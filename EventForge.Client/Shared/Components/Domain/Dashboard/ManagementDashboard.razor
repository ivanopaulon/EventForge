@typeparam TItem
@using EventForge.Client.Shared.Components.Dashboard
@using EventForge.Client.Shared.Components.UI.Dialogs
@using System.Linq.Expressions
@inject ILogger<ManagementDashboard<TItem>> Logger
@inject IDialogService DialogService

<MudPaper Class="pa-2 mb-2" Elevation="1">
    <div class="d-flex justify-space-between align-center mb-2">
        <MudText Typo="Typo.subtitle2" Class="font-weight-bold">Dashboard</MudText>
        @if (AllowConfiguration)
        {
            <MudIconButton Icon="@Icons.Material.Outlined.Settings" 
                          Size="Size.Small" 
                          OnClick="@OpenConfigurationDialog"
                          Title="Configura Dashboard" />
        }
    </div>

    @if (_metricResults?.Any() == true)
    {
        <MudGrid Spacing="1">
            @foreach (var metric in _metricResults)
            {
                <MudItem xs="12" sm="6" md="3" lg="2">
                    <MudCard Elevation="0" Class="pa-2" Style="border: 1px solid var(--mud-palette-divider);">
                        <MudCardContent Class="pa-1">
                            <div class="d-flex align-center mb-1">
                                @if (!string.IsNullOrEmpty(metric.Icon))
                                {
                                    <MudIcon Icon="@metric.Icon" 
                                             Color="@GetMudColor(metric.Color)" 
                                             Size="Size.Small"
                                             Class="mr-1" />
                                }
                                <MudText Typo="Typo.caption" Color="Color.Secondary" Style="font-size: 0.7rem;">
                                    @metric.Title
                                </MudText>
                                @if (!string.IsNullOrEmpty(metric.Description))
                                {
                                    <MudTooltip Text="@metric.Description">
                                        <MudIcon Icon="@Icons.Material.Outlined.Info" Size="Size.Small" Style="font-size: 0.8rem;" Class="ml-1" />
                                    </MudTooltip>
                                }
                            </div>
                            <MudText Typo="Typo.h6" Color="@GetMudColor(metric.Color)" Style="font-size: 1.1rem;">
                                @metric.FormattedValue
                            </MudText>
                            @if (!string.IsNullOrEmpty(metric.GroupLabel))
                            {
                                <MudText Typo="Typo.caption" Color="Color.Secondary" Style="font-size: 0.65rem;">
                                    @metric.GroupLabel
                                </MudText>
                            }
                        </MudCardContent>
                    </MudCard>
                </MudItem>
            }
        </MudGrid>
    }
    else if (_isCalculating)
    {
        <div class="d-flex justify-center align-center pa-4">
            <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
            <MudText Class="ml-3">Calcolo metriche...</MudText>
        </div>
    }
    else
    {
        <MudAlert Severity="Severity.Info">
            Nessuna metrica disponibile. Configurare le metriche per visualizzare i dati del dashboard.
        </MudAlert>
    }
</MudPaper>

@code {
    /// <summary>
    /// Items to calculate metrics from (client-side).
    /// </summary>
    [Parameter]
    public IEnumerable<TItem>? Items { get; set; }

    /// <summary>
    /// Metric definitions for the dashboard.
    /// </summary>
    [Parameter]
    public List<DashboardMetric<TItem>>? Metrics { get; set; }

    /// <summary>
    /// Optional server-side metric provider.
    /// </summary>
    [Parameter]
    public Func<ServerMetricRequest, Task<ServerMetricResponse>>? ServerMetricProvider { get; set; }

    /// <summary>
    /// Whether to use server-side calculation.
    /// </summary>
    [Parameter]
    public bool UseServerSide { get; set; } = false;

    /// <summary>
    /// Whether to allow configuration of the dashboard.
    /// </summary>
    [Parameter]
    public bool AllowConfiguration { get; set; } = true;

    /// <summary>
    /// Entity type for configuration (e.g., "VatRate", "Product").
    /// </summary>
    [Parameter]
    public string EntityType { get; set; } = string.Empty;

    private List<MetricResult>? _metricResults;
    private bool _isCalculating = false;

    protected override async Task OnParametersSetAsync()
    {
        await CalculateMetricsAsync();
    }

    private async Task OpenConfigurationDialog()
    {
        try
        {
            var parameters = new DialogParameters<DashboardConfigurationDialog>
            {
                { x => x.EntityType, EntityType }
            };

            var options = new DialogOptions
            {
                MaxWidth = MaxWidth.Medium,
                FullWidth = true,
                CloseButton = true
            };

            var dialog = await DialogService.ShowAsync<DashboardConfigurationDialog>(
                "Configurazione Dashboard",
                parameters,
                options);

            var result = await dialog.Result;

            if (!result.Canceled)
            {
                // Reload metrics after configuration change
                await CalculateMetricsAsync();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error opening dashboard configuration dialog");
        }
    }

    private async Task CalculateMetricsAsync()
    {
        if (Metrics == null || !Metrics.Any())
        {
            _metricResults = null;
            return;
        }

        try
        {
            _isCalculating = true;
            StateHasChanged();

            if (UseServerSide && ServerMetricProvider != null)
            {
                await CalculateServerSideMetricsAsync();
            }
            else
            {
                CalculateClientSideMetrics();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error calculating dashboard metrics");
            _metricResults = null;
        }
        finally
        {
            _isCalculating = false;
            StateHasChanged();
        }
    }

    private void CalculateClientSideMetrics()
    {
        if (Items == null || Metrics == null)
        {
            _metricResults = null;
            return;
        }

        _metricResults = new List<MetricResult>();

        foreach (var metric in Metrics)
        {
            try
            {
                var filteredItems = Items;

                // Apply metric-specific filter
                if (metric.Filter != null)
                {
                    filteredItems = filteredItems.Where(metric.Filter);
                }

                if (metric.GroupBySelector == null)
                {
                    // Simple metric without grouping
                    var result = CalculateSingleMetric(metric, filteredItems);
                    if (result != null)
                    {
                        _metricResults.Add(result);
                    }
                }
                else
                {
                    // Grouped metric
                    var compiledGroupBy = metric.GroupBySelector.Compile();
                    var groups = filteredItems.GroupBy(compiledGroupBy);

                    var topGroups = metric.TopN > 0 
                        ? groups.Take(metric.TopN) 
                        : groups;

                    foreach (var group in topGroups)
                    {
                        var result = CalculateSingleMetric(metric, group);
                        if (result != null)
                        {
                            result.GroupLabel = group.Key?.ToString() ?? "N/A";
                            _metricResults.Add(result);
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Error calculating metric: {MetricTitle}", metric.Title);
            }
        }
    }

    private MetricResult? CalculateSingleMetric(DashboardMetric<TItem> metric, IEnumerable<TItem> items)
    {
        if (!items.Any())
        {
            return null;
        }

        decimal value = 0;

        switch (metric.Type)
        {
            case MetricType.Count:
                value = items.Count();
                break;

            case MetricType.Sum:
                if (metric.ValueSelector != null)
                {
                    var compiledSelector = metric.ValueSelector.Compile();
                    value = items.Sum(compiledSelector);
                }
                break;

            case MetricType.Average:
                if (metric.ValueSelector != null)
                {
                    var compiledSelector = metric.ValueSelector.Compile();
                    value = items.Average(compiledSelector);
                }
                break;

            case MetricType.Min:
                if (metric.ValueSelector != null)
                {
                    var compiledSelector = metric.ValueSelector.Compile();
                    value = items.Min(compiledSelector);
                }
                break;

            case MetricType.Max:
                if (metric.ValueSelector != null)
                {
                    var compiledSelector = metric.ValueSelector.Compile();
                    value = items.Max(compiledSelector);
                }
                break;
        }

        var formattedValue = metric.Format != null 
            ? value.ToString(metric.Format) 
            : value.ToString("N0");

        return new MetricResult
        {
            Title = metric.Title,
            Value = value,
            FormattedValue = formattedValue,
            Icon = metric.Icon,
            Color = metric.Color,
            Description = metric.Description,
            ShowChart = metric.ShowChart
        };
    }

    private async Task CalculateServerSideMetricsAsync()
    {
        if (ServerMetricProvider == null || Metrics == null)
        {
            _metricResults = null;
            return;
        }

        var request = new ServerMetricRequest
        {
            MetricIds = Metrics.Select((m, i) => $"metric_{i}").ToList(),
            Filters = new Dictionary<string, object?>()
        };

        var response = await ServerMetricProvider(request);
        _metricResults = response.Metrics;
    }

    private Color GetMudColor(string? color)
    {
        return color?.ToLowerInvariant() switch
        {
            "primary" => Color.Primary,
            "secondary" => Color.Secondary,
            "success" => Color.Success,
            "info" => Color.Info,
            "warning" => Color.Warning,
            "error" => Color.Error,
            "dark" => Color.Dark,
            "tertiary" => Color.Tertiary,
            _ => Color.Default
        };
    }

    private List<ChartSeries> GetChartSeries(List<ChartDataPoint> chartData)
    {
        return new List<ChartSeries>
        {
            new ChartSeries
            {
                Name = "Value",
                Data = chartData.Select(d => d.Value).ToArray()
            }
        };
    }

    private string[] GetChartLabels(List<ChartDataPoint> chartData)
    {
        return chartData.Select(d => d.Label).ToArray();
    }
}
