@inject ITranslationService TranslationService

<div class="sf-card p-4 mb-4" style="border: 2px solid #ff9800; background-color: #fff3e0;">
    <div class="mb-3">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h6>
                <span class="e-icons e-search"></span>
                @TranslationService.GetTranslation("warehouse.productNotFound", "Prodotto non trovato")
            </h6>
            <SfButton IconCss="e-icons e-close" CssClass="e-flat" OnClick="@(() => OnSkip.InvokeAsync())" />
        </div>

        <!-- Barcode Display -->
        <div class="sf-info-panel mb-3">
            <small>@TranslationService.GetTranslation("warehouse.barcodeToAssign", "Codice da Assegnare")</small>
            <div class="mt-1">
                <strong>@ScannedBarcode</strong>
            </div>
        </div>

        <!-- Product Search -->
        <div class="mb-3">
            <SfAutoComplete TValue="string" TItem="ProductDto"
                           Value="@SearchValue"
                           DataSource="@_products"
                           Placeholder="@TranslationService.GetTranslation("products.searchProduct", "Cerca Prodotto")"
                           FloatLabelType="FloatLabelType.Auto"
                           Filtering="@OnProductFiltering"
                           ValueChange="@OnProductValueChanged">
                <AutoCompleteFieldSettings Value="Name" />
                <AutoCompleteTemplates TItem="ProductDto">
                    <ItemTemplate Context="product">
                        <div>
                            <div>@product.Name</div>
                            <small class="text-muted">@product.Code @(!string.IsNullOrEmpty(product.ShortDescription) ? " - " + product.ShortDescription : "")</small>
                        </div>
                    </ItemTemplate>
                </AutoCompleteTemplates>
            </SfAutoComplete>
            <small class="text-muted">@TranslationService.GetTranslation("products.searchByCodeOrDescription", "Cerca per codice o descrizione")</small>
        </div>

        <!-- Assignment form and details below -->
        @if (SelectedProduct != null)
        {
            <div class="sf-card p-3 mb-3">
                <p class="mb-3"><strong>@TranslationService.GetTranslation("products.selectedProduct", "Prodotto Selezionato")</strong></p>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <small class="text-muted">@TranslationService.GetTranslation("products.productName", "Nome Prodotto")</small>
                        <div><strong>@SelectedProduct.Name</strong></div>
                    </div>
                    <div class="col-md-6">
                        <small class="text-muted">@TranslationService.GetTranslation("products.productCode", "Codice Prodotto")</small>
                        <div><strong>@SelectedProduct.Code</strong></div>
                    </div>
                </div>

                <!-- Code Assignment Fields -->
                <div class="row g-2">
                    <div class="col-md-6">
                        <SfDropDownList TValue="string" TItem="CodeTypeOption"
                                        DataSource="@_codeTypes"
                                        Placeholder="@TranslationService.GetTranslation("products.codeType", "Tipo Codice")"
                                        Value="@CodeType"
                                        Change="@OnCodeTypeChanged">
                            <DropDownListFieldSettings Text="Label" Value="Value" />
                        </SfDropDownList>
                    </div>
                    <div class="col-md-6">
                        <SfTextBox Placeholder="@TranslationService.GetTranslation("products.code", "Codice")"
                                   Value="@Code"
                                   ValueChange="@OnCodeValueChanged" />
                    </div>
                </div>
            </div>
        }

        <!-- Action Buttons -->
        <div class="d-flex justify-content-end gap-2">
            <SfButton IconCss="e-icons e-skip-forward" CssClass="e-outline"
                     OnClick="@(() => OnSkip.InvokeAsync())">
                @TranslationService.GetTranslation("warehouse.skipProduct", "Salta")
            </SfButton>
            <SfButton IconCss="e-icons e-folder-open" CssClass="e-outline e-info"
                     OnClick="@(() => OnOpenProducts.InvokeAsync())">
                @TranslationService.GetTranslation("warehouse.openProductManagement", "Apri gestione prodotti")
            </SfButton>
            @if (SelectedProduct != null)
            {
                <SfButton IconCss="e-icons e-link" CssClass="e-primary"
                         OnClick="@HandleAssign"
                         Disabled="@(!IsFormValid() || IsLoading)">
                    @TranslationService.GetTranslation("warehouse.assignAndContinue", "Assegna e continua")
                </SfButton>
            }
        </div>
    </div>
</div>

@code {
    private List<ProductDto> _products = new();
    private string SearchValue { get; set; } = string.Empty;

    private List<CodeTypeOption> _codeTypes = new()
    {
        new("EAN", "EAN"),
        new("UPC", "UPC"),
        new("SKU", "SKU"),
        new("QR", "QR Code"),
        new("Barcode", "Codice a Barre"),
        new("Other", "Altro")
    };

    [Parameter] public string ScannedBarcode { get; set; } = string.Empty;
    [Parameter] public ProductDto? SelectedProduct { get; set; }
    [Parameter] public EventCallback<ProductDto?> SelectedProductChanged { get; set; }
    [Parameter] public string CodeType { get; set; } = "Barcode";
    [Parameter] public EventCallback<string> CodeTypeChanged { get; set; }
    [Parameter] public string Code { get; set; } = string.Empty;
    [Parameter] public EventCallback<string> CodeChanged { get; set; }
    [Parameter] public string? AlternativeDescription { get; set; }
    [Parameter] public EventCallback<string?> AlternativeDescriptionChanged { get; set; }
    [Parameter] public bool IsLoading { get; set; }

    [Parameter] public Func<string, CancellationToken, Task<IEnumerable<ProductDto>>>? OnSearchProducts { get; set; }
    [Parameter] public EventCallback<(Guid productId, string codeType, string code, string? altDesc)> OnAssign { get; set; }
    [Parameter] public EventCallback OnSkip { get; set; }
    [Parameter] public EventCallback OnOpenProducts { get; set; }

    protected override void OnParametersSet()
    {
        // Pre-fill the code field with scanned barcode
        if (string.IsNullOrEmpty(Code) && !string.IsNullOrEmpty(ScannedBarcode))
        {
            Code = ScannedBarcode;
        }

        // If a product is already selected externally, reflect its name in the input
        if (SelectedProduct != null)
        {
            SearchValue = SelectedProduct.Name ?? string.Empty;
        }
    }

    private async Task OnProductFiltering(SfDropDowns.FilteringEventArgs args)
    {
        var text = args?.Text ?? string.Empty;

        if (OnSearchProducts == null)
        {
            _products.Clear();
            StateHasChanged();
            return;
        }

        try
        {
            var results = await OnSearchProducts(text, CancellationToken.None);
            _products = results?.ToList() ?? new List<ProductDto>();
        }
        catch
        {
            _products.Clear();
        }

        StateHasChanged();
    }

    private async Task OnProductValueChanged(string value)
    {
        SearchValue = value ?? string.Empty;

        if (string.IsNullOrWhiteSpace(SearchValue))
        {
            SelectedProduct = null;
            await SelectedProductChanged.InvokeAsync(null);
            return;
        }

        // Try to match by Name or Code among current suggestions
        var found = _products.FirstOrDefault(p =>
            string.Equals(p.Name, SearchValue, StringComparison.OrdinalIgnoreCase) ||
            string.Equals(p.Code, SearchValue, StringComparison.OrdinalIgnoreCase));

        if (found != null)
        {
            SelectedProduct = found;
            await SelectedProductChanged.InvokeAsync(found);

            // Pre-fill code with scanned barcode if code empty
            if (string.IsNullOrEmpty(Code))
            {
                Code = ScannedBarcode;
                await CodeChanged.InvokeAsync(Code);
            }
        }
    }

    private async Task OnCodeTypeChanged(SfDropDowns.ChangeEventArgs<string, CodeTypeOption> args)
    {
        CodeType = args.Value;
        await CodeTypeChanged.InvokeAsync(args.Value);
    }

    private async Task OnCodeValueChanged(Syncfusion.Blazor.Inputs.ChangedEventArgs args)
    {
        Code = args.Value ?? string.Empty;
        await CodeChanged.InvokeAsync(Code);
    }

    private bool IsFormValid()
    {
        return SelectedProduct != null && !string.IsNullOrEmpty(Code);
    }

    private async Task HandleAssign()
    {
        if (!IsFormValid()) return;

        if (SelectedProduct == null) return;

        await OnAssign.InvokeAsync((SelectedProduct.Id, CodeType, Code, AlternativeDescription));
    }

    private record CodeTypeOption(string Value, string Label);
}
