@using EventForge.DTOs.Warehouse
@using EventForge.Client.Services
@inject IDialogService DialogService
@inject IProductService ProductService
@inject ITranslationService TranslationService
@inject ILogger<CommonTrendWrapper> Logger

<MudPaper Elevation="1" Class="pa-4 mb-4" Style="width:100%;">
    <MudStack Spacing="2">
        <MudStack Row="true" AlignItems="AlignItems.Center" JustifyContent="Justify.SpaceBetween">
            <MudText Typo="Typo.h6">
                <MudIcon Icon="@Icon" Class="mr-2" />
                @Title
            </MudText>
            <MudText Typo="Typo.caption" Class="mud-text-secondary">@Subtitle</MudText>
        </MudStack>

        <div style="width:100%;">
            @ChildContent
        </div>

        <!-- Documents Table -->
        @if (ProductId.HasValue)
        {
            <MudPaper Elevation="0" Class="mt-4 pa-3" Style="border: 1px solid rgba(0,0,0,0.12); border-radius:4px;">
                <MudText Typo="Typo.subtitle1" Class="mb-3">
                    <MudIcon Icon="@Icons.Material.Outlined.Description" Class="mr-2" Size="Size.Small" />
                    @GetDocumentsPanelText()
                </MudText>
                
                @if (_isDocsLoading)
                {
                    <div class="d-flex justify-center pa-4">
                        <MudProgressCircular Indeterminate="true" />
                    </div>
                }
                else if (_docs?.Any() != true)
                {
                    <MudAlert Severity="Severity.Info" Class="mb-0">
                        @TranslationService.GetTranslation("product.noDocuments", "Nessun documento trovato")
                    </MudAlert>
                }
                else
                {
                    <MudTable Items="_docs" Dense="true" Hover="true" Elevation="0">
                        <HeaderContent>
                            <MudTh>@TranslationService.GetTranslation("field.date", "Data")</MudTh>
                            <MudTh>@TranslationService.GetTranslation("field.number", "Numero")</MudTh>
                            <MudTh>@TranslationService.GetTranslation("field.type", "Tipo")</MudTh>
                            <MudTh Style="text-align:right;">@TranslationService.GetTranslation("field.quantity", "Quantità")</MudTh>
                            <MudTh Style="text-align:right;">@TranslationService.GetTranslation("field.unitPrice", "Prezzo Unitario")</MudTh>
                            <MudTh Style="text-align:right;">@TranslationService.GetTranslation("field.lineTotal", "Totale Riga")</MudTh>
                            <MudTh>@TranslationService.GetTranslation("field.businessParty", "Controparte")</MudTh>
                            <MudTh></MudTh>
                        </HeaderContent>
                        <RowTemplate Context="d">
                            <MudTd DataLabel="@TranslationService.GetTranslation("field.date", "Data")">
                                @d.DocumentDate.ToString("dd/MM/yyyy")
                            </MudTd>
                            <MudTd DataLabel="@TranslationService.GetTranslation("field.number", "Numero")">
                                @d.DocumentNumber
                            </MudTd>
                            <MudTd DataLabel="@TranslationService.GetTranslation("field.type", "Tipo")">
                                @d.DocumentTypeName
                            </MudTd>
                            <MudTd DataLabel="@TranslationService.GetTranslation("field.quantity", "Quantità")" Style="text-align:right;">
                                <MudChip T="string" Size="Size.Small" Color="@(d.IsStockIncrease ? Color.Success : Color.Error)">
                                    @(d.IsStockIncrease ? "+" : "-")@d.Quantity.ToString("N2")
                                </MudChip>
                            </MudTd>
                            <MudTd DataLabel="@TranslationService.GetTranslation("field.unitPrice", "Prezzo Unitario")" Style="text-align:right;">
                                €@d.UnitPrice.ToString("N2")
                            </MudTd>
                            <MudTd DataLabel="@TranslationService.GetTranslation("field.lineTotal", "Totale Riga")" Style="text-align:right;">
                                <strong>€@d.LineTotal.ToString("N2")</strong>
                            </MudTd>
                            <MudTd DataLabel="@TranslationService.GetTranslation("field.businessParty", "Controparte")">
                                @(d.BusinessPartyName ?? "-")
                            </MudTd>
                            <MudTd>
                                <MudButton Variant="Variant.Text" Size="Size.Small" OnClick="@(()=>OpenDocument(d.DocumentHeaderId))">
                                    @TranslationService.GetTranslation("common.view","Visualizza")
                                </MudButton>
                            </MudTd>
                        </RowTemplate>
                    </MudTable>
                }
            </MudPaper>
        }
    </MudStack>
</MudPaper>

@code {
    [Parameter] public string Icon { get; set; } = Icons.Material.Outlined.ShowChart;
    [Parameter] public string Title { get; set; } = string.Empty;
    [Parameter] public string Subtitle { get; set; } = string.Empty;
    [Parameter] public RenderFragment? ChildContent { get; set; }
    [Parameter] public Guid? ProductId { get; set; }

    private const int DocumentsPageSize = 50;
    private bool _isDocsLoading;
    private IEnumerable<ProductDocumentMovementDto>? _docs;
    private long _documentCount;

    protected override async Task OnParametersSetAsync()
    {
        // Load documents when ProductId is set
        if (ProductId.HasValue && _docs == null)
        {
            await LoadDocumentsAsync();
        }
    }

    private async Task LoadDocumentsAsync()
    {
        _isDocsLoading = true;
        StateHasChanged();
        try
        {
            var result = await ProductService.GetProductDocumentMovementsAsync(ProductId!.Value, page: 1, pageSize: DocumentsPageSize);
            _docs = result?.Items ?? Array.Empty<ProductDocumentMovementDto>();
            _documentCount = result?.TotalCount ?? 0;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading documents for product {ProductId}", ProductId);
            _docs = Array.Empty<ProductDocumentMovementDto>();
            _documentCount = 0;
        }
        finally
        {
            _isDocsLoading = false;
            StateHasChanged();
        }
    }

    private string GetDocumentsPanelText()
    {
        var baseText = TranslationService.GetTranslation("product.relatedDocuments", "Documenti correlati");
        return $"{baseText} ({_documentCount})";
    }

    private async Task OpenDocument(Guid documentHeaderId)
    {
        var parameters = new DialogParameters { ["DocumentHeaderId"] = documentHeaderId };
        var options = new DialogOptions { FullWidth = true, MaxWidth = MaxWidth.Large, CloseButton = true };
        await DialogService.ShowAsync<DocumentViewerDialog>(TranslationService.GetTranslation("documents.view","Visualizza documento"), parameters, options);
    }
}
