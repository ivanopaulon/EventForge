@using EventForge.DTOs.Store
@using EventForge.DTOs.Business
@using EventForge.DTOs.Sales
@using EventForge.Client.Shared.Components.Dialogs.Sales
@using EventForge.Client.Shared.Components.Business
@using EventForge.Client.Shared.Components.Common
@inject ITranslationService TranslationService
@inject IDialogService DialogService

<MudPaper Elevation="2" Class="pa-4 mb-4">
    <MudGrid Spacing="3">
        <!-- Operator Selection -->
        <MudItem xs="12" sm="6" md="3">
            <MudSelect T="Guid?"
                       Value="SelectedOperatorId"
                       ValueChanged="@OnOperatorChanged"
                       Label="@TranslationService.GetTranslation("sales.operator", "Operatore")"
                       Variant="Variant.Outlined"
                       Required="true"
                       Disabled="@(IsSessionActive || AvailableOperators == null || AvailableOperators.Count == 0)"
                       Adornment="Adornment.Start"
                       AdornmentIcon="@Icons.Material.Filled.Person">
                @if (AvailableOperators != null)
                {
                    @foreach (var op in AvailableOperators)
                    {
                        <MudSelectItem T="Guid?" Value="@((Guid?)op.Id)">@op.Name</MudSelectItem>
                    }
                }
            </MudSelect>
            @if (AvailableOperators == null || AvailableOperators.Count == 0)
            {
                <MudAlert Severity="Severity.Warning" Dense="true" Class="mt-2">
                    @TranslationService.GetTranslation("sales.noOperatorsAvailableAlert", "Nessun operatore disponibile")
                </MudAlert>
            }
        </MudItem>

        <!-- POS Selection -->
        <MudItem xs="12" sm="6" md="3">
            <MudSelect T="Guid?"
                       Value="SelectedPosId"
                       ValueChanged="@OnPosChanged"
                       Label="@TranslationService.GetTranslation("sales.pos", "Cassa/POS")"
                       Variant="Variant.Outlined"
                       Required="true"
                       Disabled="@(IsSessionActive || !SelectedOperatorId.HasValue || AvailablePos == null || AvailablePos.Count == 0)"
                       Adornment="Adornment.Start"
                       AdornmentIcon="@Icons.Material.Filled.PointOfSale">
                @if (AvailablePos != null)
                {
                    @foreach (var pos in AvailablePos)
                    {
                        <MudSelectItem T="Guid?" Value="@((Guid?)pos.Id)">@pos.Name</MudSelectItem>
                    }
                }
            </MudSelect>
            @if (!SelectedOperatorId.HasValue)
            {
                <MudAlert Severity="Severity.Info" Dense="true" Class="mt-2">
                    @TranslationService.GetTranslation("sales.selectOperatorFirst", "Seleziona prima un operatore")
                </MudAlert>
            }
            else if (AvailablePos == null || AvailablePos.Count == 0)
            {
                <MudAlert Severity="Severity.Warning" Dense="true" Class="mt-2">
                    @TranslationService.GetTranslation("sales.noPosAvailableAlert", "Nessun POS attivo disponibile")
                </MudAlert>
            }
        </MudItem>

        <!-- Customer Selection -->
        <MudItem xs="12" sm="6" md="4">
            <UnifiedBusinessPartySelector 
                SelectedBusinessParty="SelectedCustomer"
                SelectedBusinessPartyChanged="@OnCustomerChanged"
                Title="@null"
                Placeholder="@TranslationService.GetTranslation("sales.searchCustomer", "Cerca cliente...")"
                FilterByType="BusinessPartyType.Customer"
                EditMode="EntityEditMode.QuickDialog"
                CreateMode="EntityCreateMode.QuickDialog"
                DisplayMode="EntityDisplayMode.FiscalInfo | EntityDisplayMode.Contacts"
                AllowQuickCreate="true"
                AllowQuickEdit="true"
                Disabled="@(!SelectedOperatorId.HasValue || !SelectedPosId.HasValue)"
                Dense="true" />
        </MudItem>

        <!-- Date/Time + Session -->
        <MudItem xs="12" sm="6" md="4">
            <div class="d-flex flex-column" style="gap: 8px;">
                <MudText Typo="Typo.body2" Color="Color.Secondary">
                    <MudIcon Icon="@Icons.Material.Filled.CalendarToday" Size="Size.Small" Class="mr-1" />
                    @DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss")
                </MudText>
                <div class="d-flex align-center" style="gap: 8px;">
                    @if (SessionNumber != null)
                    {
                        <MudChip T="string" 
                                 Size="Size.Small" 
                                 Color="Color.Primary" 
                                 Icon="@Icons.Material.Filled.Receipt">
                            @TranslationService.GetTranslation("sales.session", "Sessione") #@SessionNumber.ToString().Substring(0, 8)
                        </MudChip>
                    }
                    @if (IsUpdatingItems)
                    {
                        <MudTooltip Text="@LoadingTooltipText">
                            <MudProgressCircular Size="Size.Small" 
                                               Color="@LoadingSpinnerColor" 
                                               Indeterminate="true" />
                        </MudTooltip>
                    }
                </div>
            </div>
        </MudItem>
    </MudGrid>

    <!-- Action Buttons -->
    @if (IsSessionActive)
    {
        <MudDivider Class="my-3" />
        <div class="d-flex justify-end gap-2">
            <MudButton StartIcon="@Icons.Material.Filled.Pause"
                       Color="Color.Warning"
                       Variant="Variant.Outlined"
                       OnClick="OnParkClick">
                @TranslationService.GetTranslation("sales.park", "Parcheggia")
            </MudButton>
            <MudButton StartIcon="@Icons.Material.Filled.Cancel"
                       Color="Color.Error"
                       Variant="Variant.Outlined"
                       OnClick="OnCancelClick">
                @TranslationService.GetTranslation("sales.cancel", "Annulla")
            </MudButton>
        </div>
    }
</MudPaper>

@code {
    [Parameter]
    public List<StoreUserDto>? AvailableOperators { get; set; }

    [Parameter]
    public Guid? SelectedOperatorId { get; set; }

    [Parameter]
    public EventCallback<Guid?> SelectedOperatorIdChanged { get; set; }

    [Parameter]
    public List<StorePosDto>? AvailablePos { get; set; }

    [Parameter]
    public Guid? SelectedPosId { get; set; }

    [Parameter]
    public EventCallback<Guid?> SelectedPosIdChanged { get; set; }

    [Parameter]
    public BusinessPartyDto? SelectedCustomer { get; set; }

    [Parameter]
    public EventCallback<BusinessPartyDto?> SelectedCustomerChanged { get; set; }

    [Parameter]
    public Guid? SessionNumber { get; set; }

    [Parameter]
    public bool IsSessionActive { get; set; }

    [Parameter]
    public EventCallback OnParkClick { get; set; }

    [Parameter]
    public EventCallback OnCancelClick { get; set; }

    [Parameter]
    public bool IsUpdatingItems { get; set; }

    [Parameter]
    public string LoadingTooltipText { get; set; } = string.Empty;

    [Parameter]
    public Color LoadingSpinnerColor { get; set; } = Color.Primary;

    private async Task OnOperatorChanged(Guid? value)
    {
        SelectedOperatorId = value;
        await SelectedOperatorIdChanged.InvokeAsync(value);
    }

    private async Task OnPosChanged(Guid? value)
    {
        SelectedPosId = value;
        await SelectedPosIdChanged.InvokeAsync(value);
    }

    private async Task OnCustomerChanged(BusinessPartyDto? value)
    {
        SelectedCustomer = value;
        await SelectedCustomerChanged.InvokeAsync(value);
    }
}
