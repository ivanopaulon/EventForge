@using EventForge.DTOs.Store
@using EventForge.DTOs.Business
@using EventForge.DTOs.Sales
@using EventForge.Client.Shared.Components.Dialogs.Sales
@using EventForge.Client.Shared.Components.Business
@using EventForge.Client.Shared.Components.Common
@inject ITranslationService TranslationService
@inject IDialogService DialogService

<MudPaper Elevation="2" Class="pa-3 mb-3">
    <MudGrid Spacing="2" AlignItems="AlignItems.Center">
        
        <!-- Operatore (col 3/12) -->
        <MudItem xs="12" sm="6" md="3">
            <MudSelect T="Guid?"
                       Value="SelectedOperatorId"
                       ValueChanged="@OnOperatorChanged"
                       Label="@TranslationService.GetTranslation("sales.operator", "Operatore")"
                       Variant="Variant.Outlined"
                       Dense="true"
                       Required="true"
                       Disabled="@IsSessionActive"
                       Adornment="Adornment.Start"
                       AdornmentIcon="@Icons.Material.Filled.Person">
                @if (AvailableOperators != null)
                {
                    @foreach (var op in AvailableOperators)
                    {
                        <MudSelectItem T="Guid?" Value="@((Guid?)op.Id)">@op.Name</MudSelectItem>
                    }
                }
            </MudSelect>
        </MudItem>

        <!-- POS (col 2/12) -->
        <MudItem xs="12" sm="6" md="2">
            <MudSelect T="Guid?"
                       Value="SelectedPosId"
                       ValueChanged="@OnPosChanged"
                       Label="@TranslationService.GetTranslation("sales.pos", "Cassa")"
                       Variant="Variant.Outlined"
                       Dense="true"
                       Required="true"
                       Disabled="@(IsSessionActive || !SelectedOperatorId.HasValue)"
                       Adornment="Adornment.Start"
                       AdornmentIcon="@Icons.Material.Filled.PointOfSale">
                @if (AvailablePos != null)
                {
                    @foreach (var pos in AvailablePos)
                    {
                        <MudSelectItem T="Guid?" Value="@((Guid?)pos.Id)">@pos.Name</MudSelectItem>
                    }
                }
            </MudSelect>
        </MudItem>

        <!-- Cliente - UnifiedBusinessPartySelector (col 4/12) -->
        <MudItem xs="12" md="4">
            <UnifiedBusinessPartySelector 
                SelectedBusinessParty="SelectedCustomer"
                SelectedBusinessPartyChanged="@OnCustomerChanged"
                Title="@null"
                Placeholder="@TranslationService.GetTranslation("sales.searchCustomer", "Cerca cliente...")"
                FilterByType="BusinessPartyType.Customer"
                EditMode="EntityEditMode.QuickDialog"
                CreateMode="EntityCreateMode.QuickDialog"
                DisplayMode="EntityDisplayMode.FiscalInfo | EntityDisplayMode.Contacts"
                AllowQuickCreate="true"
                AllowQuickEdit="true"
                Disabled="@(!SelectedOperatorId.HasValue || !SelectedPosId.HasValue)"
                Dense="true" />
        </MudItem>

        <!-- Session Info + Actions (col 3/12) -->
        <MudItem xs="12" md="3">
            <MudStack Row="true" Justify="Justify.FlexEnd" AlignItems="AlignItems.Center" Spacing="1">
                
                <!-- Session Number -->
                @if (IsSessionActive && SessionNumber.HasValue)
                {
                    <MudChip T="string" Size="Size.Small" 
                             Color="Color.Info" 
                             Icon="@Icons.Material.Outlined.Receipt"
                             Variant="Variant.Text">
                        #@SessionNumber.Value.ToString().Substring(0, 8)
                    </MudChip>
                }
                
                <!-- Loading Spinner -->
                @if (IsUpdatingItems)
                {
                    <MudTooltip Text="@LoadingTooltipText">
                        <MudProgressCircular Size="Size.Small" 
                                             Color="@LoadingSpinnerColor" 
                                             Indeterminate="true" />
                    </MudTooltip>
                }
                
                <!-- Park Button -->
                <MudTooltip Text="@TranslationService.GetTranslation("sales.parkSession", "Parcheggia (F3)")">
                    <MudIconButton Icon="@Icons.Material.Outlined.Pause"
                                   Color="Color.Warning"
                                   Size="Size.Small"
                                   OnClick="@OnParkClick"
                                   Disabled="@(!IsSessionActive)" />
                </MudTooltip>
                
                <!-- Cancel Button -->
                <MudTooltip Text="@TranslationService.GetTranslation("sales.cancelSession", "Annulla")">
                    <MudIconButton Icon="@Icons.Material.Outlined.Close"
                                   Color="Color.Error"
                                   Size="Size.Small"
                                   OnClick="@OnCancelClick"
                                   Disabled="@(!IsSessionActive)" />
                </MudTooltip>
                
            </MudStack>
        </MudItem>
        
    </MudGrid>
</MudPaper>

@code {
    [Parameter]
    public List<StoreUserDto>? AvailableOperators { get; set; }

    [Parameter]
    public Guid? SelectedOperatorId { get; set; }

    [Parameter]
    public EventCallback<Guid?> SelectedOperatorIdChanged { get; set; }

    [Parameter]
    public List<StorePosDto>? AvailablePos { get; set; }

    [Parameter]
    public Guid? SelectedPosId { get; set; }

    [Parameter]
    public EventCallback<Guid?> SelectedPosIdChanged { get; set; }

    [Parameter]
    public BusinessPartyDto? SelectedCustomer { get; set; }

    [Parameter]
    public EventCallback<BusinessPartyDto?> SelectedCustomerChanged { get; set; }

    [Parameter]
    public Guid? SessionNumber { get; set; }

    [Parameter]
    public bool IsSessionActive { get; set; }

    [Parameter]
    public EventCallback OnParkClick { get; set; }

    [Parameter]
    public EventCallback OnCancelClick { get; set; }

    [Parameter]
    public bool IsUpdatingItems { get; set; }

    [Parameter]
    public string LoadingTooltipText { get; set; } = string.Empty;

    [Parameter]
    public Color LoadingSpinnerColor { get; set; } = Color.Primary;

    private async Task OnOperatorChanged(Guid? value)
    {
        SelectedOperatorId = value;
        await SelectedOperatorIdChanged.InvokeAsync(value);
    }

    private async Task OnPosChanged(Guid? value)
    {
        SelectedPosId = value;
        await SelectedPosIdChanged.InvokeAsync(value);
    }

    private async Task OnCustomerChanged(BusinessPartyDto? value)
    {
        SelectedCustomer = value;
        await SelectedCustomerChanged.InvokeAsync(value);
    }
}
