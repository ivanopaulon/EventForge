@using EventForge.DTOs.Sales
@inject ITranslationService TranslationService

<MudPaper Elevation="2" Class="pa-4 mb-4">
    <MudText Typo="Typo.h6" Class="mb-3">
        <MudIcon Icon="@Icons.Material.Filled.ShoppingCart" Class="mr-2" />
        @TranslationService.GetTranslation("sales.items", "Articoli")
        <MudChip T="string" Size="Size.Small" Color="Color.Primary" Class="ml-2">@(Items?.Count ?? 0)</MudChip>
    </MudText>

    @if (Items?.Any() == true)
    {
        <MudTable Items="@Items" Hover="true" Striped="true" Dense="true">
            <HeaderContent>
                <MudTh>@TranslationService.GetTranslation("products.code", "Codice")</MudTh>
                <MudTh>@TranslationService.GetTranslation("products.product", "Prodotto")</MudTh>
                <MudTh Style="text-align: center;">@TranslationService.GetTranslation("sales.quantity", "Quantit√†")</MudTh>
                <MudTh Style="text-align: right;">@TranslationService.GetTranslation("sales.price", "Prezzo")</MudTh>
                <MudTh Style="text-align: right;">@TranslationService.GetTranslation("sales.discount", "Sconto")</MudTh>
                <MudTh Style="text-align: right;">@TranslationService.GetTranslation("sales.total", "Totale")</MudTh>
                <MudTh Style="text-align: center;">@TranslationService.GetTranslation("common.actions", "Azioni")</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Code">@context.ProductCode</MudTd>
                <MudTd DataLabel="Product">@context.ProductName</MudTd>
                <MudTd DataLabel="Quantity" Style="text-align: center;">
                    <div class="d-flex align-center justify-center gap-1">
                        <MudIconButton Icon="@Icons.Material.Filled.Remove" 
                                       Size="Size.Small" 
                                       OnClick="@(() => OnDecreaseQuantity.InvokeAsync(context))"
                                       Disabled="@(context.Quantity <= 1)" />
                        <MudNumericField T="decimal"
                                         Value="@context.Quantity"
                                         ValueChanged="@((decimal val) => HandleQuantityChanged(context, val))"
                                         Min="1"
                                         HideSpinButtons="true"
                                         Style="width: 60px; text-align: center;"
                                         Variant="Variant.Text" />
                        <MudIconButton Icon="@Icons.Material.Filled.Add" 
                                       Size="Size.Small" 
                                       OnClick="@(() => OnIncreaseQuantity.InvokeAsync(context))" />
                    </div>
                </MudTd>
                <MudTd DataLabel="Price" Style="text-align: right;">
                    <MudNumericField T="decimal"
                                     Value="@context.UnitPrice"
                                     ValueChanged="@((decimal val) => HandlePriceChanged(context, val))"
                                     Format="N2"
                                     Min="0"
                                     HideSpinButtons="true"
                                     Style="width: 100px;"
                                     Variant="Variant.Text" />
                </MudTd>
                <MudTd DataLabel="Discount" Style="text-align: right;">
                    <div class="d-flex align-center justify-end gap-1">
                        <MudNumericField T="decimal"
                                         Value="@context.DiscountPercent"
                                         ValueChanged="@((decimal val) => HandleDiscountChanged(context, val))"
                                         Format="N1"
                                         Min="0"
                                         Max="100"
                                         HideSpinButtons="true"
                                         Style="width: 60px;"
                                         Variant="Variant.Text" />
                        <MudText Typo="Typo.body2">%</MudText>
                    </div>
                </MudTd>
                <MudTd DataLabel="Total" Style="text-align: right;">
                    <MudText Typo="Typo.body1" Style="font-weight: 600;">
                        @context.TotalAmount.ToString("C")
                    </MudText>
                </MudTd>
                <MudTd DataLabel="Actions" Style="text-align: center;">
                    <MudIconButton Icon="@Icons.Material.Filled.Edit" 
                                   Size="Size.Small" 
                                   Color="Color.Primary"
                                   OnClick="@(() => OnEditNotes.InvokeAsync(context))"
                                   Title="@TranslationService.GetTranslation("common.notes", "Note")" />
                    <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                   Size="Size.Small" 
                                   Color="Color.Error"
                                   OnClick="@(() => OnRemoveItem.InvokeAsync(context))" />
                </MudTd>
            </RowTemplate>
        </MudTable>
    }
    else
    {
        <MudAlert Severity="Severity.Info" Dense="true">
            @TranslationService.GetTranslation("sales.emptyCart", "Nessun articolo nel carrello. Scansiona un prodotto per iniziare.")
        </MudAlert>
    }
</MudPaper>

@code {
    [Parameter] public List<SaleItemDto>? Items { get; set; }
    [Parameter] public EventCallback<(SaleItemDto Item, decimal NewQuantity)> OnQuantityChanged { get; set; }
    [Parameter] public EventCallback<(SaleItemDto Item, decimal NewPrice)> OnPriceChanged { get; set; }
    [Parameter] public EventCallback<(SaleItemDto Item, decimal NewDiscount)> OnDiscountChanged { get; set; }
    [Parameter] public EventCallback<SaleItemDto> OnEditNotes { get; set; }
    [Parameter] public EventCallback<SaleItemDto> OnRemoveItem { get; set; }
    [Parameter] public EventCallback<SaleItemDto> OnIncreaseQuantity { get; set; }
    [Parameter] public EventCallback<SaleItemDto> OnDecreaseQuantity { get; set; }

    private Task HandleQuantityChanged(SaleItemDto item, decimal value)
    {
        return OnQuantityChanged.InvokeAsync((item, value));
    }

    private Task HandlePriceChanged(SaleItemDto item, decimal value)
    {
        return OnPriceChanged.InvokeAsync((item, value));
    }

    private Task HandleDiscountChanged(SaleItemDto item, decimal value)
    {
        return OnDiscountChanged.InvokeAsync((item, value));
    }
}
