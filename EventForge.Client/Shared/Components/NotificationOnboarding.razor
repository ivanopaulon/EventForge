@using EventForge.DTOs.Notifications
@inject ITranslationService TranslationService
@inject IHelpService HelpService
@inject ISnackbar Snackbar

<MudDialog>
    <DialogContent>
        <div class="notification-onboarding">
            @if (_currentStep == 1)
            {
                <!-- Welcome Step -->
                <div class="text-center pa-4">
                    <MudIcon Icon="@Icons.Material.Filled.Notifications" 
                             Size="Size.Large" 
                             Color="Color.Primary" 
                             Class="mb-4" />
                    <MudText Typo="Typo.h4" Class="mb-2">
                        @TranslationService.GetTranslation("onboarding.notifications.welcome.title", "Benvenuto nel Centro Notifiche!")
                    </MudText>
                    <MudText Typo="Typo.body1" Color="Color.Secondary" Class="mb-4">
                        @TranslationService.GetTranslation("onboarding.notifications.welcome.description", 
                            "EventForge ti tiene aggiornato con notifiche intelligenti e personalizzabili. Scopriamo insieme come funziona!")
                    </MudText>
                    
                    <!-- Preview Cards -->
                    <MudGrid Class="mt-4">
                        <MudItem xs="12" sm="4">
                            <MudCard Class="pa-3" Elevation="2">
                                <MudIcon Icon="@Icons.Material.Filled.Event" Color="Color.Success" Class="mb-2" />
                                <MudText Typo="Typo.subtitle2">@TranslationService.GetTranslation("onboarding.notifications.features.events", "Eventi")</MudText>
                                <MudText Typo="Typo.caption">@TranslationService.GetTranslation("onboarding.notifications.features.eventsDesc", "Aggiornamenti sui tuoi eventi")</MudText>
                            </MudCard>
                        </MudItem>
                        <MudItem xs="12" sm="4">
                            <MudCard Class="pa-3" Elevation="2">
                                <MudIcon Icon="@Icons.Material.Filled.Chat" Color="Color.Info" Class="mb-2" />
                                <MudText Typo="Typo.subtitle2">@TranslationService.GetTranslation("onboarding.notifications.features.chat", "Chat")</MudText>
                                <MudText Typo="Typo.caption">@TranslationService.GetTranslation("onboarding.notifications.features.chatDesc", "Messaggi e conversazioni")</MudText>
                            </MudCard>
                        </MudItem>
                        <MudItem xs="12" sm="4">
                            <MudCard Class="pa-3" Elevation="2">
                                <MudIcon Icon="@Icons.Material.Filled.Security" Color="Color.Warning" Class="mb-2" />
                                <MudText Typo="Typo.subtitle2">@TranslationService.GetTranslation("onboarding.notifications.features.security", "Sicurezza")</MudText>
                                <MudText Typo="Typo.caption">@TranslationService.GetTranslation("onboarding.notifications.features.securityDesc", "Avvisi di sicurezza")</MudText>
                            </MudCard>
                        </MudItem>
                    </MudGrid>
                </div>
            }
            else if (_currentStep == 2)
            {
                <!-- Rich Notifications Step -->
                <div class="pa-4">
                    <MudText Typo="Typo.h5" Class="mb-3">
                        @TranslationService.GetTranslation("onboarding.notifications.rich.title", "Notifiche Ricche e Interattive")
                    </MudText>
                    <MudText Typo="Typo.body1" Color="Color.Secondary" Class="mb-4">
                        @TranslationService.GetTranslation("onboarding.notifications.rich.description", 
                            "Le notifiche EventForge supportano contenuti ricchi come file, link, azioni e molto altro.")
                    </MudText>
                    
                    <!-- Sample Rich Notification -->
                    <MudCard Class="ma-2" Elevation="3">
                        <MudCardContent Class="pa-3">
                            <div class="d-flex align-start">
                                <MudAvatar Size="Size.Medium" Class="mr-3" Color="Color.Primary">
                                    <MudIcon Icon="@Icons.Material.Filled.Event" />
                                </MudAvatar>
                                <div class="flex-grow-1">
                                    <MudText Typo="Typo.subtitle1" Class="font-weight-bold">
                                        @TranslationService.GetTranslation("onboarding.sample.title", "Nuovo Evento Creato")
                                    </MudText>
                                    <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-2">
                                        @TranslationService.GetTranslation("onboarding.sample.message", "Ãˆ stato creato un nuovo evento per il tuo team. Controlla i dettagli e conferma la partecipazione.")
                                    </MudText>
                                    
                                    <!-- Sample Tags -->
                                    <div class="d-flex flex-wrap ga-1 mb-2">
                                        <MudChip T="string" Size="Size.Small" Color="Color.Primary" Variant="Variant.Text">Evento</MudChip>
                                        <MudChip T="string" Size="Size.Small" Color="Color.Success" Variant="Variant.Text">Team</MudChip>
                                    </div>
                                    
                                    <!-- Sample Actions -->
                                    <div class="d-flex ga-1">
                                        <MudButton Size="Size.Small" Variant="Variant.Filled" Color="Color.Primary">
                                            @TranslationService.GetTranslation("onboarding.sample.view", "Visualizza")
                                        </MudButton>
                                        <MudButton Size="Size.Small" Variant="Variant.Outlined" Color="Color.Success">
                                            @TranslationService.GetTranslation("onboarding.sample.confirm", "Conferma")
                                        </MudButton>
                                    </div>
                                </div>
                            </div>
                        </MudCardContent>
                    </MudCard>
                    
                    <MudAlert Severity="Severity.Info" Class="mt-3">
                        @TranslationService.GetTranslation("onboarding.notifications.rich.tip", 
                            "ðŸ’¡ Suggerimento: Puoi interagire direttamente con le notifiche senza aprire altre pagine!")
                    </MudAlert>
                </div>
            }
            else if (_currentStep == 3)
            {
                <!-- Grouping and Filtering Step -->
                <div class="pa-4">
                    <MudText Typo="Typo.h5" Class="mb-3">
                        @TranslationService.GetTranslation("onboarding.notifications.organization.title", "Organizzazione Intelligente")
                    </MudText>
                    <MudText Typo="Typo.body1" Color="Color.Secondary" Class="mb-4">
                        @TranslationService.GetTranslation("onboarding.notifications.organization.description", 
                            "Raggruppa, filtra e cerca le tue notifiche per trovare rapidamente quello che ti serve.")
                    </MudText>
                    
                    <MudGrid>
                        <MudItem xs="12" md="6">
                            <!-- Grouping Example -->
                            <MudCard Class="pa-3 mb-3" Elevation="2">
                                <div class="d-flex justify-space-between align-center">
                                    <div class="d-flex align-center">
                                        <MudIcon Icon="@Icons.Material.Filled.ExpandMore" Class="mr-2" />
                                        <div>
                                            <MudText Typo="Typo.subtitle1" Class="font-weight-bold">
                                                @TranslationService.GetTranslation("onboarding.grouping.events", "Notifiche Eventi")
                                            </MudText>
                                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                                @TranslationService.GetTranslation("onboarding.grouping.latest", "Ultima: 2 minuti fa")
                                            </MudText>
                                        </div>
                                    </div>
                                    <MudBadge Content="3" Color="Color.Error" />
                                </div>
                            </MudCard>
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <!-- Filtering Example -->
                            <MudCard Class="pa-3 mb-3" Elevation="2">
                                <div class="d-flex align-center">
                                    <MudIcon Icon="@Icons.Material.Filled.FilterList" Color="Color.Primary" Class="mr-2" />
                                    <div>
                                        <MudText Typo="Typo.subtitle2">@TranslationService.GetTranslation("onboarding.filtering.title", "Filtri Avanzati")</MudText>
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                                            @TranslationService.GetTranslation("onboarding.filtering.desc", "Per tipo, prioritÃ , data e molto altro")
                                        </MudText>
                                    </div>
                                </div>
                            </MudCard>
                        </MudItem>
                    </MudGrid>
                    
                    <MudAlert Severity="Severity.Success" Class="mt-3">
                        @TranslationService.GetTranslation("onboarding.notifications.organization.tip", 
                            "ðŸŽ¯ Pro Tip: Usa la barra di ricerca per trovare notifiche specifiche usando parole chiave!")
                    </MudAlert>
                </div>
            }
            else if (_currentStep == 4)
            {
                <!-- Personalization Step -->
                <div class="pa-4">
                    <MudText Typo="Typo.h5" Class="mb-3">
                        @TranslationService.GetTranslation("onboarding.notifications.personalization.title", "Personalizzazione Completa")
                    </MudText>
                    <MudText Typo="Typo.body1" Color="Color.Secondary" Class="mb-4">
                        @TranslationService.GetTranslation("onboarding.notifications.personalization.description", 
                            "Configura le tue preferenze per ricevere solo le notifiche che ti interessano davvero.")
                    </MudText>
                    
                    <MudGrid>
                        <MudItem xs="12" sm="6">
                            <MudCard Class="pa-3" Elevation="2">
                                <MudIcon Icon="@Icons.Material.Filled.Tune" Color="Color.Primary" Class="mb-2" />
                                <MudText Typo="Typo.subtitle2" Class="mb-1">
                                    @TranslationService.GetTranslation("onboarding.personalization.preferences", "Preferenze")
                                </MudText>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                    @TranslationService.GetTranslation("onboarding.personalization.preferencesDesc", "Tipi, prioritÃ , suoni e lingua")
                                </MudText>
                            </MudCard>
                        </MudItem>
                        <MudItem xs="12" sm="6">
                            <MudCard Class="pa-3" Elevation="2">
                                <MudIcon Icon="@Icons.Material.Filled.Timeline" Color="Color.Info" Class="mb-2" />
                                <MudText Typo="Typo.subtitle2" Class="mb-1">
                                    @TranslationService.GetTranslation("onboarding.personalization.feed", "Feed AttivitÃ ")
                                </MudText>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                    @TranslationService.GetTranslation("onboarding.personalization.feedDesc", "Cronologia completa delle tue attivitÃ ")
                                </MudText>
                            </MudCard>
                        </MudItem>
                    </MudGrid>
                    
                    <div class="text-center mt-4">
                        <MudButton Variant="Variant.Outlined" 
                                   Color="Color.Primary"
                                   StartIcon="@Icons.Material.Filled.Settings"
                                   OnClick="@OpenPreferences">
                            @TranslationService.GetTranslation("onboarding.personalization.openPreferences", "Apri Preferenze")
                        </MudButton>
                    </div>
                </div>
            }
            else if (_currentStep == 5)
            {
                <!-- Completion Step -->
                <div class="text-center pa-4">
                    <MudIcon Icon="@Icons.Material.Filled.CheckCircle" 
                             Size="Size.Large" 
                             Color="Color.Success" 
                             Class="mb-4" />
                    <MudText Typo="Typo.h4" Class="mb-2">
                        @TranslationService.GetTranslation("onboarding.notifications.complete.title", "Tutto Pronto!")
                    </MudText>
                    <MudText Typo="Typo.body1" Color="Color.Secondary" Class="mb-4">
                        @TranslationService.GetTranslation("onboarding.notifications.complete.description", 
                            "Ora conosci tutte le funzionalitÃ  del centro notifiche. Inizia a esplorare!")
                    </MudText>
                    
                    <MudGrid>
                        <MudItem xs="12" sm="4">
                            <MudButton Variant="Variant.Outlined" 
                                       Color="Color.Primary"
                                       StartIcon="@Icons.Material.Filled.Notifications"
                                       FullWidth="true"
                                       OnClick="@GoToNotifications">
                                @TranslationService.GetTranslation("onboarding.complete.notifications", "Centro Notifiche")
                            </MudButton>
                        </MudItem>
                        <MudItem xs="12" sm="4">
                            <MudButton Variant="Variant.Outlined" 
                                       Color="Color.Info"
                                       StartIcon="@Icons.Material.Filled.Timeline"
                                       FullWidth="true"
                                       OnClick="@GoToActivityFeed">
                                @TranslationService.GetTranslation("onboarding.complete.activityFeed", "Feed AttivitÃ ")
                            </MudButton>
                        </MudItem>
                        <MudItem xs="12" sm="4">
                            <MudButton Variant="Variant.Outlined" 
                                       Color="Color.Secondary"
                                       StartIcon="@Icons.Material.Filled.Settings"
                                       FullWidth="true"
                                       OnClick="@OpenPreferences">
                                @TranslationService.GetTranslation("onboarding.complete.preferences", "Preferenze")
                            </MudButton>
                        </MudItem>
                    </MudGrid>
                    
                    <MudAlert Severity="Severity.Info" Class="mt-4">
                        @TranslationService.GetTranslation("onboarding.notifications.complete.tip", 
                            "ðŸ’¡ Ricorda: Puoi sempre accedere a questo tour dal menu Aiuto!")
                    </MudAlert>
                </div>
            }
        </div>
    </DialogContent>
    <DialogActions>
        <div class="d-flex justify-space-between align-center w-100">
            <div>
                @if (_currentStep > 1)
                {
                    <MudButton Variant="Variant.Text" 
                               Color="Color.Default"
                               StartIcon="@Icons.Material.Filled.ArrowBack"
                               OnClick="@PreviousStep">
                        @TranslationService.GetTranslation("onboarding.previous", "Indietro")
                    </MudButton>
                }
            </div>
            
            <div class="d-flex align-center ga-2">
                <!-- Progress Indicator -->
                <div class="d-flex ga-1">
                    @for (int i = 1; i <= _totalSteps; i++)
                    {
                        <MudIcon Icon="@(i <= _currentStep ? Icons.Material.Filled.Circle : Icons.Material.Outlined.Circle)"
                                 Size="Size.Small"
                                 Color="@(i <= _currentStep ? Color.Primary : Color.Default)" />
                    }
                </div>
                
                <MudText Typo="Typo.caption" Color="Color.Secondary">
                    @_currentStep / @_totalSteps
                </MudText>
            </div>
            
            <div>
                @if (_currentStep < _totalSteps)
                {
                    <MudButton Variant="Variant.Filled" 
                               Color="Color.Primary"
                               EndIcon="@Icons.Material.Filled.ArrowForward"
                               OnClick="@NextStep">
                        @TranslationService.GetTranslation("onboarding.next", "Avanti")
                    </MudButton>
                }
                else
                {
                    <MudButton Variant="Variant.Filled" 
                               Color="Color.Success"
                               EndIcon="@Icons.Material.Filled.Check"
                               OnClick="@CompleteOnboarding">
                        @TranslationService.GetTranslation("onboarding.complete", "Completa")
                    </MudButton>
                }
                
                <MudButton Variant="Variant.Text" 
                           Color="Color.Default"
                           OnClick="@SkipOnboarding"
                           Class="ml-2">
                    @TranslationService.GetTranslation("onboarding.skip", "Salta")
                </MudButton>
            </div>
        </div>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] public IDialogService DialogService { get; set; } = null!;
    [Parameter] public EventCallback OnCompleted { get; set; }
    [Parameter] public EventCallback<string> OnNavigate { get; set; }

    private int _currentStep = 1;
    private const int _totalSteps = 5;

    private void NextStep()
    {
        if (_currentStep < _totalSteps)
        {
            _currentStep++;
            StateHasChanged();
        }
    }

    private void PreviousStep()
    {
        if (_currentStep > 1)
        {
            _currentStep--;
            StateHasChanged();
        }
    }

    private async Task CompleteOnboarding()
    {
        try
        {
            // TODO: Implement when HelpService has this method
            // await HelpService.MarkOnboardingStepCompletedAsync("notifications_onboarding_completed");
            Snackbar.Add(TranslationService.GetTranslation("onboarding.completed", "Onboarding completato!"), Severity.Success);
            await OnCompleted.InvokeAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Errore: {ex.Message}", Severity.Error);
        }
    }

    private void SkipOnboarding()
    {
        // Close dialog callback will be handled by parent
    }

    private async Task OpenPreferences()
    {
        await OnNavigate.InvokeAsync("/notifications/preferences");
    }

    private async Task GoToNotifications()
    {
        await OnNavigate.InvokeAsync("/notifications");
    }

    private async Task GoToActivityFeed()
    {
        await OnNavigate.InvokeAsync("/activity-feed");
    }
}

<style>
    .notification-onboarding .mud-card {
        transition: transform 0.2s ease-in-out;
    }

    .notification-onboarding .mud-card:hover {
        transform: translateY(-2px);
    }

    .notification-onboarding .mud-button {
        transition: all 0.2s ease-in-out;
    }

    .notification-onboarding .mud-alert {
        border-radius: 8px;
    }
</style>