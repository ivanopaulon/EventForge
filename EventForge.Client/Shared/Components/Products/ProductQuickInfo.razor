@using EventForge.DTOs.Products
@using EventForge.DTOs.UnitOfMeasures
@using EventForge.DTOs.VatRates
@inject IProductService ProductService
@inject IFinancialService FinancialService
@inject ITranslationService TranslationService
@inject ISnackbar Snackbar
@inject ILogger<ProductQuickInfo> Logger

@* ProductQuickInfo Component - Displays and allows quick inline editing of product essential information *@
<MudPaper Elevation="2" Class="@GetCssClass()" Style="@Style">
    <MudStack Spacing="2">
        <!-- Header with Edit Button -->
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
            <MudText Typo="Typo.subtitle1" Style="font-weight: 600;">
                <MudIcon Icon="@Icons.Material.Outlined.Info" Size="Size.Small" Class="mr-1" />
                @TranslationService.GetTranslation("products.quickInfo", "Info Rapida Prodotto")
            </MudText>
            @if (!_isEditMode && AllowEdit)
            {
                <MudTooltip Text="@TranslationService.GetTranslation("products.editProductInfo", "Modifica info prodotto (Ctrl+E)")">
                    <MudIconButton Icon="@Icons.Material.Outlined.Edit"
                                   Size="Size.Small"
                                   Color="Color.Primary"
                                   OnClick="EnterEditMode" />
                </MudTooltip>
            }
            else if (_isEditMode)
            {
                <MudStack Row="true" Spacing="1">
                    <MudTooltip Text="@TranslationService.GetTranslation("common.cancel", "Annulla")">
                        <MudIconButton Icon="@Icons.Material.Outlined.Close"
                                       Size="Size.Small"
                                       Color="Color.Default"
                                       OnClick="CancelEdit" />
                    </MudTooltip>
                    <MudTooltip Text="@TranslationService.GetTranslation("common.save", "Salva modifiche")">
                        <MudIconButton Icon="@Icons.Material.Outlined.Save"
                                       Size="Size.Small"
                                       Color="Color.Success"
                                       OnClick="SaveChanges"
                                       Disabled="@(!_isFormValid || _isSaving)" />
                    </MudTooltip>
                </MudStack>
            }
        </MudStack>

        <MudDivider />

        @if (Product == null)
        {
            <MudText Typo="Typo.body2" Color="Color.Secondary">
                @TranslationService.GetTranslation("products.noProductSelected", "Nessun prodotto selezionato")
            </MudText>
        }
        else
        {
            @if (!_isEditMode)
            {
                <!-- View Mode -->
                <MudGrid Spacing="2">
                    <MudItem xs="12" sm="6">
                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                            @TranslationService.GetTranslation("products.code", "Codice")
                        </MudText>
                        <MudText Typo="Typo.body2" Style="font-weight: 600;">
                            @Product.Code
                        </MudText>
                    </MudItem>
                    <MudItem xs="12" sm="6">
                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                            @TranslationService.GetTranslation("products.name", "Nome")
                        </MudText>
                        <MudText Typo="Typo.body2" Style="font-weight: 600;">
                            @Product.Name
                        </MudText>
                    </MudItem>
                    <MudItem xs="12">
                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                            @TranslationService.GetTranslation("products.description", "Descrizione")
                        </MudText>
                        <MudText Typo="Typo.body2">
                            @(string.IsNullOrWhiteSpace(Product.Description) ? "-" : Product.Description)
                        </MudText>
                    </MudItem>
                    <MudItem xs="12" sm="6">
                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                            @TranslationService.GetTranslation("products.unitOfMeasure", "Unità di Misura")
                        </MudText>
                        <MudText Typo="Typo.body2">
                            @(_currentUnitName ?? "-")
                        </MudText>
                    </MudItem>
                    <MudItem xs="12" sm="6">
                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                            @TranslationService.GetTranslation("products.vatRate", "IVA")
                        </MudText>
                        <MudText Typo="Typo.body2">
                            @(_currentVatName ?? "-")
                        </MudText>
                    </MudItem>
                    @if (ShowCurrentStock && CurrentStockQuantity.HasValue)
                    {
                        <MudItem xs="12" sm="6">
                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                @TranslationService.GetTranslation("warehouse.currentStock", "Giacenza Attuale")
                            </MudText>
                            <MudText Typo="Typo.body2" Style="font-weight: 600;">
                                @CurrentStockQuantity.Value.ToString("N2") @(_currentUnitSymbol ?? "")
                            </MudText>
                        </MudItem>
                    }
                </MudGrid>
            }
            else
            {
                <!-- Edit Mode -->
                <MudForm @ref="_form" @bind-IsValid="@_isFormValid">
                    <MudStack Spacing="2">
                        <MudTextField @bind-Value="_editName"
                                      Label="@TranslationService.GetTranslation("products.name", "Nome")"
                                      Variant="Variant.Outlined"
                                      Required="true"
                                      RequiredError="@TranslationService.GetTranslation("validation.required", "Campo obbligatorio")"
                                      MaxLength="100"
                                      Immediate="true" />

                        <MudTextField @bind-Value="_editDescription"
                                      Label="@TranslationService.GetTranslation("products.description", "Descrizione")"
                                      Variant="Variant.Outlined"
                                      Lines="2"
                                      MaxLength="500"
                                      Immediate="true" />

                        <MudSelect T="Guid?"
                                   @bind-Value="_editUnitOfMeasureId"
                                   Label="@TranslationService.GetTranslation("products.unitOfMeasure", "Unità di Misura")"
                                   Variant="Variant.Outlined"
                                   Clearable="true">
                            @if (_availableUnits != null)
                            {
                                @foreach (var unit in _availableUnits)
                                {
                                    <MudSelectItem Value="@((Guid?)unit.Id)">
                                        @unit.Name (@unit.Symbol)
                                    </MudSelectItem>
                                }
                            }
                        </MudSelect>

                        <MudSelect T="Guid?"
                                   @bind-Value="_editVatRateId"
                                   Label="@TranslationService.GetTranslation("products.vatRate", "IVA")"
                                   Variant="Variant.Outlined"
                                   Clearable="true">
                            @if (_availableVatRates != null)
                            {
                                @foreach (var vat in _availableVatRates)
                                {
                                    <MudSelectItem Value="@((Guid?)vat.Id)">
                                        @vat.Name (@vat.Percentage%)
                                    </MudSelectItem>
                                }
                            }
                        </MudSelect>

                        <MudAlert Severity="Severity.Info" Dense="true" Variant="Variant.Outlined">
                            <MudText Typo="Typo.caption">
                                <MudIcon Icon="@Icons.Material.Outlined.Info" Size="Size.Small" Class="mr-1" />
                                @TranslationService.GetTranslation("products.quickEditNote", "Il codice prodotto non può essere modificato. Usa la gestione prodotti completa per modifiche avanzate.")
                            </MudText>
                        </MudAlert>
                    </MudStack>
                </MudForm>
            }
        }
    </MudStack>
</MudPaper>

@code {
    [Parameter]
    public ProductDto? Product { get; set; }

    [Parameter]
    public bool AllowEdit { get; set; } = true;

    [Parameter]
    public bool ShowCurrentStock { get; set; } = false;

    [Parameter]
    public decimal? CurrentStockQuantity { get; set; }

    [Parameter]
    public EventCallback OnProductUpdated { get; set; }

    [Parameter]
    public string? Class { get; set; }

    [Parameter]
    public string? Style { get; set; }

    private MudForm? _form;
    private bool _isEditMode = false;
    private bool _isFormValid = false;
    private bool _isSaving = false;

    // Edit fields
    private string _editName = string.Empty;
    private string _editDescription = string.Empty;
    private Guid? _editUnitOfMeasureId;
    private Guid? _editVatRateId;

    // Available options
    private IEnumerable<UMDto>? _availableUnits;
    private IEnumerable<VatRateDto>? _availableVatRates;

    // Current display values
    private string? _currentUnitName;
    private string? _currentUnitSymbol;
    private string? _currentVatName;

    protected override async Task OnInitializedAsync()
    {
        await LoadReferenceData();
        UpdateDisplayValues();
    }

    protected override void OnParametersSet()
    {
        UpdateDisplayValues();
    }

    private async Task LoadReferenceData()
    {
        try
        {
            // Load units and VAT rates in parallel
            var unitsTask = ProductService.GetUnitsOfMeasureAsync();
            var vatRatesTask = FinancialService.GetVatRatesAsync();

            await Task.WhenAll(unitsTask, vatRatesTask);

            _availableUnits = await unitsTask;
            var vatRatesResult = await vatRatesTask;
            _availableVatRates = vatRatesResult?.Items ?? Enumerable.Empty<VatRateDto>();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading reference data for ProductQuickInfo");
            Snackbar.Add(TranslationService.GetTranslation("errors.loadingData", "Errore nel caricamento dei dati"), Severity.Error);
        }
    }

    private void UpdateDisplayValues()
    {
        if (Product == null) return;

        // Update unit display
        if (Product.UnitOfMeasureId.HasValue && _availableUnits != null)
        {
            var unit = _availableUnits.FirstOrDefault(u => u.Id == Product.UnitOfMeasureId.Value);
            if (unit != null)
            {
                _currentUnitName = unit.Name;
                _currentUnitSymbol = unit.Symbol;
            }
        }
        else
        {
            _currentUnitName = null;
            _currentUnitSymbol = null;
        }

        // Update VAT display
        if (Product.VatRateId.HasValue && _availableVatRates != null)
        {
            var vat = _availableVatRates.FirstOrDefault(v => v.Id == Product.VatRateId.Value);
            if (vat != null)
            {
                _currentVatName = $"{vat.Name} ({vat.Percentage}%)";
            }
        }
        else
        {
            _currentVatName = null;
        }
    }

    private void EnterEditMode()
    {
        if (Product == null) return;

        _isEditMode = true;
        _editName = Product.Name;
        _editDescription = Product.Description ?? string.Empty;
        _editUnitOfMeasureId = Product.UnitOfMeasureId;
        _editVatRateId = Product.VatRateId;
    }

    private void CancelEdit()
    {
        _isEditMode = false;
        _editName = string.Empty;
        _editDescription = string.Empty;
        _editUnitOfMeasureId = null;
        _editVatRateId = null;
    }

    private async Task SaveChanges()
    {
        if (Product == null || !_isFormValid || _isSaving)
            return;

        _isSaving = true;

        try
        {
            var updateDto = new UpdateProductDto
            {
                Name = _editName,
                Description = _editDescription,
                ShortDescription = Product.ShortDescription ?? string.Empty,
                Status = Product.Status,
                IsVatIncluded = Product.IsVatIncluded,
                DefaultPrice = Product.DefaultPrice,
                VatRateId = _editVatRateId,
                UnitOfMeasureId = _editUnitOfMeasureId,
                CategoryNodeId = Product.CategoryNodeId,
                FamilyNodeId = Product.FamilyNodeId,
                GroupNodeId = Product.GroupNodeId,
                StationId = Product.StationId,
                BrandId = Product.BrandId,
                ModelId = Product.ModelId,
                PreferredSupplierId = Product.PreferredSupplierId,
                ReorderPoint = Product.ReorderPoint,
                SafetyStock = Product.SafetyStock,
                TargetStockLevel = Product.TargetStockLevel,
                AverageDailyDemand = Product.AverageDailyDemand,
                ImageUrl = Product.ImageUrl ?? string.Empty,
                ImageDocumentId = Product.ImageDocumentId
            };

            var updatedProduct = await ProductService.UpdateProductAsync(Product.Id, updateDto);

            if (updatedProduct != null)
            {
                // Update local product data
                Product.Name = updatedProduct.Name;
                Product.Description = updatedProduct.Description;
                Product.UnitOfMeasureId = updatedProduct.UnitOfMeasureId;
                Product.VatRateId = updatedProduct.VatRateId;

                // Update display values
                UpdateDisplayValues();

                // Exit edit mode
                _isEditMode = false;

                // Show success message
                Snackbar.Add(
                    TranslationService.GetTranslation("products.updateSuccess", "Prodotto aggiornato con successo"),
                    Severity.Success
                );

                // Notify parent component
                if (OnProductUpdated.HasDelegate)
                {
                    await OnProductUpdated.InvokeAsync();
                }
            }
            else
            {
                Snackbar.Add(
                    TranslationService.GetTranslation("products.updateFailed", "Errore nell'aggiornamento del prodotto"),
                    Severity.Error
                );
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error updating product {ProductId}", Product.Id);
            Snackbar.Add(
                TranslationService.GetTranslation("products.updateError", "Errore nell'aggiornamento del prodotto"),
                Severity.Error
            );
        }
        finally
        {
            _isSaving = false;
        }
    }

    public async Task HandleKeyboardShortcut(string key, bool ctrlKey)
    {
        if (ctrlKey && key.ToLower() == "e" && AllowEdit && !_isEditMode && Product != null)
        {
            EnterEditMode();
            StateHasChanged();
        }
        else if (key.ToLower() == "escape" && _isEditMode)
        {
            CancelEdit();
            StateHasChanged();
        }
        await Task.CompletedTask;
    }

    private string GetCssClass()
    {
        var baseClass = "pa-3";
        return string.IsNullOrEmpty(Class) ? baseClass : $"{baseClass} {Class}";
    }
}
