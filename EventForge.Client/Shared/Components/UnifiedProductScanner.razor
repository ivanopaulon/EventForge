@using EventForge.DTOs.Products
@using EventForge.DTOs.UnitOfMeasures
@using EventForge.DTOs.VatRates

@* UnifiedProductScanner Component - Unified product search with barcode scanning and inline editing *@
<MudPaper Elevation="@Elevation" Class="@GetCssClass()" Style="@Style">
    <MudStack Spacing="2">
        @if (ShowTitle)
        {
            <!-- Header with Title and Action Buttons -->
            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                <MudText Typo="Typo.subtitle1" Style="font-weight: 600;">
                    <MudIcon Icon="@Icons.Material.Outlined.Inventory" Size="Size.Small" Class="mr-1" />
                    @Title
                </MudText>
                @if (SelectedProduct != null && !_isEditMode)
                {
                    <MudStack Row="true" Spacing="1">
                        @if (AllowEdit)
                        {
                            <MudTooltip Text="@TranslationService.GetTranslation("products.editProductInfo", "Modifica info prodotto (Ctrl+E)")">
                                <MudIconButton Icon="@Icons.Material.Outlined.Edit"
                                               Size="Size.Small"
                                               Color="Color.Primary"
                                               OnClick="EnterEditMode" />
                            </MudTooltip>
                        }
                        @if (AllowClear)
                        {
                            <MudTooltip Text="@TranslationService.GetTranslation("common.clear", "Pulisci")">
                                <MudIconButton Icon="@Icons.Material.Outlined.Clear"
                                               Size="Size.Small"
                                               Color="Color.Default"
                                               OnClick="ClearSelection" />
                            </MudTooltip>
                        }
                    </MudStack>
                }
                else if (_isEditMode)
                {
                    <MudStack Row="true" Spacing="1">
                        <MudTooltip Text="@TranslationService.GetTranslation("common.cancel", "Annulla")">
                            <MudIconButton Icon="@Icons.Material.Outlined.Close"
                                           Size="Size.Small"
                                           Color="Color.Default"
                                           OnClick="CancelEdit" />
                        </MudTooltip>
                        <MudTooltip Text="@TranslationService.GetTranslation("common.save", "Salva modifiche")">
                            <MudIconButton Icon="@Icons.Material.Outlined.Save"
                                           Size="Size.Small"
                                           Color="Color.Success"
                                           OnClick="SaveChanges"
                                           Disabled="@(!_isFormValid || _isSaving)" />
                        </MudTooltip>
                    </MudStack>
                }
            </MudStack>

            <MudDivider />
        }

        @if (SelectedProduct == null || _isEditMode)
        {
            <!-- SEARCH MODE: Autocomplete for product search with barcode support -->
            <MudAutocomplete T="ProductDto"
                             @ref="_autocomplete"
                             @bind-Value="SelectedProduct"
                             @bind-Text="_searchText"
                             SearchFunc="@SearchProductsAsync"
                             ToStringFunc="@(p => p?.Name ?? string.Empty)"
                             Variant="Variant.Outlined"
                             Dense="@Dense"
                             Margin="Margin.Dense"
                             MinCharacters="@MinSearchCharacters"
                             DebounceInterval="@DebounceMs"
                             ShowProgressIndicator="true"
                             Clearable="@AllowClear"
                             Disabled="@(Disabled || _isEditMode)"
                             Placeholder="@Placeholder"
                             HelperText="@SearchHelperText"
                             Adornment="Adornment.Start"
                             AdornmentIcon="@Icons.Material.Outlined.Search"
                             AdornmentColor="Color.Primary"
                             @onkeydown="@HandleSearchKeyDown">
                <!-- ItemTemplate -->
                <ItemTemplate Context="product">
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                        <div>
                            <MudText Typo="Typo.body2"><strong>@product.Name</strong></MudText>
                            @if (!string.IsNullOrEmpty(product.Code))
                            {
                                <MudText Typo="Typo.caption" Style="color: var(--mud-palette-text-secondary);">
                                    @product.Code
                                </MudText>
                            }
                        </div>
                        @if (product.DefaultPrice.HasValue)
                        {
                            <MudChip T="string" Size="Size.Small" Color="Color.Primary" Variant="Variant.Text">
                                @product.DefaultPrice.Value.ToString("C2")
                            </MudChip>
                        }
                    </MudStack>
                </ItemTemplate>
                
                <!-- NoItemsTemplate -->
                <NoItemsTemplate>
                    <MudText Typo="Typo.body2" Style="color: var(--mud-palette-text-disabled);">
                        @TranslationService.GetTranslation("documents.noProductsFound", "Nessun prodotto trovato")
                    </MudText>
                </NoItemsTemplate>
            </MudAutocomplete>
        }

        @if (SelectedProduct != null && !_isEditMode)
        {
            <!-- VIEW MODE: Display product information -->
            <MudGrid Spacing="2">
                <MudItem xs="12" sm="6">
                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                        @TranslationService.GetTranslation("products.code", "Codice")
                    </MudText>
                    <MudText Typo="Typo.body2" Style="font-weight: 600;">
                        @SelectedProduct.Code
                    </MudText>
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                        @TranslationService.GetTranslation("products.name", "Nome")
                    </MudText>
                    <MudText Typo="Typo.body2" Style="font-weight: 600;">
                        @SelectedProduct.Name
                    </MudText>
                </MudItem>
                <MudItem xs="12">
                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                        @TranslationService.GetTranslation("products.description", "Descrizione")
                    </MudText>
                    <MudText Typo="Typo.body2">
                        @(string.IsNullOrWhiteSpace(SelectedProduct.Description) ? "-" : SelectedProduct.Description)
                    </MudText>
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                        @TranslationService.GetTranslation("products.unitOfMeasure", "Unità di Misura")
                    </MudText>
                    <MudText Typo="Typo.body2">
                        @(_currentUnitName ?? "-")
                    </MudText>
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                        @TranslationService.GetTranslation("products.vatRate", "IVA")
                    </MudText>
                    <MudText Typo="Typo.body2">
                        @(_currentVatName ?? "-")
                    </MudText>
                </MudItem>
                @if (SelectedProduct.DefaultPrice.HasValue)
                {
                    <MudItem xs="12" sm="6">
                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                            @TranslationService.GetTranslation("products.price", "Prezzo")
                        </MudText>
                        <MudText Typo="Typo.body2" Style="font-weight: 600;">
                            @SelectedProduct.DefaultPrice.Value.ToString("C2")
                        </MudText>
                    </MudItem>
                }
                @if (ShowCurrentStock && CurrentStockQuantity.HasValue)
                {
                    <MudItem xs="12" sm="6">
                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                            @TranslationService.GetTranslation("warehouse.currentStock", "Giacenza Attuale")
                        </MudText>
                        <MudText Typo="Typo.body2" Style="font-weight: 600;">
                            @CurrentStockQuantity.Value.ToString("N2") @(_currentUnitSymbol ?? "")
                        </MudText>
                    </MudItem>
                }
            </MudGrid>
        }

        @if (_isEditMode && SelectedProduct != null)
        {
            <!-- EDIT MODE: Inline editing form -->
            <MudForm @ref="_form" @bind-IsValid="@_isFormValid">
                <MudStack Spacing="2">
                    <MudTextField @bind-Value="_editName"
                                  Label="@TranslationService.GetTranslation("products.name", "Nome")"
                                  Variant="Variant.Outlined"
                                  Required="true"
                                  RequiredError="@TranslationService.GetTranslation("validation.required", "Campo obbligatorio")"
                                  MaxLength="100"
                                  Immediate="true" />

                    <MudTextField @bind-Value="_editDescription"
                                  Label="@TranslationService.GetTranslation("products.description", "Descrizione")"
                                  Variant="Variant.Outlined"
                                  Lines="2"
                                  MaxLength="500"
                                  Immediate="true" />

                    <MudSelect T="Guid?"
                               @bind-Value="_editUnitOfMeasureId"
                               Label="@TranslationService.GetTranslation("products.unitOfMeasure", "Unità di Misura")"
                               Variant="Variant.Outlined"
                               Clearable="true">
                        @if (_availableUnits != null)
                        {
                            @foreach (var unit in _availableUnits)
                            {
                                <MudSelectItem Value="@((Guid?)unit.Id)">
                                    @unit.Name (@unit.Symbol)
                                </MudSelectItem>
                            }
                        }
                    </MudSelect>

                    <MudSelect T="Guid?"
                               @bind-Value="_editVatRateId"
                               Label="@TranslationService.GetTranslation("products.vatRate", "IVA")"
                               Variant="Variant.Outlined"
                               Clearable="true">
                        @if (_availableVatRates != null)
                        {
                            @foreach (var vat in _availableVatRates)
                            {
                                <MudSelectItem Value="@((Guid?)vat.Id)">
                                    @vat.Name (@vat.Percentage%)
                                </MudSelectItem>
                            }
                        }
                    </MudSelect>

                    <MudAlert Severity="Severity.Info" Dense="true" Variant="Variant.Outlined">
                        <MudText Typo="Typo.caption">
                            <MudIcon Icon="@Icons.Material.Outlined.Info" Size="Size.Small" Class="mr-1" />
                            @TranslationService.GetTranslation("products.quickEditNote", "Il codice prodotto non può essere modificato. Usa la gestione prodotti completa per modifiche avanzate.")
                        </MudText>
                    </MudAlert>
                </MudStack>
            </MudForm>
        }
    </MudStack>
</MudPaper>
