@using EventForge.DTOs.Products
@using EventForge.Client.Services
@using EventForge.Client.Shared.Components.Domain.Products
@inject ITranslationService TranslationService
@inject IProductService ProductService

<MudStack Spacing="3">
    <!-- Product Quick Info -->
    @if (State.Product != null)
    {
        <ProductQuickInfo @ref="_productQuickInfo"
                          Product="@State.Product"
                          AllowEdit="true"
                          ShowCurrentStock="false"
                          OnProductUpdated="@OnProductUpdatedAsync" />
        
        <!-- Action Buttons -->
        <MudStack Row="true" Justify="Justify.Center" Spacing="2">
            <MudButton StartIcon="@Icons.Material.Outlined.Edit" 
                       Color="Color.Primary" 
                       Variant="Variant.Filled"
                       OnClick="@OnEdit">
                @TranslationService.GetTranslation("warehouse.editInventory", "Modifica Inventario")
            </MudButton>
            <MudButton StartIcon="@Icons.Material.Outlined.History" 
                       Color="Color.Info" 
                       Variant="Variant.Outlined"
                       OnClick="@OnViewHistory">
                @TranslationService.GetTranslation("warehouse.viewHistory", "Visualizza Storico")
            </MudButton>
        </MudStack>
        
        <!-- Alternative Unit Info -->
        @if (State.ConversionFactor > 1)
        {
            <MudAlert Severity="Severity.Info" Dense="true" Variant="Variant.Outlined">
                <MudText Typo="Typo.caption">
                    <MudIcon Icon="@Icons.Material.Outlined.SwapHoriz" Size="Size.Small" Class="mr-1" />
                    <strong>@TranslationService.GetTranslation("warehouse.alternativeUnit", "Unit√† alternativa"):</strong> 
                    @TranslationService.GetTranslation("warehouse.conversionFactor", "Fattore di conversione") @State.ConversionFactor.ToString("0.##")
                </MudText>
            </MudAlert>
        }
    }
    else
    {
        <MudAlert Severity="Severity.Warning">
            @TranslationService.GetTranslation("warehouse.noProductSelected", "Nessun prodotto selezionato")
        </MudAlert>
    }
</MudStack>

@code {
    [Parameter]
    public InventoryDialogState State { get; set; } = new();

    [Parameter]
    public EventCallback OnEdit { get; set; }

    [Parameter]
    public EventCallback OnViewHistory { get; set; }

    private ProductQuickInfo? _productQuickInfo;

    private async Task OnProductUpdatedAsync()
    {
        // Refresh product data after update
        if (State.Product?.Id != null)
        {
            var refreshedProduct = await ProductService.GetProductByIdAsync(State.Product.Id);
            if (refreshedProduct != null)
            {
                State.Product = refreshedProduct;
                StateHasChanged();
            }
        }
    }
}
