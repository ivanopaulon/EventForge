@using EventForge.DTOs.Common
@using EventForge.DTOs.Products
@inject ITranslationService TranslationService
@inject IProductService ProductService
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject ILogger<ProductNotFoundDialog> Logger

<MudDialog>
    <TitleContent>
        <div class="ef-dialog-title">
            <MudIcon Icon="@DialogStyleConstants.Icons.SearchOff" 
                     Color="Color.Primary" 
                     Size="Size.Medium" />
            <MudText Typo="Typo.h6">
                @TranslationService.GetTranslation("warehouse.productNotFound", "Prodotto non trovato") - @Barcode
            </MudText>
        </div>
    </TitleContent>
    <DialogContent>
        <div class="ef-dialog-content">
            <PageLoadingOverlay Visible="_isLoading"
                                Message="@(_isLoading ? TranslationService.GetTranslation("messages.loadingPage", "Caricamento pagina...") : TranslationService.GetTranslation("common.loading", "Caricamento..."))" />

            <MudText Typo="Typo.body1" Class="mb-3">
            @TranslationService.GetTranslation("warehouse.searchOrCreatePrompt", "Cerca un prodotto esistente per assegnare questo codice, oppure crea un nuovo prodotto.")
        </MudText>

        <!-- Keyboard Shortcuts Helper -->
        <MudAlert Severity="Severity.Info" Dense="true" Variant="Variant.Outlined" Class="mb-3">
            <MudText Typo="Typo.caption">
                <MudIcon Icon="@Icons.Material.Outlined.Keyboard" Size="Size.Small" Class="mr-1" />
                <strong>@TranslationService.GetTranslation("common.shortcuts", "Scorciatoie"):</strong> 
                Tab/Invio = campo successivo | Invio = Assegna | Esc = Annulla
            </MudText>
        </MudAlert>

        <!-- Product Search -->
        <UnifiedProductScanner 
            SelectedProduct="@_selectedProduct"
            SelectedProductChanged="@OnProductSelected"
            Title="@null"
            Placeholder="@TranslationService.GetTranslation("products.searchProduct", "Cerca Prodotto")"
            SearchHelperText="@TranslationService.GetTranslation("products.searchByCodeOrDescription", "Cerca per codice o descrizione")"
            ShowProductInfo="true"
            SearchMode="ProductSearchMode.Description"
            EditMode="ProductEditMode.None"
            CreateMode="ProductCreateMode.None"
            AllowClear="true"
            AutoFocus="true"
            Class="mb-4" />

        <!-- Code Type Selection for Assignment -->
        @if (_selectedProduct != null)
        {
            <MudForm @ref="_form" @bind-IsValid="@_isFormValid" Class="ef-dialog-form">
                <MudGrid Spacing="3">
                    <!-- Code Type and Code on the same row -->
                    <MudItem xs="12" md="5">
                        <MudSelect @bind-Value="_createCodeDto.CodeType"
                                   @ref="_codeTypeSelect"
                                   Label="@TranslationService.GetTranslation("products.codeType", "Tipo Codice")"
                                   Variant="Variant.Outlined"
                                   Required="true"
                                   RequiredError="@TranslationService.GetTranslation("validation.required", "Campo obbligatorio")"
                                   Adornment="Adornment.Start"
                                   AdornmentIcon="@Icons.Material.Outlined.Category"
                                   @onkeydown="@OnCodeTypeKeyDown">
                            <MudSelectItem Value="@("EAN")">EAN</MudSelectItem>
                            <MudSelectItem Value="@("UPC")">UPC</MudSelectItem>
                            <MudSelectItem Value="@("SKU")">SKU</MudSelectItem>
                            <MudSelectItem Value="@("QR")">QR Code</MudSelectItem>
                            <MudSelectItem Value="@("Barcode")">@TranslationService.GetTranslation("products.barcode", "Codice a Barre")</MudSelectItem>
                            <MudSelectItem Value="@("Other")">@TranslationService.GetTranslation("products.other", "Altro")</MudSelectItem>
                        </MudSelect>
                    </MudItem>

                    <MudItem xs="12" md="7">
                        <MudTextField @bind-Value="_createCodeDto.Code"
                                      Label="@TranslationService.GetTranslation("field.code", "Codice")"
                                      Variant="Variant.Outlined"
                                      Required="true"
                                      RequiredError="@TranslationService.GetTranslation("validation.required", "Campo obbligatorio")"
                                      MaxLength="100"
                                      ReadOnly="true"
                                      Adornment="Adornment.Start"
                                      AdornmentIcon="@Icons.Material.Outlined.QrCode"
                                      HelperText="@TranslationService.GetTranslation("products.codeFromScanner", "Codice letto da scanner")" />
                    </MudItem>

                    <!-- Alternative Description on a separate row -->
                    <MudItem xs="12">
                        <MudTextField @bind-Value="_createCodeDto.AlternativeDescription"
                                      @ref="_altDescriptionField"
                                      Label="@TranslationService.GetTranslation("products.alternativeDescription", "Descrizione Alternativa")"
                                      Variant="Variant.Outlined"
                                      Lines="2"
                                      MaxLength="200"
                                      Counter="200"
                                      Adornment="Adornment.Start"
                                      AdornmentIcon="@Icons.Material.Outlined.Description"
                                      HelperText="@TranslationService.GetTranslation("products.descriptionHelper", "Descrizione opzionale per questo codice")"
                                      @onkeydown="@OnAltDescriptionKeyDown" />
                    </MudItem>
                </MudGrid>
            </MudForm>
        }

        <!-- Action Buttons in Content Area -->
        @if (_selectedProduct == null)
        {
            <MudDivider Class="my-4" />
            <MudText Typo="Typo.body2" Class="mb-3">
                @TranslationService.GetTranslation("warehouse.noProductSelectedHint", "Non hai trovato il prodotto? Creane uno nuovo:")
            </MudText>
        }
        </div>
    </DialogContent>
    <DialogActions>
        <div class="ef-dialog-actions">
            <MudButton StartIcon="@Icons.Material.Outlined.SkipNext"
                      Color="Color.Default"
                      Variant="Variant.Outlined"
                      OnClick="@(() => SelectAction("skip"))">
                @TranslationService.GetTranslation("sales.skipAndContinue", "Salta e Continua")
            </MudButton>
            
            <MudSpacer />

            <MudButton OnClick="Cancel" 
                       Color="Color.Default" 
                       Variant="Variant.Outlined">
                @TranslationService.GetTranslation("common.cancel", "Annulla")
            </MudButton>
            
            @if (_selectedProduct == null)
            {
                <MudButton StartIcon="@DialogStyleConstants.Icons.Add"
                          Color="Color.Primary"
                          Variant="Variant.Filled"
                          OnClick="CreateNewProduct">
                    @TranslationService.GetTranslation("warehouse.createNewProduct", "Crea Nuovo Prodotto")
                </MudButton>
            }
            else
            {
                <MudButton StartIcon="@Icons.Material.Outlined.Link"
                          Color="Color.Primary"
                          Variant="Variant.Filled"
                          OnClick="AssignBarcodeToProduct"
                          Disabled="@(!_isFormValid || _isLoading)">
                    @TranslationService.GetTranslation("warehouse.assignAndContinue", "Assegna e Continua")
                </MudButton>
            }
        </div>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] 
    IMudDialogInstance MudDialog { get; set; } = null!;

    [Parameter]
    public string Barcode { get; set; } = string.Empty;

    [Parameter]
    public bool IsInventoryContext { get; set; } = false;

    [Parameter]
    public ProductDto? PreSelectedProduct { get; set; }

    private bool _isLoading = false;
    private bool _isFormValid = false;
    private MudForm? _form;
    private MudSelect<string>? _codeTypeSelect;
    private MudTextField<string>? _altDescriptionField;
    private ProductDto? _selectedProduct;
    private CreateProductCodeDto _createCodeDto = new();
    
    // Delay to allow form to render in the DOM before validation
    private const int FormRenderDelayMs = 150;
    
    // Typed result class for assignment
    public class AssignResult
    {
        public string Action { get; set; } = "assigned";
        public ProductDto Product { get; set; } = default!;
        public bool AutoAdvanceToQuantity { get; set; } = true;
    }

    protected override async Task OnInitializedAsync()
    {
        _createCodeDto.Code = Barcode;
        _createCodeDto.CodeType = "Barcode";
        _createCodeDto.Status = ProductCodeStatus.Active;
        
        // If a product was pre-selected (e.g., after creation), set it
        if (PreSelectedProduct != null)
        {
            _selectedProduct = PreSelectedProduct;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await base.OnAfterRenderAsync(firstRender);
        
        // If a product was pre-selected, trigger form validation after first render
        if (firstRender && _selectedProduct != null && _form != null)
        {
            Logger.LogInformation("Pre-selected product detected, triggering form validation for product {ProductId}", _selectedProduct.Id);
            await Task.Delay(FormRenderDelayMs);
            await _form.Validate();
            Logger.LogInformation("Form validation result for pre-selected product: {IsValid}, CodeType: {CodeType}, Code: {Code}", 
                _isFormValid, _createCodeDto.CodeType, _createCodeDto.Code);
            StateHasChanged();
        }
    }

    private async Task OnProductSelected(ProductDto? product)
    {
        _selectedProduct = product;
        
        Logger.LogInformation("Product selected: {ProductId} - {ProductName}", 
            product?.Id, product?.Name);
        
        await InvokeAsync(async () =>
        {
            StateHasChanged();
            
            if (product != null)
            {
                // Wait for the form to be rendered in the DOM
                await Task.Delay(FormRenderDelayMs);
                
                if (_form != null)
                {
                    Logger.LogInformation("Triggering form validation for product {ProductId}", product.Id);
                    await _form.Validate();
                    
                    Logger.LogInformation("Form validation result: {IsValid}, CodeType: {CodeType}, Code: {Code}", 
                        _isFormValid, _createCodeDto.CodeType, _createCodeDto.Code);
                    
                    StateHasChanged();
                }
                else
                {
                    Logger.LogWarning("Form reference is null after product selection");
                }
            }
        });
    }

    private async Task AssignBarcodeToProduct()
    {
        if (!_isFormValid || _selectedProduct == null)
            return;

        _isLoading = true;
        try
        {
            _createCodeDto.ProductId = _selectedProduct.Id;
            var result = await ProductService.CreateProductCodeAsync(_createCodeDto);

            if (result != null)
            {
                Snackbar.Add(
                    TranslationService.GetTranslation("products.barcodeAssignedSuccess", "Codice a barre assegnato con successo a {0}", _selectedProduct.Name), 
                    Severity.Success
                );
                
                // Use typed result
                var assignResult = new AssignResult
                {
                    Action = "assigned",
                    Product = _selectedProduct,
                    AutoAdvanceToQuantity = true
                };
                
                MudDialog.Close(DialogResult.Ok(assignResult));
            }
            else
            {
                Snackbar.Add(TranslationService.GetTranslation("products.assignError", "Errore nell'assegnazione del codice"), Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error assigning barcode to product");
            Snackbar.Add(TranslationService.GetTranslation("products.assignError", "Errore nell'assegnazione del codice"), Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void SelectAction(string action)
    {
        MudDialog.Close(DialogResult.Ok(action));
    }

    private void Cancel()
    {
        MudDialog.Cancel();
    }

    private async Task OnCodeTypeKeyDown(KeyboardEventArgs e)
    {
        // Tab or Enter to move to alternative description
        if ((e.Key == "Tab" || e.Key == "Enter") && !string.IsNullOrWhiteSpace(_createCodeDto.CodeType))
        {
            if (_altDescriptionField != null)
            {
                await Task.Delay(100);
                await _altDescriptionField.FocusAsync();
            }
        }
    }

    private async Task OnAltDescriptionKeyDown(KeyboardEventArgs e)
    {
        // Enter to submit if form is valid
        if (e.Key == "Enter" && _isFormValid && !e.ShiftKey)
        {
            await AssignBarcodeToProduct();
        }
    }

    private async Task CreateNewProduct()
    {
        var parameters = new DialogParameters
        {
            { "PrefilledCode", Barcode },
            { "AutoAssignCode", true }
        };

        var dialog = await DialogService.ShowAsync<QuickCreateProductDialog>(
            TranslationService.GetTranslation("warehouse.createNewProduct", "Crea Nuovo Prodotto"),
            parameters,
            DialogStyleConstants.ProductDialogs.QuickCreate);

        var result = await dialog.Result;

        if (!result.Canceled && result.Data is ProductDto createdProduct)
        {
            // Return the created product to the caller
            MudDialog.Close(DialogResult.Ok(createdProduct));
        }
    }
}
