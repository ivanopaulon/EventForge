@using EventForge.DTOs.Warehouse
@inject ITranslationService TranslationService

<MudDialog>
    <DialogContent>
        <MudStack Spacing="3">
            <!-- Product Information Display -->
            @if (!string.IsNullOrEmpty(ProductName))
            {
                <MudPaper Elevation="0" Class="pa-3" Style="background-color: var(--mud-palette-background-grey);">
                    <div>
                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                            @TranslationService.GetTranslation("warehouse.productName", "Nome Prodotto")
                        </MudText>
                        <MudText Typo="Typo.body1" Style="font-weight: 600;">
                            @ProductName
                        </MudText>
                    </div>
                </MudPaper>
            }

            <!-- Edit Form -->
            <MudForm @ref="_form" @bind-IsValid="@_isFormValid">
                <MudStack Spacing="3">
                    <MudAutocomplete T="StorageLocationDto"
                                    @bind-Value="_selectedLocation"
                                    Label="@TranslationService.GetTranslation("warehouse.location", "Ubicazione")"
                                    Variant="Variant.Outlined"
                                    SearchFunc="@SearchLocations"
                                    ToStringFunc="@(l => l?.Code ?? string.Empty)"
                                    Immediate="true"
                                    ResetValueOnEmptyText="true"
                                    CoerceText="true"
                                    CoerceValue="false"
                                    Adornment="Adornment.Start"
                                    AdornmentIcon="@Icons.Material.Outlined.LocationOn"
                                    HelperText="@TranslationService.GetTranslation("warehouse.selectLocation", "Seleziona ubicazione")">
                        <ItemTemplate Context="location">
                            <MudText Typo="Typo.body2">@location.Code</MudText>
                            @if (!string.IsNullOrEmpty(location.Description))
                            {
                                <MudText Typo="Typo.caption" Color="Color.Secondary">@location.Description</MudText>
                            }
                        </ItemTemplate>
                        <NoItemsTemplate>
                            <MudText Typo="Typo.body2" Color="Color.Secondary">
                                @TranslationService.GetTranslation("warehouse.noLocationsFound", "Nessuna ubicazione trovata")
                            </MudText>
                        </NoItemsTemplate>
                    </MudAutocomplete>

                    <MudNumericField T="decimal"
                                    @bind-Value="_quantity"
                                    Label="@TranslationService.GetTranslation("warehouse.quantity", "QuantitÃ ")"
                                    Variant="Variant.Outlined"
                                    Min="0"
                                    Required="true"
                                    RequiredError="@TranslationService.GetTranslation("validation.required", "Campo obbligatorio")"
                                    Adornment="Adornment.Start"
                                    AdornmentIcon="@Icons.Material.Outlined.Numbers" />

                    <MudTextField @bind-Value="_notes"
                                 Label="@TranslationService.GetTranslation("warehouse.notes", "Note")"
                                 Variant="Variant.Outlined"
                                 Lines="2"
                                 MaxLength="200"
                                 Counter="200"
                                 Adornment="Adornment.Start"
                                 AdornmentIcon="@Icons.Material.Outlined.Comment" />
                </MudStack>
            </MudForm>
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel" 
                   Color="Color.Default" 
                   Variant="Variant.Text">
            @TranslationService.GetTranslation("common.cancel", "Annulla")
        </MudButton>
        <MudButton OnClick="Submit" 
                   Color="Color.Primary" 
                   Variant="Variant.Filled"
                   Disabled="@(!_isFormValid)">
            @TranslationService.GetTranslation("common.save", "Salva")
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] IMudDialogInstance MudDialog { get; set; } = null!;

    [Parameter] public decimal Quantity { get; set; }
    [Parameter] public Guid? LocationId { get; set; }
    [Parameter] public string? Notes { get; set; }
    [Parameter] public string? ProductName { get; set; }
    [Parameter] public List<StorageLocationDto>? AvailableLocations { get; set; }

    private MudForm? _form;
    private bool _isFormValid;
    private decimal _quantity;
    private Guid? _locationId;
    private StorageLocationDto? _selectedLocation;
    private string? _notes;
    private const int MaxLocationSearchResults = 20;

    protected override void OnInitialized()
    {
        _quantity = Quantity;
        _locationId = LocationId;
        _notes = Notes;
        
        // Set the selected location if LocationId is provided
        if (_locationId.HasValue && AvailableLocations != null)
        {
            _selectedLocation = AvailableLocations.FirstOrDefault(l => l.Id == _locationId.Value);
        }
    }

    private Task<IEnumerable<StorageLocationDto>> SearchLocations(string value, CancellationToken token)
    {
        if (AvailableLocations == null)
            return Task.FromResult(Enumerable.Empty<StorageLocationDto>());

        if (string.IsNullOrWhiteSpace(value))
            return Task.FromResult(AvailableLocations.Take(MaxLocationSearchResults));
        
        var results = AvailableLocations
            .Where(l => l.Code.Contains(value, StringComparison.OrdinalIgnoreCase) ||
                       (l.Description?.Contains(value, StringComparison.OrdinalIgnoreCase) ?? false))
            .Take(MaxLocationSearchResults);
        
        return Task.FromResult(results);
    }

    private void Cancel()
    {
        MudDialog.Cancel();
    }

    private void Submit()
    {
        if (_isFormValid)
        {
            var result = new EditInventoryRowResult
            {
                Quantity = _quantity,
                LocationId = _selectedLocation?.Id,
                Notes = _notes
            };
            MudDialog.Close(DialogResult.Ok(result));
        }
    }

    public class EditInventoryRowResult
    {
        public decimal Quantity { get; set; }
        public Guid? LocationId { get; set; }
        public string? Notes { get; set; }
    }
}
