@using Microsoft.AspNetCore.Authorization
@using EventForge.DTOs.Tenants
@attribute [AllowAnonymous]
@inject IAuthService AuthService
@inject ISnackbar Snackbar
@inject ITranslationService TranslationService

<MudDialog ClassActions="pa-4" ClassContent="py-0">
    <TitleContent>
        <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
            <MudImage Src="/eventforge.ico" Width="32" Height="32" Alt="EventForge Logo"></MudImage>
            <MudText Typo="Typo.h6">
                @TranslationService.GetTranslation("auth.login", "EventForge Login")
            </MudText>
        </MudStack>
    </TitleContent>
    <DialogContent>
        <PageLoadingOverlay IsVisible="_isLoading"
                            Message="@TranslationService.GetTranslation("auth.loginInProgress", "Logging in...")" />


        <MudForm @ref="form"
                 @bind-IsValid="@_isFormValid"
                 role="form"
                 aria-label="Modulo di accesso">
            <MudStack Spacing="3" Class="mt-4">
                <!-- Tenant selector -->
                @if (_isLoadingTenants)
                {
                    <MudSkeleton Height="56px" />
                }
                else if (_tenants?.Any() == true)
                {
                    <MudSelect T="string"
                               @bind-Value="_selectedTenantId"
                               Label="@TranslationService.GetTranslation("auth.selectTenant", "Seleziona Tenant")"
                               Variant="Variant.Outlined"
                               Required="true"
                               RequiredError="@TranslationService.GetTranslation("auth.tenantRequired", "Seleziona un tenant")"
                               Disabled="_isLoading"
                               Dense="true"
                               Placeholder="@TranslationService.GetTranslation("auth.selectTenantPlaceholder", "Scegli tenant...")"
                               For="@(() => _selectedTenantId)">
                        @foreach (var t in _tenants)
                        {
                            <MudSelectItem Value="@t.Id.ToString()">@($"{t.DisplayName} ({t.Name})")</MudSelectItem>
                        }
                    </MudSelect>
                }
                else
                {
                    <MudAlert Severity="Severity.Info">
                        @TranslationService.GetTranslation("auth.noTenants", "Nessun tenant disponibile. Contatta l'amministratore.")
                    </MudAlert>
                }

                <MudTextField @bind-Value="_loginRequest.Username"
                              For="@(() => _loginRequest.Username)"
                              Label="@TranslationService.GetTranslation("auth.username", "Username")"
                              Variant="Variant.Outlined"
                              Required="true"
                              RequiredError="@TranslationService.GetTranslation("auth.usernameRequired", "Username is required")"
                              Disabled="_isLoading"
                              autocomplete="username"
                              InputType="InputType.Text"
                              Margin="Margin.Dense" />

                <MudTextField @bind-Value="_loginRequest.Password"
                              For="@(() => _loginRequest.Password)"
                              Label="@TranslationService.GetTranslation("auth.password", "Password")"
                              Variant="Variant.Outlined"
                              InputType="InputType.Password"
                              Required="true"
                              RequiredError="@TranslationService.GetTranslation("auth.passwordRequired", "Password is required")"
                              Disabled="_isLoading"
                              autocomplete="current-password"
                              Margin="Margin.Dense" />

                <MudCheckBox T="bool"
                             @bind-Value="_loginRequest.RememberMe"
                             Label="@TranslationService.GetTranslation("auth.rememberMe", "Remember me")"
                             Disabled="_isLoading" />
            </MudStack>
        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudButton ButtonType="ButtonType.Button"
                   Variant="Variant.Filled"
                   Color="Color.Primary"
                   Size="Size.Medium"
                   FullWidth="true"
                   OnClick="HandleLogin"
                   Disabled="@(!_isFormValid || _isLoading)"
                   aria-label="Accedi al sistema">
            @TranslationService.GetTranslation("auth.login", "Login")
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] 
    private IMudDialogInstance MudDialog { get; set; } = null!;

    private MudForm form = null!;
    private bool _isFormValid;
    private bool _isLoading = false;
    private bool _isLoadingTenants = true;
    private readonly LoginRequestDto _loginRequest = new();
    private List<TenantResponseDto> _tenants = new();
    private string? _selectedTenantId;

    protected override async Task OnInitializedAsync()
    {
        await LoadTenantsAsync();
    }

    private async Task LoadTenantsAsync()
    {
        try
        {
            _isLoadingTenants = true;
            _tenants = (await AuthService.GetAvailableTenantsAsync()).ToList();

            // Auto-select first tenant if none chosen
            if (_tenants.Any())
            {
                _selectedTenantId ??= _tenants.First().Id.ToString();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add(TranslationService.GetTranslation("auth.tenantsLoadError", "Errore nel caricamento dei tenant: {0}", ex.Message), Severity.Error);
            _tenants = new List<TenantResponseDto>();
        }
        finally
        {
            _isLoadingTenants = false;
            StateHasChanged();
        }
    }

    private async Task HandleLogin()
    {
        // Ensure form validation runs
        await form.Validate();
        if (!_isFormValid) return;

        // Ensure tenant selected
        if (string.IsNullOrWhiteSpace(_selectedTenantId))
        {
            Snackbar.Add(TranslationService.GetTranslation("auth.tenantRequired", "Seleziona un tenant"), Severity.Warning);
            return;
        }

        // Set tenant code on request
        _loginRequest.TenantCode = _selectedTenantId;

        _isLoading = true;
        try
        {
            var result = await AuthService.LoginAsync(_loginRequest);
            if (result != null)
            {
                Snackbar.Add(TranslationService.GetTranslation("auth.loginSuccess", "Login successful!"), Severity.Success);
                
                // Close dialog with success result
                MudDialog.Close(DialogResult.Ok(true));
            }
            else
            {
                Snackbar.Add(TranslationService.GetTranslation("auth.loginFailed", "Login failed. Please check your credentials."), Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add(TranslationService.GetTranslation("auth.loginError", "Login error: {0}", ex.Message), Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }
}
