@using Microsoft.AspNetCore.Authorization
@using EventForge.DTOs.Tenants
@attribute [AllowAnonymous]
@inject IAuthService AuthService
@inject IProfileService ProfileService
@inject ISnackbar Snackbar
@inject ITranslationService TranslationService
@inject IDialogService DialogService

<MudDialog ClassActions="pa-4" ClassContent="py-0" Class="ef-dialog">
    <TitleContent>
        <MudImage Src="/eventforgetitle.svg" Alt="EventForge Logo"></MudImage>
    </TitleContent>
    <DialogContent>
        <!-- Overlay during login submission -->
        <PageLoadingOverlay IsVisible="_isLoading"
                            Message="@TranslationService.GetTranslation("auth.loginInProgress", "Logging in...")" />

        <!-- Overlay during initial tenant loading -->
        <PageLoadingOverlay IsVisible="_isLoadingTenants"
                            Message="@TranslationService.GetTranslation("auth.connectingToServer", "Connessione al server...")" />

        @if (!_isLoadingTenants)
        {
            <MudForm @ref="form"
                     @bind-IsValid="@_isFormValid"
                     role="form"
                     aria-label="Modulo di accesso">
                <MudStack Spacing="3" Class="mt-4">
                    <!-- Tenant selector -->
                    @if (_tenants?.Any() == true)
                    {
                        <MudSelect T="string"
                                   Class="ef-select" 
                                   @bind-Value="_selectedTenantId"
                                   Label="@TranslationService.GetTranslation("auth.selectTenant", "Seleziona Tenant")"
                                   Variant="Variant.Outlined"
                                   Required="true"
                                   RequiredError="@TranslationService.GetTranslation("auth.tenantRequired", "Seleziona un tenant")"
                                   Disabled="_isLoading"
                                   Dense="true"
                                   Placeholder="@TranslationService.GetTranslation("auth.selectTenantPlaceholder", "Scegli tenant...")"
                                   For="@(() => _selectedTenantId)">
                            @foreach (var t in _tenants)
                            {
                                <MudSelectItem Value="@t.Id.ToString()">@($"{t.DisplayName} ({t.Name})")</MudSelectItem>
                            }
                        </MudSelect>
                    }
                    else
                    {
                        <MudAlert Severity="Severity.Warning">
                            @TranslationService.GetTranslation("auth.noTenantsAvailable", "Nessun tenant disponibile. Contatta l'amministratore.")
                        </MudAlert>
                    }

                    <MudTextField @bind-Value="_loginRequest.Username"
                                  Class="ef-input"
                                  For="@(() => _loginRequest.Username)"
                                  Label="@TranslationService.GetTranslation("auth.username", "Username")"
                                  Variant="Variant.Outlined"
                                  Required="true"
                                  RequiredError="@TranslationService.GetTranslation("auth.usernameRequired", "Username is required")"
                                  Disabled="_isLoading"
                                  autocomplete="username"
                                  InputType="InputType.Text"
                                  Margin="Margin.Dense" />

                    <MudTextField @bind-Value="_loginRequest.Password"
                                  Class="ef-input"
                                  For="@(() => _loginRequest.Password)"
                                  Label="@TranslationService.GetTranslation("auth.password", "Password")"
                                  Variant="Variant.Outlined"
                                  InputType="@_passwordInputType"
                                  Required="true"
                                  RequiredError="@TranslationService.GetTranslation("auth.passwordRequired", "Password is required")"
                                  Disabled="_isLoading"
                                  autocomplete="current-password"
                                  Margin="Margin.Dense"
                                  Adornment="Adornment.End"
                                  AdornmentIcon="@_passwordVisibilityIcon"
                                  OnAdornmentClick="TogglePasswordVisibility"
                                  AdornmentAriaLabel="@TranslationService.GetTranslation("auth.togglePasswordVisibility", "Toggle password visibility")" />

                    <MudCheckBox T="bool"
                                 @bind-Value="_loginRequest.RememberMe"
                                 Label="@TranslationService.GetTranslation("auth.rememberMe", "Remember me")"
                                 Disabled="_isLoading" />

                    <MudText Typo="Typo.caption" Color="Color.Info" Class="mt-2">
                        @TranslationService.GetTranslation("auth.temporaryPasswordHint", "Did you receive a temporary password from the administrator? Log in and you will be guided through the password change.")
                    </MudText>
                </MudStack>
            </MudForm>
        }
    </DialogContent>
    <DialogActions>
        @if (!_isLoadingTenants)
        {
            <MudStack Row="true" Spacing="2" Style="width: 100%;">
                <MudButton ButtonType="ButtonType.Button"
                           Variant="Variant.Text"
                           Color="Color.Default"
                           OnClick="Cancel"
                           Disabled="_isLoading">
                    @TranslationService.GetTranslation("common.cancel", "Cancel")
                </MudButton>
                <MudSpacer />
                <MudButton ButtonType="ButtonType.Button"
                           Variant="Variant.Outlined"
                           Color="Color.Secondary"
                           OnClick="OpenChangePasswordDialog"
                           Disabled="_isLoading">
                    @TranslationService.GetTranslation("auth.changePassword", "Change Password")
                </MudButton>
                <MudButton ButtonType="ButtonType.Button"
                           Variant="Variant.Filled"
                           Color="Color.Primary"
                           OnClick="HandleLogin"
                           Disabled="@(!_isFormValid || _isLoading || _tenants?.Any() != true)"
                           aria-label="Accedi al sistema">
                    @TranslationService.GetTranslation("auth.login", "Login")
                </MudButton>
            </MudStack>
        }
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] 
    private IMudDialogInstance MudDialog { get; set; } = null!;

    private MudForm form = null!;
    private bool _isFormValid;
    private bool _isLoading = false;
    private bool _isLoadingTenants = true;
    private readonly LoginRequestDto _loginRequest = new();
    private List<TenantResponseDto> _tenants = new();
    private string? _selectedTenantId;
    private bool _passwordVisible = false;
    private InputType _passwordInputType = InputType.Password;
    private string _passwordVisibilityIcon = Icons.Material.Filled.VisibilityOff;

    protected override async Task OnInitializedAsync()
    {
        await LoadTenantsAsync();
    }

    private async Task LoadTenantsAsync()
    {
        try
        {
            _isLoadingTenants = true;
            StateHasChanged(); // Force UI update
            
            _tenants = (await AuthService.GetAvailableTenantsAsync()).ToList();

            // Auto-select first tenant if none chosen
            if (_tenants.Any())
            {
                _selectedTenantId ??= _tenants.First().Id.ToString();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add(
                TranslationService.GetTranslation("auth.tenantsLoadError", 
                    "Errore nel caricamento dei tenant: {0}", ex.Message), 
                Severity.Error);
            _tenants = new List<TenantResponseDto>();
        }
        finally
        {
            _isLoadingTenants = false;
            StateHasChanged(); // Force UI update
        }
    }

    private async Task HandleLogin()
    {
        // Ensure form validation runs
        await form.Validate();
        if (!_isFormValid) return;

        // Ensure tenant selected
        if (string.IsNullOrWhiteSpace(_selectedTenantId))
        {
            Snackbar.Add(
                TranslationService.GetTranslation("auth.tenantRequired", "Seleziona un tenant"), 
                Severity.Warning);
            return;
        }

        // Set tenant code on request
        _loginRequest.TenantCode = _selectedTenantId;

        _isLoading = true;
        StateHasChanged(); // Force UI update
        
        try
        {
            var result = await AuthService.LoginAsync(_loginRequest);
            if (result != null)
            {
                Snackbar.Add(
                    TranslationService.GetTranslation("auth.loginSuccess", "Login successful!"), 
                    Severity.Success);
                
                // Check if user must change password
                if (result.MustChangePassword)
                {
                    await HandleMustChangePassword();
                }
                else
                {
                    // Close dialog with success result
                    MudDialog.Close(DialogResult.Ok(true));
                }
            }
            else
            {
                Snackbar.Add(
                    TranslationService.GetTranslation("auth.loginFailed", 
                        "Login failed. Please check your credentials."), 
                    Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add(
                TranslationService.GetTranslation("auth.loginError", 
                    "Errore durante il login: {0}", ex.Message), 
                Severity.Error);
        }
        finally
        {
            _isLoading = false;
            StateHasChanged(); // Force UI update
        }
    }

    private async Task HandleMustChangePassword()
    {
        // Open ChangePasswordDialog as blocking dialog
        var options = new DialogOptions 
        { 
            CloseButton = false, 
            BackdropClick = false,
            MaxWidth = MaxWidth.Small,
            FullWidth = true
        };

        var dialog = await DialogService.ShowAsync<ChangePasswordDialog>(
            TranslationService.GetTranslation("auth.mustChangePassword", "You must change your password"),
            options);
        
        var result = await dialog.Result;

        if (result != null && !result.Canceled)
        {
            // Password changed successfully, close login dialog
            MudDialog.Close(DialogResult.Ok(true));
        }
        else
        {
            // User cancelled password change, logout
            Snackbar.Add(
                TranslationService.GetTranslation("auth.passwordChangeRequired", 
                    "Password change is required. You have been logged out."),
                Severity.Warning);
            
            await AuthService.LogoutAsync();
            
            // Keep login dialog open for retry
            _isLoading = false;
            StateHasChanged();
        }
    }

    private async Task OpenChangePasswordDialog()
    {
        // Open ChangePasswordDialog for voluntary password change
        var options = new DialogOptions 
        { 
            CloseButton = true, 
            BackdropClick = true,
            MaxWidth = MaxWidth.Small,
            FullWidth = true
        };

        var dialog = await DialogService.ShowAsync<ChangePasswordDialog>(
            TranslationService.GetTranslation("auth.changePassword", "Change Password"),
            options);
    }

    private void TogglePasswordVisibility()
    {
        if (_passwordVisible)
        {
            _passwordVisible = false;
            _passwordInputType = InputType.Password;
            _passwordVisibilityIcon = Icons.Material.Filled.VisibilityOff;
        }
        else
        {
            _passwordVisible = true;
            _passwordInputType = InputType.Text;
            _passwordVisibilityIcon = Icons.Material.Filled.Visibility;
        }
    }

    private void Cancel()
    {
        MudDialog.Cancel();
    }
}
