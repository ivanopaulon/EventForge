@using EventForge.DTOs.Products
@using EventForge.DTOs.Warehouse
@using EventForge.Client.Shared.Components.Products
@inject ITranslationService TranslationService
@inject IProductService ProductService
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@(IsEditMode ? Icons.Material.Outlined.Edit : Icons.Material.Outlined.Inventory)" Class="mr-2" />
            @(IsEditMode 
                ? TranslationService.GetTranslation("warehouse.editRow", "Modifica Riga Inventario")
                : TranslationService.GetTranslation("warehouse.inventoryEntry", "Inserimento Inventario"))
            @if (_localProduct != null)
            {
                <span>- @_localProduct.Name</span>
            }
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudStack Spacing="3">
            <!-- Product Quick Info Component with inline editing -->
            @if (_localProduct != null)
            {
                <ProductQuickInfo @ref="_productQuickInfo"
                                  Product="@_localProduct"
                                  AllowEdit="true"
                                  ShowCurrentStock="false"
                                  OnProductUpdated="@OnProductUpdatedAsync" />
            }

            <!-- Alternative Unit Notice -->
            @if (ConversionFactor > 1)
            {
                <MudAlert Severity="Severity.Warning" Dense="true" Variant="Variant.Outlined">
                    <MudText Typo="Typo.caption">
                        <MudIcon Icon="@Icons.Material.Outlined.SwapHoriz" Size="Size.Small" Class="mr-1" />
                        <strong>Unità alternativa rilevata:</strong> 
                        Fattore di conversione @ConversionFactor.ToString("0.##") - Le quantità sono già convertite in unità base
                    </MudText>
                </MudAlert>
            }

            <!-- Keyboard Shortcuts Helper -->
            <MudAlert Severity="Severity.Info" Dense="true" Variant="Variant.Outlined">
                <MudText Typo="Typo.caption">
                    <MudIcon Icon="@Icons.Material.Outlined.Keyboard" Size="Size.Small" Class="mr-1" />
                    <strong>@TranslationService.GetTranslation("common.shortcuts", "Scorciatoie"):</strong> 
                    Tab = campo successivo | Invio su Quantità = Aggiungi | Esc = Annulla
                </MudText>
            </MudAlert>

            <!-- Entry Form -->
            <MudForm @ref="_form" @bind-IsValid="@_isFormValid">
                <MudStack Spacing="3">
                    @if (IsEditMode)
                    {
                        <!-- In edit mode, show location as read-only -->
                        <MudTextField Value="@_locationDisplayText"
                                     Label="@TranslationService.GetTranslation("warehouse.storageLocation", "Ubicazione")"
                                     Variant="Variant.Outlined"
                                     ReadOnly="true"
                                     Adornment="Adornment.Start"
                                     AdornmentIcon="@Icons.Material.Outlined.LocationOn" />
                    }
                    else
                    {
                        <!-- In insert mode, allow location selection -->
                        <MudSelect T="Guid?"
                                   @bind-Value="@_selectedLocationId"
                                   Label="@TranslationService.GetTranslation("warehouse.storageLocation", "Ubicazione")"
                                   Variant="Variant.Outlined"
                                   Required="true"
                                   RequiredError="@TranslationService.GetTranslation("validation.required", "Campo obbligatorio")"
                                   Adornment="Adornment.Start"
                                   AdornmentIcon="@Icons.Material.Outlined.LocationOn"
                                   @ref="_locationSelect"
                                   @onkeydown="@OnLocationKeyDown">
                            @if (Locations != null)
                            {
                                @foreach (var location in Locations)
                                {
                                    <MudSelectItem Value="@((Guid?)location.Id)">
                                        @location.Code - @location.Description
                                    </MudSelectItem>
                                }
                            }
                        </MudSelect>
                    }

                    <MudNumericField T="decimal"
                                    @bind-Value="_quantity"
                                    Label="@(ConversionFactor > 1 ? TranslationService.GetTranslation("warehouse.quantity", "Quantità") + " (unità base)" : TranslationService.GetTranslation("warehouse.quantity", "Quantità"))"
                                    Variant="Variant.Outlined"
                                    Min="0"
                                    Required="true"
                                    RequiredError="@TranslationService.GetTranslation("validation.required", "Campo obbligatorio")"
                                    Adornment="Adornment.Start"
                                    AdornmentIcon="@Icons.Material.Outlined.Numbers"
                                    @ref="_quantityField"
                                    @onkeydown="@OnQuantityKeyDown" />

                    <MudTextField @bind-Value="_notes"
                                 Label="@TranslationService.GetTranslation("warehouse.notes", "Note")"
                                 Variant="Variant.Outlined"
                                 Lines="2"
                                 MaxLength="200"
                                 Counter="200"
                                 Adornment="Adornment.Start"
                                 AdornmentIcon="@Icons.Material.Outlined.Comment"
                                 @onkeydown="@OnNotesKeyDown" />
                </MudStack>
            </MudForm>
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel" Color="Color.Default">
            @TranslationService.GetTranslation("common.cancel", "Annulla")
        </MudButton>
        <MudButton OnClick="Submit" 
                   Color="@(IsEditMode ? Color.Primary : Color.Success)" 
                   Variant="Variant.Filled"
                   StartIcon="@(IsEditMode ? Icons.Material.Outlined.Save : Icons.Material.Outlined.Add)"
                   Disabled="@(!_isFormValid)">
            @(IsEditMode 
                ? TranslationService.GetTranslation("common.save", "Salva")
                : TranslationService.GetTranslation("warehouse.addToInventory", "Aggiungi al Documento"))
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    IMudDialogInstance MudDialog { get; set; } = null!;

    [Parameter]
    public bool IsEditMode { get; set; } = false;

    [Parameter]
    public ProductDto? Product { get; set; }

    [Parameter]
    public List<StorageLocationDto>? Locations { get; set; }

    [Parameter]
    public decimal ConversionFactor { get; set; } = 1m;

    [Parameter]
    public EventCallback<Guid> OnQuickEditProduct { get; set; }

    // Edit mode specific parameters
    [Parameter]
    public Guid? ExistingLocationId { get; set; }

    [Parameter]
    public string? ExistingLocationName { get; set; }

    [Parameter]
    public decimal Quantity { get; set; }

    [Parameter]
    public string? Notes { get; set; }

    private MudForm? _form;
    private MudSelect<Guid?>? _locationSelect;
    private MudNumericField<decimal>? _quantityField;
    private ProductQuickInfo? _productQuickInfo;
    private bool _isFormValid;
    private Guid? _selectedLocationId;
    private decimal _quantity;
    private string _notes = string.Empty;
    private ProductDto? _localProduct;
    private string _locationDisplayText = string.Empty;

    protected override void OnInitialized()
    {
        if (IsEditMode)
        {
            // Edit mode: use existing values
            _selectedLocationId = ExistingLocationId;
            _locationDisplayText = ExistingLocationName ?? string.Empty;
            _quantity = Quantity;
            _notes = Notes ?? string.Empty;
        }
        else
        {
            // Insert mode: Initialize quantity with conversion factor for alternative units
            // This converts 1 alternative unit to base units
            _quantity = ConversionFactor;
        }
        
        // Keep a local copy of the product that can be updated
        _localProduct = Product;
    }
    
    protected override void OnParametersSet()
    {
        // Update local product if the parameter changes
        _localProduct = Product;
        
        if (IsEditMode)
        {
            _locationDisplayText = ExistingLocationName ?? string.Empty;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            if (IsEditMode)
            {
                // In edit mode, focus on quantity field
                if (_quantityField != null)
                {
                    await _quantityField.FocusAsync();
                }
            }
            else
            {
                // Insert mode: Auto-select location if only one exists
                if (Locations?.Count == 1)
                {
                    _selectedLocationId = Locations[0].Id;
                    StateHasChanged();
                    // Focus on quantity field since location is auto-selected
                    if (_quantityField != null)
                    {
                        await _quantityField.FocusAsync();
                    }
                }
                else if (_locationSelect != null)
                {
                    // Focus on location select if multiple locations
                    await _locationSelect.FocusAsync();
                }
            }
        }
    }

    private async Task OnLocationKeyDown(KeyboardEventArgs e)
    {
        // Tab or Enter to move to quantity field
        if ((e.Key == "Tab" || e.Key == "Enter") && _selectedLocationId.HasValue)
        {
            if (_quantityField != null)
            {
                await Task.Delay(100); // Small delay to ensure location is set
                await _quantityField.FocusAsync();
            }
        }
    }

    private async Task OnQuantityKeyDown(KeyboardEventArgs e)
    {
        // Ctrl+E to edit product info
        if (e.Key.ToLower() == "e" && e.CtrlKey && _productQuickInfo != null)
        {
            await _productQuickInfo.HandleKeyboardShortcut("e", true);
            return;
        }
        
        // Enter to submit if form is valid (skip notes)
        if (e.Key == "Enter" && _isFormValid && !e.ShiftKey)
        {
            Submit();
        }
    }

    private async Task OnNotesKeyDown(KeyboardEventArgs e)
    {
        // Ctrl+Enter to submit from notes field
        if (e.Key == "Enter" && e.CtrlKey && _isFormValid)
        {
            Submit();
        }
    }

    private void Cancel()
    {
        MudDialog.Cancel();
    }

    private void Submit()
    {
        if (!_isFormValid)
            return;

        if (IsEditMode)
        {
            // Edit mode: return only quantity and notes
            var editResult = new InventoryRowResult
            {
                IsEditMode = true,
                Quantity = _quantity,
                Notes = _notes
            };
            MudDialog.Close(DialogResult.Ok(editResult));
        }
        else
        {
            // Insert mode: return location, quantity and notes
            if (!_selectedLocationId.HasValue)
                return;

            var insertResult = new InventoryRowResult
            {
                IsEditMode = false,
                LocationId = _selectedLocationId.Value,
                Quantity = _quantity,
                Notes = _notes
            };
            MudDialog.Close(DialogResult.Ok(insertResult));
        }
    }

    private async Task OnProductUpdatedAsync()
    {
        // Refresh product data after update
        if (_localProduct?.Id != null)
        {
            var refreshedProduct = await ProductService.GetProductByIdAsync(_localProduct.Id);
            if (refreshedProduct != null)
            {
                _localProduct = refreshedProduct;
                StateHasChanged();
            }
        }
    }

    public class InventoryRowResult
    {
        public bool IsEditMode { get; set; }
        public Guid LocationId { get; set; }
        public decimal Quantity { get; set; }
        public string Notes { get; set; } = string.Empty;
    }
}
