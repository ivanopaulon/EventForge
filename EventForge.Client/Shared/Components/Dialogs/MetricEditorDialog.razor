@using EventForge.DTOs.Dashboard
@using EventForge.Client.Shared.Components.MetricBuilder
@inject ITranslationService TranslationService
@inject ISnackbar Snackbar

<MudDialog>
    <DialogContent>
        <MudStepper @ref="_stepper" @bind-ActiveStepIndex="_activeStepIndex" Color="Color.Primary" Variant="Variant.Filled">
            @* Step 1: Basic Information *@
            <MudStep title="Informazioni Base" Icon="@Icons.Material.Outlined.Info">
                <MudStack Spacing="3" Class="mt-4">
                    <MudText Typo="Typo.h6">
                        @(IsNewMetric ? "Crea Nuova Metrica" : "Modifica Metrica")
                    </MudText>
                    
                    <MudTextField @bind-Value="Metric.Title"
                                  Label="Titolo Metrica"
                                  Variant="Variant.Outlined"
                                  Required="true"
                                  HelperText="Nome descrittivo della metrica da visualizzare"
                                  Immediate="true" />
                    
                    <MudTextField @bind-Value="Metric.Description"
                                  Label="Descrizione (opzionale)"
                                  Variant="Variant.Outlined"
                                  Lines="2"
                                  HelperText="Testo tooltip per spiegare la metrica" />
                </MudStack>
            </MudStep>

            @* Step 2: Calculation Type and Field Selection *@
            <MudStep title="Tipo Calcolo" Icon="@Icons.Material.Outlined.Calculate">
                <MudStack Spacing="3" Class="mt-4">
                    <MudText Typo="Typo.h6">Tipo di Calcolo e Campo</MudText>
                    
                    <MudSelect @bind-Value="Metric.Type"
                               Label="Tipo di Metrica"
                               Variant="Variant.Outlined"
                               Required="true"
                               HelperText="Tipo di calcolo da eseguire">
                        <MudSelectItem Value="MetricType.Count">Conteggio</MudSelectItem>
                        <MudSelectItem Value="MetricType.Sum">Somma</MudSelectItem>
                        <MudSelectItem Value="MetricType.Average">Media</MudSelectItem>
                        <MudSelectItem Value="MetricType.Min">Minimo</MudSelectItem>
                        <MudSelectItem Value="MetricType.Max">Massimo</MudSelectItem>
                    </MudSelect>
                    
                    @if (RequiresFieldName())
                    {
                        <FieldSelector EntityType="@EntityType"
                                      MetricType="@Metric.Type"
                                      @bind-SelectedFieldPath="Metric.FieldName"
                                      Required="true" />
                    }
                    else
                    {
                        <MudAlert Severity="Severity.Info" Dense="true">
                            Il conteggio non richiede la selezione di un campo specifico.
                        </MudAlert>
                    }
                </MudStack>
            </MudStep>

            @* Step 3: Optional Filters *@
            <MudStep title="Filtri" Icon="@Icons.Material.Outlined.FilterAlt" Optional="true">
                <MudStack Spacing="3" Class="mt-4">
                    <MudText Typo="Typo.h6">Filtri Opzionali</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                        Aggiungi condizioni per filtrare i dati prima del calcolo.
                    </MudText>
                    
                    <FilterBuilder EntityType="@EntityType"
                                  @bind-FilterCondition="Metric.FilterCondition" />
                </MudStack>
            </MudStep>

            @* Step 4: Visualization Settings with Live Preview *@
            <MudStep title="Visualizzazione" Icon="@Icons.Material.Outlined.Palette">
                <MudStack Spacing="3" Class="mt-4">
                    <MudText Typo="Typo.h6">Impostazioni di Visualizzazione</MudText>
                    
                    <MudTextField @bind-Value="Metric.Format"
                                  Label="Formato Visualizzazione"
                                  Variant="Variant.Outlined"
                                  HelperText="Formato numerico (N0 = intero, N2 = 2 decimali, C2 = valuta, P2 = percentuale)"
                                  Placeholder="N0, N2, C2, P2" />
                    
                    <MudSelect @bind-Value="Metric.Icon"
                               Label="Icona"
                               Variant="Variant.Outlined"
                               HelperText="Icona da visualizzare con la metrica">
                        <MudSelectItem Value="@Icons.Material.Outlined.Analytics">üìä Analytics</MudSelectItem>
                        <MudSelectItem Value="@Icons.Material.Outlined.TrendingUp">üìà Trending Up</MudSelectItem>
                        <MudSelectItem Value="@Icons.Material.Outlined.TrendingDown">üìâ Trending Down</MudSelectItem>
                        <MudSelectItem Value="@Icons.Material.Outlined.Assessment">üìã Assessment</MudSelectItem>
                        <MudSelectItem Value="@Icons.Material.Outlined.BarChart">üìä Bar Chart</MudSelectItem>
                        <MudSelectItem Value="@Icons.Material.Outlined.PieChart">ü•ß Pie Chart</MudSelectItem>
                        <MudSelectItem Value="@Icons.Material.Outlined.ShowChart">üìà Show Chart</MudSelectItem>
                        <MudSelectItem Value="@Icons.Material.Outlined.Percent">% Percent</MudSelectItem>
                        <MudSelectItem Value="@Icons.Material.Outlined.Calculate">üßÆ Calculate</MudSelectItem>
                        <MudSelectItem Value="@Icons.Material.Outlined.Functions">∆í Functions</MudSelectItem>
                        <MudSelectItem Value="@Icons.Material.Outlined.CheckCircle">‚úì Check Circle</MudSelectItem>
                        <MudSelectItem Value="@Icons.Material.Outlined.Error">‚ö† Error</MudSelectItem>
                        <MudSelectItem Value="@Icons.Material.Outlined.Info">‚Ñπ Info</MudSelectItem>
                        <MudSelectItem Value="@Icons.Material.Outlined.Warning">‚ö† Warning</MudSelectItem>
                        <MudSelectItem Value="@Icons.Material.Outlined.AttachMoney">üí∞ Money</MudSelectItem>
                        <MudSelectItem Value="@Icons.Material.Outlined.Euro">‚Ç¨ Euro</MudSelectItem>
                        <MudSelectItem Value="@Icons.Material.Outlined.ShoppingCart">üõí Shopping Cart</MudSelectItem>
                        <MudSelectItem Value="@Icons.Material.Outlined.Inventory">üì¶ Inventory</MudSelectItem>
                        <MudSelectItem Value="@Icons.Material.Outlined.People">üë• People</MudSelectItem>
                        <MudSelectItem Value="@Icons.Material.Outlined.Business">üè¢ Business</MudSelectItem>
                    </MudSelect>
                    
                    <MudSelect @bind-Value="Metric.Color"
                               Label="Colore"
                               Variant="Variant.Outlined"
                               HelperText="Colore per la visualizzazione della metrica">
                        <MudSelectItem Value="@("primary")">
                            <div class="d-flex align-center">
                                <MudChip T="string" Size="Size.Small" Color="Color.Primary" Class="mr-2">‚óè</MudChip>
                                <span>Primary (Blu)</span>
                            </div>
                        </MudSelectItem>
                        <MudSelectItem Value="@("secondary")">
                            <div class="d-flex align-center">
                                <MudChip T="string" Size="Size.Small" Color="Color.Secondary" Class="mr-2">‚óè</MudChip>
                                <span>Secondary (Grigio)</span>
                            </div>
                        </MudSelectItem>
                        <MudSelectItem Value="@("success")">
                            <div class="d-flex align-center">
                                <MudChip T="string" Size="Size.Small" Color="Color.Success" Class="mr-2">‚óè</MudChip>
                                <span>Success (Verde)</span>
                            </div>
                        </MudSelectItem>
                        <MudSelectItem Value="@("info")">
                            <div class="d-flex align-center">
                                <MudChip T="string" Size="Size.Small" Color="Color.Info" Class="mr-2">‚óè</MudChip>
                                <span>Info (Celeste)</span>
                            </div>
                        </MudSelectItem>
                        <MudSelectItem Value="@("warning")">
                            <div class="d-flex align-center">
                                <MudChip T="string" Size="Size.Small" Color="Color.Warning" Class="mr-2">‚óè</MudChip>
                                <span>Warning (Arancione)</span>
                            </div>
                        </MudSelectItem>
                        <MudSelectItem Value="@("error")">
                            <div class="d-flex align-center">
                                <MudChip T="string" Size="Size.Small" Color="Color.Error" Class="mr-2">‚óè</MudChip>
                                <span>Error (Rosso)</span>
                            </div>
                        </MudSelectItem>
                        <MudSelectItem Value="@("dark")">
                            <div class="d-flex align-center">
                                <MudChip T="string" Size="Size.Small" Color="Color.Dark" Class="mr-2">‚óè</MudChip>
                                <span>Dark (Nero)</span>
                            </div>
                        </MudSelectItem>
                    </MudSelect>
                    
                    @if (!string.IsNullOrEmpty(Metric.Icon))
                    {
                        <MudPaper Class="pa-3" Elevation="0" Style="border: 1px solid var(--mud-palette-divider);">
                            <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mb-2">Anteprima dal Vivo:</MudText>
                            <div class="d-flex align-center">
                                <MudIcon Icon="@Metric.Icon" 
                                         Color="@GetColorFromString(Metric.Color)" 
                                         Size="Size.Medium"
                                         Class="mr-2" />
                                <div>
                                    <MudText Typo="Typo.body2" Color="Color.Secondary">@Metric.Title</MudText>
                                    <MudText Typo="Typo.h6" Color="@GetColorFromString(Metric.Color)">
                                        @GetPreviewValue()
                                    </MudText>
                                </div>
                            </div>
                        </MudPaper>
                    }
                </MudStack>
            </MudStep>
        </MudStepper>
    </DialogContent>
    
    <DialogActions>
        <MudButton OnClick="Cancel" StartIcon="@Icons.Material.Outlined.Close">
            Annulla
        </MudButton>
        <MudSpacer />
        <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mr-4">
            Step @(_activeStepIndex + 1) di 4
        </MudText>
        
        @if (_activeStepIndex > 0)
        {
            <MudButton OnClick="PrevStep" StartIcon="@Icons.Material.Outlined.ArrowBack">
                Indietro
            </MudButton>
        }
        
        @if (_activeStepIndex < 3)
        {
            <MudButton Variant="Variant.Filled" Color="Color.Primary" 
                       OnClick="NextStep" EndIcon="@Icons.Material.Outlined.ArrowForward"
                       Disabled="@(!IsCurrentStepValid())">
                Avanti
            </MudButton>
        }
        else
        {
            <MudButton Color="Color.Primary" Variant="Variant.Filled"
                       OnClick="Save" StartIcon="@Icons.Material.Outlined.Save"
                       Disabled="@(!IsValid())">
                @(IsNewMetric ? "Crea Metrica" : "Salva")
            </MudButton>
        }
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    private IMudDialogInstance MudDialog { get; set; } = null!;

    [Parameter]
    public DashboardMetricConfigDto Metric { get; set; } = new();
    
    [Parameter]
    public bool IsNewMetric { get; set; } = true;

    [Parameter]
    public string EntityType { get; set; } = "VatRate";

    private MudStepper? _stepper;
    private int _activeStepIndex = 0;

    protected override void OnInitialized()
    {
        // Set defaults for new metrics
        if (IsNewMetric && string.IsNullOrEmpty(Metric.Icon))
        {
            Metric.Icon = Icons.Material.Outlined.Analytics;
        }
        if (IsNewMetric && string.IsNullOrEmpty(Metric.Color))
        {
            Metric.Color = "primary";
        }
        if (IsNewMetric && string.IsNullOrEmpty(Metric.Format))
        {
            Metric.Format = "N0";
        }
    }

    private bool RequiresFieldName()
    {
        // Count doesn't need a field name, but Sum, Average, Min, Max do
        return Metric.Type != MetricType.Count;
    }

    private bool IsStep1Valid()
    {
        return !string.IsNullOrWhiteSpace(Metric.Title);
    }

    private bool IsStep2Valid()
    {
        // If the metric type requires a field name, validate it
        if (RequiresFieldName() && string.IsNullOrWhiteSpace(Metric.FieldName))
            return false;

        return true;
    }

    private bool IsCurrentStepValid()
    {
        return _activeStepIndex switch
        {
            0 => IsStep1Valid(),
            1 => IsStep2Valid(),
            _ => true
        };
    }

    private bool IsValid()
    {
        return IsStep1Valid() && IsStep2Valid();
    }

    private void NextStep()
    {
        _activeStepIndex++;
    }

    private void PrevStep()
    {
        _activeStepIndex--;
    }

    private Color GetColorFromString(string? colorStr)
    {
        return colorStr?.ToLower() switch
        {
            "primary" => Color.Primary,
            "secondary" => Color.Secondary,
            "success" => Color.Success,
            "info" => Color.Info,
            "warning" => Color.Warning,
            "error" => Color.Error,
            "dark" => Color.Dark,
            _ => Color.Primary
        };
    }

    private string GetPreviewValue()
    {
        var previewNum = Metric.Type switch
        {
            MetricType.Count => 42,
            MetricType.Sum => 12345.67m,
            MetricType.Average => 98.5m,
            MetricType.Min => 10.5m,
            MetricType.Max => 999.99m,
            _ => 0m
        };

        try
        {
            if (!string.IsNullOrEmpty(Metric.Format))
            {
                return previewNum.ToString(Metric.Format);
            }
        }
        catch
        {
            // If format is invalid, just use default
        }

        return previewNum.ToString("N0");
    }

    private void Cancel()
    {
        MudDialog.Cancel();
    }

    private void Save()
    {
        if (!IsValid())
        {
            Snackbar.Add("Completa tutti i campi obbligatori", Severity.Warning);
            return;
        }

        MudDialog.Close(DialogResult.Ok(Metric));
    }
}
