@*
    Enhanced Fullscreen Health Status & Log Dialog
    Features: MudAppBar, auto-refresh, collapsible filters, public log access with sanitization
    Implements true parity with AuditHistoryDialog pattern
*@

@using EventForge.DTOs.Health
@using EventForge.DTOs.SuperAdmin
@using EventForge.DTOs.Common
@using EventForge.DTOs.Profile
@using EventForge.DTOs.Auth
@using EventForge.Client.Services
@using System.Timers
@inject ITranslationService TranslationService
@inject ILogManagementService LogManagementService
@inject IProfileService ProfileService
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject AuthenticationStateProvider AuthenticationStateProvider
@implements IDisposable

<MudDialog Class="health-status-dialog-enhanced"
           DefaultFocus="DefaultFocus.None">
    <TitleContent>
        <MudAppBar Elevation="1" Dense="true">
            <MudIcon Icon="@GetOverallHealthIcon()" 
                     Color="@GetOverallHealthColor()" 
                     Class="mr-3" />
            <MudText Typo="Typo.h6">
                @TranslationService.GetTranslation("health.dialog.title", "System Health & Logs")
            </MudText>
            <MudSpacer />
            
            <!-- Auto-refresh toggle and interval -->
            <MudSwitch @bind-Value="_autoRefreshEnabled" 
                       Color="Color.Primary" 
                       Class="mr-2"
                       T="bool"
                       Label="@TranslationService.GetTranslation("health.autoRefresh", "Auto-refresh")"
                       aria-label="@TranslationService.GetTranslation("health.autoRefresh", "Auto-refresh")" />
            
            @if (_autoRefreshEnabled)
            {
                <MudNumericField @bind-Value="_refreshIntervalSeconds"
                                 Label="@TranslationService.GetTranslation("health.intervalSeconds", "Interval (s)")"
                                 Min="5"
                                 Max="300"
                                 Step="5"
                                 Style="width: 120px;"
                                 Class="mr-2"
                                 Variant="Variant.Outlined"
                                 Margin="Margin.Dense" />
            }
            
            <MudIconButton Icon="@Icons.Material.Outlined.Refresh"
                           Color="Color.Inherit"
                           OnClick="@RefreshAll"
                           aria-label="@TranslationService.GetTranslation("common.refresh", "Refresh")" />
            <MudIconButton Icon="@Icons.Material.Outlined.FileDownload"
                           Color="Color.Inherit"
                           OnClick="@ExportLogs"
                           aria-label="@TranslationService.GetTranslation("health.export", "Export")" />
            <MudIconButton Icon="@Icons.Material.Outlined.Close"
                           Color="Color.Inherit"
                           OnClick="@Close"
                           aria-label="@TranslationService.GetTranslation("button.close", "Close")" />
        </MudAppBar>
    </TitleContent>
    <DialogContent>
        <MudGrid>
            <!-- Left Column: Health Status -->
            <MudItem xs="12" md="6">
                <MudPaper Elevation="0" Class="pa-4" Style="height: 100%; overflow-y: auto;">
                    <MudText Typo="Typo.h6" Class="mb-4">
                        <MudIcon Icon="@Icons.Material.Filled.MonitorHeart" Class="mr-2" />
                        @TranslationService.GetTranslation("health.systemHealth", "System Health")
                    </MudText>
                    
                    @if (HealthData != null)
                    {
                        <MudStack Spacing="3">
                            
                            <!-- API Status Section -->
                            <MudCard Elevation="1">
                                <MudCardContent>
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-3">
                                        <MudIcon Icon="@Icons.Material.Filled.Api" 
                                                 Color="@GetStatusColor(HealthData.ApiStatus)" 
                                                 Size="Size.Medium" />
                                        <MudText Typo="Typo.subtitle1" Class="font-weight-medium">
                                            @TranslationService.GetTranslation("health.api.title", "API Status")
                                        </MudText>
                                        <MudChip T="string" Size="Size.Small" 
                                                 Color="@GetStatusColor(HealthData.ApiStatus)" 
                                                 Text="@HealthData.ApiStatus" 
                                                 Variant="Variant.Filled" />
                                    </MudStack>
                                    
                                    <MudSimpleTable Dense="true" Bordered="false" Striped="false">
                                        <tbody>
                                            <tr>
                                                <td><strong>@TranslationService.GetTranslation("health.version", "Version")</strong></td>
                                                <td>@HealthData.Version</td>
                                            </tr>
                                            <tr>
                                                <td><strong>@TranslationService.GetTranslation("health.environment", "Environment")</strong></td>
                                                <td>@HealthData.Environment</td>
                                            </tr>
                                            <tr>
                                                <td><strong>@TranslationService.GetTranslation("health.uptime", "Uptime")</strong></td>
                                                <td>@FormatUptime(HealthData.Uptime)</td>
                                            </tr>
                                        </tbody>
                                    </MudSimpleTable>
                                </MudCardContent>
                            </MudCard>

                            <!-- Database Status Section -->
                            <MudCard Elevation="1">
                                <MudCardContent>
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-3">
                                        <MudIcon Icon="@Icons.Material.Filled.Storage" 
                                                 Color="@GetStatusColor(HealthData.DatabaseStatus)" 
                                                 Size="Size.Medium" />
                                        <MudText Typo="Typo.subtitle1" Class="font-weight-medium">
                                            @TranslationService.GetTranslation("health.database.title", "Database Status")
                                        </MudText>
                                        <MudChip T="string" Size="Size.Small" 
                                                 Color="@GetStatusColor(HealthData.DatabaseStatus)" 
                                                 Text="@HealthData.DatabaseStatus" 
                                                 Variant="Variant.Filled" />
                                    </MudStack>
                                    
                                    <MudSimpleTable Dense="true" Bordered="false" Striped="false">
                                        <tbody>
                                            <tr>
                                                <td><strong>@TranslationService.GetTranslation("health.status", "Status")</strong></td>
                                                <td>@HealthData.DatabaseStatus</td>
                                            </tr>
                                            @if (HealthData.DatabaseDetails?.Any() == true)
                                            {
                                                @foreach (var detail in HealthData.DatabaseDetails)
                                                {
                                                    <tr>
                                                        <td><strong>@detail.Key</strong></td>
                                                        <td>@detail.Value</td>
                                                    </tr>
                                                }
                                            }
                                            @if (HealthData.AppliedMigrations?.Any() == true)
                                            {
                                                <tr>
                                                    <td><strong>@TranslationService.GetTranslation("health.migrations", "Migrations")</strong></td>
                                                    <td>@HealthData.AppliedMigrations.Count()</td>
                                                </tr>
                                            }
                                        </tbody>
                                    </MudSimpleTable>
                                </MudCardContent>
                            </MudCard>

                            <!-- Last Updated Info -->
                            @if (LastUpdated.HasValue)
                            {
                                <MudAlert Severity="Severity.Info" NoIcon="false">
                                    <MudText Typo="Typo.body2">
                                        <MudIcon Icon="@Icons.Material.Filled.Schedule" Size="Size.Small" Class="mr-1" />
                                        @TranslationService.GetTranslation("health.lastUpdated", "Last Updated"): @LastUpdated.Value.ToString("HH:mm:ss")
                                    </MudText>
                                </MudAlert>
                            }

                            <!-- Current Session Section -->
                            @if (CurrentUser != null)
                            {
                                <MudCard Elevation="1">
                                    <MudCardContent>
                                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-3">
                                            <MudIcon Icon="@Icons.Material.Filled.AccountCircle" 
                                                     Color="Color.Primary" 
                                                     Size="Size.Medium" />
                                            <MudText Typo="Typo.subtitle1" Class="font-weight-medium">
                                                @TranslationService.GetTranslation("health.currentSession", "Current Session")
                                            </MudText>
                                        </MudStack>
                                        
                                        <MudSimpleTable Dense="true" Bordered="false" Striped="false">
                                            <tbody>
                                                <tr>
                                                    <td><strong>@TranslationService.GetTranslation("field.username", "Username")</strong></td>
                                                    <td>@CurrentUser.Username</td>
                                                </tr>
                                                <tr>
                                                    <td><strong>@TranslationService.GetTranslation("field.fullName", "Full Name")</strong></td>
                                                    <td>@CurrentUser.FullName</td>
                                                </tr>
                                                <tr>
                                                    <td><strong>@TranslationService.GetTranslation("field.roles", "Roles")</strong></td>
                                                    <td>
                                                        @if (CurrentUser.Roles?.Any() == true)
                                                        {
                                                            <MudStack Row="true" Spacing="1">
                                                                @foreach (var role in CurrentUser.Roles)
                                                                {
                                                                    <MudChip T="string" Size="Size.Small" Color="Color.Secondary" Text="@role" />
                                                                }
                                                            </MudStack>
                                                        }
                                                        else
                                                        {
                                                            <span>-</span>
                                                        }
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td><strong>@TranslationService.GetTranslation("field.permissions", "Permissions")</strong></td>
                                                    <td>
                                                        @if (CurrentUser.Permissions?.Any() == true)
                                                        {
                                                            <MudText Typo="Typo.body2">@CurrentUser.Permissions.Count @TranslationService.GetTranslation("health.permissionsGranted", "permissions granted")</MudText>
                                                        }
                                                        else
                                                        {
                                                            <span>-</span>
                                                        }
                                                    </td>
                                                </tr>
                                                @if (CurrentUser.LastLoginAt.HasValue)
                                                {
                                                    <tr>
                                                        <td><strong>@TranslationService.GetTranslation("field.lastLogin", "Last Login")</strong></td>
                                                        <td>@CurrentUser.LastLoginAt.Value.ToString("yyyy-MM-dd HH:mm:ss") UTC</td>
                                                    </tr>
                                                }
                                                @if (TokenExpiresAt.HasValue)
                                                {
                                                    <tr>
                                                        <td><strong>@TranslationService.GetTranslation("health.tokenExpiry", "Token Expiry")</strong></td>
                                                        <td>@TokenExpiresAt.Value.ToString("yyyy-MM-dd HH:mm:ss") UTC</td>
                                                    </tr>
                                                    <tr>
                                                        <td><strong>@TranslationService.GetTranslation("health.tokenTimeRemaining", "Time Remaining")</strong></td>
                                                        <td>@FormatTimeRemaining(TokenExpiresAt.Value)</td>
                                                    </tr>
                                                }
                                            </tbody>
                                        </MudSimpleTable>
                                    </MudCardContent>
                                </MudCard>
                            }

                        </MudStack>
                    }
                    else
                    {
                        <div class="text-center pa-4">
                            @if (!string.IsNullOrEmpty(ErrorMessage))
                            {
                                <MudAlert Severity="Severity.Error" Class="mb-4">
                                    <MudText Typo="Typo.h6">@TranslationService.GetTranslation("health.error", "Health Check Error")</MudText>
                                    <MudText Typo="Typo.body2">@ErrorMessage</MudText>
                                </MudAlert>
                                <MudButton Variant="Variant.Filled" 
                                           Color="Color.Primary" 
                                           OnClick="@RefreshAll"
                                           StartIcon="@Icons.Material.Filled.Refresh">
                                    @TranslationService.GetTranslation("common.retry", "Retry")
                                </MudButton>
                            }
                            else
                            {
                                <MudProgressCircular Color="Color.Primary" Indeterminate="true" Class="mb-3" />
                                <MudText Typo="Typo.body1">
                                    @TranslationService.GetTranslation("health.loading", "Loading health information...")
                                </MudText>
                            }
                        </div>
                    }
                </MudPaper>
            </MudItem>

            <!-- Active Sessions Column -->
            <MudItem xs="12" md="6">
                <MudPaper Elevation="0" Class="pa-4" Style="height: 100%; overflow-y: auto;">
                    <MudText Typo="Typo.h6" Class="mb-4">
                        <MudIcon Icon="@Icons.Material.Filled.Devices" Class="mr-2" />
                        @TranslationService.GetTranslation("health.activeSessions", "Active Sessions")
                    </MudText>
                    
                    @if (ActiveSessions != null && ActiveSessions.Any())
                    {
                        <MudStack Spacing="2">
                            <!-- Termination Actions -->
                            <MudPaper Elevation="1" Class="pa-3">
                                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                    <MudText Typo="Typo.body2">
                                        @ActiveSessions.Count @TranslationService.GetTranslation("health.sessionsActive", "active session(s)")
                                    </MudText>
                                    <MudButton Variant="Variant.Outlined" 
                                               Color="Color.Warning" 
                                               Size="Size.Small"
                                               StartIcon="@Icons.Material.Filled.PowerOff"
                                               OnClick="@TerminateAllOtherSessions"
                                               Disabled="@_isTerminatingSession">
                                        @TranslationService.GetTranslation("health.terminateOtherSessions", "Terminate Other Sessions")
                                    </MudButton>
                                </MudStack>
                            </MudPaper>

                            <!-- Sessions Table -->
                            <MudTable Items="@ActiveSessions" 
                                      Hover="true" 
                                      Striped="true" 
                                      Dense="true"
                                      Elevation="1">
                                <HeaderContent>
                                    <MudTh>@TranslationService.GetTranslation("health.session", "Session")</MudTh>
                                    <MudTh>@TranslationService.GetTranslation("health.device", "Device")</MudTh>
                                    <MudTh>@TranslationService.GetTranslation("health.location", "Location")</MudTh>
                                    <MudTh>@TranslationService.GetTranslation("health.lastActivity", "Last Activity")</MudTh>
                                    <MudTh>@TranslationService.GetTranslation("health.actions", "Actions")</MudTh>
                                </HeaderContent>
                                <RowTemplate>
                                    <MudTd DataLabel="Session">
                                        <MudStack Spacing="0">
                                            @if (context.IsCurrentSession)
                                            {
                                                <MudChip T="string" Size="Size.Small" Color="Color.Success" Text="@TranslationService.GetTranslation("health.currentSession", "Current")" />
                                            }
                                            <MudText Typo="Typo.caption">@context.IpAddress</MudText>
                                        </MudStack>
                                    </MudTd>
                                    <MudTd DataLabel="Device">
                                        <MudStack Spacing="0">
                                            <MudText Typo="Typo.body2">@GetDeviceIcon(context.DeviceType) @context.Browser</MudText>
                                            <MudText Typo="Typo.caption">@context.OperatingSystem</MudText>
                                        </MudStack>
                                    </MudTd>
                                    <MudTd DataLabel="Location">
                                        <MudText Typo="Typo.body2">@(context.Location ?? "-")</MudText>
                                    </MudTd>
                                    <MudTd DataLabel="Last Activity">
                                        <MudStack Spacing="0">
                                            <MudText Typo="Typo.body2">@context.LastActivity.ToString("yyyy-MM-dd")</MudText>
                                            <MudText Typo="Typo.caption">@context.LastActivity.ToString("HH:mm:ss") UTC</MudText>
                                        </MudStack>
                                    </MudTd>
                                    <MudTd DataLabel="Actions">
                                        <MudStack Row="true" Spacing="1">
                                            <MudIconButton Icon="@Icons.Material.Outlined.Visibility" 
                                                           Size="Size.Small" 
                                                           Color="Color.Info"
                                                           OnClick="@(() => ShowSessionDetails(context))"
                                                           Title="@TranslationService.GetTranslation("health.viewDetails", "View Details")" />
                                            @if (!context.IsCurrentSession)
                                            {
                                                <MudIconButton Icon="@Icons.Material.Filled.PowerOff" 
                                                               Size="Size.Small" 
                                                               Color="Color.Error"
                                                               OnClick="@(() => TerminateSession(context.Id))"
                                                               Disabled="@_isTerminatingSession"
                                                               Title="@TranslationService.GetTranslation("health.terminateSession", "Terminate")" />
                                            }
                                        </MudStack>
                                    </MudTd>
                                </RowTemplate>
                            </MudTable>
                        </MudStack>
                    }
                    else if (ActiveSessions == null)
                    {
                        <MudAlert Severity="Severity.Warning" NoIcon="false">
                            @TranslationService.GetTranslation("health.sessionsNotAvailable", "Session information is not available")
                        </MudAlert>
                    }
                    else
                    {
                        <MudAlert Severity="Severity.Info" NoIcon="false">
                            @TranslationService.GetTranslation("health.noActiveSessions", "No active sessions")
                        </MudAlert>
                    }

                    <!-- Session Details Dialog -->
                    @if (_selectedSessionForDetails != null)
                    {
                        <MudPaper Elevation="2" Class="mt-4 pa-4">
                            <div class="d-flex justify-space-between align-center mb-3">
                                <MudText Typo="Typo.h6">
                                    @TranslationService.GetTranslation("health.sessionDetails", "Session Details")
                                </MudText>
                                <MudIconButton Icon="@Icons.Material.Filled.Close" 
                                               Size="Size.Small"
                                               OnClick="@(() => _selectedSessionForDetails = null)" />
                            </div>
                            
                            <MudSimpleTable Dense="true">
                                <tbody>
                                    <tr>
                                        <td><strong>@TranslationService.GetTranslation("health.sessionId", "Session ID")</strong></td>
                                        <td><code>@_selectedSessionForDetails.Id</code></td>
                                    </tr>
                                    <tr>
                                        <td><strong>@TranslationService.GetTranslation("health.ipAddress", "IP Address")</strong></td>
                                        <td>@_selectedSessionForDetails.IpAddress</td>
                                    </tr>
                                    <tr>
                                        <td><strong>@TranslationService.GetTranslation("health.userAgent", "User Agent")</strong></td>
                                        <td style="word-break: break-all;">@_selectedSessionForDetails.UserAgent</td>
                                    </tr>
                                    <tr>
                                        <td><strong>@TranslationService.GetTranslation("health.browser", "Browser")</strong></td>
                                        <td>@_selectedSessionForDetails.Browser</td>
                                    </tr>
                                    <tr>
                                        <td><strong>@TranslationService.GetTranslation("health.operatingSystem", "Operating System")</strong></td>
                                        <td>@_selectedSessionForDetails.OperatingSystem</td>
                                    </tr>
                                    <tr>
                                        <td><strong>@TranslationService.GetTranslation("health.deviceType", "Device Type")</strong></td>
                                        <td>@_selectedSessionForDetails.DeviceType</td>
                                    </tr>
                                    <tr>
                                        <td><strong>@TranslationService.GetTranslation("health.loginTime", "Login Time")</strong></td>
                                        <td>@_selectedSessionForDetails.LoginTime.ToString("yyyy-MM-dd HH:mm:ss") UTC</td>
                                    </tr>
                                    <tr>
                                        <td><strong>@TranslationService.GetTranslation("health.lastActivity", "Last Activity")</strong></td>
                                        <td>@_selectedSessionForDetails.LastActivity.ToString("yyyy-MM-dd HH:mm:ss") UTC</td>
                                    </tr>
                                    <tr>
                                        <td><strong>@TranslationService.GetTranslation("health.location", "Location")</strong></td>
                                        <td>@(_selectedSessionForDetails.Location ?? "-")</td>
                                    </tr>
                                    <tr>
                                        <td><strong>@TranslationService.GetTranslation("health.isCurrentSession", "Is Current Session")</strong></td>
                                        <td>@(_selectedSessionForDetails.IsCurrentSession ? TranslationService.GetTranslation("common.yes", "Yes") : TranslationService.GetTranslation("common.no", "No"))</td>
                                    </tr>
                                </tbody>
                            </MudSimpleTable>
                        </MudPaper>
                    }
                </MudPaper>
            </MudItem>

            <!-- Log Management Section (Full Width) -->
            <MudItem xs="12">
                <MudPaper Elevation="0" Class="pa-4" Style="overflow-y: auto;">
                    <MudText Typo="Typo.h6" Class="mb-4">
                        <MudIcon Icon="@Icons.Material.Filled.Article" Class="mr-2" />
                        @TranslationService.GetTranslation("health.systemLogs", "System Logs")
                    </MudText>

                    <!-- Filters Section -->
                    <MudPaper Elevation="2" Class="mb-3">
                        <div style="cursor: pointer;" @onclick="@(() => _filtersExpanded = !_filtersExpanded)" 
                             class="d-flex align-center pa-3">
                            <MudIcon Icon="@Icons.Material.Outlined.FilterList" Class="mr-2" />
                            <MudText Typo="Typo.h6" Class="flex-grow-1">
                                @TranslationService.GetTranslation("health.logFilters", "Log Filters")
                            </MudText>
                            <MudIconButton Icon="@(_filtersExpanded ? Icons.Material.Outlined.ExpandLess : Icons.Material.Outlined.ExpandMore)"
                                           Size="Size.Small"
                                           Color="Color.Inherit" />
                        </div>
                        <MudCollapse Expanded="_filtersExpanded">
                            <div class="pa-3">
                                <MudGrid Spacing="2">
                                    <MudItem xs="12" md="3">
                                        <MudSelect T="string" @bind-Value="_selectedLogLevel" @bind-Value:after="OnFilterChanged"
                                                   Label="@TranslationService.GetTranslation("health.logLevel", "Level")" 
                                                   Variant="Variant.Outlined"
                                                   Clearable="true"
                                                   Dense="true">
                                            <MudSelectItem Value="@("")">@TranslationService.GetTranslation("common.all", "All")</MudSelectItem>
                                            <MudSelectItem Value="@("Debug")">Debug</MudSelectItem>
                                            <MudSelectItem Value="@("Information")">Information</MudSelectItem>
                                            <MudSelectItem Value="@("Warning")">Warning</MudSelectItem>
                                            <MudSelectItem Value="@("Error")">Error</MudSelectItem>
                                            <MudSelectItem Value="@("Critical")">Critical</MudSelectItem>
                                        </MudSelect>
                                    </MudItem>
                                    <MudItem xs="12" md="3">
                                        <MudDatePicker @bind-Date="_startDate" @bind-Date:after="OnFilterChanged"
                                                       Label="@TranslationService.GetTranslation("health.startDate", "From Date")"
                                                       Variant="Variant.Outlined"
                                                       Dense="true" />
                                    </MudItem>
                                    <MudItem xs="12" md="3">
                                        <MudDatePicker @bind-Date="_endDate" @bind-Date:after="OnFilterChanged"
                                                       Label="@TranslationService.GetTranslation("health.endDate", "To Date")"
                                                       Variant="Variant.Outlined"
                                                       Dense="true" />
                                    </MudItem>
                                    <MudItem xs="12" md="3">
                                        <MudTextField @bind-Value="_searchText" @bind-Value:after="OnFilterChanged"
                                                      Label="@TranslationService.GetTranslation("health.searchMessage", "Search message")"
                                                      Placeholder="@TranslationService.GetTranslation("health.searchPlaceholder", "Search...")"
                                                      Variant="Variant.Outlined"
                                                      Clearable="true"
                                                      Dense="true" />
                                    </MudItem>
                                </MudGrid>
                                <div class="d-flex justify-end mt-3 gap-2">
                                    <MudButton Variant="Variant.Text" 
                                               Color="Color.Primary" 
                                               StartIcon="@Icons.Material.Outlined.Clear"
                                               OnClick="@ClearFilters"
                                               Size="Size.Small">
                                        @TranslationService.GetTranslation("health.clearFilters", "Clear filters")
                                    </MudButton>
                                </div>
                            </div>
                        </MudCollapse>
                    </MudPaper>

                    <!-- Logs Table -->
                    <MudPaper Elevation="1" Class="mt-4">
                        @if (_isLoadingLogs)
                        {
                            <div class="text-center pa-4">
                                <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
                            </div>
                        }
                        else if (_isAdmin && _logs?.Items?.Any() == true)
                        {
                            <!-- Admin: Full logs table -->
                            <MudTable Items="@_logs.Items" 
                                      Hover="true" 
                                      Striped="true" 
                                      Dense="true"
                                      Elevation="0">
                                <HeaderContent>
                                    <MudTh>@TranslationService.GetTranslation("health.timestamp", "Timestamp")</MudTh>
                                    <MudTh>@TranslationService.GetTranslation("health.level", "Level")</MudTh>
                                    <MudTh>@TranslationService.GetTranslation("health.message", "Message")</MudTh>
                                    <MudTh>@TranslationService.GetTranslation("health.actions", "Actions")</MudTh>
                                </HeaderContent>
                                <RowTemplate>
                                    <MudTd DataLabel="Timestamp">@context.Timestamp.ToString("yyyy-MM-dd HH:mm:ss")</MudTd>
                                    <MudTd DataLabel="Level">
                                        <MudChip T="string" 
                                                 Size="Size.Small" 
                                                 Color="@GetLogLevelColor(context.Level)" 
                                                 Text="@context.Level" />
                                    </MudTd>
                                    <MudTd DataLabel="Message">
                                        <MudText Typo="Typo.body2" Style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                            @context.Message
                                        </MudText>
                                    </MudTd>
                                    <MudTd DataLabel="Actions">
                                        <MudIconButton Icon="@Icons.Material.Outlined.Visibility" 
                                                       Size="Size.Small" 
                                                       Color="Color.Info"
                                                       OnClick="@(() => ShowLogDetails(context))" />
                                    </MudTd>
                                </RowTemplate>
                            </MudTable>

                            <!-- Pagination -->
                            <div class="d-flex justify-center pa-3">
                                <MudPagination Count="@_logs.TotalPages" 
                                               Selected="@_currentPage" 
                                               SelectedChanged="@OnPageChanged"
                                               Color="Color.Primary" />
                            </div>
                        }
                        else if (!_isAdmin && _sanitizedLogs?.Items?.Any() == true)
                        {
                            <!-- Non-admin: Sanitized logs table -->
                            <MudTable Items="@_sanitizedLogs.Items" 
                                      Hover="true" 
                                      Striped="true" 
                                      Dense="true"
                                      Elevation="0">
                                <HeaderContent>
                                    <MudTh>@TranslationService.GetTranslation("health.timestamp", "Timestamp")</MudTh>
                                    <MudTh>@TranslationService.GetTranslation("health.level", "Level")</MudTh>
                                    <MudTh>@TranslationService.GetTranslation("health.message", "Message")</MudTh>
                                    <MudTh>@TranslationService.GetTranslation("health.actions", "Actions")</MudTh>
                                </HeaderContent>
                                <RowTemplate>
                                    <MudTd DataLabel="Timestamp">@context.Timestamp.ToString("yyyy-MM-dd HH:mm:ss")</MudTd>
                                    <MudTd DataLabel="Level">
                                        <MudChip T="string" 
                                                 Size="Size.Small" 
                                                 Color="@GetLogLevelColor(context.Level)" 
                                                 Text="@context.Level" />
                                    </MudTd>
                                    <MudTd DataLabel="Message">
                                        <MudText Typo="Typo.body2" Style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                            @context.Message
                                        </MudText>
                                    </MudTd>
                                    <MudTd DataLabel="Actions">
                                        <MudIconButton Icon="@Icons.Material.Outlined.Visibility" 
                                                       Size="Size.Small" 
                                                       Color="Color.Info"
                                                       OnClick="@(() => ShowSanitizedLogDetails(context))" />
                                    </MudTd>
                                </RowTemplate>
                            </MudTable>

                            <!-- Pagination -->
                            <div class="d-flex justify-center pa-3">
                                <MudPagination Count="@_sanitizedLogs.TotalPages" 
                                               Selected="@_currentPage" 
                                               SelectedChanged="@OnPageChanged"
                                               Color="Color.Primary" />
                            </div>
                        }
                        else
                        {
                            <div class="text-center pa-4">
                                <MudText Typo="Typo.body1" Color="Color.Secondary">
                                    @TranslationService.GetTranslation("health.noLogs", "No logs found")
                                </MudText>
                            </div>
                        }
                    </MudPaper>

                    <!-- Admin Log Details Panel -->
                    @if (_selectedLog != null)
                    {
                        <MudPaper Elevation="2" Class="mt-4 pa-4">
                            <div class="d-flex justify-space-between align-center mb-3">
                                <MudText Typo="Typo.h6">
                                    @TranslationService.GetTranslation("health.logDetails", "Dettagli Log")
                                </MudText>
                                <MudIconButton Icon="@Icons.Material.Filled.Close" 
                                               Size="Size.Small"
                                               OnClick="@(() => _selectedLog = null)" />
                            </div>
                            
                            <MudSimpleTable Dense="true">
                                <tbody>
                                    <tr>
                                        <td><strong>Timestamp:</strong></td>
                                        <td>@_selectedLog.Timestamp.ToString("yyyy-MM-dd HH:mm:ss.fff")</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Level:</strong></td>
                                        <td>
                                            <MudChip T="string" Size="Size.Small" Color="@GetLogLevelColor(_selectedLog.Level)" Text="@_selectedLog.Level" />
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><strong>Message:</strong></td>
                                        <td>@_selectedLog.Message</td>
                                    </tr>
                                    @if (!string.IsNullOrEmpty(_selectedLog.Source))
                                    {
                                        <tr>
                                            <td><strong>Source:</strong></td>
                                            <td>@_selectedLog.Source</td>
                                        </tr>
                                    }
                                    @if (!string.IsNullOrEmpty(_selectedLog.Category))
                                    {
                                        <tr>
                                            <td><strong>Category:</strong></td>
                                            <td>@_selectedLog.Category</td>
                                        </tr>
                                    }
                                    @if (!string.IsNullOrEmpty(_selectedLog.Username))
                                    {
                                        <tr>
                                            <td><strong>User:</strong></td>
                                            <td>@_selectedLog.Username</td>
                                        </tr>
                                    }
                                    @if (!string.IsNullOrEmpty(_selectedLog.Exception))
                                    {
                                        <tr>
                                            <td colspan="2">
                                                <MudAlert Severity="Severity.Error" Class="mt-2">
                                                    <strong>Exception:</strong>
                                                    <pre style="white-space: pre-wrap; font-size: 0.75rem;">@_selectedLog.Exception</pre>
                                                </MudAlert>
                                            </td>
                                        </tr>
                                    }
                                    @if (_selectedLog.Properties != null && _selectedLog.Properties.Any())
                                    {
                                        <tr>
                                            <td colspan="2">
                                                <MudText Typo="Typo.subtitle2" Class="mt-2"><strong>Properties:</strong></MudText>
                                                <pre style="white-space: pre-wrap; font-size: 0.75rem; background: #f5f5f5; padding: 8px; border-radius: 4px;">@System.Text.Json.JsonSerializer.Serialize(_selectedLog.Properties, new System.Text.Json.JsonSerializerOptions { WriteIndented = true })</pre>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </MudSimpleTable>
                        </MudPaper>
                    }

                    <!-- Sanitized Log Details Panel -->
                    @if (_selectedSanitizedLog != null)
                    {
                        <MudPaper Elevation="2" Class="mt-4 pa-4">
                            <div class="d-flex justify-space-between align-center mb-3">
                                <MudText Typo="Typo.h6">
                                    @TranslationService.GetTranslation("health.logDetails", "Log Details")
                                </MudText>
                                <MudIconButton Icon="@Icons.Material.Filled.Close" 
                                               Size="Size.Small"
                                               OnClick="@(() => _selectedSanitizedLog = null)" />
                            </div>
                            
                            <MudSimpleTable Dense="true">
                                <tbody>
                                    <tr>
                                        <td><strong>Timestamp:</strong></td>
                                        <td>@_selectedSanitizedLog.Timestamp.ToString("yyyy-MM-dd HH:mm:ss.fff")</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Level:</strong></td>
                                        <td>
                                            <MudChip T="string" Size="Size.Small" Color="@GetLogLevelColor(_selectedSanitizedLog.Level)" Text="@_selectedSanitizedLog.Level" />
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><strong>Message:</strong></td>
                                        <td>@_selectedSanitizedLog.Message</td>
                                    </tr>
                                    @if (!string.IsNullOrEmpty(_selectedSanitizedLog.Source))
                                    {
                                        <tr>
                                            <td><strong>Source:</strong></td>
                                            <td>@_selectedSanitizedLog.Source</td>
                                        </tr>
                                    }
                                    @if (!string.IsNullOrEmpty(_selectedSanitizedLog.Category))
                                    {
                                        <tr>
                                            <td><strong>Category:</strong></td>
                                            <td>@_selectedSanitizedLog.Category</td>
                                        </tr>
                                    }
                                    @if (_selectedSanitizedLog.HasException)
                                    {
                                        <tr>
                                            <td colspan="2">
                                                <MudAlert Severity="Severity.Warning" Class="mt-2">
                                                    <strong>@TranslationService.GetTranslation("health.exceptionOccurred", "An exception occurred (details hidden for security)").</strong>
                                                </MudAlert>
                                            </td>
                                        </tr>
                                    }
                                    @if (_selectedSanitizedLog.PublicProperties != null && _selectedSanitizedLog.PublicProperties.Any())
                                    {
                                        <tr>
                                            <td colspan="2">
                                                <MudText Typo="Typo.subtitle2" Class="mt-2"><strong>Properties:</strong></MudText>
                                                <pre style="white-space: pre-wrap; font-size: 0.75rem; background: #f5f5f5; padding: 8px; border-radius: 4px;">@System.Text.Json.JsonSerializer.Serialize(_selectedSanitizedLog.PublicProperties, new System.Text.Json.JsonSerializerOptions { WriteIndented = true })</pre>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </MudSimpleTable>
                        </MudPaper>
                    }
                </MudPaper>
            </MudItem>
        </MudGrid>
    </DialogContent>
</MudDialog>

<style>
    .health-status-dialog-enhanced {
        height: 100vh;
    }
</style>

@code {
    [CascadingParameter] IMudDialogInstance MudDialog { get; set; } = default!;
    
    [Parameter] public DetailedHealthStatusDto? HealthData { get; set; }
    [Parameter] public DateTime? LastUpdated { get; set; }
    [Parameter] public EventCallback OnRefreshRequested { get; set; }
    [Parameter] public List<ActiveSessionDto>? ActiveSessions { get; set; }
    [Parameter] public UserDto? CurrentUser { get; set; }
    [Parameter] public DateTime? TokenExpiresAt { get; set; }
    [Parameter] public string? ErrorMessage { get; set; } // NEW

    // Log Management State
    private bool _filtersExpanded = false;
    private bool _isLoadingLogs = false;
    private PagedResult<SystemLogDto>? _logs;
    private PagedResult<SanitizedSystemLogDto>? _sanitizedLogs;
    private SystemLogDto? _selectedLog;
    private SanitizedSystemLogDto? _selectedSanitizedLog;
    private int _currentPage = 1;
    private int _pageSize = 20;
    private bool _isAdmin = false;

    // Filter State
    private string _selectedLogLevel = string.Empty;
    private DateTime? _startDate;
    private DateTime? _endDate;
    private string _searchText = string.Empty;

    // Auto-refresh State
    private bool _autoRefreshEnabled = false;
    private int _refreshIntervalSeconds = 30;
    private Timer? _refreshTimer;

    // Session Management State
    private bool _isTerminatingSession = false;
    private ActiveSessionDto? _selectedSessionForDetails;

    protected override async Task OnInitializedAsync()
    {
        // Set default date range to last 24 hours
        _endDate = DateTime.Now;
        _startDate = DateTime.Now.AddDays(-1);
        
        // Check if user is admin
        await DetermineUserRole();
        
        // Load initial logs
        await LoadLogsAsync();
    }

    protected override void OnParametersSet()
    {
        // Update auto-refresh when enabled status changes
        if (_autoRefreshEnabled)
        {
            StartAutoRefresh();
        }
        else
        {
            StopAutoRefresh();
        }
    }

    private async Task DetermineUserRole()
    {
        try
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;
            _isAdmin = user.IsInRole("SuperAdmin") || user.IsInRole("Admin");
        }
        catch (Exception ex)
        {
            _isAdmin = false;
            Console.WriteLine($"Error determining user role: {ex.Message}");
        }
    }

    private void StartAutoRefresh()
    {
        StopAutoRefresh(); // Stop any existing timer
        
        _refreshTimer = new Timer(_refreshIntervalSeconds * 1000);
        _refreshTimer.Elapsed += async (sender, e) => await OnAutoRefreshTick();
        _refreshTimer.AutoReset = true;
        _refreshTimer.Start();
    }

    private void StopAutoRefresh()
    {
        if (_refreshTimer != null)
        {
            _refreshTimer.Stop();
            _refreshTimer.Dispose();
            _refreshTimer = null;
        }
    }

    private async Task OnAutoRefreshTick()
    {
        try
        {
            await InvokeAsync(async () =>
            {
                await RefreshAll();
                StateHasChanged();
            });
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Auto-refresh error: {ex.Message}");
        }
    }

    private async Task RefreshAll()
    {
        // Refresh health data
        if (OnRefreshRequested.HasDelegate)
        {
            await OnRefreshRequested.InvokeAsync();
        }
        
        // Refresh logs
        await LoadLogsAsync();
        
        // Update last updated timestamp
        LastUpdated = DateTime.Now;
    }

    private void Close()
    {
        StopAutoRefresh();
        MudDialog?.Close();
    }

    private async Task LoadLogsAsync()
    {
        _isLoadingLogs = true;
        try
        {
            var queryParams = new ApplicationLogQueryParameters
            {
                Level = string.IsNullOrEmpty(_selectedLogLevel) ? null : _selectedLogLevel,
                FromDate = _startDate,
                ToDate = _endDate,
                Message = string.IsNullOrEmpty(_searchText) ? null : _searchText,
                Page = _currentPage,
                PageSize = _pageSize,
                SortBy = "Timestamp",
                SortDirection = "desc"
            };

            if (_isAdmin)
            {
                // Admin users get full logs
                _logs = await LogManagementService.GetApplicationLogsAsync(queryParams);
                _sanitizedLogs = null;
            }
            else
            {
                // Non-admin users get sanitized logs
                _sanitizedLogs = await LogManagementService.GetPublicApplicationLogsAsync(queryParams);
                _logs = null;
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add(TranslationService.GetTranslation("health.errorLoadingLogs", "Error loading logs: {0}", ex.Message), Severity.Error);
            
            if (_isAdmin)
            {
                _logs = new PagedResult<SystemLogDto>
                {
                    Items = new List<SystemLogDto>(),
                    Page = _currentPage,
                    PageSize = _pageSize,
                    TotalCount = 0
                };
            }
            else
            {
                _sanitizedLogs = new PagedResult<SanitizedSystemLogDto>
                {
                    Items = new List<SanitizedSystemLogDto>(),
                    Page = _currentPage,
                    PageSize = _pageSize,
                    TotalCount = 0
                };
            }
        }
        finally
        {
            _isLoadingLogs = false;
            StateHasChanged();
        }
    }

    private async Task OnFilterChanged()
    {
        _currentPage = 1;
        await Task.CompletedTask;
        StateHasChanged();
    }

    private void ClearFilters()
    {
        _selectedLogLevel = string.Empty;
        _startDate = DateTime.Now.AddDays(-1);
        _endDate = DateTime.Now;
        _searchText = string.Empty;
        _currentPage = 1;
        _ = LoadLogsAsync();
    }

    private async Task OnPageChanged(int page)
    {
        _currentPage = page;
        await LoadLogsAsync();
    }

    private void ShowLogDetails(SystemLogDto log)
    {
        _selectedLog = log;
        _selectedSanitizedLog = null;
        StateHasChanged();
    }

    private void ShowSanitizedLogDetails(SanitizedSystemLogDto log)
    {
        _selectedSanitizedLog = log;
        _selectedLog = null;
        StateHasChanged();
    }

    private async Task ExportLogs()
    {
        // Stub implementation for now
        Snackbar.Add(TranslationService.GetTranslation("health.exportNotImplemented", "Export feature coming soon"), Severity.Info);
        await Task.CompletedTask;
    }

    private Color GetLogLevelColor(string level)
    {
        return level?.ToLower() switch
        {
            "debug" => Color.Info,
            "information" => Color.Primary,
            "warning" => Color.Warning,
            "error" => Color.Error,
            "critical" => Color.Error,
            _ => Color.Default
        };
    }

    private Color GetStatusColor(string? status)
    {
        if (string.IsNullOrEmpty(status)) return Color.Default;
        
        return status.ToLower() switch
        {
            "healthy" => Color.Success,
            "degraded" => Color.Warning,
            "unhealthy" or "error" => Color.Error,
            "disabled" => Color.Info,
            _ => Color.Default
        };
    }

    private Color GetOverallHealthColor()
    {
        if (HealthData == null) return Color.Default;

        var statuses = new List<string?>
        {
            HealthData.ApiStatus,
            HealthData.DatabaseStatus
        };

        if (statuses.Any(s => s?.ToLower() == "unhealthy" || s?.ToLower() == "error"))
            return Color.Error;
        else if (statuses.Any(s => s?.ToLower() == "degraded" || s?.ToLower() == "warning"))
            return Color.Warning;
        else if (statuses.Any(s => s?.ToLower() == "healthy"))
            return Color.Success;
        else
            return Color.Info;
    }

    private string GetOverallHealthIcon()
    {
        if (HealthData == null) return Icons.Material.Filled.Help;

        var overallStatus = GetOverallHealthStatus();
        return overallStatus.ToLower() switch
        {
            "healthy" => Icons.Material.Filled.CheckCircle,
            "degraded" => Icons.Material.Filled.Warning,
            "unhealthy" => Icons.Material.Filled.Error,
            _ => Icons.Material.Filled.Help
        };
    }

    private string GetOverallHealthStatus()
    {
        if (HealthData == null) return "Unknown";

        var statuses = new List<string?>
        {
            HealthData.ApiStatus,
            HealthData.DatabaseStatus
        };

        if (statuses.Any(s => s?.ToLower() == "unhealthy" || s?.ToLower() == "error"))
            return "Unhealthy";
        else if (statuses.Any(s => s?.ToLower() == "degraded" || s?.ToLower() == "warning"))
            return "Degraded";
        else if (statuses.Any(s => s?.ToLower() == "healthy"))
            return "Healthy";
        else
            return "Unknown";
    }

    private string FormatUptime(TimeSpan uptime)
    {
        if (uptime.TotalDays >= 1)
            return $"{uptime.Days}d {uptime.Hours}h {uptime.Minutes}m";
        else if (uptime.TotalHours >= 1)
            return $"{uptime.Hours}h {uptime.Minutes}m";
        else
            return $"{uptime.Minutes}m {uptime.Seconds}s";
    }

    private string FormatTimeRemaining(DateTime expiresAt)
    {
        var remaining = expiresAt - DateTime.UtcNow;
        if (remaining.TotalSeconds <= 0)
            return TranslationService.GetTranslation("health.expired", "Expired");
        
        if (remaining.TotalDays >= 1)
            return $"{remaining.Days}d {remaining.Hours}h {remaining.Minutes}m";
        else if (remaining.TotalHours >= 1)
            return $"{remaining.Hours}h {remaining.Minutes}m {remaining.Seconds}s";
        else if (remaining.TotalMinutes >= 1)
            return $"{remaining.Minutes}m {remaining.Seconds}s";
        else
            return $"{remaining.Seconds}s";
    }

    private string GetDeviceIcon(string? deviceType)
    {
        return deviceType?.ToLower() switch
        {
            "mobile" => "",
            "tablet" => "",
            "desktop" => "",
            _ => ""
        };
    }

    private void ShowSessionDetails(ActiveSessionDto session)
    {
        _selectedSessionForDetails = session;
        StateHasChanged();
    }

    private async Task TerminateSession(Guid sessionId)
    {
        if (_isTerminatingSession)
            return;

        try
        {
            _isTerminatingSession = true;
            StateHasChanged();

            var success = await ProfileService.TerminateSessionAsync(sessionId);
            
            if (success)
            {
                // Remove the terminated session from the list
                ActiveSessions?.RemoveAll(s => s.Id == sessionId);
                
                Snackbar.Add(
                    TranslationService.GetTranslation("health.sessionTerminated", "Session terminated successfully"),
                    Severity.Success
                );
            }
            else
            {
                Snackbar.Add(
                    TranslationService.GetTranslation("health.sessionTerminationFailed", "Failed to terminate session"),
                    Severity.Error
                );
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add(
                TranslationService.GetTranslation("health.errorTerminatingSession", "Error terminating session: {0}", ex.Message),
                Severity.Error
            );
        }
        finally
        {
            _isTerminatingSession = false;
            StateHasChanged();
        }
    }

    private async Task TerminateAllOtherSessions()
    {
        if (_isTerminatingSession)
            return;

        // Ask for confirmation
        var confirmed = await DialogService.ShowMessageBox(
            TranslationService.GetTranslation("health.confirmTermination", "Confirm Termination"),
            TranslationService.GetTranslation("health.confirmTerminateAllOtherSessions", "Are you sure you want to terminate all other sessions? This action cannot be undone."),
            yesText: TranslationService.GetTranslation("common.yes", "Yes"),
            noText: TranslationService.GetTranslation("common.no", "No")
        );

        if (confirmed != true)
            return;

        try
        {
            _isTerminatingSession = true;
            StateHasChanged();

            var success = await ProfileService.TerminateAllOtherSessionsAsync();
            
            if (success)
            {
                // Remove all non-current sessions from the list
                ActiveSessions?.RemoveAll(s => !s.IsCurrentSession);
                
                Snackbar.Add(
                    TranslationService.GetTranslation("health.allOtherSessionsTerminated", "All other sessions terminated successfully"),
                    Severity.Success
                );
            }
            else
            {
                Snackbar.Add(
                    TranslationService.GetTranslation("health.terminationFailed", "Failed to terminate other sessions"),
                    Severity.Error
                );
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add(
                TranslationService.GetTranslation("health.errorTerminatingSessions", "Error terminating sessions: {0}", ex.Message),
                Severity.Error
            );
        }
        finally
        {
            _isTerminatingSession = false;
            StateHasChanged();
        }
    }

    public void Dispose()
    {
        StopAutoRefresh();
    }
}