@using EventForge.DTOs.PriceLists
@using EventForge.DTOs.Products
@using EventForge.DTOs.Common
@inject IPriceListService PriceListService
@inject ISnackbar Snackbar
@inject ITranslationService TranslationService
@inject ILogger<GenerateFromDefaultPricesDialog> Logger

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.PriceChange" Class="mr-2" />
            @TranslationService.GetTranslation("pricelist.generateFromDefaults", "Genera Listino da Prezzi Default")
        </MudText>
    </TitleContent>
    
    <DialogContent>
        <MudForm @ref="_form" @bind-IsValid="_isValid">
            <MudStack Spacing="3">
                
                <!-- Section 1: Basic Info -->
                <MudPaper Elevation="1" Class="pa-3">
                    <MudText Typo="Typo.subtitle1" Class="mb-2">
                        <MudIcon Icon="@Icons.Material.Filled.Info" Size="Size.Small" Class="mr-1" />
                        Informazioni Listino
                    </MudText>
                    
                    <MudTextField @bind-Value="_name" 
                                  Label="@TranslationService.GetTranslation("field.name", "Nome Listino")"
                                  Required="true"
                                  RequiredError="@TranslationService.GetTranslation("validation.required", "Campo obbligatorio")"
                                  Variant="Variant.Outlined"
                                  Immediate="true"
                                  Class="ef-input" />
                    
                    <MudTextField @bind-Value="_description" 
                                  Label="@TranslationService.GetTranslation("field.description", "Descrizione")"
                                  Lines="2"
                                  Variant="Variant.Outlined"
                                  Class="ef-input mt-2" />
                    
                    <MudTextField @bind-Value="_code" 
                                  Label="@TranslationService.GetTranslation("field.code", "Codice")"
                                  Variant="Variant.Outlined"
                                  HelperText="@TranslationService.GetTranslation("pricelist.codeHelper", "Lascia vuoto per generazione automatica")"
                                  Class="ef-input mt-2" />
                </MudPaper>
                
                <!-- Section 2: Options -->
                <MudPaper Elevation="1" Class="pa-3">
                    <MudText Typo="Typo.subtitle1" Class="mb-2">
                        <MudIcon Icon="@Icons.Material.Filled.Tune" Size="Size.Small" Class="mr-1" />
                        Opzioni
                    </MudText>
                    
                    <MudGrid Spacing="2">
                        <MudItem xs="12" md="6">
                            <MudSwitch @bind-Value="_isDefault" 
                                       Label="@TranslationService.GetTranslation("pricelist.isDefault", "Listino Default")" 
                                       Color="Color.Warning" />
                        </MudItem>
                        
                        <MudItem xs="12" md="6">
                            <MudNumericField @bind-Value="_priority" 
                                             Label="@TranslationService.GetTranslation("field.priority", "Priorità")"
                                             Min="0" Max="100"
                                             Variant="Variant.Outlined"
                                             HelperText="@TranslationService.GetTranslation("pricelist.priorityHelper", "0 = priorità massima")"
                                             Class="ef-numeric" />
                        </MudItem>
                        
                        <MudItem xs="12" md="6">
                            <MudDatePicker @bind-Date="_validFrom" 
                                           Label="@TranslationService.GetTranslation("field.validFrom", "Valido Da")"
                                           Variant="Variant.Outlined"
                                           Class="ef-datepicker" />
                        </MudItem>
                        
                        <MudItem xs="12" md="6">
                            <MudDatePicker @bind-Date="_validTo" 
                                           Label="@TranslationService.GetTranslation("field.validTo", "Valido Fino")"
                                           Variant="Variant.Outlined"
                                           Class="ef-datepicker" />
                        </MudItem>
                    </MudGrid>
                </MudPaper>
                
                <!-- Section 3: Advanced Options (Collapsible) -->
                <MudExpansionPanels>
                    <MudExpansionPanel Text="@TranslationService.GetTranslation("pricelist.advancedOptions", "Opzioni Avanzate")">
                        <MudStack Spacing="2">
                            <!-- Price Adjustments -->
                            <MudText Typo="Typo.subtitle2" Class="mt-2">
                                <MudIcon Icon="@Icons.Material.Filled.Calculate" Size="Size.Small" Class="mr-1" />
                                Adattamento Prezzi
                            </MudText>
                            
                            <MudNumericField @bind-Value="_markupPercentage" 
                                             Label="@TranslationService.GetTranslation("pricelist.markup", "Maggiorazione %")"
                                             Min="-100" Max="500"
                                             Step="0.1M"
                                             Variant="Variant.Outlined"
                                             HelperText="Valori negativi = sconto. Es: +10% = 1.10x, -15% = 0.85x"
                                             Class="ef-numeric" />
                            
                            <MudSelect @bind-Value="_roundingStrategy" 
                                       Label="@TranslationService.GetTranslation("pricelist.rounding", "Arrotondamento")"
                                       Variant="Variant.Outlined"
                                       Class="ef-select">
                                <MudSelectItem Value="@((RoundingStrategy?)null)">Nessuno</MudSelectItem>
                                <MudSelectItem Value="@RoundingStrategy.ToNearest5Cents">0.05 € (es. 12.47 → 12.45)</MudSelectItem>
                                <MudSelectItem Value="@RoundingStrategy.ToNearest10Cents">0.10 € (es. 12.47 → 12.50)</MudSelectItem>
                                <MudSelectItem Value="@RoundingStrategy.ToNearest50Cents">0.50 € (es. 12.47 → 12.50)</MudSelectItem>
                                <MudSelectItem Value="@RoundingStrategy.ToNearestEuro">1.00 € (es. 12.47 → 12.00)</MudSelectItem>
                                <MudSelectItem Value="@RoundingStrategy.ToNearest99Cents">X.99 € (es. 12.47 → 12.99)</MudSelectItem>
                            </MudSelect>
                            
                            <!-- Filters -->
                            <MudDivider Class="my-2" />
                            
                            <MudText Typo="Typo.subtitle2">
                                <MudIcon Icon="@Icons.Material.Filled.FilterList" Size="Size.Small" Class="mr-1" />
                                Filtri Prodotti
                            </MudText>
                            
                            <MudSwitch @bind-Value="_onlyActiveProducts" 
                                       Label="@TranslationService.GetTranslation("pricelist.onlyActiveProducts", "Solo Prodotti Attivi")" 
                                       Color="Color.Primary" />
                            
                            <MudNumericField @bind-Value="_minimumPrice" 
                                             Label="@TranslationService.GetTranslation("pricelist.minimumPrice", "Prezzo Minimo")"
                                             Min="0"
                                             Variant="Variant.Outlined"
                                             HelperText="Escludi prodotti con prezzo inferiore"
                                             Class="ef-numeric" />
                        </MudStack>
                    </MudExpansionPanel>
                </MudExpansionPanels>
                
                <!-- Section 4: Preview Button -->
                <MudButton Variant="Variant.Outlined" 
                           Color="Color.Info"
                           StartIcon="@Icons.Material.Filled.Preview"
                           OnClick="@LoadPreview"
                           Disabled="@(!_isValid || _isLoadingPreview)"
                           FullWidth="true">
                    @if (_isLoadingPreview)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                    }
                    @TranslationService.GetTranslation("pricelist.preview", "Carica Anteprima")
                </MudButton>
                
                <!-- Preview Results -->
                @if (_previewData != null)
                {
                    <MudAlert Severity="Severity.Success" Dense="true">
                        <MudStack Spacing="1">
                            <MudText Typo="Typo.body2">
                                <strong>@_previewData.TotalProductsFound</strong> prodotti con prezzo default trovati
                            </MudText>
                            <MudText Typo="Typo.caption">
                                Valore totale listino: <strong>@_previewData.TotalEstimatedValue.ToString("C2")</strong>
                            </MudText>
                            @if (_previewData.ProductsExcluded > 0)
                            {
                                <MudText Typo="Typo.caption" Color="Color.Warning">
                                    @_previewData.ProductsExcluded prodotti esclusi per filtri
                                </MudText>
                            }
                        </MudStack>
                    </MudAlert>
                    
                    <MudTable Items="@_previewData.ProductPreviews.Take(10)" 
                              Dense="true" 
                              Hover="true"
                              Height="300px"
                              FixedHeader="true">
                        <HeaderContent>
                            <MudTh>Prodotto</MudTh>
                            <MudTh>Prezzo Default</MudTh>
                            <MudTh>Prezzo Finale</MudTh>
                        </HeaderContent>
                        <RowTemplate Context="preview">
                            <MudTd>
                                <MudText Typo="Typo.body2">@preview.ProductName</MudText>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">@preview.ProductCode</MudText>
                            </MudTd>
                            <MudTd>
                                <MudText Typo="Typo.body2" Color="Color.Secondary">
                                    @preview.OriginalPrice.ToString("C2")
                                </MudText>
                            </MudTd>
                            <MudTd>
                                <MudText Typo="Typo.body2">
                                    <strong>@preview.CalculatedPrice.ToString("C2")</strong>
                                </MudText>
                                @if (preview.OriginalPrice != preview.CalculatedPrice)
                                {
                                    var diff = preview.CalculatedPrice - preview.OriginalPrice;
                                    var diffPercent = (diff / preview.OriginalPrice) * 100;
                                    <MudChip T="string"
                                             Size="Size.Small" 
                                             Color="@(diff > 0 ? Color.Success : Color.Error)" 
                                             Variant="Variant.Text">
                                        @(diff > 0 ? "+" : "")@diff.ToString("C2") (@diffPercent.ToString("+0.0;-0.0"))%
                                    </MudChip>
                                }
                            </MudTd>
                        </RowTemplate>
                    </MudTable>
                    
                    @if (_previewData.ProductPreviews.Count > 10)
                    {
                        <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-2">
                            Mostrati 10 di @_previewData.ProductPreviews.Count prodotti
                        </MudText>
                    }
                }
            </MudStack>
        </MudForm>
    </DialogContent>
    
    <DialogActions>
        <MudButton OnClick="Cancel">
            @TranslationService.GetTranslation("common.cancel", "Annulla")
        </MudButton>
        <MudButton Color="Color.Primary" 
                   Variant="Variant.Filled"
                   OnClick="Submit"
                   Disabled="@(!_isValid || _isSubmitting || _previewData == null)">
            @if (_isSubmitting)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
            }
            @TranslationService.GetTranslation("pricelist.generate", "Genera Listino") (@(_previewData?.TotalProductsFound ?? 0))
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] IMudDialogInstance MudDialog { get; set; } = null!;
    
    private MudForm _form = null!;
    private bool _isValid;
    private bool _isSubmitting;
    private bool _isLoadingPreview;
    
    // Basic Info
    private string _name = string.Empty;
    private string? _description;
    private string? _code;
    
    // Options
    private int _priority = 50;
    private bool _isDefault = false;
    private DateTime? _validFrom;
    private DateTime? _validTo;
    
    // Advanced Options
    private decimal? _markupPercentage;
    private RoundingStrategy? _roundingStrategy;
    private bool _onlyActiveProducts = true;
    private decimal? _minimumPrice;
    
    private GeneratePriceListPreviewDto? _previewData;

    private async Task LoadPreview()
    {
        if (!_isValid)
            return;
        
        try
        {
            _isLoadingPreview = true;
            
            var dto = BuildDto();
            
            // Call preview endpoint
            _previewData = await PriceListService.PreviewGenerateFromDefaultPricesAsync(dto, CancellationToken.None);
            
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading preview");
            Snackbar.Add($"Errore anteprima: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoadingPreview = false;
        }
    }

    private async Task Submit()
    {
        if (!_isValid || _previewData == null)
            return;
        
        try
        {
            _isSubmitting = true;
            
            var dto = BuildDto();
            
            // Call generate endpoint
            var newPriceListId = await PriceListService.GenerateFromDefaultPricesAsync(dto, CancellationToken.None);
            
            Snackbar.Add(
                TranslationService.GetTranslation("pricelist.generatedSuccess", "Listino generato con successo"), 
                Severity.Success);
            
            MudDialog.Close(DialogResult.Ok(newPriceListId));
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error generating price list");
            Snackbar.Add($"Errore: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isSubmitting = false;
        }
    }

    private GenerateFromDefaultPricesDto BuildDto()
    {
        return new GenerateFromDefaultPricesDto
        {
            Name = _name,
            Description = _description,
            Code = _code,
            IsDefault = _isDefault,
            Priority = _priority,
            ValidFrom = _validFrom,
            ValidTo = _validTo,
            MarkupPercentage = _markupPercentage,
            RoundingStrategy = _roundingStrategy,
            OnlyActiveProducts = _onlyActiveProducts,
            MinimumPrice = _minimumPrice
        };
    }

    private void Cancel()
    {
        MudDialog.Cancel();
    }
}
