@using EventForge.DTOs.Products
@using EventForge.DTOs.Warehouse
@inject ITranslationService TranslationService
@inject IProductService ProductService
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<MudDialog>
    <TitleContent>
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Style="width: 100%;">
            <MudText Typo="Typo.h6">
                <MudIcon Icon="@Icons.Material.Outlined.Inventory" Class="mr-2" />
                @TranslationService.GetTranslation("warehouse.inventoryEntry", "Inserimento Inventario") 
                @if (_localProduct != null)
                {
                    <span>- @_localProduct.Name</span>
                }
            </MudText>
            @if (_localProduct != null)
            {
                <MudTooltip Text="@TranslationService.GetTranslation("warehouse.quickEditProduct", "Modifica prodotto rapida")">
                    <MudIconButton Icon="@Icons.Material.Outlined.EditNote"
                                   Color="Color.Info"
                                   Size="Size.Small"
                                   OnClick="@(() => OpenQuickEditProduct())" />
                </MudTooltip>
            }
        </MudStack>
    </TitleContent>
    <DialogContent>
        <MudStack Spacing="3">
            <!-- Product Information Display -->
            @if (_localProduct != null)
            {
                <MudPaper Elevation="0" Class="pa-3" Style="background-color: var(--mud-palette-background-grey);">
                    <MudGrid Spacing="2">
                        <MudItem xs="12" md="6">
                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                @TranslationService.GetTranslation("warehouse.productCode", "Codice Prodotto")
                            </MudText>
                            <MudText Typo="Typo.body2" Style="font-weight: 600;">
                                @_localProduct.Code
                            </MudText>
                        </MudItem>
                        @if (!string.IsNullOrEmpty(_localProduct.Description))
                        {
                            <MudItem xs="12">
                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                    @TranslationService.GetTranslation("warehouse.description", "Descrizione")
                                </MudText>
                                <MudText Typo="Typo.body2">
                                    @_localProduct.Description
                                </MudText>
                            </MudItem>
                        }
                    </MudGrid>
                </MudPaper>
            }

            <!-- Alternative Unit Notice -->
            @if (ConversionFactor > 1)
            {
                <MudAlert Severity="Severity.Warning" Dense="true" Variant="Variant.Outlined">
                    <MudText Typo="Typo.caption">
                        <MudIcon Icon="@Icons.Material.Outlined.SwapHoriz" Size="Size.Small" Class="mr-1" />
                        <strong>Unità alternativa rilevata:</strong> 
                        Fattore di conversione @ConversionFactor.ToString("0.##") - Le quantità sono già convertite in unità base
                    </MudText>
                </MudAlert>
            }

            <!-- Keyboard Shortcuts Helper -->
            <MudAlert Severity="Severity.Info" Dense="true" Variant="Variant.Outlined">
                <MudText Typo="Typo.caption">
                    <MudIcon Icon="@Icons.Material.Outlined.Keyboard" Size="Size.Small" Class="mr-1" />
                    <strong>@TranslationService.GetTranslation("common.shortcuts", "Scorciatoie"):</strong> 
                    Tab = campo successivo | Invio su Quantità = Aggiungi | Esc = Annulla
                </MudText>
            </MudAlert>

            <!-- Entry Form -->
            <MudForm @ref="_form" @bind-IsValid="@_isFormValid">
                <MudStack Spacing="3">
                    <MudSelect T="Guid?"
                               @bind-Value="@_selectedLocationId"
                               Label="@TranslationService.GetTranslation("warehouse.storageLocation", "Ubicazione")"
                               Variant="Variant.Outlined"
                               Required="true"
                               RequiredError="@TranslationService.GetTranslation("validation.required", "Campo obbligatorio")"
                               Adornment="Adornment.Start"
                               AdornmentIcon="@Icons.Material.Outlined.LocationOn"
                               @ref="_locationSelect"
                               @onkeydown="@OnLocationKeyDown">
                        @if (Locations != null)
                        {
                            @foreach (var location in Locations)
                            {
                                <MudSelectItem Value="@((Guid?)location.Id)">
                                    @location.Code - @location.Description
                                </MudSelectItem>
                            }
                        }
                    </MudSelect>

                    <MudNumericField T="decimal"
                                    @bind-Value="_quantity"
                                    Label="@(ConversionFactor > 1 ? TranslationService.GetTranslation("warehouse.quantity", "Quantità") + " (unità base)" : TranslationService.GetTranslation("warehouse.quantity", "Quantità"))"
                                    Variant="Variant.Outlined"
                                    Min="0"
                                    Required="true"
                                    RequiredError="@TranslationService.GetTranslation("validation.required", "Campo obbligatorio")"
                                    Adornment="Adornment.Start"
                                    AdornmentIcon="@Icons.Material.Outlined.Numbers"
                                    @ref="_quantityField"
                                    @onkeydown="@OnQuantityKeyDown" />

                    <MudTextField @bind-Value="_notes"
                                 Label="@TranslationService.GetTranslation("warehouse.notes", "Note")"
                                 Variant="Variant.Outlined"
                                 Lines="2"
                                 MaxLength="200"
                                 Counter="200"
                                 Adornment="Adornment.Start"
                                 AdornmentIcon="@Icons.Material.Outlined.Comment"
                                 @onkeydown="@OnNotesKeyDown" />
                </MudStack>
            </MudForm>
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel" Color="Color.Default">
            @TranslationService.GetTranslation("common.cancel", "Annulla")
        </MudButton>
        <MudButton OnClick="Submit" 
                   Color="Color.Success" 
                   Variant="Variant.Filled"
                   StartIcon="@Icons.Material.Outlined.Add"
                   Disabled="@(!_isFormValid)">
            @TranslationService.GetTranslation("warehouse.addToInventory", "Aggiungi al Documento")
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    IMudDialogInstance MudDialog { get; set; } = null!;

    [Parameter]
    public ProductDto? Product { get; set; }

    [Parameter]
    public List<StorageLocationDto>? Locations { get; set; }

    [Parameter]
    public decimal ConversionFactor { get; set; } = 1m;

    [Parameter]
    public EventCallback<Guid> OnQuickEditProduct { get; set; }

    private MudForm? _form;
    private MudSelect<Guid?>? _locationSelect;
    private MudNumericField<decimal>? _quantityField;
    private bool _isFormValid;
    private Guid? _selectedLocationId;
    private decimal _quantity;
    private string _notes = string.Empty;
    private ProductDto? _localProduct;

    protected override void OnInitialized()
    {
        // Initialize quantity with conversion factor for alternative units
        // This converts 1 alternative unit to base units
        _quantity = ConversionFactor;
        
        // Keep a local copy of the product that can be updated
        _localProduct = Product;
    }
    
    protected override void OnParametersSet()
    {
        // Update local product if the parameter changes
        _localProduct = Product;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Auto-select location if only one exists
            if (Locations?.Count == 1)
            {
                _selectedLocationId = Locations[0].Id;
                StateHasChanged();
                // Focus on quantity field since location is auto-selected
                if (_quantityField != null)
                {
                    await _quantityField.FocusAsync();
                }
            }
            else if (_locationSelect != null)
            {
                // Focus on location select if multiple locations
                await _locationSelect.FocusAsync();
            }
        }
    }

    private async Task OnLocationKeyDown(KeyboardEventArgs e)
    {
        // Tab or Enter to move to quantity field
        if ((e.Key == "Tab" || e.Key == "Enter") && _selectedLocationId.HasValue)
        {
            if (_quantityField != null)
            {
                await Task.Delay(100); // Small delay to ensure location is set
                await _quantityField.FocusAsync();
            }
        }
    }

    private async Task OnQuantityKeyDown(KeyboardEventArgs e)
    {
        // Enter to submit if form is valid (skip notes)
        if (e.Key == "Enter" && _isFormValid && !e.ShiftKey)
        {
            Submit();
        }
    }

    private async Task OnNotesKeyDown(KeyboardEventArgs e)
    {
        // Ctrl+Enter to submit from notes field
        if (e.Key == "Enter" && e.CtrlKey && _isFormValid)
        {
            Submit();
        }
    }

    private void Cancel()
    {
        MudDialog.Cancel();
    }

    private void Submit()
    {
        if (!_isFormValid || !_selectedLocationId.HasValue)
            return;

        var result = new InventoryEntryResult
        {
            LocationId = _selectedLocationId.Value,
            Quantity = _quantity,
            Notes = _notes
        };

        MudDialog.Close(DialogResult.Ok(result));
    }

    private async Task OpenQuickEditProduct()
    {
        if (_localProduct?.Id == null)
            return;

        try
        {
            // Load the product details
            var product = await ProductService.GetProductByIdAsync(_localProduct.Id);
            if (product == null)
            {
                Snackbar.Add(TranslationService.GetTranslation("products.notFound", "Prodotto non trovato"), Severity.Error);
                return;
            }

            var parameters = new DialogParameters
            {
                { "IsEditMode", true },
                { "ProductId", _localProduct.Id },
                { "ExistingProduct", product }
            };

            var options = new DialogOptions
            {
                MaxWidth = MaxWidth.Medium,
                FullWidth = true,
                CloseButton = true,
                CloseOnEscapeKey = true
            };

            var dialog = await DialogService.ShowAsync<QuickCreateProductDialog>(
                TranslationService.GetTranslation("warehouse.quickEditProduct", "Modifica Rapida Prodotto"),
                parameters,
                options);

            var result = await dialog.Result;

            if (!result.Canceled && result.Data is ProductDto updatedProduct)
            {
                // Update the local product reference
                _localProduct = updatedProduct;
                
                Snackbar.Add(TranslationService.GetTranslation("products.updateSuccess", "Prodotto aggiornato con successo"), Severity.Success);
                
                // Trigger a re-render to show the updated product information
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add(TranslationService.GetTranslation("products.loadError", "Errore nel caricamento del prodotto"), Severity.Error);
        }
    }

    public class InventoryEntryResult
    {
        public Guid LocationId { get; set; }
        public decimal Quantity { get; set; }
        public string Notes { get; set; } = string.Empty;
    }
}
