@using EventForge.DTOs.Business
@using EventForge.DTOs.Common
@using EventForge.DTOs.External
@inject ITranslationService TranslationService
@inject IBusinessPartyService BusinessPartyService
@inject IVatLookupService VatLookupService
@inject ISnackbar Snackbar
@inject ILogger<QuickCreateBusinessPartyDialog> Logger

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">
            @(IsEditMode 
                ? TranslationService.GetTranslation("business.quickEditPartner", "Modifica Rapida Partner")
                : TranslationService.GetTranslation("business.quickCreatePartner", "Creazione Rapida Partner"))
        </MudText>
    </TitleContent>
    <DialogContent>
        <div class="ef-dialog-content">
            <PageLoadingOverlay Visible="_isLoading" />

            <MudForm @ref="_form" @bind-IsValid="@_isFormValid">
                <MudStack Spacing="3">
                    
                    <!-- Dati Identificativi -->
                    <MudPaper Elevation="2" Class="pa-4 mb-4">
                        <MudText Typo="Typo.h6" Class="mb-3">
                            @TranslationService.GetTranslation("business.identification", "Dati Identificativi")
                        </MudText>
                        
                        <MudGrid Spacing="2">
                            <MudItem xs="12" sm="6">
                                <MudSelect @bind-Value="_model.PartyType"
                                          Label="@($"{TranslationService.GetTranslation("field.partyType", "Tipo Partner")} *")"
                                          Variant="Variant.Outlined"
                                          Required="true">
                                    <MudSelectItem Value="BusinessPartyType.Cliente">
                                        @TranslationService.GetTranslation("businessPartyType.customer", "Cliente")
                                    </MudSelectItem>
                                    <MudSelectItem Value="BusinessPartyType.Supplier">
                                        @TranslationService.GetTranslation("businessPartyType.supplier", "Fornitore")
                                    </MudSelectItem>
                                    <MudSelectItem Value="BusinessPartyType.Both">
                                        @TranslationService.GetTranslation("businessPartyType.both", "Entrambi")
                                    </MudSelectItem>
                                </MudSelect>
                            </MudItem>
                            <MudItem xs="12" sm="6">
                                <MudTextField @bind-Value="_model.Name"
                                              Label="@($"{TranslationService.GetTranslation("field.name", "Nome/Ragione Sociale")} *")"
                                              Variant="Variant.Outlined"
                                              Required="true"
                                              RequiredError="@TranslationService.GetTranslation("validation.nameRequired", "Il nome Ã¨ obbligatorio")"
                                              MaxLength="200"
                                              Counter="200" />
                            </MudItem>
                        </MudGrid>
                    </MudPaper>

                    <!-- Dati Fiscali -->
                    <MudPaper Elevation="2" Class="pa-4 mb-4">
                        <MudText Typo="Typo.h6" Class="mb-3">
                            @TranslationService.GetTranslation("business.fiscalData", "Dati Fiscali (Opzionali)")
                        </MudText>
                        
                        <MudGrid Spacing="2">
                            <MudItem xs="12" sm="4">
                                <MudTextField @bind-Value="_model.TaxCode"
                                              Label="@TranslationService.GetTranslation("field.taxCode", "Codice Fiscale")"
                                              Variant="Variant.Outlined"
                                              MaxLength="20" />
                            </MudItem>
                            <MudItem xs="12" sm="8">
                                <div class="d-flex gap-2">
                                    <MudTextField @bind-Value="_model.VatNumber"
                                                  Label="@TranslationService.GetTranslation("field.vatNumber", "Partita IVA")"
                                                  Variant="Variant.Outlined"
                                                  MaxLength="20"
                                                  Placeholder="IT12345678901"
                                                  Style="flex-grow: 1;" />
                                    <MudButton Variant="Variant.Filled"
                                               Color="Color.Primary"
                                               StartIcon="@Icons.Material.Filled.Search"
                                               OnClick="@LookupVatAsync"
                                               Disabled="@(string.IsNullOrWhiteSpace(_model.VatNumber) || _isLookingUp)"
                                               Style="align-self: flex-start; margin-top: 4px;">
                                        @if (_isLookingUp)
                                        {
                                            <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                                        }
                                        else
                                        {
                                            @TranslationService.GetTranslation("common.search", "Cerca")
                                        }
                                    </MudButton>
                                </div>
                            </MudItem>
                        </MudGrid>
                        
                        <!-- VAT Lookup Result -->
                        @if (_lookupResult != null)
                        {
                            @if (_lookupResult.IsValid)
                            {
                                <MudAlert Severity="Severity.Success" Icon="@Icons.Material.Filled.CheckCircle" Dense="true" Class="mt-3">
                                    <MudStack Spacing="1">
                                        <MudText Typo="Typo.body2" Style="font-weight: 600;">
                                            @_lookupResult.Name
                                        </MudText>
                                        <MudText Typo="Typo.caption">@_lookupResult.Address</MudText>
                                        <MudButton Size="Size.Small"
                                                   Variant="Variant.Text"
                                                   StartIcon="@Icons.Material.Outlined.ContentCopy"
                                                   OnClick="@ApplyLookupData">
                                            @TranslationService.GetTranslation("vat.useData", "Usa questi dati")
                                        </MudButton>
                                    </MudStack>
                                </MudAlert>
                            }
                            else
                            {
                                <MudAlert Severity="Severity.Warning" Dense="true" Class="mt-3">
                                    @TranslationService.GetTranslation("vat.invalidVat", "Partita IVA non valida o non trovata")
                                </MudAlert>
                            }
                        }
                        
                        <MudGrid Spacing="2" Class="mt-2">
                            <MudItem xs="12" sm="4">
                                <MudTextField @bind-Value="_model.SdiCode"
                                              Label="@TranslationService.GetTranslation("field.sdiCode", "Codice SDI")"
                                              Variant="Variant.Outlined"
                                              MaxLength="10" />
                            </MudItem>
                        </MudGrid>
                    </MudPaper>

                </MudStack>
            </MudForm>
        </div>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel" 
                   Variant="Variant.Text" 
                   Color="Color.Default">
            @TranslationService.GetTranslation("common.cancel", "Annulla")
        </MudButton>
        <MudButton OnClick="CreatePartner" 
                   Variant="Variant.Filled" 
                   Color="Color.Primary"
                   Disabled="@(!_isFormValid || _isLoading)"
                   StartIcon="@Icons.Material.Filled.Save">
            @TranslationService.GetTranslation("common.save", "Salva")
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] 
    IMudDialogInstance MudDialog { get; set; } = null!;
    
    [Parameter] 
    public BusinessPartyType? PreferredPartyType { get; set; }
    
    [Parameter]
    public Guid? BusinessPartyId { get; set; }
    
    [Parameter]
    public BusinessPartyDto? ExistingBusinessParty { get; set; }
    
    private bool IsEditMode => BusinessPartyId.HasValue || ExistingBusinessParty != null;
    
    private MudForm? _form;
    private bool _isFormValid;
    private bool _isLoading;
    private bool _isLookingUp = false;
    private VatLookupResultDto? _lookupResult;
    
    // Model class for simplified creation
    private class CreateModel
    {
        public BusinessPartyType PartyType { get; set; } = BusinessPartyType.Cliente;
        public string Name { get; set; } = string.Empty;
        public string? TaxCode { get; set; }
        public string? VatNumber { get; set; }
        public string? SdiCode { get; set; }
    }
    
    private CreateModel _model = new();
    
    protected override async Task OnInitializedAsync()
    {
        if (IsEditMode)
        {
            if (ExistingBusinessParty != null)
            {
                _model = new CreateModel
                {
                    PartyType = ExistingBusinessParty.PartyType,
                    Name = ExistingBusinessParty.Name,
                    TaxCode = ExistingBusinessParty.TaxCode,
                    VatNumber = ExistingBusinessParty.VatNumber,
                    SdiCode = ExistingBusinessParty.SdiCode
                };
            }
            else if (BusinessPartyId.HasValue)
            {
                try
                {
                    var bp = await BusinessPartyService.GetBusinessPartyAsync(BusinessPartyId.Value);
                    if (bp != null)
                    {
                        _model = new CreateModel
                        {
                            PartyType = bp.PartyType,
                            Name = bp.Name,
                            TaxCode = bp.TaxCode,
                            VatNumber = bp.VatNumber,
                            SdiCode = bp.SdiCode
                        };
                    }
                }
                catch (Exception ex)
                {
                    Logger.LogError(ex, "Error loading business partner for edit");
                    Snackbar.Add(
                        TranslationService.GetTranslation("business.loadError", "Errore nel caricamento del partner"),
                        Severity.Error
                    );
                }
            }
        }
        else if (PreferredPartyType.HasValue)
        {
            _model.PartyType = PreferredPartyType.Value;
        }
    }
    
    private async Task CreatePartner()
    {
        if (_form == null || !_isFormValid) return;
        
        await _form.Validate();
        if (!_form.IsValid) return;
        
        _isLoading = true;
        try
        {
            BusinessPartyDto result;

            if (IsEditMode && (BusinessPartyId.HasValue || ExistingBusinessParty != null))
            {
                // UPDATE
                var updateDto = new UpdateBusinessPartyDto
                {
                    PartyType = _model.PartyType,
                    Name = _model.Name,
                    TaxCode = _model.TaxCode,
                    VatNumber = _model.VatNumber,
                    SdiCode = _model.SdiCode
                };
                
                var id = BusinessPartyId ?? ExistingBusinessParty!.Id;
                result = await BusinessPartyService.UpdateBusinessPartyAsync(id, updateDto);
                
                Snackbar.Add(
                    TranslationService.GetTranslation("business.updateSuccess", "Partner aggiornato con successo"),
                    Severity.Success
                );
            }
            else
            {
                // CREATE
                var dto = new CreateBusinessPartyDto
                {
                    PartyType = _model.PartyType,
                    Name = _model.Name,
                    TaxCode = _model.TaxCode,
                    VatNumber = _model.VatNumber,
                    SdiCode = _model.SdiCode
                };
                
                result = await BusinessPartyService.CreateBusinessPartyAsync(dto);
                
                Snackbar.Add(
                    TranslationService.GetTranslation("business.createSuccess", "Partner creato con successo"),
                    Severity.Success
                );
            }
            
            if (result != null)
            {
                MudDialog.Close(DialogResult.Ok(result));
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error saving business partner");
            Snackbar.Add(
                TranslationService.GetTranslation("business.saveError", "Errore nel salvataggio del partner"),
                Severity.Error
            );
        }
        finally
        {
            _isLoading = false;
        }
    }
    
    private void Cancel()
    {
        MudDialog.Cancel();
    }
    
    private async Task LookupVatAsync()
    {
        if (string.IsNullOrWhiteSpace(_model.VatNumber)) return;

        _isLookingUp = true;
        _lookupResult = null;

        try
        {
            _lookupResult = await VatLookupService.LookupAsync(_model.VatNumber);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error looking up VAT number");
            Snackbar.Add(
                TranslationService.GetTranslation("vat.lookupError", "Errore durante la verifica della Partita IVA"),
                Severity.Error
            );
        }
        finally
        {
            _isLookingUp = false;
        }
    }

    private void ApplyLookupData()
    {
        if (_lookupResult == null || !_lookupResult.IsValid) return;

        _model.Name = _lookupResult.Name ?? _model.Name;
        // Keep the VAT number as entered (already validated)
        
        Snackbar.Add(
            TranslationService.GetTranslation("vat.dataApplied", "Dati applicati con successo"),
            Severity.Success
        );
    }
}
