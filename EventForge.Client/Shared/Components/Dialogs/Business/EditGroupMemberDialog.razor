@using EventForge.DTOs.Business
@using EventForge.DTOs.Common
@inject IBusinessPartyGroupService GroupService
@inject ISnackbar Snackbar
@inject ILogger<EditGroupMemberDialog> Logger

<MudDialog>
    <TitleContent>
        <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
            <MudIcon Icon="@Icons.Material.Filled.Edit" />
            <MudText Typo="Typo.h6">Modifica Membro Gruppo</MudText>
        </MudStack>
    </TitleContent>
    
    <DialogContent>
        <MudForm @ref="_form" @bind-IsValid="@_isFormValid">
            <MudStack Spacing="3">
                <!-- BP Info (read-only) -->
                <MudPaper Outlined="true" Class="pa-3">
                    <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                        <MudAvatar Color="Color.Primary" Size="Size.Large">
                            <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Large" />
                        </MudAvatar>
                        <MudStack Spacing="0" Style="flex: 1;">
                            <MudText Typo="Typo.h6" Style="font-weight: 600;">
                                @Member.BusinessPartyName
                            </MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                ID: @Member.BusinessPartyId
                            </MudText>
                        </MudStack>
                    </MudStack>
                </MudPaper>
                
                <MudDivider />
                
                <!-- Date pickers -->
                <MudStack Spacing="2">
                    <MudDatePicker @bind-Date="_memberSince" 
                                   Label="Membro Dal" 
                                   Required="true"
                                   Variant="Variant.Outlined"
                                   HelperText="Data di inizio appartenenza al gruppo" />
                    
                    <MudDatePicker @bind-Date="_memberUntil" 
                                   Label="Membro Fino" 
                                   Clearable="true"
                                   Variant="Variant.Outlined"
                                   HelperText="Data di fine appartenenza (opzionale)" />
                </MudStack>
                
                <MudDivider />
                
                <!-- Status -->
                <MudSelect @bind-Value="_status" 
                           Label="Stato Membro"
                           Variant="Variant.Outlined"
                           HelperText="Stato corrente del membro nel gruppo">
                    <MudSelectItem Value="BusinessPartyGroupMemberStatus.Active">
                        <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                            <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" Size="Size.Small" />
                            <MudText>Attivo</MudText>
                        </MudStack>
                    </MudSelectItem>
                    <MudSelectItem Value="BusinessPartyGroupMemberStatus.Suspended">
                        <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                            <MudIcon Icon="@Icons.Material.Filled.PauseCircle" Color="Color.Warning" Size="Size.Small" />
                            <MudText>Sospeso</MudText>
                        </MudStack>
                    </MudSelectItem>
                    <MudSelectItem Value="BusinessPartyGroupMemberStatus.Expired">
                        <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                            <MudIcon Icon="@Icons.Material.Filled.Schedule" Color="Color.Default" Size="Size.Small" />
                            <MudText>Scaduto</MudText>
                        </MudStack>
                    </MudSelectItem>
                    <MudSelectItem Value="BusinessPartyGroupMemberStatus.Revoked">
                        <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                            <MudIcon Icon="@Icons.Material.Filled.Cancel" Color="Color.Error" Size="Size.Small" />
                            <MudText>Revocato</MudText>
                        </MudStack>
                    </MudSelectItem>
                </MudSelect>
                
                <MudDivider />
                
                <!-- Priority + Featured -->
                <MudStack Spacing="2">
                    <MudNumericField @bind-Value="_overridePriority" 
                                     Label="Priorità Specifica" 
                                     Min="0" 
                                     Max="100"
                                     Variant="Variant.Outlined"
                                     HelperText="Priorità personalizzata per questo membro (0-100)" />
                    
                    <MudSwitch @bind-Value="_isFeatured" 
                               Label="Membro in Evidenza"
                               Color="Color.Primary">
                        <MudText Typo="Typo.body2">Evidenzia questo membro</MudText>
                    </MudSwitch>
                </MudStack>
                
                <MudDivider />
                
                <!-- Notes -->
                <MudTextField @bind-Value="_notes" 
                              Label="Note" 
                              Lines="3" 
                              MaxLength="500"
                              Counter="500"
                              Variant="Variant.Outlined"
                              HelperText="Note aggiuntive sull'appartenenza al gruppo" />
                
                <MudDivider />
                
                <!-- Azioni Rapide -->
                <MudPaper Outlined="true" Class="pa-3">
                    <MudText Typo="Typo.subtitle2" Class="mb-2">Azioni Rapide</MudText>
                    
                    <MudStack Row="true" Spacing="2" Style="flex-wrap: wrap;">
                        <MudButton OnClick="@(() => _status = BusinessPartyGroupMemberStatus.Suspended)" 
                                   Color="Color.Warning"
                                   Variant="Variant.Outlined"
                                   StartIcon="@Icons.Material.Filled.PauseCircle"
                                   Size="Size.Small">
                            Sospendi
                        </MudButton>
                        
                        <MudButton OnClick="@(() => _status = BusinessPartyGroupMemberStatus.Active)" 
                                   Color="Color.Success"
                                   Variant="Variant.Outlined"
                                   StartIcon="@Icons.Material.Filled.CheckCircle"
                                   Size="Size.Small">
                            Riattiva
                        </MudButton>
                        
                        <MudButton OnClick="ExtendMembership" 
                                   Color="Color.Primary"
                                   Variant="Variant.Outlined"
                                   StartIcon="@Icons.Material.Filled.Update"
                                   Size="Size.Small">
                            Estendi +12 Mesi
                        </MudButton>
                    </MudStack>
                </MudPaper>
            </MudStack>
        </MudForm>
    </DialogContent>
    
    <DialogActions>
        <MudButton OnClick="Cancel" 
                   Variant="Variant.Text">
            Annulla
        </MudButton>
        <MudButton Color="Color.Primary" 
                   OnClick="Submit" 
                   Disabled="@(!_isFormValid)"
                   Variant="Variant.Filled"
                   StartIcon="@Icons.Material.Filled.Save">
            Salva Modifiche
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] 
    IMudDialogInstance MudDialog { get; set; } = null!;
    
    [Parameter] 
    public BusinessPartyGroupMemberDto Member { get; set; } = null!;
    
    [Parameter] 
    public Guid GroupId { get; set; }
    
    private MudForm? _form;
    private bool _isFormValid;
    private DateTime? _memberSince;
    private DateTime? _memberUntil;
    private BusinessPartyGroupMemberStatus _status;
    private int? _overridePriority;
    private bool _isFeatured;
    private string? _notes;
    
    protected override void OnInitialized()
    {
        _memberSince = Member.MemberSince;
        _memberUntil = Member.MemberUntil;
        _status = Member.Status;
        _overridePriority = Member.OverridePriority;
        _isFeatured = Member.IsFeatured;
        _notes = Member.Notes;
    }
    
    private void ExtendMembership()
    {
        _memberUntil = DateTime.Today.AddMonths(12);
    }
    
    private async Task Submit()
    {
        if (_form == null || !_isFormValid) 
            return;
        
        await _form.Validate();
        if (!_form.IsValid) 
            return;
        
        try
        {
            var updateDto = new UpdateBusinessPartyGroupMemberDto
            {
                MemberSince = _memberSince,
                MemberUntil = _memberUntil,
                Status = _status,
                OverridePriority = _overridePriority,
                IsFeatured = _isFeatured,
                Notes = _notes
            };
            
            await GroupService.UpdateMemberAsync(Member.Id, updateDto);
            
            Snackbar.Add("Membro aggiornato con successo", Severity.Success);
            MudDialog.Close(DialogResult.Ok(true));
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error updating member {MemberId}", Member.Id);
            Snackbar.Add("Errore durante l'aggiornamento del membro", Severity.Error);
        }
    }
    
    private void Cancel()
    {
        MudDialog.Cancel();
    }
}
