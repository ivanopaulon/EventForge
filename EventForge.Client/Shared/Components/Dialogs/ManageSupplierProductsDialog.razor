@using EventForge.DTOs.Products
@using EventForge.DTOs.Business
@using EventForge.Client.Services
@using MudBlazor
@inject IProductService ProductService
@inject ITranslationService TranslationService
@inject ISnackbar Snackbar
@inject ILogger<ManageSupplierProductsDialog> Logger

<MudDialog>
    <DialogContent>
        @if (_isLoading)
        {
            <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="mb-4" />
        }
        else
        {
            <MudText Typo="Typo.body1" Class="mb-4">
                @TranslationService.GetTranslation("supplier.manageProductsDescription", "Seleziona i prodotti da associare al fornitore. I prodotti gi√† associati sono preselezionati.")
            </MudText>

            <MudPaper Elevation="0" Class="pa-3 mb-3" Style="background-color: var(--mud-palette-background-grey);">
                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                    <MudText Typo="Typo.body2">
                        <strong>@_selectedProducts.Count</strong> / @_products.Count 
                        @TranslationService.GetTranslation("supplier.productsSelected", "prodotti selezionati")
                    </MudText>
                    <MudText Typo="Typo.caption" Class="mud-text-secondary">
                        @TranslationService.GetTranslation("supplier.selectHint", "Seleziona i prodotti da associare al fornitore")
                    </MudText>
                </MudStack>
            </MudPaper>

            <MudTable T="ProductWithAssociationDto"
                      Items="@_filteredProducts"
                      Dense="true"
                      Hover="true"
                      MultiSelection="true"
                      @bind-SelectedItems="_selectedProducts"
                      FixedHeader="true"
                      Height="calc(100vh - 300px)">
                <ToolBarContent>
                    <MudText Typo="Typo.h6">@TranslationService.GetTranslation("supplier.selectProducts", "Seleziona Prodotti")</MudText>
                    <MudSpacer />
                    <MudTextField @bind-Value="_searchTerm"
                                  Placeholder="@TranslationService.GetTranslation("common.search", "Cerca...")"
                                  Adornment="Adornment.Start"
                                  AdornmentIcon="@Icons.Material.Outlined.Search"
                                  IconSize="Size.Medium"
                                  Immediate="true"
                                  Class="mt-0"
                                  Clearable="true" />
                </ToolBarContent>
                <ColGroup>
                    <col style="width: 50px;" />  <!-- Checkbox -->
                    <col style="width: 150px;" /> <!-- Code -->
                    <col />                        <!-- Name -->
                    <col style="width: 300px;" />  <!-- Description -->
                    <col style="width: 120px;" />  <!-- Status -->
                    <col style="width: 120px;" />  <!-- Cost -->
                </ColGroup>
                <HeaderContent>
                    <MudTh>
                        <MudCheckBox T="bool"
                                    Checked="@_selectAll"
                                    CheckedChanged="@OnSelectAllChanged"
                                    Color="Color.Primary" />
                    </MudTh>
                    <MudTh>
                        <MudTableSortLabel SortBy="new Func<ProductWithAssociationDto, object>(x => x.Code ?? string.Empty)">
                            @TranslationService.GetTranslation("product.code", "Codice")
                        </MudTableSortLabel>
                    </MudTh>
                    <MudTh>
                        <MudTableSortLabel SortBy="new Func<ProductWithAssociationDto, object>(x => x.Name)">
                            @TranslationService.GetTranslation("product.name", "Nome")
                        </MudTableSortLabel>
                    </MudTh>
                    <MudTh>@TranslationService.GetTranslation("product.description", "Descrizione")</MudTh>
                    <MudTh>@TranslationService.GetTranslation("common.status", "Stato")</MudTh>
                    <MudTh>
                        <MudTableSortLabel SortBy="new Func<ProductWithAssociationDto, object>(x => x.UnitCost ?? 0)">
                            @TranslationService.GetTranslation("product.cost", "Costo")
                        </MudTableSortLabel>
                    </MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Select">
                        <!-- Checkbox handled by MultiSelection -->
                    </MudTd>
                    <MudTd DataLabel="@TranslationService.GetTranslation("product.code", "Codice")">
                        <MudText Typo="Typo.body2">@context.Code</MudText>
                    </MudTd>
                    <MudTd DataLabel="@TranslationService.GetTranslation("product.name", "Nome")">
                        <MudText Typo="Typo.body2">
                            <strong>@context.Name</strong>
                        </MudText>
                    </MudTd>
                    <MudTd DataLabel="@TranslationService.GetTranslation("product.description", "Descrizione")">
                        <MudText Typo="Typo.caption" Class="mud-text-secondary">
                            @(context.Description ?? "-")
                        </MudText>
                    </MudTd>
                    <MudTd DataLabel="@TranslationService.GetTranslation("common.status", "Stato")">
                        @if (context.IsAssociated)
                        {
                            <MudChip T="string" Size="Size.Small" Color="Color.Success">
                                @TranslationService.GetTranslation("supplier.associated", "Associato")
                            </MudChip>
                        }
                        else
                        {
                            <MudChip T="string" Size="Size.Small" Color="Color.Default">
                                @TranslationService.GetTranslation("supplier.notAssociated", "Non associato")
                            </MudChip>
                        }
                    </MudTd>
                    <MudTd DataLabel="@TranslationService.GetTranslation("product.cost", "Costo")">
                        @if (context.UnitCost.HasValue)
                        {
                            <MudText Typo="Typo.body2">@context.UnitCost.Value.ToString("C2")</MudText>
                        }
                        else
                        {
                            <MudText Typo="Typo.caption" Class="mud-text-secondary">-</MudText>
                        }
                    </MudTd>
                </RowTemplate>
                <NoRecordsContent>
                    <MudText>@TranslationService.GetTranslation("supplier.noProductsFound", "Nessun prodotto trovato")</MudText>
                </NoRecordsContent>
            </MudTable>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel" 
                   Variant="Variant.Text">
            @TranslationService.GetTranslation("common.cancel", "Annulla")
        </MudButton>
        <MudButton OnClick="Save" 
                   Color="Color.Primary" 
                   Variant="Variant.Filled"
                   Disabled="@_isSaving">
            @if (_isSaving)
            {
                <MudProgressCircular Class="mr-2" Size="Size.Small" Indeterminate="true" />
            }
            @TranslationService.GetTranslation("common.save", "Salva")
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] 
    IMudDialogInstance MudDialog { get; set; } = null!;

    [Parameter, EditorRequired]
    public Guid SupplierId { get; set; }

    [Parameter, EditorRequired]
    public string SupplierName { get; set; } = string.Empty;

    private List<ProductWithAssociationDto> _products = new();
    private HashSet<ProductWithAssociationDto> _selectedProducts = new();
    private bool _isLoading = true;
    private bool _isSaving = false;
    private string _searchTerm = string.Empty;
    private bool _selectAll = false;

    private IEnumerable<ProductWithAssociationDto> _filteredProducts =>
        string.IsNullOrWhiteSpace(_searchTerm)
            ? _products
            : _products.Where(p => FilterProduct(p, _searchTerm));

    protected override async Task OnInitializedAsync()
    {
        await LoadProductsAsync();
        InitializeSelection();
    }

    private async Task LoadProductsAsync()
    {
        _isLoading = true;
        try
        {
            var products = await ProductService.GetProductsWithSupplierAssociationAsync(SupplierId);
            if (products != null)
            {
                _products = products.ToList();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading products for supplier {SupplierId}", SupplierId);
            Snackbar.Add(
                TranslationService.GetTranslation("supplier.loadProductsError", "Errore nel caricamento dei prodotti"),
                Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void InitializeSelection()
    {
        // Pre-select already associated products
        _selectedProducts = _products.Where(p => p.IsAssociated).ToHashSet();
        _selectAll = _selectedProducts.Count == _products.Count && _products.Any();
    }

    private bool FilterProduct(ProductWithAssociationDto product, string searchTerm)
    {
        if (string.IsNullOrWhiteSpace(searchTerm))
            return true;

        return product.Name.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
               (product.Code != null && product.Code.Contains(searchTerm, StringComparison.OrdinalIgnoreCase)) ||
               (product.Description != null && product.Description.Contains(searchTerm, StringComparison.OrdinalIgnoreCase));
    }

    private void OnSelectAllChanged(bool value)
    {
        _selectAll = value;
        if (value)
        {
            _selectedProducts.Clear();
            _selectedProducts.UnionWith(_products);
        }
        else
        {
            _selectedProducts.Clear();
        }
    }

    private async Task Save()
    {
        _isSaving = true;
        try
        {
            var selectedProductIds = _selectedProducts
                .Select(p => p.ProductId)
                .ToList();

            var count = await ProductService.BulkUpdateProductSupplierAssociationsAsync(SupplierId, selectedProductIds);

            Snackbar.Add(
                TranslationService.GetTranslation("supplier.productsSaved", "Associazioni salvate con successo"),
                Severity.Success);

            MudDialog.Close(DialogResult.Ok(count));
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error saving product-supplier associations for supplier {SupplierId}", SupplierId);
            Snackbar.Add(
                TranslationService.GetTranslation("supplier.saveError", "Errore nel salvataggio delle associazioni"),
                Severity.Error);
        }
        finally
        {
            _isSaving = false;
        }
    }

    private void Cancel()
    {
        MudDialog.Cancel();
    }
}
