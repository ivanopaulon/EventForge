@using MudBlazor
@using EventForge.DTOs.SuperAdmin
@inject ISuperAdminService SuperAdminService
@inject ISnackbar Snackbar
@inject ITranslationService TranslationService
@inject ILogger<RolePermissionsDialog> Logger

<MudDialog>
    <DialogContent>
        @if (_isLoading)
        {
            <div class="d-flex flex-column align-center justify-center pa-4">
                <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
                <MudText Typo="Typo.body2" Class="mt-4">@TranslationService.GetTranslation("common.loading", "Caricamento...")</MudText>
            </div>
        }
        else
        {
            <MudGrid>
                <MudItem xs="12">
                    <MudAlert Severity="Severity.Info" Dense="true">
                        @TranslationService.GetTranslation("rolePermissions.manageInfo", "Seleziona i permessi da assegnare al ruolo. I permessi sono raggruppati per risorsa.")
                    </MudAlert>
                </MudItem>

                <!-- Search and Filter -->
                <MudItem xs="12">
                    <MudTextField @bind-Value="_searchTerm"
                                 @bind-Value:after="FilterPermissions"
                                 Label="@TranslationService.GetTranslation("rolePermissions.search", "Cerca permessi")"
                                 Placeholder="@TranslationService.GetTranslation("rolePermissions.searchPlaceholder", "Cerca per nome, risorsa o azione...")"
                                 Variant="Variant.Outlined"
                                 Adornment="Adornment.End"
                                 AdornmentIcon="@Icons.Material.Outlined.Search"
                                 Clearable="true" />
                </MudItem>

                <!-- Permission Statistics -->
                <MudItem xs="12">
                    <div class="d-flex gap-2 justify-space-between">
                        <MudChip T="string" Color="Color.Info" Icon="@Icons.Material.Outlined.CheckCircle">
                            @_selectedPermissions.Count / @_allPermissions.Count @TranslationService.GetTranslation("rolePermissions.selected", "selezionati")
                        </MudChip>
                        <div class="d-flex gap-2">
                            <MudButton StartIcon="@Icons.Material.Outlined.CheckBox" 
                                      Color="Color.Success" 
                                      Variant="Variant.Text" 
                                      Size="Size.Small"
                                      OnClick="SelectAll">
                                @TranslationService.GetTranslation("rolePermissions.selectAll", "Seleziona tutti")
                            </MudButton>
                            <MudButton StartIcon="@Icons.Material.Outlined.CheckBoxOutlineBlank" 
                                      Color="Color.Default" 
                                      Variant="Variant.Text" 
                                      Size="Size.Small"
                                      OnClick="DeselectAll">
                                @TranslationService.GetTranslation("rolePermissions.deselectAll", "Deseleziona tutti")
                            </MudButton>
                        </div>
                    </div>
                </MudItem>

                <!-- Grouped Permissions -->
                <MudItem xs="12">
                    <MudPaper Elevation="0" Class="border-solid border-1 mud-border-secondary" Style="max-height: 500px; overflow-y: auto;">
                        @foreach (var group in _filteredGroupedPermissions)
                        {
                            <MudExpansionPanel Class="mb-2">
                                <TitleContent>
                                    <div class="d-flex align-center justify-space-between" style="width: 100%;">
                                        <div class="d-flex align-center gap-2">
                                            <MudIcon Icon="@GetResourceIcon(group.Key)" />
                                            <MudText Typo="Typo.subtitle1">
                                                @(string.IsNullOrEmpty(group.Key) ? 
                                                    TranslationService.GetTranslation("rolePermissions.otherPermissions", "Altri Permessi") : 
                                                    group.Key)
                                            </MudText>
                                            <MudChip T="string" Size="Size.Small" Color="Color.Primary">
                                                @group.Value.Count(p => _selectedPermissions.Contains(p.Id)) / @group.Value.Count
                                            </MudChip>
                                        </div>
                                        <div class="d-flex gap-1" @onclick:stopPropagation="true">
                                            <MudButton StartIcon="@Icons.Material.Outlined.CheckBox" 
                                                      Color="Color.Success" 
                                                      Variant="Variant.Text" 
                                                      Size="Size.Small"
                                                      OnClick="@(() => SelectGroupPermissions(group.Value))">
                                                @TranslationService.GetTranslation("common.all", "Tutti")
                                            </MudButton>
                                            <MudButton StartIcon="@Icons.Material.Outlined.CheckBoxOutlineBlank" 
                                                      Color="Color.Default" 
                                                      Variant="Variant.Text" 
                                                      Size="Size.Small"
                                                      OnClick="@(() => DeselectGroupPermissions(group.Value))">
                                                @TranslationService.GetTranslation("common.none", "Nessuno")
                                            </MudButton>
                                        </div>
                                    </div>
                                </TitleContent>
                                <ChildContent>
                                    <MudList T="string" Dense="true">
                                        @foreach (var permission in group.Value.OrderBy(p => p.Action))
                                        {
                                            <MudListItem T="string">
                                                <div class="d-flex align-center justify-space-between">
                                                    <div class="d-flex align-center gap-2">
                                                        <MudCheckBox T="bool" 
                                                                    Value="@_selectedPermissions.Contains(permission.Id)"
                                                                    ValueChanged="@(value => TogglePermission(permission.Id, value))"
                                                                    Color="Color.Success" />
                                                        <div>
                                                            <MudText Typo="Typo.body2" Style="font-weight: 500;">
                                                                @permission.PermissionName
                                                            </MudText>
                                                            @if (!string.IsNullOrEmpty(permission.Description))
                                                            {
                                                                <MudText Typo="Typo.caption" Class="mud-text-secondary">
                                                                    @permission.Description
                                                                </MudText>
                                                            }
                                                        </div>
                                                    </div>
                                                    @if (!string.IsNullOrEmpty(permission.Action))
                                                    {
                                                        <MudChip T="string" Size="Size.Small" Color="@GetActionColor(permission.Action)">
                                                            @permission.Action
                                                        </MudChip>
                                                    }
                                                </div>
                                            </MudListItem>
                                        }
                                    </MudList>
                                </ChildContent>
                            </MudExpansionPanel>
                        }
                        @if (!_filteredGroupedPermissions.Any())
                        {
                            <div class="text-center pa-4">
                                <MudText Typo="Typo.body2" Class="mud-text-secondary">
                                    @TranslationService.GetTranslation("rolePermissions.noPermissionsFound", "Nessun permesso trovato con i criteri di ricerca")
                                </MudText>
                            </div>
                        }
                    </MudPaper>
                </MudItem>

                <!-- Selected Permissions Preview -->
                @if (_selectedPermissions.Any())
                {
                    <MudItem xs="12">
                        <MudText Typo="Typo.subtitle2" Class="mb-2">
                            <MudIcon Icon="@Icons.Material.Outlined.Preview" Size="Size.Small" Class="mr-1" />
                            @TranslationService.GetTranslation("rolePermissions.selectedPermissions", "Permessi Selezionati")
                        </MudText>
                        <MudPaper Elevation="0" Class="border-solid border-1 mud-border-info pa-2" Style="max-height: 150px; overflow-y: auto;">
                            <div class="d-flex flex-wrap gap-1">
                                @foreach (var permissionId in _selectedPermissions)
                                {
                                    var permission = _allPermissions.FirstOrDefault(p => p.Id == permissionId);
                                    if (permission != null)
                                    {
                                        <MudChip T="string" 
                                                Size="Size.Small" 
                                                Color="Color.Info"
                                                OnClose="@(() => TogglePermission(permissionId, false))"
                                                CloseIcon="@Icons.Material.Outlined.Cancel">
                                            @permission.PermissionName
                                        </MudChip>
                                    }
                                }
                            </div>
                        </MudPaper>
                    </MudItem>
                }
            </MudGrid>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">@TranslationService.GetTranslation("button.cancel", "Annulla")</MudButton>
        <MudButton Color="Color.Primary" 
                   Variant="Variant.Filled"
                   Disabled="@(_isLoading || _isSaving)" 
                   OnClick="Save">
            @if (_isSaving)
            {
                <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                <MudText Class="ms-2">@TranslationService.GetTranslation("common.saving", "Salvataggio...")</MudText>
            }
            else
            {
                @TranslationService.GetTranslation("button.save", "Salva")
            }
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] IMudDialogInstance MudDialog { get; set; } = null!;
    
    [Parameter] public Guid RoleId { get; set; }
    [Parameter] public string RoleName { get; set; } = string.Empty;

    private bool _isLoading = true;
    private bool _isSaving;
    
    private string _searchTerm = string.Empty;
    private List<PermissionDto> _allPermissions = new();
    private HashSet<Guid> _selectedPermissions = new();
    private Dictionary<string, List<PermissionDto>> _groupedPermissions = new();
    private Dictionary<string, List<PermissionDto>> _filteredGroupedPermissions = new();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Load all available permissions
            var allPermissions = await SuperAdminService.GetAllPermissionsAsync();
            _allPermissions = allPermissions.ToList();

            // Group permissions by Resource
            _groupedPermissions = _allPermissions
                .GroupBy(p => p.Resource ?? string.Empty)
                .OrderBy(g => g.Key)
                .ToDictionary(g => g.Key, g => g.ToList());

            _filteredGroupedPermissions = new Dictionary<string, List<PermissionDto>>(_groupedPermissions);

            // Load current role permissions
            var rolePermissions = await SuperAdminService.GetRolePermissionsAsync(RoleId);
            _selectedPermissions = new HashSet<Guid>(rolePermissions.Select(p => p.Id));
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading permissions for role {RoleId}", RoleId);
            Snackbar.Add(TranslationService.GetTranslation("error.loadFailed", "Errore durante il caricamento: {0}", ex.Message), Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void FilterPermissions()
    {
        if (string.IsNullOrWhiteSpace(_searchTerm))
        {
            _filteredGroupedPermissions = new Dictionary<string, List<PermissionDto>>(_groupedPermissions);
        }
        else
        {
            var searchLower = _searchTerm.ToLower();
            _filteredGroupedPermissions = _groupedPermissions
                .Select(g => new
                {
                    Key = g.Key,
                    Value = g.Value.Where(p =>
                        p.PermissionName.Contains(searchLower, StringComparison.OrdinalIgnoreCase) ||
                        (p.Resource != null && p.Resource.Contains(searchLower, StringComparison.OrdinalIgnoreCase)) ||
                        (p.Action != null && p.Action.Contains(searchLower, StringComparison.OrdinalIgnoreCase)) ||
                        (p.Description != null && p.Description.Contains(searchLower, StringComparison.OrdinalIgnoreCase))
                    ).ToList()
                })
                .Where(g => g.Value.Any())
                .ToDictionary(g => g.Key, g => g.Value);
        }
        StateHasChanged();
    }

    private void TogglePermission(Guid permissionId, bool selected)
    {
        if (selected)
        {
            _selectedPermissions.Add(permissionId);
        }
        else
        {
            _selectedPermissions.Remove(permissionId);
        }
        StateHasChanged();
    }

    private void SelectAll()
    {
        foreach (var permission in _allPermissions)
        {
            _selectedPermissions.Add(permission.Id);
        }
        StateHasChanged();
    }

    private void DeselectAll()
    {
        _selectedPermissions.Clear();
        StateHasChanged();
    }

    private void SelectGroupPermissions(List<PermissionDto> permissions)
    {
        foreach (var permission in permissions)
        {
            _selectedPermissions.Add(permission.Id);
        }
        StateHasChanged();
    }

    private void DeselectGroupPermissions(List<PermissionDto> permissions)
    {
        foreach (var permission in permissions)
        {
            _selectedPermissions.Remove(permission.Id);
        }
        StateHasChanged();
    }

    private string GetResourceIcon(string? resource)
    {
        if (string.IsNullOrEmpty(resource))
            return Icons.Material.Outlined.Security;

        return resource.ToLower() switch
        {
            var r when r.Contains("product") => Icons.Material.Outlined.Inventory2,
            var r when r.Contains("warehouse") => Icons.Material.Outlined.Warehouse,
            var r when r.Contains("store") => Icons.Material.Outlined.Store,
            var r when r.Contains("sale") || r.Contains("pos") => Icons.Material.Outlined.PointOfSale,
            var r when r.Contains("user") => Icons.Material.Outlined.People,
            var r when r.Contains("tenant") => Icons.Material.Outlined.Business,
            var r when r.Contains("document") => Icons.Material.Outlined.Description,
            var r when r.Contains("report") => Icons.Material.Outlined.Assessment,
            var r when r.Contains("config") => Icons.Material.Outlined.Settings,
            _ => Icons.Material.Outlined.Security
        };
    }

    private Color GetActionColor(string? action)
    {
        if (string.IsNullOrEmpty(action))
            return Color.Default;

        return action.ToLower() switch
        {
            "create" => Color.Success,
            "read" => Color.Info,
            "update" => Color.Warning,
            "delete" => Color.Error,
            _ => Color.Default
        };
    }

    private void Cancel()
    {
        MudDialog.Cancel();
    }

    private async Task Save()
    {
        try
        {
            _isSaving = true;
            StateHasChanged();

            await SuperAdminService.UpdateRolePermissionsAsync(RoleId, _selectedPermissions.ToList());

            Snackbar.Add(TranslationService.GetTranslation("rolePermissions.saved", "Permessi aggiornati con successo!"), Severity.Success);
            MudDialog.Close(DialogResult.Ok(true));
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to update role permissions for {RoleId}", RoleId);
            Snackbar.Add(TranslationService.GetTranslation("error.saveFailed", "Errore durante il salvataggio: {0}", ex.Message), Severity.Error);
        }
        finally
        {
            _isSaving = false;
            StateHasChanged();
        }
    }
}
