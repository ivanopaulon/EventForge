@using EventForge.DTOs.Documents
@using EventForge.DTOs.Products
@using EventForge.DTOs.UnitOfMeasures
@using EventForge.DTOs.VatRates
@using EventForge.DTOs.Common
@using MudBlazor
@inject IDocumentHeaderService DocumentHeaderService
@inject IProductService ProductService
@inject IFinancialService FinancialService
@inject ISnackbar Snackbar
@inject ITranslationService TranslationService
@inject ILogger<AddDocumentRowDialog> Logger
@inject IJSRuntime JSRuntime

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@(_isEditMode ? Icons.Material.Outlined.Edit : Icons.Material.Outlined.Add)" Class="mr-2" />
            @TranslationService.GetTranslation(_isEditMode ? "documents.editRow" : "documents.addRow", _isEditMode ? "Modifica Riga" : "Aggiungi Riga")
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudStack Spacing="3">
            <!-- Barcode Scanner Section -->
            <MudPaper Elevation="1" Class="pa-3" Style="background-color: var(--mud-palette-background-grey);">
                <MudStack Spacing="2">
                    <MudText Typo="Typo.subtitle2">
                        <MudIcon Icon="@Icons.Material.Outlined.QrCodeScanner" Class="mr-2" Size="Size.Small" />
                        @TranslationService.GetTranslation("warehouse.scanBarcode", "Scansiona Codice a Barre")
                    </MudText>
                    <MudTextField @bind-Value="_barcodeInput"
                                  Label="@TranslationService.GetTranslation("warehouse.barcodeInput", "Codice a Barre")"
                                  Variant="Variant.Outlined"
                                  @onkeydown="@OnBarcodeKeyDown"
                                  @ref="_barcodeField"
                                  Adornment="Adornment.Start"
                                  AdornmentIcon="@Icons.Material.Outlined.QrCode"
                                  HelperText="@TranslationService.GetTranslation("warehouse.scanOrTypeBarcode", "Scansiona o digita il codice a barre e premi Invio")" />
                </MudStack>
            </MudPaper>

            <!-- Product Search/Selection -->
            <MudAutocomplete T="ProductDto"
                             Variant="Variant.Outlined"
                             Label="@TranslationService.GetTranslation("documents.product", "Prodotto")"
                             Value="_selectedProduct"
                             ValueChanged="@OnProductSelected"
                             SearchFunc="@SearchProductsAsync"
                             ToStringFunc="@(p => p?.Name ?? string.Empty)"
                             ShowProgressIndicator="true"
                             Adornment="Adornment.Start"
                             AdornmentIcon="@Icons.Material.Outlined.Inventory">
                <ItemTemplate Context="product">
                    <MudText>@product.Name</MudText>
                    <MudText Typo="Typo.caption">@product.Code</MudText>
                </ItemTemplate>
            </MudAutocomplete>

            <!-- Product Code and Description on same line -->
            <MudGrid Spacing="2">
                <MudItem xs="12" md="4">
                    <MudTextField T="string"
                                  Variant="Variant.Outlined"
                                  Label="@TranslationService.GetTranslation("documents.productCode", "Codice")"
                                  @bind-Value="_model.ProductCode"
                                  Adornment="Adornment.Start"
                                  AdornmentIcon="@Icons.Material.Outlined.Tag" />
                </MudItem>
                <MudItem xs="12" md="8">
                    <MudTextField T="string"
                                  Variant="Variant.Outlined"
                                  Label="@TranslationService.GetTranslation("documents.description", "Descrizione")"
                                  @bind-Value="_model.Description"
                                  Required="true"
                                  Adornment="Adornment.Start"
                                  AdornmentIcon="@Icons.Material.Outlined.Description" />
                </MudItem>
            </MudGrid>

            <MudGrid Spacing="2">
                <MudItem xs="12" md="3">
                    <MudNumericField T="decimal"
                                     Variant="Variant.Outlined"
                                     Label="@TranslationService.GetTranslation("documents.quantity", "Quantità")"
                                     @bind-Value="_model.Quantity"
                                     Min="0.0001m"
                                     Required="true"
                                     @ref="_quantityField"
                                     Adornment="Adornment.Start"
                                     AdornmentIcon="@Icons.Material.Outlined.Numbers" />
                </MudItem>
                <MudItem xs="12" md="3">
                    <MudNumericField T="decimal"
                                     Variant="Variant.Outlined"
                                     Label="@TranslationService.GetTranslation("documents.unitPrice", "Prezzo Unitario")"
                                     @bind-Value="_model.UnitPrice"
                                     Min="0"
                                     Format="N2"
                                     Adornment="Adornment.Start"
                                     AdornmentIcon="@Icons.Material.Outlined.Euro" />
                </MudItem>
                <MudItem xs="12" md="3">
                    <MudSelect T="Guid?"
                               Variant="Variant.Outlined"
                               Label="@TranslationService.GetTranslation("documents.unitOfMeasure", "UM")"
                               Value="_selectedUnitOfMeasureId"
                               ValueChanged="@OnUnitOfMeasureChanged"
                               Disabled="@(_availableUnits.Count == 0)"
                               Adornment="Adornment.Start"
                               AdornmentIcon="@Icons.Material.Outlined.Scale">
                        @foreach (var unit in _availableUnits)
                        {
                            var uom = _allUnitsOfMeasure.FirstOrDefault(u => u.Id == unit.UnitOfMeasureId);
                            if (uom != null)
                            {
                                <MudSelectItem T="Guid?" Value="@uom.Id">@uom.Name (@uom.Symbol)</MudSelectItem>
                            }
                        }
                    </MudSelect>
                </MudItem>
                <MudItem xs="12" md="3">
                    <MudSelect T="Guid?"
                               Variant="Variant.Outlined"
                               Label="@TranslationService.GetTranslation("documents.vatRate", "Aliquota IVA")"
                               Value="_selectedVatRateId"
                               ValueChanged="@OnVatRateChanged"
                               Adornment="Adornment.Start"
                               AdornmentIcon="@Icons.Material.Outlined.Percent">
                        @foreach (var vatRate in _allVatRates)
                        {
                            <MudSelectItem T="Guid?" Value="@vatRate.Id">@vatRate.Name (@vatRate.Percentage%)</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>
            </MudGrid>

            <!-- Recent Transactions / Price Suggestions -->
            @if (_recentTransactions.Any() && _selectedProduct != null)
            {
                <MudPaper Class="pa-3 mt-2" Elevation="0" Style="background-color: var(--mud-palette-background-grey); border-left: 4px solid var(--mud-palette-info);">
                    <MudStack Spacing="2">
                        <MudText Typo="Typo.subtitle2" Color="Color.Info">
                            <MudIcon Icon="@Icons.Material.Outlined.History" Class="mr-2" Size="Size.Small" />
                            @{
                                var isPurchase = !string.IsNullOrEmpty(_documentHeader?.DocumentTypeName) && 
                                    PurchaseKeywords.Any(k => _documentHeader.DocumentTypeName.ToLower().Contains(k));
                            }
                            @if (isPurchase)
                            {
                                @TranslationService.GetTranslation("documents.recentPurchases", "Ultimi Acquisti per questo Prodotto")
                            }
                            else
                            {
                                @TranslationService.GetTranslation("documents.recentSales", "Ultime Vendite per questo Prodotto")
                            }
                        </MudText>
                        <MudDivider />
                        @foreach (var transaction in _recentTransactions)
                        {
                            <MudPaper Class="pa-2" Elevation="1">
                                <MudGrid Spacing="1">
                                    <MudItem xs="12" sm="6">
                                        <MudText Typo="Typo.body2" Style="font-weight: 500;">@transaction.PartyName</MudText>
                                        <MudText Typo="Typo.caption">
                                            @transaction.DocumentNumber - @transaction.DocumentDate.ToString("dd/MM/yyyy")
                                        </MudText>
                                    </MudItem>
                                    <MudItem xs="6" sm="2" Class="d-flex align-center justify-end">
                                        <MudText Typo="Typo.body2">@transaction.Quantity.ToString("N2")</MudText>
                                    </MudItem>
                                    <MudItem xs="6" sm="2" Class="d-flex align-center justify-end">
                                        <MudText Typo="Typo.body2" Color="Color.Success" Style="font-weight: 600;">
                                            @transaction.EffectiveUnitPrice.ToString("C2")
                                        </MudText>
                                    </MudItem>
                                    <MudItem xs="12" sm="2" Class="d-flex align-center justify-end">
                                        <MudButton Size="Size.Small" 
                                                   Variant="Variant.Outlined" 
                                                   Color="Color.Primary"
                                                   OnClick="@(() => ApplySuggestion(transaction))"
                                                   StartIcon="@Icons.Material.Outlined.CheckCircle">
                                            @TranslationService.GetTranslation("documents.applyPrice", "Applica")
                                        </MudButton>
                                    </MudItem>
                                </MudGrid>
                                @if (!string.IsNullOrEmpty(transaction.UnitOfMeasure))
                                {
                                    <MudText Typo="Typo.caption" Color="Color.Default">
                                        @TranslationService.GetTranslation("documents.netPriceAfterDiscount", "Prezzo netto (dopo sconto)") - @transaction.UnitOfMeasure
                                    </MudText>
                                }
                            </MudPaper>
                        }
                    </MudStack>
                </MudPaper>
            }
            else if (_loadingTransactions)
            {
                <MudPaper Class="pa-3 mt-2" Elevation="0">
                    <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
                    <MudText Typo="Typo.caption" Align="Align.Center" Class="mt-2">
                        @TranslationService.GetTranslation("documents.loadingTransactions", "Caricamento suggerimenti prezzo...")
                    </MudText>
                </MudPaper>
            }

            <!-- Discount Section -->
            <MudGrid Spacing="2">
                <MudItem xs="12" md="3">
                    <MudSelect T="DiscountType"
                               Variant="Variant.Outlined"
                               Label="@TranslationService.GetTranslation("documents.discountType", "Tipo Sconto")"
                               @bind-Value="_model.DiscountType"
                               Adornment="Adornment.Start"
                               AdornmentIcon="@Icons.Material.Outlined.LocalOffer">
                        <MudSelectItem T="DiscountType" Value="@DiscountType.Percentage">@TranslationService.GetTranslation("documents.percentage", "Percentuale")</MudSelectItem>
                        <MudSelectItem T="DiscountType" Value="@DiscountType.Value">@TranslationService.GetTranslation("documents.value", "Valore")</MudSelectItem>
                    </MudSelect>
                </MudItem>
                <MudItem xs="12" md="3">
                    @if (_model.DiscountType == DiscountType.Percentage)
                    {
                        <MudNumericField T="decimal"
                                         Variant="Variant.Outlined"
                                         Label="@TranslationService.GetTranslation("documents.discountPercentage", "Sconto %")"
                                         @bind-Value="_model.LineDiscount"
                                         Min="0"
                                         Max="100"
                                         Format="N2"
                                         Adornment="Adornment.End"
                                         AdornmentIcon="@Icons.Material.Outlined.Percent" />
                    }
                    else
                    {
                        <MudNumericField T="decimal"
                                         Variant="Variant.Outlined"
                                         Label="@TranslationService.GetTranslation("documents.discountValue", "Sconto €")"
                                         @bind-Value="_model.LineDiscountValue"
                                         Min="0"
                                         Format="N2"
                                         Adornment="Adornment.Start"
                                         AdornmentIcon="@Icons.Material.Outlined.Euro" />
                    }
                </MudItem>
            </MudGrid>

            <MudTextField T="string"
                          Variant="Variant.Outlined"
                          Label="@TranslationService.GetTranslation("documents.notes", "Note")"
                          @bind-Value="_model.Notes"
                          Lines="2"
                          Adornment="Adornment.Start"
                          AdornmentIcon="@Icons.Material.Outlined.Comment" />

            <!-- Line Total Display -->
            <MudPaper Elevation="2" Class="pa-3" Style="background-color: var(--mud-palette-background-grey);">
                <MudStack Spacing="2">
                    <MudText Typo="Typo.subtitle2" Color="Color.Primary">
                        <MudIcon Icon="@Icons.Material.Outlined.Calculate" Class="mr-2" Size="Size.Small" />
                        @TranslationService.GetTranslation("documents.lineTotal", "Totale Riga")
                    </MudText>
                    <MudDivider />
                    <MudGrid Spacing="1">
                        <MudItem xs="6">
                            <MudText Typo="Typo.body2">@TranslationService.GetTranslation("documents.baseAmount", "Imponibile base"):</MudText>
                        </MudItem>
                        <MudItem xs="6" Style="text-align: right;">
                            <MudText Typo="Typo.body2" Style="font-weight: 600;">@((_model.Quantity * _model.UnitPrice).ToString("N2")) €</MudText>
                        </MudItem>
                        @if (_model.LineDiscount > 0 || _model.LineDiscountValue > 0)
                        {
                            <MudItem xs="6">
                                <MudText Typo="Typo.body2" Color="Color.Success">@TranslationService.GetTranslation("documents.discount", "Sconto"):</MudText>
                            </MudItem>
                            <MudItem xs="6" Style="text-align: right;">
                                <MudText Typo="Typo.body2" Color="Color.Success" Style="font-weight: 600;">- @GetDiscountAmount().ToString("N2") €</MudText>
                            </MudItem>
                        }
                        <MudItem xs="6">
                            <MudText Typo="Typo.body2">@TranslationService.GetTranslation("documents.subtotal", "Subtotale"):</MudText>
                        </MudItem>
                        <MudItem xs="6" Style="text-align: right;">
                            <MudText Typo="Typo.body2" Style="font-weight: 600;">@CalculateSubtotal().ToString("N2") €</MudText>
                        </MudItem>
                        <MudItem xs="6">
                            <MudText Typo="Typo.body2">@TranslationService.GetTranslation("documents.vat", "IVA") (@(_model.VatRate.ToString("0.##"))%):</MudText>
                        </MudItem>
                        <MudItem xs="6" Style="text-align: right;">
                            <MudText Typo="Typo.body2" Style="font-weight: 600;">@CalculateVatAmount().ToString("N2") €</MudText>
                        </MudItem>
                        <MudItem xs="12">
                            <MudDivider />
                        </MudItem>
                        <MudItem xs="6">
                            <MudText Typo="Typo.h6" Color="Color.Primary">@TranslationService.GetTranslation("documents.total", "Totale"):</MudText>
                        </MudItem>
                        <MudItem xs="6" Style="text-align: right;">
                            <MudText Typo="Typo.h6" Color="Color.Primary" Style="font-weight: 600;">@CalculateLineTotal().ToString("N2") €</MudText>
                        </MudItem>
                    </MudGrid>
                </MudStack>
            </MudPaper>

            <!-- Merge Duplicates Option -->
            <MudCheckBox T="bool"
                         @bind-Checked="_model.MergeDuplicateProducts"
                         Label="@TranslationService.GetTranslation("documents.mergeDuplicates", "Somma quantità se l'articolo è già presente")"
                         Color="Color.Primary"
                         Disabled="@(_selectedProduct == null)">
                @if (_selectedProduct == null)
                {
                    <MudTooltip Text="@TranslationService.GetTranslation("documents.mergeDuplicatesRequiresProduct", "Seleziona un prodotto dall'autocomplete per abilitare la fusione")">
                        <MudIcon Icon="@Icons.Material.Outlined.Info" Size="Size.Small" Color="Color.Warning" Class="ml-1" />
                    </MudTooltip>
                }
                else
                {
                    <MudTooltip Text="@TranslationService.GetTranslation("documents.mergeDuplicatesHelp", "Quando abilitato, se aggiungi lo stesso prodotto più volte, la quantità verrà sommata alla riga esistente invece di crearne una nuova")">
                        <MudIcon Icon="@Icons.Material.Outlined.Info" Size="Size.Small" Color="Color.Info" Class="ml-1" />
                    </MudTooltip>
                }
            </MudCheckBox>

            <!-- Quick Tips -->
            <MudAlert Severity="Severity.Info" Dense="true" Variant="Variant.Text">
                <MudText Typo="Typo.caption">
                    <MudIcon Icon="@Icons.Material.Outlined.Keyboard" Size="Size.Small" Class="mr-1" />
                    <strong>Suggerimento:</strong> Dopo aver aggiunto una riga, il form verrà resettato per inserimenti consecutivi
                </MudText>
            </MudAlert>
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel" Variant="Variant.Outlined">
            @TranslationService.GetTranslation("common.close", "Chiudi")
        </MudButton>
        <MudButton Color="Color.Primary" 
                   OnClick="SaveAndContinue" 
                   Disabled="@(!IsValid())"
                   Variant="Variant.Filled"
                   StartIcon="@(_isEditMode ? Icons.Material.Filled.Save : Icons.Material.Filled.Add)">
            @TranslationService.GetTranslation(_isEditMode ? "common.save" : "documents.addAndContinue", _isEditMode ? "Salva" : "Aggiungi e Continua")
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] private IMudDialogInstance MudDialog { get; set; } = null!;
    [Parameter] public Guid DocumentHeaderId { get; set; }
    [Parameter] public Guid? RowId { get; set; }

    private MudTextField<string>? _barcodeField;
    private MudNumericField<decimal>? _quantityField;
    private CreateDocumentRowDto _model = new() { Quantity = 1m };
    private ProductDto? _selectedProduct = null;
    private string _barcodeInput = string.Empty;
    private bool _isProcessing = false;
    private bool _isEditMode => RowId.HasValue;
    private List<ProductUnitDto> _availableUnits = new();
    private List<UMDto> _allUnitsOfMeasure = new();
    private List<VatRateDto> _allVatRates = new();
    private Guid? _selectedUnitOfMeasureId = null;
    private Guid? _selectedVatRateId = null;
    private Guid? _barcodeProductUnitId = null; // Track unit from barcode lookup
    
    // Document type detection keywords
    private static readonly string[] PurchaseKeywords = { "purchase", "receipt", "return", "acquisto", "carico", "reso" };
    private static readonly string[] SaleKeywords = { "sale", "invoice", "shipment", "delivery", "vendita", "fattura", "scarico", "consegna" };
    
    // Recent transactions for price suggestions
    private DocumentHeaderDto? _documentHeader = null;
    private List<RecentProductTransactionDto> _recentTransactions = new();
    private bool _loadingTransactions = false;

    protected override async Task OnInitializedAsync()
    {
        // Load document header to get context (business party, document type)
        try
        {
            _documentHeader = await DocumentHeaderService.GetDocumentHeaderByIdAsync(DocumentHeaderId, includeRows: false);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading document header");
        }

        // Load all units of measure
        try
        {
            var units = await ProductService.GetUnitsOfMeasureAsync();
            _allUnitsOfMeasure = units?.ToList() ?? new List<UMDto>();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading units of measure");
        }

        // Load all VAT rates
        try
        {
            var vatRates = await FinancialService.GetVatRatesAsync();
            _allVatRates = vatRates?.Where(v => v.IsActive).ToList() ?? new List<VatRateDto>();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading VAT rates");
        }

        // If in edit mode, load the existing row
        if (_isEditMode && RowId.HasValue)
        {
            await LoadRowForEdit(RowId.Value);
        }
    }

    protected override void OnParametersSet()
    {
        _model.DocumentHeaderId = DocumentHeaderId;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_isEditMode && _barcodeField != null)
        {
            await _barcodeField.FocusAsync();
        }
    }

    private async Task OnBarcodeKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !string.IsNullOrWhiteSpace(_barcodeInput))
        {
            await SearchByBarcode(_barcodeInput);
        }
    }

    private async Task SearchByBarcode(string barcode)
    {
        if (string.IsNullOrWhiteSpace(barcode))
            return;

        try
        {
            // Use new API that returns ProductWithCodeDto
            var productWithCode = await ProductService.GetProductWithCodeByCodeAsync(barcode);
            if (productWithCode?.Product != null)
            {
                // Store the ProductUnitId from the barcode if available
                _barcodeProductUnitId = productWithCode.Code?.ProductUnitId;
                
                OnProductSelected(productWithCode.Product);
                Snackbar.Add(TranslationService.GetTranslation("warehouse.productFound", "Prodotto trovato: {0}", productWithCode.Product.Name), Severity.Success);
                
                // Focus on quantity field after product is found
                if (_quantityField != null)
                {
                    await Task.Delay(100);
                    await _quantityField.FocusAsync();
                }
            }
            else
            {
                Snackbar.Add(TranslationService.GetTranslation("warehouse.productNotFound", "Prodotto non trovato per il codice: {0}", barcode), Severity.Warning);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error searching product by barcode {Barcode}", barcode);
            Snackbar.Add(TranslationService.GetTranslation("warehouse.searchError", "Errore nella ricerca"), Severity.Error);
        }
    }

    private async Task OnProductSelected(ProductDto? product)
    {
        _selectedProduct = product;
        if (product != null)
        {
            await PopulateFromProduct(product);
            
            // Load recent transactions for price suggestions
            await LoadRecentTransactions(product.Id);
            
            StateHasChanged();
        }
    }

    private async Task<IEnumerable<ProductDto>> SearchProductsAsync(string searchTerm, CancellationToken cancellationToken)
    {
        if (string.IsNullOrWhiteSpace(searchTerm))
            return Array.Empty<ProductDto>();

        try
        {
            // Use GetProductsAsync and filter locally for simplicity
            var result = await ProductService.GetProductsAsync(1, 50);
            return result?.Items.Where(p => 
                (p.Name?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false) ||
                (p.Code?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false)
            ) ?? Array.Empty<ProductDto>();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error searching products");
            return Array.Empty<ProductDto>();
        }
    }

    private async Task PopulateFromProduct(ProductDto product)
    {
        _model.ProductId = product.Id;
        _model.ProductCode = product.Code;
        _model.Description = product.Name;
        _model.UnitPrice = product.DefaultPrice ?? 0;

        // Load VAT rate from product if available
        if (product.VatRateId.HasValue)
        {
            _selectedVatRateId = product.VatRateId;
            var vatRate = _allVatRates.FirstOrDefault(v => v.Id == product.VatRateId.Value);
            if (vatRate != null)
            {
                _model.VatRate = vatRate.Percentage;
                _model.VatDescription = vatRate.Name;
            }
        }

        // Load units of measure for this product
        try
        {
            var units = await ProductService.GetProductUnitsAsync(product.Id);
            _availableUnits = units?.ToList() ?? new List<ProductUnitDto>();

            if (_availableUnits.Any())
            {
                // If barcode lookup provided a ProductUnitId, try to use it
                if (_barcodeProductUnitId.HasValue)
                {
                    // Find the unit with the ProductUnitId from the barcode
                    var barcodeUnit = _availableUnits.FirstOrDefault(u => u.Id == _barcodeProductUnitId.Value);
                    if (barcodeUnit != null)
                    {
                        _selectedUnitOfMeasureId = barcodeUnit.UnitOfMeasureId;
                        UpdateModelUnitOfMeasure(_selectedUnitOfMeasureId);
                        
                        // Clear the barcode unit after using it
                        _barcodeProductUnitId = null;
                    }
                    else
                    {
                        // Barcode specified a unit, but it's not in the available units
                        // Fall back to default selection
                        SelectDefaultUnit();
                    }
                }
                else
                {
                    // No barcode unit - use default selection
                    SelectDefaultUnit();
                }
            }
            else
            {
                // If no units configured for product, use product's default unit if available
                if (product.UnitOfMeasureId.HasValue)
                {
                    // Create a temporary ProductUnit entry so the dropdown works
                    _availableUnits.Add(new ProductUnitDto
                    {
                        Id = Guid.NewGuid(),
                        ProductId = product.Id,
                        UnitOfMeasureId = product.UnitOfMeasureId.Value,
                        ConversionFactor = 1,
                        UnitType = "Base",
                        Status = EventForge.DTOs.Common.ProductUnitStatus.Active
                    });

                    _selectedUnitOfMeasureId = product.UnitOfMeasureId;
                    UpdateModelUnitOfMeasure(_selectedUnitOfMeasureId);
                }
                else
                {
                    // No units configured - show warning
                    Snackbar.Add(TranslationService.GetTranslation("documents.noUnitsConfigured", "Nessuna unità di misura configurata per questo prodotto"), Severity.Warning);
                    _selectedUnitOfMeasureId = null;
                    _model.UnitOfMeasure = null;
                    _model.UnitOfMeasureId = null;
                }
            }

            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading product units for product {ProductId}", product.Id);
            Snackbar.Add(TranslationService.GetTranslation("documents.errorLoadingUnits", "Errore nel caricamento delle unità di misura"), Severity.Error);
        }
    }

    private void SelectDefaultUnit()
    {
        // Find the default unit or use the first one
        var defaultUnit = _availableUnits.FirstOrDefault(u => u.UnitType == "Base");
        if (defaultUnit != null)
        {
            _selectedUnitOfMeasureId = defaultUnit.UnitOfMeasureId;
        }
        else
        {
            _selectedUnitOfMeasureId = _availableUnits.First().UnitOfMeasureId;
        }

        // Set the unit of measure name
        UpdateModelUnitOfMeasure(_selectedUnitOfMeasureId);
    }

    private void OnUnitOfMeasureChanged(Guid? unitOfMeasureId)
    {
        _selectedUnitOfMeasureId = unitOfMeasureId;
        UpdateModelUnitOfMeasure(unitOfMeasureId);
    }

    private void OnVatRateChanged(Guid? vatRateId)
    {
        _selectedVatRateId = vatRateId;
        if (vatRateId.HasValue)
        {
            var vatRate = _allVatRates.FirstOrDefault(v => v.Id == vatRateId.Value);
            if (vatRate != null)
            {
                _model.VatRate = vatRate.Percentage;
                _model.VatDescription = vatRate.Name;
            }
        }
        else
        {
            _model.VatRate = 0;
            _model.VatDescription = null;
        }
        StateHasChanged();
    }

    private decimal GetDiscountAmount()
    {
        var baseAmount = _model.Quantity * _model.UnitPrice;
        var discount = _model.DiscountType == DiscountType.Percentage
            ? baseAmount * (_model.LineDiscount / 100m)
            : _model.LineDiscountValue;
        
        // Ensure discount doesn't exceed base amount
        return Math.Min(discount, baseAmount);
    }

    private decimal CalculateSubtotal()
    {
        var baseAmount = _model.Quantity * _model.UnitPrice;
        return baseAmount - GetDiscountAmount();
    }

    private decimal CalculateVatAmount()
    {
        var subtotal = CalculateSubtotal();
        return subtotal * (_model.VatRate / 100m);
    }

    private decimal CalculateLineTotal()
    {
        var subtotal = CalculateSubtotal();
        var vatAmount = subtotal * (_model.VatRate / 100m);
        return subtotal + vatAmount;
    }

    private void UpdateModelUnitOfMeasure(Guid? unitOfMeasureId)
    {
        if (unitOfMeasureId.HasValue)
        {
            var selectedUom = _allUnitsOfMeasure.FirstOrDefault(u => u.Id == unitOfMeasureId);
            if (selectedUom != null)
            {
                _model.UnitOfMeasure = selectedUom.Symbol;
                _model.UnitOfMeasureId = selectedUom.Id;
            }
        }
        else
        {
            // Clear unit of measure fields when null
            _model.UnitOfMeasure = null;
            _model.UnitOfMeasureId = null;
        }
    }

    private async Task LoadRowForEdit(Guid rowId)
    {
        try
        {
            // Load the document to get the row data
            var document = await DocumentHeaderService.GetDocumentHeaderByIdAsync(DocumentHeaderId, includeRows: true);
            var row = document?.Rows?.FirstOrDefault(r => r.Id == rowId);

            if (row != null)
            {
                _model.ProductCode = row.ProductCode;
                _model.Description = row.Description;
                _model.Quantity = row.Quantity;
                _model.UnitPrice = row.UnitPrice;
                _model.UnitOfMeasure = row.UnitOfMeasure;
                _model.UnitOfMeasureId = row.UnitOfMeasureId;
                _model.Notes = row.Notes;
                _model.VatRate = row.VatRate;
                _model.VatDescription = row.VatDescription;
                _selectedUnitOfMeasureId = row.UnitOfMeasureId;

                // Try to find the VAT rate based on percentage and description
                if (_model.VatRate > 0 || !string.IsNullOrEmpty(_model.VatDescription))
                {
                    var vatRate = _allVatRates.FirstOrDefault(v => 
                        v.Percentage == _model.VatRate && 
                        (string.IsNullOrEmpty(_model.VatDescription) || v.Name == _model.VatDescription));
                    if (vatRate != null)
                    {
                        _selectedVatRateId = vatRate.Id;
                    }
                }

                // Load the product if available
                if (row.ProductId.HasValue)
                {
                    var product = await ProductService.GetProductByIdAsync(row.ProductId.Value);
                    if (product != null)
                    {
                        _selectedProduct = product;
                        // Load product units
                        var units = await ProductService.GetProductUnitsAsync(product.Id);
                        _availableUnits = units?.ToList() ?? new List<ProductUnitDto>();
                    }
                }

                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading row {RowId} for edit", rowId);
            Snackbar.Add(TranslationService.GetTranslation("documents.errorLoadingRow", "Errore nel caricamento della riga"), Severity.Error);
        }
    }

    private bool IsValid()
    {
        return !string.IsNullOrWhiteSpace(_model.Description) && _model.Quantity > 0;
    }

    private async Task SaveAndContinue()
    {
        if (_isProcessing)
            return;

        _isProcessing = true;
        try
        {
            // Ensure unit of measure is set before saving
            if (_selectedUnitOfMeasureId.HasValue && _model.UnitOfMeasureId != _selectedUnitOfMeasureId)
            {
                UpdateModelUnitOfMeasure(_selectedUnitOfMeasureId);
            }

            if (_isEditMode && RowId.HasValue)
            {
                // Update existing row
                var updateDto = new UpdateDocumentRowDto
                {
                    ProductCode = _model.ProductCode,
                    Description = _model.Description,
                    UnitOfMeasure = _model.UnitOfMeasure,
                    UnitOfMeasureId = _model.UnitOfMeasureId,
                    UnitPrice = _model.UnitPrice,
                    Quantity = _model.Quantity,
                    Notes = _model.Notes,
                    RowType = _model.RowType,
                    LineDiscount = _model.LineDiscount,
                    LineDiscountValue = _model.LineDiscountValue,
                    DiscountType = _model.DiscountType,
                    VatRate = _model.VatRate,
                    VatDescription = _model.VatDescription,
                    IsGift = _model.IsGift,
                    IsManual = _model.IsManual,
                    SourceWarehouseId = _model.SourceWarehouseId,
                    DestinationWarehouseId = _model.DestinationWarehouseId,
                    SortOrder = _model.SortOrder,
                    StationId = _model.StationId,
                    ParentRowId = _model.ParentRowId
                };

                var result = await DocumentHeaderService.UpdateDocumentRowAsync(RowId.Value, updateDto);
                if (result != null)
                {
                    Snackbar.Add(TranslationService.GetTranslation("documents.rowUpdatedSuccess", "Riga aggiornata con successo"), Severity.Success);
                    MudDialog.Close(DialogResult.Ok(result));
                }
                else
                {
                    Snackbar.Add(TranslationService.GetTranslation("documents.rowUpdatedError", "Errore durante l'aggiornamento della riga"), Severity.Error);
                }
            }
            else
            {
                // Create new row
                var result = await DocumentHeaderService.AddDocumentRowAsync(_model);
                if (result != null)
                {
                    Snackbar.Add(TranslationService.GetTranslation("documents.rowAddedSuccess", "Riga aggiunta con successo"), Severity.Success);
                    
                    // Reset the form for next entry instead of closing
                    ResetForm();
                    
                    // Focus back to barcode field for next scan
                    if (_barcodeField != null)
                    {
                        await Task.Delay(100);
                        await _barcodeField.FocusAsync();
                    }
                }
                else
                {
                    Snackbar.Add(TranslationService.GetTranslation("documents.rowAddedError", "Errore durante l'aggiunta della riga"), Severity.Error);
                }
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error saving document row");
            var errorKey = _isEditMode ? "documents.rowUpdatedError" : "documents.rowAddedError";
            var errorMessage = _isEditMode ? "Errore durante l'aggiornamento della riga" : "Errore durante l'aggiunta della riga";
            Snackbar.Add(TranslationService.GetTranslation(errorKey, errorMessage), Severity.Error);
        }
        finally
        {
            _isProcessing = false;
        }
    }

    private void ResetForm()
    {
        // Preserve the merge duplicates preference across form resets
        var preserveMergeDuplicates = _model.MergeDuplicateProducts;
        
        _model = new CreateDocumentRowDto 
        { 
            DocumentHeaderId = DocumentHeaderId,
            Quantity = 1,
            MergeDuplicateProducts = preserveMergeDuplicates
        };
        _selectedProduct = null;
        _barcodeInput = string.Empty;
        StateHasChanged();
    }

    private void Cancel()
    {
        MudDialog.Cancel();
    }

    private async Task LoadRecentTransactions(Guid productId)
    {
        if (_documentHeader == null)
        {
            return;
        }

        _loadingTransactions = true;
        _recentTransactions.Clear();
        
        try
        {
            // Determine transaction type based on document type name keywords
            // Determine transaction type based on document type name keywords
            string transactionType = "purchase"; // default
            
            if (!string.IsNullOrEmpty(_documentHeader.DocumentTypeName))
            {
                var lowerName = _documentHeader.DocumentTypeName.ToLower();
                
                if (SaleKeywords.Any(k => lowerName.Contains(k)))
                {
                    transactionType = "sale";
                }
                else if (PurchaseKeywords.Any(k => lowerName.Contains(k)))
                {
                    transactionType = "purchase";
                }
            }
            
            // Optionally filter by business party if available
            Guid? partyId = _documentHeader.BusinessPartyId != Guid.Empty ? _documentHeader.BusinessPartyId : null;
            
            var transactions = await ProductService.GetRecentProductTransactionsAsync(
                productId,
                transactionType,
                partyId,
                top: 3
            );
            
            if (transactions != null)
            {
                _recentTransactions = transactions.ToList();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading recent transactions for product {ProductId}", productId);
        }
        finally
        {
            _loadingTransactions = false;
        }
    }

    private void ApplySuggestion(RecentProductTransactionDto suggestion)
    {
        try
        {
            // Apply the effective unit price
            _model.UnitPrice = suggestion.EffectiveUnitPrice;
            
            // If base unit price is available, apply it
            if (suggestion.BaseUnitPrice.HasValue)
            {
                _model.BaseUnitPrice = suggestion.BaseUnitPrice.Value;
            }
            
            // Clear discount fields since the suggested price is already net
            _model.LineDiscount = 0;
            _model.LineDiscountValue = 0;
            _model.DiscountType = EventForge.DTOs.Common.DiscountType.Percentage;
            
            Snackbar.Add(
                TranslationService.GetTranslation("documents.priceApplied", "Prezzo applicato: {0:C2}", suggestion.EffectiveUnitPrice),
                Severity.Success
            );
            
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error applying price suggestion");
            Snackbar.Add(
                TranslationService.GetTranslation("documents.priceApplyError", "Errore nell'applicazione del prezzo"),
                Severity.Error
            );
        }
    }
}
