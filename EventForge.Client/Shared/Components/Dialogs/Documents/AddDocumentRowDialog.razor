@using EventForge.DTOs.Documents
@using EventForge.DTOs.Products
@using EventForge.DTOs.UnitOfMeasures
@using EventForge.DTOs.VatRates
@using EventForge.DTOs.Common
@using MudBlazor
@inject IDocumentHeaderService DocumentHeaderService
@inject IProductService ProductService
@inject IFinancialService FinancialService
@inject ISnackbar Snackbar
@inject ITranslationService TranslationService
@inject ILogger<AddDocumentRowDialog> Logger
@inject IJSRuntime JSRuntime
@inject IDialogService DialogService

<MudDialog MaxWidth="MaxWidth.Large" FullWidth="true">
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@(_isEditMode ? Icons.Material.Outlined.Edit : Icons.Material.Outlined.Add)" Class="mr-2" />
            @TranslationService.GetTranslation(_isEditMode ? "documents.editRow" : "documents.addRow", _isEditMode ? "Modifica Riga" : "Aggiungi Riga")
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudStack Spacing="3">
            
            <!-- 1. BARCODE SCANNER (Full Width) -->
            <MudPaper Elevation="1" Class="pa-3" Style="background-color: var(--mud-palette-background-grey);">
                <MudStack Spacing="2">
                    <MudText Typo="Typo.subtitle2">
                        <MudIcon Icon="@Icons.Material.Outlined.QrCodeScanner" Class="mr-2" Size="Size.Small" />
                        @TranslationService.GetTranslation("warehouse.scanBarcode", "Scansiona Codice a Barre")
                    </MudText>
                    <MudTextField @bind-Value="_barcodeInput"
                                  Label="@TranslationService.GetTranslation("warehouse.barcodeInput", "Codice a Barre")"
                                  Variant="Variant.Outlined"
                                  @onkeydown="@OnBarcodeKeyDown"
                                  @ref="_barcodeField"
                                  Adornment="Adornment.Start"
                                  AdornmentIcon="@Icons.Material.Outlined.QrCode"
                                  HelperText="@TranslationService.GetTranslation("warehouse.scanOrTypeBarcode", "Scansiona o digita il codice a barre e premi Invio")" />
                </MudStack>
            </MudPaper>
            
            <!-- 2. PRODOTTO + QUANTITÃ€ (2 colonne) -->
            <MudGrid Spacing="3">
                <!-- Colonna Sinistra: Prodotto -->
                <MudItem xs="12" md="6">
                    <MudPaper Elevation="2" Class="pa-3" Style="height: 100%;">
                        <MudText Typo="Typo.subtitle1" Class="mb-3" Style="font-weight: 600;">
                            <MudIcon Icon="@Icons.Material.Outlined.Inventory" Class="mr-2" Size="Size.Small" />
                            @TranslationService.GetTranslation("documents.productSection", "Prodotto")
                        </MudText>
                        
                        <MudStack Spacing="2">
                            <MudAutocomplete T="ProductDto"
                                            Variant="Variant.Outlined"
                                            Label="@TranslationService.GetTranslation("documents.product", "Prodotto")"
                                            Value="_selectedProduct"
                                            ValueChanged="@OnProductSelected"
                                            SearchFunc="@SearchProductsAsync"
                                            ToStringFunc="@(p => p?.Name ?? string.Empty)"
                                            ShowProgressIndicator="true"
                                            Dense="true"
                                            Adornment="Adornment.Start"
                                            AdornmentIcon="@Icons.Material.Outlined.Inventory">
                                <ItemTemplate Context="product">
                                    <MudText>@product.Name</MudText>
                                    <MudText Typo="Typo.caption">@product.Code</MudText>
                                </ItemTemplate>
                            </MudAutocomplete>
                            
                            <MudTextField T="string"
                                         Label="@TranslationService.GetTranslation("documents.description", "Descrizione")"
                                         @bind-Value="_model.Description"
                                         Variant="Variant.Outlined"
                                         Lines="2"
                                         Dense="true"
                                         Required="true"
                                         Adornment="Adornment.Start"
                                         AdornmentIcon="@Icons.Material.Outlined.Description" />
                            
                            <MudCheckBox T="bool"
                                        @bind-Checked="_model.MergeDuplicateProducts"
                                        Label="@TranslationService.GetTranslation("documents.mergeDuplicates", "Somma quantitÃ  se giÃ  presente")"
                                        Color="Color.Primary"
                                        Dense="true"
                                        Disabled="@(_selectedProduct == null)">
                                @if (_selectedProduct == null)
                                {
                                    <MudTooltip Text="@TranslationService.GetTranslation("documents.mergeDuplicatesRequiresProduct", "Seleziona un prodotto dall'autocomplete per abilitare la fusione")">
                                        <MudIcon Icon="@Icons.Material.Outlined.Info" Size="Size.Small" Color="Color.Warning" Class="ml-1" />
                                    </MudTooltip>
                                }
                                else
                                {
                                    <MudTooltip Text="@TranslationService.GetTranslation("documents.mergeDuplicatesHelp", "Quando abilitato, se aggiungi lo stesso prodotto piÃ¹ volte, la quantitÃ  verrÃ  sommata alla riga esistente invece di crearne una nuova")">
                                        <MudIcon Icon="@Icons.Material.Outlined.Info" Size="Size.Small" Color="Color.Info" Class="ml-1" />
                                    </MudTooltip>
                                }
                            </MudCheckBox>
                        </MudStack>
                    </MudPaper>
                </MudItem>
                
                <!-- Colonna Destra: QuantitÃ  e UM -->
                <MudItem xs="12" md="6">
                    <MudPaper Elevation="2" Class="pa-3" Style="height: 100%;">
                        <MudText Typo="Typo.subtitle1" Class="mb-3" Style="font-weight: 600;">
                            <MudIcon Icon="@Icons.Material.Outlined.Straighten" Class="mr-2" Size="Size.Small" />
                            @TranslationService.GetTranslation("documents.quantityAndUnit", "QuantitÃ  e UnitÃ ")
                        </MudText>
                        
                        <MudStack Spacing="2">
                            <MudNumericField T="decimal"
                                            Label="@TranslationService.GetTranslation("documents.quantity", "QuantitÃ ")"
                                            @bind-Value="_model.Quantity"
                                            Min="0.0001m"
                                            Variant="Variant.Outlined"
                                            Dense="true"
                                            @ref="_quantityField"
                                            Adornment="Adornment.Start"
                                            AdornmentIcon="@Icons.Material.Outlined.Numbers" />
                            
                            <MudSelect T="Guid?"
                                      Label="@TranslationService.GetTranslation("documents.unitOfMeasure", "UnitÃ  di Misura")"
                                      Value="_selectedUnitOfMeasureId"
                                      ValueChanged="@OnUnitOfMeasureChanged"
                                      Variant="Variant.Outlined"
                                      Dense="true"
                                      Disabled="@(_availableUnits.Count == 0)"
                                      Adornment="Adornment.Start"
                                      AdornmentIcon="@Icons.Material.Outlined.Scale">
                                @foreach (var unit in _availableUnits)
                                {
                                    var uom = _allUnitsOfMeasure.FirstOrDefault(u => u.Id == unit.UnitOfMeasureId);
                                    if (uom != null)
                                    {
                                        <MudSelectItem T="Guid?" Value="@uom.Id">@uom.Name (@uom.Symbol)</MudSelectItem>
                                    }
                                }
                            </MudSelect>
                        </MudStack>
                    </MudPaper>
                </MudItem>
            </MudGrid>
            
            <!-- 3. PREZZI + IVA + SCONTI (3 colonne) -->
            <MudGrid Spacing="3">
                <!-- Colonna 1: Prezzi Netto/Lordo -->
                <MudItem xs="12" md="4">
                    <MudPaper Elevation="2" Class="pa-3" Style="height: 100%;">
                        <MudText Typo="Typo.subtitle1" Class="mb-3" Style="font-weight: 600;">
                            <MudIcon Icon="@Icons.Material.Outlined.AttachMoney" Class="mr-2" Size="Size.Small" />
                            @TranslationService.GetTranslation("documents.netPrice", "Prezzo Netto")
                        </MudText>
                        
                        <MudStack Spacing="2">
                            <MudNumericField T="decimal"
                                            Label="@TranslationService.GetTranslation("documents.unitPrice", "Prezzo Unitario Netto")"
                                            @bind-Value="_model.UnitPrice"
                                            Min="0"
                                            Format="N2"
                                            Variant="Variant.Outlined"
                                            Dense="true"
                                            Adornment="Adornment.Start"
                                            AdornmentIcon="@Icons.Material.Outlined.Euro" />
                            
                            <MudTextField T="string"
                                         Label="@TranslationService.GetTranslation("documents.unitPriceGross", "Prezzo Unit. Lordo")"
                                         Value="@GetUnitPriceGross().ToString("C2")"
                                         ReadOnly="true"
                                         Variant="Variant.Filled"
                                         Dense="true"
                                         Adornment="Adornment.Start"
                                         AdornmentIcon="@Icons.Material.Outlined.Calculate"
                                         HelperText="@TranslationService.GetTranslation("documents.autoCalculated", "Calcolato automaticamente")" />
                        </MudStack>
                    </MudPaper>
                </MudItem>
                
                <!-- Colonna 2: IVA -->
                <MudItem xs="12" md="4">
                    <MudPaper Elevation="2" Class="pa-3" Style="height: 100%;">
                        <MudText Typo="Typo.subtitle1" Class="mb-3" Style="font-weight: 600;">
                            <MudIcon Icon="@Icons.Material.Outlined.Receipt" Class="mr-2" Size="Size.Small" />
                            @TranslationService.GetTranslation("documents.vat", "IVA")
                        </MudText>
                        
                        <MudStack Spacing="2">
                            <MudSelect T="Guid?"
                                      Label="@TranslationService.GetTranslation("documents.vatRate", "Aliquota IVA %")"
                                      Value="_selectedVatRateId"
                                      ValueChanged="@OnVatRateChanged"
                                      Variant="Variant.Outlined"
                                      Dense="true"
                                      Adornment="Adornment.Start"
                                      AdornmentIcon="@Icons.Material.Outlined.Percent">
                                @foreach (var vatRate in _allVatRates)
                                {
                                    <MudSelectItem T="Guid?" Value="@vatRate.Id">@vatRate.Name (@vatRate.Percentage%)</MudSelectItem>
                                }
                            </MudSelect>
                            
                            <MudTextField T="string"
                                         Label="@TranslationService.GetTranslation("documents.vatAmount", "Importo IVA")"
                                         Value="@GetVatAmount().ToString("C2")"
                                         ReadOnly="true"
                                         Variant="Variant.Filled"
                                         Dense="true"
                                         Adornment="Adornment.Start"
                                         AdornmentIcon="@Icons.Material.Outlined.Calculate" />
                        </MudStack>
                    </MudPaper>
                </MudItem>
                
                <!-- Colonna 3: Sconti -->
                <MudItem xs="12" md="4">
                    <MudPaper Elevation="2" Class="pa-3" Style="height: 100%;">
                        <MudText Typo="Typo.subtitle1" Class="mb-3" Style="font-weight: 600;">
                            <MudIcon Icon="@Icons.Material.Outlined.Discount" Class="mr-2" Size="Size.Small" />
                            @TranslationService.GetTranslation("documents.discounts", "Sconti")
                        </MudText>
                        
                        <MudStack Spacing="2">
                            <MudNumericField T="decimal"
                                            Label="@TranslationService.GetTranslation("documents.lineDiscount", "Sconto %")"
                                            @bind-Value="_model.LineDiscount"
                                            Min="0"
                                            Max="100"
                                            Format="N2"
                                            Variant="Variant.Outlined"
                                            Dense="true"
                                            Adornment="Adornment.End"
                                            AdornmentIcon="@Icons.Material.Outlined.Percent" />
                            
                            <MudNumericField T="decimal"
                                            Label="@TranslationService.GetTranslation("documents.lineDiscountValue", "Sconto â‚¬")"
                                            @bind-Value="_model.LineDiscountValue"
                                            Min="0"
                                            Format="N2"
                                            Variant="Variant.Outlined"
                                            Dense="true"
                                            Adornment="Adornment.Start"
                                            AdornmentIcon="@Icons.Material.Outlined.Euro" />
                        </MudStack>
                    </MudPaper>
                </MudItem>
            </MudGrid>
            
            <!-- 4. NOTE (Full Width) -->
            <MudTextField T="string"
                         Label="@TranslationService.GetTranslation("documents.notes", "Note (opzionali)")"
                         @bind-Value="_model.Notes"
                         Lines="2"
                         Variant="Variant.Outlined"
                         Adornment="Adornment.Start"
                         AdornmentIcon="@Icons.Material.Outlined.Comment" />
            
            <!-- 5. RIEPILOGO RIGA (Full Width, evidenziato) -->
            <MudPaper Elevation="3" Class="pa-4" 
                     Style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <MudText Typo="Typo.subtitle1" Class="mb-3" Style="font-weight: 600;">
                    <MudIcon Icon="@Icons.Material.Outlined.Summarize" Class="mr-2" Size="Size.Small" />
                    @TranslationService.GetTranslation("documents.rowSummary", "Riepilogo Riga")
                </MudText>
                <MudGrid Spacing="2">
                    <MudItem xs="6" sm="3">
                        <MudText Typo="Typo.caption">
                            @TranslationService.GetTranslation("documents.netSubtotal", "Subtotale Netto")
                        </MudText>
                        <MudText Typo="Typo.h6" Style="font-weight: 600;">
                            @GetSubtotal().ToString("C2")
                        </MudText>
                    </MudItem>
                    <MudItem xs="6" sm="3">
                        <MudText Typo="Typo.caption">
                            @TranslationService.GetTranslation("documents.vatTax", "Imposta IVA")
                        </MudText>
                        <MudText Typo="Typo.h6" Style="font-weight: 600;">
                            @GetVatAmount().ToString("C2")
                        </MudText>
                    </MudItem>
                    <MudItem xs="6" sm="3">
                        <MudText Typo="Typo.caption">
                            @TranslationService.GetTranslation("documents.totalDiscount", "Sconto Totale")
                        </MudText>
                        <MudText Typo="Typo.h6" Style="font-weight: 600; color: #90EE90;">
                            -@GetTotalDiscount().ToString("C2")
                        </MudText>
                    </MudItem>
                    <MudItem xs="6" sm="3">
                        <MudText Typo="Typo.caption">
                            ðŸ’Ž @TranslationService.GetTranslation("documents.lineTotal", "TOTALE RIGA")
                        </MudText>
                        <MudText Typo="Typo.h5" Style="font-weight: 700;">
                            @GetLineTotal().ToString("C2")
                        </MudText>
                    </MudItem>
                </MudGrid>
            </MudPaper>
            
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel" Variant="Variant.Outlined">
            @TranslationService.GetTranslation("common.close", "Chiudi")
        </MudButton>
        <MudButton Color="Color.Primary" 
                   OnClick="SaveAndContinue" 
                   Disabled="@(!IsValid())"
                   Variant="Variant.Filled"
                   StartIcon="@(_isEditMode ? Icons.Material.Filled.Save : Icons.Material.Filled.Add)">
            @TranslationService.GetTranslation(_isEditMode ? "common.save" : "documents.addAndContinue", _isEditMode ? "Salva" : "Aggiungi e Continua")
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] private IMudDialogInstance MudDialog { get; set; } = null!;
    [Parameter] public Guid DocumentHeaderId { get; set; }
    [Parameter] public Guid? RowId { get; set; }

    private MudTextField<string>? _barcodeField;
    private MudNumericField<decimal>? _quantityField;
    private CreateDocumentRowDto _model = new() { Quantity = 1m };
    private ProductDto? _selectedProduct = null;
    private string _barcodeInput = string.Empty;
    private bool _isProcessing = false;
    private bool _isEditMode => RowId.HasValue;
    private List<ProductUnitDto> _availableUnits = new();
    private List<UMDto> _allUnitsOfMeasure = new();
    private List<VatRateDto> _allVatRates = new();
    private Guid? _selectedUnitOfMeasureId = null;
    private Guid? _selectedVatRateId = null;
    private Guid? _barcodeProductUnitId = null; // Track unit from barcode lookup
    
    // Quick insert state variables
    private string _scannedBarcode = string.Empty;
    private bool _isProcessingBarcode = false;
    
    // Document type detection keywords
    private static readonly string[] PurchaseKeywords = { "purchase", "receipt", "return", "acquisto", "carico", "reso" };
    private static readonly string[] SaleKeywords = { "sale", "invoice", "shipment", "delivery", "vendita", "fattura", "scarico", "consegna" };
    
    // Recent transactions for price suggestions
    private DocumentHeaderDto? _documentHeader = null;
    private List<RecentProductTransactionDto> _recentTransactions = new();
    private bool _loadingTransactions = false;

    protected override async Task OnInitializedAsync()
    {
        // Load document header to get context (business party, document type)
        try
        {
            _documentHeader = await DocumentHeaderService.GetDocumentHeaderByIdAsync(DocumentHeaderId, includeRows: false);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading document header");
        }

        // Load all units of measure
        try
        {
            var units = await ProductService.GetUnitsOfMeasureAsync();
            _allUnitsOfMeasure = units?.ToList() ?? new List<UMDto>();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading units of measure");
        }

        // Load all VAT rates
        try
        {
            var vatRatesResult = await FinancialService.GetVatRatesAsync(1, 100);
            _allVatRates = vatRatesResult?.Items?.Where(v => v.IsActive).ToList() ?? new List<VatRateDto>();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading VAT rates");
        }

        // If in edit mode, load the existing row
        if (_isEditMode && RowId.HasValue)
        {
            await LoadRowForEdit(RowId.Value);
        }
    }

    protected override void OnParametersSet()
    {
        _model.DocumentHeaderId = DocumentHeaderId;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_isEditMode && _barcodeField != null)
        {
            await _barcodeField.FocusAsync();
        }
    }

    private async Task OnBarcodeKeyDown(KeyboardEventArgs e)
    {
        // Read value directly from component reference instead of bound variable
        // to avoid synchronization issues between KeyDown event and data binding
        if (e.Key == "Enter")
        {
            var currentValue = _barcodeField?.Value;
            if (!string.IsNullOrWhiteSpace(currentValue))
            {
                await SearchByBarcode(currentValue);
            }
        }
    }

    private async Task SearchByBarcode(string barcode)
    {
        if (_isProcessingBarcode) return;
        
        try
        {
            _isProcessingBarcode = true;
            _scannedBarcode = barcode;
            
            // Use new API that returns ProductWithCodeDto
            var productWithCode = await ProductService.GetProductWithCodeByCodeAsync(barcode);
            if (productWithCode?.Product != null)
            {
                // Store the ProductUnitId from the barcode if available
                _barcodeProductUnitId = productWithCode.Code?.ProductUnitId;
                
                await OnProductSelected(productWithCode.Product);
                _barcodeInput = string.Empty;
                _scannedBarcode = string.Empty;
                
                Snackbar.Add(
                    TranslationService.GetTranslation("warehouse.productFound", "Prodotto trovato"),
                    Severity.Success
                );
                
                // Focus on quantity field after product is found
                if (_quantityField != null)
                {
                    await Task.Delay(100);
                    await _quantityField.FocusAsync();
                }
            }
            else
            {
                // PRODOTTO NON TROVATO - Mostra dialog
                await ShowProductNotFoundDialog(barcode);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error searching product by barcode {Barcode}", barcode);
            Snackbar.Add($"Errore: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isProcessingBarcode = false;
        }
    }

    // Nuovo metodo ShowProductNotFoundDialog
    private async Task ShowProductNotFoundDialog(string code)
    {
        var parameters = new DialogParameters
        {
            { nameof(ProductNotFoundDialog.Barcode), code },
            { nameof(ProductNotFoundDialog.IsInventoryContext), false }
        };

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Small,
            FullWidth = true,
            CloseOnEscapeKey = false
        };

        var dialog = await DialogService.ShowAsync<ProductNotFoundDialog>(
            TranslationService.GetTranslation("warehouse.productNotFound", "Prodotto non trovato"),
            parameters,
            options
        );

        var result = await dialog.Result;

        if (!result.Canceled && result.Data != null)
        {
            // Handle ProductDto result (created product from QuickCreateProductDialog)
            if (result.Data is ProductDto createdProduct)
            {
                // Prodotto creato con successo, selezionalo automaticamente
                _selectedProduct = createdProduct;
                await OnProductSelected(createdProduct);
                _barcodeInput = string.Empty;
                _scannedBarcode = string.Empty;
                
                Snackbar.Add(
                    TranslationService.GetTranslation("warehouse.productCreatedAndSelected", "Prodotto creato e selezionato"),
                    Severity.Success
                );
            }
            // Handle string actions (skip)
            else if (result.Data is string action)
            {
                if (action == "skip")
                {
                    // Skip - pulisci e torna al dialog
                    _barcodeInput = string.Empty;
                    _scannedBarcode = string.Empty;
                }
            }
            else
            {
                // Try to handle assignment result
                try
                {
                    dynamic assignResult = result.Data;
                    if (assignResult.Action == "assigned" && assignResult.Product != null)
                    {
                        ProductDto assignedProduct = assignResult.Product;
                        
                        // Prodotto assegnato, selezionalo automaticamente
                        _selectedProduct = assignedProduct;
                        await OnProductSelected(assignedProduct);
                        _barcodeInput = string.Empty;
                        _scannedBarcode = string.Empty;
                        
                        Snackbar.Add(
                            TranslationService.GetTranslation("warehouse.codeAssignedAndProductSelected", "Codice assegnato e prodotto selezionato"),
                            Severity.Success
                        );
                    }
                }
                catch (Exception ex)
                {
                    Logger.LogWarning(ex, "Could not extract assignment info from dialog result");
                    _barcodeInput = string.Empty;
                    _scannedBarcode = string.Empty;
                }
            }
        }
        else
        {
            _barcodeInput = string.Empty;
            _scannedBarcode = string.Empty;
        }
    }

    private async Task OnProductSelected(ProductDto? product)
    {
        _selectedProduct = product;
        if (product != null)
        {
            await PopulateFromProduct(product);
            
            // Load recent transactions for price suggestions
            await LoadRecentTransactions(product.Id);
            
            StateHasChanged();
        }
    }

    private async Task<IEnumerable<ProductDto>> SearchProductsAsync(string searchTerm, CancellationToken cancellationToken)
    {
        if (string.IsNullOrWhiteSpace(searchTerm))
            return Array.Empty<ProductDto>();

        try
        {
            // Use unified search API that searches entire product catalog
            var result = await ProductService.SearchProductsAsync(searchTerm, 50);
            
            if (result == null)
                return Array.Empty<ProductDto>();
            
            var exactMatchProduct = result.ExactMatch?.Product;
            if (exactMatchProduct != null)
            {
                // If exact match found, show it first
                var exactMatchList = new List<ProductDto> { exactMatchProduct };
                
                // Add other results if present, excluding the exact match
                var searchResults = result.SearchResults ?? Enumerable.Empty<ProductDto>();
                if (searchResults.Any())
                {
                    exactMatchList.AddRange(searchResults.Where(p => p.Id != exactMatchProduct.Id));
                }
                
                return exactMatchList;
            }
            
            return result.SearchResults ?? Enumerable.Empty<ProductDto>();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error searching products");
            return Array.Empty<ProductDto>();
        }
    }

    private async Task PopulateFromProduct(ProductDto product)
    {
        _model.ProductId = product.Id;
        _model.ProductCode = product.Code;
        _model.Description = product.Name;
        
        // âœ… CHIAVE: Normalizza il prezzo in base a IsVatIncluded
        decimal productPrice = product.DefaultPrice ?? 0m;
        decimal vatRate = 0m;

        // Load VAT rate from product if available
        if (product.VatRateId.HasValue)
        {
            _selectedVatRateId = product.VatRateId;
            var vatRateDto = _allVatRates.FirstOrDefault(v => v.Id == product.VatRateId.Value);
            if (vatRateDto != null)
            {
                vatRate = vatRateDto.Percentage;
                _model.VatRate = vatRate;
                _model.VatDescription = vatRateDto.Name;
            }
        }
        
        // âœ… Se il prodotto ha IVA inclusa, scorporiamo SUBITO
        if (product.IsVatIncluded && vatRate > 0)
        {
            // Scorporo IVA: Prezzo / (1 + IVA%)
            productPrice = productPrice / (1 + vatRate / 100m);
        }
        
        // Salva il prezzo giÃ  NETTO
        _model.UnitPrice = productPrice;

        // Load units of measure for this product
        try
        {
            var units = await ProductService.GetProductUnitsAsync(product.Id);
            _availableUnits = units?.ToList() ?? new List<ProductUnitDto>();

            if (_availableUnits.Any())
            {
                // If barcode lookup provided a ProductUnitId, try to use it
                if (_barcodeProductUnitId.HasValue)
                {
                    // Find the unit with the ProductUnitId from the barcode
                    var barcodeUnit = _availableUnits.FirstOrDefault(u => u.Id == _barcodeProductUnitId.Value);
                    if (barcodeUnit != null)
                    {
                        _selectedUnitOfMeasureId = barcodeUnit.UnitOfMeasureId;
                        UpdateModelUnitOfMeasure(_selectedUnitOfMeasureId);
                        
                        // Clear the barcode unit after using it
                        _barcodeProductUnitId = null;
                    }
                    else
                    {
                        // Barcode specified a unit, but it's not in the available units
                        // Fall back to default selection
                        SelectDefaultUnit();
                    }
                }
                else
                {
                    // No barcode unit - use default selection
                    SelectDefaultUnit();
                }
            }
            else
            {
                // If no units configured for product, use product's default unit if available
                if (product.UnitOfMeasureId.HasValue)
                {
                    // Create a temporary ProductUnit entry so the dropdown works
                    _availableUnits.Add(new ProductUnitDto
                    {
                        Id = Guid.NewGuid(),
                        ProductId = product.Id,
                        UnitOfMeasureId = product.UnitOfMeasureId.Value,
                        ConversionFactor = 1,
                        UnitType = "Base",
                        Status = EventForge.DTOs.Common.ProductUnitStatus.Active
                    });

                    _selectedUnitOfMeasureId = product.UnitOfMeasureId;
                    UpdateModelUnitOfMeasure(_selectedUnitOfMeasureId);
                }
                else
                {
                    // No units configured - show warning
                    Snackbar.Add(TranslationService.GetTranslation("documents.noUnitsConfigured", "Nessuna unitÃ  di misura configurata per questo prodotto"), Severity.Warning);
                    _selectedUnitOfMeasureId = null;
                    _model.UnitOfMeasure = null;
                    _model.UnitOfMeasureId = null;
                }
            }

            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading product units for product {ProductId}", product.Id);
            Snackbar.Add(TranslationService.GetTranslation("documents.errorLoadingUnits", "Errore nel caricamento delle unitÃ  di misura"), Severity.Error);
        }
    }

    private void SelectDefaultUnit()
    {
        // Find the default unit or use the first one
        var defaultUnit = _availableUnits.FirstOrDefault(u => u.UnitType == "Base");
        if (defaultUnit != null)
        {
            _selectedUnitOfMeasureId = defaultUnit.UnitOfMeasureId;
        }
        else
        {
            _selectedUnitOfMeasureId = _availableUnits.First().UnitOfMeasureId;
        }

        // Set the unit of measure name
        UpdateModelUnitOfMeasure(_selectedUnitOfMeasureId);
    }

    private void OnUnitOfMeasureChanged(Guid? unitOfMeasureId)
    {
        _selectedUnitOfMeasureId = unitOfMeasureId;
        UpdateModelUnitOfMeasure(unitOfMeasureId);
    }

    private void OnVatRateChanged(Guid? vatRateId)
    {
        _selectedVatRateId = vatRateId;
        if (vatRateId.HasValue)
        {
            var vatRate = _allVatRates.FirstOrDefault(v => v.Id == vatRateId.Value);
            if (vatRate != null)
            {
                _model.VatRate = vatRate.Percentage;
                _model.VatDescription = vatRate.Name;
            }
        }
        else
        {
            _model.VatRate = 0;
            _model.VatDescription = null;
        }
        StateHasChanged();
    }

    private decimal GetDiscountAmount()
    {
        var baseAmount = _model.Quantity * _model.UnitPrice;
        var discount = _model.DiscountType == DiscountType.Percentage
            ? baseAmount * (_model.LineDiscount / 100m)
            : _model.LineDiscountValue;
        
        // Ensure discount doesn't exceed base amount
        return Math.Min(discount, baseAmount);
    }

    private decimal CalculateSubtotal()
    {
        var baseAmount = _model.Quantity * _model.UnitPrice;
        return baseAmount - GetDiscountAmount();
    }

    private decimal CalculateVatAmount()
    {
        var subtotal = CalculateSubtotal();
        return subtotal * (_model.VatRate / 100m);
    }

    private decimal CalculateLineTotal()
    {
        var subtotal = CalculateSubtotal();
        var vatAmount = subtotal * (_model.VatRate / 100m);
        return subtotal + vatAmount;
    }
    
    private decimal CalculateNetTotal()
    {
        return CalculateSubtotal();
    }
    
    private decimal CalculateGrossTotal()
    {
        return CalculateLineTotal();
    }
    
    private bool IsProductVatIncluded => _selectedProduct?.IsVatIncluded ?? false;
    
    private decimal GetOriginalGrossPrice()
    {
        if (!IsProductVatIncluded)
            return _model.Quantity * _model.UnitPrice;
            
        // Se il prodotto aveva IVA inclusa, mostra il prezzo lordo originale
        return _model.Quantity * _model.UnitPrice * (1 + _model.VatRate / 100m);
    }

    private void UpdateModelUnitOfMeasure(Guid? unitOfMeasureId)
    {
        if (unitOfMeasureId.HasValue)
        {
            var selectedUom = _allUnitsOfMeasure.FirstOrDefault(u => u.Id == unitOfMeasureId);
            if (selectedUom != null)
            {
                _model.UnitOfMeasure = selectedUom.Symbol;
                _model.UnitOfMeasureId = selectedUom.Id;
            }
        }
        else
        {
            // Clear unit of measure fields when null
            _model.UnitOfMeasure = null;
            _model.UnitOfMeasureId = null;
        }
    }

    private async Task LoadRowForEdit(Guid rowId)
    {
        try
        {
            // Load the document to get the row data
            var document = await DocumentHeaderService.GetDocumentHeaderByIdAsync(DocumentHeaderId, includeRows: true);
            var row = document?.Rows?.FirstOrDefault(r => r.Id == rowId);

            if (row != null)
            {
                _model.ProductCode = row.ProductCode;
                _model.Description = row.Description;
                _model.Quantity = row.Quantity;
                _model.UnitPrice = row.UnitPrice;
                _model.UnitOfMeasure = row.UnitOfMeasure;
                _model.UnitOfMeasureId = row.UnitOfMeasureId;
                _model.Notes = row.Notes;
                _model.VatRate = row.VatRate;
                _model.VatDescription = row.VatDescription;
                _selectedUnitOfMeasureId = row.UnitOfMeasureId;

                // Try to find the VAT rate based on percentage and description
                if (_model.VatRate > 0 || !string.IsNullOrEmpty(_model.VatDescription))
                {
                    var vatRate = _allVatRates.FirstOrDefault(v => 
                        v.Percentage == _model.VatRate && 
                        (string.IsNullOrEmpty(_model.VatDescription) || v.Name == _model.VatDescription));
                    if (vatRate != null)
                    {
                        _selectedVatRateId = vatRate.Id;
                    }
                }

                // Load the product if available
                if (row.ProductId.HasValue)
                {
                    var product = await ProductService.GetProductByIdAsync(row.ProductId.Value);
                    if (product != null)
                    {
                        _selectedProduct = product;
                        // Load product units
                        var units = await ProductService.GetProductUnitsAsync(product.Id);
                        _availableUnits = units?.ToList() ?? new List<ProductUnitDto>();
                    }
                }

                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading row {RowId} for edit", rowId);
            Snackbar.Add(TranslationService.GetTranslation("documents.errorLoadingRow", "Errore nel caricamento della riga"), Severity.Error);
        }
    }

    private bool IsValid()
    {
        return !string.IsNullOrWhiteSpace(_model.Description) && _model.Quantity > 0;
    }

    private async Task SaveAndContinue()
    {
        if (_isProcessing)
            return;

        _isProcessing = true;
        try
        {
            // Ensure unit of measure is set before saving
            if (_selectedUnitOfMeasureId.HasValue && _model.UnitOfMeasureId != _selectedUnitOfMeasureId)
            {
                UpdateModelUnitOfMeasure(_selectedUnitOfMeasureId);
            }

            if (_isEditMode && RowId.HasValue)
            {
                // Update existing row
                var updateDto = new UpdateDocumentRowDto
                {
                    ProductCode = _model.ProductCode,
                    Description = _model.Description,
                    UnitOfMeasure = _model.UnitOfMeasure,
                    UnitOfMeasureId = _model.UnitOfMeasureId,
                    UnitPrice = _model.UnitPrice,
                    Quantity = _model.Quantity,
                    Notes = _model.Notes,
                    RowType = _model.RowType,
                    LineDiscount = _model.LineDiscount,
                    LineDiscountValue = _model.LineDiscountValue,
                    DiscountType = _model.DiscountType,
                    VatRate = _model.VatRate,
                    VatDescription = _model.VatDescription,
                    IsGift = _model.IsGift,
                    IsManual = _model.IsManual,
                    SourceWarehouseId = _model.SourceWarehouseId,
                    DestinationWarehouseId = _model.DestinationWarehouseId,
                    SortOrder = _model.SortOrder,
                    StationId = _model.StationId,
                    ParentRowId = _model.ParentRowId
                };

                var result = await DocumentHeaderService.UpdateDocumentRowAsync(RowId.Value, updateDto);
                if (result != null)
                {
                    Snackbar.Add(TranslationService.GetTranslation("documents.rowUpdatedSuccess", "Riga aggiornata con successo"), Severity.Success);
                    MudDialog.Close(DialogResult.Ok(result));
                }
                else
                {
                    Snackbar.Add(TranslationService.GetTranslation("documents.rowUpdatedError", "Errore durante l'aggiornamento della riga"), Severity.Error);
                }
            }
            else
            {
                // Create new row
                Logger.LogInformation(
                    "Adding document row: ProductId={ProductId}, Qty={Qty}, MergeDuplicates={Merge}",
                    _model.ProductId,
                    _model.Quantity,
                    _model.MergeDuplicateProducts
                );
                
                var result = await DocumentHeaderService.AddDocumentRowAsync(_model);
                if (result != null)
                {
                    Snackbar.Add(TranslationService.GetTranslation("documents.rowAddedSuccess", "Riga aggiunta con successo"), Severity.Success);
                    
                    // Reset the form for next entry instead of closing
                    ResetForm();
                    
                    // Focus back to barcode field for next scan
                    if (_barcodeField != null)
                    {
                        await Task.Delay(100);
                        await _barcodeField.FocusAsync();
                    }
                }
                else
                {
                    Snackbar.Add(TranslationService.GetTranslation("documents.rowAddedError", "Errore durante l'aggiunta della riga"), Severity.Error);
                }
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error saving document row");
            var errorKey = _isEditMode ? "documents.rowUpdatedError" : "documents.rowAddedError";
            var errorMessage = _isEditMode ? "Errore durante l'aggiornamento della riga" : "Errore durante l'aggiunta della riga";
            Snackbar.Add(TranslationService.GetTranslation(errorKey, errorMessage), Severity.Error);
        }
        finally
        {
            _isProcessing = false;
        }
    }

    private void ResetForm()
    {
        // Preserve the merge duplicates preference across form resets
        var preserveMergeDuplicates = _model.MergeDuplicateProducts;
        
        _model = new CreateDocumentRowDto 
        { 
            DocumentHeaderId = DocumentHeaderId,
            Quantity = 1,
            MergeDuplicateProducts = preserveMergeDuplicates
        };
        _selectedProduct = null;
        _barcodeInput = string.Empty;
        StateHasChanged();
    }

    private void Cancel()
    {
        MudDialog.Cancel();
    }

    private async Task LoadRecentTransactions(Guid productId)
    {
        if (_documentHeader == null)
        {
            return;
        }

        _loadingTransactions = true;
        _recentTransactions.Clear();
        
        try
        {
            // Determine transaction type based on document type name keywords
            // Determine transaction type based on document type name keywords
            string transactionType = "purchase"; // default
            
            if (!string.IsNullOrEmpty(_documentHeader.DocumentTypeName))
            {
                var lowerName = _documentHeader.DocumentTypeName.ToLower();
                
                if (SaleKeywords.Any(k => lowerName.Contains(k)))
                {
                    transactionType = "sale";
                }
                else if (PurchaseKeywords.Any(k => lowerName.Contains(k)))
                {
                    transactionType = "purchase";
                }
            }
            
            // Optionally filter by business party if available
            Guid? partyId = _documentHeader.BusinessPartyId != Guid.Empty ? _documentHeader.BusinessPartyId : null;
            
            var transactions = await ProductService.GetRecentProductTransactionsAsync(
                productId,
                transactionType,
                partyId,
                top: 3
            );
            
            if (transactions != null)
            {
                _recentTransactions = transactions.ToList();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading recent transactions for product {ProductId}", productId);
        }
        finally
        {
            _loadingTransactions = false;
        }
    }

    private void ApplySuggestion(RecentProductTransactionDto suggestion)
    {
        try
        {
            // Apply the effective unit price
            _model.UnitPrice = suggestion.EffectiveUnitPrice;
            
            // If base unit price is available, apply it
            if (suggestion.BaseUnitPrice.HasValue)
            {
                _model.BaseUnitPrice = suggestion.BaseUnitPrice.Value;
            }
            
            // Clear discount fields since the suggested price is already net
            _model.LineDiscount = 0;
            _model.LineDiscountValue = 0;
            _model.DiscountType = EventForge.DTOs.Common.DiscountType.Percentage;
            
            Snackbar.Add(
                TranslationService.GetTranslation("documents.priceApplied", "Prezzo applicato: {0:C2}", suggestion.EffectiveUnitPrice),
                Severity.Success
            );
            
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error applying price suggestion");
            Snackbar.Add(
                TranslationService.GetTranslation("documents.priceApplyError", "Errore nell'applicazione del prezzo"),
                Severity.Error
            );
        }
    }
    
    // Helper methods for new Line Summary section
    private decimal GetUnitPriceGross()
    {
        if (_model.UnitPrice <= 0 || _model.VatRate < 0)
            return _model.UnitPrice;
        
        return _model.UnitPrice * (1 + _model.VatRate / 100);
    }
    
    private decimal GetSubtotal()
    {
        return CalculateSubtotal();
    }
    
    private decimal GetVatAmount()
    {
        return CalculateVatAmount();
    }
    
    private decimal GetTotalDiscount()
    {
        var subtotal = _model.Quantity * _model.UnitPrice;
        var discountFromPercentage = subtotal * (_model.LineDiscount / 100);
        return discountFromPercentage + _model.LineDiscountValue;
    }
    
    private decimal GetLineTotal()
    {
        var subtotal = GetSubtotal();
        var vatAmount = GetVatAmount();
        
        return subtotal + vatAmount;
    }
    
    private decimal GetTotal()
    {
        return CalculateLineTotal();
    }
    
    // Method to open product edit dialog
    private async Task OpenEditProductDialog()
    {
        if (_selectedProduct == null || _selectedProduct.Id == Guid.Empty)
        {
            Snackbar.Add(
                TranslationService.GetTranslation("products.noProductSelected", "Nessun prodotto selezionato"),
                Severity.Warning
            );
            return;
        }

        var parameters = new DialogParameters
        {
            { "IsEditMode", true },
            { "ProductId", _selectedProduct.Id },
            { "ExistingProduct", _selectedProduct }
        };

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Medium,
            FullWidth = true,
            CloseButton = true,
            CloseOnEscapeKey = true
        };

        var dialog = await DialogService.ShowAsync<QuickCreateProductDialog>(
            TranslationService.GetTranslation("warehouse.quickEditProduct", "Modifica Rapida Prodotto"),
            parameters,
            options
        );

        var result = await dialog.Result;

        if (!result.Canceled && result.Data is ProductDto updatedProduct)
        {
            // Update the selected product
            _selectedProduct = updatedProduct;
            
            // Update form fields
            _model.Description = updatedProduct.Description;
            _model.ProductCode = updatedProduct.Code;
            _model.UnitPrice = updatedProduct.DefaultPrice ?? _model.UnitPrice;
            
            // Update VAT rate if product has one
            if (updatedProduct.VatRateId.HasValue)
            {
                _selectedVatRateId = updatedProduct.VatRateId.Value;
                var vatRate = _allVatRates.FirstOrDefault(v => v.Id == updatedProduct.VatRateId.Value);
                if (vatRate != null)
                {
                    _model.VatRate = vatRate.Percentage;
                    _model.VatDescription = vatRate.Name;
                }
            }
            
            Snackbar.Add(
                TranslationService.GetTranslation("products.updatedSuccess", "Prodotto aggiornato con successo"),
                Severity.Success
            );
            
            StateHasChanged();
        }
    }
}
