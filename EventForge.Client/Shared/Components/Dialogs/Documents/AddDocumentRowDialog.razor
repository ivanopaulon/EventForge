@using EventForge.DTOs.Documents
@using EventForge.DTOs.Products
@using EventForge.DTOs.UnitOfMeasures
@using MudBlazor
@inject IDocumentHeaderService DocumentHeaderService
@inject IProductService ProductService
@inject ISnackbar Snackbar
@inject ITranslationService TranslationService
@inject ILogger<AddDocumentRowDialog> Logger
@inject IJSRuntime JSRuntime

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@(_isEditMode ? Icons.Material.Outlined.Edit : Icons.Material.Outlined.Add)" Class="mr-2" />
            @TranslationService.GetTranslation(_isEditMode ? "documents.editRow" : "documents.addRow", _isEditMode ? "Modifica Riga" : "Aggiungi Riga")
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudStack Spacing="3">
            <!-- Barcode Scanner Section -->
            <MudPaper Elevation="1" Class="pa-3" Style="background-color: var(--mud-palette-background-grey);">
                <MudStack Spacing="2">
                    <MudText Typo="Typo.subtitle2">
                        <MudIcon Icon="@Icons.Material.Outlined.QrCodeScanner" Class="mr-2" Size="Size.Small" />
                        @TranslationService.GetTranslation("warehouse.scanBarcode", "Scansiona Codice a Barre")
                    </MudText>
                    <MudTextField @bind-Value="_barcodeInput"
                                  Label="@TranslationService.GetTranslation("warehouse.barcodeInput", "Codice a Barre")"
                                  Variant="Variant.Outlined"
                                  @onkeydown="@OnBarcodeKeyDown"
                                  @ref="_barcodeField"
                                  Adornment="Adornment.Start"
                                  AdornmentIcon="@Icons.Material.Outlined.QrCode"
                                  HelperText="@TranslationService.GetTranslation("warehouse.scanOrTypeBarcode", "Scansiona o digita il codice a barre e premi Invio")" />
                </MudStack>
            </MudPaper>

            <!-- Product Search/Selection -->
            <MudAutocomplete T="ProductDto"
                             Variant="Variant.Outlined"
                             Label="@TranslationService.GetTranslation("documents.product", "Prodotto")"
                             Value="_selectedProduct"
                             ValueChanged="@OnProductSelected"
                             SearchFunc="@SearchProductsAsync"
                             ToStringFunc="@(p => p?.Name ?? string.Empty)"
                             ShowProgressIndicator="true"
                             Adornment="Adornment.Start"
                             AdornmentIcon="@Icons.Material.Outlined.Inventory">
                <ItemTemplate Context="product">
                    <MudText>@product.Name</MudText>
                    <MudText Typo="Typo.caption">@product.Code</MudText>
                </ItemTemplate>
            </MudAutocomplete>

            <!-- Product Details -->
            @if (_selectedProduct != null)
            {
                <MudAlert Severity="Severity.Success" Dense="true" Variant="Variant.Text">
                    <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                        <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" Size="Size.Medium" />
                        <div>
                            <MudText Typo="Typo.body2" Style="font-weight: 600;">@_selectedProduct.Name</MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">@TranslationService.GetTranslation("documents.productCode", "Codice"): @_selectedProduct.Code</MudText>
                        </div>
                    </MudStack>
                </MudAlert>
            }

            <MudTextField T="string"
                          Variant="Variant.Outlined"
                          Label="@TranslationService.GetTranslation("documents.description", "Descrizione")"
                          @bind-Value="_model.Description"
                          Required="true"
                          Disabled="@(_selectedProduct != null)"
                          Adornment="Adornment.Start"
                          AdornmentIcon="@Icons.Material.Outlined.Description" />

            <MudTextField T="string"
                          Variant="Variant.Outlined"
                          Label="@TranslationService.GetTranslation("documents.productCode", "Codice")"
                          @bind-Value="_model.ProductCode"
                          Disabled="@(_selectedProduct != null)"
                          Adornment="Adornment.Start"
                          AdornmentIcon="@Icons.Material.Outlined.Tag" />

            <MudGrid Spacing="2">
                <MudItem xs="12" md="4">
                    <MudNumericField T="decimal"
                                     Variant="Variant.Outlined"
                                     Label="@TranslationService.GetTranslation("documents.quantity", "Quantità")"
                                     @bind-Value="_model.Quantity"
                                     Min="0.0001m"
                                     Required="true"
                                     @ref="_quantityField"
                                     Adornment="Adornment.Start"
                                     AdornmentIcon="@Icons.Material.Outlined.Numbers" />
                </MudItem>
                <MudItem xs="12" md="4">
                    <MudNumericField T="decimal"
                                     Variant="Variant.Outlined"
                                     Label="@TranslationService.GetTranslation("documents.unitPrice", "Prezzo Unitario")"
                                     @bind-Value="_model.UnitPrice"
                                     Min="0"
                                     Format="N2"
                                     Adornment="Adornment.Start"
                                     AdornmentIcon="@Icons.Material.Outlined.Euro" />
                </MudItem>
                <MudItem xs="12" md="4">
                    <MudSelect T="Guid?"
                               Variant="Variant.Outlined"
                               Label="@TranslationService.GetTranslation("documents.unitOfMeasure", "UM")"
                               Value="_selectedUnitOfMeasureId"
                               ValueChanged="@OnUnitOfMeasureChanged"
                               Disabled="@(_availableUnits.Count == 0)"
                               Adornment="Adornment.Start"
                               AdornmentIcon="@Icons.Material.Outlined.Scale">
                        @foreach (var unit in _availableUnits)
                        {
                            var uom = _allUnitsOfMeasure.FirstOrDefault(u => u.Id == unit.UnitOfMeasureId);
                            if (uom != null)
                            {
                                <MudSelectItem T="Guid?" Value="@uom.Id">@uom.Name (@uom.Symbol)</MudSelectItem>
                            }
                        }
                    </MudSelect>
                </MudItem>
            </MudGrid>

            <MudTextField T="string"
                          Variant="Variant.Outlined"
                          Label="@TranslationService.GetTranslation("documents.notes", "Note")"
                          @bind-Value="_model.Notes"
                          Lines="2"
                          Adornment="Adornment.Start"
                          AdornmentIcon="@Icons.Material.Outlined.Comment" />

            <!-- Merge Duplicates Option -->
            <MudCheckBox T="bool"
                         @bind-Checked="_model.MergeDuplicateProducts"
                         Label="@TranslationService.GetTranslation("documents.mergeDuplicates", "Sum quantity if item already present")"
                         Color="Color.Primary">
                <MudTooltip Text="@TranslationService.GetTranslation("documents.mergeDuplicatesHelp", "When enabled, if you add the same product multiple times, the quantity will be summed to the existing row instead of creating a new one")">
                    <MudIcon Icon="@Icons.Material.Outlined.Info" Size="Size.Small" Color="Color.Info" Class="ml-1" />
                </MudTooltip>
            </MudCheckBox>

            <!-- Quick Tips -->
            <MudAlert Severity="Severity.Info" Dense="true" Variant="Variant.Text">
                <MudText Typo="Typo.caption">
                    <MudIcon Icon="@Icons.Material.Outlined.Keyboard" Size="Size.Small" Class="mr-1" />
                    <strong>Suggerimento:</strong> Dopo aver aggiunto una riga, il form verrà resettato per inserimenti consecutivi
                </MudText>
            </MudAlert>
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel" Variant="Variant.Outlined">
            @TranslationService.GetTranslation("common.close", "Chiudi")
        </MudButton>
        <MudButton Color="Color.Primary" 
                   OnClick="SaveAndContinue" 
                   Disabled="@(!IsValid())"
                   Variant="Variant.Filled"
                   StartIcon="@(_isEditMode ? Icons.Material.Filled.Save : Icons.Material.Filled.Add)">
            @TranslationService.GetTranslation(_isEditMode ? "common.save" : "documents.addAndContinue", _isEditMode ? "Salva" : "Aggiungi e Continua")
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] private IMudDialogInstance MudDialog { get; set; } = null!;
    [Parameter] public Guid DocumentHeaderId { get; set; }
    [Parameter] public Guid? RowId { get; set; }

    private MudTextField<string>? _barcodeField;
    private MudNumericField<decimal>? _quantityField;
    private CreateDocumentRowDto _model = new() { Quantity = 1m };
    private ProductDto? _selectedProduct = null;
    private string _barcodeInput = string.Empty;
    private bool _isProcessing = false;
    private bool _isEditMode => RowId.HasValue;
    private List<ProductUnitDto> _availableUnits = new();
    private List<UMDto> _allUnitsOfMeasure = new();
    private Guid? _selectedUnitOfMeasureId = null;

    protected override async Task OnInitializedAsync()
    {
        // Load all units of measure
        try
        {
            var units = await ProductService.GetUnitsOfMeasureAsync();
            _allUnitsOfMeasure = units?.ToList() ?? new List<UMDto>();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading units of measure");
        }

        // If in edit mode, load the existing row
        if (_isEditMode && RowId.HasValue)
        {
            await LoadRowForEdit(RowId.Value);
        }
    }

    protected override void OnParametersSet()
    {
        _model.DocumentHeaderId = DocumentHeaderId;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_isEditMode && _barcodeField != null)
        {
            await _barcodeField.FocusAsync();
        }
    }

    private async Task OnBarcodeKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !string.IsNullOrWhiteSpace(_barcodeInput))
        {
            await SearchByBarcode(_barcodeInput);
        }
    }

    private async Task SearchByBarcode(string barcode)
    {
        if (string.IsNullOrWhiteSpace(barcode))
            return;

        try
        {
            var product = await ProductService.GetProductByCodeAsync(barcode);
            if (product != null)
            {
                OnProductSelected(product);
                Snackbar.Add(TranslationService.GetTranslation("warehouse.productFound", "Prodotto trovato: {0}", product.Name), Severity.Success);
                
                // Focus on quantity field after product is found
                if (_quantityField != null)
                {
                    await Task.Delay(100);
                    await _quantityField.FocusAsync();
                }
            }
            else
            {
                Snackbar.Add(TranslationService.GetTranslation("warehouse.productNotFound", "Prodotto non trovato per il codice: {0}", barcode), Severity.Warning);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error searching product by barcode {Barcode}", barcode);
            Snackbar.Add(TranslationService.GetTranslation("warehouse.searchError", "Errore nella ricerca"), Severity.Error);
        }
    }

    private async Task OnProductSelected(ProductDto? product)
    {
        _selectedProduct = product;
        if (product != null)
        {
            await PopulateFromProduct(product);
            StateHasChanged();
        }
    }

    private async Task<IEnumerable<ProductDto>> SearchProductsAsync(string searchTerm, CancellationToken cancellationToken)
    {
        if (string.IsNullOrWhiteSpace(searchTerm))
            return Array.Empty<ProductDto>();

        try
        {
            // Use GetProductsAsync and filter locally for simplicity
            var result = await ProductService.GetProductsAsync(1, 50);
            return result?.Items.Where(p => 
                (p.Name?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false) ||
                (p.Code?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false)
            ) ?? Array.Empty<ProductDto>();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error searching products");
            return Array.Empty<ProductDto>();
        }
    }

    private async Task PopulateFromProduct(ProductDto product)
    {
        _model.ProductId = product.Id;
        _model.ProductCode = product.Code;
        _model.Description = product.Name;
        _model.UnitPrice = product.DefaultPrice ?? 0;

        // Load units of measure for this product
        try
        {
            var units = await ProductService.GetProductUnitsAsync(product.Id);
            _availableUnits = units?.ToList() ?? new List<ProductUnitDto>();

            if (_availableUnits.Any())
            {
                // Find the default unit or use the first one
                var defaultUnit = _availableUnits.FirstOrDefault(u => u.UnitType == "Base");
                if (defaultUnit != null)
                {
                    _selectedUnitOfMeasureId = defaultUnit.UnitOfMeasureId;
                }
                else
                {
                    _selectedUnitOfMeasureId = _availableUnits.First().UnitOfMeasureId;
                }

                // Set the unit of measure name
                UpdateModelUnitOfMeasure(_selectedUnitOfMeasureId);
            }
            else
            {
                // If no units configured for product, use product's default unit if available
                if (product.UnitOfMeasureId.HasValue)
                {
                    // Create a temporary ProductUnit entry so the dropdown works
                    _availableUnits.Add(new ProductUnitDto
                    {
                        Id = Guid.NewGuid(),
                        ProductId = product.Id,
                        UnitOfMeasureId = product.UnitOfMeasureId.Value,
                        ConversionFactor = 1,
                        UnitType = "Base",
                        Status = EventForge.DTOs.Common.ProductUnitStatus.Active
                    });

                    _selectedUnitOfMeasureId = product.UnitOfMeasureId;
                    UpdateModelUnitOfMeasure(_selectedUnitOfMeasureId);
                }
                else
                {
                    // No units configured - show warning
                    Snackbar.Add(TranslationService.GetTranslation("documents.noUnitsConfigured", "Nessuna unità di misura configurata per questo prodotto"), Severity.Warning);
                    _selectedUnitOfMeasureId = null;
                    _model.UnitOfMeasure = null;
                    _model.UnitOfMeasureId = null;
                }
            }

            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading product units for product {ProductId}", product.Id);
            Snackbar.Add(TranslationService.GetTranslation("documents.errorLoadingUnits", "Errore nel caricamento delle unità di misura"), Severity.Error);
        }
    }

    private void OnUnitOfMeasureChanged(Guid? unitOfMeasureId)
    {
        _selectedUnitOfMeasureId = unitOfMeasureId;
        UpdateModelUnitOfMeasure(unitOfMeasureId);
    }

    private void UpdateModelUnitOfMeasure(Guid? unitOfMeasureId)
    {
        if (unitOfMeasureId.HasValue)
        {
            var selectedUom = _allUnitsOfMeasure.FirstOrDefault(u => u.Id == unitOfMeasureId);
            if (selectedUom != null)
            {
                _model.UnitOfMeasure = selectedUom.Symbol;
                _model.UnitOfMeasureId = selectedUom.Id;
            }
        }
        else
        {
            // Clear unit of measure fields when null
            _model.UnitOfMeasure = null;
            _model.UnitOfMeasureId = null;
        }
    }

    private async Task LoadRowForEdit(Guid rowId)
    {
        try
        {
            // Load the document to get the row data
            var document = await DocumentHeaderService.GetDocumentHeaderByIdAsync(DocumentHeaderId, includeRows: true);
            var row = document?.Rows?.FirstOrDefault(r => r.Id == rowId);

            if (row != null)
            {
                _model.ProductCode = row.ProductCode;
                _model.Description = row.Description;
                _model.Quantity = row.Quantity;
                _model.UnitPrice = row.UnitPrice;
                _model.UnitOfMeasure = row.UnitOfMeasure;
                _model.UnitOfMeasureId = row.UnitOfMeasureId;
                _model.Notes = row.Notes;
                _selectedUnitOfMeasureId = row.UnitOfMeasureId;

                // Load the product if available
                if (row.ProductId.HasValue)
                {
                    var product = await ProductService.GetProductByIdAsync(row.ProductId.Value);
                    if (product != null)
                    {
                        _selectedProduct = product;
                        // Load product units
                        var units = await ProductService.GetProductUnitsAsync(product.Id);
                        _availableUnits = units?.ToList() ?? new List<ProductUnitDto>();
                    }
                }

                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading row {RowId} for edit", rowId);
            Snackbar.Add(TranslationService.GetTranslation("documents.errorLoadingRow", "Errore nel caricamento della riga"), Severity.Error);
        }
    }

    private bool IsValid()
    {
        return !string.IsNullOrWhiteSpace(_model.Description) && _model.Quantity > 0;
    }

    private async Task SaveAndContinue()
    {
        if (_isProcessing)
            return;

        _isProcessing = true;
        try
        {
            // Ensure unit of measure is set before saving
            if (_selectedUnitOfMeasureId.HasValue && _model.UnitOfMeasureId != _selectedUnitOfMeasureId)
            {
                UpdateModelUnitOfMeasure(_selectedUnitOfMeasureId);
            }

            if (_isEditMode && RowId.HasValue)
            {
                // Update existing row
                var updateDto = new UpdateDocumentRowDto
                {
                    ProductCode = _model.ProductCode,
                    Description = _model.Description,
                    UnitOfMeasure = _model.UnitOfMeasure,
                    UnitOfMeasureId = _model.UnitOfMeasureId,
                    UnitPrice = _model.UnitPrice,
                    Quantity = _model.Quantity,
                    Notes = _model.Notes,
                    RowType = _model.RowType,
                    LineDiscount = _model.LineDiscount,
                    VatRate = _model.VatRate,
                    VatDescription = _model.VatDescription,
                    IsGift = _model.IsGift,
                    IsManual = _model.IsManual,
                    SourceWarehouseId = _model.SourceWarehouseId,
                    DestinationWarehouseId = _model.DestinationWarehouseId,
                    SortOrder = _model.SortOrder,
                    StationId = _model.StationId,
                    ParentRowId = _model.ParentRowId
                };

                var result = await DocumentHeaderService.UpdateDocumentRowAsync(RowId.Value, updateDto);
                if (result != null)
                {
                    Snackbar.Add(TranslationService.GetTranslation("documents.rowUpdatedSuccess", "Riga aggiornata con successo"), Severity.Success);
                    MudDialog.Close(DialogResult.Ok(result));
                }
                else
                {
                    Snackbar.Add(TranslationService.GetTranslation("documents.rowUpdatedError", "Errore durante l'aggiornamento della riga"), Severity.Error);
                }
            }
            else
            {
                // Create new row
                var result = await DocumentHeaderService.AddDocumentRowAsync(_model);
                if (result != null)
                {
                    Snackbar.Add(TranslationService.GetTranslation("documents.rowAddedSuccess", "Riga aggiunta con successo"), Severity.Success);
                    
                    // Reset the form for next entry instead of closing
                    ResetForm();
                    
                    // Focus back to barcode field for next scan
                    if (_barcodeField != null)
                    {
                        await Task.Delay(100);
                        await _barcodeField.FocusAsync();
                    }
                }
                else
                {
                    Snackbar.Add(TranslationService.GetTranslation("documents.rowAddedError", "Errore durante l'aggiunta della riga"), Severity.Error);
                }
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error saving document row");
            var errorKey = _isEditMode ? "documents.rowUpdatedError" : "documents.rowAddedError";
            var errorMessage = _isEditMode ? "Errore durante l'aggiornamento della riga" : "Errore durante l'aggiunta della riga";
            Snackbar.Add(TranslationService.GetTranslation(errorKey, errorMessage), Severity.Error);
        }
        finally
        {
            _isProcessing = false;
        }
    }

    private void ResetForm()
    {
        // Preserve the merge duplicates preference across form resets
        var preserveMergeDuplicates = _model.MergeDuplicateProducts;
        
        _model = new CreateDocumentRowDto 
        { 
            DocumentHeaderId = DocumentHeaderId,
            Quantity = 1,
            MergeDuplicateProducts = preserveMergeDuplicates
        };
        _selectedProduct = null;
        _barcodeInput = string.Empty;
        StateHasChanged();
    }

    private void Cancel()
    {
        MudDialog.Cancel();
    }
}
