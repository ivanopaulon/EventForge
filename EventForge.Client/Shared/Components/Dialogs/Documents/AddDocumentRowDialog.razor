@using EventForge.DTOs.Documents
@using EventForge.DTOs.Products
@using EventForge.DTOs.UnitOfMeasures
@using EventForge.DTOs.VatRates
@using EventForge.DTOs.Common
@using MudBlazor

<MudDialog MaxWidth="MaxWidth.Large" FullWidth="true">
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@(_isEditMode ? Icons.Material.Outlined.Edit : Icons.Material.Outlined.Add)" Class="mr-2" />
            @TranslationService.GetTranslation(_isEditMode ? "documents.editRow" : "documents.addRow", _isEditMode ? "Modifica Riga" : "Aggiungi Riga")
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudStack Spacing="3">
            
            <!-- 1. BARCODE SCANNER (Full Width) -->
            <MudPaper Elevation="1" Class="pa-3" Style="background-color: var(--mud-palette-background-grey);">
                <MudStack Spacing="2">
                    <MudText Typo="Typo.subtitle2">
                        <MudIcon Icon="@Icons.Material.Outlined.QrCodeScanner" Class="mr-2" Size="Size.Small" />
                        @TranslationService.GetTranslation("warehouse.scanBarcode", "Scansiona Codice a Barre")
                    </MudText>
                    <MudTextField @bind-Value="_barcodeInput"
                                  Label="@TranslationService.GetTranslation("warehouse.barcodeInput", "Codice a Barre")"
                                  Variant="Variant.Outlined"
                                  @onkeydown="@OnBarcodeKeyDown"
                                  @ref="_barcodeField"
                                  Adornment="Adornment.Start"
                                  AdornmentIcon="@Icons.Material.Outlined.QrCode"
                                  HelperText="@TranslationService.GetTranslation("warehouse.scanOrTypeBarcode", "Scansiona o digita il codice a barre e premi Invio")" />
                </MudStack>
            </MudPaper>
            
            <!-- 2. PRODOTTO + QUANTITÃ€ (2 colonne) -->
            <MudGrid Spacing="3">
                <!-- Colonna Sinistra: Prodotto -->
                <MudItem xs="12" md="6">
                    <MudPaper Elevation="2" Class="pa-3" Style="height: 100%;">
                        <MudText Typo="Typo.subtitle1" Class="mb-3" Style="font-weight: 600;">
                            <MudIcon Icon="@Icons.Material.Outlined.Inventory" Class="mr-2" Size="Size.Small" />
                            @TranslationService.GetTranslation("documents.productSection", "Prodotto")
                        </MudText>
                        
                        <MudStack Spacing="2">
                            <MudAutocomplete T="ProductDto"
                                            Variant="Variant.Outlined"
                                            Label="@TranslationService.GetTranslation("documents.product", "Prodotto")"
                                            Value="_selectedProduct"
                                            ValueChanged="@OnProductSelected"
                                            SearchFunc="@SearchProductsAsync"
                                            ToStringFunc="@(p => p?.Name ?? string.Empty)"
                                            ShowProgressIndicator="true"
                                            Dense="true"
                                            Adornment="Adornment.Start"
                                            AdornmentIcon="@Icons.Material.Outlined.Inventory">
                                <ItemTemplate Context="product">
                                    <MudText>@product.Name</MudText>
                                    <MudText Typo="Typo.caption">@product.Code</MudText>
                                </ItemTemplate>
                            </MudAutocomplete>
                            
                            <MudTextField T="string"
                                         Label="@TranslationService.GetTranslation("documents.description", "Descrizione")"
                                         @bind-Value="_model.Description"
                                         Variant="Variant.Outlined"
                                         Lines="2"
                                         Dense="true"
                                         Required="true"
                                         Adornment="Adornment.Start"
                                         AdornmentIcon="@Icons.Material.Outlined.Description" />
                            
                            <MudCheckBox T="bool"
                                        @bind-Checked="_model.MergeDuplicateProducts"
                                        Label="@TranslationService.GetTranslation("documents.mergeDuplicates", "Somma quantitÃ  se giÃ  presente")"
                                        Color="Color.Primary"
                                        Dense="true"
                                        Disabled="@(_selectedProduct == null)">
                                @if (_selectedProduct == null)
                                {
                                    <MudTooltip Text="@TranslationService.GetTranslation("documents.mergeDuplicatesRequiresProduct", "Seleziona un prodotto dall'autocomplete per abilitare la fusione")">
                                        <MudIcon Icon="@Icons.Material.Outlined.Info" Size="Size.Small" Color="Color.Warning" Class="ml-1" />
                                    </MudTooltip>
                                }
                                else
                                {
                                    <MudTooltip Text="@TranslationService.GetTranslation("documents.mergeDuplicatesHelp", "Quando abilitato, se aggiungi lo stesso prodotto piÃ¹ volte, la quantitÃ  verrÃ  sommata alla riga esistente invece di crearne una nuova")">
                                        <MudIcon Icon="@Icons.Material.Outlined.Info" Size="Size.Small" Color="Color.Info" Class="ml-1" />
                                    </MudTooltip>
                                }
                            </MudCheckBox>
                        </MudStack>
                    </MudPaper>
                </MudItem>
                
                <!-- Colonna Destra: QuantitÃ  e UM -->
                <MudItem xs="12" md="6">
                    <MudPaper Elevation="2" Class="pa-3" Style="height: 100%;">
                        <MudText Typo="Typo.subtitle1" Class="mb-3" Style="font-weight: 600;">
                            <MudIcon Icon="@Icons.Material.Outlined.Straighten" Class="mr-2" Size="Size.Small" />
                            @TranslationService.GetTranslation("documents.quantityAndUnit", "QuantitÃ  e UnitÃ ")
                        </MudText>
                        
                        <MudStack Spacing="2">
                            <MudNumericField T="decimal"
                                            Label="@TranslationService.GetTranslation("documents.quantity", "QuantitÃ ")"
                                            @bind-Value="_model.Quantity"
                                            Min="0.0001m"
                                            Variant="Variant.Outlined"
                                            Dense="true"
                                            @ref="_quantityField"
                                            Adornment="Adornment.Start"
                                            AdornmentIcon="@Icons.Material.Outlined.Numbers" />
                            
                            <MudSelect T="Guid?"
                                      Label="@TranslationService.GetTranslation("documents.unitOfMeasure", "UnitÃ  di Misura")"
                                      Value="_selectedUnitOfMeasureId"
                                      ValueChanged="@OnUnitOfMeasureChanged"
                                      Variant="Variant.Outlined"
                                      Dense="true"
                                      Disabled="@(_availableUnits.Count == 0)"
                                      Adornment="Adornment.Start"
                                      AdornmentIcon="@Icons.Material.Outlined.Scale">
                                @foreach (var unit in _availableUnits)
                                {
                                    var uom = _allUnitsOfMeasure.FirstOrDefault(u => u.Id == unit.UnitOfMeasureId);
                                    if (uom != null)
                                    {
                                        <MudSelectItem T="Guid?" Value="@uom.Id">@uom.Name (@uom.Symbol)</MudSelectItem>
                                    }
                                }
                            </MudSelect>
                        </MudStack>
                    </MudPaper>
                </MudItem>
            </MudGrid>
            
            <!-- 3. PREZZI + IVA + SCONTI (3 colonne) -->
            <MudGrid Spacing="3">
                <!-- Colonna 1: Prezzi Netto/Lordo -->
                <MudItem xs="12" md="4">
                    <MudPaper Elevation="2" Class="pa-3" Style="height: 100%;">
                        <MudText Typo="Typo.subtitle1" Class="mb-3" Style="font-weight: 600;">
                            <MudIcon Icon="@Icons.Material.Outlined.AttachMoney" Class="mr-2" Size="Size.Small" />
                            @TranslationService.GetTranslation("documents.netPrice", "Prezzo Netto")
                        </MudText>
                        
                        <MudStack Spacing="2">
                            <MudNumericField T="decimal"
                                            Label="@TranslationService.GetTranslation("documents.unitPrice", "Prezzo Unitario Netto")"
                                            @bind-Value="_model.UnitPrice"
                                            Min="0"
                                            Format="N2"
                                            Variant="Variant.Outlined"
                                            Dense="true"
                                            Adornment="Adornment.Start"
                                            AdornmentIcon="@Icons.Material.Outlined.Euro" />
                            
                            <MudTextField T="string"
                                         Label="@TranslationService.GetTranslation("documents.unitPriceGross", "Prezzo Unit. Lordo")"
                                         Value="@GetUnitPriceGross().ToString("C2")"
                                         ReadOnly="true"
                                         Variant="Variant.Filled"
                                         Dense="true"
                                         Adornment="Adornment.Start"
                                         AdornmentIcon="@Icons.Material.Outlined.Calculate"
                                         HelperText="@TranslationService.GetTranslation("documents.autoCalculated", "Calcolato automaticamente")" />
                        </MudStack>
                    </MudPaper>
                </MudItem>
                
                <!-- Colonna 2: IVA -->
                <MudItem xs="12" md="4">
                    <MudPaper Elevation="2" Class="pa-3" Style="height: 100%;">
                        <MudText Typo="Typo.subtitle1" Class="mb-3" Style="font-weight: 600;">
                            <MudIcon Icon="@Icons.Material.Outlined.Receipt" Class="mr-2" Size="Size.Small" />
                            @TranslationService.GetTranslation("documents.vat", "IVA")
                        </MudText>
                        
                        <MudStack Spacing="2">
                            <MudSelect T="Guid?"
                                      Label="@TranslationService.GetTranslation("documents.vatRate", "Aliquota IVA %")"
                                      Value="_selectedVatRateId"
                                      ValueChanged="@OnVatRateChanged"
                                      Variant="Variant.Outlined"
                                      Dense="true"
                                      Adornment="Adornment.Start"
                                      AdornmentIcon="@Icons.Material.Outlined.Percent">
                                @foreach (var vatRate in _allVatRates)
                                {
                                    <MudSelectItem T="Guid?" Value="@vatRate.Id">@vatRate.Name (@vatRate.Percentage%)</MudSelectItem>
                                }
                            </MudSelect>
                            
                            <MudTextField T="string"
                                         Label="@TranslationService.GetTranslation("documents.vatAmount", "Importo IVA")"
                                         Value="@GetVatAmount().ToString("C2")"
                                         ReadOnly="true"
                                         Variant="Variant.Filled"
                                         Dense="true"
                                         Adornment="Adornment.Start"
                                         AdornmentIcon="@Icons.Material.Outlined.Calculate" />
                        </MudStack>
                    </MudPaper>
                </MudItem>
                
                <!-- Colonna 3: Sconti -->
                <MudItem xs="12" md="4">
                    <MudPaper Elevation="2" Class="pa-3" Style="height: 100%;">
                        <MudText Typo="Typo.subtitle1" Class="mb-3" Style="font-weight: 600;">
                            <MudIcon Icon="@Icons.Material.Outlined.Discount" Class="mr-2" Size="Size.Small" />
                            @TranslationService.GetTranslation("documents.discounts", "Sconti")
                        </MudText>
                        
                        <MudStack Spacing="2">
                            <MudNumericField T="decimal"
                                            Label="@TranslationService.GetTranslation("documents.lineDiscount", "Sconto %")"
                                            @bind-Value="_model.LineDiscount"
                                            Min="0"
                                            Max="100"
                                            Format="N2"
                                            Variant="Variant.Outlined"
                                            Dense="true"
                                            Adornment="Adornment.End"
                                            AdornmentIcon="@Icons.Material.Outlined.Percent" />
                            
                            <MudNumericField T="decimal"
                                            Label="@TranslationService.GetTranslation("documents.lineDiscountValue", "Sconto â‚¬")"
                                            @bind-Value="_model.LineDiscountValue"
                                            Min="0"
                                            Format="N2"
                                            Variant="Variant.Outlined"
                                            Dense="true"
                                            Adornment="Adornment.Start"
                                            AdornmentIcon="@Icons.Material.Outlined.Euro" />
                        </MudStack>
                    </MudPaper>
                </MudItem>
            </MudGrid>
            
            <!-- 4. NOTE (Full Width) -->
            <MudTextField T="string"
                         Label="@TranslationService.GetTranslation("documents.notes", "Note (opzionali)")"
                         @bind-Value="_model.Notes"
                         Lines="2"
                         Variant="Variant.Outlined"
                         Adornment="Adornment.Start"
                         AdornmentIcon="@Icons.Material.Outlined.Comment" />
            
            <!-- 5. RIEPILOGO RIGA (Full Width, evidenziato) -->
            <MudPaper Elevation="3" Class="pa-4" 
                     Style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <MudText Typo="Typo.subtitle1" Class="mb-3" Style="font-weight: 600;">
                    <MudIcon Icon="@Icons.Material.Outlined.Summarize" Class="mr-2" Size="Size.Small" />
                    @TranslationService.GetTranslation("documents.rowSummary", "Riepilogo Riga")
                </MudText>
                <MudGrid Spacing="2">
                    <MudItem xs="6" sm="3">
                        <MudText Typo="Typo.caption">
                            @TranslationService.GetTranslation("documents.netSubtotal", "Subtotale Netto")
                        </MudText>
                        <MudText Typo="Typo.h6" Style="font-weight: 600;">
                            @GetSubtotal().ToString("C2")
                        </MudText>
                    </MudItem>
                    <MudItem xs="6" sm="3">
                        <MudText Typo="Typo.caption">
                            @TranslationService.GetTranslation("documents.vatTax", "Imposta IVA")
                        </MudText>
                        <MudText Typo="Typo.h6" Style="font-weight: 600;">
                            @GetVatAmount().ToString("C2")
                        </MudText>
                    </MudItem>
                    <MudItem xs="6" sm="3">
                        <MudText Typo="Typo.caption">
                            @TranslationService.GetTranslation("documents.totalDiscount", "Sconto Totale")
                        </MudText>
                        <MudText Typo="Typo.h6" Style="font-weight: 600; color: #90EE90;">
                            -@GetTotalDiscount().ToString("C2")
                        </MudText>
                    </MudItem>
                    <MudItem xs="6" sm="3">
                        <MudText Typo="Typo.caption">
                            ðŸ’Ž @TranslationService.GetTranslation("documents.lineTotal", "TOTALE RIGA")
                        </MudText>
                        <MudText Typo="Typo.h5" Style="font-weight: 700;">
                            @GetLineTotal().ToString("C2")
                        </MudText>
                    </MudItem>
                </MudGrid>
            </MudPaper>
            
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel" Variant="Variant.Outlined">
            @TranslationService.GetTranslation("common.close", "Chiudi")
        </MudButton>
        <MudButton Color="Color.Primary" 
                   OnClick="SaveAndContinue" 
                   Disabled="@(!IsValid())"
                   Variant="Variant.Filled"
                   StartIcon="@(_isEditMode ? Icons.Material.Filled.Save : Icons.Material.Filled.Add)">
            @TranslationService.GetTranslation(_isEditMode ? "common.save" : "documents.addAndContinue", _isEditMode ? "Salva" : "Aggiungi e Continua")
        </MudButton>
    </DialogActions>
</MudDialog>
