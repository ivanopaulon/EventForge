@using EventForge.DTOs.Documents
@using EventForge.DTOs.Products
@using EventForge.DTOs.UnitOfMeasures
@using EventForge.DTOs.VatRates
@using EventForge.DTOs.Common
@using EventForge.Client.Models.Documents
@using EventForge.Client.Services.Documents
@using EventForge.Client.Shared.Components.Products
@using MudBlazor

<MudDialog MaxWidth="MaxWidth.Large" FullWidth="true" @onkeydown="@OnDialogKeyDown" tabindex="-1">
    <TitleContent>
        <div class="@DialogStyleConstants.Classes.DialogTitle">
            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Style="width: 100%;">
                <MudText Typo="Typo.h6">
                    <MudIcon Icon="@(_isEditMode? DialogStyleConstants.Icons.Edit : DialogStyleConstants.Icons.AddRow)" Class="mr-2" />
                    @TranslationService.GetTranslation(_isEditMode ? "documents.editRow" : "documents.addRow", _isEditMode ? "Modifica Riga" : "Aggiungi Riga")
                </MudText>

                @if (!_isEditMode)
                {
                    <MudButtonGroup Variant="Variant.Outlined" Color="Color.Primary" Size="Size.Small">
                        <MudTooltip Text="@TranslationService.GetTranslation("documents.standardModeTooltip", "Modalit√† completa con tutti i campi")">
                            <MudButton StartIcon="@Icons.Material.Outlined.Edit"
                                       Color="@(_dialogMode == DialogMode.Standard ? Color.Primary : Color.Default)"
                                       Variant="@(_dialogMode == DialogMode.Standard ? Variant.Filled : Variant.Outlined)"
                                       OnClick="@(() => SetDialogMode(DialogMode.Standard))">
                                @TranslationService.GetTranslation("documents.standardMode", "Standard")
                            </MudButton>
                        </MudTooltip>

                        <MudTooltip Text="@TranslationService.GetTranslation("documents.continuousScanTooltip", "Scansione continua con barcode scanner")">
                            <MudButton StartIcon="@Icons.Material.Outlined.QrCodeScanner"
                                       Color="@(_dialogMode == DialogMode.ContinuousScan ? Color.Primary : Color.Default)"
                                       Variant="@(_dialogMode == DialogMode.ContinuousScan ? Variant.Filled : Variant.Outlined)"
                                       OnClick="@(() => SetDialogMode(DialogMode.ContinuousScan))">
                                @TranslationService.GetTranslation("documents.continuousScanMode", "Scan")
                                @if (_continuousScanCount > 0)
                                {
                                    <MudBadge Content="@_continuousScanCount" Color="Color.Success" Overlap="true" Class="ml-2" />
                                }
                            </MudButton>
                        </MudTooltip>
                    </MudButtonGroup>
                }
            </MudStack>
        </div>
    </TitleContent>
    <DialogContent>
        <!-- Save progress bar - PR #2c-Part2 Commit 3 -->
        @if (_isSaving)
        {
            <div class="save-progress"></div>
        }

        <div class="@DialogStyleConstants.Classes.DialogContent">
            @if (_isLoadingData)
            {
                <MudStack Spacing="2" Class="mb-4">
                    <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
                    <MudText Typo="Typo.caption" Align="Align.Center" Color="Color.Primary">
                        @TranslationService.GetTranslation("common.loading", "Caricamento in corso...")
                    </MudText>
                </MudStack>
            }

            @if (_validationErrors.Any())
            {
                <MudAlert Severity="Severity.Error" Class="mb-4" Variant="Variant.Filled"
                          CloseIcon="@Icons.Material.Filled.Close"
                          CloseIconClicked="@(() => _validationErrors.Clear())">
                    <MudText Typo="Typo.subtitle2" Class="mb-2">
                        <b>@TranslationService.GetTranslation("validation.errors", "Errori di validazione"):</b>
                    </MudText>
                    <MudList T="string" Dense="true">
                        @foreach (var error in _validationErrors)
                        {
                            <MudListItem T="string" Icon="@Icons.Material.Filled.Error" IconColor="Color.Error">
                                @error
                            </MudListItem>
                        }
                    </MudList>
                </MudAlert>
            }

            <!-- Keyboard Shortcuts Help Panel - PR #2c-Part1 Commit 2 -->

            <MudStack Spacing="3">

                @if (_dialogMode == DialogMode.ContinuousScan)
                {
                    <!-- CONTINUOUS SCAN MODE INTERFACE -->
                    <MudPaper Elevation="3" Class="pa-4" Style="background: linear-gradient(135deg, #e3f2fd 0%, #90caf9 50%, #2196f3 100%);">
                        <MudStack Spacing="3">
                            <!-- Info Alert -->
                            <MudAlert Severity="Severity.Info" Dense="true" Variant="Variant.Filled" Elevation="2">
                                üîç <strong>Scansiona i codici a barre</strong> - ogni scansione aggiunge automaticamente 1 unit√†<br />
                                üí° Prodotti gi√† presenti vengono aggiornati automaticamente<br />
                                ‚ö° Premi <kbd>ESC</kbd> per tornare alla modalit√† standard
                            </MudAlert>

                            <MudTextField @bind-Value="_continuousScanInput"
                                          @ref="_continuousScanField"
                                          Label="Scansiona Codice a Barre"
                                          Variant="Variant.Outlined"
                                          @onkeydown="@OnContinuousScanKeyDown"
                                          Adornment="Adornment.Start"
                                          AdornmentIcon="@Icons.Material.Filled.QrCodeScanner"
                                          AdornmentColor="Color.Primary"
                                          Immediate="true"
                                          Disabled="_isProcessingContinuousScan"
                                          Style="font-size: 1.3rem; font-weight: 500;" />

                            @if (_isProcessingContinuousScan)
                            {
                                <MudProgressLinear Color="Color.Primary" Indeterminate="true" Size="Size.Small" Class="mt-2" />
                            }

                            <!-- Stats Cards -->
                            <MudGrid Spacing="2">
                                <MudItem xs="12" sm="4">
                                    <MudPaper Elevation="2" Class="pa-3" Style="text-align: center; background: white;">
                                        <MudIcon Icon="@Icons.Material.Filled.QrCodeScanner" Color="Color.Primary" Size="Size.Medium" />
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">Scansioni Totali</MudText>
                                        <MudText Typo="Typo.h3" Color="Color.Primary">@_continuousScanCount</MudText>
                                    </MudPaper>
                                </MudItem>

                                <MudItem xs="12" sm="4">
                                    <MudPaper Elevation="2" Class="pa-3" Style="text-align: center; background: white;">
                                        <MudIcon Icon="@Icons.Material.Filled.Inventory" Color="Color.Success" Size="Size.Medium" />
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">Prodotti Unici</MudText>
                                        <MudText Typo="Typo.h3" Color="Color.Success">@_uniqueProductsCount</MudText>
                                    </MudPaper>
                                </MudItem>

                                <MudItem xs="12" sm="4">
                                    <MudPaper Elevation="2" Class="pa-3" Style="text-align: center; background: white;">
                                        <MudIcon Icon="@Icons.Material.Filled.Speed" Color="Color.Info" Size="Size.Medium" />
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">Velocit√†</MudText>
                                        <MudText Typo="Typo.h3" Color="Color.Info">@_scansPerMinute<MudText Typo="Typo.caption" Inline="true">/min</MudText></MudText>
                                    </MudPaper>
                                </MudItem>
                            </MudGrid>

                            <!-- Recent Scans List -->
                            @if (_recentContinuousScans.Any())
                            {
                                <MudPaper Elevation="2" Class="pa-3" Style="background-color: white; max-height: 300px; overflow-y: auto;">
                                    <MudText Typo="Typo.subtitle1">
                                        <MudIcon Icon="@Icons.Material.Filled.History" Size="Size.Small" Class="mr-2" />
                                        Ultimi Prodotti Scansionati
                                    </MudText>

                                    <MudList T="string" Dense="true">
                                        @foreach (var scan in _recentContinuousScans.Take(5))
                                        {
                                            <MudListItem T="string" Icon="@Icons.Material.Filled.CheckCircle" IconColor="Color.Success">
                                                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Style="width: 100%;">
                                                    <MudStack Spacing="0">
                                                        <MudText Typo="Typo.body2"><strong>@scan.ProductName</strong></MudText>
                                                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                                                            @scan.Barcode ¬∑ Qty: @scan.Quantity ¬∑ ‚Ç¨@scan.UnitPrice.ToString("F2")
                                                        </MudText>
                                                    </MudStack>
                                                    <MudChip T="string" Size="Size.Small" Color="Color.Info" Icon="@Icons.Material.Filled.AccessTime">
                                                        @GetTimeAgo(scan.Timestamp)
                                                    </MudChip>
                                                </MudStack>
                                            </MudListItem>
                                        }
                                    </MudList>
                                </MudPaper>
                            }

                            <!-- Finalize Button -->
                            <MudButton StartIcon="@Icons.Material.Filled.Check"
                                       Variant="Variant.Filled"
                                       Color="Color.Success"
                                       OnClick="@(() => MudDialog.Close())"
                                       Disabled="@(_continuousScanCount == 0)"
                                       FullWidth="true">
                                Finalizza e Chiudi (@_continuousScanCount scansioni)
                            </MudButton>

                        </MudStack>
                    </MudPaper>
                }

                @if (_dialogMode != DialogMode.ContinuousScan)
                {
                    @if (_dialogMode == DialogMode.Standard)
                    {
                        <!-- UNIFIED PRODUCT SCANNER: Replaces DocumentRowBarcodeScanner, MudAutocomplete, and ProductQuickInfo -->
                        <UnifiedProductScanner SelectedProduct="@_selectedProduct"
                                               SelectedProductChanged="@OnProductSelectedAsync"
                                               Title="@TranslationService.GetTranslation("documents.product", "Prodotto")"
                                               Placeholder="@TranslationService.GetTranslation("documents.searchOrScanProduct", "Scansiona barcode o cerca per nome...")"
                                               SearchHelperText="@TranslationService.GetTranslation("documents.searchProductHelper", "Premi Invio per cercare come barcode")"
                                               ShowProductInfo="true"
                                               SearchMode="ProductSearchMode.Both"
                                               EditMode="ProductEditMode.Dialog"
                                               CreateMode="ProductCreateMode.Delegate"
                                               AllowClear="true"
                                               ShowCurrentStock="false"
                                               AutoFocus="!_isEditMode"
                                               OnProductWithCodeFound="@HandleProductWithCodeFound"
                                               OnProductNotFound="@ShowProductNotFoundDialog"
                                               OnProductUpdated="@HandleProductUpdated" />

                        <!-- Recent Transactions -->
                        @if (_state.SelectedProduct != null)
                        {
                            <DocumentRowRecentTransactions ProductId="@_state.SelectedProduct.Id"
                                                           TransactionType="@DetermineTransactionType()"
                                                           PartyId="@GetBusinessPartyId()"
                                                           OnPriceApplied="@HandleRecentPriceAppliedWithFeedback"
                                                           MaxTransactions="3" />
                        }

                        <!-- SEZIONE 3: CAMPI MODIFICABILI UNIFICATI (Bordo Blu) -->
                        <MudGrid Spacing="2">
                            <!-- Prima riga: Quantit√† + Unit√† di Misura -->
                            <MudItem xs="12" sm="6">
                                <MudNumericField @bind-Value="_model.Quantity"
                                                 Label="@TranslationService.GetTranslation("documents.quantity", "Quantit√†")"
                                                 Variant="Variant.Outlined"
                                                 Required="true"
                                                 Min="0.01m"
                                                 Step="1"
                                                 Adornment="Adornment.Start"
                                                 AdornmentIcon="@Icons.Material.Outlined.Numbers"
                                                 AdornmentColor="Color.Primary" />
                            </MudItem>

                            <MudItem xs="12" sm="6">
                                <MudSelect Value="_selectedUnitOfMeasureId"
                                           T="Guid ?"
                                           ValueChanged="@OnUnitOfMeasureChanged"
                                           Label="@TranslationService.GetTranslation("products.unitOfMeasure", "Unit√† di Misura")"
                                           Variant="Variant.Outlined"
                                           Required="true"
                                           Adornment="Adornment.Start"
                                           AdornmentIcon="@Icons.Material.Outlined.Straighten"
                                           AdornmentColor="Color.Primary"
                                           Disabled="@(_availableUnits.Count == 0)">
                                    @foreach (var unit in _availableUnits)
                                    {
                                        var uom = _allUnitsOfMeasure.FirstOrDefault(u => u.Id == unit.UnitOfMeasureId);
                                        if (uom != null)
                                        {
                                            <MudSelectItem T="Guid ?" Value="@uom.Id">@uom.Symbol - @uom.Name</MudSelectItem>
                                        }
                                    }
                                </MudSelect>
                            </MudItem>

                            <!-- Seconda riga: Prezzo + Sconto % + Sconto ‚Ç¨ -->
                            <MudItem xs="12" sm="4">
                                <MudNumericField Value="_model.UnitPrice"
                                                 ValueChanged="@((decimal val) => OnPriceManuallyChanged(val))"
                                                 Label="@TranslationService.GetTranslation("documents.price", "Prezzo")"
                                                 Variant="Variant.Outlined"
                                                 Required="true"
                                                 Min="0"
                                                 Format="F2"
                                                 Adornment="Adornment.Start"
                                                 AdornmentIcon="@Icons.Material.Outlined.Euro"
                                                 AdornmentColor="Color.Success">
                                    <HelperTextContent>
                                        @if (_model.AppliedPriceListId.HasValue)
                                        {
                                            <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                                                <MudIcon Icon="@Icons.Material.Outlined.PriceCheck" Size="Size.Small" Color="Color.Info" />
                                                <MudText Typo="Typo.caption" Color="Color.Info">
                                                    @TranslationService.GetTranslation("documents.fromPriceList", "Da listino"): @GetAppliedPriceListName()
                                                </MudText>
                                                @if (_model.IsPriceManual)
                                                {
                                                    <MudChip T="string" Size="Size.Small" Color="Color.Warning" Variant="Variant.Text">
                                                        @TranslationService.GetTranslation("documents.manualOverride", "Modificato")
                                                    </MudChip>
                                                }
                                            </MudStack>
                                        }
                                        else
                                        {
                                            <MudText Typo="Typo.caption">@GetPriceHelperText()</MudText>
                                        }
                                    </HelperTextContent>
                                </MudNumericField>
                            </MudItem>

                            <MudItem xs="12" sm="4">
                                <MudNumericField Value="_model.LineDiscount"
                                                 ValueChanged="@((decimal val) => OnDiscountPercentChanged(val))"
                                                 Label="@TranslationService.GetTranslation("documents.discountPercent", "Sconto %")"
                                                 Variant="Variant.Outlined"
                                                 Min="0"
                                                 Max="100"
                                                 Step="0.1m"
                                                 Format="F2"
                                                 Adornment="Adornment.Start"
                                                 AdornmentIcon="@Icons.Material.Outlined.Percent"
                                                 AdornmentColor="Color.Warning"
                                                 Disabled="@(_model.LineDiscountValue > 0)"
                                                 HelperText="@(_model.LineDiscountValue > 0 ? TranslationService.GetTranslation("documents.discountPercentDisabled", "‚ö†Ô∏è Disabilitato: sconto ‚Ç¨ attivo") : "")" />
                            </MudItem>

                            <MudItem xs="12" sm="4">
                                <MudNumericField Value="_model.LineDiscountValue"
                                                 ValueChanged="@((decimal val) => OnDiscountAmountChanged(val))"
                                                 Label="@TranslationService.GetTranslation("documents.discountAmount", "Sconto ‚Ç¨")"
                                                 Variant="Variant.Outlined"
                                                 Min="0"
                                                 Format="F2"
                                                 Adornment="Adornment.Start"
                                                 AdornmentIcon="@Icons.Material.Outlined.EuroSymbol"
                                                 AdornmentColor="Color.Warning"
                                                 Disabled="@(_model.LineDiscount > 0)"
                                                 HelperText="@(_model.LineDiscount > 0 ? TranslationService.GetTranslation("documents.discountAmountDisabled", "‚ö†Ô∏è Disabilitato: sconto % attivo") : "")" />
                            </MudItem>
                        </MudGrid>
                    }
                    else
                    {
                        <!-- NON-STANDARD MODE: Keep original barcode scanner -->
                        <DocumentRowBarcodeScanner @ref="_barcodeScannerRef"
                                                   IsEnabled="true"
                                                   AutoFocus="!_isEditMode"
                                                   OnBarcodeScanned="@HandleBarcodeScanned"
                                                   OnScanStart="@(() => Task.CompletedTask)"
                                                   OnScanEnd="@(() => Task.CompletedTask)" />
                    }

                    <!-- 3.5 MERGE DUPLICATES CHECKBOX (Only in Add Mode) -->
                    @if (!_isEditMode && _dialogMode == DialogMode.Standard)
                    {
                        <MudPaper Elevation="1" Class="pa-3" Style="background-color: var(--mud-palette-background-grey);">
                            <MudCheckBox T="bool"
                                         @bind-Checked="_model.MergeDuplicateProducts"
                                         Label="@TranslationService.GetTranslation("documents.mergeDuplicates", "Somma quantit√† se l'articolo √® gi√† presente")"
                                         Color="Color.Primary"
                                         Disabled="@(_selectedProduct == null)">
                                @if (_selectedProduct == null)
                                {
                                    <MudTooltip Text="@TranslationService.GetTranslation("documents.mergeDuplicatesDisabledHelp", "Seleziona un prodotto dall'autocomplete per abilitare la fusione")">
                                        <MudIcon Icon="@Icons.Material.Outlined.Info" Size="Size.Small" Color="Color.Warning" Class="ml-1" />
                                    </MudTooltip>
                                }
                                else
                                {
                                    <MudTooltip Text="@TranslationService.GetTranslation("documents.mergeDuplicatesHelp", "When enabled, if you add the same product with the same price, VAT and discounts, the quantity will be summed to the existing row instead of creating a new one")">
                                        <MudIcon Icon="@Icons.Material.Outlined.Info" Size="Size.Small" Color="Color.Info" Class="ml-1" />
                                    </MudTooltip>
                                }
                            </MudCheckBox>

                            @* Alert informativo quando merge √® attivo *@
                            @if (_model.MergeDuplicateProducts && _selectedProduct != null)
                            {
                                <MudAlert Severity="Severity.Info" Dense="true" Class="mt-2">
                                    <MudText Typo="Typo.caption">
                                        <MudIcon Icon="@Icons.Material.Outlined.MergeType" Size="Size.Small" Class="mr-1" />
                                        <strong>@TranslationService.GetTranslation("documents.mergeDuplicatesActivePrefix", "Merge Mode Active:")</strong>
                                        @(" ")
                                        @TranslationService.GetTranslation("documents.mergeDuplicatesActiveInfo", "If an identical row exists (same product, price, VAT and discounts), the quantity will be summed.")
                                    </MudText>
                                </MudAlert>
                            }
                        </MudPaper>
                    }

                }

                @if (_dialogMode == DialogMode.Standard)
                {
                    <!-- 5. RIEPILOGO RIGA (Full Width, evidenziato) -->
                    <DocumentRowSummary NetSubtotal="@GetSubtotal()"
                                        VatAmount="@GetVatAmount()"
                                        TotalDiscount="@GetTotalDiscount()"
                                        LineTotal="@GetLineTotal()" />
                }

            </MudStack>
        </div>
    </DialogContent>
    <DialogActions>
        <div class="@DialogStyleConstants.Classes.DialogActions">
            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Style="width: 100%;">
                <MudText Typo="Typo.caption" Class="ml-2" Style="color: var(--mud-palette-text-secondary);">
                    <MudIcon Icon="@Icons.Material.Outlined.Keyboard" Size="Size.Small" />
                    @TranslationService.GetTranslation("documents.shortcutEnter", "Enter: Salva") ¬∑
                    @TranslationService.GetTranslation("documents.shortcutCtrlE", "Ctrl+E: Modifica Prodotto") ¬∑
                    @TranslationService.GetTranslation("documents.shortcutEsc", "Esc: Chiudi")
                </MudText>
                <MudStack Row="true" Spacing="2">
                    <MudButton OnClick="Cancel" Variant="Variant.Outlined" Disabled="@_isSaving">
                        @TranslationService.GetTranslation("common.close", "Chiudi")
                    </MudButton>

                    <!-- Save & Continue button with tooltip - PR #2c-Part2 Commit 2 & 3 -->
                    <MudTooltip Arrow="true" Placement="Placement.Top">
                        <ChildContent>
                            <MudButton Color="Color.Primary"
                                       OnClick="SaveAndContinue"
                                       Disabled="@(!IsValid() || _isSaving)"
                                       Class="@(_isSaving ? "button-loading" : "")"
                                       Variant="Variant.Filled">
                                @if (_isSaving)
                                {
                                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                                }
                                else
                                {
                                    <MudIcon Icon="@(_isEditMode? DialogStyleConstants.Icons.Save : DialogStyleConstants.Icons.Add)" Class="mr-1" />
                                }
                                @TranslationService.GetTranslation(_isEditMode ? "common.save" : "documents.addAndContinue", _isEditMode ? "Salva" : "Aggiungi e Continua")
                            </MudButton>
                        </ChildContent>
                        <TooltipContent>
                            <div class="tooltip-with-hint">
                                <span>@(_isEditMode ? "Salva e chiudi" : "Aggiungi e continua")</span>
                                <kbd class="tooltip-keyboard-hint">@(_isEditMode ? "Ctrl+S" : "Ctrl+Enter")</kbd>
                            </div>
                        </TooltipContent>
                    </MudTooltip>
                </MudStack>
            </MudStack>
        </div>
    </DialogActions>
</MudDialog>
