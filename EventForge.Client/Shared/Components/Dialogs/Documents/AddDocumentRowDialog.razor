@using EventForge.DTOs.Documents
@using EventForge.DTOs.Products
@using EventForge.DTOs.UnitOfMeasures
@using EventForge.DTOs.VatRates
@using EventForge.DTOs.Common
@using EventForge.Client.Models.Documents
@using EventForge.Client.Services.Documents
@using MudBlazor

<MudDialog MaxWidth="MaxWidth.Large" FullWidth="true" @onkeydown="@OnDialogKeyDown" tabindex="-1">
    <TitleContent>
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Style="width: 100%;">
            <MudText Typo="Typo.h6">
                <MudIcon Icon="@(_isEditMode ? Icons.Material.Outlined.Edit : Icons.Material.Outlined.Add)" Class="mr-2" />
                @TranslationService.GetTranslation(_isEditMode ? "documents.editRow" : "documents.addRow", _isEditMode ? "Modifica Riga" : "Aggiungi Riga")
            </MudText>
            
            @if (!_isEditMode)
            {
                <MudButtonGroup Variant="Variant.Outlined" Color="Color.Primary" Size="Size.Small">
                    <MudTooltip Text="Modalit√† completa con tutti i campi">
                        <MudButton StartIcon="@Icons.Material.Outlined.Edit"
                                  Color="@(_dialogMode == DialogMode.Standard ? Color.Primary : Color.Default)"
                                  Variant="@(_dialogMode == DialogMode.Standard ? Variant.Filled : Variant.Outlined)"
                                  OnClick="@(() => SetDialogMode(DialogMode.Standard))">
                            Standard
                        </MudButton>
                    </MudTooltip>
                    
                    <MudTooltip Text="Inserimento rapido con campi essenziali">
                        <MudButton StartIcon="@Icons.Material.Filled.FlashOn"
                                  Color="@(_dialogMode == DialogMode.QuickAdd ? Color.Primary : Color.Default)"
                                  Variant="@(_dialogMode == DialogMode.QuickAdd ? Variant.Filled : Variant.Outlined)"
                                  OnClick="@(() => SetDialogMode(DialogMode.QuickAdd))">
                            Quick
                        </MudButton>
                    </MudTooltip>
                    
                    <MudTooltip Text="Scansione continua con barcode scanner">
                        <MudButton StartIcon="@Icons.Material.Outlined.QrCodeScanner"
                                  Color="@(_dialogMode == DialogMode.ContinuousScan ? Color.Primary : Color.Default)"
                                  Variant="@(_dialogMode == DialogMode.ContinuousScan ? Variant.Filled : Variant.Outlined)"
                                  OnClick="@(() => SetDialogMode(DialogMode.ContinuousScan))">
                            Scan
                            @if (_continuousScanCount > 0)
                            {
                                <MudBadge Content="@_continuousScanCount" Color="Color.Success" Overlap="true" Class="ml-2" />
                            }
                        </MudButton>
                    </MudTooltip>
                </MudButtonGroup>
            }
        </MudStack>
    </TitleContent>
    <DialogContent>
        @if (_isLoadingData)
        {
            <MudStack Spacing="2" Class="mb-4">
                <MudProgressLinear Indeterminate="true" Color="Color.Primary"/>
                <MudText Typo="Typo.caption" Align="Align.Center" Color="Color.Primary">
                    @TranslationService.GetTranslation("common.loading", "Caricamento in corso...")
                </MudText>
            </MudStack>
        }

        @if (_validationErrors.Any())
        {
            <MudAlert Severity="Severity.Error" Class="mb-4" Variant="Variant.Filled" 
                      CloseIcon="@Icons.Material.Filled.Close" 
                      CloseIconClicked="@(() => _validationErrors.Clear())">
                <MudText Typo="Typo.subtitle2" Class="mb-2">
                    <b>@TranslationService.GetTranslation("validation.errors", "Errori di validazione"):</b>
                </MudText>
                <MudList T="string" Dense="true">
                    @foreach (var error in _validationErrors)
                    {
                        <MudListItem T="string" Icon="@Icons.Material.Filled.Error" IconColor="Color.Error">
                            @error
                        </MudListItem>
                    }
                </MudList>
            </MudAlert>
        }

        <MudStack Spacing="3">
            
            @if (_dialogMode == DialogMode.ContinuousScan)
            {
                <!-- CONTINUOUS SCAN MODE INTERFACE -->
                <MudPaper Elevation="3" Class="pa-4" Style="background: linear-gradient(135deg, #e3f2fd 0%, #90caf9 50%, #2196f3 100%);">
                    <MudStack Spacing="3">
                        
                        <!-- Header -->
                        <MudText Typo="Typo.h5" Color="Color.Surface" Align="Align.Center" Style="text-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                            <MudIcon Icon="@Icons.Material.Filled.QrCodeScanner" Size="Size.Large" Class="mr-2" />
                            Modalit√† Lettura Continua
                        </MudText>
                        
                        <!-- Info Alert -->
                        <MudAlert Severity="Severity.Info" Dense="true" Variant="Variant.Filled" Elevation="2">
                            üîç <strong>Scansiona i codici a barre</strong> - ogni scansione aggiunge automaticamente 1 unit√†<br/>
                            üí° Prodotti gi√† presenti vengono aggiornati automaticamente<br/>
                            ‚ö° Premi <kbd>ESC</kbd> per tornare alla modalit√† standard
                        </MudAlert>
                        
                        <!-- Scanner Input -->
                        <MudPaper Elevation="4" Class="pa-3" Style="background-color: white; border-left: 4px solid #2196f3;">
                            <MudTextField @bind-Value="_continuousScanInput"
                                         @ref="_continuousScanField"
                                         Label="Scansiona Codice a Barre"
                                         Variant="Variant.Outlined"
                                         @onkeydown="@OnContinuousScanKeyDown"
                                         Adornment="Adornment.Start"
                                         AdornmentIcon="@Icons.Material.Filled.QrCodeScanner"
                                         AdornmentColor="Color.Primary"
                                         Immediate="true"
                                         Disabled="_isProcessingContinuousScan"
                                         Style="font-size: 1.3rem; font-weight: 500;" />
                            
                            @if (_isProcessingContinuousScan)
                            {
                                <MudProgressLinear Color="Color.Primary" Indeterminate="true" Size="Size.Small" Class="mt-2" />
                            }
                        </MudPaper>
                        
                        <!-- Stats Cards -->
                        <MudGrid Spacing="2">
                            <MudItem xs="12" sm="4">
                                <MudPaper Elevation="2" Class="pa-3" Style="text-align: center; background: white;">
                                    <MudIcon Icon="@Icons.Material.Filled.QrCodeScanner" Color="Color.Primary" Size="Size.Medium" />
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">Scansioni Totali</MudText>
                                    <MudText Typo="Typo.h3" Color="Color.Primary">@_continuousScanCount</MudText>
                                </MudPaper>
                            </MudItem>
                            
                            <MudItem xs="12" sm="4">
                                <MudPaper Elevation="2" Class="pa-3" Style="text-align: center; background: white;">
                                    <MudIcon Icon="@Icons.Material.Filled.Inventory" Color="Color.Success" Size="Size.Medium" />
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">Prodotti Unici</MudText>
                                    <MudText Typo="Typo.h3" Color="Color.Success">@_uniqueProductsCount</MudText>
                                </MudPaper>
                            </MudItem>
                            
                            <MudItem xs="12" sm="4">
                                <MudPaper Elevation="2" Class="pa-3" Style="text-align: center; background: white;">
                                    <MudIcon Icon="@Icons.Material.Filled.Speed" Color="Color.Info" Size="Size.Medium" />
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">Velocit√†</MudText>
                                    <MudText Typo="Typo.h3" Color="Color.Info">@_scansPerMinute<MudText Typo="Typo.caption" Inline="true">/min</MudText></MudText>
                                </MudPaper>
                            </MudItem>
                        </MudGrid>
                        
                        <!-- Recent Scans List -->
                        @if (_recentContinuousScans.Any())
                        {
                            <MudPaper Elevation="2" Class="pa-3" Style="background-color: white; max-height: 300px; overflow-y: auto;">
                                <MudText Typo="Typo.subtitle1">
                                    <MudIcon Icon="@Icons.Material.Filled.History" Size="Size.Small" Class="mr-2" />
                                    Ultimi Prodotti Scansionati
                                </MudText>
                                
                                <MudList T="string" Dense="true">
                                    @foreach (var scan in _recentContinuousScans.Take(5))
                                    {
                                        <MudListItem T="string" Icon="@Icons.Material.Filled.CheckCircle" IconColor="Color.Success">
                                            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Style="width: 100%;">
                                                <MudStack Spacing="0">
                                                    <MudText Typo="Typo.body2"><strong>@scan.ProductName</strong></MudText>
                                                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                                                        @scan.Barcode ¬∑ Qty: @scan.Quantity ¬∑ ‚Ç¨@scan.UnitPrice.ToString("F2")
                                                    </MudText>
                                                </MudStack>
                                                <MudChip T="string" Size="Size.Small" Color="Color.Info" Icon="@Icons.Material.Filled.AccessTime">
                                                    @GetTimeAgo(scan.Timestamp)
                                                </MudChip>
                                            </MudStack>
                                        </MudListItem>
                                    }
                                </MudList>
                            </MudPaper>
                        }
                        
                        <!-- Finalize Button -->
                        <MudButton StartIcon="@Icons.Material.Filled.Check"
                                  Variant="Variant.Filled"
                                  Color="Color.Success"
                                  OnClick="@(() => MudDialog.Close())"
                                  Disabled="@(_continuousScanCount == 0)"
                                  FullWidth="true">
                            Finalizza e Chiudi (@_continuousScanCount scansioni)
                        </MudButton>
                        
                    </MudStack>
                </MudPaper>
            }
            
            @if (_dialogMode != DialogMode.ContinuousScan)
            {
            <!-- 1. BARCODE SCANNER (Full Width) -->
            <MudPaper Elevation="1" Class="pa-3" Style="background-color: var(--mud-palette-background-grey);">
                <MudStack Spacing="2">
                    <MudText Typo="Typo.subtitle2">
                        <MudIcon Icon="@Icons.Material.Outlined.QrCodeScanner" Class="mr-2" Size="Size.Small" />
                        @TranslationService.GetTranslation("warehouse.scanBarcode", "Scansiona Codice a Barre")
                    </MudText>
                    <MudTextField @bind-Value="_barcodeInput"
                                  Label="@TranslationService.GetTranslation("warehouse.barcodeInput", "Codice a Barre")"
                                  Variant="Variant.Outlined"
                                  @onkeydown="@OnBarcodeKeyDown"
                                  @ref="_barcodeField"
                                  Adornment="Adornment.Start"
                                  AdornmentIcon="@Icons.Material.Outlined.QrCode"
                                  HelperText="@TranslationService.GetTranslation("warehouse.scanOrTypeBarcode", "Scansiona o digita il codice a barre e premi Invio")" />
                </MudStack>
            </MudPaper>
            
            @if (_dialogMode == DialogMode.QuickAdd)
            {
                <!-- QUICK ADD MODE: Minimalist interface -->
                <MudPaper Elevation="2" Class="pa-3" Style="background-color: var(--mud-palette-success-lighten);">
                    <MudText Typo="Typo.subtitle2" Class="mb-3">
                        <MudIcon Icon="@Icons.Material.Filled.FlashOn" Class="mr-2" Size="Size.Small" />
                        @TranslationService.GetTranslation("documents.quickAddModeActive", "Quick Add Mode Active")
                    </MudText>
                    <MudGrid Spacing="2">
                        <MudItem xs="12" sm="8">
                            <MudTextField T="string"
                                         Label="@TranslationService.GetTranslation("documents.description", "Descrizione *")"
                                         @bind-Value="_model.Description"
                                         Variant="Variant.Outlined"
                                         Required="true"
                                         ReadOnly="true"
                                         Adornment="Adornment.Start"
                                         AdornmentIcon="@Icons.Material.Outlined.Description" />
                        </MudItem>
                        <MudItem xs="12" sm="4">
                            <MudNumericField T="decimal"
                                            Label="@TranslationService.GetTranslation("documents.quantity", "Quantit√† *")"
                                            @bind-Value="_model.Quantity"
                                            Min="0.0001m"
                                            Variant="Variant.Outlined"
                                            @ref="_quantityField"
                                            Adornment="Adornment.Start"
                                            AdornmentIcon="@Icons.Material.Outlined.Numbers" />
                        </MudItem>
                    </MudGrid>
                    
                    <!-- Recent Quick Entries -->
                    @if (_recentQuickEntries.Any())
                    {
                        <MudDivider Class="my-3" />
                        <MudText Typo="Typo.caption" Class="mb-2">
                            @TranslationService.GetTranslation("documents.recentEntries", "Recent Entries")
                        </MudText>
                        <MudStack Spacing="1">
                            @foreach (var entry in _recentQuickEntries.Take(5))
                            {
                                <MudChip T="string" Size="Size.Small" Color="Color.Success" Variant="Variant.Outlined">
                                    @entry.Description - Qty: @entry.Quantity (@entry.Timestamp.ToString("HH:mm:ss"))
                                </MudChip>
                            }
                        </MudStack>
                    }
                </MudPaper>
            }
            
            @if (_dialogMode == DialogMode.Standard)
            {
                <!-- 2. PRODOTTO E CAMPI ESSENZIALI (Semplificato) -->
                <MudPaper Elevation="2" Class="pa-3">
                    <MudStack Spacing="3">
                        
                        <!-- Prodotto -->
                        <MudStack Spacing="1">
                            <MudText Typo="Typo.caption" Style="color: var(--mud-palette-text-secondary);">
                                <MudIcon Icon="@Icons.Material.Outlined.Inventory" Size="Size.Small" Class="mr-1" />
                                @TranslationService.GetTranslation("documents.product", "Prodotto")
                            </MudText>
                            <MudAutocomplete T="ProductDto"
                                            Value="_selectedProduct"
                                            ValueChanged="@OnProductSelected"
                                            SearchFunc="@SearchProductsAsync"
                                            ToStringFunc="@(p => p?.Name ?? string.Empty)"
                                            Variant="Variant.Outlined"
                                            Dense="true"
                                            Margin="Margin.Dense"
                                            MinCharacters="2"
                                            DebounceInterval="300"
                                            ShowProgressIndicator="true"
                                            Clearable="true"
                                            ResetValueOnEmptyText="false"
                                            CoerceText="false"
                                            CoerceValue="false"
                                            Placeholder="@TranslationService.GetTranslation("documents.searchProductHelp", "Cerca prodotto (min 2 caratteri)...")"
                                            Adornment="Adornment.Start"
                                            AdornmentIcon="@Icons.Material.Outlined.Inventory"
                                            aria-label="@TranslationService.GetTranslation("documents.product", "Prodotto")">
                                <ItemTemplate Context="product">
                                    <MudStack Spacing="0">
                                        <MudText Typo="Typo.body2" Style="font-weight: 500;">@product.Name</MudText>
                                        <MudText Typo="Typo.caption" Style="color: var(--mud-palette-text-secondary);">
                                            @product.Code ¬∑ @(product.DefaultPrice?.ToString("C2") ?? "N/A")
                                        </MudText>
                                    </MudStack>
                                </ItemTemplate>
                                <NoItemsTemplate>
                                    <MudText Typo="Typo.body2" Align="Align.Center" Class="py-2">
                                        @TranslationService.GetTranslation("documents.noProductsFound", "Nessun prodotto trovato")
                                    </MudText>
                                </NoItemsTemplate>
                            </MudAutocomplete>
                        </MudStack>
                        
                        <!-- Descrizione -->
                        <MudTextField T="string"
                                     Label="@TranslationService.GetTranslation("documents.description", "Descrizione *")"
                                     @bind-Value="_model.Description"
                                     Variant="Variant.Outlined"
                                     Lines="2"
                                     Required="true"
                                     Adornment="Adornment.Start"
                                     AdornmentIcon="@Icons.Material.Outlined.Description" />
                        
                        <!-- Quantit√† e Prezzo in Grid compatto -->
                        <MudGrid Spacing="2">
                            <MudItem xs="12" sm="6">
                                <MudNumericField T="decimal"
                                                Label="@TranslationService.GetTranslation("documents.quantity", "Quantit√† *")"
                                                @bind-Value="_model.Quantity"
                                                Min="0.0001m"
                                                Variant="Variant.Outlined"
                                                @ref="_quantityField"
                                                Adornment="Adornment.Start"
                                                AdornmentIcon="@Icons.Material.Outlined.Numbers" />
                                
                                <MudSelect T="Guid?"
                                          Label="@TranslationService.GetTranslation("documents.unitOfMeasure", "Unit√† di Misura")"
                                          Value="_selectedUnitOfMeasureId"
                                          ValueChanged="@OnUnitOfMeasureChanged"
                                          Variant="Variant.Outlined"
                                          Dense="true"
                                          Disabled="@(_availableUnits.Count == 0)"
                                          Adornment="Adornment.Start"
                                          AdornmentIcon="@Icons.Material.Outlined.Scale">
                                    @foreach (var unit in _availableUnits)
                                    {
                                        var uom = _allUnitsOfMeasure.FirstOrDefault(u => u.Id == unit.UnitOfMeasureId);
                                        if (uom != null)
                                        {
                                            <MudSelectItem T="Guid?" Value="@uom.Id">@uom.Name (@uom.Symbol)</MudSelectItem>
                                        }
                                    }
                                </MudSelect>
                            </MudItem>
                        </MudGrid>
                    </MudStack>
                </MudPaper>
            }
            
            @if (_dialogMode == DialogMode.Standard)
            {
                <!-- 3. PREZZO UNITARIO NETTO (visible by default) -->
                <MudNumericField T="decimal"
                                Label="@TranslationService.GetTranslation("documents.unitPrice", "Prezzo Unitario Netto")"
                                @bind-Value="_model.UnitPrice"
                                Min="0"
                                Format="N2"
                                Variant="Variant.Outlined"
                                Adornment="Adornment.Start"
                                AdornmentIcon="@Icons.Material.Outlined.Euro" />
                
                <!-- 3.5 MERGE DUPLICATES CHECKBOX (Only in Add Mode) -->
                @if (!_isEditMode)
                {
                    <MudPaper Elevation="1" Class="pa-3" Style="background-color: var(--mud-palette-background-grey);">
                        <MudCheckBox T="bool"
                                     @bind-Checked="_model.MergeDuplicateProducts"
                                     Label="@TranslationService.GetTranslation("documents.mergeDuplicates", "Somma quantit√† se l'articolo √® gi√† presente")"
                                     Color="Color.Primary"
                                     Disabled="@(_selectedProduct == null)">
                            @if (_selectedProduct == null)
                            {
                                <MudTooltip Text="@TranslationService.GetTranslation("documents.mergeDuplicatesDisabledHelp", "Seleziona un prodotto dall'autocomplete per abilitare la fusione")">
                                    <MudIcon Icon="@Icons.Material.Outlined.Info" Size="Size.Small" Color="Color.Warning" Class="ml-1" />
                                </MudTooltip>
                            }
                            else
                            {
                                <MudTooltip Text="@TranslationService.GetTranslation("documents.mergeDuplicatesHelp", "When enabled, if you add the same product with the same price, VAT and discounts, the quantity will be summed to the existing row instead of creating a new one")">
                                    <MudIcon Icon="@Icons.Material.Outlined.Info" Size="Size.Small" Color="Color.Info" Class="ml-1" />
                                </MudTooltip>
                            }
                        </MudCheckBox>
                        
                        @* Alert informativo quando merge √® attivo *@
                        @if (_model.MergeDuplicateProducts && _selectedProduct != null)
                        {
                            <MudAlert Severity="Severity.Info" Dense="true" Class="mt-2">
                                <MudText Typo="Typo.caption">
                                    <MudIcon Icon="@Icons.Material.Outlined.MergeType" Size="Size.Small" Class="mr-1" />
                                    <strong>@TranslationService.GetTranslation("documents.mergeDuplicatesActivePrefix", "Merge Mode Active:")</strong>
                                    @(" ")
                                    @TranslationService.GetTranslation("documents.mergeDuplicatesActiveInfo", "If an identical row exists (same product, price, VAT and discounts), the quantity will be summed.")
                                </MudText>
                            </MudAlert>
                        }
                    </MudPaper>
                }
            
                <!-- 4. EXPANSION PANELS FOR ADVANCED SECTIONS -->
                <MudExpansionPanels MultiExpansion="true" Elevation="1">
                
                <!-- IVA e Prezzi Panel -->
                <MudExpansionPanel Text="@TranslationService.GetTranslation("documents.vatAndPricesSection", "IVA e Prezzi")" 
                                   Expanded="@_vatPanelExpanded"
                                   ExpandedChanged="@((expanded) => { _vatPanelExpanded = expanded; DebouncePanelStateSave(); })"
                                   id="vat-prices-panel">
                    <MudStack Spacing="2">
                        <MudSelect T="Guid?"
                                  Label="@TranslationService.GetTranslation("documents.vatRate", "Aliquota IVA %")"
                                  Value="_selectedVatRateId"
                                  ValueChanged="@OnVatRateChanged"
                                  Variant="Variant.Outlined"
                                  Dense="true"
                                  Adornment="Adornment.Start"
                                  AdornmentIcon="@Icons.Material.Outlined.Percent">
                            @foreach (var vatRate in _allVatRates)
                            {
                                <MudSelectItem T="Guid?" Value="@vatRate.Id">@vatRate.Name (@vatRate.Percentage%)</MudSelectItem>
                            }
                        </MudSelect>
                        
                        <MudTextField T="string"
                                     Label="@TranslationService.GetTranslation("documents.vatAmount", "Importo IVA")"
                                     Value="@GetVatAmount().ToString("C2")"
                                     ReadOnly="true"
                                     Variant="Variant.Filled"
                                     Dense="true"
                                     Adornment="Adornment.Start"
                                     AdornmentIcon="@Icons.Material.Outlined.Calculate" />
                        
                        <MudTextField T="string"
                                     Label="@TranslationService.GetTranslation("documents.unitPriceGross", "Prezzo Unit. Lordo")"
                                     Value="@GetUnitPriceGross().ToString("C2")"
                                     ReadOnly="true"
                                     Variant="Variant.Filled"
                                     Dense="true"
                                     Adornment="Adornment.Start"
                                     AdornmentIcon="@Icons.Material.Outlined.Calculate"
                                     HelperText="@TranslationService.GetTranslation("documents.autoCalculated", "Calcolato automaticamente")" />
                    </MudStack>
                </MudExpansionPanel>
                
                <!-- Sconti Panel -->
                <MudExpansionPanel Text="@TranslationService.GetTranslation("documents.discountsSection", "Sconti")"
                                   Expanded="@_discountsPanelExpanded"
                                   ExpandedChanged="@((expanded) => { _discountsPanelExpanded = expanded; DebouncePanelStateSave(); })"
                                   id="discounts-panel">
                    <MudStack Spacing="2">
                        <MudNumericField T="decimal"
                                        Label="@TranslationService.GetTranslation("documents.lineDiscount", "Sconto %")"
                                        @bind-Value="_model.LineDiscount"
                                        Min="0"
                                        Max="100"
                                        Format="N2"
                                        Variant="Variant.Outlined"
                                        Dense="true"
                                        Adornment="Adornment.End"
                                        AdornmentIcon="@Icons.Material.Outlined.Percent" />
                        
                        <MudNumericField T="decimal"
                                        Label="@TranslationService.GetTranslation("documents.lineDiscountValue", "Sconto ‚Ç¨")"
                                        @bind-Value="_model.LineDiscountValue"
                                        Min="0"
                                        Format="N2"
                                        Variant="Variant.Outlined"
                                        Dense="true"
                                        Adornment="Adornment.Start"
                                        AdornmentIcon="@Icons.Material.Outlined.Euro" />
                    </MudStack>
                </MudExpansionPanel>
                
                <!-- Note e Dettagli Panel -->
                <MudExpansionPanel Text="@TranslationService.GetTranslation("documents.notesAndDetailsSection", "Note e Dettagli")"
                                   Expanded="@_notesPanelExpanded"
                                   ExpandedChanged="@((expanded) => { _notesPanelExpanded = expanded; DebouncePanelStateSave(); })"
                                   id="notes-details-panel">
                    <MudTextField T="string"
                                 Label="@TranslationService.GetTranslation("documents.notes", "Note (opzionali)")"
                                 @bind-Value="_model.Notes"
                                 Lines="2"
                                 Variant="Variant.Outlined"
                                 Adornment="Adornment.Start"
                                 AdornmentIcon="@Icons.Material.Outlined.Comment" />
                </MudExpansionPanel>
                
            </MudExpansionPanels>
            }
            
            @if (_dialogMode == DialogMode.Standard)
            {
                <!-- 5. RIEPILOGO RIGA (Full Width, evidenziato) -->
                <MudPaper Elevation="3" Class="pa-4" 
                         Style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <MudText Typo="Typo.subtitle1" Class="mb-3" Style="font-weight: 600;">
                    <MudIcon Icon="@Icons.Material.Outlined.Summarize" Class="mr-2" Size="Size.Small" />
                    @TranslationService.GetTranslation("documents.rowSummary", "Riepilogo Riga")
                </MudText>
                <MudGrid Spacing="2">
                    <MudItem xs="6" sm="3">
                        <MudText Typo="Typo.caption">
                            @TranslationService.GetTranslation("documents.netSubtotal", "Subtotale Netto")
                        </MudText>
                        <MudText Typo="Typo.h6" Style="font-weight: 600;">
                            @GetSubtotal().ToString("C2")
                        </MudText>
                    </MudItem>
                    <MudItem xs="6" sm="3">
                        <MudText Typo="Typo.caption">
                            @TranslationService.GetTranslation("documents.vatTax", "Imposta IVA")
                        </MudText>
                        <MudText Typo="Typo.h6" Style="font-weight: 600;">
                            @GetVatAmount().ToString("C2")
                        </MudText>
                    </MudItem>
                    <MudItem xs="6" sm="3">
                        <MudText Typo="Typo.caption">
                            @TranslationService.GetTranslation("documents.totalDiscount", "Sconto Totale")
                        </MudText>
                        <MudText Typo="Typo.h6" Style="font-weight: 600; color: #90EE90;">
                            -@GetTotalDiscount().ToString("C2")
                        </MudText>
                    </MudItem>
                    <MudItem xs="6" sm="3">
                        <MudText Typo="Typo.caption">
                            üíé @TranslationService.GetTranslation("documents.lineTotal", "TOTALE RIGA")
                        </MudText>
                        <MudText Typo="Typo.h5" Style="font-weight: 700;">
                            @GetLineTotal().ToString("C2")
                        </MudText>
                    </MudItem>
                </MudGrid>
            </MudPaper>
            }
            
            } @* End of DialogMode != ContinuousScan check *@
            
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Style="width: 100%;">
            <MudText Typo="Typo.caption" Class="ml-2" Style="color: var(--mud-palette-text-secondary);">
                <MudIcon Icon="@Icons.Material.Outlined.Keyboard" Size="Size.Small" />
                @TranslationService.GetTranslation("documents.shortcutEnter", "Enter: Salva") ¬∑ 
                @TranslationService.GetTranslation("documents.shortcutCtrlE", "Ctrl+E: Modifica Prodotto") ¬∑ 
                @TranslationService.GetTranslation("documents.shortcutEsc", "Esc: Chiudi")
            </MudText>
            <MudStack Row="true" Spacing="2">
                <MudButton OnClick="Cancel" Variant="Variant.Outlined" Disabled="@_isProcessing">
                    @TranslationService.GetTranslation("common.close", "Chiudi")
                </MudButton>
                <MudButton Color="Color.Primary" 
                           OnClick="SaveAndContinue" 
                           Disabled="@(!IsValid() || _isProcessing)"
                           Variant="Variant.Filled">
                    @if (_isProcessing)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                    }
                    else
                    {
                        <MudIcon Icon="@(_isEditMode ? Icons.Material.Filled.Save : Icons.Material.Filled.Add)" Class="mr-1" />
                    }
                    @TranslationService.GetTranslation(_isEditMode ? "common.save" : "documents.addAndContinue", _isEditMode ? "Salva" : "Aggiungi e Continua")
                </MudButton>
            </MudStack>
        </MudStack>
    </DialogActions>
</MudDialog>

