@using EventForge.DTOs.Products
@using EventForge.Client.Services
@inject ITranslationService TranslationService

<MudStack Spacing="1">
    <MudText Typo="Typo.caption" Style="color: var(--mud-palette-text-secondary);">
        <MudIcon Icon="@Icons.Material.Outlined.Inventory" Size="Size.Small" Class="mr-1" />
        @TranslationService.GetTranslation("documents.product", "Prodotto")
    </MudText>
    <MudAutocomplete T="ProductDto"
                     @bind-Value="@SelectedProduct"
                     SearchFunc="@SearchFunc"
                     ToStringFunc="@(p => p?.Name ?? string.Empty)"
                     Variant="Variant.Outlined"
                     Dense="true"
                     Margin="Margin.Dense"
                     MinCharacters="2"
                     DebounceInterval="300"
                     ShowProgressIndicator="true"
                     Clearable="true"
                     ResetValueOnEmptyText="false"
                     CoerceText="false"
                     CoerceValue="false"
                     Disabled="@(!IsEnabled)"
                     Placeholder="@TranslationService.GetTranslation("documents.searchProductHelp", "Cerca prodotto (min 2 caratteri)...")"
                     Adornment="Adornment.Start"
                     AdornmentIcon="@Icons.Material.Outlined.Inventory"
                     ValueChanged="@OnProductChangedHandler"
                     aria-label="@TranslationService.GetTranslation("documents.product", "Prodotto")">
        <ItemTemplate Context="product">
            <MudStack Spacing="0">
                <MudText Typo="Typo.body2" Style="font-weight: 500;">@product.Name</MudText>
                <MudText Typo="Typo.caption" Style="color: var(--mud-palette-text-secondary);">
                    @product.Code Â· @(product.DefaultPrice?.ToString("C2") ?? "N/A")
                </MudText>
            </MudStack>
        </ItemTemplate>
        <NoItemsTemplate>
            <MudText Typo="Typo.body2" Align="Align.Center" Class="py-2">
                @TranslationService.GetTranslation("documents.noProductsFound", "Nessun prodotto trovato")
            </MudText>
        </NoItemsTemplate>
    </MudAutocomplete>
    
    @if (SelectedProduct != null && ShowQuickEdit)
    {
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mt-1">
            <MudText Typo="Typo.caption" Color="Color.Success">
                <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Small" Class="mr-1" />
                @TranslationService.GetTranslation("documents.productSelected", "Prodotto selezionato")
            </MudText>
            <MudButton Size="Size.Small" 
                       Variant="Variant.Text" 
                       Color="Color.Primary"
                       StartIcon="@Icons.Material.Outlined.Edit"
                       OnClick="@(() => OnQuickEdit.InvokeAsync())">
                @TranslationService.GetTranslation("common.quickEdit", "Modifica Rapida")
            </MudButton>
        </MudStack>
    }
</MudStack>

@code {
    [Parameter] public ProductDto? SelectedProduct { get; set; }
    [Parameter] public bool IsEnabled { get; set; } = true;
    [Parameter] public bool ShowQuickEdit { get; set; } = true;
    [Parameter] public EventCallback<ProductDto?> OnProductChanged { get; set; }
    [Parameter] public EventCallback OnQuickEdit { get; set; }
    [Parameter] public Func<string, CancellationToken, Task<IEnumerable<ProductDto>>>? SearchFunc { get; set; }
}
