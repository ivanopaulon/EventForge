@using EventForge.DTOs.Products
@using EventForge.Client.Services
@inject ITranslationService TranslationService

<MudStack Spacing="1">
    <!-- Label -->
    <MudText Typo="Typo.caption" Style="color: var(--mud-palette-text-secondary);">
        <MudIcon Icon="@Icons.Material.Outlined.Inventory" Size="Size.Small" Class="mr-1" />
        @TranslationService.GetTranslation("documents.product", "Prodotto")
    </MudText>
    
    <!-- Autocomplete - EXACT PATTERN from GenericDocumentProcedure -->
    <MudAutocomplete T="ProductDto"
                     @bind-Value="SelectedProduct"
                     SearchFunc="@SearchProductsAsync"
                     ToStringFunc="@(p => p?.Name ?? string.Empty)"
                     Variant="Variant.Outlined"
                     Dense="true"
                     Margin="Margin.Dense"
                     MinCharacters="2"
                     DebounceInterval="300"
                     ShowProgressIndicator="true"
                     Clearable="@AllowClear"
                     Placeholder="@TranslationService.GetTranslation("documents.searchProduct", "Cerca prodotto (min 2 caratteri)...")"
                     CoerceText="false"
                     CoerceValue="false"
                     Disabled="@Disabled"
                     Adornment="Adornment.Start"
                     AdornmentIcon="@Icons.Material.Outlined.Search"
                     AdornmentColor="Color.Primary">
        <!-- ItemTemplate -->
        <ItemTemplate Context="product">
            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                <div>
                    <MudText Typo="Typo.body2"><strong>@product.Name</strong></MudText>
                    @if (!string.IsNullOrEmpty(product.Code))
                    {
                        <MudText Typo="Typo.caption" Style="color: var(--mud-palette-text-secondary);">
                            @product.Code
                        </MudText>
                    }
                </div>
                @if (product.DefaultPrice.HasValue)
                {
                    <MudChip T="string" Size="Size.Small" Color="Color.Primary" Variant="Variant.Text">
                        @product.DefaultPrice.Value.ToString("C2")
                    </MudChip>
                }
            </MudStack>
        </ItemTemplate>
        
        <!-- NoItemsTemplate -->
        <NoItemsTemplate>
            <MudText Typo="Typo.body2" Style="color: var(--mud-palette-text-disabled);">
                @TranslationService.GetTranslation("documents.noProductsFound", "Nessun prodotto trovato")
            </MudText>
        </NoItemsTemplate>
    </MudAutocomplete>
    
    <!-- ProductQuickInfo Card -->
    @if (SelectedProduct != null && ShowQuickInfo)
    {
        <MudPaper Elevation="1" Class="pa-2 mt-2">
            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                <MudStack Spacing="0">
                    <MudText Typo="Typo.caption" Style="color: var(--mud-palette-text-secondary);">
                        <MudIcon Icon="@Icons.Material.Outlined.CheckCircle" Size="Size.Small" Color="Color.Success" Class="mr-1" />
                        @TranslationService.GetTranslation("documents.productSelected", "Prodotto Selezionato")
                    </MudText>
                    <MudText Typo="Typo.body2"><strong>@SelectedProduct.Name</strong></MudText>
                    @if (!string.IsNullOrEmpty(SelectedProduct.Code))
                    {
                        <MudText Typo="Typo.caption" Style="color: var(--mud-palette-text-secondary);">
                            @TranslationService.GetTranslation("documents.code", "Codice"): @SelectedProduct.Code
                        </MudText>
                    }
                    @if (SelectedProduct.DefaultPrice.HasValue)
                    {
                        <MudText Typo="Typo.caption" Style="color: var(--mud-palette-primary);">
                            @TranslationService.GetTranslation("documents.defaultPrice", "Prezzo"): @SelectedProduct.DefaultPrice.Value.ToString("C2")
                        </MudText>
                    }
                </MudStack>
                
                @if (AllowQuickEdit)
                {
                    <MudButton Size="Size.Small"
                               Variant="Variant.Text"
                               Color="Color.Primary"
                               StartIcon="@DialogStyleConstants.Icons.Edit"
                               OnClick="@HandleQuickEdit">
                        @TranslationService.GetTranslation("common.quickEdit", "Modifica")
                    </MudButton>
                }
            </MudStack>
        </MudPaper>
    }
</MudStack>
