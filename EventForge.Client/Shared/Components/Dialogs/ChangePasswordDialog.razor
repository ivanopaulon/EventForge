@using EventForge.DTOs.Profile
@inject IProfileService ProfileService
@inject ISnackbar Snackbar
@inject ITranslationService TranslationService
@inject ILogger<ChangePasswordDialog> Logger

<MudDialog ClassActions="pa-4" ClassContent="py-0" Class="ef-dialog">
    <TitleContent>
        <MudText Typo="Typo.h6">
            @TranslationService.GetTranslation("auth.changePassword", "Change Password")
        </MudText>
    </TitleContent>
    <DialogContent>
        <PageLoadingOverlay IsVisible="_isLoading"
                            Message="@TranslationService.GetTranslation("auth.changingPassword", "Changing password...")" />

        <MudForm @ref="_form"
                 @bind-IsValid="@_isFormValid"
                 role="form"
                 aria-label="Change password form">
            <MudStack Spacing="3" Class="mt-4">
                <MudTextField @bind-Value="_changePasswordDto.CurrentPassword"
                              Class="ef-input"
                              For="@(() => _changePasswordDto.CurrentPassword)"
                              Label="@TranslationService.GetTranslation("auth.currentPassword", "Current Password")"
                              Variant="Variant.Outlined"
                              InputType="InputType.Password"
                              Required="true"
                              RequiredError="@TranslationService.GetTranslation("auth.currentPasswordRequired", "Current password is required")"
                              Disabled="_isLoading"
                              autocomplete="current-password"
                              Margin="Margin.Dense" />

                <MudTextField @bind-Value="_changePasswordDto.NewPassword"
                              Class="ef-input"
                              For="@(() => _changePasswordDto.NewPassword)"
                              Label="@TranslationService.GetTranslation("auth.newPassword", "New Password")"
                              Variant="Variant.Outlined"
                              InputType="InputType.Password"
                              Required="true"
                              RequiredError="@TranslationService.GetTranslation("auth.newPasswordRequired", "New password is required")"
                              Disabled="_isLoading"
                              autocomplete="new-password"
                              Margin="Margin.Dense"
                              HelperText="@TranslationService.GetTranslation("auth.passwordMinLength", "Minimum 8 characters")" />

                <MudTextField @bind-Value="_changePasswordDto.ConfirmPassword"
                              Class="ef-input"
                              For="@(() => _changePasswordDto.ConfirmPassword)"
                              Label="@TranslationService.GetTranslation("auth.confirmPassword", "Confirm Password")"
                              Variant="Variant.Outlined"
                              InputType="InputType.Password"
                              Required="true"
                              RequiredError="@TranslationService.GetTranslation("auth.confirmPasswordRequired", "Password confirmation is required")"
                              Disabled="_isLoading"
                              autocomplete="new-password"
                              Margin="Margin.Dense" />

                @if (!string.IsNullOrEmpty(_validationError))
                {
                    <MudAlert Severity="Severity.Error" Dense="true">
                        @_validationError
                    </MudAlert>
                }
            </MudStack>
        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudButton ButtonType="ButtonType.Button"
                   Variant="Variant.Text"
                   Color="Color.Default"
                   OnClick="Cancel"
                   Disabled="_isLoading">
            @TranslationService.GetTranslation("common.cancel", "Cancel")
        </MudButton>
        <MudButton ButtonType="ButtonType.Button"
                   Variant="Variant.Filled"
                   Color="Color.Primary"
                   OnClick="HandleChangePassword"
                   Disabled="@(!_isFormValid || _isLoading)">
            @TranslationService.GetTranslation("auth.changePassword", "Change Password")
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] 
    private IMudDialogInstance MudDialog { get; set; } = null!;

    private const int MinPasswordLength = 8;

    private MudForm _form = null!;
    private bool _isFormValid;
    private bool _isLoading = false;
    private readonly ChangePasswordDto _changePasswordDto = new();
    private string _validationError = string.Empty;

    private async Task HandleChangePassword()
    {
        // Validate form
        await _form.Validate();
        if (!_isFormValid) return;

        // Client-side validation for password match
        if (_changePasswordDto.NewPassword != _changePasswordDto.ConfirmPassword)
        {
            _validationError = TranslationService.GetTranslation("auth.passwordsMustMatch", "Passwords do not match");
            return;
        }

        // Client-side validation for password length
        if (_changePasswordDto.NewPassword.Length < MinPasswordLength)
        {
            _validationError = TranslationService.GetTranslation("auth.passwordTooShort", $"Password must be at least {MinPasswordLength} characters");
            return;
        }

        _validationError = string.Empty;
        _isLoading = true;
        StateHasChanged();

        try
        {
            var success = await ProfileService.ChangePasswordAsync(_changePasswordDto);
            if (success)
            {
                Snackbar.Add(
                    TranslationService.GetTranslation("auth.passwordChangedSuccess", "Password changed successfully!"),
                    Severity.Success);
                
                // Close dialog with success result
                MudDialog.Close(DialogResult.Ok(true));
            }
            else
            {
                _validationError = TranslationService.GetTranslation("auth.passwordChangeFailed", "Failed to change password. Please check your current password.");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error changing password for user");
            _validationError = TranslationService.GetTranslation("auth.passwordChangeError", "An error occurred while changing your password. Please try again.");
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private void Cancel()
    {
        MudDialog.Cancel();
    }
}
