@using EventForge.DTOs.Profile
@inject IProfileService ProfileService
@inject ISnackbar Snackbar
@inject ITranslationService TranslationService
@inject ILogger<ChangePasswordDialog> Logger

<MudDialog ClassActions="pa-4" ClassContent="py-0" Class="ef-dialog">
    <TitleContent>
        <MudText Typo="Typo.h6">
            @TranslationService.GetTranslation("auth.changePassword", "Change Password")
        </MudText>
    </TitleContent>
    <DialogContent>
        <PageLoadingOverlay IsVisible="_isLoading"
                            Message="@TranslationService.GetTranslation("auth.changingPassword", "Changing password...")" />

        <MudForm @ref="_form"
                 @bind-IsValid="@_isFormValid"
                 role="form"
                 aria-label="Change password form">
            <MudStack Spacing="3" Class="mt-4">
                <MudTextField @bind-Value="_changePasswordDto.CurrentPassword"
                              Class="ef-input"
                              For="@(() => _changePasswordDto.CurrentPassword)"
                              Label="@TranslationService.GetTranslation("auth.currentPassword", "Current Password")"
                              Variant="Variant.Outlined"
                              InputType="@_currentPasswordInputType"
                              Required="true"
                              RequiredError="@TranslationService.GetTranslation("auth.currentPasswordRequired", "Current password is required")"
                              Disabled="_isLoading"
                              autocomplete="current-password"
                              Margin="Margin.Dense"
                              Adornment="Adornment.End"
                              AdornmentIcon="@_currentPasswordVisibilityIcon"
                              OnAdornmentClick="ToggleCurrentPasswordVisibility"
                              AdornmentAriaLabel="@TranslationService.GetTranslation("auth.togglePasswordVisibility", "Toggle password visibility")" />

                <MudTextField @bind-Value="_changePasswordDto.NewPassword"
                              @bind-Value:after="OnNewPasswordChanged"
                              Class="ef-input"
                              For="@(() => _changePasswordDto.NewPassword)"
                              Label="@TranslationService.GetTranslation("auth.newPassword", "New Password")"
                              Variant="Variant.Outlined"
                              InputType="@_newPasswordInputType"
                              Required="true"
                              RequiredError="@TranslationService.GetTranslation("auth.newPasswordRequired", "New password is required")"
                              Disabled="_isLoading"
                              autocomplete="new-password"
                              Margin="Margin.Dense"
                              Adornment="Adornment.End"
                              AdornmentIcon="@_newPasswordVisibilityIcon"
                              OnAdornmentClick="ToggleNewPasswordVisibility"
                              AdornmentAriaLabel="@TranslationService.GetTranslation("auth.togglePasswordVisibility", "Toggle password visibility")" />

                @if (!string.IsNullOrEmpty(_changePasswordDto.NewPassword))
                {
                    <MudText Typo="Typo.caption" Color="@GetPasswordStrengthColor()" Class="mt-n2">
                        @TranslationService.GetTranslation("auth.passwordStrength", "Password strength"): @GetPasswordStrengthText()
                    </MudText>
                }
                else
                {
                    <MudText Typo="Typo.caption" Color="Color.Default" Class="mt-n2">
                        @TranslationService.GetTranslationFormatted("auth.passwordMinLength", "Minimum {0} characters", MinPasswordLength)
                    </MudText>
                }

                <MudTextField @bind-Value="_changePasswordDto.ConfirmPassword"
                              Class="ef-input"
                              For="@(() => _changePasswordDto.ConfirmPassword)"
                              Label="@TranslationService.GetTranslation("auth.confirmPassword", "Confirm Password")"
                              Variant="Variant.Outlined"
                              InputType="@_confirmPasswordInputType"
                              Required="true"
                              RequiredError="@TranslationService.GetTranslation("auth.confirmPasswordRequired", "Password confirmation is required")"
                              Disabled="_isLoading"
                              autocomplete="new-password"
                              Margin="Margin.Dense"
                              Adornment="Adornment.End"
                              AdornmentIcon="@_confirmPasswordVisibilityIcon"
                              OnAdornmentClick="ToggleConfirmPasswordVisibility"
                              AdornmentAriaLabel="@TranslationService.GetTranslation("auth.togglePasswordVisibility", "Toggle password visibility")" />

                @if (!string.IsNullOrEmpty(_validationError))
                {
                    <MudAlert Severity="Severity.Error" Dense="true">
                        @_validationError
                    </MudAlert>
                }
            </MudStack>
        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudButton ButtonType="ButtonType.Button"
                   Variant="Variant.Text"
                   Color="Color.Default"
                   OnClick="Cancel"
                   Disabled="_isLoading">
            @TranslationService.GetTranslation("common.cancel", "Cancel")
        </MudButton>
        <MudButton ButtonType="ButtonType.Button"
                   Variant="Variant.Filled"
                   Color="Color.Primary"
                   OnClick="HandleChangePassword"
                   Disabled="@(!_isFormValid || _isLoading)">
            @TranslationService.GetTranslation("auth.changePassword", "Change Password")
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] 
    private IMudDialogInstance MudDialog { get; set; } = null!;

    private const int MinPasswordLength = 8;
    private const int StrongPasswordLength = 12;
    private const int MaxPasswordStrength = 4;

    // Password strength levels
    private const int StrengthVeryWeak = 0;
    private const int StrengthWeak = 1;
    private const int StrengthMedium = 2;
    private const int StrengthGood = 3;
    private const int StrengthStrong = 4;

    private MudForm _form = null!;
    private bool _isFormValid;
    private bool _isLoading = false;
    private readonly ChangePasswordDto _changePasswordDto = new();
    private string _validationError = string.Empty;

    // Password visibility toggles
    private bool _currentPasswordVisible = false;
    private InputType _currentPasswordInputType = InputType.Password;
    private string _currentPasswordVisibilityIcon = Icons.Material.Filled.VisibilityOff;

    private bool _newPasswordVisible = false;
    private InputType _newPasswordInputType = InputType.Password;
    private string _newPasswordVisibilityIcon = Icons.Material.Filled.VisibilityOff;

    private bool _confirmPasswordVisible = false;
    private InputType _confirmPasswordInputType = InputType.Password;
    private string _confirmPasswordVisibilityIcon = Icons.Material.Filled.VisibilityOff;

    private int _passwordStrength = StrengthVeryWeak;

    private async Task HandleChangePassword()
    {
        // Validate form
        await _form.Validate();
        if (!_isFormValid) return;

        // Client-side validation for password match
        if (_changePasswordDto.NewPassword != _changePasswordDto.ConfirmPassword)
        {
            _validationError = TranslationService.GetTranslation("auth.passwordsMustMatch", "Passwords do not match");
            return;
        }

        // Client-side validation for password length
        if (_changePasswordDto.NewPassword.Length < MinPasswordLength)
        {
            _validationError = TranslationService.GetTranslation("auth.passwordTooShort", $"Password must be at least {MinPasswordLength} characters");
            return;
        }

        _validationError = string.Empty;
        _isLoading = true;
        StateHasChanged();

        try
        {
            var success = await ProfileService.ChangePasswordAsync(_changePasswordDto);
            if (success)
            {
                Snackbar.Add(
                    TranslationService.GetTranslation("auth.passwordChangedSuccess", "Password changed successfully!"),
                    Severity.Success);
                
                // Close dialog with success result
                MudDialog.Close(DialogResult.Ok(true));
            }
            else
            {
                _validationError = TranslationService.GetTranslation("auth.passwordChangeFailed", "Failed to change password. Please check your current password.");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error changing password for user");
            _validationError = TranslationService.GetTranslation("auth.passwordChangeError", "An error occurred while changing your password. Please try again.");
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private void Cancel()
    {
        MudDialog.Cancel();
    }

    private void ToggleCurrentPasswordVisibility()
    {
        if (_currentPasswordVisible)
        {
            _currentPasswordVisible = false;
            _currentPasswordInputType = InputType.Password;
            _currentPasswordVisibilityIcon = Icons.Material.Filled.VisibilityOff;
        }
        else
        {
            _currentPasswordVisible = true;
            _currentPasswordInputType = InputType.Text;
            _currentPasswordVisibilityIcon = Icons.Material.Filled.Visibility;
        }
    }

    private void ToggleNewPasswordVisibility()
    {
        if (_newPasswordVisible)
        {
            _newPasswordVisible = false;
            _newPasswordInputType = InputType.Password;
            _newPasswordVisibilityIcon = Icons.Material.Filled.VisibilityOff;
        }
        else
        {
            _newPasswordVisible = true;
            _newPasswordInputType = InputType.Text;
            _newPasswordVisibilityIcon = Icons.Material.Filled.Visibility;
        }
    }

    private void ToggleConfirmPasswordVisibility()
    {
        if (_confirmPasswordVisible)
        {
            _confirmPasswordVisible = false;
            _confirmPasswordInputType = InputType.Password;
            _confirmPasswordVisibilityIcon = Icons.Material.Filled.VisibilityOff;
        }
        else
        {
            _confirmPasswordVisible = true;
            _confirmPasswordInputType = InputType.Text;
            _confirmPasswordVisibilityIcon = Icons.Material.Filled.Visibility;
        }
    }

    private void OnNewPasswordChanged()
    {
        CalculatePasswordStrength();
    }

    private void CalculatePasswordStrength()
    {
        if (string.IsNullOrEmpty(_changePasswordDto.NewPassword))
        {
            _passwordStrength = StrengthVeryWeak;
            return;
        }

        int strength = 0;
        var password = _changePasswordDto.NewPassword;

        // Length checks
        if (password.Length >= MinPasswordLength) strength++;
        if (password.Length >= StrongPasswordLength) strength++;

        // Character variety checks - single pass through the string for efficiency
        bool hasUpper = false;
        bool hasLower = false;
        bool hasDigit = false;
        bool hasSpecial = false;

        foreach (char ch in password)
        {
            // Check each character type independently (not mutually exclusive)
            if (!hasUpper && char.IsUpper(ch)) hasUpper = true;
            if (!hasLower && char.IsLower(ch)) hasLower = true;
            if (!hasDigit && char.IsDigit(ch)) hasDigit = true;
            // Count only printable special characters (not whitespace or control characters)
            if (!hasSpecial && !char.IsLetterOrDigit(ch) && !char.IsWhiteSpace(ch) && !char.IsControl(ch)) hasSpecial = true;
            
            // Early exit when all character types are found
            if (hasUpper && hasLower && hasDigit && hasSpecial) break;
        }

        if (hasUpper) strength++;
        if (hasLower) strength++;
        if (hasDigit) strength++;
        if (hasSpecial) strength++;

        // Strength naturally ranges from 0 (no criteria met) to 6 (all criteria met)
        // Map to 0-4 scale: 0-1=VeryWeak(0), 2=Weak(1), 3-4=Medium(2), 5=Good(3), 6=Strong(4)
        _passwordStrength = strength switch
        {
            0 or 1 => StrengthVeryWeak,
            2 => StrengthWeak,
            3 or 4 => StrengthMedium,
            5 => StrengthGood,
            _ => StrengthStrong // 6
        };
    }

    private string GetPasswordStrengthText()
    {
        return _passwordStrength switch
        {
            StrengthVeryWeak => TranslationService.GetTranslation("auth.passwordStrength.veryWeak", "Very Weak"),
            StrengthWeak => TranslationService.GetTranslation("auth.passwordStrength.weak", "Weak"),
            StrengthMedium => TranslationService.GetTranslation("auth.passwordStrength.medium", "Medium"),
            StrengthGood => TranslationService.GetTranslation("auth.passwordStrength.good", "Good"),
            StrengthStrong => TranslationService.GetTranslation("auth.passwordStrength.strong", "Strong"),
            _ => ""
        };
    }

    private Color GetPasswordStrengthColor()
    {
        return _passwordStrength switch
        {
            StrengthVeryWeak or StrengthWeak => Color.Error,
            StrengthMedium => Color.Warning,
            StrengthGood => Color.Info,
            StrengthStrong => Color.Success,
            _ => Color.Default
        };
    }
}
