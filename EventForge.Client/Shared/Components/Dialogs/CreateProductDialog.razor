@using EventForge.DTOs.Common
@using EventForge.DTOs.Products
@using EventForge.DTOs.VatRates
@using EventForge.DTOs.UnitOfMeasures
@using EventForge.DTOs.Station
@using Microsoft.AspNetCore.Components.Forms
@inject IProductService ProductService
@inject IFinancialService FinancialService
@inject IEntityManagementService EntityManagementService
@inject ISnackbar Snackbar
@inject ITranslationService TranslationService
@inject ILogger<CreateProductDialog> Logger
@inject IClientLogService ClientLogService

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Outlined.Add" Class="mr-2" />
            @TranslationService.GetTranslation("products.createProduct", "Crea Nuovo Prodotto")
        </MudText>
    </TitleContent>
    <DialogContent>
        @if (_isLoading)
        {
            <MudProgressLinear Indeterminate="true" Class="mb-4" />
        }

        <MudForm @ref="_form" @bind-IsValid="@_isFormValid">
            <MudGrid Spacing="3">
                <MudItem xs="12">
                    <MudTextField @bind-Value="_createDto.Name"
                                  Label="@TranslationService.GetTranslation("products.productName", "Nome Prodotto")"
                                  Variant="Variant.Outlined"
                                  Required="true"
                                  RequiredError="@TranslationService.GetTranslation("validation.required", "Campo obbligatorio")"
                                  MaxLength="100"
                                  Counter="100" />
                </MudItem>

                <MudItem xs="12">
                    <MudTextField @bind-Value="_createDto.Code"
                                  Label="@TranslationService.GetTranslation("products.productCode", "Codice Prodotto")"
                                  Variant="Variant.Outlined"
                                  HelperText="@TranslationService.GetTranslation("products.codeHelper", "Codice SKU o simile")"
                                  Adornment="Adornment.Start"
                                  AdornmentIcon="@Icons.Material.Outlined.QrCode"
                                  ReadOnly="true" />
                </MudItem>

                <MudItem xs="12">
                    <MudTextField @bind-Value="_createDto.ShortDescription"
                                  Label="@TranslationService.GetTranslation("products.shortDescription", "Descrizione Breve")"
                                  Variant="Variant.Outlined"
                                  MaxLength="50"
                                  Counter="50" />
                </MudItem>

                <MudItem xs="12">
                    <MudTextField @bind-Value="_createDto.Description"
                                  Label="@TranslationService.GetTranslation("products.description", "Descrizione")"
                                  Variant="Variant.Outlined"
                                  Lines="3"
                                  MaxLength="500"
                                  Counter="500" />
                </MudItem>

                <MudItem xs="12" md="6">
                    <MudNumericField @bind-Value="_createDto.DefaultPrice"
                                    Label="@TranslationService.GetTranslation("products.defaultPrice", "Prezzo Predefinito")"
                                    Variant="Variant.Outlined"
                                    Min="0m"
                                    Format="N2"
                                    Adornment="Adornment.Start"
                                    AdornmentText="€" />
                </MudItem>

                <MudItem xs="12" md="6">
                    <MudSelect @bind-Value="_createDto.Status"
                               Label="@TranslationService.GetTranslation("products.status", "Stato")"
                               Variant="Variant.Outlined"
                               Required="true">
                        <MudSelectItem Value="@ProductStatus.Active">@TranslationService.GetTranslation("products.active", "Attivo")</MudSelectItem>
                        <MudSelectItem Value="@ProductStatus.Suspended">@TranslationService.GetTranslation("products.suspended", "Sospeso")</MudSelectItem>
                        <MudSelectItem Value="@ProductStatus.OutOfStock">@TranslationService.GetTranslation("products.outOfStock", "Esaurito")</MudSelectItem>
                        <MudSelectItem Value="@ProductStatus.Deleted">@TranslationService.GetTranslation("products.deleted", "Eliminato")</MudSelectItem>
                    </MudSelect>
                </MudItem>

                <MudItem xs="12">
                    <MudSwitch @bind-Value="_createDto.IsVatIncluded"
                              Label="@TranslationService.GetTranslation("products.vatIncluded", "IVA Inclusa")"
                              Color="Color.Primary" />
                </MudItem>

                <MudItem xs="12" md="6">
                    <MudSelect T="Guid?" @bind-Value="_createDto.VatRateId"
                               Label="@TranslationService.GetTranslation("products.vatRate", "Aliquota IVA")"
                               Variant="Variant.Outlined"
                               Clearable="true">
                        @foreach (var vatRate in _vatRates)
                        {
                            <MudSelectItem Value="@((Guid?)vatRate.Id)">@vatRate.Name (@vatRate.Percentage%)</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>

                <MudItem xs="12" md="6">
                    <MudSelect T="Guid?" @bind-Value="_createDto.UnitOfMeasureId"
                               Label="@TranslationService.GetTranslation("products.unitOfMeasure", "Unità di Misura")"
                               Variant="Variant.Outlined"
                               Clearable="true">
                        @foreach (var um in _unitsOfMeasure)
                        {
                            <MudSelectItem Value="@((Guid?)um.Id)">@um.Name (@um.Symbol)</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>

                <MudItem xs="12" md="6">
                    <MudSelect T="Guid?" @bind-Value="_createDto.CategoryNodeId"
                               Label="@TranslationService.GetTranslation("products.category", "Categoria")"
                               Variant="Variant.Outlined"
                               Clearable="true">
                        @foreach (var node in _categoryNodes)
                        {
                            <MudSelectItem Value="@((Guid?)node.Id)">@node.Name</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>

                <MudItem xs="12" md="6">
                    <MudSelect T="Guid?" @bind-Value="_createDto.FamilyNodeId"
                               Label="@TranslationService.GetTranslation("products.family", "Famiglia")"
                               Variant="Variant.Outlined"
                               Clearable="true">
                        @foreach (var node in _familyNodes)
                        {
                            <MudSelectItem Value="@((Guid?)node.Id)">@node.Name</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>

                <MudItem xs="12" md="6">
                    <MudSelect T="Guid?" @bind-Value="_createDto.GroupNodeId"
                               Label="@TranslationService.GetTranslation("products.statisticalGroup", "Gruppo Statistico")"
                               Variant="Variant.Outlined"
                               Clearable="true">
                        @foreach (var node in _groupNodes)
                        {
                            <MudSelectItem Value="@((Guid?)node.Id)">@node.Name</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>

                <MudItem xs="12" md="6">
                    <MudSelect T="Guid?" @bind-Value="_createDto.StationId"
                               Label="@TranslationService.GetTranslation("products.station", "Postazione")"
                               Variant="Variant.Outlined"
                               Clearable="true">
                        @foreach (var station in _stations)
                        {
                            <MudSelectItem Value="@((Guid?)station.Id)">@station.Name</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>

                <MudItem xs="12">
                    <MudSwitch @bind-Value="_createDto.IsBundle"
                              Label="@TranslationService.GetTranslation("products.isBundle", "È un Bundle")"
                              Color="Color.Primary" />
                </MudItem>

                <MudItem xs="12">
                    <MudText Typo="Typo.subtitle2">@TranslationService.GetTranslation("products.productImage", "Immagine Prodotto")</MudText>
                    <MudFileUpload T="IBrowserFile" Accept="image/*" @bind-Files="_selectedImage" MaximumFileCount="1">
                        <ActivatorContent>
                            <MudButton HtmlTag="label"
                                      Variant="Variant.Filled"
                                      Color="Color.Primary"
                                      StartIcon="@Icons.Material.Filled.CloudUpload">
                                @TranslationService.GetTranslation("products.selectImage", "Seleziona Immagine")
                            </MudButton>
                        </ActivatorContent>
                    </MudFileUpload>
                    @if (_selectedImage != null)
                    {
                        <MudChip T="string" Color="Color.Info" Icon="@Icons.Material.Filled.Image" OnClose="ClearImage">
                            @_selectedImage.Name
                        </MudChip>
                    }
                    @if (_isUploadingImage)
                    {
                        <MudProgressLinear Indeterminate="true" Class="mt-2" />
                    }
                </MudItem>
            </MudGrid>
        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel" Color="Color.Default" Variant="Variant.Outlined">
            @TranslationService.GetTranslation("common.cancel", "Annulla")
        </MudButton>
        <MudButton OnClick="SaveProduct" Color="Color.Primary" Variant="Variant.Filled" Disabled="@(!_isFormValid || _isLoading)">
            @TranslationService.GetTranslation("common.save", "Salva")
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] 
    IMudDialogInstance MudDialog { get; set; } = null!;

    [Parameter]
    public string Barcode { get; set; } = string.Empty;

    private bool _isLoading = false;
    private bool _isUploadingImage = false;
    private bool _isFormValid = false;
    private MudForm? _form;
    private CreateProductDto _createDto = new();
    private IBrowserFile? _selectedImage;

    private List<VatRateDto> _vatRates = new();
    private List<UMDto> _unitsOfMeasure = new();
    private List<ClassificationNodeDto> _categoryNodes = new();
    private List<ClassificationNodeDto> _familyNodes = new();
    private List<ClassificationNodeDto> _groupNodes = new();
    private List<StationDto> _stations = new();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            await ClientLogService.LogInformationAsync("CreateProductDialog: Opening dialog", "CreateProductDialog");
            
            // Pre-fill the code with the scanned barcode
            _createDto.Code = Barcode;
            _createDto.Status = ProductStatus.Active;

            await ClientLogService.LogDebugAsync($"CreateProductDialog: Initialized with barcode {Barcode}", "CreateProductDialog");

            // Load related entities
            await LoadRelatedEntitiesAsync();
            
            await ClientLogService.LogInformationAsync("CreateProductDialog: Dialog opened successfully", "CreateProductDialog");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error initializing CreateProductDialog");
            await ClientLogService.LogErrorAsync("CreateProductDialog: Error during initialization", ex, "CreateProductDialog");
            Snackbar.Add(TranslationService.GetTranslation("products.initError", "Errore durante l'inizializzazione"), Severity.Error);
            throw;
        }
    }

    private async Task LoadRelatedEntitiesAsync()
    {
        try
        {
            await ClientLogService.LogInformationAsync("CreateProductDialog: Loading related entities", "CreateProductDialog");
            
            // Load VAT rates
            try
            {
                await ClientLogService.LogDebugAsync("CreateProductDialog: Loading VAT rates", "CreateProductDialog");
                var vatRates = await FinancialService.GetVatRatesAsync();
                _vatRates = vatRates.ToList();
                await ClientLogService.LogInformationAsync($"CreateProductDialog: Loaded {_vatRates.Count} VAT rates", "CreateProductDialog");
                
                if (_vatRates.Count == 0)
                {
                    await ClientLogService.LogWarningAsync("CreateProductDialog: No VAT rates available", "CreateProductDialog");
                }
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Error loading VAT rates");
                await ClientLogService.LogErrorAsync("CreateProductDialog: Error loading VAT rates", ex, "CreateProductDialog");
                // Continue - VAT rate is optional
            }

            // Load units of measure
            try
            {
                await ClientLogService.LogDebugAsync("CreateProductDialog: Loading units of measure", "CreateProductDialog");
                var unitsOfMeasure = await ProductService.GetUnitsOfMeasureAsync();
                _unitsOfMeasure = unitsOfMeasure.ToList();
                await ClientLogService.LogInformationAsync($"CreateProductDialog: Loaded {_unitsOfMeasure.Count} units of measure", "CreateProductDialog");
                
                if (_unitsOfMeasure.Count == 0)
                {
                    await ClientLogService.LogWarningAsync("CreateProductDialog: No units of measure available", "CreateProductDialog");
                }
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Error loading units of measure");
                await ClientLogService.LogErrorAsync("CreateProductDialog: Error loading units of measure", ex, "CreateProductDialog");
                // Continue - unit of measure is optional
            }

            // Load classification nodes
            try
            {
                await ClientLogService.LogDebugAsync("CreateProductDialog: Loading classification nodes", "CreateProductDialog");
                var classificationNodes = await EntityManagementService.GetClassificationNodesAsync();
                var nodesList = classificationNodes.ToList();
                
                _categoryNodes = nodesList.Where(n => n.Type == ProductClassificationType.Category).ToList();
                _familyNodes = nodesList.Where(n => n.Type == ProductClassificationType.Family).ToList();
                _groupNodes = nodesList.Where(n => n.Type == ProductClassificationType.MerchandiseGroup).ToList();
                
                await ClientLogService.LogInformationAsync(
                    $"CreateProductDialog: Loaded classification nodes - Categories: {_categoryNodes.Count}, Families: {_familyNodes.Count}, Groups: {_groupNodes.Count}", 
                    "CreateProductDialog");
                
                if (nodesList.Count == 0)
                {
                    await ClientLogService.LogWarningAsync("CreateProductDialog: No classification nodes available", "CreateProductDialog");
                }
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Error loading classification nodes");
                await ClientLogService.LogErrorAsync("CreateProductDialog: Error loading classification nodes", ex, "CreateProductDialog");
                // Continue - classification nodes are optional
            }

            // Load stations
            try
            {
                await ClientLogService.LogDebugAsync("CreateProductDialog: Loading stations", "CreateProductDialog");
                var stations = await ProductService.GetStationsAsync();
                _stations = stations.ToList();
                await ClientLogService.LogInformationAsync($"CreateProductDialog: Loaded {_stations.Count} stations", "CreateProductDialog");
                
                if (_stations.Count == 0)
                {
                    await ClientLogService.LogWarningAsync("CreateProductDialog: No stations available", "CreateProductDialog");
                }
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Error loading stations");
                await ClientLogService.LogErrorAsync("CreateProductDialog: Error loading stations", ex, "CreateProductDialog");
                // Continue - station is optional
            }
            
            await ClientLogService.LogInformationAsync("CreateProductDialog: All related entities loaded", "CreateProductDialog");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading related entities");
            await ClientLogService.LogErrorAsync("CreateProductDialog: Critical error loading related entities", ex, "CreateProductDialog");
            Snackbar.Add(TranslationService.GetTranslation("products.loadError", "Errore nel caricamento dei dati"), Severity.Error);
            throw;
        }
    }

    private void ClearImage()
    {
        _selectedImage = null;
        _createDto.ImageUrl = string.Empty;
    }

    private async Task SaveProduct()
    {
        if (!_isFormValid)
        {
            await ClientLogService.LogWarningAsync("CreateProductDialog: Attempted to save product with invalid form", "CreateProductDialog");
            return;
        }

        _isLoading = true;
        try
        {
            await ClientLogService.LogInformationAsync($"CreateProductDialog: Saving product with code {_createDto.Code}", "CreateProductDialog");
            
            // Upload image if selected and not already uploaded
            if (_selectedImage != null && string.IsNullOrEmpty(_createDto.ImageUrl))
            {
                _isUploadingImage = true;
                await ClientLogService.LogDebugAsync($"CreateProductDialog: Uploading image {_selectedImage.Name}", "CreateProductDialog");
                
                var imageUrl = await ProductService.UploadProductImageAsync(_selectedImage);
                if (imageUrl != null)
                {
                    _createDto.ImageUrl = imageUrl;
                    await ClientLogService.LogInformationAsync($"CreateProductDialog: Image uploaded successfully to {imageUrl}", "CreateProductDialog");
                }
                else
                {
                    await ClientLogService.LogWarningAsync("CreateProductDialog: Image upload returned null", "CreateProductDialog");
                }
                _isUploadingImage = false;
            }

            await ClientLogService.LogDebugAsync("CreateProductDialog: Calling ProductService.CreateProductAsync", "CreateProductDialog");
            var result = await ProductService.CreateProductAsync(_createDto);

            if (result != null)
            {
                await ClientLogService.LogInformationAsync($"CreateProductDialog: Product created successfully with ID {result.Id}", "CreateProductDialog");
                
                // Create a ProductCode entry for the barcode if provided
                if (!string.IsNullOrWhiteSpace(Barcode))
                {
                    await ClientLogService.LogDebugAsync($"CreateProductDialog: Creating ProductCode entry for barcode {Barcode}", "CreateProductDialog");
                    try
                    {
                        var createCodeDto = new CreateProductCodeDto
                        {
                            ProductId = result.Id,
                            Code = Barcode,
                            CodeType = "Barcode",
                            Status = ProductCodeStatus.Active
                        };
                        
                        var codeResult = await ProductService.CreateProductCodeAsync(createCodeDto);
                        if (codeResult != null)
                        {
                            await ClientLogService.LogInformationAsync($"CreateProductDialog: ProductCode created successfully with ID {codeResult.Id}", "CreateProductDialog");
                        }
                        else
                        {
                            await ClientLogService.LogWarningAsync($"CreateProductDialog: Failed to create ProductCode for barcode {Barcode}", "CreateProductDialog");
                        }
                    }
                    catch (Exception codeEx)
                    {
                        // Log the error but don't fail the entire operation
                        Logger.LogError(codeEx, "Error creating product code for barcode {Barcode}", Barcode);
                        await ClientLogService.LogErrorAsync($"CreateProductDialog: Exception creating ProductCode: {codeEx.Message}", codeEx, "CreateProductDialog");
                    }
                }
                
                Snackbar.Add(TranslationService.GetTranslation("products.createSuccess", "Prodotto creato con successo"), Severity.Success);
                MudDialog.Close(DialogResult.Ok(result));
            }
            else
            {
                await ClientLogService.LogErrorAsync("CreateProductDialog: CreateProductAsync returned null", null, "CreateProductDialog");
                Snackbar.Add(TranslationService.GetTranslation("products.createError", "Errore nella creazione del prodotto"), Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error creating product");
            await ClientLogService.LogErrorAsync($"CreateProductDialog: Exception creating product: {ex.Message}", ex, "CreateProductDialog");
            Snackbar.Add(TranslationService.GetTranslation("products.createError", "Errore nella creazione del prodotto"), Severity.Error);
        }
        finally
        {
            _isLoading = false;
            _isUploadingImage = false;
        }
    }

    private void Cancel()
    {
        MudDialog.Cancel();
    }
}
