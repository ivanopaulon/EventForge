@inject ITranslationService TranslationService

<MudDialog>
    <DialogContent>
        <MudStack Spacing="3">
            @if (AllowGrouping)
            {
                <MudText Typo="Typo.h6">@TranslationService.GetTranslation("table.groupBy", "Raggruppa per")</MudText>
                
                <MudPaper Elevation="0" Class="pa-2" Style="border: 1px solid var(--mud-palette-lines-default);">
                    @if (_selectedGroupProperties.Count == 0)
                    {
                        <MudText Typo="Typo.body2" Class="mud-text-secondary pa-2">
                            @TranslationService.GetTranslation("table.noGrouping", "Nessun raggruppamento")
                        </MudText>
                    }
                    else
                    {
                        @foreach (var (groupProperty, index) in _selectedGroupProperties.Select((prop, idx) => (prop, idx)))
                        {
                            var column = Columns.FirstOrDefault(c => c.PropertyName == groupProperty);
                            <MudPaper Elevation="1" Class="pa-2 mb-2">
                                <div class="d-flex align-center gap-2">
                                    <MudChip T="string" Size="Size.Small" Color="@(index == 0 ? Color.Primary : Color.Secondary)">
                                        @(index + 1)
                                    </MudChip>
                                    <MudText Typo="Typo.body1" Class="flex-grow-1">
                                        @(column?.DisplayName ?? groupProperty)
                                    </MudText>
                                    <MudIconButton Icon="@Icons.Material.Outlined.ArrowUpward"
                                                  Size="Size.Small"
                                                  Color="Color.Default"
                                                  Disabled="@(index == 0)"
                                                  OnClick="@(() => MoveGroupUp(index))" />
                                    <MudIconButton Icon="@Icons.Material.Outlined.ArrowDownward"
                                                  Size="Size.Small"
                                                  Color="Color.Default"
                                                  Disabled="@(index == _selectedGroupProperties.Count - 1)"
                                                  OnClick="@(() => MoveGroupDown(index))" />
                                    <MudIconButton Icon="@Icons.Material.Outlined.Delete"
                                                  Size="Size.Small"
                                                  Color="Color.Error"
                                                  OnClick="@(() => RemoveGroup(groupProperty))" />
                                </div>
                            </MudPaper>
                        }
                    }
                    
                    <MudSelect T="string"
                               Label="@TranslationService.GetTranslation("table.addGroupLevel", "Aggiungi livello raggruppamento")"
                               Variant="Variant.Outlined"
                               Value="@((string?)null)"
                               ValueChanged="@AddGroup"
                               Class="mt-2">
                        @foreach (var prop in AvailableGroupProperties.Where(p => !_selectedGroupProperties.Contains(p)))
                        {
                            var column = Columns.FirstOrDefault(c => c.PropertyName == prop);
                            <MudSelectItem T="string" Value="@prop">
                                @(column?.DisplayName ?? prop)
                            </MudSelectItem>
                        }
                    </MudSelect>
                </MudPaper>
            }

            <MudText Typo="Typo.h6">@TranslationService.GetTranslation("table.columnOrder", "Ordine colonne")</MudText>
            
            <MudPaper Elevation="0" Class="pa-2" Style="border: 1px solid var(--mud-palette-lines-default);">
                @foreach (var column in _workingColumns.OrderBy(c => c.Order))
                {
                    <MudPaper Elevation="1" Class="pa-2 mb-2">
                        <div class="d-flex align-center gap-2">
                            <MudCheckBox @bind-Value="column.IsVisible"
                                       Color="Color.Primary"
                                       Dense="true" />
                            <MudText Typo="Typo.body1" Class="flex-grow-1">
                                @column.DisplayName
                            </MudText>
                            <MudIconButton Icon="@Icons.Material.Outlined.ArrowUpward"
                                         Size="Size.Small"
                                         Color="Color.Default"
                                         Disabled="@IsFirstColumn(column)"
                                         OnClick="@(() => MoveColumnUp(column))" />
                            <MudIconButton Icon="@Icons.Material.Outlined.ArrowDownward"
                                         Size="Size.Small"
                                         Color="Color.Default"
                                         Disabled="@IsLastColumn(column)"
                                         OnClick="@(() => MoveColumnDown(column))" />
                        </div>
                    </MudPaper>
                }
            </MudPaper>

            <MudText Typo="Typo.caption" Class="mud-text-secondary">
                @TranslationService.GetTranslation("table.columnConfigHelp", 
                    "Usa le frecce per riordinare le colonne. Deseleziona per nascondere una colonna.")
            </MudText>
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">
            @TranslationService.GetTranslation("common.cancel", "Annulla")
        </MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="Submit">
            @TranslationService.GetTranslation("common.save", "Salva")
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] IMudDialogInstance? MudDialog { get; set; }

    [Parameter] public List<EFTableColumnConfiguration> Columns { get; set; } = new();
    [Parameter] public List<string> GroupByProperties { get; set; } = new();
    [Parameter] public List<string> AvailableGroupProperties { get; set; } = new();
    [Parameter] public bool AllowGrouping { get; set; } = true;

    private List<EFTableColumnConfiguration> _workingColumns = new();
    private List<string> _selectedGroupProperties = new();

    protected override void OnInitialized()
    {
        // Create working copies of columns
        _workingColumns = Columns.Select(c => new EFTableColumnConfiguration
        {
            PropertyName = c.PropertyName,
            DisplayName = c.DisplayName,
            IsVisible = c.IsVisible,
            Order = c.Order
        }).ToList();

        _selectedGroupProperties = new List<string>(GroupByProperties);
    }

    private void MoveColumnUp(EFTableColumnConfiguration column)
    {
        var currentIndex = _workingColumns.FindIndex(c => c.PropertyName == column.PropertyName);
        if (currentIndex > 0)
        {
            var previousColumn = _workingColumns[currentIndex - 1];
            var tempOrder = column.Order;
            column.Order = previousColumn.Order;
            previousColumn.Order = tempOrder;
            
            _workingColumns = _workingColumns.OrderBy(c => c.Order).ToList();
            StateHasChanged();
        }
    }

    private void MoveColumnDown(EFTableColumnConfiguration column)
    {
        var currentIndex = _workingColumns.FindIndex(c => c.PropertyName == column.PropertyName);
        if (currentIndex < _workingColumns.Count - 1)
        {
            var nextColumn = _workingColumns[currentIndex + 1];
            var tempOrder = column.Order;
            column.Order = nextColumn.Order;
            nextColumn.Order = tempOrder;
            
            _workingColumns = _workingColumns.OrderBy(c => c.Order).ToList();
            StateHasChanged();
        }
    }

    private bool IsFirstColumn(EFTableColumnConfiguration column)
    {
        return _workingColumns.OrderBy(c => c.Order).First().PropertyName == column.PropertyName;
    }

    private bool IsLastColumn(EFTableColumnConfiguration column)
    {
        return _workingColumns.OrderBy(c => c.Order).Last().PropertyName == column.PropertyName;
    }

    private void Submit()
    {
        // Reorder based on final order values
        var orderedColumns = _workingColumns.OrderBy(c => c.Order).ToList();
        for (int i = 0; i < orderedColumns.Count; i++)
        {
            orderedColumns[i].Order = i;
        }

        var result = new EFTableColumnConfigurationResult
        {
            Columns = orderedColumns,
            GroupByProperties = new List<string>(_selectedGroupProperties)
        };

        MudDialog?.Close(DialogResult.Ok(result));
    }

    private void Cancel()
    {
        MudDialog?.Cancel();
    }

    private void AddGroup(string? propertyName)
    {
        if (!string.IsNullOrEmpty(propertyName) && !_selectedGroupProperties.Contains(propertyName))
        {
            _selectedGroupProperties.Add(propertyName);
            StateHasChanged();
        }
    }

    private void RemoveGroup(string propertyName)
    {
        _selectedGroupProperties.Remove(propertyName);
        StateHasChanged();
    }

    private void MoveGroupUp(int index)
    {
        if (index > 0 && index < _selectedGroupProperties.Count)
        {
            var temp = _selectedGroupProperties[index];
            _selectedGroupProperties[index] = _selectedGroupProperties[index - 1];
            _selectedGroupProperties[index - 1] = temp;
            StateHasChanged();
        }
    }

    private void MoveGroupDown(int index)
    {
        if (index >= 0 && index < _selectedGroupProperties.Count - 1)
        {
            var temp = _selectedGroupProperties[index];
            _selectedGroupProperties[index] = _selectedGroupProperties[index + 1];
            _selectedGroupProperties[index + 1] = temp;
            StateHasChanged();
        }
    }
}
