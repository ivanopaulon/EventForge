@inherits ErrorBoundaryBase
@using Microsoft.Extensions.Logging
@inject ILogger<ErrorBoundary> Logger

<div class="mud-alert mud-alert-outlined mud-alert-outlined-error">
    @if (CurrentException is not null)
    {
        <div class="d-flex align-center">
            <MudIcon Icon="@Icons.Material.Filled.Error" Class="mr-3" />
            <div>
                <h6 class="mb-1">Si è verificato un errore</h6>
                <p class="mb-2">@GetUserFriendlyMessage(CurrentException)</p>
                @if (ShowDetails)
                {
                    <details class="mt-2">
                        <summary class="mud-typography mud-typography-caption">Dettagli tecnici</summary>
                        <div class="mud-typography mud-typography-caption mt-1">
                            <strong>Tipo:</strong> @CurrentException.GetType().Name<br />
                            <strong>Messaggio:</strong> @CurrentException.Message
                            @if (!string.IsNullOrWhiteSpace(CurrentException.StackTrace))
                            {
                                <br /><strong>Stack Trace:</strong><br />
                                <pre style="font-size: 0.75rem; white-space: pre-wrap;">@CurrentException.StackTrace</pre>
                            }
                        </div>
                    </details>
                }
                <div class="mt-3">
                    <MudButton Variant="Variant.Filled" 
                              Color="Color.Primary" 
                              StartIcon="@Icons.Material.Filled.Refresh"
                              OnClick="Recover">
                        Riprova
                    </MudButton>
                    <MudButton Variant="Variant.Text" 
                              Color="Color.Primary"
                              Class="ml-2"
                              OnClick="() => ShowDetails = !ShowDetails">
                        @(ShowDetails ? "Nascondi" : "Mostra") dettagli
                    </MudButton>
                </div>
            </div>
        </div>
    }
</div>

@code {
    [Parameter] public bool ShowDetails { get; set; } = false;
    [Parameter] public EventCallback<Exception> OnError { get; set; }

    protected override async Task OnErrorAsync(Exception exception)
    {
        Logger.LogError(exception, "An unhandled error occurred in the UI");
        
        // Notify parent component if callback is provided
        if (OnError.HasDelegate)
        {
            await OnError.InvokeAsync(exception);
        }
    }

    private string GetUserFriendlyMessage(Exception exception)
    {
        return exception switch
        {
            HttpRequestException => "Errore di connessione al server. Verificare la connessione di rete.",
            TaskCanceledException => "La richiesta ha impiegato troppo tempo. Riprovare.",
            UnauthorizedAccessException => "Non si dispone delle autorizzazioni necessarie per questa operazione.",
            ArgumentException => "Dati non validi forniti.",
            InvalidOperationException => "Operazione non valida in questo momento.",
            _ => "Si è verificato un errore imprevisto. Riprovare o contattare l'assistenza se il problema persiste."
        };
    }
}