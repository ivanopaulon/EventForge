@inherits ErrorBoundaryBase
@using Microsoft.Extensions.Logging
@inject ILogger<ErrorBoundary> Logger

<MudAlert Severity="Severity.Error" Variant="Variant.Outlined">
    @if (CurrentException is not null)
    {
        <div class="d-flex align-center">
            <MudIcon Icon="@Icons.Material.Filled.Error" Class="mr-3" />
            <div>
                <MudText Typo="Typo.h6" Class="mb-1">Si è verificato un errore</MudText>
                <MudText Typo="Typo.body2" Class="mb-2">@GetUserFriendlyMessage(CurrentException)</MudText>
                @if (ShowDetails)
                {
                    <MudCollapse Expanded="ShowDetails">
                        <div class="mt-2">
                            <MudText Typo="Typo.caption">Dettagli tecnici</MudText>
                            <div class="mt-1">
                                <MudText Typo="Typo.caption"><strong>Tipo:</strong> @CurrentException.GetType().Name</MudText>
                                <MudText Typo="Typo.caption"><strong>Messaggio:</strong> @CurrentException.Message</MudText>
                                @if (!string.IsNullOrWhiteSpace(CurrentException.StackTrace))
                                {
                                    <MudText Typo="Typo.caption"><strong>Stack Trace:</strong></MudText>
                                    <MudText Typo="Typo.caption" Style="font-family: monospace; white-space: pre-wrap; font-size: 0.75rem;">@CurrentException.StackTrace</MudText>
                                }
                            </div>
                        </div>
                    </MudCollapse>
                }
                <div class="mt-3">
                    <MudButton Variant="Variant.Filled" 
                              Color="Color.Primary" 
                              StartIcon="@Icons.Material.Filled.Refresh"
                              OnClick="Recover">
                        Riprova
                    </MudButton>
                    <MudButton Variant="Variant.Text" 
                              Color="Color.Primary"
                              Class="ml-2"
                              OnClick="() => ShowDetails = !ShowDetails">
                        @(ShowDetails ? "Nascondi" : "Mostra") dettagli
                    </MudButton>
                </div>
            </div>
        </div>
    }
</MudAlert>

@code {
    [Parameter] public bool ShowDetails { get; set; } = false;
    [Parameter] public EventCallback<Exception> OnError { get; set; }

    protected override async Task OnErrorAsync(Exception exception)
    {
        Logger.LogError(exception, "An unhandled error occurred in the UI");
        
        // Notify parent component if callback is provided
        if (OnError.HasDelegate)
        {
            await OnError.InvokeAsync(exception);
        }
    }

    private string GetUserFriendlyMessage(Exception exception)
    {
        return exception switch
        {
            HttpRequestException => "Errore di connessione al server. Verificare la connessione di rete.",
            TaskCanceledException => "La richiesta ha impiegato troppo tempo. Riprovare.",
            UnauthorizedAccessException => "Non si dispone delle autorizzazioni necessarie per questa operazione.",
            ArgumentException => "Dati non validi forniti.",
            InvalidOperationException => "Operazione non valida in questo momento.",
            _ => "Si è verificato un errore imprevisto. Riprovare o contattare l'assistenza se il problema persiste."
        };
    }
}