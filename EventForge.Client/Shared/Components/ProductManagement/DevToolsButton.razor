@inject HttpClient Http
@inject ISnackbar Snackbar
@inject ITranslationService TranslationService
@inject ILogger<DevToolsButton> Logger

<MudButton Variant="Variant.Filled"
           Color="Color.Warning"
           StartIcon="@Icons.Material.Outlined.Science"
           OnClick="HandleClick"
           Disabled="@_isGenerating">
    @TranslationService.GetTranslation("devtools.generateProducts.button", "Genera prodotti di test")
</MudButton>

@code {
    [Parameter]
    public int Count { get; set; } = 10;

    [Parameter]
    public EventCallback<bool> OnGenerateCompleted { get; set; }

    private bool _isGenerating = false;

    private async Task HandleClick()
    {
        if (_isGenerating) return;

        _isGenerating = true;
        StateHasChanged();

        try
        {
            var payload = new { count = Count };
            var response = await Http.PostAsJsonAsync("/api/devtools/generate-test-products", payload);

            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add(
                    TranslationService.GetTranslation("devtools.generateProducts.started", "Generazione avviata"),
                    Severity.Info);
                await OnGenerateCompleted.InvokeAsync(true);
            }
            else
            {
                var errorText = await response.Content.ReadAsStringAsync();
                Snackbar.Add(
                    TranslationService.GetTranslation("devtools.generateProducts.error", "Errore generazione: {0}", errorText),
                    Severity.Error);
                await OnGenerateCompleted.InvokeAsync(false);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Errore durante la generazione dei prodotti di test");
            Snackbar.Add(
                TranslationService.GetTranslation("devtools.generateProducts.unexpectedError", "Errore generazione: {0}", ex.Message),
                Severity.Error);
            await OnGenerateCompleted.InvokeAsync(false);
        }
        finally
        {
            _isGenerating = false;
            StateHasChanged();
        }
    }
}
