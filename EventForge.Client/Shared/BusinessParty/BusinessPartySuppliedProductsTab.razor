@using EventForge.DTOs.Products
@using EventForge.DTOs.Common
@inject IProductService ProductService
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject ITranslationService TranslationService
@inject ILogger<BusinessPartySuppliedProductsTab> Logger

<MudStack Spacing="3">
    <!-- Toolbar -->
    <MudPaper Elevation="1" Class="pa-4">
        <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
            <MudText Typo="Typo.h6">@TranslationService.GetTranslation("businessParty.suppliedProducts", "Prodotti Forniti")</MudText>
            <MudSpacer />
            <MudButton Variant="Variant.Outlined"
                      Color="Color.Primary"
                      StartIcon="@Icons.Material.Filled.Checklist"
                      OnClick="@OpenManageProductsDialog">
                @TranslationService.GetTranslation("productSupplier.manageBulk", "Gestisci Catalogo")
            </MudButton>
            <MudButton Variant="Variant.Filled"
                      Color="Color.Primary"
                      StartIcon="@Icons.Material.Filled.Add"
                      OnClick="@OpenAssignProductDialog">
                @TranslationService.GetTranslation("productSupplier.assign", "Assegna Prodotto")
            </MudButton>
        </MudStack>
    </MudPaper>

    <!-- Products Table -->
    <MudTable @ref="_table"
              ServerData="@(new Func<TableState, CancellationToken, Task<TableData<ProductSupplierDto>>>(LoadServerData))"
              Hover="true"
              Dense="true"
              Loading="@_isLoading"
              LoadingProgressColor="Color.Primary"
              FixedHeader="true"
              Height="calc(100vh - 350px)"
              T="ProductSupplierDto">
        <ToolBarContent>
            <MudText Typo="Typo.body2" Class="mr-4">
                @TranslationService.GetTranslation("common.total", "Totale"): @_totalCount
            </MudText>
        </ToolBarContent>
        <HeaderContent>
            <MudTh>@TranslationService.GetTranslation("product.code", "Codice")</MudTh>
            <MudTh>@TranslationService.GetTranslation("product.name", "Nome")</MudTh>
            <MudTh>@TranslationService.GetTranslation("productSupplier.supplierCode", "Codice Fornitore")</MudTh>
            <MudTh Style="text-align: right;">@TranslationService.GetTranslation("productSupplier.unitCost", "Costo Unitario")</MudTh>
            <MudTh Style="text-align: right;">@TranslationService.GetTranslation("productSupplier.lastPurchasePrice", "Ultimo Prezzo")</MudTh>
            <MudTh>@TranslationService.GetTranslation("productSupplier.lastPurchaseDate", "Ultima Data")</MudTh>
            <MudTh Style="text-align: center;">@TranslationService.GetTranslation("productSupplier.leadTime", "Lead Time (gg)")</MudTh>
            <MudTh Style="text-align: center;">@TranslationService.GetTranslation("productSupplier.preferred", "Preferito")</MudTh>
            <MudTh Style="text-align: center;">@TranslationService.GetTranslation("common.actions", "Azioni")</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="@TranslationService.GetTranslation("product.code", "Codice")">
                @context.ProductName
            </MudTd>
            <MudTd DataLabel="@TranslationService.GetTranslation("product.name", "Nome")">
                @context.ProductName
            </MudTd>
            <MudTd DataLabel="@TranslationService.GetTranslation("productSupplier.supplierCode", "Codice Fornitore")">
                @context.SupplierProductCode
            </MudTd>
            <MudTd DataLabel="@TranslationService.GetTranslation("productSupplier.unitCost", "Costo Unitario")" Style="text-align: right;">
                @if (context.UnitCost.HasValue)
                {
                    <text>@context.UnitCost.Value.ToString("C2")</text>
                }
                else
                {
                    <text>-</text>
                }
            </MudTd>
            <MudTd DataLabel="@TranslationService.GetTranslation("productSupplier.lastPurchasePrice", "Ultimo Prezzo")" Style="text-align: right;">
                @if (context.LastPurchasePrice.HasValue)
                {
                    <text>@context.LastPurchasePrice.Value.ToString("C2")</text>
                }
                else
                {
                    <text>-</text>
                }
            </MudTd>
            <MudTd DataLabel="@TranslationService.GetTranslation("productSupplier.lastPurchaseDate", "Ultima Data")">
                @(context.LastPurchaseDate?.ToShortDateString() ?? "-")
            </MudTd>
            <MudTd DataLabel="@TranslationService.GetTranslation("productSupplier.leadTime", "Lead Time (gg)")" Style="text-align: center;">
                @(context.LeadTimeDays?.ToString() ?? "-")
            </MudTd>
            <MudTd DataLabel="@TranslationService.GetTranslation("productSupplier.preferred", "Preferito")" Style="text-align: center;">
                @if (context.Preferred)
                {
                    <MudIcon Icon="@Icons.Material.Filled.Star" Color="Color.Warning" Size="Size.Small" />
                }
            </MudTd>
            <MudTd DataLabel="@TranslationService.GetTranslation("common.actions", "Azioni")" Style="text-align: center;">
                <MudIconButton Icon="@Icons.Material.Filled.Edit"
                              Size="Size.Small"
                              Color="Color.Primary"
                              OnClick="@(() => EditProductSupplier(context))" />
                <MudIconButton Icon="@Icons.Material.Filled.Delete"
                              Size="Size.Small"
                              Color="Color.Error"
                              OnClick="@(() => DeleteProductSupplier(context))" />
            </MudTd>
        </RowTemplate>
        <NoRecordsContent>
            <MudText>@TranslationService.GetTranslation("productSupplier.noRecords", "Nessun prodotto trovato")</MudText>
        </NoRecordsContent>
        <LoadingContent>
            <MudText>@TranslationService.GetTranslation("common.loading", "Caricamento...")</MudText>
        </LoadingContent>
        <PagerContent>
            <MudTablePager PageSizeOptions="new int[] { 10, 20, 50, 100 }" />
        </PagerContent>
    </MudTable>
</MudStack>

@code {
    [Parameter] public Guid BusinessPartyId { get; set; }

    private MudTable<ProductSupplierDto>? _table;
    private bool _isLoading = false;
    private int _totalCount = 0;

    protected override async Task OnParametersSetAsync()
    {
        if (_table != null)
        {
            await _table.ReloadServerData();
        }
    }

    private async Task<TableData<ProductSupplierDto>> LoadServerData(TableState state, CancellationToken cancellationToken)
    {
        _isLoading = true;
        try
        {
            var page = (int)state.Page + 1;
            var pageSize = (int)state.PageSize;

            var result = await ProductService.GetProductsBySupplierAsync(
                BusinessPartyId,
                page,
                pageSize);

            if (result != null)
            {
                _totalCount = (int)result.TotalCount;

                return new TableData<ProductSupplierDto>
                {
                    Items = result.Items,
                    TotalItems = (int)result.TotalCount
                };
            }

            return new TableData<ProductSupplierDto> { Items = new List<ProductSupplierDto>(), TotalItems = 0 };
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading products for supplier {BusinessPartyId}", BusinessPartyId);
            Snackbar.Add(TranslationService.GetTranslation("productSupplier.loadError", "Errore nel caricamento dei prodotti"), Severity.Error);
            return new TableData<ProductSupplierDto> { Items = new List<ProductSupplierDto>(), TotalItems = 0 };
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task OpenManageProductsDialog()
    {
        var parameters = new DialogParameters
        {
            { "SupplierId", BusinessPartyId },
            { "SupplierName", string.Empty }
        };

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.ExtraExtraLarge,
            FullWidth = true,
            FullScreen = true,
            CloseButton = true
        };

        var dialog = await DialogService.ShowAsync<ManageSupplierProductsDialog>(
            TranslationService.GetTranslation("supplier.manageProducts", "Gestisci Prodotti"),
            parameters,
            options);

        var result = await dialog.Result;

        if (!result.Canceled && _table != null)
        {
            await _table.ReloadServerData();
            Snackbar.Add(
                TranslationService.GetTranslation("productSupplier.bulkUpdateSuccess", "Catalogo aggiornato con successo"),
                Severity.Success);
        }
    }

    private async Task OpenAssignProductDialog()
    {
        var parameters = new DialogParameters
        {
            { "SupplierId", BusinessPartyId }
        };

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Medium,
            FullWidth = true,
            CloseButton = true
        };

        var dialog = await DialogService.ShowAsync<AddProductSupplierDialog>(
            TranslationService.GetTranslation("productSupplier.assignTitle", "Assegna Prodotto"),
            parameters,
            options);

        var result = await dialog.Result;

        if (!result.Canceled && _table != null)
        {
            await _table.ReloadServerData();
        }
    }

    private async Task EditProductSupplier(ProductSupplierDto productSupplier)
    {
        var parameters = new DialogParameters
        {
            { "ProductSupplierId", productSupplier.Id }
        };

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Medium,
            FullWidth = true,
            CloseButton = true
        };

        var dialog = await DialogService.ShowAsync<EditProductSupplierDialog>(
            TranslationService.GetTranslation("productSupplier.editTitle", "Modifica Associazione"),
            parameters,
            options);

        var result = await dialog.Result;

        if (!result.Canceled && _table != null)
        {
            await _table.ReloadServerData();
        }
    }

    private async Task DeleteProductSupplier(ProductSupplierDto productSupplier)
    {
        var confirmed = await DialogService.ShowMessageBox(
            TranslationService.GetTranslation("common.confirm", "Conferma"),
            TranslationService.GetTranslation("productSupplier.deleteConfirm", "Sei sicuro di voler eliminare questa associazione?"),
            yesText: TranslationService.GetTranslation("common.yes", "SÃ¬"),
            noText: TranslationService.GetTranslation("common.no", "No"));

        if (confirmed == true)
        {
            try
            {
                await ProductService.RemoveProductSupplierAsync(productSupplier.Id);
                Snackbar.Add(TranslationService.GetTranslation("productSupplier.deleteSuccess", "Associazione eliminata con successo"), Severity.Success);
                
                if (_table != null)
                {
                    await _table.ReloadServerData();
                }
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Error deleting product supplier {Id}", productSupplier.Id);
                Snackbar.Add(TranslationService.GetTranslation("productSupplier.deleteError", "Errore nell'eliminazione"), Severity.Error);
            }
        }
    }
}
