@page "/financial/tax-accounts"
@using Microsoft.AspNetCore.Authorization
@using EventForge.DTOs.Financial
@using EventForge.DTOs.Common
@using EventForge.Client.Shared.Components
@attribute [Authorize]
@inject IAuthService AuthService
@inject IFinancialService FinancialService
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject ITranslationService TranslationService
@inject ILogger<TaxAccountManagement> Logger

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
 <PageLoadingOverlay IsVisible="_isLoading || _isLoadingTaxAccounts"
 Message="@(_isLoading ? TranslationService.GetTranslation("messages.loadingPage", "Caricamento pagina...") : TranslationService.GetTranslation("common.loading", "Caricamento..."))" />

 @if (_isLoading)
 {
 <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
 }
 else
 {
 <MudPaper Elevation="2" Class="pa-2 pa-sm-3 pa-md-4 mb-4">
 <div class="d-flex justify-space-between align-center mb-4">
 <div>
 <MudText Typo="Typo.h4">
 <MudIcon Icon="@Icons.Material.Outlined.AccountBalance" Class="mr-2" />
 @TranslationService.GetTranslation("financial.taxAccountManagement", "Gestione Conti IVA")
 </MudText>
 <MudText Typo="Typo.body2" Class="mud-text-secondary mt-2">
 @TranslationService.GetTranslation("financial.taxAccountManagementDescription", "Configura conti IVA per la contabilità")
 </MudText>
 </div>
 </div>

 <!-- Filters Section -->
 <MudPaper Elevation="0" Class="pa-3 mb-4" Style="background-color: var(--mud-palette-background-grey);">
 <div class="d-flex gap-3 align-center flex-wrap">
 <MudTextField @bind-Value="_searchTerm"
 @bind-Value:after="OnSearchChanged"
 Label="@TranslationService.GetTranslation("financial.searchTaxAccounts", "Cerca conti IVA")"
 Placeholder="@TranslationService.GetTranslation("financial.searchTaxAccountPlaceholder", "Inserisci codice o descrizione...")"
 Variant="Variant.Outlined"
 Adornment="Adornment.End"
 AdornmentIcon="@Icons.Material.Outlined.Search"
 Clearable="true"
 Style="flex:2;" />
 </div>
 </MudPaper>

 <!-- Tax Accounts Data Table -->
 <MudPaper Elevation="1" Class="border-rounded">
 <MudCardHeader Class="pa-2">
 <CardHeaderContent>
 <MudText Typo="Typo.h6">
 <MudIcon Icon="@Icons.Material.Outlined.List" Class="mr-2" />
 @TranslationService.GetTranslation("financial.taxAccountList", "Lista Conti IVA")
 <MudText Typo="Typo.body2" Class="mud-text-secondary ml-2">
 (@_filteredTaxAccounts.Count() @TranslationService.GetTranslation("financial.itemsFound", "elementi trovati"))
 </MudText>
 </MudText>
 </CardHeaderContent>
 <CardHeaderActions>
 <ActionButtonGroup Mode="ActionButtonGroupMode.Toolbar"
 ShowRefresh="true"
 ShowExport="true" 
 ShowCreate="true"
 ShowAuditLog="false"
 CreateIcon="@Icons.Material.Outlined.Add"
 CreateTooltip="@TranslationService.GetTranslation("financial.createNewTaxAccount", "Crea nuovo conto IVA")"
 IsDisabled="_isLoadingTaxAccounts"
 OnRefresh="@LoadTaxAccountsAsync"
 OnCreate="@OpenCreateTaxAccountDialog" />
 </CardHeaderActions>
 </MudCardHeader>
 <MudCardContent Class="pa-1">
 @if (_isLoadingTaxAccounts)
 {
 <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="mt-4" />
 }
 else
 {
 <MudTable T="TaxAccountDto" 
 Items="_filteredTaxAccounts" 
 Hover="true" 
 Striped="true"
 Loading="_isLoadingTaxAccounts"
 LoadingProgressColor="Color.Info"
 SortLabel="@TranslationService.GetTranslation("tooltip.sortColumn", "Ordina colonna")"
 AllowUnsorted="false"
 Dense="false"
 Breakpoint="Breakpoint.Sm">
 <HeaderContent>
 <MudTh><MudTableSortLabel SortBy="@(new Func<TaxAccountDto, object>(x => x.Code))">@TranslationService.GetTranslation("field.code", "Codice")</MudTableSortLabel></MudTh>
 <MudTh><MudTableSortLabel SortBy="@(new Func<TaxAccountDto, object>(x => x.Name))">@TranslationService.GetTranslation("field.name", "Nome")</MudTableSortLabel></MudTh>
 <MudTh>@TranslationService.GetTranslation("field.description", "Descrizione")</MudTh>
 <MudTh><MudTableSortLabel SortBy="@(new Func<TaxAccountDto, object>(x => x.CreatedAt))">@TranslationService.GetTranslation("field.createdAt", "Creato il")</MudTableSortLabel></MudTh>
 <MudTh Class="text-center" Style="min-width:120px;">@TranslationService.GetTranslation("common.actions", "Azioni")</MudTh>
 </HeaderContent>

 <RowTemplate>
 <MudTd DataLabel="@TranslationService.GetTranslation("field.code", "Codice")">
 <MudChip T="string" Size="Size.Small" Color="Color.Primary" Variant="Variant.Outlined">
 @context.Code
 </MudChip>
 </MudTd>
 <MudTd DataLabel="@TranslationService.GetTranslation("field.name", "Nome")">
 <MudText Typo="Typo.body2">@context.Name</MudText>
 </MudTd>
 <MudTd DataLabel="@TranslationService.GetTranslation("field.description", "Descrizione")">
 <MudText Typo="Typo.body2" Class="text-truncate" Style="max-width:400px;">
 @(string.IsNullOrEmpty(context.Description) ? "-" : context.Description)
 </MudText>
 </MudTd>
 <MudTd DataLabel="@TranslationService.GetTranslation("field.createdAt", "Creato il")">
 <MudText Typo="Typo.body2">@context.CreatedAt.ToString("dd/MM/yyyy HH:mm")</MudText>
 </MudTd>
 <MudTd DataLabel="@TranslationService.GetTranslation("common.actions", "Azioni")" Class="text-center">
 <ActionButtonGroup EntityName="@context.Name"
 ItemDisplayName="@context.Name"
 ShowView="true"
 ShowEdit="true"
 ShowAuditLog="false"
 ShowToggleStatus="false"
 ShowDelete="true"
 OnView="@(() => ViewTaxAccount(context))"
 OnEdit="@(() => EditTaxAccount(context))"
 OnDelete="@(() => DeleteTaxAccount(context))" />
 </MudTd>
 </RowTemplate>

 <NoRecordsContent>
 <div class="text-center pa-2 pa-sm-3 pa-md-4">
 <MudIcon Icon="@Icons.Material.Outlined.AccountBalance" Size="Size.Medium" Class="mb-4 mud-text-secondary" />
 <MudText Typo="Typo.h6" Class="mb-2">
 @(_taxAccounts.Any() ? 
 TranslationService.GetTranslation("financial.noTaxAccountsMatchFilters", "Nessun conto IVA corrisponde ai filtri applicati") : 
 TranslationService.GetTranslation("financial.noTaxAccountsFound", "Nessun conto IVA trovato"))
 </MudText>
 @if (_taxAccounts.Any())
 {
 <MudButton Variant="Variant.Text" 
 Color="Color.Primary" 
 StartIcon="@Icons.Material.Outlined.Clear"
 OnClick="@ClearFilters">
 @TranslationService.GetTranslation("financial.clearFilters", "Cancella filtri")
 </MudButton>
 }
 </div>
 </NoRecordsContent>
 </MudTable>
 }
 </MudCardContent>
 </MudPaper>
 </MudPaper>
 }
</MudContainer>

@code {
 // ...existing code...
}
