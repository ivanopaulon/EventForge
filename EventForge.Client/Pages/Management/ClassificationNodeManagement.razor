@page "/management/classification-nodes"
@using Microsoft.AspNetCore.Authorization
@using EventForge.DTOs.Common
@using EventForge.Client.Shared.Components
@attribute [Authorize(Roles = "SuperAdmin,Admin,Manager")]
@inject EventForge.Client.Services.IEntityManagementService EntityManagementService
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject ITranslationService TranslationService
@inject ILogger<ClassificationNodeManagement> Logger

<PageTitle>@TranslationService.GetTranslation("classifications.management", "Gestione Classificazioni")</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4" Style="height:100vh; display:flex; flex-direction:column;">
    <PageLoadingOverlay IsVisible="_isLoading" Message="@TranslationService.GetTranslation("messages.loadingPage", "Caricamento pagina...")" />

    <MudPaper Elevation="1" Class="pa-3 mb-4" Style="min-height:0;">
        <MudText Typo="Typo.h4">
            <MudIcon Icon="@Icons.Material.Outlined.Category" Class="mr-2" />
            @TranslationService.GetTranslation("classifications.management", "Gestione Classificazioni")
        </MudText>
    </MudPaper>

    <MudPaper Elevation="1" Class="pa-4 flex-grow-1 d-flex flex-column" Style="min-height:0;">
        <MudTextField @bind-Value="_search" Placeholder="@TranslationService.GetTranslation("classifications.searchPlaceholder", "Cerca classificazioni...")" Variant="Variant.Outlined" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Outlined.Search" />
        <div Style="overflow:auto; min-height:0; flex:1;">
            <MudTable Items="@_nodes" Loading="_isLoading" Hover="true" Striped="true" Class="mt-3">
                <HeaderContent>
                    <MudTh>@TranslationService.GetTranslation("field.name", "Nome")</MudTh>
                    <MudTh>@TranslationService.GetTranslation("field.code", "Codice")</MudTh>
                    <MudTh>@TranslationService.GetTranslation("common.actions", "Azioni")</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd>@context.Name</MudTd>
                    <MudTd>@context.Code</MudTd>
                    <MudTd>
                        <MudButton Size="Size.Small" Variant="Variant.Text" OnClick="@(() => EditNode(context))">@TranslationService.GetTranslation("common.edit", "Modifica")</MudButton>
                    </MudTd>
                </RowTemplate>
            </MudTable>
        </div>
    </MudPaper>
</MudContainer>

@code {
    private bool _isLoading = true;
    private string _search = string.Empty;
    private List<ClassificationNodeDto> _nodes = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadNodes();
    }

    private async Task LoadNodes()
    {
        try
        {
            _isLoading = true;
            var nodes = await EntityManagementService.GetClassificationNodesAsync();
            _nodes = nodes?.ToList() ?? new List<ClassificationNodeDto>();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading classifications");
            Snackbar.Add(TranslationService.GetTranslation("common.errorLoading", "Errore nel caricamento"), Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void EditNode(ClassificationNodeDto node)
    {
        Snackbar.Add(TranslationService.GetTranslation("common.notImplemented", "Funzionalit√† non ancora implementata"), Severity.Info);
    }
}
