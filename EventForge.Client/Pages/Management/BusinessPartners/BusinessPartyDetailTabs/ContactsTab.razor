@using EventForge.DTOs.Business
@using EventForge.DTOs.Common
@using EventForge.Client.Services
@using EventForge.Client.Shared.Components.UI.Dialogs
@inject IEntityManagementService EntityManagementService
@inject ITranslationService TranslationService
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject ILogger<ContactsTab> Logger

<MudPaper Elevation="1" Class="pa-4">
    <div class="d-flex justify-space-between align-center mb-4">
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Outlined.ContactPhone" Class="mr-2" />
            @TranslationService.GetTranslation("businessParty.contacts", "Contatti")
        </MudText>
        <MudButton Variant="Variant.Filled" 
                   Color="Color.Primary" 
                   StartIcon="@Icons.Material.Filled.Add"
                   OnClick="@OpenAddDialog"
                   Size="Size.Small">
            @TranslationService.GetTranslation("button.add", "Aggiungi")
        </MudButton>
    </div>

    @if (_isLoading)
    {
        <MudProgressLinear Indeterminate="true" Class="my-4" />
    }
    else if (!_contacts.Any())
    {
        <MudAlert Severity="Severity.Info">
            @TranslationService.GetTranslation("businessParty.noContacts", "Nessun contatto configurato")
        </MudAlert>
    }
    else
    {
        <MudTable Items="_contacts" Dense="true" Hover="true" Striped="true">
            <HeaderContent>
                <MudTh>@TranslationService.GetTranslation("field.contactType", "Tipo")</MudTh>
                <MudTh>@TranslationService.GetTranslation("field.value", "Valore")</MudTh>
                <MudTh>@TranslationService.GetTranslation("field.purpose", "Scopo")</MudTh>
                <MudTh>@TranslationService.GetTranslation("field.isPrimary", "Primario")</MudTh>
                <MudTh>@TranslationService.GetTranslation("field.notes", "Note")</MudTh>
                <MudTh Style="width: 120px;">@TranslationService.GetTranslation("field.actions", "Azioni")</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Tipo">@GetContactTypeText(context.ContactType)</MudTd>
                <MudTd DataLabel="Valore">@context.Value</MudTd>
                <MudTd DataLabel="Scopo">@GetContactPurposeText(context.Purpose)</MudTd>
                <MudTd DataLabel="Primario">
                    @if (context.IsPrimary)
                    {
                        <MudIcon Icon="@Icons.Material.Filled.Check" Color="Color.Success" Size="Size.Small" />
                    }
                </MudTd>
                <MudTd DataLabel="Note">@context.Notes</MudTd>
                <MudTd DataLabel="Azioni">
                    <MudIconButton Icon="@Icons.Material.Filled.Edit" 
                                   Size="Size.Small" 
                                   Color="Color.Primary"
                                   OnClick="@(() => OpenEditDialog(context))"
                                   title="@TranslationService.GetTranslation("button.edit", "Modifica")" />
                    <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                   Size="Size.Small" 
                                   Color="Color.Error"
                                   OnClick="@(() => DeleteContactAsync(context))"
                                   title="@TranslationService.GetTranslation("button.delete", "Elimina")" />
                </MudTd>
            </RowTemplate>
        </MudTable>
    }
</MudPaper>

@code {
    [Parameter] public BusinessPartyDto Party { get; set; } = new();
    [Parameter] public bool IsEditMode { get; set; } = true;
    [Parameter] public EventCallback OnPartyUpdated { get; set; }

    private List<ContactDto> _contacts = new();
    private bool _isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadContactsAsync();
    }

    protected override async Task OnParametersSetAsync()
    {
        await LoadContactsAsync();
    }

    private async Task LoadContactsAsync()
    {
        if (Party?.Id == Guid.Empty) 
        {
            _contacts = new List<ContactDto>();
            _isLoading = false;
            return;
        }

        _isLoading = true;
        try
        {
            var contacts = await EntityManagementService.GetContactsByOwnerAsync(Party.Id);
            _contacts = contacts?.ToList() ?? new List<ContactDto>();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading contacts for business party {PartyId}", Party.Id);
            Snackbar.Add(TranslationService.GetTranslation("businessParty.contactsLoadError", "Errore nel caricamento dei contatti"), Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private string GetContactTypeText(ContactType type) => type switch
    {
        ContactType.Email => TranslationService.GetTranslation("contactType.email", "Email"),
        ContactType.Phone => TranslationService.GetTranslation("contactType.phone", "Telefono"),
        ContactType.Fax => TranslationService.GetTranslation("contactType.fax", "Fax"),
        ContactType.PEC => TranslationService.GetTranslation("contactType.pec", "PEC"),
        ContactType.Other => TranslationService.GetTranslation("contactType.other", "Altro"),
        _ => type.ToString()
    };

    private string GetContactPurposeText(ContactPurpose purpose) => purpose switch
    {
        ContactPurpose.Primary => TranslationService.GetTranslation("contactPurpose.primary", "Primario"),
        ContactPurpose.Emergency => TranslationService.GetTranslation("contactPurpose.emergency", "Emergenza"),
        ContactPurpose.Billing => TranslationService.GetTranslation("contactPurpose.billing", "Fatturazione"),
        ContactPurpose.Legal => TranslationService.GetTranslation("contactPurpose.legal", "Legale"),
        ContactPurpose.Other => TranslationService.GetTranslation("contactPurpose.other", "Altro"),
        _ => purpose.ToString()
    };

    private async Task OpenAddDialog()
    {
        var parameters = new DialogParameters
        {
            ["OwnerId"] = Party.Id,
            ["OwnerType"] = "BusinessParty"
        };

        var options = new DialogOptions 
        { 
            CloseOnEscapeKey = true,
            MaxWidth = MaxWidth.Medium,
            FullWidth = true
        };

        var dialog = await DialogService.ShowAsync<ContactDialog>(
            TranslationService.GetTranslation("businessParty.addContact", "Aggiungi Contatto"),
            parameters,
            options);

        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await LoadContactsAsync();
            await OnPartyUpdated.InvokeAsync();
        }
    }

    private async Task OpenEditDialog(ContactDto contact)
    {
        var parameters = new DialogParameters
        {
            ["Contact"] = contact
        };

        var options = new DialogOptions 
        { 
            CloseOnEscapeKey = true,
            MaxWidth = MaxWidth.Medium,
            FullWidth = true
        };

        var dialog = await DialogService.ShowAsync<ContactDialog>(
            TranslationService.GetTranslation("businessParty.editContact", "Modifica Contatto"),
            parameters,
            options);

        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await LoadContactsAsync();
            await OnPartyUpdated.InvokeAsync();
        }
    }

    private async Task DeleteContactAsync(ContactDto contact)
    {
        var confirmed = await DialogService.ShowMessageBox(
            TranslationService.GetTranslation("common.confirm", "Conferma"),
            TranslationService.GetTranslation("businessParty.deleteContactConfirm", "Sei sicuro di voler eliminare questo contatto?"),
            yesText: TranslationService.GetTranslation("button.delete", "Elimina"),
            cancelText: TranslationService.GetTranslation("button.cancel", "Annulla"));

        if (confirmed == true)
        {
            try
            {
                await EntityManagementService.DeleteContactAsync(contact.Id);
                Snackbar.Add(TranslationService.GetTranslation("messages.deleteSuccessful", "Eliminazione completata con successo"), Severity.Success);
                await LoadContactsAsync();
                await OnPartyUpdated.InvokeAsync();
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Error deleting contact {ContactId}", contact.Id);
                Snackbar.Add(TranslationService.GetTranslation("messages.deleteFailed", "Errore durante l'eliminazione"), Severity.Error);
            }
        }
    }
}
