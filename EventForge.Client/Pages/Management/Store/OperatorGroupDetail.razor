@page "/store/operator-groups/{GroupId:guid}"
@page "/store/operator-groups/{GroupIdString}"
@using Microsoft.AspNetCore.Authorization
@using EventForge.DTOs.Store
@using EventForge.DTOs.Common
@using EventForge.Client.Shared.Components
@attribute [Authorize]
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject ITranslationService TranslationService
@inject ILogger<OperatorGroupDetail> Logger
@using EventForge.Client.ViewModels
@inject OperatorGroupDetailViewModel ViewModel
@implements IDisposable

<PageLoadingOverlay Visible="ViewModel.IsLoading || ViewModel.IsSaving"
                     Message="@(ViewModel.IsSaving ? TranslationService.GetTranslation("common.saving", "Salvataggio...") : TranslationService.GetTranslation("common.loading", "Caricamento..."))" />

@if (!ViewModel.IsLoading)
{
    <div class="product-page-root">
        @if (ViewModel.Entity == null)
        {
            <MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
                <MudAlert Severity="Severity.Error">
                    @TranslationService.GetTranslation("store.operatorGroupNotFound", "Gruppo operatori non trovato")
                </MudAlert>
            </MudContainer>
        }
        else
        {
            <div class="product-top">
                <MudPaper Elevation="2" Class="pa-4 mb-4">
                    <div class="d-flex justify-space-between align-center flex-wrap gap-2">
                        <div class="d-flex align-center gap-2">
                            <MudIconButton Icon="@Icons.Material.Filled.ArrowBack"
                                           Color="Color.Primary"
                                           OnClick="@(() => TryNavigateAway("/store/operator-groups"))"
                                           Size="Size.Medium"
                                           title="@TranslationService.GetTranslation("common.back", "Indietro")" />
                            <MudText Typo="Typo.h5">
                                @(ViewModel.IsNewEntity ? TranslationService.GetTranslation("store.newOperatorGroup", "Nuovo Gruppo Operatori") : TranslationService.GetTranslation("store.operatorGroupDetail", "Dettaglio Gruppo Operatori"))
                            </MudText>
                        </div>
                        <div class="d-flex gap-2 align-center">
                            @if (ViewModel.HasUnsavedChanges())
                            {
                                <MudChip T="string" Size="Size.Small" Color="Color.Warning" Icon="@Icons.Material.Outlined.Edit">
                                    @TranslationService.GetTranslation("common.unsavedChanges", "Modifiche non salvate")
                                </MudChip>
                            }
                            <MudButton Variant="Variant.Filled"
                                       Color="Color.Primary"
                                       StartIcon="@Icons.Material.Filled.Save"
                                       OnClick="SaveAsync"
                                       Disabled="ViewModel.IsSaving || (ViewModel.Entity.IsSystemGroup && !ViewModel.IsNewEntity)"
                                       Size="Size.Medium">
                                @TranslationService.GetTranslation("common.save", "Salva")
                            </MudButton>
                        </div>
                    </div>
                    @if (!ViewModel.IsNewEntity)
                    {
                        <MudDivider Class="my-3" />
                        <div class="d-flex align-center gap-4 flex-wrap">
                            <div class="d-flex align-center gap-2">
                                <MudAvatar Color="Color.Primary" Size="Size.Medium">
                                    <MudIcon Icon="@Icons.Material.Outlined.Groups" />
                                </MudAvatar>
                                <div>
                                    <MudText Typo="Typo.body1" Style="font-weight: 600;">@ViewModel.Entity.Name</MudText>
                                    <MudText Typo="Typo.caption" Class="mud-text-secondary">
                                        Code: @ViewModel.Entity.Code - ID: @ViewModel.Entity.Id.ToString()[..8]...
                                    </MudText>
                                </div>
                            </div>
                            <MudChip T="string" Size="Size.Medium" Color="GetStatusColor(ViewModel.Entity.Status)">
                                @GetStatusText(ViewModel.Entity.Status)
                            </MudChip>
                            @if (ViewModel.Entity.IsSystemGroup)
                            {
                                <MudChip T="string" Size="Size.Medium" Color="Color.Default" Icon="@Icons.Material.Outlined.Lock">
                                    @TranslationService.GetTranslation("status.systemGroup", "Gruppo di Sistema")
                                </MudChip>
                            }
                            @if (ViewModel.Entity.IsDefault)
                            {
                                <MudChip T="string" Size="Size.Medium" Color="Color.Warning" Icon="@Icons.Material.Outlined.Star">
                                    @TranslationService.GetTranslation("status.default", "Default")
                                </MudChip>
                            }
                        </div>
                    }
                </MudPaper>
            </div>

            <div class="eftable-wrapper">
                <MudPaper Elevation="2" Class="pa-4">
                    @if (ViewModel.Entity.IsSystemGroup && !ViewModel.IsNewEntity)
                    {
                        <MudAlert Severity="Severity.Info" Class="mb-4">
                            @TranslationService.GetTranslation("store.systemGroupReadOnly", "Questo è un gruppo di sistema e non può essere modificato.")
                        </MudAlert>
                    }
                    <MudForm @ref="_form" Model="@ViewModel.Entity">
                        <MudGrid>
                            <MudItem xs="12" md="6">
                                <MudTextField @bind-Value="ViewModel.Entity.Code"
                                              Label="@TranslationService.GetTranslation("field.code", "Codice")"
                                              Required="true"
                                              MaxLength="50"
                                              Variant="Variant.Outlined"
                                              Disabled="@(ViewModel.Entity.IsSystemGroup && !ViewModel.IsNewEntity)"
                                              @bind-Value:after="HandleEntityChanged" />
                            </MudItem>

                            <MudItem xs="12" md="6">
                                <MudTextField @bind-Value="ViewModel.Entity.Name"
                                              Label="@TranslationService.GetTranslation("field.name", "Nome")"
                                              Required="true"
                                              MaxLength="50"
                                              Variant="Variant.Outlined"
                                              Disabled="@(ViewModel.Entity.IsSystemGroup && !ViewModel.IsNewEntity)"
                                              @bind-Value:after="HandleEntityChanged" />
                            </MudItem>

                            <MudItem xs="12" md="6">
                                <MudSelect @bind-Value="ViewModel.Entity.Status"
                                           Label="@TranslationService.GetTranslation("field.status", "Status")"
                                           Variant="Variant.Outlined"
                                           Disabled="@(ViewModel.Entity.IsSystemGroup && !ViewModel.IsNewEntity)"
                                           @bind-Value:after="HandleEntityChanged">
                                    @foreach (CashierGroupStatus status in Enum.GetValues(typeof(CashierGroupStatus)))
                                    {
                                        <MudSelectItem Value="@status">@GetStatusText(status)</MudSelectItem>
                                    }
                                </MudSelect>
                            </MudItem>

                            <MudItem xs="12" md="6">
                                <MudTextField @bind-Value="ViewModel.Entity.ColorHex"
                                              Label="@TranslationService.GetTranslation("field.colorHex", "Colore (Hex)")"
                                              MaxLength="7"
                                              Placeholder="#FF5733"
                                              Variant="Variant.Outlined"
                                              Disabled="@(ViewModel.Entity.IsSystemGroup && !ViewModel.IsNewEntity)"
                                              Pattern="^#([A-Fa-f0-9]{6})$"
                                              @bind-Value:after="HandleEntityChanged"
                                              HelperText="@TranslationService.GetTranslation("field.colorHexHelper", "Formato: #RRGGBB")" />
                            </MudItem>

                            @if (ViewModel.IsNewEntity)
                            {
                                <MudItem xs="12" md="6">
                                    <MudSwitch @bind-Value="ViewModel.Entity.IsSystemGroup"
                                               Label="@TranslationService.GetTranslation("field.isSystemGroup", "Gruppo di Sistema")"
                                               Color="Color.Primary"
                                               @bind-Value:after="HandleEntityChanged" />
                                </MudItem>

                                <MudItem xs="12" md="6">
                                    <MudSwitch @bind-Value="ViewModel.Entity.IsDefault"
                                               Label="@TranslationService.GetTranslation("field.isDefault", "Gruppo Default")"
                                               Color="Color.Primary"
                                               @bind-Value:after="HandleEntityChanged" />
                                </MudItem>
                            }

                            <MudItem xs="12">
                                <MudTextField @bind-Value="ViewModel.Entity.Description"
                                              Label="@TranslationService.GetTranslation("field.description", "Descrizione")"
                                              Lines="3"
                                              MaxLength="200"
                                              Variant="Variant.Outlined"
                                              Disabled="@(ViewModel.Entity.IsSystemGroup && !ViewModel.IsNewEntity)"
                                              @bind-Value:after="HandleEntityChanged" />
                            </MudItem>

                            @if (!ViewModel.IsNewEntity)
                            {
                                <MudItem xs="12">
                                    <MudDivider Class="my-4" />
                                    <MudText Typo="Typo.h6" Class="mb-2">
                                        @TranslationService.GetTranslation("store.groupStatistics", "Statistiche Gruppo")
                                    </MudText>
                                    <MudGrid>
                                        <MudItem xs="12" sm="6" md="4">
                                            <MudPaper Elevation="1" Class="pa-4">
                                                <div class="d-flex align-center gap-2">
                                                    <MudIcon Icon="@Icons.Material.Outlined.People" Color="Color.Primary" />
                                                    <div>
                                                        <MudText Typo="Typo.caption" Class="mud-text-secondary">
                                                            @TranslationService.GetTranslation("field.operatorsCount", "Operatori")
                                                        </MudText>
                                                        <MudText Typo="Typo.h6">@ViewModel.Entity.CashierCount</MudText>
                                                    </div>
                                                </div>
                                            </MudPaper>
                                        </MudItem>
                                        <MudItem xs="12" sm="6" md="4">
                                            <MudPaper Elevation="1" Class="pa-4">
                                                <div class="d-flex align-center gap-2">
                                                    <MudIcon Icon="@Icons.Material.Outlined.Security" Color="Color.Primary" />
                                                    <div>
                                                        <MudText Typo="Typo.caption" Class="mud-text-secondary">
                                                            @TranslationService.GetTranslation("field.privilegesCount", "Privilegi")
                                                        </MudText>
                                                        <MudText Typo="Typo.h6">@ViewModel.Entity.PrivilegeCount</MudText>
                                                    </div>
                                                </div>
                                            </MudPaper>
                                        </MudItem>
                                    </MudGrid>
                                </MudItem>
                            }
                        </MudGrid>
                    </MudForm>
                </MudPaper>
            </div>
        }
    </div>
}

@code {
    [Parameter] public Guid? GroupId { get; set; }
    [Parameter] public string? GroupIdString { get; set; }

    private MudForm _form = null!;

    protected override async Task OnInitializedAsync()
    {
        ViewModel.StateChanged += OnViewModelStateChanged;
        await LoadGroupAsync();
    }

    protected override async Task OnParametersSetAsync()
    {
        var currentId = GetCurrentGroupId();
        if (ViewModel.Entity?.Id != currentId || (currentId == Guid.Empty && !ViewModel.IsNewEntity))
            await LoadGroupAsync();
    }

    private Guid GetCurrentGroupId()
    {
        if (GroupId.HasValue)
            return GroupId.Value;

        if (string.IsNullOrEmpty(GroupIdString))
            return Guid.Empty;

        if (GroupIdString.Equals("new", StringComparison.OrdinalIgnoreCase))
            return Guid.Empty;

        if (Guid.TryParse(GroupIdString, out var parsedGuid))
            return parsedGuid;

        return Guid.Empty;
    }

    private async Task LoadGroupAsync()
    {
        try
        {
            var groupId = GetCurrentGroupId();
            await ViewModel.LoadEntityAsync(groupId);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading operator group {GroupId}", GetCurrentGroupId());
            Snackbar.Add(TranslationService.GetTranslation("store.loadError", "Errore nel caricamento"), Severity.Error);
        }
    }

    private void HandleEntityChanged()
    {
        ViewModel.NotifyEntityChanged();
    }

    private async Task SaveAsync()
    {
        try
        {
            if (ViewModel.Entity.IsSystemGroup && !ViewModel.IsNewEntity)
            {
                Snackbar.Add(TranslationService.GetTranslation("store.cannotModifySystemGroup", "Non è possibile modificare un gruppo di sistema"), Severity.Warning);
                return;
            }

            await _form.Validate();

            if (!_form.IsValid)
            {
                Snackbar.Add(TranslationService.GetTranslation("common.validationErrors", "Correggere gli errori di validazione"), Severity.Warning);
                return;
            }

            var success = await ViewModel.SaveEntityAsync();
            if (success)
            {
                var message = ViewModel.IsNewEntity 
                    ? TranslationService.GetTranslation("store.operatorGroupCreated", "Gruppo creato con successo")
                    : TranslationService.GetTranslation("store.operatorGroupSaved", "Gruppo salvato con successo");
                Snackbar.Add(message, Severity.Success);

                // If it was a new group, navigate to its detail page
                if (ViewModel.Entity?.Id != Guid.Empty && GroupIdString?.Equals("new", StringComparison.OrdinalIgnoreCase) == true)
                {
                    NavigationManager.NavigateTo($"/store/operator-groups/{ViewModel.Entity.Id}");
                }
            }
            else
            {
                var message = ViewModel.IsNewEntity
                    ? TranslationService.GetTranslation("store.createError", "Errore nella creazione")
                    : TranslationService.GetTranslation("store.saveError", "Errore nel salvataggio");
                Snackbar.Add(message, Severity.Error);
            }
        }
        catch (Exception ex)
        {
            var errorMessage = ex.Message;
            Logger.LogError(ex, "Error saving operator group");
            Snackbar.Add(errorMessage, Severity.Error);
        }
    }

    private async Task TryNavigateAway(string target)
    {
        if (!ViewModel.HasUnsavedChanges())
        {
            NavigationManager.NavigateTo(target);
            return;
        }

        var title = TranslationService.GetTranslation("common.confirm", "Conferma");
        var message = TranslationService.GetTranslation("common.unsavedChangesConfirm", "Ci sono modifiche non salvate. Vuoi salvare prima di uscire?");
        var saveText = TranslationService.GetTranslation("common.save", "Salva");
        var discardText = TranslationService.GetTranslation("common.discard", "Non salvare");
        var cancelText = TranslationService.GetTranslation("common.cancel", "Annulla");

        var result = await DialogService.ShowMessageBox(title, message, yesText: saveText, noText: discardText, cancelText: cancelText);

        if (result == true)
        {
            await SaveAsync();
            NavigationManager.NavigateTo(target);
        }
        else if (result == false)
        {
            NavigationManager.NavigateTo(target);
        }
    }

    private void OnViewModelStateChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    private Color GetStatusColor(CashierGroupStatus status) => status switch
    {
        CashierGroupStatus.Active => Color.Success,
        CashierGroupStatus.Suspended => Color.Warning,
        CashierGroupStatus.Deleted => Color.Error,
        _ => Color.Default
    };

    private string GetStatusText(CashierGroupStatus status) => status switch
    {
        CashierGroupStatus.Active => TranslationService.GetTranslation("status.active", "Attivo"),
        CashierGroupStatus.Suspended => TranslationService.GetTranslation("status.suspended", "Sospeso"),
        CashierGroupStatus.Deleted => TranslationService.GetTranslation("status.deleted", "Eliminato"),
        _ => status.ToString()
    };

    public void Dispose()
    {
        ViewModel.StateChanged -= OnViewModelStateChanged;
    }
}