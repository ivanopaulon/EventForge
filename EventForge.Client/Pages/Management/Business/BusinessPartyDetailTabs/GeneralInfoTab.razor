@using EventForge.DTOs.Business
@using EventForge.DTOs.External
@using EventForge.DTOs.Common
@using EventForge.Client.Services
@using EventForge.Client.Services.External
@inject ITranslationService TranslationService
@inject IVatLookupService VatLookupService
@inject IEntityManagementService EntityManagementService
@inject ISnackbar Snackbar
@inject ILogger<GeneralInfoTab> Logger

<MudStack Spacing="3">
    <MudPaper Elevation="1" Class="pa-4">
        <MudText Typo="Typo.h6" Class="mb-3">
            <MudIcon Icon="@Icons.Material.Outlined.Info" Class="mr-2" />
            @TranslationService.GetTranslation("businessParty.basicInfo", "Informazioni di Base")
        </MudText>
        <MudGrid Spacing="3">
            <!-- Party Type -->
            <MudItem xs="12" md="6">
                <MudSelect @bind-Value="Party.PartyType"
                           Label="@($"{TranslationService.GetTranslation("field.partyType", "Tipo")} *")"
                           Variant="Variant.Outlined"
                           ReadOnly="@(!IsEditMode)"
                           @bind-Value:after="NotifyUpdated"
                           Required="true">
                    <MudSelectItem Value="@BusinessPartyType.Cliente">@TranslationService.GetTranslation("partyType.cliente", "Cliente")</MudSelectItem>
                    <MudSelectItem Value="@BusinessPartyType.Supplier">@TranslationService.GetTranslation("partyType.supplier", "Fornitore")</MudSelectItem>
                    <MudSelectItem Value="@BusinessPartyType.Both">@TranslationService.GetTranslation("partyType.both", "Cliente/Fornitore")</MudSelectItem>
                </MudSelect>
            </MudItem>
            
            <!-- Name -->
            <MudItem xs="12" md="6">
                <MudTextField @bind-Value="Party.Name"
                              Label="@($"{TranslationService.GetTranslation("field.name", "Nome")} *")"
                              Variant="Variant.Outlined"
                              ReadOnly="@(!IsEditMode)"
                              Required="true"
                              MaxLength="200"
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.Business"
                              @bind-Value:after="NotifyUpdated" />
            </MudItem>
            
            <!-- Tax Code -->
            <MudItem xs="12" md="6">
                <MudTextField @bind-Value="Party.TaxCode"
                              Label="@TranslationService.GetTranslation("field.taxCode", "Codice Fiscale")"
                              Variant="Variant.Outlined"
                              ReadOnly="@(!IsEditMode)"
                              MaxLength="20"
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.Badge"
                              @bind-Value:after="NotifyUpdated" />
            </MudItem>
            
            <!-- VAT Number with Lookup -->
            <MudItem xs="12">
                <div class="d-flex gap-2">
                    <MudTextField @bind-Value="Party.VatNumber"
                                  Label="@TranslationService.GetTranslation("field.vatNumber", "Partita IVA")"
                                  Variant="Variant.Outlined"
                                  ReadOnly="@(!IsEditMode)"
                                  MaxLength="20"
                                  Placeholder="IT12345678901"
                                  Adornment="Adornment.Start"
                                  AdornmentIcon="@Icons.Material.Outlined.Business"
                                  HelperText="@TranslationService.GetTranslation("businessParty.vatNumberHelper", "Partita IVA (con o senza codice paese)")"
                                  @bind-Value:after="NotifyUpdated"
                                  Style="flex-grow: 1;" />
                    @if (IsEditMode)
                    {
                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Primary"
                                   StartIcon="@Icons.Material.Filled.Search"
                                   OnClick="@LookupVatAsync"
                                   Disabled="@(_isLookingUp || string.IsNullOrWhiteSpace(Party.VatNumber))"
                                   Style="align-self: flex-start; margin-top: 4px;">
                            @if (_isLookingUp)
                            {
                                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                            }
                            @TranslationService.GetTranslation("common.search", "Cerca")
                        </MudButton>
                    }
                </div>
            </MudItem>
            
            <!-- VAT Lookup Result -->
            @if (_lookupResult != null && _lookupResult.IsValid)
            {
                <MudItem xs="12">
                    <MudAlert Severity="Severity.Success" Dense="true" Class="mb-3">
                        <div class="d-flex justify-space-between align-center">
                            <div>
                                <MudText Typo="Typo.subtitle2">
                                    <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Small" Class="mr-1" />
                                    @TranslationService.GetTranslation("vat.validVat", "P.IVA Valida")
                                </MudText>
                                <MudText Typo="Typo.body2"><strong>@_lookupResult.Name</strong></MudText>
                                <MudText Typo="Typo.caption">@_lookupResult.Address</MudText>
                            </div>
                            <MudButton Variant="Variant.Text" 
                                       Color="Color.Primary" 
                                       OnClick="@(async () => await ApplyLookupData())">
                                @TranslationService.GetTranslation("vat.useData", "Usa questi dati")
                            </MudButton>
                        </div>
                    </MudAlert>
                </MudItem>
            }
            else if (_lookupResult != null && !_lookupResult.IsValid)
            {
                <MudItem xs="12">
                    <MudAlert Severity="Severity.Warning" Dense="true">
                        @TranslationService.GetTranslation("vat.invalidVat", "P.IVA non valida o non trovata")
                        @if (!string.IsNullOrEmpty(_lookupResult.ErrorMessage))
                        {
                            <MudText Typo="Typo.caption" Class="mt-2">@_lookupResult.ErrorMessage</MudText>
                        }
                    </MudAlert>
                </MudItem>
            }
            
            <!-- SDI Code -->
            <MudItem xs="12" md="6">
                <MudTextField @bind-Value="Party.SdiCode"
                              Label="@TranslationService.GetTranslation("field.sdiCode", "Codice SDI")"
                              Variant="Variant.Outlined"
                              ReadOnly="@(!IsEditMode)"
                              MaxLength="10"
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.QrCode"
                              @bind-Value:after="NotifyUpdated" />
            </MudItem>
            
            <!-- PEC -->
            <MudItem xs="12" md="6">
                <MudTextField @bind-Value="Party.Pec"
                              Label="@TranslationService.GetTranslation("field.pec", "PEC")"
                              Variant="Variant.Outlined"
                              ReadOnly="@(!IsEditMode)"
                              MaxLength="100"
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.Email"
                              @bind-Value:after="NotifyUpdated" />
            </MudItem>

            <!-- Is Active -->
            <MudItem xs="12" md="6">
                <MudSwitch T="bool"
                           Checked="@Party.IsActive"
                           Label="@TranslationService.GetTranslation("field.isActive", "Attivo")"
                           Color="Color.Primary"
                           Disabled="true" />
            </MudItem>
            
            <!-- Notes -->
            <MudItem xs="12">
                <MudTextField @bind-Value="Party.Notes"
                              Label="@TranslationService.GetTranslation("field.notes", "Note")"
                              Variant="Variant.Outlined"
                              Lines="4"
                              ReadOnly="@(!IsEditMode)"
                              MaxLength="500"
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.Notes"
                              @bind-Value:after="NotifyUpdated" />
            </MudItem>
        </MudGrid>
    </MudPaper>

    @if (!IsNewParty)
    {
        <!-- Audit Information -->
        <MudPaper Elevation="1" Class="pa-4">
            <MudText Typo="Typo.h6" Class="mb-3">
                <MudIcon Icon="@Icons.Material.Outlined.History" Class="mr-2" />
                @TranslationService.GetTranslation("common.auditInfo", "Informazioni di Sistema")
            </MudText>
            <MudGrid Spacing="3">
                <MudItem xs="12" md="6">
                    <MudTextField Value="@Party.CreatedAt.ToString("dd/MM/yyyy HH:mm")"
                                  Label="@TranslationService.GetTranslation("field.createdAt", "Creato il")"
                                  Variant="Variant.Outlined"
                                  ReadOnly="true" />
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudTextField Value="@Party.CreatedBy"
                                  Label="@TranslationService.GetTranslation("field.createdBy", "Creato da")"
                                  Variant="Variant.Outlined"
                                  ReadOnly="true" />
                </MudItem>
                @if (Party.ModifiedAt.HasValue)
                {
                    <MudItem xs="12" md="6">
                        <MudTextField Value="@Party.ModifiedAt.Value.ToString("dd/MM/yyyy HH:mm")"
                                      Label="@TranslationService.GetTranslation("field.modifiedAt", "Modificato il")"
                                      Variant="Variant.Outlined"
                                      ReadOnly="true" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudTextField Value="@Party.ModifiedBy"
                                      Label="@TranslationService.GetTranslation("field.modifiedBy", "Modificato da")"
                                      Variant="Variant.Outlined"
                                      ReadOnly="true" />
                    </MudItem>
                }
            </MudGrid>
        </MudPaper>
    }
</MudStack>

@code {
    [Parameter] public BusinessPartyDto Party { get; set; } = new();
    [Parameter] public bool IsEditMode { get; set; } = true;
    [Parameter] public bool IsNewParty { get; set; } = false;
    [Parameter] public EventCallback OnPartyUpdated { get; set; }
    [Parameter] public EventCallback OnAddressCreated { get; set; }

    // VAT lookup fields
    private bool _isLookingUp = false;
    private VatLookupResultDto? _lookupResult;

    private void NotifyUpdated()
    {
        OnPartyUpdated.InvokeAsync();
    }

    private async Task LookupVatAsync()
    {
        if (string.IsNullOrWhiteSpace(Party.VatNumber))
            return;

        _isLookingUp = true;
        _lookupResult = null;

        try
        {
            _lookupResult = await VatLookupService.LookupAsync(Party.VatNumber);
            
            if (_lookupResult == null)
            {
                Snackbar.Add(
                    TranslationService.GetTranslation("vat.lookupError", "Errore durante la ricerca. Riprova più tardi."),
                    Severity.Error
                );
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error during VAT lookup");
            Snackbar.Add(
                TranslationService.GetTranslation("vat.lookupError", "Errore durante la ricerca. Riprova più tardi."),
                Severity.Error
            );
        }
        finally
        {
            _isLookingUp = false;
        }
    }

    private async Task ApplyLookupData()
    {
        if (_lookupResult == null || !_lookupResult.IsValid)
            return;

        // Populate the form fields
        if (!string.IsNullOrEmpty(_lookupResult.Name))
            Party.Name = _lookupResult.Name;
        
        // Keep the VAT number as entered by the user (already validated by VIES)
        // It's already in Party.VatNumber from the input field

        NotifyUpdated();

        // Create address if party is already saved and we have address data
        if (Party.Id != Guid.Empty && HasAddressData())
        {
            try
            {
                var address = new CreateAddressDto
                {
                    OwnerId = Party.Id,
                    OwnerType = "BusinessParty",
                    AddressType = AddressType.Legal,
                    Street = _lookupResult.Street,
                    City = _lookupResult.City,
                    ZipCode = _lookupResult.PostalCode,
                    Province = _lookupResult.Province,
                    Country = GetCountryFromVatNumber(),
                    Notes = TranslationService.GetTranslation("address.viesNotes", "Indirizzo da ricerca P.IVA VIES")
                };

                await EntityManagementService.CreateAddressAsync(address);
                await OnAddressCreated.InvokeAsync();

                Snackbar.Add(
                    TranslationService.GetTranslation("vat.dataAndAddressApplied", "Dati e indirizzo applicati con successo"),
                    Severity.Success
                );
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Error creating address from VAT lookup for party {PartyId}", Party.Id);
                Snackbar.Add(
                    TranslationService.GetTranslation("vat.dataAppliedAddressError", "Dati applicati, ma errore nella creazione dell'indirizzo"),
                    Severity.Warning
                );
            }
        }
        else if (Party.Id == Guid.Empty && HasAddressData())
        {
            // Party is new (not yet saved)
            Snackbar.Add(
                TranslationService.GetTranslation("vat.dataAppliedSaveFirst", "Dati applicati. Salva prima il Business Party per creare l'indirizzo automaticamente."),
                Severity.Info
            );
        }
        else
        {
            // No address data available
            Snackbar.Add(
                TranslationService.GetTranslation("vat.dataApplied", "Dati applicati con successo"),
                Severity.Success
            );
        }
    }

    private bool HasAddressData()
    {
        return !string.IsNullOrEmpty(_lookupResult?.Street) ||
               !string.IsNullOrEmpty(_lookupResult?.City) ||
               !string.IsNullOrEmpty(_lookupResult?.PostalCode);
    }

    private string? GetCountryFromVatNumber()
    {
        // Extract country from VAT number prefix (e.g., "IT" from "IT12345678901")
        if (!string.IsNullOrEmpty(Party.VatNumber) && Party.VatNumber.Length >= 2)
        {
            var prefix = Party.VatNumber[..2].ToUpperInvariant();
            if (char.IsLetter(prefix[0]) && char.IsLetter(prefix[1]))
            {
                return prefix switch
                {
                    "IT" => "Italia",
                    "DE" => "Germania",
                    "FR" => "Francia",
                    "ES" => "Spagna",
                    "AT" => "Austria",
                    "BE" => "Belgio",
                    "NL" => "Paesi Bassi",
                    "PT" => "Portogallo",
                    "GR" => "Grecia",
                    "PL" => "Polonia",
                    _ => prefix
                };
            }
        }
        return _lookupResult?.CountryCode;
    }
}
