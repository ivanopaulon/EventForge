@page "/business/suppliers/new"
@page "/business/suppliers/{PartyId:guid}"
@page "/business/customers/new"
@page "/business/customers/{PartyId:guid}"
@using Microsoft.AspNetCore.Authorization
@using EventForge.DTOs.Business
@using EventForge.DTOs.Common
@using EventForge.Client.Shared.Components
@using EventForge.Client.Pages.Management.Business.BusinessPartyDetailTabs
@using EventForge.Client.Shared.BusinessParty
@attribute [Authorize]
@inject IBusinessPartyService BusinessPartyService
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject ITranslationService TranslationService
@inject ILogger<BusinessPartyDetail> Logger

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <PageLoadingOverlay Visible="_isLoading || _isSaving"
                         Message="@(_isSaving ? TranslationService.GetTranslation("common.saving", "Salvataggio...") : TranslationService.GetTranslation("common.loading", "Caricamento..."))" />

    @if (_party == null && !_isCreateMode && !_isLoading)
    {
        <MudAlert Severity="Severity.Error">
            @TranslationService.GetTranslation("businessParty.notFound", "Business party non trovato")
        </MudAlert>
    }
    else if (!_isLoading)
    {
        <!-- Page Header -->
        <MudPaper Elevation="2" Class="pa-4 mb-4">
            <div class="d-flex justify-space-between align-center">
                <div>
                    <div class="d-flex align-center gap-2 mb-2">
                        <MudIconButton Icon="@Icons.Material.Filled.ArrowBack" 
                                       Color="Color.Primary"
                                       OnClick="@(() => TryNavigateAway(GetBackRoute()))"
                                       Size="Size.Small" />
                        <MudText Typo="Typo.h4">
                            <MudIcon Icon="@Icons.Material.Outlined.Business" Class="mr-2" />
                            @if (_isCreateMode)
                            {
                                <text>@GetEntityTypeName() - @TranslationService.GetTranslation("common.create", "Crea")</text>
                            }
                            else
                            {
                                <text>@(_party?.Name ?? TranslationService.GetTranslation("businessParty.unknown", "Business Party"))</text>
                            }
                        </MudText>
                        
                        @if (!_isCreateMode && _party != null)
                        {
                            <MudChip T="string" Size="Size.Small" Color="@(_party.IsActive ? Color.Success : Color.Default)">
                                @(_party.IsActive ? TranslationService.GetTranslation("status.active", "Attivo") : TranslationService.GetTranslation("status.inactive", "Inattivo"))
                            </MudChip>
                        }

                        @if (HasUnsavedChanges())
                        {
                            <MudChip T="string" Size="Size.Small" Color="Color.Warning" Class="ml-2">
                                @TranslationService.GetTranslation("common.unsavedChanges", "Modifiche non salvate")
                            </MudChip>
                        }
                    </div>
                </div>
                <div class="d-flex gap-2">
                    <MudButton Variant="Variant.Filled" 
                               Color="Color.Primary" 
                               StartIcon="@Icons.Material.Filled.Save"
                               OnClick="SavePartyAsync"
                               Disabled="_isSaving"
                               Size="Size.Small">
                        @TranslationService.GetTranslation("common.save", "Salva")
                    </MudButton>
                </div>
            </div>
        </MudPaper>

        <!-- Tabs Section -->
        <MudPaper Elevation="2" Class="pa-2">
            <MudTabs Elevation="0" 
                     Rounded="false" 
                     PanelClass="pa-4" 
                     @bind-ActivePanelIndex="_activeTab" 
                     Color="Color.Primary">
                
                <!-- ========== TAB 1: GENERALE (Fase 1 - già implementata) ========== -->
                <MudTabPanel Text="@TranslationService.GetTranslation("businessParty.general", "Generale")" 
                             Icon="@Icons.Material.Filled.Info">
                    <GeneralInfoTab Party="@_party" 
                                    IsEditMode="@_isEditMode" 
                                    IsNewParty="@_isCreateMode" 
                                    OnPartyUpdated="@HandlePartyLocallyChanged" 
                                    OnAddressCreated="@HandleAddressCreated"
                                    OnManageGroupsClicked="@OnManageGroupsClicked"
                                    OnRemoveGroup="@OnRemoveGroup" />
                </MudTabPanel>
                
                @if (!_isCreateMode && _party != null)
                {
                    <!-- ========== TAB 2: RECAPITI (Fase 2 - NUOVO consolidato) ========== -->
                    <MudTabPanel Text="@TranslationService.GetTranslation("businessParty.recapiti", "Recapiti")" 
                                 Icon="@Icons.Material.Filled.ContactPhone"
                                 BadgeData="@(_party.AddressCount + _party.ContactCount + _party.ReferenceCount)"
                                 BadgeDot="@(_party.AddressCount > 0 || _party.ContactCount > 0 || _party.ReferenceCount > 0)">
                        <RecapitiTab Party="@_party" 
                                     IsEditMode="@_isEditMode" 
                                     OnPartyUpdated="@HandlePartyLocallyChanged" />
                    </MudTabPanel>
                    
                    <!-- ========== TAB 3: OPERATIVO (Fase 2 - NUOVO consolidato) ========== -->
                    <MudTabPanel Text="@TranslationService.GetTranslation("businessParty.operativo", "Operativo")" 
                                 Icon="@Icons.Material.Filled.Inventory">
                        <OperativoTab BusinessPartyId="@_party.Id" 
                                      PartyType="@_party.PartyType" />
                    </MudTabPanel>
                    
                    <!-- ========== TAB 4: CONTABILITÀ (invariata) ========== -->
                    @if (_party.HasAccountingData)
                    {
                        <MudTabPanel Text="@TranslationService.GetTranslation("businessParty.accounting", "Dati Contabili")" 
                                     Icon="@Icons.Material.Filled.AccountBalance">
                            <AccountingTab Party="@_party" 
                                           IsEditMode="@_isEditMode" 
                                           OnPartyUpdated="@HandlePartyLocallyChanged" />
                        </MudTabPanel>
                    }
                }
                
            </MudTabs>
        </MudPaper>
    }
</MudContainer>

@code {
    [Parameter] public Guid? PartyId { get; set; }

    private BusinessPartyDto? _party;
    private bool _isLoading = true;
    private bool _isCreateMode => PartyId == null || PartyId == Guid.Empty;
    private bool _isEditMode = true;
    private bool _isSaving = false;
    private int _activeTab = 0;

    private string _originalPartySnapshot = string.Empty;
    private bool _hasLocalChanges = false;

    private static readonly System.Text.Json.JsonSerializerOptions _jsonOptions = new()
    {
        PropertyNameCaseInsensitive = true,
        DefaultIgnoreCondition = System.Text.Json.Serialization.JsonIgnoreCondition.WhenWritingNull
    };

    // Determine if we're in supplier or customer mode based on route
    private bool _isSupplierMode => NavigationManager.Uri.Contains("/suppliers");
    
    // ========== LAZY LOADING INFRASTRUCTURE (AGGIORNATO FASE 2) ==========
    
    /// <summary>
    /// Stato di caricamento per ogni tab
    /// </summary>
    private readonly Dictionary<string, TabLoadState> _tabLoadStates = new()
    {
        { "General", TabLoadState.Loaded },       // Caricato all'init
        { "Recapiti", TabLoadState.NotLoaded },   // NUOVO (consolidato Indirizzi+Contatti+Riferimenti)
        { "Operativo", TabLoadState.NotLoaded },  // NUOVO (consolidato Documenti+Prodotti+Forniti)
        { "Contabilita", TabLoadState.NotLoaded } // Invariato
    };

    protected override async Task OnInitializedAsync()
    {
        await LoadPartyAsync();
    }

    protected override async Task OnParametersSetAsync()
    {
        if (_party?.Id != PartyId)
            await LoadPartyAsync();
    }

    private async Task LoadPartyAsync()
    {
        _isLoading = true;
        try
        {
            if (_isCreateMode)
            {
                _party = new BusinessPartyDto
                {
                    PartyType = _isSupplierMode ? BusinessPartyType.Supplier : BusinessPartyType.Cliente,
                    Name = string.Empty,
                    IsActive = true
                };
                _originalPartySnapshot = SerializeParty(_party);
            }
            else if (PartyId.HasValue)
            {
                var party = await BusinessPartyService.GetBusinessPartyAsync(PartyId.Value);
                _party = party;
                if (_party != null)
                {
                    _originalPartySnapshot = SerializeParty(_party);
                }
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading business party {PartyId}", PartyId);
            Snackbar.Add(TranslationService.GetTranslation("businessParty.loadError", "Errore nel caricamento"), Severity.Error);
        }
        finally
        {
            _isLoading = false;
            _hasLocalChanges = false;
        }
    }

    private async Task SavePartyAsync()
    {
        if (_party == null) return;
        
        _isSaving = true;
        try
        {
            if (_isCreateMode)
            {
                var createDto = new CreateBusinessPartyDto
                {
                    PartyType = _party.PartyType,
                    Name = _party.Name ?? string.Empty,
                    TaxCode = _party.TaxCode,
                    VatNumber = _party.VatNumber,
                    SdiCode = _party.SdiCode,
                    Pec = _party.Pec,
                    Notes = _party.Notes
                };
                var created = await BusinessPartyService.CreateBusinessPartyAsync(createDto);
                Snackbar.Add(TranslationService.GetTranslation("businessParty.createSuccess", "Business party creato con successo"), Severity.Success);
                NavigationManager.NavigateTo(GetDetailRoute(created.Id));
            }
            else if (PartyId.HasValue)
            {
                var updateDto = new UpdateBusinessPartyDto
                {
                    PartyType = _party.PartyType,
                    Name = _party.Name ?? string.Empty,
                    TaxCode = _party.TaxCode,
                    VatNumber = _party.VatNumber,
                    SdiCode = _party.SdiCode,
                    Pec = _party.Pec,
                    Notes = _party.Notes
                };
                await BusinessPartyService.UpdateBusinessPartyAsync(PartyId.Value, updateDto);
                Snackbar.Add(TranslationService.GetTranslation("businessParty.updateSuccess", "Business party aggiornato con successo"), Severity.Success);
                await LoadPartyAsync();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error saving business party");
            Snackbar.Add(TranslationService.GetTranslation("businessParty.saveError", "Errore nel salvataggio"), Severity.Error);
        }
        finally
        {
            _isSaving = false;
        }
    }

    private void HandlePartyLocallyChanged()
    {
        _hasLocalChanges = true;
        StateHasChanged();
    }

    private async Task HandleAddressCreated()
    {
        // Refresh party to update address count
        if (_party?.Id != Guid.Empty)
        {
            await LoadPartyAsync();
        }
    }

    private string SerializeParty(BusinessPartyDto? p)
    {
        if (p == null) return string.Empty;
        return System.Text.Json.JsonSerializer.Serialize(p, _jsonOptions);
    }

    private bool HasUnsavedChanges()
    {
        if (_party == null) return false;
        if (_hasLocalChanges) return true;
        var current = SerializeParty(_party);
        return !string.Equals(current, _originalPartySnapshot, StringComparison.Ordinal);
    }

    private async Task TryNavigateAway(string target)
    {
        if (!HasUnsavedChanges())
        {
            NavigationManager.NavigateTo(target);
            return;
        }

        var title = TranslationService.GetTranslation("common.confirm", "Conferma");
        var message = TranslationService.GetTranslation("common.unsavedChangesConfirm", "Ci sono modifiche non salvate. Vuoi salvare prima di uscire?");
        var saveText = TranslationService.GetTranslation("common.save", "Salva");
        var discardText = TranslationService.GetTranslation("common.discard", "Non salvare");
        var cancelText = TranslationService.GetTranslation("common.cancel", "Annulla");

        var result = await DialogService.ShowMessageBox(title, message, yesText: saveText, noText: discardText, cancelText: cancelText);

        if (result == true)
        {
            await SavePartyAsync();
            NavigationManager.NavigateTo(target);
        }
        else if (result == false)
        {
            NavigationManager.NavigateTo(target);
        }
    }

    private string GetBackRoute()
    {
        return _isSupplierMode ? "/business/suppliers" : "/business/customers";
    }

    private string GetDetailRoute(Guid id)
    {
        return _isSupplierMode ? $"/business/suppliers/{id}" : $"/business/customers/{id}";
    }

    private string GetEntityTypeName()
    {
        return _isSupplierMode 
            ? TranslationService.GetTranslation("entity.supplier", "Fornitore")
            : TranslationService.GetTranslation("entity.customer", "Cliente");
    }
    
    // ========== GESTIONE GRUPPI (NUOVO) ==========
    
    /// <summary>
    /// Apre dialog per gestire gruppi (placeholder - implementazione in fase successiva)
    /// </summary>
    private void OnManageGroupsClicked()
    {
        // TODO: Implementare in Fase successiva
        // var parameters = new DialogParameters
        // {
        //     { "BusinessPartyId", _party.Id },
        //     { "CurrentGroups", _party.Groups }
        // };
        // var result = await DialogService.ShowAsync<ManageBusinessPartyGroupsDialog>(...);
        
        Snackbar.Add("Gestione gruppi: implementazione in fase successiva", Severity.Info);
    }
    
    /// <summary>
    /// Rimuove un gruppo dal business party
    /// </summary>
    private void OnRemoveGroup(Guid groupId)
    {
        // TODO: Implementare chiamata API per rimuovere gruppo
        // await GroupService.RemoveBusinessPartyFromGroupAsync(groupId, _party.Id);
        
        // Placeholder: rimuovi solo lato client
        if (_party?.Groups != null)
        {
            var group = _party.Groups.FirstOrDefault(g => g.Id == groupId);
            if (group != null)
            {
                _party.Groups.Remove(group);
                StateHasChanged();
                Snackbar.Add($"Gruppo '{group.Name}' rimosso (solo UI - backend non implementato)", Severity.Warning);
            }
        }
    }
}
