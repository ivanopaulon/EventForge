@page "/business/groups/new"
@page "/business/groups/{GroupId:guid}"
@using Microsoft.AspNetCore.Authorization
@using EventForge.DTOs.Business
@using EventForge.DTOs.Common
@using EventForge.Client.Shared.Components
@attribute [Authorize]
@inject IBusinessPartyGroupService GroupService
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject ITranslationService TranslationService
@inject ILogger<BusinessPartyGroupDetail> Logger

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <PageLoadingOverlay Visible="_isLoading || _isSaving"
                        Message="@(_isSaving ? "Salvataggio..." : "Caricamento...")" />

    @if (!_isLoading && _group == null && !_isCreateMode)
    {
        <MudAlert Severity="Severity.Error">
            Gruppo non trovato
        </MudAlert>
    }
    else if (!_isLoading)
    {
        <!-- Page Header -->
        <MudPaper Elevation="2" Class="pa-4 mb-4">
            <div class="d-flex justify-space-between align-center">
                <div>
                    <div class="d-flex align-center gap-2 mb-2">
                        <MudIconButton Icon="@Icons.Material.Filled.ArrowBack" 
                                       Color="Color.Primary"
                                       OnClick="@(() => TryNavigateAway("/business/groups"))"
                                       Size="Size.Small" />
                        <MudText Typo="Typo.h4">
                            <MudIcon Icon="@Icons.Material.Outlined.Group" Class="mr-2" />
                            @(_isCreateMode ? "Crea Nuovo Gruppo" : _group?.Name)
                        </MudText>

                        @if (HasUnsavedChanges())
                        {
                            <MudChip T="string" Size="Size.Small" Color="Color.Warning" Class="ml-2">
                                Modifiche non salvate
                            </MudChip>
                        }
                    </div>
                    @if (!_isCreateMode && _group != null)
                    {
                        <MudText Typo="Typo.body2" Class="mud-text-secondary">
                            Creato il: @_group.CreatedAt.ToString("dd/MM/yyyy HH:mm")
                        </MudText>
                    }
                </div>
                <div class="d-flex gap-2">
                    <MudButton Variant="Variant.Filled" 
                               Color="Color.Primary" 
                               StartIcon="@Icons.Material.Filled.Save"
                               OnClick="SaveGroupAsync"
                               Disabled="_isSaving"
                               Size="Size.Small">
                        Salva
                    </MudButton>
                </div>
            </div>
        </MudPaper>

        <!-- Tabs Section -->
        <MudPaper Elevation="2" Class="pa-2">
            <MudTabs Elevation="0" Rounded="false" PanelClass="pa-4" @bind-ActivePanelIndex="_activeTab" Color="Color.Primary">
                <MudTabPanel Text="Informazioni Generali" Icon="@Icons.Material.Filled.Info">
                    <MudForm @ref="_form" Class="pa-2">
                        <MudGrid>
                            <!-- Riga 1: Nome + Codice -->
                            <MudItem xs="12" md="6">
                                <MudTextField @bind-Value="GroupName"
                                              Label="Nome Gruppo *"
                                              Variant="Variant.Outlined"
                                              Required="true"
                                              RequiredError="Il nome è obbligatorio"
                                              MaxLength="100"
                                              Immediate="true"
                                              OnBlur="@(() => MarkChanged())"
                                              aria-describedby="name-help" />
                                <MudText id="name-help" Typo="Typo.caption" Class="mud-input-helper-text">
                                    Nome identificativo del gruppo
                                </MudText>
                            </MudItem>
                            
                            <MudItem xs="12" md="6">
                                <MudTextField @bind-Value="GroupCode"
                                              Label="Codice"
                                              Variant="Variant.Outlined"
                                              MaxLength="50"
                                              OnBlur="@(() => MarkChanged())"
                                              aria-describedby="code-help" />
                                <MudText id="code-help" Typo="Typo.caption" Class="mud-input-helper-text">
                                    Codice breve opzionale (es: VIP, GOLD)
                                </MudText>
                            </MudItem>
                            
                            <!-- Riga 2: Tipo Gruppo + Stato Attivo -->
                            <MudItem xs="12" md="6">
                                <MudSelect @bind-Value="GroupType"
                                           Label="Tipo Gruppo *"
                                           Variant="Variant.Outlined"
                                           Required="true"
                                           OnBlur="@(() => MarkChanged())"
                                           aria-describedby="type-help">
                                    <MudSelectItem Value="@BusinessPartyGroupType.Customer">Cliente</MudSelectItem>
                                    <MudSelectItem Value="@BusinessPartyGroupType.Supplier">Fornitore</MudSelectItem>
                                    <MudSelectItem Value="@BusinessPartyGroupType.Both">Entrambi (Cliente/Fornitore)</MudSelectItem>
                                </MudSelect>
                                <MudText id="type-help" Typo="Typo.caption" Class="mud-input-helper-text">
                                    Definisce se il gruppo è per clienti, fornitori o entrambi
                                </MudText>
                            </MudItem>
                            
                            <MudItem xs="12" md="6">
                                <MudSwitch @bind-Value="IsActive"
                                           Label="Gruppo Attivo"
                                           Color="Color.Success"
                                           For="@(() => IsActive)" />
                                <MudText Typo="Typo.caption" Class="mud-input-helper-text">
                                    Disattiva per nascondere il gruppo senza eliminarlo
                                </MudText>
                            </MudItem>
                            
                            <!-- Riga 3: Colore Badge -->
                            <MudItem xs="12" md="6">
                                <MudColorPicker @bind-Text="ColorHex"
                                                Label="Colore Badge"
                                                Variant="Variant.Outlined"
                                                DisableAlpha="true"
                                                OnBlur="@(() => MarkChanged())"
                                                aria-describedby="color-help" />
                                <MudText id="color-help" Typo="Typo.caption" Class="mud-input-helper-text">
                                    Colore del badge visualizzato nelle liste
                                </MudText>
                                
                                <!-- Preview Badge -->
                                @if (!string.IsNullOrEmpty(ColorHex) && !string.IsNullOrEmpty(GroupName))
                                {
                                    <div class="mt-2">
                                        <MudText Typo="Typo.caption" Class="mb-1">Anteprima:</MudText>
                                        <MudChip T="string"
                                                 Size="Size.Small"
                                                 Variant="Variant.Filled"
                                                 Style="@GetPreviewBadgeStyle()"
                                                 Icon="@(string.IsNullOrEmpty(Icon) ? Icons.Material.Outlined.Group : Icon)">
                                            @GroupName
                                        </MudChip>
                                    </div>
                                }
                            </MudItem>
                            
                            <!-- Riga 3b: Icona -->
                            <MudItem xs="12" md="6">
                                <MudTextField @bind-Value="Icon"
                                              Label="Icona MaterialDesign"
                                              Variant="Variant.Outlined"
                                              MaxLength="100"
                                              OnBlur="@(() => MarkChanged())"
                                              aria-describedby="icon-help" />
                                <MudText id="icon-help" Typo="Typo.caption" Class="mud-input-helper-text">
                                    Nome icona MaterialDesign (es: star, diamond, workspace_premium)
                                </MudText>
                            </MudItem>
                            
                            <!-- Riga 4: Descrizione -->
                            <MudItem xs="12">
                                <MudTextField @bind-Value="Description"
                                              Label="Descrizione"
                                              Variant="Variant.Outlined"
                                              Lines="3"
                                              MaxLength="500"
                                              OnBlur="@(() => MarkChanged())"
                                              aria-describedby="description-help" />
                                <MudText id="description-help" Typo="Typo.caption" Class="mud-input-helper-text">
                                    Descrizione opzionale visibile nei tooltip
                                </MudText>
                            </MudItem>
                            
                            <!-- Riga 5: Validità Da/A -->
                            <MudItem xs="12" md="6">
                                <MudDatePicker @bind-Date="ValidFrom"
                                               Label="Valido Da"
                                               Variant="Variant.Outlined"
                                               Clearable="true"
                                               OnBlur="@(() => MarkChanged())"
                                               aria-describedby="valid-from-help" />
                                <MudText id="valid-from-help" Typo="Typo.caption" Class="mud-input-helper-text">
                                    Lascia vuoto per nessun limite iniziale
                                </MudText>
                            </MudItem>
                            
                            <MudItem xs="12" md="6">
                                <MudDatePicker @bind-Date="ValidTo"
                                               Label="Valido Fino"
                                               Variant="Variant.Outlined"
                                               Clearable="true"
                                               OnBlur="@(() => MarkChanged())"
                                               aria-describedby="valid-to-help" />
                                <MudText id="valid-to-help" Typo="Typo.caption" Class="mud-input-helper-text">
                                    Lascia vuoto per nessun limite finale
                                </MudText>
                            </MudItem>
                            
                            <!-- Info Read-Only (solo edit mode) -->
                            @if (!_isCreateMode && _group != null)
                            {
                                <MudItem xs="12" md="6">
                                    <MudTextField Value="@_group.Id.ToString()"
                                                  Label="ID"
                                                  Variant="Variant.Outlined"
                                                  ReadOnly="true"
                                                  aria-label="Identificativo unico" />
                                </MudItem>
                                
                                <MudItem xs="12" md="6">
                                    <MudTextField Value="@_group.Priority.ToString()"
                                                  Label="Priorità (Gestita Automaticamente)"
                                                  Variant="Variant.Outlined"
                                                  ReadOnly="true"
                                                  aria-label="Priorità del gruppo" />
                                    <MudText Typo="Typo.caption" Class="mud-input-helper-text">
                                        La priorità viene gestita tramite riordino nella pagina lista
                                    </MudText>
                                </MudItem>
                            }
                        </MudGrid>
                    </MudForm>
                </MudTabPanel>

                @if (!_isCreateMode && _group != null)
                {
                    <MudTabPanel Text="@($"Membri ({_members?.Count() ?? 0})")" 
                                 Icon="@Icons.Material.Filled.People"
                                 BadgeData="@_members?.Count()" 
                                 BadgeDot="@(_members?.Any() ?? false)">
                        
                        <!-- Header con azioni -->
                        <MudPaper Elevation="0" Class="pa-3 mb-3">
                            <div class="d-flex justify-space-between align-center">
                                <MudText Typo="Typo.h6">
                                    <MudIcon Icon="@Icons.Material.Filled.People" Class="mr-2" />
                                    Membri del Gruppo
                                </MudText>
                                <MudButton Variant="Variant.Filled"
                                           Color="Color.Primary"
                                           StartIcon="@Icons.Material.Filled.Add"
                                           Size="Size.Small"
                                           OnClick="@OpenAddMemberDialog">
                                    Aggiungi Membro
                                </MudButton>
                            </div>
                        </MudPaper>

                        <!-- Loading -->
                        @if (_loadingMembers)
                        {
                            <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="mt-4" />
                            <MudText Typo="Typo.caption" Align="Align.Center" Class="mt-2">
                                Caricamento membri...
                            </MudText>
                        }
                        <!-- Tabella membri -->
                        else if (_members?.Any() == true)
                        {
                            <MudTable Items="_members" Hover="true" Dense="false" Striped="true" FixedHeader="true" Height="60vh">
                                <HeaderContent>
                                    <MudTh><MudTableSortLabel SortBy="new Func<BusinessPartyGroupMemberDto, object>(x => x.BusinessPartyName)">Business Party</MudTableSortLabel></MudTh>
                                    <MudTh>Tipo</MudTh>
                                    <MudTh><MudTableSortLabel SortBy="new Func<BusinessPartyGroupMemberDto, object>(x => x.MemberSince ?? DateTime.MinValue)">Membro Dal</MudTableSortLabel></MudTh>
                                    <MudTh><MudTableSortLabel SortBy="new Func<BusinessPartyGroupMemberDto, object>(x => x.MemberUntil ?? DateTime.MaxValue)">Membro Fino</MudTableSortLabel></MudTh>
                                    <MudTh><MudTableSortLabel SortBy="new Func<BusinessPartyGroupMemberDto, object>(x => x.Status)">Stato</MudTableSortLabel></MudTh>
                                    <MudTh Style="text-align: right;">Azioni</MudTh>
                                </HeaderContent>
                                <RowTemplate>
                                    <MudTd DataLabel="Business Party">@context.BusinessPartyName</MudTd>
                                    <MudTd DataLabel="Tipo">
                                        <MudChip T="string" Size="Size.Small" Color="@GetBusinessPartyTypeColor(context.BusinessPartyType)">
                                            @GetBusinessPartyTypeLabel(context.BusinessPartyType)
                                        </MudChip>
                                    </MudTd>
                                    <MudTd DataLabel="Membro Dal">@(context.MemberSince?.ToString("dd/MM/yyyy") ?? "-")</MudTd>
                                    <MudTd DataLabel="Membro Fino">@(context.MemberUntil?.ToString("dd/MM/yyyy") ?? "Permanente")</MudTd>
                                    <MudTd DataLabel="Stato">
                                        <MudChip T="string" Size="Size.Small" Color="@GetMemberStatusColor(context.Status)">
                                            @GetMemberStatusLabel(context.Status)
                                        </MudChip>
                                    </MudTd>
                                    <MudTd DataLabel="Azioni" Style="text-align: right;">
                                        <MudIconButton Icon="@Icons.Material.Filled.Edit" 
                                                       Color="Color.Primary" 
                                                       Size="Size.Small"
                                                       OnClick="@(() => OpenEditMemberDialog(context))"
                                                       title="Modifica" />
                                        <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                                       Color="Color.Error" 
                                                       Size="Size.Small"
                                                       OnClick="@(() => RemoveMember(context.Id))"
                                                       title="Rimuovi" />
                                    </MudTd>
                                </RowTemplate>
                                <NoRecordsContent>
                                    <MudText Class="pa-4">Nessun membro disponibile</MudText>
                                </NoRecordsContent>
                            </MudTable>
                        }
                        <!-- Empty state -->
                        else
                        {
                            <MudPaper Elevation="0" Class="pa-4 text-center">
                                <MudIcon Icon="@Icons.Material.Outlined.People" Size="Size.Large" Class="mb-2 mud-text-secondary" />
                                <MudText Typo="Typo.body1" Class="mud-text-secondary">
                                    Nessun membro nel gruppo
                                </MudText>
                            </MudPaper>
                        }
                    </MudTabPanel>
                }
            </MudTabs>
        </MudPaper>
    }
</MudContainer>

@code {
    [Parameter] public Guid? GroupId { get; set; }

    private BusinessPartyGroupDto? _group;
    private bool _isLoading = true;
    private bool _isCreateMode => GroupId == null || GroupId == Guid.Empty;
    private bool _isSaving = false;
    private int _activeTab = 0;
    private MudForm? _form;

    // Membri
    private IEnumerable<BusinessPartyGroupMemberDto>? _members;
    private bool _loadingMembers = false;

    // Unsaved changes tracking
    private string _originalGroupSnapshot = string.Empty;
    private bool _hasLocalChanges = false;

    // Bound properties per two-way binding con form
    private string GroupName
    {
        get => _group?.Name ?? string.Empty;
        set { if (_group != null) _group.Name = value; }
    }

    private string? GroupCode
    {
        get => _group?.Code;
        set { if (_group != null) _group.Code = value; }
    }

    private string? Description
    {
        get => _group?.Description;
        set { if (_group != null) _group.Description = value; }
    }

    private BusinessPartyGroupType GroupType
    {
        get => _group?.GroupType ?? BusinessPartyGroupType.Customer;
        set { if (_group != null) _group.GroupType = value; }
    }

    private string? ColorHex
    {
        get => _group?.ColorHex;
        set { if (_group != null) _group.ColorHex = value; }
    }

    private string? Icon
    {
        get => _group?.Icon;
        set { if (_group != null) _group.Icon = value; }
    }

    private bool IsActive
    {
        get => _group?.IsActive ?? true;
        set { if (_group != null) _group.IsActive = value; }
    }

    private DateTime? ValidFrom
    {
        get => _group?.ValidFrom;
        set { if (_group != null) _group.ValidFrom = value; }
    }

    private DateTime? ValidTo
    {
        get => _group?.ValidTo;
        set { if (_group != null) _group.ValidTo = value; }
    }

    private static readonly System.Text.Json.JsonSerializerOptions _jsonOptions = new()
    {
        PropertyNameCaseInsensitive = true,
        DefaultIgnoreCondition = System.Text.Json.Serialization.JsonIgnoreCondition.WhenWritingNull
    };

    protected override async Task OnInitializedAsync()
    {
        await LoadGroupAsync();
    }

    protected override async Task OnParametersSetAsync()
    {
        if (_group?.Id != GroupId)
            await LoadGroupAsync();
    }

    private async Task LoadGroupAsync()
    {
        _isLoading = true;
        try
        {
            if (_isCreateMode)
            {
                _group = new BusinessPartyGroupDto 
                { 
                    Name = string.Empty,
                    GroupType = BusinessPartyGroupType.Customer,
                    Priority = 50, // Default
                    IsActive = true
                };
                _originalGroupSnapshot = SerializeGroup(_group);
            }
            else if (GroupId.HasValue)
            {
                var group = await GroupService.GetGroupByIdAsync(GroupId.Value);
                _group = group;

                if (_group != null)
                {
                    _originalGroupSnapshot = SerializeGroup(_group);
                    await LoadMembersAsync();
                }
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading group {GroupId}", GroupId);
            Snackbar.Add("Errore nel caricamento del gruppo", Severity.Error);
        }
        finally
        {
            _isLoading = false;
            _hasLocalChanges = false;
        }
    }

    private async Task LoadMembersAsync()
    {
        if (_group == null || _isCreateMode) return;

        try
        {
            _loadingMembers = true;
            StateHasChanged();

            var result = await GroupService.GetGroupMembersAsync(_group.Id, page: 1, pageSize: 100);
            _members = result.Items ?? new List<BusinessPartyGroupMemberDto>();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load members for group {GroupId}", _group.Id);
            Snackbar.Add("Errore durante il caricamento dei membri", Severity.Warning);
        }
        finally
        {
            _loadingMembers = false;
            StateHasChanged();
        }
    }

    private async Task SaveGroupAsync()
    {
        if (_group == null || _form == null) return;

        await _form.Validate();
        if (!_form.IsValid) return;

        _isSaving = true;
        try
        {
            if (_isCreateMode)
            {
                var createDto = new CreateBusinessPartyGroupDto
                {
                    Name = _group.Name,
                    Code = _group.Code,
                    Description = _group.Description,
                    GroupType = _group.GroupType,
                    ColorHex = _group.ColorHex,
                    Icon = _group.Icon,
                    Priority = 50, // Default, verrà gestito dal riordino
                    IsActive = _group.IsActive,
                    ValidFrom = _group.ValidFrom,
                    ValidTo = _group.ValidTo
                };

                var created = await GroupService.CreateGroupAsync(createDto, "current-user");
                Snackbar.Add("Gruppo creato con successo", Severity.Success);
                
                // Navigate to edit page
                NavigationManager.NavigateTo($"/business/groups/{created.Id}");
            }
            else if (GroupId.HasValue)
            {
                var updateDto = new UpdateBusinessPartyGroupDto
                {
                    Name = _group.Name,
                    Code = _group.Code,
                    Description = _group.Description,
                    GroupType = _group.GroupType,
                    ColorHex = _group.ColorHex,
                    Icon = _group.Icon,
                    Priority = _group.Priority, // Mantiene priorità attuale
                    IsActive = _group.IsActive,
                    ValidFrom = _group.ValidFrom,
                    ValidTo = _group.ValidTo
                };

                await GroupService.UpdateGroupAsync(GroupId.Value, updateDto, "current-user");
                Snackbar.Add("Gruppo aggiornato con successo", Severity.Success);
                await LoadGroupAsync(); // Refresh and reset snapshot
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error saving group");
            Snackbar.Add("Errore nel salvataggio del gruppo", Severity.Error);
        }
        finally
        {
            _isSaving = false;
        }
    }

    private void MarkChanged()
    {
        _hasLocalChanges = true;
        StateHasChanged();
    }

    private string SerializeGroup(BusinessPartyGroupDto? g)
    {
        if (g == null) return string.Empty;
        return System.Text.Json.JsonSerializer.Serialize(g, _jsonOptions);
    }

    private bool HasUnsavedChanges()
    {
        if (_group == null) return false;
        if (_hasLocalChanges) return true;
        var current = SerializeGroup(_group);
        return !string.Equals(current, _originalGroupSnapshot, StringComparison.Ordinal);
    }

    private async Task TryNavigateAway(string target)
    {
        if (!HasUnsavedChanges())
        {
            NavigationManager.NavigateTo(target);
            return;
        }

        var result = await DialogService.ShowMessageBox(
            "Conferma", 
            "Ci sono modifiche non salvate. Vuoi salvare prima di uscire?",
            yesText: "Salva",
            noText: "Non salvare",
            cancelText: "Annulla");

        if (result == true)
        {
            await SaveGroupAsync();
            NavigationManager.NavigateTo(target);
        }
        else if (result == false)
        {
            NavigationManager.NavigateTo(target);
        }
    }

    #region Helper Methods

    private string GetPreviewBadgeStyle()
    {
        if (string.IsNullOrEmpty(ColorHex))
            return string.Empty;
        
        var bgColor = $"{ColorHex}20";
        return $"background-color: {bgColor}; color: {ColorHex}; border: 1px solid {ColorHex}40;";
    }

    private Color GetBusinessPartyTypeColor(BusinessPartyType type) => type switch
    {
        BusinessPartyType.Cliente => Color.Primary,
        BusinessPartyType.Customer => Color.Primary,
        BusinessPartyType.Supplier => Color.Success,
        BusinessPartyType.Both => Color.Secondary,
        _ => Color.Default
    };

    private string GetBusinessPartyTypeLabel(BusinessPartyType type) => type switch
    {
        BusinessPartyType.Cliente => "Cliente",
        BusinessPartyType.Customer => "Cliente",
        BusinessPartyType.Supplier => "Fornitore",
        BusinessPartyType.Both => "Entrambi",
        _ => "N/D"
    };

    private Color GetMemberStatusColor(BusinessPartyGroupMemberStatus status) => status switch
    {
        BusinessPartyGroupMemberStatus.Active => Color.Success,
        BusinessPartyGroupMemberStatus.Suspended => Color.Warning,
        BusinessPartyGroupMemberStatus.Expired => Color.Error,
        BusinessPartyGroupMemberStatus.Revoked => Color.Dark,
        _ => Color.Default
    };

    private string GetMemberStatusLabel(BusinessPartyGroupMemberStatus status) => status switch
    {
        BusinessPartyGroupMemberStatus.Active => "Attivo",
        BusinessPartyGroupMemberStatus.Suspended => "Sospeso",
        BusinessPartyGroupMemberStatus.Expired => "Scaduto",
        BusinessPartyGroupMemberStatus.Revoked => "Revocato",
        _ => "N/D"
    };

    #endregion

    #region Member Management (Placeholder)

    private async Task OpenAddMemberDialog()
    {
        // TODO: Implementare dialog con UnifiedBusinessPartySelector
        Snackbar.Add("Funzionalità aggiungi membro in sviluppo", Severity.Info);
        await Task.CompletedTask;
    }

    private async Task OpenEditMemberDialog(BusinessPartyGroupMemberDto member)
    {
        // TODO: Implementare dialog modifica membro
        Snackbar.Add("Funzionalità modifica membro in sviluppo", Severity.Info);
        await Task.CompletedTask;
    }

    private async Task RemoveMember(Guid memberId)
    {
        try
        {
            var confirm = await DialogService.ShowMessageBox(
                "Conferma",
                "Sei sicuro di voler rimuovere questo membro dal gruppo?",
                yesText: "Rimuovi",
                cancelText: "Annulla");

            if (confirm != true) return;

            await GroupService.RemoveMemberAsync(_group!.Id, memberId, "current-user");
            Snackbar.Add("Membro rimosso con successo", Severity.Success);

            await LoadMembersAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to remove member {MemberId}", memberId);
            Snackbar.Add("Errore durante la rimozione del membro", Severity.Error);
        }
    }

    #endregion
}
