@page "/business/groups/new"
@page "/business/groups/{GroupId:guid}"
@using Microsoft.AspNetCore.Authorization
@using EventForge.DTOs.Business
@using EventForge.DTOs.Common
@using EventForge.Client.Shared.Components
@using EventForge.Client.Shared.Components.Dialogs.Business
@attribute [Authorize]
@inject IBusinessPartyGroupService GroupService
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject ITranslationService TranslationService
@inject ILogger<BusinessPartyGroupDetail> Logger
@inject IJSRuntime JSRuntime

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <PageLoadingOverlay Visible="_isLoading || _isSaving"
                         Message="@(_isSaving ? TranslationService.GetTranslation("common.saving", "Salvataggio...") : TranslationService.GetTranslation("common.loading", "Caricamento..."))" />

    @if (_group == null && !_isCreateMode && !_isLoading)
    {
        <MudAlert Severity="Severity.Error">
            @TranslationService.GetTranslation("businessPartyGroup.notFound", "Gruppo non trovato")
        </MudAlert>
    }
    else if (!_isLoading)
    {
        <!-- Page Header -->
        <MudPaper Elevation="2" Class="pa-4 mb-4">
            <div class="d-flex justify-space-between align-center">
                <div>
                    <div class="d-flex align-center gap-2 mb-2">
                        <MudIconButton Icon="@Icons.Material.Filled.ArrowBack" 
                                       Color="Color.Primary"
                                       OnClick="@(() => NavigationManager.NavigateTo("/business/groups"))"
                                       Size="Size.Small" />
                        <MudText Typo="Typo.h4">
                            <MudIcon Icon="@Icons.Material.Outlined.Group" Class="mr-2" />
                            @if (_isCreateMode)
                            {
                                <text>Nuovo Gruppo</text>
                            }
                            else
                            {
                                <text>@(_group?.Name ?? "Gruppo Business Party")</text>
                            }
                        </MudText>
                        
                        @if (!_isCreateMode && _group != null)
                        {
                            <MudChip T="string" Size="Size.Small" Color="@(_group.IsActive ? Color.Success : Color.Default)">
                                @(_group.IsActive ? "Attivo" : "Inattivo")
                            </MudChip>
                        }
                    </div>
                </div>
                <div class="d-flex gap-2">
                    <MudButton Variant="Variant.Filled" 
                               Color="Color.Primary" 
                               StartIcon="@Icons.Material.Filled.Save"
                               OnClick="SaveGroupAsync"
                               Disabled="_isSaving"
                               Size="Size.Small">
                        Salva
                    </MudButton>
                </div>
            </div>
        </MudPaper>

        <!-- Tabs Section -->
        <MudPaper Elevation="2" Class="pa-2">
            <MudTabs Elevation="0" Rounded="false" PanelClass="pa-4" @bind-ActivePanelIndex="_activeTab" Color="Color.Primary">
                <MudTabPanel Text="Informazioni Generali" Icon="@Icons.Material.Filled.Info">
                    <MudGrid Spacing="3">
                        <MudItem xs="12" md="6">
                            <MudTextField @bind-Value="_groupName" 
                                          Label="Nome" 
                                          Required="true"
                                          Variant="Variant.Outlined" />
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <MudTextField @bind-Value="_groupCode" 
                                          Label="Codice" 
                                          Variant="Variant.Outlined" />
                        </MudItem>
                        <MudItem xs="12">
                            <MudTextField @bind-Value="_description" 
                                          Label="Descrizione" 
                                          Lines="3"
                                          Variant="Variant.Outlined" />
                        </MudItem>
                        <MudItem xs="12" md="4">
                            <MudSelect @bind-Value="_groupType" 
                                       Label="Tipo Gruppo"
                                       Variant="Variant.Outlined">
                                <MudSelectItem Value="BusinessPartyGroupType.Customer">Cliente</MudSelectItem>
                                <MudSelectItem Value="BusinessPartyGroupType.Supplier">Fornitore</MudSelectItem>
                                <MudSelectItem Value="BusinessPartyGroupType.Both">Entrambi</MudSelectItem>
                            </MudSelect>
                        </MudItem>
                        <MudItem xs="12" md="4">
                            <MudNumericField @bind-Value="_priority" 
                                             Label="Priorità" 
                                             Min="0" 
                                             Max="100"
                                             Variant="Variant.Outlined" />
                        </MudItem>
                        <MudItem xs="12" md="4">
                            <MudColorPicker @bind-Text="_colorHex" 
                                            Label="Colore"
                                            Variant="Variant.Outlined" />
                        </MudItem>
                    </MudGrid>
                </MudTabPanel>

                @if (!_isCreateMode && _group != null)
                {
                    <MudTabPanel Text="Membri" 
                                 Icon="@Icons.Material.Filled.People" 
                                 BadgeData="@_members?.Count" 
                                 BadgeDot="@(_members?.Any() == true)">
                        <MudStack Spacing="3">
                            <!-- Toolbar -->
                            <MudPaper Elevation="0" Class="pa-3 mb-3">
                                <div class="d-flex justify-space-between align-center mb-3">
                                    <MudText Typo="Typo.h6">
                                        <MudIcon Icon="@Icons.Material.Filled.People" Class="mr-2" />
                                        Membri del Gruppo
                                    </MudText>
                                    <MudStack Row="true" Spacing="2">
                                        <MudButton Variant="Variant.Text"
                                                   StartIcon="@Icons.Material.Filled.Download"
                                                   OnClick="@ExportMembersToCsv"
                                                   Size="Size.Small"
                                                   Disabled="@(!_members?.Any() ?? true)">
                                            Esporta CSV
                                        </MudButton>
                                        
                                        <MudButton Variant="Variant.Outlined"
                                                   Color="Color.Primary"
                                                   StartIcon="@Icons.Material.Filled.GroupAdd"
                                                   Size="Size.Small"
                                                   OnClick="@OpenBulkAddDialog">
                                            Aggiungi Multipli
                                        </MudButton>
                                        
                                        <MudButton Variant="Variant.Filled"
                                                   Color="Color.Primary"
                                                   StartIcon="@Icons.Material.Filled.Add"
                                                   Size="Size.Small"
                                                   OnClick="@OpenAddMemberDialog">
                                            Aggiungi Membro
                                        </MudButton>
                                    </MudStack>
                                </div>
                                
                                <!-- Statistiche Membri -->
                                @if (_members?.Any() == true)
                                {
                                    <MudGrid Spacing="2">
                                        <MudItem xs="4">
                                            <MudPaper Elevation="0" Class="pa-2" Style="background-color: var(--mud-palette-primary-lighten);">
                                                <MudStack Spacing="0" AlignItems="AlignItems.Center">
                                                    <MudText Typo="Typo.h5" Color="Color.Primary">@_members.Count()</MudText>
                                                    <MudText Typo="Typo.caption">Totali</MudText>
                                                </MudStack>
                                            </MudPaper>
                                        </MudItem>
                                        
                                        <MudItem xs="4">
                                            <MudPaper Elevation="0" Class="pa-2" Style="background-color: var(--mud-palette-success-lighten);">
                                                <MudStack Spacing="0" AlignItems="AlignItems.Center">
                                                    <MudText Typo="Typo.h5" Color="Color.Success">
                                                        @_members.Count(m => m.Status == BusinessPartyGroupMemberStatus.Active)
                                                    </MudText>
                                                    <MudText Typo="Typo.caption">Attivi</MudText>
                                                </MudStack>
                                            </MudPaper>
                                        </MudItem>
                                        
                                        <MudItem xs="4">
                                            <MudPaper Elevation="0" Class="pa-2" Style="background-color: var(--mud-palette-warning-lighten);">
                                                <MudStack Spacing="0" AlignItems="AlignItems.Center">
                                                    <MudText Typo="Typo.h5" Color="Color.Warning">
                                                        @_members.Count(m => m.Status == BusinessPartyGroupMemberStatus.Suspended)
                                                    </MudText>
                                                    <MudText Typo="Typo.caption">Sospesi</MudText>
                                                </MudStack>
                                            </MudPaper>
                                        </MudItem>
                                    </MudGrid>
                                }
                            </MudPaper>

                            <!-- Members List -->
                            @if (_isLoadingMembers)
                            {
                                <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
                            }
                            else if (_members == null || !_members.Any())
                            {
                                <MudAlert Severity="Severity.Info">
                                    Nessun membro nel gruppo. Aggiungi membri utilizzando i pulsanti sopra.
                                </MudAlert>
                            }
                            else
                            {
                                <MudSimpleTable Striped="true" Dense="false" Hover="true">
                                    <thead>
                                        <tr>
                                            <th>Business Party</th>
                                            <th>Tipo</th>
                                            <th>Membro Dal</th>
                                            <th>Membro Fino</th>
                                            <th>Stato</th>
                                            <th>Priorità</th>
                                            <th>Azioni</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var member in _members)
                                        {
                                            <tr>
                                                <td>
                                                    <MudStack Spacing="0">
                                                        <MudText Typo="Typo.body2" Style="font-weight: 600;">
                                                            @member.BusinessPartyName
                                                            @if (member.IsFeatured)
                                                            {
                                                                <MudIcon Icon="@Icons.Material.Filled.Star" Color="Color.Warning" Size="Size.Small" Class="ml-1" />
                                                            }
                                                        </MudText>
                                                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                                                            @member.BusinessPartyId
                                                        </MudText>
                                                    </MudStack>
                                                </td>
                                                <td>
                                                    <MudChip T="string" Size="Size.Small" Color="@GetBusinessPartyTypeColor(member.BusinessPartyType)">
                                                        @GetBusinessPartyTypeLabel(member.BusinessPartyType)
                                                    </MudChip>
                                                </td>
                                                <td>
                                                    <MudText Typo="Typo.body2">
                                                        @(member.MemberSince?.ToString("dd/MM/yyyy") ?? "-")
                                                    </MudText>
                                                </td>
                                                <td>
                                                    <MudText Typo="Typo.body2">
                                                        @(member.MemberUntil?.ToString("dd/MM/yyyy") ?? "∞")
                                                    </MudText>
                                                </td>
                                                <td>
                                                    <MudChip T="string" Size="Size.Small" Color="@GetMemberStatusColor(member.Status)">
                                                        @GetMemberStatusLabel(member.Status)
                                                    </MudChip>
                                                </td>
                                                <td>
                                                    <MudText Typo="Typo.body2">
                                                        @(member.OverridePriority?.ToString() ?? "-")
                                                    </MudText>
                                                </td>
                                                <td>
                                                    <MudStack Row="true" Spacing="1">
                                                        <MudIconButton Icon="@Icons.Material.Filled.Edit" 
                                                                       Color="Color.Primary" 
                                                                       Size="Size.Small"
                                                                       OnClick="@(() => OpenEditMemberDialog(member))" />
                                                        <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                                                       Color="Color.Error" 
                                                                       Size="Size.Small"
                                                                       OnClick="@(() => RemoveMember(member.BusinessPartyId))" />
                                                    </MudStack>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </MudSimpleTable>
                            }
                        </MudStack>
                    </MudTabPanel>
                }
            </MudTabs>
        </MudPaper>
    }
</MudContainer>

@code {
    [Parameter]
    public Guid? GroupId { get; set; }

    private bool _isCreateMode => !GroupId.HasValue || GroupId.Value == Guid.Empty;
    private bool _isLoading;
    private bool _isSaving;
    private bool _isLoadingMembers;
    private int _activeTab = 0;

    // Group properties
    private BusinessPartyGroupDto? _group;
    private string _groupName = string.Empty;
    private string? _groupCode;
    private string? _description;
    private BusinessPartyGroupType _groupType = BusinessPartyGroupType.Customer;
    private int _priority = 50;
    private string? _colorHex = "#1976D2";

    // Members
    private List<BusinessPartyGroupMemberDto>? _members;

    protected override async Task OnParametersSetAsync()
    {
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        if (_isCreateMode) return;

        _isLoading = true;
        try
        {
            _group = await GroupService.GetGroupByIdAsync(GroupId!.Value);
            if (_group != null)
            {
                _groupName = _group.Name;
                _groupCode = _group.Code;
                _description = _group.Description;
                _groupType = _group.GroupType;
                _priority = _group.Priority;
                _colorHex = _group.ColorHex;

                await LoadMembersAsync();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading group {GroupId}", GroupId);
            Snackbar.Add("Errore nel caricamento del gruppo", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task LoadMembersAsync()
    {
        if (_isCreateMode || GroupId == null) return;

        _isLoadingMembers = true;
        try
        {
            // Load with pagination - start with first 100 members
            // TODO: Implement proper pagination UI if groups have many members
            var result = await GroupService.GetGroupMembersAsync(GroupId.Value, 1, 100);
            _members = result?.Items?.ToList();
            
            if (result?.TotalCount > 100)
            {
                Snackbar.Add($"Visualizzati i primi 100 membri di {result.TotalCount} totali", Severity.Info);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading members for group {GroupId}", GroupId);
            Snackbar.Add("Errore nel caricamento dei membri", Severity.Error);
        }
        finally
        {
            _isLoadingMembers = false;
        }
    }

    private async Task SaveGroupAsync()
    {
        _isSaving = true;
        try
        {
            if (_isCreateMode)
            {
                var createDto = new CreateBusinessPartyGroupDto
                {
                    Name = _groupName,
                    Code = _groupCode,
                    Description = _description,
                    GroupType = _groupType,
                    Priority = _priority,
                    ColorHex = _colorHex
                };

                var created = await GroupService.CreateGroupAsync(createDto);
                Snackbar.Add("Gruppo creato con successo", Severity.Success);
                NavigationManager.NavigateTo($"/business/groups/{created.Id}");
            }
            else if (GroupId.HasValue)
            {
                var updateDto = new UpdateBusinessPartyGroupDto
                {
                    Name = _groupName,
                    Code = _groupCode,
                    Description = _description,
                    GroupType = _groupType,
                    Priority = _priority,
                    ColorHex = _colorHex,
                    IsActive = _group?.IsActive ?? true,
                    ValidFrom = _group?.ValidFrom,
                    ValidTo = _group?.ValidTo
                };

                await GroupService.UpdateGroupAsync(GroupId.Value, updateDto);
                Snackbar.Add("Gruppo aggiornato con successo", Severity.Success);
                await LoadDataAsync();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error saving group");
            Snackbar.Add("Errore nel salvataggio del gruppo", Severity.Error);
        }
        finally
        {
            _isSaving = false;
        }
    }

    private async Task OpenAddMemberDialog()
    {
        if (_group == null) return;
        
        var parameters = new DialogParameters<AddGroupMemberDialog>
        {
            { x => x.GroupId, _group.Id },
            { x => x.GroupType, _group.GroupType },
            { x => x.ExistingMemberIds, _members?.Select(m => m.BusinessPartyId).ToList() }
        };
        
        var options = new DialogOptions 
        { 
            CloseButton = true, 
            MaxWidth = MaxWidth.Medium, 
            FullWidth = true 
        };
        
        var dialog = await DialogService.ShowAsync<AddGroupMemberDialog>(
            "Aggiungi Membro al Gruppo",
            parameters,
            options);
        
        var result = await dialog.Result;
        if (!result.Canceled)
        {
            await LoadMembersAsync();
        }
    }

    private async Task OpenBulkAddDialog()
    {
        if (_group == null) return;
        
        var parameters = new DialogParameters<BulkAddGroupMembersDialog>
        {
            { x => x.GroupId, _group.Id },
            { x => x.GroupType, _group.GroupType },
            { x => x.ExistingMemberIds, _members?.Select(m => m.BusinessPartyId).ToList() }
        };
        
        var options = new DialogOptions 
        { 
            CloseButton = true, 
            MaxWidth = MaxWidth.Large, 
            FullWidth = true 
        };
        
        var dialog = await DialogService.ShowAsync<BulkAddGroupMembersDialog>(
            "Aggiungi Multipli Membri",
            parameters,
            options);
        
        var result = await dialog.Result;
        if (!result.Canceled && result.Data is int count && count > 0)
        {
            Snackbar.Add($"{count} membri aggiunti con successo", Severity.Success);
            await LoadMembersAsync();
        }
    }

    private async Task OpenEditMemberDialog(BusinessPartyGroupMemberDto member)
    {
        if (_group == null) return;
        
        var parameters = new DialogParameters<EditGroupMemberDialog>
        {
            { x => x.Member, member },
            { x => x.GroupId, _group.Id }
        };
        
        var options = new DialogOptions 
        { 
            CloseButton = true, 
            MaxWidth = MaxWidth.Medium, 
            FullWidth = true 
        };
        
        var dialog = await DialogService.ShowAsync<EditGroupMemberDialog>(
            "Modifica Membro Gruppo",
            parameters,
            options);
        
        var result = await dialog.Result;
        if (!result.Canceled)
        {
            await LoadMembersAsync();
        }
    }

    private async Task RemoveMember(Guid businessPartyId)
    {
        if (_group == null) return;
        
        try
        {
            var confirm = await DialogService.ShowMessageBox(
                "Conferma Rimozione",
                "Sei sicuro di voler rimuovere questo membro dal gruppo?",
                yesText: "Rimuovi",
                cancelText: "Annulla");

            if (confirm != true) return;

            var removed = await GroupService.RemoveMemberAsync(_group.Id, businessPartyId);
            if (removed)
            {
                Snackbar.Add("Membro rimosso con successo", Severity.Success);
                await LoadMembersAsync();
            }
            else
            {
                Snackbar.Add("Impossibile rimuovere il membro: membro non trovato o già rimosso", Severity.Warning);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to remove business party {BusinessPartyId}", businessPartyId);
            Snackbar.Add("Errore durante la rimozione del membro", Severity.Error);
        }
    }

    private async Task ExportMembersToCsv()
    {
        if (_members == null || !_members.Any()) return;
        
        try
        {
            var csv = new System.Text.StringBuilder();
            csv.AppendLine("Nome,Tipo,Membro Dal,Membro Fino,Stato,Priorità,In Evidenza");
            
            foreach (var member in _members.OrderBy(m => m.BusinessPartyName))
            {
                csv.AppendLine($"\"{member.BusinessPartyName}\"," +
                              $"{GetBusinessPartyTypeLabel(member.BusinessPartyType)}," +
                              $"{member.MemberSince?.ToString("dd/MM/yyyy") ?? "-"}," +
                              $"{member.MemberUntil?.ToString("dd/MM/yyyy") ?? "Permanente"}," +
                              $"{GetMemberStatusLabel(member.Status)}," +
                              $"{member.OverridePriority?.ToString() ?? "-"}," +
                              $"{(member.IsFeatured ? "Sì" : "No")}");
            }
            
            var fileName = $"membri_gruppo_{_group?.Name ?? "export"}_{DateTime.Now:yyyyMMdd_HHmmss}.csv";
            
            await JSRuntime.InvokeVoidAsync("downloadFile", fileName, "text/csv", csv.ToString());
            
            Snackbar.Add($"Esportati {_members.Count()} membri", Severity.Success);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to export members to CSV");
            Snackbar.Add("Errore durante l'esportazione", Severity.Error);
        }
    }

    private Color GetBusinessPartyTypeColor(BusinessPartyType type) => type switch
    {
        BusinessPartyType.Cliente or BusinessPartyType.Customer => Color.Primary,
        BusinessPartyType.Supplier => Color.Secondary,
        BusinessPartyType.Both => Color.Info,
        _ => Color.Default
    };

    private string GetBusinessPartyTypeLabel(BusinessPartyType type) => type switch
    {
        BusinessPartyType.Cliente or BusinessPartyType.Customer => "Cliente",
        BusinessPartyType.Supplier => "Fornitore",
        BusinessPartyType.Both => "Entrambi",
        _ => "N/D"
    };

    private Color GetMemberStatusColor(BusinessPartyGroupMemberStatus status) => status switch
    {
        BusinessPartyGroupMemberStatus.Active => Color.Success,
        BusinessPartyGroupMemberStatus.Suspended => Color.Warning,
        BusinessPartyGroupMemberStatus.Expired => Color.Default,
        BusinessPartyGroupMemberStatus.Revoked => Color.Error,
        _ => Color.Default
    };

    private string GetMemberStatusLabel(BusinessPartyGroupMemberStatus status) => status switch
    {
        BusinessPartyGroupMemberStatus.Active => "Attivo",
        BusinessPartyGroupMemberStatus.Suspended => "Sospeso",
        BusinessPartyGroupMemberStatus.Expired => "Scaduto",
        BusinessPartyGroupMemberStatus.Revoked => "Revocato",
        _ => "N/D"
    };
}
