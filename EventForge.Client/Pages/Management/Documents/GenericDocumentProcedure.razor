@page "/documents/create"
@page "/documents/edit/{DocumentId:guid}"
@using Microsoft.AspNetCore.Authorization
@using EventForge.DTOs.Common
@using EventForge.DTOs.Documents
@using EventForge.DTOs.Business
@using EventForge.DTOs.Products
@using EventForge.Client.Shared.Components.Dialogs.Documents
@using EventForge.Client.Shared.Documents
@using EventForge.Client.Shared.Components
@attribute [Authorize(Roles = "SuperAdmin,Admin,Manager,Operator")]
@inject IDocumentHeaderService DocumentHeaderService
@inject IDocumentTypeService DocumentTypeService
@inject IBusinessPartyService BusinessPartyService
@inject IProductService ProductService
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject ITranslationService TranslationService
@inject ILogger<GenericDocumentProcedure> Logger
@inject NavigationManager NavigationManager

<PageTitle>@_pageTitle</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudGrid Class="mb-4">
        <MudItem xs="12" md="8">
            <MudText Typo="Typo.h4">
                <MudIcon Icon="@Icons.Material.Outlined.Description" Class="mr-2" Size="Size.Medium" />
                @_pageTitle
            </MudText>
        </MudItem>
        <MudItem xs="12" md="4">
            <MudStack Row="true" Justify="Justify.FlexEnd">
                <MudButton StartIcon="@Icons.Material.Outlined.ArrowBack"
                           Color="Color.Default"
                           Variant="Variant.Outlined"
                           OnClick="@(() => NavigationManager.NavigateTo("/documents/list"))">
                    @TranslationService.GetTranslation("common.back", "Indietro")
                </MudButton>
            </MudStack>
        </MudItem>
    </MudGrid>

    <PageLoadingOverlay Visible="_isLoading"
                        Message="@(_isLoading ? TranslationService.GetTranslation("messages.loadingPage", "Caricamento pagina...") : TranslationService.GetTranslation("common.loading", "Caricamento..."))" />

    <!-- Ultra-Compact Inline Document Header -->
    <MudPaper Elevation="2" Class="pa-2 mb-3 document-inline-header">
        <!-- Primary Action Bar (Always Visible) -->
        <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center" Class="flex-wrap">
            <!-- Document Type -->
            <MudSelect T="Guid" 
                      @bind-Value="_model.DocumentTypeId" 
                      Variant="Variant.Outlined"
                      Dense="true"
                      Margin="Margin.Dense"
                      Disabled="@_isEditMode"
                      Style="min-width: 180px; max-width: 200px;"
                      aria-label="@TranslationService.GetTranslation("documents.documentType", "Tipo Documento")">
                @foreach (var type in _documentTypes ?? Enumerable.Empty<DocumentTypeDto>())
                {
                    <MudSelectItem Value="@type.Id">@type.Name</MudSelectItem>
                }
            </MudSelect>

            <!-- Document Number (Read-only chip) -->
            <MudChip T="string" 
                     Color="Color.Default" 
                     Size="Size.Medium"
                     Icon="@Icons.Material.Outlined.Tag"
                     Style="font-family: monospace; font-weight: 600;">
                @(!string.IsNullOrWhiteSpace(_model.Series) ? $"{_model.Series}/" : "")@(_model.Number ?? "---")
            </MudChip>

            <!-- Separator -->
            <MudText Typo="Typo.body1" Style="color: var(--mud-palette-text-disabled);">•</MudText>

            <!-- Document Date (Compact inline date picker) -->
            <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                <MudIcon Icon="@Icons.Material.Outlined.CalendarToday" Size="Size.Small" />
                <MudDatePicker @bind-Date="_documentDate"
                              Variant="Variant.Text"
                              Dense="true"
                              Margin="Margin.Dense"
                              DateFormat="dd/MM/yyyy"
                              Editable="true"
                              Style="width: 110px;"
                              aria-label="@TranslationService.GetTranslation("documents.date", "Data Documento")" />
            </MudStack>

            <!-- Separator -->
            <MudText Typo="Typo.body1" Style="color: var(--mud-palette-text-disabled);">•</MudText>

            <!-- Business Party (Compact autocomplete) -->
            <MudAutocomplete T="BusinessPartyDto"
                            @bind-Value="_selectedBusinessParty"
                            SearchFunc="@SearchBusinessPartiesAsync"
                            ToStringFunc="@(bp => bp?.Name ?? string.Empty)"
                            Variant="Variant.Outlined"
                            Dense="true"
                            Margin="Margin.Dense"
                            ShowProgressIndicator="true"
                            Clearable="false"
                            Style="min-width: 220px; max-width: 300px;"
                            Placeholder="@TranslationService.GetTranslation("documents.selectBusinessParty", "Seleziona controparte")"
                            aria-label="@TranslationService.GetTranslation("documents.businessParty", "Controparte")"
                            AdornmentIcon="@Icons.Material.Outlined.Business">
                <ItemTemplate>
                    <MudStack Spacing="0">
                        <MudText Typo="Typo.body2">@context.Name</MudText>
                        @if (!string.IsNullOrEmpty(context.TaxCode))
                        {
                            <MudText Typo="Typo.caption" Style="color: var(--mud-palette-text-secondary);">
                                @context.TaxCode
                            </MudText>
                        }
                    </MudStack>
                </ItemTemplate>
            </MudAutocomplete>

            <!-- Separator -->
            <MudText Typo="Typo.body1" Style="color: var(--mud-palette-text-disabled);">•</MudText>

            <!-- Document Status Selector -->
            <MudSelect T="DocumentStatus" 
                      @bind-Value="_documentStatus"
                      Variant="Variant.Outlined"
                      Dense="true"
                      Margin="Margin.Dense"
                      Style="min-width: 140px;"
                      ValueChanged="@OnStatusChanged"
                      Disabled="@(!_isEditMode || _currentDocument == null)"
                      aria-label="@TranslationService.GetTranslation("documents.status", "Stato Documento")">
                <MudSelectItem Value="@DocumentStatus.Draft">
                    <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                        <MudIcon Icon="@Icons.Material.Outlined.Edit" Size="Size.Small" Color="Color.Default" />
                        <MudText>@TranslationService.GetTranslation("status.draft", "Bozza")</MudText>
                    </MudStack>
                </MudSelectItem>
                <MudSelectItem Value="@DocumentStatus.Open">
                    <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                        <MudIcon Icon="@Icons.Material.Outlined.CheckCircleOutline" Size="Size.Small" Color="Color.Success" />
                        <MudText>@TranslationService.GetTranslation("status.open", "Aperto")</MudText>
                    </MudStack>
                </MudSelectItem>
                <MudSelectItem Value="@DocumentStatus.Closed">
                    <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                        <MudIcon Icon="@Icons.Material.Outlined.Lock" Size="Size.Small" Color="Color.Warning" />
                        <MudText>@TranslationService.GetTranslation("status.closed", "Chiuso")</MudText>
                    </MudStack>
                </MudSelectItem>
                <MudSelectItem Value="@DocumentStatus.Cancelled">
                    <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                        <MudIcon Icon="@Icons.Material.Outlined.Cancel" Size="Size.Small" Color="Color.Error" />
                        <MudText>@TranslationService.GetTranslation("status.cancelled", "Annullato")</MudText>
                    </MudStack>
                </MudSelectItem>
            </MudSelect>

            <MudSpacer />

            <!-- Save Button -->
            <MudTooltip Text="@TranslationService.GetTranslation("common.save", "Salva")">
                <MudIconButton Icon="@Icons.Material.Outlined.Save"
                              Color="Color.Primary"
                              Variant="Variant.Filled"
                              Size="Size.Medium"
                              OnClick="@SaveDocumentHeaderAsync"
                              Disabled="@(!CanSaveHeader())"
                              aria-label="@TranslationService.GetTranslation("common.save", "Salva documento")" />
            </MudTooltip>

            <!-- Expand/Collapse Details Button -->
            <MudTooltip Text="@(_detailsExpanded ? TranslationService.GetTranslation("documents.hideDetails", "Nascondi dettagli") : TranslationService.GetTranslation("documents.showDetails", "Mostra dettagli"))">
                <MudButton StartIcon="@(_detailsExpanded ? Icons.Material.Outlined.ExpandLess : Icons.Material.Outlined.ExpandMore)"
                          Variant="Variant.Text"
                          Size="Size.Small"
                          OnClick="@(() => _detailsExpanded = !_detailsExpanded)"
                          Style="text-transform: none;">
                    @(_detailsExpanded ? TranslationService.GetTranslation("common.hide", "Nascondi") : TranslationService.GetTranslation("documents.details", "Dettagli"))
                </MudButton>
            </MudTooltip>
        </MudStack>

        <!-- Expanded Details Section (Collapsible) -->
        <MudCollapse Expanded="@_detailsExpanded">
            <MudDivider Class="my-2" />
            
            <MudText Typo="Typo.subtitle2" Color="Color.Primary" Class="mb-2">
                <MudIcon Icon="@Icons.Material.Outlined.Description" Size="Size.Small" Class="mr-1" />
                @TranslationService.GetTranslation("documents.documentDetails", "Dettagli Documento")
            </MudText>

            <MudGrid Spacing="2">
                <!-- Row 1: Series, Number, Type -->
                <MudItem xs="12" sm="4">
                    <MudTextField T="string"
                                 @bind-Value="_model.Series"
                                 Label="@TranslationService.GetTranslation("documents.series", "Serie")"
                                 Variant="Variant.Outlined"
                                 Dense="true"
                                 Margin="Margin.Dense" />
                </MudItem>
                <MudItem xs="12" sm="4">
                    <MudTextField T="string"
                                 Value="@_model.Number"
                                 Label="@TranslationService.GetTranslation("documents.number", "Numero")"
                                 Variant="Variant.Outlined"
                                 Dense="true"
                                 Margin="Margin.Dense"
                                 Disabled="true"
                                 HelperText="@TranslationService.GetTranslation("documents.autoGenerated", "Generato automaticamente")" />
                </MudItem>
                <MudItem xs="12" sm="4">
                    <MudTextField T="string"
                                 Value="@(_documentTypes?.FirstOrDefault(dt => dt.Id == _model.DocumentTypeId)?.Name ?? "N/D")"
                                 Label="@TranslationService.GetTranslation("documents.documentType", "Tipo Documento")"
                                 Variant="Variant.Outlined"
                                 Dense="true"
                                 Margin="Margin.Dense"
                                 Disabled="true" />
                </MudItem>

                <!-- Row 2: Date, Business Party, Tax Code -->
                <MudItem xs="12" sm="4">
                    <MudDatePicker @bind-Date="_documentDate"
                                  Label="@TranslationService.GetTranslation("documents.documentDate", "Data Documento")"
                                  Variant="Variant.Outlined"
                                  Dense="true"
                                  Margin="Margin.Dense"
                                  DateFormat="dd/MM/yyyy" />
                </MudItem>
                <MudItem xs="12" sm="4">
                    <MudTextField T="string"
                                 Value="@(_selectedBusinessParty?.Name ?? "N/D")"
                                 Label="@TranslationService.GetTranslation("documents.businessParty", "Controparte")"
                                 Variant="Variant.Outlined"
                                 Dense="true"
                                 Margin="Margin.Dense"
                                 Disabled="true" />
                </MudItem>
                <MudItem xs="12" sm="4">
                    <MudTextField T="string"
                                 Value="@(_selectedBusinessParty?.TaxCode ?? "N/D")"
                                 Label="@TranslationService.GetTranslation("documents.taxCode", "P.IVA / C.F.")"
                                 Variant="Variant.Outlined"
                                 Dense="true"
                                 Margin="Margin.Dense"
                                 Disabled="true" />
                </MudItem>

                <!-- Row 3: Notes (Full Width) -->
                <MudItem xs="12">
                    <MudTextField T="string"
                                 @bind-Value="_model.Notes"
                                 Label="@TranslationService.GetTranslation("documents.notes", "Note")"
                                 Variant="Variant.Outlined"
                                 Dense="true"
                                 Margin="Margin.Dense"
                                 Lines="3"
                                 Placeholder="@TranslationService.GetTranslation("documents.notesPlaceholder", "Note opzionali per il documento...")" />
                </MudItem>
            </MudGrid>
        </MudCollapse>
    </MudPaper>

    <!-- Document Rows Section with VAT/Totals Panel -->
    <MudGrid Class="mt-4">
        <!-- Left column: Document Rows Table -->
        <MudItem xs="12" lg="8">
            <MudPaper Elevation="2" Class="pa-4">
                <MudText Typo="Typo.h6" Class="mb-3">
                    <MudIcon Icon="@Icons.Material.Outlined.List" Class="mr-2" />
                    @TranslationService.GetTranslation("documents.rows", "Righe Documento")
                </MudText>

                @if (_currentDocument == null)
                {
                    <!-- Documento non ancora salvato -->
                    <MudAlert Severity="Severity.Info" Class="mb-4" Icon="@Icons.Material.Outlined.Info">
                        <MudStack Spacing="2">
                            <MudText>
                                <strong>@TranslationService.GetTranslation("documents.saveFirstTitle", "Salva prima il documento")</strong>
                            </MudText>
                            <MudText Typo="Typo.body2">
                                @TranslationService.GetTranslation("documents.saveFirstMessage", "Per poter aggiungere righe al documento, è necessario salvarlo prima compilando i campi della testata (Tipo Documento, Cliente, Data) e cliccando su 'Salva'.")
                            </MudText>
                        </MudStack>
                    </MudAlert>
                }
                else
                {
                    <!-- Search/Filter Section -->
                    @if (HasRows)
                    {
                        <MudPaper Elevation="1" Class="pa-3 mb-3">
                            <MudTextField @bind-Value="_searchQuery"
                                          Label="@TranslationService.GetTranslation("documents.searchArticles", "Cerca articolo")"
                                          Placeholder="@TranslationService.GetTranslation("documents.searchByCodeOrDescription", "Cerca per codice o descrizione...")"
                                          Variant="Variant.Outlined"
                                          Adornment="Adornment.Start"
                                          AdornmentIcon="@Icons.Material.Outlined.Search"
                                          AdornmentColor="Color.Primary"
                                          Immediate="true"
                                          Clearable="true"
                                          DebounceInterval="300"
                                          HelperText="@GetSearchHelperText()"
                                          Class="mb-2" />
                        </MudPaper>
                    }
                    
                    <!-- Documento salvato - mostra sempre la toolbar con il pulsante Aggiungi Riga -->
                    <ManagementTableToolbar ShowSelectionBadge="@HasRows"
                                            SelectedCount="@_selectedRows.Count"
                                            ShowRefresh="false"
                                            ShowCreate="true"
                                            ShowDelete="@(HasRows && _selectedRows.Count > 0)"
                                            CreateLabel="documents.addRow"
                                            CreateTooltip="documents.addRowTooltip"
                                            IsDisabled="_isLoading"
                                            OnCreate="@AddRowAsync"
                                            OnDelete="@DeleteSelectedRowsAsync">
                        <AdditionalActions>
                            @if (_selectedRows.Count >= 2 && CanMergeSelectedRows())
                            {
                                <MudButton Variant="Variant.Text"
                                           Color="Color.Primary"
                                           StartIcon="@Icons.Material.Outlined.MergeType"
                                           OnClick="@MergeSelectedRowsAsync"
                                           Disabled="@_isLoading"
                                           Size="Size.Small">
                                    @TranslationService.GetTranslation("documents.mergeRows", "Unisci Righe")
                                </MudButton>
                            }
                        </AdditionalActions>
                    </ManagementTableToolbar>
                    
                    @if (HasRows)
                    {
                        <!-- EFTable with full column configuration and actions -->
                        <EFTable @ref="_efTable"
                                 TItem="DocumentRowDto"
                                 Items="@_filteredRows"
                                 ComponentKey="GenericDocumentRows"
                                 InitialColumnConfigurations="@_documentRowColumns"
                                 AllowDragDropGrouping="true"
                                 ShowColumnConfiguration="true"
                                 Dense="true"
                                 Hover="true"
                                 Striped="true"
                                 FixedHeader="true"
                                 Height="calc(100vh - 450px)">
                            <HeaderContent Context="columnConfigurations">
                                @foreach (var column in columnConfigurations.Where(c => c.IsVisible).OrderBy(c => c.Order))
                                {
                                    <EFTableColumnHeader TItem="DocumentRowDto" 
                                                       PropertyName="@column.PropertyName" 
                                                       OnDragStartCallback="@_efTable.HandleColumnDragStart">
                                        <MudTableSortLabel T="DocumentRowDto">@column.DisplayName</MudTableSortLabel>
                                    </EFTableColumnHeader>
                                }
                                
                                <!-- Actions column - always visible -->
                                <MudTh Style="text-align: right; white-space: nowrap; min-width: 120px;">
                                    @TranslationService.GetTranslation("common.actions", "Azioni")
                                </MudTh>
                            </HeaderContent>
                            <RowTemplate Context="row">
                                @{
                                    var visibleColumns = _efTable?.ColumnConfigurations
                                        ?.Where(c => c.IsVisible)
                                        .OrderBy(c => c.Order)
                                        .ToList() ?? _documentRowColumns.Where(c => c.IsVisible).OrderBy(c => c.Order).ToList();
                                    
                                    var grossTotal = row.LineTotal + row.VatTotal;
                                }
                                
                                @foreach (var column in visibleColumns)
                                {
                                    @if (column.PropertyName == "ProductCode")
                                    {
                                        <MudTd DataLabel="@column.DisplayName">
                                            <MudText Typo="Typo.body2">@row.ProductCode</MudText>
                                        </MudTd>
                                    }
                                    else if (column.PropertyName == "Description")
                                    {
                                        <MudTd DataLabel="@column.DisplayName">
                                            @if (!string.IsNullOrWhiteSpace(_searchQuery))
                                            {
                                                <MudHighlighter Text="@row.Description" 
                                                               HighlightedText="@_searchQuery" 
                                                               CaseSensitive="false" />
                                            }
                                            else
                                            {
                                                <MudText Typo="Typo.body2">@row.Description</MudText>
                                            }
                                        </MudTd>
                                    }
                                    else if (column.PropertyName == "Quantity")
                                    {
                                        <MudTd DataLabel="@column.DisplayName" Style="text-align: right;">
                                            <MudText Typo="Typo.body2">@row.Quantity.ToString("N2")</MudText>
                                        </MudTd>
                                    }
                                    else if (column.PropertyName == "UnitOfMeasure")
                                    {
                                        <MudTd DataLabel="@column.DisplayName" Style="text-align: center;">
                                            <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined">
                                                @row.UnitOfMeasure
                                            </MudChip>
                                        </MudTd>
                                    }
                                    else if (column.PropertyName == "UnitPrice")
                                    {
                                        <MudTd DataLabel="@column.DisplayName" Style="text-align: right;">
                                            <MudText Typo="Typo.body2">@row.UnitPrice.ToString("C2")</MudText>
                                        </MudTd>
                                    }
                                    else if (column.PropertyName == "VatRate")
                                    {
                                        <MudTd DataLabel="@column.DisplayName" Style="text-align: center;">
                                            <MudChip T="string" Size="Size.Small" Color="Color.Info" Icon="@Icons.Material.Outlined.Percent">
                                                @row.VatRate.ToString("N0")%
                                            </MudChip>
                                        </MudTd>
                                    }
                                    else if (column.PropertyName == "DiscountTotal")
                                    {
                                        <MudTd DataLabel="@column.DisplayName" Style="text-align: right;">
                                            @if (row.DiscountTotal > 0)
                                            {
                                                <MudText Typo="Typo.body2" Color="Color.Success">
                                                    -@row.DiscountTotal.ToString("C2")
                                                </MudText>
                                            }
                                            else
                                            {
                                                <MudText Typo="Typo.body2" Style="color: var(--mud-palette-text-disabled);">—</MudText>
                                            }
                                        </MudTd>
                                    }
                                    else if (column.PropertyName == "LineTotal")
                                    {
                                        <MudTd DataLabel="@column.DisplayName" Style="text-align: right;">
                                            <MudText Typo="Typo.body2" Style="font-weight: 500;">
                                                @row.LineTotal.ToString("C2")
                                            </MudText>
                                        </MudTd>
                                    }
                                    else if (column.PropertyName == "VatTotal")
                                    {
                                        <MudTd DataLabel="@column.DisplayName" Style="text-align: right;">
                                            <MudText Typo="Typo.body2" Color="Color.Info">
                                                @row.VatTotal.ToString("C2")
                                            </MudText>
                                        </MudTd>
                                    }
                                    else if (column.PropertyName == "GrossTotal")
                                    {
                                        <MudTd DataLabel="@column.DisplayName" Style="text-align: right;">
                                            <MudText Typo="Typo.h6" Color="Color.Primary" Style="font-weight: 600;">
                                                @grossTotal.ToString("C2")
                                            </MudText>
                                        </MudTd>
                                    }
                                    else if (column.PropertyName == "VatDescription")
                                    {
                                        <MudTd DataLabel="@column.DisplayName">
                                            <MudText Typo="Typo.caption">@row.VatDescription</MudText>
                                        </MudTd>
                                    }
                                    else if (column.PropertyName == "LineDiscount")
                                    {
                                        <MudTd DataLabel="@column.DisplayName" Style="text-align: right;">
                                            @if (row.LineDiscount > 0)
                                            {
                                                <MudText Typo="Typo.body2">@row.LineDiscount.ToString("N2")%</MudText>
                                            }
                                            else
                                            {
                                                <MudText Typo="Typo.body2" Style="color: var(--mud-palette-text-disabled);">—</MudText>
                                            }
                                        </MudTd>
                                    }
                                    else if (column.PropertyName == "LineDiscountValue")
                                    {
                                        <MudTd DataLabel="@column.DisplayName" Style="text-align: right;">
                                            @if (row.LineDiscountValue > 0)
                                            {
                                                <MudText Typo="Typo.body2">@row.LineDiscountValue.ToString("C2")</MudText>
                                            }
                                            else
                                            {
                                                <MudText Typo="Typo.body2" Style="color: var(--mud-palette-text-disabled);">—</MudText>
                                            }
                                        </MudTd>
                                    }
                                }
                                
                                <!-- Actions cell -->
                                <MudTd DataLabel="@TranslationService.GetTranslation("common.actions", "Azioni")" 
                                       Style="text-align: right; white-space: nowrap;">
                                    <MudTooltip Text="@TranslationService.GetTranslation("common.edit", "Modifica")">
                                        <MudIconButton Icon="@Icons.Material.Outlined.Edit" 
                                                      Size="Size.Small" 
                                                      Color="Color.Primary"
                                                      OnClick="@(() => EditRow(row))" />
                                    </MudTooltip>
                                    <MudTooltip Text="@TranslationService.GetTranslation("common.delete", "Elimina")">
                                        <MudIconButton Icon="@Icons.Material.Outlined.Delete" 
                                                      Size="Size.Small" 
                                                      Color="Color.Error"
                                                      OnClick="@(() => DeleteRow(row))" />
                                    </MudTooltip>
                                </MudTd>
                            </RowTemplate>
                        </EFTable>
                    }
                    else
                    {
                        <!-- Mostra messaggio informativo -->
                        <MudAlert Severity="Severity.Info" Class="mb-4">
                            <MudText>
                                @TranslationService.GetTranslation("documents.noRows", "Nessuna riga presente. Clicca 'Aggiungi Riga' per iniziare.")
                            </MudText>
                        </MudAlert>
                    }
                }
            </MudPaper>
        </MudItem>

        <!-- Right column: VAT Summary and Totals -->
        <MudItem xs="12" lg="4" Class="document-sidebar-sticky">
            <MudStack Spacing="3">
                <DocumentVatSummary Rows="@_currentDocument?.Rows" />
                <DocumentTotalsCard Document="@_currentDocument" />
            </MudStack>
        </MudItem>
    </MudGrid>
</MudContainer>

@code {
    [Parameter] public Guid? DocumentId { get; set; }

    private bool _isLoading = false;
    private bool _isEditMode => DocumentId.HasValue;
    private string _pageTitle = "";
    private CreateDocumentHeaderDto _model = new();
    private DocumentHeaderDto? _currentDocument = null;
    private DateTime? _documentDate = DateTime.Now;
    private List<DocumentTypeDto> _documentTypes = new();
    private BusinessPartyDto? _selectedBusinessParty = null;
    
    // Document status binding
    private DocumentStatus _documentStatus = DocumentStatus.Draft;
    
    // Selection management for rows
    private HashSet<DocumentRowDto> _selectedRows = new();
    
    // Search functionality
    private string _searchQuery = string.Empty;
    private IEnumerable<DocumentRowDto>? _filteredRows => FilterRows();
    
    // Computed property for checking if document has rows
    private bool HasRows => _currentDocument?.Rows?.Any() ?? false;

    // EFTable reference
    private EFTable<DocumentRowDto> _efTable = null!;
    
    // Details expansion state
    private bool _detailsExpanded = false;

    // Column configuration for EFTable
    private List<EFTableColumnConfiguration> _documentRowColumns = new();
    private Dictionary<string, EFTableColumnConfiguration> _columnLookup = new();

    // Helper per verificare visibilità colonna
    private bool IsColumnVisible(string propertyName)
    {
        return _columnLookup.TryGetValue(propertyName, out var column) && column.IsVisible;
    }
    
    // Helper per ottenere label colonna (con traduzione)
    private string GetColumnLabel(string propertyName)
    {
        if (_columnLookup.TryGetValue(propertyName, out var column))
        {
            return column.DisplayName;
        }
        return propertyName;
    }
    
    // Helper per stili header colonne
    private string GetHeaderStyle(string propertyName)
    {
        // Allinea a destra le colonne numeriche
        var numericColumns = new[] { "Quantity", "UnitPrice", "VatRate", "DiscountTotal", "LineTotal", "VatTotal", "GrossTotal", "LineDiscount", "LineDiscountValue" };
        
        if (numericColumns.Contains(propertyName))
            return "text-align: right; white-space: nowrap;";
        
        if (propertyName == "UnitOfMeasure")
            return "text-align: center; white-space: nowrap;";
        
        return "white-space: nowrap;";
    }
    
    // Funzioni di ordinamento per colonne
    private Func<DocumentRowDto, object> GetSortFunc(string propertyName)
    {
        return propertyName switch
        {
            "ProductCode" => x => x.ProductCode ?? string.Empty,
            "Description" => x => x.Description ?? string.Empty,
            "Quantity" => x => x.Quantity,
            "UnitOfMeasure" => x => x.UnitOfMeasure ?? string.Empty,
            "UnitPrice" => x => x.UnitPrice,
            "VatRate" => x => x.VatRate,
            "DiscountTotal" => x => x.DiscountTotal,
            "LineTotal" => x => x.LineTotal,
            "VatTotal" => x => x.VatTotal,
            "GrossTotal" => x => x.LineTotal + x.VatTotal,
            "VatDescription" => x => x.VatDescription ?? string.Empty,
            "LineDiscount" => x => x.LineDiscount,
            "LineDiscountValue" => x => x.LineDiscountValue,
            _ => x => x.Id
        };
    }

    protected override async Task OnInitializedAsync()
    {
        // Initialize column configurations with translations
        _documentRowColumns = new List<EFTableColumnConfiguration>
        {
            // Colonne sempre visibili di default
            new() { PropertyName = "ProductCode", DisplayName = TranslationService.GetTranslation("documents.column.productcode", "Codice"), IsVisible = true, Order = 0 },
            new() { PropertyName = "Description", DisplayName = TranslationService.GetTranslation("documents.column.description", "Descrizione"), IsVisible = true, Order = 1 },
            new() { PropertyName = "Quantity", DisplayName = TranslationService.GetTranslation("documents.column.quantity", "Quantità"), IsVisible = true, Order = 2 },
            new() { PropertyName = "UnitOfMeasure", DisplayName = TranslationService.GetTranslation("documents.column.unitofmeasure", "UM"), IsVisible = true, Order = 3 },
            new() { PropertyName = "UnitPrice", DisplayName = TranslationService.GetTranslation("documents.column.unitprice", "Prezzo Unit."), IsVisible = true, Order = 4 },
            new() { PropertyName = "VatRate", DisplayName = TranslationService.GetTranslation("documents.column.vatrate", "IVA %"), IsVisible = true, Order = 5 },
            new() { PropertyName = "DiscountTotal", DisplayName = TranslationService.GetTranslation("documents.column.discounttotal", "Sconto"), IsVisible = true, Order = 6 },
            new() { PropertyName = "LineTotal", DisplayName = TranslationService.GetTranslation("documents.column.linetotal", "Imponibile"), IsVisible = true, Order = 7 },
            new() { PropertyName = "VatTotal", DisplayName = TranslationService.GetTranslation("documents.column.vattotal", "Imposta"), IsVisible = true, Order = 8 },
            new() { PropertyName = "GrossTotal", DisplayName = TranslationService.GetTranslation("documents.column.grosstotal", "Totale Lordo"), IsVisible = true, Order = 9 },
            
            // Colonne opzionali (nascoste di default, utente può abilitarle)
            new() { PropertyName = "VatDescription", DisplayName = TranslationService.GetTranslation("documents.column.vatdescription", "Desc. IVA"), IsVisible = false, Order = 10 },
            new() { PropertyName = "LineDiscount", DisplayName = TranslationService.GetTranslation("documents.column.linediscount", "Sconto %"), IsVisible = false, Order = 11 },
            new() { PropertyName = "LineDiscountValue", DisplayName = TranslationService.GetTranslation("documents.column.linediscountvalue", "Valore Sconto"), IsVisible = false, Order = 12 },
        };

        // Build lookup dictionary for efficient column access
        _columnLookup = _documentRowColumns.ToDictionary(c => c.PropertyName, c => c);

        _pageTitle = _isEditMode
            ? TranslationService.GetTranslation("documents.editDocument", "Modifica Documento")
            : TranslationService.GetTranslation("documents.createDocument", "Nuovo Documento");

        await LoadDocumentTypesAsync();

        if (_isEditMode && DocumentId.HasValue)
        {
            await LoadDocumentAsync(DocumentId.Value);
            
            // Auto-expand details if in edit mode or has notes
            if (!string.IsNullOrWhiteSpace(_model.Notes))
            {
                _detailsExpanded = true;
            }
        }
        else
        {
            _model.Date = DateTime.UtcNow;
            
            // Initialize status for new document
            _documentStatus = DocumentStatus.Draft;
            
            // Set DDT_VEND (Sales Delivery Note) as default document type
            var defaultDocType = _documentTypes.FirstOrDefault(dt => dt.Code == "DDT_VEND");
            if (defaultDocType != null)
            {
                _model.DocumentTypeId = defaultDocType.Id;
            }
        }
    }

    private async Task LoadDocumentTypesAsync()
    {
        try
        {
            var types = await DocumentTypeService.GetAllDocumentTypesAsync();
            _documentTypes = types?.ToList() ?? new List<DocumentTypeDto>();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading document types");
            Snackbar.Add(TranslationService.GetTranslation("documents.errorLoadingTypes", "Errore durante il caricamento dei tipi di documento"), Severity.Error);
        }
    }

    private async Task LoadDocumentAsync(Guid documentId)
    {
        _isLoading = true;
        try
        {
            Logger.LogInformation("Loading document {DocumentId} with includeRows=true", documentId);
            
            _currentDocument = await DocumentHeaderService.GetDocumentHeaderByIdAsync(documentId, includeRows: true);
            
            if (_currentDocument != null)
            {
                Logger.LogInformation("Document loaded successfully. Id={Id}, Status={Status}, RowsCount={RowsCount}", _currentDocument.Id, _currentDocument.Status, _currentDocument.Rows?.Count ?? 0);
                
                _model.DocumentTypeId = _currentDocument.DocumentTypeId;
                _model.Series = _currentDocument.Series;
                _model.Number = _currentDocument.Number;
                _model.Date = _currentDocument.Date;
                _model.BusinessPartyId = _currentDocument.BusinessPartyId;
                _model.Notes = _currentDocument.Notes;
                _documentDate = _currentDocument.Date.ToLocalTime();
                
                // Initialize document status
                _documentStatus = _currentDocument.Status;
                
                // Load the business party to populate the autocomplete
                if (_currentDocument.BusinessPartyId != Guid.Empty)
                {
                    _selectedBusinessParty = await BusinessPartyService.GetBusinessPartyAsync(_currentDocument.BusinessPartyId);
                    if (_selectedBusinessParty == null)
                    {
                        Logger.LogWarning("Business party with ID {BusinessPartyId} not found for document {DocumentId}", _currentDocument.BusinessPartyId, documentId);
                    }
                }
                
                // Recalculate totals if they are zero but rows exist
                if (_currentDocument.Rows?.Any() == true && HasZeroTotals(_currentDocument))
                {
                    Logger.LogInformation("Document {DocumentId} has rows but totals are zero. Recalculating...", documentId);
                    await RecalculateDocumentTotalsAsync();
                }
            }
            else
            {
                Logger.LogWarning("Document {DocumentId} not found or failed to load", documentId);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading document {DocumentId}", documentId);
            Snackbar.Add(TranslationService.GetTranslation("documents.errorLoading", "Errore durante il caricamento del documento"), Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task<IEnumerable<BusinessPartyDto>> SearchBusinessPartiesAsync(string searchTerm, CancellationToken cancellationToken)
    {
        if (string.IsNullOrWhiteSpace(searchTerm) || searchTerm.Length < 2)
            return Array.Empty<BusinessPartyDto>();

        try
        {
            // Get the selected document type to filter by required party type
            var selectedDocType = _documentTypes.FirstOrDefault(dt => dt.Id == _model.DocumentTypeId);
            
            // Use server-side search with type filter if applicable
            BusinessPartyType? partyTypeFilter = null;
            if (selectedDocType != null && selectedDocType.RequiredPartyType != BusinessPartyType.Both)
            {
                partyTypeFilter = selectedDocType.RequiredPartyType;
            }

            var result = await BusinessPartyService.SearchBusinessPartiesAsync(searchTerm, partyTypeFilter, pageSize: 50);
            return result;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error searching business parties");
            return Array.Empty<BusinessPartyDto>();
        }
    }

    private bool CanSaveHeader()
    {
        return _model.DocumentTypeId != Guid.Empty
               && _selectedBusinessParty != null
               && _documentDate.HasValue;
    }

    private decimal CalculateTotalAmount()
    {
        if (_currentDocument?.Rows == null || !_currentDocument.Rows.Any())
            return 0;
        
        return _currentDocument.Rows.Sum(row => row.Quantity * row.UnitPrice);
    }

    private async Task SaveDocumentHeaderAsync()
    {
        // Block modification if document is closed or cancelled
        if (_currentDocument != null && 
            (_currentDocument.Status == DocumentStatus.Closed || _currentDocument.Status == DocumentStatus.Cancelled))
        {
            Snackbar.Add(
                TranslationService.GetTranslation("documents.cannotEditClosed", "Impossibile modificare un documento chiuso o annullato"),
                Severity.Warning
            );
            return;
        }
        
        _isLoading = true;
        try
        {
            _model.BusinessPartyId = _selectedBusinessParty!.Id;
            _model.Date = _documentDate!.Value.ToUniversalTime();

            if (_isEditMode && DocumentId.HasValue)
            {
                var updateDto = new UpdateDocumentHeaderDto
                {
                    DocumentTypeId = _model.DocumentTypeId,
                    Series = _model.Series,
                    Number = _model.Number,
                    Date = _model.Date,
                    BusinessPartyId = _model.BusinessPartyId,
                    Notes = _model.Notes
                };
                var updated = await DocumentHeaderService.UpdateDocumentHeaderAsync(DocumentId.Value, updateDto);
                if (updated != null)
                {
                    _currentDocument = updated;
                    Snackbar.Add(TranslationService.GetTranslation("documents.updateSuccess", "Documento aggiornato con successo"), Severity.Success);
                }
            }
            else
            {
                var created = await DocumentHeaderService.CreateDocumentHeaderAsync(_model);
                if (created != null)
                {
                    _currentDocument = created;
                    Snackbar.Add(TranslationService.GetTranslation("documents.createSuccess", "Documento creato con successo"), Severity.Success);
                    NavigationManager.NavigateTo($"/documents/edit/{created.Id}");
                }
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error saving document header");
            Snackbar.Add(TranslationService.GetTranslation("documents.saveError", "Errore durante il salvataggio del documento"), Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    /// <summary>
    /// Called when the user changes the document status from the selector
    /// </summary>
    private async Task OnStatusChanged(DocumentStatus newStatus)
    {
        if (_currentDocument == null || !_isEditMode) return;
        
        try
        {
            _isLoading = true;
            
            var previousStatus = _currentDocument.Status;
            
            // If the status is "Closed", call the dedicated endpoint
            if (newStatus == DocumentStatus.Closed && previousStatus != DocumentStatus.Closed)
            {
                var closed = await DocumentHeaderService.CloseDocumentAsync(_currentDocument.Id);
                if (closed != null)
                {
                    _currentDocument = closed;
                    _documentStatus = closed.Status;
                    
                    Snackbar.Add(
                        TranslationService.GetTranslation("documents.statusClosedSuccess", "Documento chiuso con successo"),
                        Severity.Success
                    );
                    
                    Logger.LogInformation("Document {DocumentId} closed successfully", _currentDocument.Id);
                }
                else
                {
                    // Rollback if close failed
                    _documentStatus = previousStatus;
                    Snackbar.Add(
                        TranslationService.GetTranslation("documents.statusUpdateError", "Errore nell'aggiornamento dello stato"),
                        Severity.Error
                    );
                }
            }
            else
            {
                // For other states, update the Status field in the document
                // Note: This requires a backend endpoint to update only the status
                // For now, update locally and it will be saved with the next SaveDocumentHeaderAsync
                _currentDocument.Status = newStatus;
                _documentStatus = newStatus;
                
                Snackbar.Add(
                    TranslationService.GetTranslation("documents.statusUpdated", "Stato documento aggiornato"),
                    Severity.Info
                );
                
                Logger.LogInformation("Document {DocumentId} status changed to {Status}", _currentDocument.Id, newStatus);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error updating document status for document {DocumentId}", _currentDocument?.Id);
            
            // Rollback on error
            if (_currentDocument != null)
            {
                _documentStatus = _currentDocument.Status;
            }
            
            Snackbar.Add(
                TranslationService.GetTranslation("documents.statusUpdateError", "Errore nell'aggiornamento dello stato"),
                Severity.Error
            );
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private async Task AddRowAsync()
    {
        // Block if document is closed or cancelled
        if (_currentDocument?.Status == DocumentStatus.Closed || _currentDocument?.Status == DocumentStatus.Cancelled)
        {
            Snackbar.Add(
                TranslationService.GetTranslation("documents.cannotModifyRows", "Impossibile modificare righe di un documento chiuso"),
                Severity.Warning
            );
            return;
        }
        
        var parameters = new DialogParameters
        {
            { "DocumentHeaderId", _currentDocument!.Id }
        };

        var options = new DialogOptions 
        { 
            MaxWidth = MaxWidth.Medium, 
            FullWidth = true,
            CloseButton = true
        };

        var dialog = await DialogService.ShowAsync<AddDocumentRowDialog>(
            TranslationService.GetTranslation("documents.addRow", "Aggiungi Riga"),
            parameters,
            options);

        var result = await dialog.Result;
        // Always reload the document when the dialog closes, regardless of how it was closed
        // This ensures we show any rows that were added during the dialog session
        await LoadDocumentAsync(_currentDocument.Id);
        
        // Recalculate document totals after adding row
        await RecalculateDocumentTotalsAsync();
    }


    private async Task EditRow(DocumentRowDto row)
    {
        // Block if document is closed or cancelled
        if (_currentDocument?.Status == DocumentStatus.Closed || _currentDocument?.Status == DocumentStatus.Cancelled)
        {
            Snackbar.Add(
                TranslationService.GetTranslation("documents.cannotModifyRows", "Impossibile modificare righe di un documento chiuso"),
                Severity.Warning
            );
            return;
        }
        
        var parameters = new DialogParameters
        {
            { "DocumentHeaderId", _currentDocument!.Id },
            { "RowId", row.Id }
        };

        var options = new DialogOptions 
        { 
            MaxWidth = MaxWidth.Medium, 
            FullWidth = true,
            CloseButton = true
        };

        var dialog = await DialogService.ShowAsync<AddDocumentRowDialog>(
            TranslationService.GetTranslation("documents.editRow", "Modifica Riga"),
            parameters,
            options);

        var result = await dialog.Result;
        // Always reload the document when the dialog closes
        await LoadDocumentAsync(_currentDocument.Id);
        
        // Recalculate document totals after editing row
        await RecalculateDocumentTotalsAsync();
    }

    private async Task DeleteRow(DocumentRowDto row)
    {
        // Block if document is closed or cancelled
        if (_currentDocument?.Status == DocumentStatus.Closed || _currentDocument?.Status == DocumentStatus.Cancelled)
        {
            Snackbar.Add(
                TranslationService.GetTranslation("documents.cannotModifyRows", "Impossibile modificare righe di un documento chiuso"),
                Severity.Warning
            );
            return;
        }
        
        bool? confirmed = await DialogService.ShowMessageBox(
            TranslationService.GetTranslation("documents.confirmDeleteRow", "Conferma Eliminazione"),
            TranslationService.GetTranslation("documents.confirmDeleteRowMessage", "Sei sicuro di voler eliminare questa riga?"),
            yesText: TranslationService.GetTranslation("common.yes", "Sì"),
            noText: TranslationService.GetTranslation("common.no", "No"));

        if (confirmed == true)
        {
            _isLoading = true;
            try
            {
                bool success = await DocumentHeaderService.DeleteDocumentRowAsync(row.Id);
                if (success)
                {
                    Snackbar.Add(TranslationService.GetTranslation("documents.deleteRowSuccess", "Riga eliminata con successo"), Severity.Success);
                    await LoadDocumentAsync(_currentDocument!.Id);
                    
                    // Recalculate document totals after deleting row
                    await RecalculateDocumentTotalsAsync();
                }
                else
                {
                    Snackbar.Add(TranslationService.GetTranslation("documents.deleteRowError", "Errore durante l'eliminazione della riga"), Severity.Error);
                }
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Error deleting document row");
                Snackbar.Add(TranslationService.GetTranslation("documents.deleteRowError", "Errore durante l'eliminazione della riga"), Severity.Error);
            }
            finally
            {
                _isLoading = false;
            }
        }
    }

    private async Task DeleteSelectedRowsAsync()
    {
        if (_selectedRows.Count == 0)
            return;

        // Block if document is closed or cancelled
        if (_currentDocument?.Status == DocumentStatus.Closed || _currentDocument?.Status == DocumentStatus.Cancelled)
        {
            Snackbar.Add(
                TranslationService.GetTranslation("documents.cannotModifyRows", "Impossibile modificare righe di un documento chiuso"),
                Severity.Warning
            );
            return;
        }

        bool? confirmed = await DialogService.ShowMessageBox(
            TranslationService.GetTranslation("documents.confirmDeleteRows", "Conferma Eliminazione"),
            TranslationService.GetTranslationFormatted("documents.confirmDeleteRowsMessage", "Sei sicuro di voler eliminare {0} righe?", _selectedRows.Count),
            yesText: TranslationService.GetTranslation("common.yes", "Sì"),
            noText: TranslationService.GetTranslation("common.no", "No"));

        if (confirmed == true)
        {
            _isLoading = true;
            try
            {
                int successCount = 0;
                foreach (var row in _selectedRows.ToList())
                {
                    bool success = await DocumentHeaderService.DeleteDocumentRowAsync(row.Id);
                    if (success)
                        successCount++;
                }

                if (successCount > 0)
                {
                    Snackbar.Add(TranslationService.GetTranslationFormatted("documents.deleteRowsSuccess", "{0} righe eliminate con successo", successCount), Severity.Success);
                    _selectedRows.Clear();
                    await LoadDocumentAsync(_currentDocument!.Id);
                    
                    // Recalculate document totals after deleting rows
                    await RecalculateDocumentTotalsAsync();
                }
                else
                {
                    Snackbar.Add(TranslationService.GetTranslation("documents.deleteRowsError", "Errore durante l'eliminazione delle righe"), Severity.Error);
                }
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Error deleting document rows");
                Snackbar.Add(TranslationService.GetTranslation("documents.deleteRowsError", "Errore durante l'eliminazione delle righe"), Severity.Error);
            }
            finally
            {
                _isLoading = false;
            }
        }
    }

    private bool CanMergeSelectedRows()
    {
        if (_selectedRows.Count < 2)
            return false;

        // Check if all selected rows have the same ProductId and it's not null
        var firstProductId = _selectedRows.First().ProductId;
        if (!firstProductId.HasValue)
            return false;

        // All rows must have the same ProductId
        if (!_selectedRows.All(r => r.ProductId == firstProductId))
            return false;

        // All rows must have the same UnitOfMeasure
        var firstUoM = _selectedRows.First().UnitOfMeasure;
        if (!_selectedRows.All(r => r.UnitOfMeasure == firstUoM))
            return false;

        return true;
    }

    private async Task MergeSelectedRowsAsync()
    {
        if (!CanMergeSelectedRows())
        {
            Snackbar.Add(TranslationService.GetTranslation("documents.cannotMergeRows", "Impossibile unire le righe selezionate. Assicurati che abbiano lo stesso prodotto e unità di misura."), Severity.Warning);
            return;
        }

        // Block if document is closed or cancelled
        if (_currentDocument?.Status == DocumentStatus.Closed || _currentDocument?.Status == DocumentStatus.Cancelled)
        {
            Snackbar.Add(
                TranslationService.GetTranslation("documents.cannotModifyRows", "Impossibile modificare righe di un documento chiuso"),
                Severity.Warning
            );
            return;
        }

        var rowsToMerge = _selectedRows.OrderBy(r => r.CreatedAt).ToList();
        var mainRow = rowsToMerge.First();

        // Create confirmation message showing what will be merged
        var confirmMessage = $"{TranslationService.GetTranslation("documents.mergeRowsConfirmMessage", "Verranno unite {0} righe del prodotto {1}:", rowsToMerge.Count, mainRow.Description)}\n\n";
        confirmMessage += string.Join("\n", rowsToMerge.Select(r => $"- {r.Quantity} x {r.UnitPrice:C2} = {(r.Quantity * r.UnitPrice):C2}"));
        confirmMessage += $"\n\n{TranslationService.GetTranslation("documents.mergeRowsResult", "Risultato: Quantità totale = {0}", rowsToMerge.Sum(r => r.Quantity))}";

        bool? confirmed = await DialogService.ShowMessageBox(
            TranslationService.GetTranslation("documents.confirmMergeRows", "Conferma Unione Righe"),
            confirmMessage,
            yesText: TranslationService.GetTranslation("common.yes", "Sì"),
            noText: TranslationService.GetTranslation("common.no", "No"));

        if (confirmed == true)
        {
            _isLoading = true;
            try
            {
                // Calculate merged values
                decimal totalQuantity = rowsToMerge.Sum(r => r.Quantity);
                decimal maxPrice = rowsToMerge.Max(r => r.UnitPrice);
                var mergedNotes = string.Join(" | ", rowsToMerge.Where(r => !string.IsNullOrWhiteSpace(r.Notes)).Select(r => r.Notes));

                // Update the main row
                var updateDto = new UpdateDocumentRowDto
                {
                    RowType = mainRow.RowType,
                    ParentRowId = mainRow.ParentRowId,
                    ProductCode = mainRow.ProductCode,
                    Description = mainRow.Description,
                    UnitOfMeasure = mainRow.UnitOfMeasure,
                    UnitOfMeasureId = mainRow.UnitOfMeasureId,
                    UnitPrice = maxPrice,
                    Quantity = totalQuantity,
                    LineDiscount = mainRow.LineDiscount,
                    VatRate = mainRow.VatRate,
                    VatDescription = mainRow.VatDescription,
                    IsGift = mainRow.IsGift,
                    IsManual = mainRow.IsManual,
                    SourceWarehouseId = mainRow.SourceWarehouseId,
                    DestinationWarehouseId = mainRow.DestinationWarehouseId,
                    Notes = string.IsNullOrWhiteSpace(mergedNotes) ? null : mergedNotes,
                    SortOrder = mainRow.SortOrder,
                    StationId = mainRow.StationId
                };

                var updated = await DocumentHeaderService.UpdateDocumentRowAsync(mainRow.Id, updateDto);
                if (updated != null)
                {
                    // Delete the other rows
                    int deletedCount = 0;
                    foreach (var row in rowsToMerge.Skip(1))
                    {
                        bool success = await DocumentHeaderService.DeleteDocumentRowAsync(row.Id);
                        if (success)
                            deletedCount++;
                    }

                    Snackbar.Add(TranslationService.GetTranslation("documents.mergeRowsSuccess", "Righe unite con successo"), Severity.Success);
                    _selectedRows.Clear();
                    await LoadDocumentAsync(_currentDocument!.Id);
                    
                    // Recalculate document totals after merging rows
                    await RecalculateDocumentTotalsAsync();
                }
                else
                {
                    Snackbar.Add(TranslationService.GetTranslation("documents.mergeRowsError", "Errore durante l'unione delle righe"), Severity.Error);
                }
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Error merging document rows");
                Snackbar.Add(TranslationService.GetTranslation("documents.mergeRowsError", "Errore durante l'unione delle righe"), Severity.Error);
            }
            finally
            {
                _isLoading = false;
            }
        }
    }

    /// <summary>
    /// Checks if the document has zero totals.
    /// </summary>
    private static bool HasZeroTotals(DocumentHeaderDto document)
    {
        return document.TotalNetAmount == 0m && 
               document.VatAmount == 0m && 
               document.TotalGrossAmount == 0m;
    }

    /// <summary>
    /// Recalculates document totals by calling the backend API.
    /// Updates the current document with the latest calculated values.
    /// </summary>
    private async Task RecalculateDocumentTotalsAsync()
    {
        if (_currentDocument?.Id == Guid.Empty || _currentDocument == null)
        {
            Logger.LogWarning("Cannot recalculate totals: document is null or ID is empty");
            return;
        }

        try
        {
            var updated = await DocumentHeaderService.CalculateDocumentTotalsAsync(_currentDocument.Id);

            if (updated != null)
            {
                // Update totals in current document
                _currentDocument.TotalNetAmount = updated.TotalNetAmount;
                _currentDocument.VatAmount = updated.VatAmount;
                _currentDocument.TotalGrossAmount = updated.TotalGrossAmount;

                Logger.LogInformation("Recalculated document totals: Net={Net}, VAT={VAT}, Gross={Gross}",
                    updated.TotalNetAmount, updated.VatAmount, updated.TotalGrossAmount);

                // Force UI refresh
                StateHasChanged();
            }
            else
            {
                Logger.LogWarning("Calculate totals returned null for document {DocumentId}", _currentDocument.Id);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error recalculating document totals for document {DocumentId}", _currentDocument.Id);
            // Don't throw - allow the operation to complete even if totals calc fails
            Snackbar.Add(
                TranslationService.GetTranslation("documents.totalsCalculationError", "Errore nel calcolo dei totali"),
                Severity.Warning
            );
        }
    }
    
    private IEnumerable<DocumentRowDto>? FilterRows()
    {
        if (_currentDocument?.Rows == null)
            return null;
            
        if (string.IsNullOrWhiteSpace(_searchQuery))
            return _currentDocument.Rows;
            
        return _currentDocument.Rows.Where(row =>
            (!string.IsNullOrEmpty(row.ProductCode) && 
             row.ProductCode.Contains(_searchQuery, StringComparison.OrdinalIgnoreCase)) ||
            (!string.IsNullOrEmpty(row.Description) && 
             row.Description.Contains(_searchQuery, StringComparison.OrdinalIgnoreCase))
        );
    }
    
    private string GetSearchHelperText()
    {
        if (string.IsNullOrWhiteSpace(_searchQuery))
            return TranslationService.GetTranslation("documents.searchHelp", "Digita per filtrare le righe");
        
        var total = _currentDocument?.Rows?.Count() ?? 0;
        if (total == 0)
            return TranslationService.GetTranslation("documents.searchHelp", "Digita per filtrare le righe");
        
        // Materialize the filtered collection to avoid multiple enumerations
        var filtered = _filteredRows?.ToList();
        var count = filtered?.Count ?? 0;
        
        return count == total 
            ? TranslationService.GetTranslationFormatted("documents.showingAllRows", "Visualizzate tutte le {0} righe", total)
            : TranslationService.GetTranslationFormatted("documents.showingFilteredRows", "Visualizzate {0} di {1} righe", count, total);
    }
}
