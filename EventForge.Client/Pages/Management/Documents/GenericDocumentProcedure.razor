@page "/documents/create"
@page "/documents/edit/{DocumentId:guid}"
@using Microsoft.AspNetCore.Authorization
@using EventForge.DTOs.Common
@using EventForge.DTOs.Documents
@using EventForge.DTOs.Business
@using EventForge.DTOs.Products
@using EventForge.Client.Shared.Components.Dialogs.Documents
@using EventForge.Client.Shared.Documents
@attribute [Authorize(Roles = "SuperAdmin,Admin,Manager,Operator")]
@inject IDocumentHeaderService DocumentHeaderService
@inject IDocumentTypeService DocumentTypeService
@inject IBusinessPartyService BusinessPartyService
@inject IProductService ProductService
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject ITranslationService TranslationService
@inject ILogger<GenericDocumentProcedure> Logger
@inject NavigationManager NavigationManager

<PageTitle>@_pageTitle</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudGrid Class="mb-4">
        <MudItem xs="12" md="8">
            <MudText Typo="Typo.h4">
                <MudIcon Icon="@Icons.Material.Outlined.Description" Class="mr-2" Size="Size.Medium" />
                @_pageTitle
            </MudText>
        </MudItem>
        <MudItem xs="12" md="4">
            <MudStack Row="true" Justify="Justify.FlexEnd">
                <MudButton StartIcon="@Icons.Material.Outlined.ArrowBack"
                           Color="Color.Default"
                           Variant="Variant.Outlined"
                           OnClick="@(() => NavigationManager.NavigateTo("/documents/list"))">
                    @TranslationService.GetTranslation("common.back", "Indietro")
                </MudButton>
            </MudStack>
        </MudItem>
    </MudGrid>

    <PageLoadingOverlay Visible="_isLoading"
                        Message="@(_isLoading ? TranslationService.GetTranslation("messages.loadingPage", "Caricamento pagina...") : TranslationService.GetTranslation("common.loading", "Caricamento..."))" />

    <!-- Document Header Section -->
    <MudPaper Elevation="2" Class="pa-4 mb-4">
        <MudText Typo="Typo.h6" Class="mb-3">
            <MudIcon Icon="@Icons.Material.Outlined.Description" Class="mr-2" />
            @TranslationService.GetTranslation("documents.headerInfo", "Informazioni Documento")
        </MudText>
        <MudStack Spacing="3">
            <MudSelect T="Guid" Label="@TranslationService.GetTranslation("documents.documentType", "Tipo Documento")" 
                       Variant="Variant.Outlined"
                       @bind-Value="_model.DocumentTypeId" Required="true" Disabled="@_isEditMode"
                       Adornment="Adornment.Start"
                       AdornmentIcon="@Icons.Material.Outlined.Category">
                @if (_documentTypes != null)
                {
                    @foreach (var type in _documentTypes)
                    {
                        <MudSelectItem T="Guid" Value="@type.Id">@type.Name</MudSelectItem>
                    }
                }
            </MudSelect>
            
            <MudTextField T="string" Label="@TranslationService.GetTranslation("documents.series", "Serie")" 
                          Variant="Variant.Outlined"
                          @bind-Value="_model.Series"
                          Adornment="Adornment.Start"
                          AdornmentIcon="@Icons.Material.Outlined.Tag" />
            
            <MudTextField T="string" 
                         Variant="Variant.Outlined"
                         Label="@TranslationService.GetTranslation("documents.number", "Numero")" 
                         @bind-Value="_model.Number" 
                         Required="false"
                         Placeholder="@TranslationService.GetTranslation("documents.autoGenerated", "Auto-generato")"
                         HelperText="@TranslationService.GetTranslation("documents.numberHelperText", "Lascia vuoto per generazione automatica")"
                         Adornment="Adornment.Start"
                         AdornmentIcon="@Icons.Material.Outlined.Numbers" />
            
            <MudDatePicker Label="@TranslationService.GetTranslation("documents.date", "Data")" 
                           Variant="Variant.Outlined"
                           @bind-Date="_documentDate" Required="true"
                           Adornment="Adornment.Start"
                           AdornmentIcon="@Icons.Material.Outlined.CalendarToday" />
            
            <MudAutocomplete T="BusinessPartyDto"
                             Variant="Variant.Outlined"
                             Label="@TranslationService.GetTranslation("documents.businessParty", "Controparte")"
                             @bind-Value="_selectedBusinessParty"
                             SearchFunc="@SearchBusinessPartiesAsync"
                             ToStringFunc="@(bp => bp?.Name ?? string.Empty)"
                             Required="true"
                             ShowProgressIndicator="true"
                             Adornment="Adornment.Start"
                             AdornmentIcon="@Icons.Material.Outlined.Business">
                <ItemTemplate Context="bp">
                    <MudText>@bp.Name</MudText>
                    @if (!string.IsNullOrEmpty(bp.TaxCode))
                    {
                        <MudText Typo="Typo.caption">@bp.TaxCode</MudText>
                    }
                </ItemTemplate>
            </MudAutocomplete>
            
            <MudTextField T="string" Label="@TranslationService.GetTranslation("documents.notes", "Note")" 
                          Variant="Variant.Outlined"
                          @bind-Value="_model.Notes" Lines="3"
                          Adornment="Adornment.Start"
                          AdornmentIcon="@Icons.Material.Outlined.Comment" />
            
            <MudButton StartIcon="@Icons.Material.Outlined.Save"
                       Color="Color.Primary"
                       Variant="Variant.Filled"
                       OnClick="@SaveDocumentHeaderAsync"
                       Disabled="@(!CanSaveHeader())">
                @TranslationService.GetTranslation("common.save", "Salva")
            </MudButton>
        </MudStack>
    </MudPaper>

    <!-- Document Rows Section with VAT/Totals Panel -->
    <MudGrid Class="mt-4">
        <!-- Left column: Document Rows Table -->
        <MudItem xs="12" lg="8">
            <MudPaper Elevation="2" Class="pa-4">
                <MudText Typo="Typo.h6" Class="mb-3">
                    <MudIcon Icon="@Icons.Material.Outlined.List" Class="mr-2" />
                    @TranslationService.GetTranslation("documents.rows", "Righe Documento")
                </MudText>

                @if (_currentDocument == null)
                {
                    <!-- Documento non ancora salvato -->
                    <MudAlert Severity="Severity.Info" Class="mb-4" Icon="@Icons.Material.Outlined.Info">
                        <MudStack Spacing="2">
                            <MudText>
                                <strong>@TranslationService.GetTranslation("documents.saveFirstTitle", "Salva prima il documento")</strong>
                            </MudText>
                            <MudText Typo="Typo.body2">
                                @TranslationService.GetTranslation("documents.saveFirstMessage", "Per poter aggiungere righe al documento, è necessario salvarlo prima compilando i campi della testata (Tipo Documento, Cliente, Data) e cliccando su 'Salva'.")
                            </MudText>
                        </MudStack>
                    </MudAlert>
                }
                else
                {
                    <!-- Documento salvato - mostra sempre la toolbar con il pulsante Aggiungi Riga -->
                    <ManagementTableToolbar ShowSelectionBadge="@HasRows"
                                            SelectedCount="@_selectedRows.Count"
                                            ShowRefresh="false"
                                            ShowCreate="true"
                                            ShowDelete="@(HasRows && _selectedRows.Count > 0)"
                                            CreateLabel="documents.addRow"
                                            CreateTooltip="documents.addRowTooltip"
                                            IsDisabled="_isLoading"
                                            OnCreate="@AddRowAsync"
                                            OnDelete="@DeleteSelectedRowsAsync">
                        <AdditionalActions>
                            @if (_selectedRows.Count >= 2 && CanMergeSelectedRows())
                            {
                                <MudButton Variant="Variant.Text"
                                           Color="Color.Primary"
                                           StartIcon="@Icons.Material.Outlined.MergeType"
                                           OnClick="@MergeSelectedRowsAsync"
                                           Disabled="@_isLoading"
                                           Size="Size.Small">
                                    @TranslationService.GetTranslation("documents.mergeRows", "Unisci Righe")
                                </MudButton>
                            }
                        </AdditionalActions>
                    </ManagementTableToolbar>
                    
                    @if (HasRows)
                    {
                        <!-- Mostra la tabella delle righe con EFTable -->
                        <EFTable TItem="DocumentRowDto"
                                 Items="@_currentDocument.Rows"
                                 Title=""
                                 ComponentKey="GenericDocumentRows"
                                 ShowColumnConfiguration="true"
                                 AllowDragDropGrouping="true"
                                 ShowSearch="false"
                                 ShowExport="true"
                                 ExportFormats="@(new List<string> { "Excel", "CSV" })"
                                 ExcelFileName="DocumentRows"
                                 EnableExcelExport="true"
                                 ShowInternalPager="false"
                                 Dense="true"
                                 Hover="true"
                                 Striped="true"
                                 InitialColumnConfigurations="@_documentRowColumns">
                            <HeaderContent Context="columnConfigurations">
                                @foreach (var col in columnConfigurations.Where(c => c.IsVisible).OrderBy(c => c.Order))
                                {
                                    <MudTh Style="@GetHeaderStyle(col.PropertyName)">
                                        <MudTableSortLabel T="DocumentRowDto" 
                                                          SortBy="@(GetSortFunc(col.PropertyName))">
                                            @col.DisplayName
                                        </MudTableSortLabel>
                                    </MudTh>
                                }
                                <MudTh Style="text-align: right; white-space: nowrap;">
                                    @TranslationService.GetTranslation("common.actions", "Azioni")
                                </MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                @{
                                    var row = context;
                                    var grossTotal = row.LineTotal + row.VatTotal;
                                }
                                
                                @if (IsColumnVisible("ProductCode"))
                                {
                                    <MudTd DataLabel="@GetColumnLabel("ProductCode")">
                                        <MudText Typo="Typo.body2">@row.ProductCode</MudText>
                                    </MudTd>
                                }
                                
                                @if (IsColumnVisible("Description"))
                                {
                                    <MudTd DataLabel="@GetColumnLabel("Description")">
                                        <MudText Typo="Typo.body2">@row.Description</MudText>
                                    </MudTd>
                                }
                                
                                @if (IsColumnVisible("Quantity"))
                                {
                                    <MudTd DataLabel="@GetColumnLabel("Quantity")" Style="text-align: right;">
                                        <MudText Typo="Typo.body2">@row.Quantity.ToString("N2")</MudText>
                                    </MudTd>
                                }
                                
                                @if (IsColumnVisible("UnitOfMeasure"))
                                {
                                    <MudTd DataLabel="@GetColumnLabel("UnitOfMeasure")" Style="text-align: center;">
                                        <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined">
                                            @(row.UnitOfMeasure ?? "-")
                                        </MudChip>
                                    </MudTd>
                                }
                                
                                @if (IsColumnVisible("UnitPrice"))
                                {
                                    <MudTd DataLabel="@GetColumnLabel("UnitPrice")" Style="text-align: right;">
                                        <MudText Typo="Typo.body2">@row.UnitPrice.ToString("C2")</MudText>
                                    </MudTd>
                                }
                                
                                @if (IsColumnVisible("VatRate"))
                                {
                                    <MudTd DataLabel="@GetColumnLabel("VatRate")" Style="text-align: center;">
                                        <MudChip T="string" 
                                                 Size="Size.Small" 
                                                 Color="Color.Info"
                                                 Icon="@Icons.Material.Outlined.Percent">
                                            @row.VatRate.ToString("N0")%
                                        </MudChip>
                                    </MudTd>
                                }
                                
                                @if (IsColumnVisible("DiscountTotal"))
                                {
                                    <MudTd DataLabel="@GetColumnLabel("DiscountTotal")" Style="text-align: right;">
                                        @if (row.DiscountTotal > 0)
                                        {
                                            <MudText Typo="Typo.body2" Color="Color.Success">
                                                -@row.DiscountTotal.ToString("C2")
                                            </MudText>
                                        }
                                        else
                                        {
                                            <MudText Typo="Typo.body2" Style="color: var(--mud-palette-text-disabled);">
                                                —
                                            </MudText>
                                        }
                                    </MudTd>
                                }
                                
                                @if (IsColumnVisible("LineTotal"))
                                {
                                    <MudTd DataLabel="@GetColumnLabel("LineTotal")" Style="text-align: right;">
                                        <MudText Typo="Typo.body2" Style="font-weight: 500;">
                                            @row.LineTotal.ToString("C2")
                                        </MudText>
                                    </MudTd>
                                }
                                
                                @if (IsColumnVisible("VatTotal"))
                                {
                                    <MudTd DataLabel="@GetColumnLabel("VatTotal")" Style="text-align: right;">
                                        <MudText Typo="Typo.body2" Color="Color.Info">
                                            @row.VatTotal.ToString("C2")
                                        </MudText>
                                    </MudTd>
                                }
                                
                                @if (IsColumnVisible("GrossTotal"))
                                {
                                    <MudTd DataLabel="@GetColumnLabel("GrossTotal")" Style="text-align: right;">
                                        <MudText Typo="Typo.h6" Color="Color.Primary" Style="font-weight: 600;">
                                            @grossTotal.ToString("C2")
                                        </MudText>
                                    </MudTd>
                                }
                                
                                @if (IsColumnVisible("VatDescription"))
                                {
                                    <MudTd DataLabel="@GetColumnLabel("VatDescription")">
                                        <MudText Typo="Typo.caption">@row.VatDescription</MudText>
                                    </MudTd>
                                }
                                
                                @if (IsColumnVisible("LineDiscount"))
                                {
                                    <MudTd DataLabel="@GetColumnLabel("LineDiscount")" Style="text-align: right;">
                                        @if (row.LineDiscount > 0)
                                        {
                                            <MudText Typo="Typo.body2">@row.LineDiscount.ToString("N2")%</MudText>
                                        }
                                        else
                                        {
                                            <MudText Typo="Typo.body2" Style="color: var(--mud-palette-text-disabled);">—</MudText>
                                        }
                                    </MudTd>
                                }
                                
                                @if (IsColumnVisible("LineDiscountValue"))
                                {
                                    <MudTd DataLabel="@GetColumnLabel("LineDiscountValue")" Style="text-align: right;">
                                        @if (row.LineDiscountValue > 0)
                                        {
                                            <MudText Typo="Typo.body2">@row.LineDiscountValue.ToString("C2")</MudText>
                                        }
                                        else
                                        {
                                            <MudText Typo="Typo.body2" Style="color: var(--mud-palette-text-disabled);">—</MudText>
                                        }
                                    </MudTd>
                                }
                                
                                <MudTd DataLabel="@TranslationService.GetTranslation("common.actions", "Azioni")" Style="text-align: right; white-space: nowrap;">
                                    <MudTooltip Text="@TranslationService.GetTranslation("common.edit", "Modifica")">
                                        <MudIconButton Icon="@Icons.Material.Outlined.Edit" 
                                                      Size="Size.Small" 
                                                      Color="Color.Primary"
                                                      OnClick="@(() => EditRow(row))" />
                                    </MudTooltip>
                                    <MudTooltip Text="@TranslationService.GetTranslation("common.delete", "Elimina")">
                                        <MudIconButton Icon="@Icons.Material.Outlined.Delete" 
                                                      Size="Size.Small" 
                                                      Color="Color.Error"
                                                      OnClick="@(() => DeleteRow(row))" />
                                    </MudTooltip>
                                </MudTd>
                            </RowTemplate>
                            <NoRecordsContent>
                                <MudText>@TranslationService.GetTranslation("documents.noRows", "Nessuna riga presente")</MudText>
                            </NoRecordsContent>
                        </EFTable>

                        <MudDivider Class="my-4" />
                        <MudStack Row="true" Justify="Justify.FlexEnd" Class="mt-4">
                            <MudText Typo="Typo.h6">
                                @TranslationService.GetTranslation("documents.totalAmount", "Totale"): @CalculateTotalAmount().ToString("C2")
                            </MudText>
                        </MudStack>
                    }
                    else
                    {
                        <!-- Mostra messaggio informativo -->
                        <MudAlert Severity="Severity.Info" Class="mb-4">
                            <MudText>
                                @TranslationService.GetTranslation("documents.noRows", "Nessuna riga presente. Clicca 'Aggiungi Riga' per iniziare.")
                            </MudText>
                        </MudAlert>
                    }
                }
            </MudPaper>
        </MudItem>

        <!-- Right column: VAT Summary and Totals -->
        <MudItem xs="12" lg="4">
            <MudStack Spacing="3">
                <DocumentVatSummary Rows="@_currentDocument?.Rows" />
                <DocumentTotalsCard Document="@_currentDocument" />
            </MudStack>
        </MudItem>
    </MudGrid>

    @if (_currentDocument != null)
    {
        <!-- Actions -->
        <MudStack Row="true" Class="mt-4" Justify="Justify.FlexEnd">
            @if (_currentDocument.Status == DocumentStatus.Draft)
            {
                <MudButton StartIcon="@Icons.Material.Outlined.Check"
                           Color="Color.Success"
                           Variant="Variant.Filled"
                           OnClick="@ApproveDocumentAsync"
                           Disabled="@(_currentDocument.Rows == null || !_currentDocument.Rows.Any())">
                    @TranslationService.GetTranslation("documents.approve", "Approva")
                </MudButton>
            }
            <MudButton StartIcon="@Icons.Material.Outlined.Close"
                       Color="Color.Default"
                       Variant="Variant.Outlined"
                       OnClick="@(() => NavigationManager.NavigateTo("/documents/list"))">
                @TranslationService.GetTranslation("common.close", "Chiudi")
            </MudButton>
        </MudStack>
    }
</MudContainer>

@code {
    [Parameter] public Guid? DocumentId { get; set; }

    private bool _isLoading = false;
    private bool _isEditMode => DocumentId.HasValue;
    private string _pageTitle = "";
    private CreateDocumentHeaderDto _model = new();
    private DocumentHeaderDto? _currentDocument = null;
    private DateTime? _documentDate = DateTime.Now;
    private List<DocumentTypeDto> _documentTypes = new();
    private BusinessPartyDto? _selectedBusinessParty = null;
    
    // Selection management for rows
    private HashSet<DocumentRowDto> _selectedRows = new();
    
    // Computed property for checking if document has rows
    private bool HasRows => _currentDocument?.Rows?.Any() ?? false;

    // Column configuration for EFTable
    private List<EFTableColumnConfiguration> _documentRowColumns = new()
    {
        // Colonne sempre visibili di default
        new() { PropertyName = "ProductCode", DisplayName = "Codice", IsVisible = true, Order = 0 },
        new() { PropertyName = "Description", DisplayName = "Descrizione", IsVisible = true, Order = 1 },
        new() { PropertyName = "Quantity", DisplayName = "Quantità", IsVisible = true, Order = 2 },
        new() { PropertyName = "UnitOfMeasure", DisplayName = "UM", IsVisible = true, Order = 3 },
        new() { PropertyName = "UnitPrice", DisplayName = "Prezzo Unit.", IsVisible = true, Order = 4 },
        new() { PropertyName = "VatRate", DisplayName = "IVA %", IsVisible = true, Order = 5 },
        new() { PropertyName = "DiscountTotal", DisplayName = "Sconto", IsVisible = true, Order = 6 },
        new() { PropertyName = "LineTotal", DisplayName = "Imponibile", IsVisible = true, Order = 7 },
        new() { PropertyName = "VatTotal", DisplayName = "Imposta", IsVisible = true, Order = 8 },
        new() { PropertyName = "GrossTotal", DisplayName = "Totale Lordo", IsVisible = true, Order = 9 },
        
        // Colonne opzionali (nascoste di default, utente può abilitarle)
        new() { PropertyName = "VatDescription", DisplayName = "Desc. IVA", IsVisible = false, Order = 10 },
        new() { PropertyName = "LineDiscount", DisplayName = "Sconto %", IsVisible = false, Order = 11 },
        new() { PropertyName = "LineDiscountValue", DisplayName = "Valore Sconto", IsVisible = false, Order = 12 },
    };

    // Helper per verificare visibilità colonna
    private bool IsColumnVisible(string propertyName)
    {
        return _documentRowColumns
            .FirstOrDefault(c => c.PropertyName == propertyName)?.IsVisible ?? false;
    }
    
    // Helper per ottenere label colonna (con traduzione)
    private string GetColumnLabel(string propertyName)
    {
        var column = _documentRowColumns.FirstOrDefault(c => c.PropertyName == propertyName);
        if (column == null) return propertyName;
        
        return TranslationService.GetTranslation($"documents.column.{propertyName.ToLower()}", column.DisplayName);
    }
    
    // Helper per stili header colonne
    private string GetHeaderStyle(string propertyName)
    {
        // Allinea a destra le colonne numeriche
        var numericColumns = new[] { "Quantity", "UnitPrice", "VatRate", "DiscountTotal", "LineTotal", "VatTotal", "GrossTotal", "LineDiscount", "LineDiscountValue" };
        
        if (numericColumns.Contains(propertyName))
            return "text-align: right; white-space: nowrap;";
        
        if (propertyName == "UnitOfMeasure")
            return "text-align: center; white-space: nowrap;";
        
        return "white-space: nowrap;";
    }
    
    // Funzioni di ordinamento per colonne
    private Func<DocumentRowDto, object> GetSortFunc(string propertyName)
    {
        return propertyName switch
        {
            "ProductCode" => x => x.ProductCode ?? string.Empty,
            "Description" => x => x.Description ?? string.Empty,
            "Quantity" => x => x.Quantity,
            "UnitOfMeasure" => x => x.UnitOfMeasure ?? string.Empty,
            "UnitPrice" => x => x.UnitPrice,
            "VatRate" => x => x.VatRate,
            "DiscountTotal" => x => x.DiscountTotal,
            "LineTotal" => x => x.LineTotal,
            "VatTotal" => x => x.VatTotal,
            "GrossTotal" => x => x.LineTotal + x.VatTotal,
            "VatDescription" => x => x.VatDescription ?? string.Empty,
            "LineDiscount" => x => x.LineDiscount,
            "LineDiscountValue" => x => x.LineDiscountValue,
            _ => x => x.Id
        };
    }

    protected override async Task OnInitializedAsync()
    {
        _pageTitle = _isEditMode
            ? TranslationService.GetTranslation("documents.editDocument", "Modifica Documento")
            : TranslationService.GetTranslation("documents.createDocument", "Nuovo Documento");

        await LoadDocumentTypesAsync();

        if (_isEditMode && DocumentId.HasValue)
        {
            await LoadDocumentAsync(DocumentId.Value);
        }
        else
        {
            _model.Date = DateTime.UtcNow;
            
            // Set DDT_VEND (Sales Delivery Note) as default document type
            var defaultDocType = _documentTypes.FirstOrDefault(dt => dt.Code == "DDT_VEND");
            if (defaultDocType != null)
            {
                _model.DocumentTypeId = defaultDocType.Id;
            }
        }
    }

    private async Task LoadDocumentTypesAsync()
    {
        try
        {
            var types = await DocumentTypeService.GetAllDocumentTypesAsync();
            _documentTypes = types?.ToList() ?? new List<DocumentTypeDto>();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading document types");
            Snackbar.Add(TranslationService.GetTranslation("documents.errorLoadingTypes", "Errore durante il caricamento dei tipi di documento"), Severity.Error);
        }
    }

    private async Task LoadDocumentAsync(Guid documentId)
    {
        _isLoading = true;
        try
        {
            Logger.LogInformation("Loading document {DocumentId} with includeRows=true", documentId);
            
            _currentDocument = await DocumentHeaderService.GetDocumentHeaderByIdAsync(documentId, includeRows: true);
            
            if (_currentDocument != null)
            {
                Logger.LogInformation("Document loaded successfully. Id={Id}, Status={Status}, RowsCount={RowsCount}", _currentDocument.Id, _currentDocument.Status, _currentDocument.Rows?.Count ?? 0);
                
                _model.DocumentTypeId = _currentDocument.DocumentTypeId;
                _model.Series = _currentDocument.Series;
                _model.Number = _currentDocument.Number;
                _model.Date = _currentDocument.Date;
                _model.BusinessPartyId = _currentDocument.BusinessPartyId;
                _model.Notes = _currentDocument.Notes;
                _documentDate = _currentDocument.Date.ToLocalTime();
                
                // Load the business party to populate the autocomplete
                if (_currentDocument.BusinessPartyId != Guid.Empty)
                {
                    _selectedBusinessParty = await BusinessPartyService.GetBusinessPartyAsync(_currentDocument.BusinessPartyId);
                    if (_selectedBusinessParty == null)
                    {
                        Logger.LogWarning("Business party with ID {BusinessPartyId} not found for document {DocumentId}", _currentDocument.BusinessPartyId, documentId);
                    }
                }
            }
            else
            {
                Logger.LogWarning("Document {DocumentId} not found or failed to load", documentId);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading document {DocumentId}", documentId);
            Snackbar.Add(TranslationService.GetTranslation("documents.errorLoading", "Errore durante il caricamento del documento"), Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task<IEnumerable<BusinessPartyDto>> SearchBusinessPartiesAsync(string searchTerm, CancellationToken cancellationToken)
    {
        if (string.IsNullOrWhiteSpace(searchTerm) || searchTerm.Length < 2)
            return Array.Empty<BusinessPartyDto>();

        try
        {
            // Get the selected document type to filter by required party type
            var selectedDocType = _documentTypes.FirstOrDefault(dt => dt.Id == _model.DocumentTypeId);
            
            // Use server-side search with type filter if applicable
            BusinessPartyType? partyTypeFilter = null;
            if (selectedDocType != null && selectedDocType.RequiredPartyType != BusinessPartyType.Both)
            {
                partyTypeFilter = selectedDocType.RequiredPartyType;
            }

            var result = await BusinessPartyService.SearchBusinessPartiesAsync(searchTerm, partyTypeFilter, pageSize: 50);
            return result;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error searching business parties");
            return Array.Empty<BusinessPartyDto>();
        }
    }

    private bool CanSaveHeader()
    {
        return _model.DocumentTypeId != Guid.Empty
               && _selectedBusinessParty != null
               && _documentDate.HasValue;
    }

    private decimal CalculateTotalAmount()
    {
        if (_currentDocument?.Rows == null || !_currentDocument.Rows.Any())
            return 0;
        
        return _currentDocument.Rows.Sum(row => row.Quantity * row.UnitPrice);
    }

    private async Task SaveDocumentHeaderAsync()
    {
        _isLoading = true;
        try
        {
            _model.BusinessPartyId = _selectedBusinessParty!.Id;
            _model.Date = _documentDate!.Value.ToUniversalTime();

            if (_isEditMode && DocumentId.HasValue)
            {
                var updateDto = new UpdateDocumentHeaderDto
                {
                    DocumentTypeId = _model.DocumentTypeId,
                    Series = _model.Series,
                    Number = _model.Number,
                    Date = _model.Date,
                    BusinessPartyId = _model.BusinessPartyId,
                    Notes = _model.Notes
                };
                var updated = await DocumentHeaderService.UpdateDocumentHeaderAsync(DocumentId.Value, updateDto);
                if (updated != null)
                {
                    _currentDocument = updated;
                    Snackbar.Add(TranslationService.GetTranslation("documents.updateSuccess", "Documento aggiornato con successo"), Severity.Success);
                }
            }
            else
            {
                var created = await DocumentHeaderService.CreateDocumentHeaderAsync(_model);
                if (created != null)
                {
                    _currentDocument = created;
                    Snackbar.Add(TranslationService.GetTranslation("documents.createSuccess", "Documento creato con successo"), Severity.Success);
                    NavigationManager.NavigateTo($"/documents/edit/{created.Id}");
                }
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error saving document header");
            Snackbar.Add(TranslationService.GetTranslation("documents.saveError", "Errore durante il salvataggio del documento"), Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task AddRowAsync()
    {
        var parameters = new DialogParameters
        {
            { "DocumentHeaderId", _currentDocument!.Id }
        };

        var options = new DialogOptions 
        { 
            MaxWidth = MaxWidth.Medium, 
            FullWidth = true,
            CloseButton = true
        };

        var dialog = await DialogService.ShowAsync<AddDocumentRowDialog>(
            TranslationService.GetTranslation("documents.addRow", "Aggiungi Riga"),
            parameters,
            options);

        var result = await dialog.Result;
        // Always reload the document when the dialog closes, regardless of how it was closed
        // This ensures we show any rows that were added during the dialog session
        await LoadDocumentAsync(_currentDocument.Id);
    }

    private async Task ApproveDocumentAsync()
    {
        _isLoading = true;
        try
        {
            var result = await DocumentHeaderService.ApproveDocumentAsync(_currentDocument!.Id);
            if (result != null)
            {
                _currentDocument = result;
                Snackbar.Add(TranslationService.GetTranslation("documents.approveSuccess", "Documento approvato con successo"), Severity.Success);
                NavigationManager.NavigateTo("/documents/list");
            }
            else
            {
                Snackbar.Add(TranslationService.GetTranslation("documents.approveError", "Errore durante l'approvazione del documento"), Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error approving document");
            Snackbar.Add(TranslationService.GetTranslation("documents.approveError", "Errore durante l'approvazione del documento"), Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task EditRow(DocumentRowDto row)
    {
        var parameters = new DialogParameters
        {
            { "DocumentHeaderId", _currentDocument!.Id },
            { "RowId", row.Id }
        };

        var options = new DialogOptions 
        { 
            MaxWidth = MaxWidth.Medium, 
            FullWidth = true,
            CloseButton = true
        };

        var dialog = await DialogService.ShowAsync<AddDocumentRowDialog>(
            TranslationService.GetTranslation("documents.editRow", "Modifica Riga"),
            parameters,
            options);

        var result = await dialog.Result;
        // Always reload the document when the dialog closes
        await LoadDocumentAsync(_currentDocument.Id);
    }

    private async Task DeleteRow(DocumentRowDto row)
    {
        bool? confirmed = await DialogService.ShowMessageBox(
            TranslationService.GetTranslation("documents.confirmDeleteRow", "Conferma Eliminazione"),
            TranslationService.GetTranslation("documents.confirmDeleteRowMessage", "Sei sicuro di voler eliminare questa riga?"),
            yesText: TranslationService.GetTranslation("common.yes", "Sì"),
            noText: TranslationService.GetTranslation("common.no", "No"));

        if (confirmed == true)
        {
            _isLoading = true;
            try
            {
                bool success = await DocumentHeaderService.DeleteDocumentRowAsync(row.Id);
                if (success)
                {
                    Snackbar.Add(TranslationService.GetTranslation("documents.deleteRowSuccess", "Riga eliminata con successo"), Severity.Success);
                    await LoadDocumentAsync(_currentDocument!.Id);
                }
                else
                {
                    Snackbar.Add(TranslationService.GetTranslation("documents.deleteRowError", "Errore durante l'eliminazione della riga"), Severity.Error);
                }
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Error deleting document row");
                Snackbar.Add(TranslationService.GetTranslation("documents.deleteRowError", "Errore durante l'eliminazione della riga"), Severity.Error);
            }
            finally
            {
                _isLoading = false;
            }
        }
    }

    private async Task DeleteSelectedRowsAsync()
    {
        if (_selectedRows.Count == 0)
            return;

        bool? confirmed = await DialogService.ShowMessageBox(
            TranslationService.GetTranslation("documents.confirmDeleteRows", "Conferma Eliminazione"),
            TranslationService.GetTranslationFormatted("documents.confirmDeleteRowsMessage", "Sei sicuro di voler eliminare {0} righe?", _selectedRows.Count),
            yesText: TranslationService.GetTranslation("common.yes", "Sì"),
            noText: TranslationService.GetTranslation("common.no", "No"));

        if (confirmed == true)
        {
            _isLoading = true;
            try
            {
                int successCount = 0;
                foreach (var row in _selectedRows.ToList())
                {
                    bool success = await DocumentHeaderService.DeleteDocumentRowAsync(row.Id);
                    if (success)
                        successCount++;
                }

                if (successCount > 0)
                {
                    Snackbar.Add(TranslationService.GetTranslationFormatted("documents.deleteRowsSuccess", "{0} righe eliminate con successo", successCount), Severity.Success);
                    _selectedRows.Clear();
                    await LoadDocumentAsync(_currentDocument!.Id);
                }
                else
                {
                    Snackbar.Add(TranslationService.GetTranslation("documents.deleteRowsError", "Errore durante l'eliminazione delle righe"), Severity.Error);
                }
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Error deleting document rows");
                Snackbar.Add(TranslationService.GetTranslation("documents.deleteRowsError", "Errore durante l'eliminazione delle righe"), Severity.Error);
            }
            finally
            {
                _isLoading = false;
            }
        }
    }

    private bool CanMergeSelectedRows()
    {
        if (_selectedRows.Count < 2)
            return false;

        // Check if all selected rows have the same ProductId and it's not null
        var firstProductId = _selectedRows.First().ProductId;
        if (!firstProductId.HasValue)
            return false;

        // All rows must have the same ProductId
        if (!_selectedRows.All(r => r.ProductId == firstProductId))
            return false;

        // All rows must have the same UnitOfMeasure
        var firstUoM = _selectedRows.First().UnitOfMeasure;
        if (!_selectedRows.All(r => r.UnitOfMeasure == firstUoM))
            return false;

        return true;
    }

    private async Task MergeSelectedRowsAsync()
    {
        if (!CanMergeSelectedRows())
        {
            Snackbar.Add(TranslationService.GetTranslation("documents.cannotMergeRows", "Impossibile unire le righe selezionate. Assicurati che abbiano lo stesso prodotto e unità di misura."), Severity.Warning);
            return;
        }

        var rowsToMerge = _selectedRows.OrderBy(r => r.CreatedAt).ToList();
        var mainRow = rowsToMerge.First();

        // Create confirmation message showing what will be merged
        var confirmMessage = $"{TranslationService.GetTranslation("documents.mergeRowsConfirmMessage", "Verranno unite {0} righe del prodotto {1}:", rowsToMerge.Count, mainRow.Description)}\n\n";
        confirmMessage += string.Join("\n", rowsToMerge.Select(r => $"- {r.Quantity} x {r.UnitPrice:C2} = {(r.Quantity * r.UnitPrice):C2}"));
        confirmMessage += $"\n\n{TranslationService.GetTranslation("documents.mergeRowsResult", "Risultato: Quantità totale = {0}", rowsToMerge.Sum(r => r.Quantity))}";

        bool? confirmed = await DialogService.ShowMessageBox(
            TranslationService.GetTranslation("documents.confirmMergeRows", "Conferma Unione Righe"),
            confirmMessage,
            yesText: TranslationService.GetTranslation("common.yes", "Sì"),
            noText: TranslationService.GetTranslation("common.no", "No"));

        if (confirmed == true)
        {
            _isLoading = true;
            try
            {
                // Calculate merged values
                decimal totalQuantity = rowsToMerge.Sum(r => r.Quantity);
                decimal maxPrice = rowsToMerge.Max(r => r.UnitPrice);
                var mergedNotes = string.Join(" | ", rowsToMerge.Where(r => !string.IsNullOrWhiteSpace(r.Notes)).Select(r => r.Notes));

                // Update the main row
                var updateDto = new UpdateDocumentRowDto
                {
                    RowType = mainRow.RowType,
                    ParentRowId = mainRow.ParentRowId,
                    ProductCode = mainRow.ProductCode,
                    Description = mainRow.Description,
                    UnitOfMeasure = mainRow.UnitOfMeasure,
                    UnitOfMeasureId = mainRow.UnitOfMeasureId,
                    UnitPrice = maxPrice,
                    Quantity = totalQuantity,
                    LineDiscount = mainRow.LineDiscount,
                    VatRate = mainRow.VatRate,
                    VatDescription = mainRow.VatDescription,
                    IsGift = mainRow.IsGift,
                    IsManual = mainRow.IsManual,
                    SourceWarehouseId = mainRow.SourceWarehouseId,
                    DestinationWarehouseId = mainRow.DestinationWarehouseId,
                    Notes = string.IsNullOrWhiteSpace(mergedNotes) ? null : mergedNotes,
                    SortOrder = mainRow.SortOrder,
                    StationId = mainRow.StationId
                };

                var updated = await DocumentHeaderService.UpdateDocumentRowAsync(mainRow.Id, updateDto);
                if (updated != null)
                {
                    // Delete the other rows
                    int deletedCount = 0;
                    foreach (var row in rowsToMerge.Skip(1))
                    {
                        bool success = await DocumentHeaderService.DeleteDocumentRowAsync(row.Id);
                        if (success)
                            deletedCount++;
                    }

                    Snackbar.Add(TranslationService.GetTranslation("documents.mergeRowsSuccess", "Righe unite con successo"), Severity.Success);
                    _selectedRows.Clear();
                    await LoadDocumentAsync(_currentDocument!.Id);
                }
                else
                {
                    Snackbar.Add(TranslationService.GetTranslation("documents.mergeRowsError", "Errore durante l'unione delle righe"), Severity.Error);
                }
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Error merging document rows");
                Snackbar.Add(TranslationService.GetTranslation("documents.mergeRowsError", "Errore durante l'unione delle righe"), Severity.Error);
            }
            finally
            {
                _isLoading = false;
            }
        }
    }
}
