@page "/documents/create"
@page "/documents/edit/{DocumentId:guid}"
@using Microsoft.AspNetCore.Authorization
@using EventForge.DTOs.Common
@using EventForge.DTOs.Documents
@using EventForge.DTOs.Business
@using EventForge.DTOs.Products
@using EventForge.Client.Shared.Components.Dialogs.Documents
@attribute [Authorize(Roles = "SuperAdmin,Admin,Manager,Operator")]
@inject IDocumentHeaderService DocumentHeaderService
@inject IDocumentTypeService DocumentTypeService
@inject IBusinessPartyService BusinessPartyService
@inject IProductService ProductService
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject ITranslationService TranslationService
@inject ILogger<GenericDocumentProcedure> Logger
@inject NavigationManager NavigationManager

<PageTitle>@_pageTitle</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudGrid Class="mb-4">
        <MudItem xs="12" md="8">
            <MudText Typo="Typo.h4">
                <MudIcon Icon="@Icons.Material.Outlined.Description" Class="mr-2" Size="Size.Medium" />
                @_pageTitle
            </MudText>
        </MudItem>
        <MudItem xs="12" md="4">
            <MudStack Row="true" Justify="Justify.FlexEnd">
                <MudButton StartIcon="@Icons.Material.Outlined.ArrowBack"
                           Color="Color.Default"
                           Variant="Variant.Outlined"
                           OnClick="@(() => NavigationManager.NavigateTo("/documents/list"))">
                    @TranslationService.GetTranslation("common.back", "Indietro")
                </MudButton>
            </MudStack>
        </MudItem>
    </MudGrid>

    <PageLoadingOverlay Visible="_isLoading"
                        Message="@(_isLoading ? TranslationService.GetTranslation("messages.loadingPage", "Caricamento pagina...") : TranslationService.GetTranslation("common.loading", "Caricamento..."))" />

    <!-- Document Header Section -->
    <MudPaper Elevation="2" Class="pa-4 mb-4">
        <MudText Typo="Typo.h6" Class="mb-3">
            <MudIcon Icon="@Icons.Material.Outlined.Description" Class="mr-2" />
            @TranslationService.GetTranslation("documents.headerInfo", "Informazioni Documento")
        </MudText>
        <MudStack Spacing="3">
            <MudSelect T="Guid" Label="@TranslationService.GetTranslation("documents.documentType", "Tipo Documento")" 
                       Variant="Variant.Outlined"
                       @bind-Value="_model.DocumentTypeId" Required="true" Disabled="@_isEditMode"
                       Adornment="Adornment.Start"
                       AdornmentIcon="@Icons.Material.Outlined.Category">
                @if (_documentTypes != null)
                {
                    @foreach (var type in _documentTypes)
                    {
                        <MudSelectItem T="Guid" Value="@type.Id">@type.Name</MudSelectItem>
                    }
                }
            </MudSelect>
            
            <MudTextField T="string" Label="@TranslationService.GetTranslation("documents.series", "Serie")" 
                          Variant="Variant.Outlined"
                          @bind-Value="_model.Series"
                          Adornment="Adornment.Start"
                          AdornmentIcon="@Icons.Material.Outlined.Tag" />
            
            <MudTextField T="string" 
                         Variant="Variant.Outlined"
                         Label="@TranslationService.GetTranslation("documents.number", "Numero")" 
                         @bind-Value="_model.Number" 
                         Required="false"
                         Placeholder="@TranslationService.GetTranslation("documents.autoGenerated", "Auto-generato")"
                         HelperText="@TranslationService.GetTranslation("documents.numberHelperText", "Lascia vuoto per generazione automatica")"
                         Adornment="Adornment.Start"
                         AdornmentIcon="@Icons.Material.Outlined.Numbers" />
            
            <MudDatePicker Label="@TranslationService.GetTranslation("documents.date", "Data")" 
                           Variant="Variant.Outlined"
                           @bind-Date="_documentDate" Required="true"
                           Adornment="Adornment.Start"
                           AdornmentIcon="@Icons.Material.Outlined.CalendarToday" />
            
            <MudAutocomplete T="BusinessPartyDto"
                             Variant="Variant.Outlined"
                             Label="@TranslationService.GetTranslation("documents.businessParty", "Controparte")"
                             @bind-Value="_selectedBusinessParty"
                             SearchFunc="@SearchBusinessPartiesAsync"
                             ToStringFunc="@(bp => bp?.Name ?? string.Empty)"
                             Required="true"
                             ShowProgressIndicator="true"
                             Adornment="Adornment.Start"
                             AdornmentIcon="@Icons.Material.Outlined.Business">
                <ItemTemplate Context="bp">
                    <MudText>@bp.Name</MudText>
                    @if (!string.IsNullOrEmpty(bp.TaxCode))
                    {
                        <MudText Typo="Typo.caption">@bp.TaxCode</MudText>
                    }
                </ItemTemplate>
            </MudAutocomplete>
            
            <MudTextField T="string" Label="@TranslationService.GetTranslation("documents.notes", "Note")" 
                          Variant="Variant.Outlined"
                          @bind-Value="_model.Notes" Lines="3"
                          Adornment="Adornment.Start"
                          AdornmentIcon="@Icons.Material.Outlined.Comment" />
            
            <MudButton StartIcon="@Icons.Material.Outlined.Save"
                       Color="Color.Primary"
                       Variant="Variant.Filled"
                       OnClick="@SaveDocumentHeaderAsync"
                       Disabled="@(!CanSaveHeader())">
                @TranslationService.GetTranslation("common.save", "Salva")
            </MudButton>
        </MudStack>
    </MudPaper>

    <!-- Document Rows Section -->
    <MudPaper Elevation="2" Class="pa-4 mt-4">
        <MudText Typo="Typo.h6" Class="mb-3">
            <MudIcon Icon="@Icons.Material.Outlined.List" Class="mr-2" />
            @TranslationService.GetTranslation("documents.rows", "Righe Documento")
        </MudText>

        @if (_currentDocument == null)
        {
            <!-- Documento non ancora salvato -->
            <MudAlert Severity="Severity.Info" Class="mb-4" Icon="@Icons.Material.Outlined.Info">
                <MudStack Spacing="2">
                    <MudText>
                        <strong>@TranslationService.GetTranslation("documents.saveFirstTitle", "Salva prima il documento")</strong>
                    </MudText>
                    <MudText Typo="Typo.body2">
                        @TranslationService.GetTranslation("documents.saveFirstMessage", "Per poter aggiungere righe al documento, è necessario salvarlo prima compilando i campi della testata (Tipo Documento, Cliente, Data) e cliccando su 'Salva'.")
                    </MudText>
                </MudStack>
            </MudAlert>
        }
        else
        {
            <!-- Documento salvato - mostra sempre la toolbar con il pulsante Aggiungi Riga -->
            <ManagementTableToolbar ShowSelectionBadge="@(_currentDocument.Rows?.Any() ?? false)"
                                    SelectedCount="@_selectedRows.Count"
                                    ShowRefresh="false"
                                    ShowCreate="true"
                                    ShowDelete="@(_selectedRows.Count > 0)"
                                    CreateLabel="documents.addRow"
                                    CreateTooltip="documents.addRowTooltip"
                                    IsDisabled="_isLoading"
                                    OnCreate="@AddRowAsync"
                                    OnDelete="@DeleteSelectedRowsAsync">
                <AdditionalActions>
                    @if (_selectedRows.Count >= 2 && CanMergeSelectedRows())
                    {
                        <MudButton Variant="Variant.Text"
                                   Color="Color.Primary"
                                   StartIcon="@Icons.Material.Outlined.MergeType"
                                   OnClick="@MergeSelectedRowsAsync"
                                   Disabled="@_isLoading"
                                   Size="Size.Small">
                            @TranslationService.GetTranslation("documents.mergeRows", "Unisci Righe")
                        </MudButton>
                    }
                </AdditionalActions>
            </ManagementTableToolbar>
            
            @if (_currentDocument.Rows != null && _currentDocument.Rows.Any())
            {
                <!-- Mostra la tabella delle righe -->
                <MudTable T="DocumentRowDto"
                          Items="@_currentDocument.Rows"
                          MultiSelection="true"
                          @bind-SelectedItems="_selectedRows"
                          Dense="true"
                          Hover="true"
                          Striped="true"
                          FixedHeader="true"
                          Height="calc(100vh - 400px)">
                    <HeaderContent>
                        <MudTh>@TranslationService.GetTranslation("documents.productCode", "Codice")</MudTh>
                        <MudTh>@TranslationService.GetTranslation("documents.description", "Descrizione")</MudTh>
                        <MudTh>@TranslationService.GetTranslation("documents.quantity", "Quantità")</MudTh>
                        <MudTh>@TranslationService.GetTranslation("documents.unitOfMeasure", "UM")</MudTh>
                        <MudTh>@TranslationService.GetTranslation("documents.unitPrice", "Prezzo")</MudTh>
                        <MudTh>@TranslationService.GetTranslation("documents.discount", "Sconto")</MudTh>
                        <MudTh>@TranslationService.GetTranslation("documents.total", "Totale")</MudTh>
                        <MudTh Style="text-align: right;">@TranslationService.GetTranslation("common.actions", "Azioni")</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="@TranslationService.GetTranslation("documents.productCode", "Codice")">@context.ProductCode</MudTd>
                        <MudTd DataLabel="@TranslationService.GetTranslation("documents.description", "Descrizione")">@context.Description</MudTd>
                        <MudTd DataLabel="@TranslationService.GetTranslation("documents.quantity", "Quantità")">@context.Quantity</MudTd>
                        <MudTd DataLabel="@TranslationService.GetTranslation("documents.unitOfMeasure", "UM")">@(context.UnitOfMeasure ?? "-")</MudTd>
                        <MudTd DataLabel="@TranslationService.GetTranslation("documents.unitPrice", "Prezzo")">
                            @{
                                decimal effectiveUnitPrice = context.Quantity > 0 
                                    ? Math.Round(context.LineTotal / context.Quantity, 2) 
                                    : context.UnitPrice;
                            }
                            <MudTooltip Text="@TranslationService.GetTranslation("documents.netUnitPriceTooltip", "Prezzo netto per unità (dopo sconto)")">
                                <span>@effectiveUnitPrice.ToString("C2")</span>
                            </MudTooltip>
                        </MudTd>
                        <MudTd DataLabel="@TranslationService.GetTranslation("documents.discount", "Sconto")">
                            @if (context.DiscountType == EventForge.DTOs.Common.DiscountType.Percentage && context.LineDiscount > 0)
                            {
                                <span>@context.LineDiscount.ToString("N2")%</span>
                            }
                            else if (context.DiscountType == EventForge.DTOs.Common.DiscountType.Value && context.LineDiscountValue > 0)
                            {
                                <span>@context.LineDiscountValue.ToString("C2")</span>
                            }
                            else
                            {
                                <span>-</span>
                            }
                        </MudTd>
                        <MudTd DataLabel="@TranslationService.GetTranslation("documents.total", "Totale")">@context.LineTotal.ToString("C2")</MudTd>
                        <MudTd Style="text-align: right;">
                            <ActionButtonGroup EntityName="@TranslationService.GetTranslation("entity.documentRow", "Riga")"
                                               ItemDisplayName="@context.Description"
                                               ShowView="false"
                                               ShowEdit="true"
                                               ShowAuditLog="false"
                                               ShowToggleStatus="false"
                                               ShowDelete="true"
                                               OnEdit="@(() => EditRow(context.Id))"
                                               OnDelete="@(() => DeleteRowAsync(context.Id))" />
                        </MudTd>
                    </RowTemplate>
                    <NoRecordsContent>
                        <MudText>@TranslationService.GetTranslation("documents.noRows", "Nessuna riga presente")</MudText>
                    </NoRecordsContent>
                </MudTable>

                <MudDivider Class="my-4" />
                <MudStack Row="true" Justify="Justify.FlexEnd" Class="mt-4">
                    <MudText Typo="Typo.h6">
                        @TranslationService.GetTranslation("documents.totalAmount", "Totale"): @CalculateTotalAmount().ToString("C2")
                    </MudText>
                </MudStack>
            }
            else
            {
                <!-- Mostra messaggio informativo -->
                <MudAlert Severity="Severity.Info" Class="mb-4">
                    <MudText>
                        @TranslationService.GetTranslation("documents.noRows", "Nessuna riga presente. Clicca 'Aggiungi Riga' per iniziare.")
                    </MudText>
                </MudAlert>
            }
        }
    </MudPaper>

    @if (_currentDocument != null)
    {
        <!-- Actions -->
        <MudStack Row="true" Class="mt-4" Justify="Justify.FlexEnd">
            @if (_currentDocument.Status == DocumentStatus.Draft)
            {
                <MudButton StartIcon="@Icons.Material.Outlined.Check"
                           Color="Color.Success"
                           Variant="Variant.Filled"
                           OnClick="@ApproveDocumentAsync"
                           Disabled="@(_currentDocument.Rows == null || !_currentDocument.Rows.Any())">
                    @TranslationService.GetTranslation("documents.approve", "Approva")
                </MudButton>
            }
            <MudButton StartIcon="@Icons.Material.Outlined.Close"
                       Color="Color.Default"
                       Variant="Variant.Outlined"
                       OnClick="@(() => NavigationManager.NavigateTo("/documents/list"))">
                @TranslationService.GetTranslation("common.close", "Chiudi")
            </MudButton>
        </MudStack>
    }
</MudContainer>

@code {
    [Parameter] public Guid? DocumentId { get; set; }

    private bool _isLoading = false;
    private bool _isEditMode => DocumentId.HasValue;
    private string _pageTitle = "";
    private CreateDocumentHeaderDto _model = new();
    private DocumentHeaderDto? _currentDocument = null;
    private DateTime? _documentDate = DateTime.Now;
    private List<DocumentTypeDto> _documentTypes = new();
    private BusinessPartyDto? _selectedBusinessParty = null;
    
    // Selection management for rows
    private HashSet<DocumentRowDto> _selectedRows = new();

    protected override async Task OnInitializedAsync()
    {
        _pageTitle = _isEditMode
            ? TranslationService.GetTranslation("documents.editDocument", "Modifica Documento")
            : TranslationService.GetTranslation("documents.createDocument", "Nuovo Documento");

        await LoadDocumentTypesAsync();

        if (_isEditMode && DocumentId.HasValue)
        {
            await LoadDocumentAsync(DocumentId.Value);
        }
        else
        {
            _model.Date = DateTime.UtcNow;
            
            // Set DDT_VEND (Sales Delivery Note) as default document type
            var defaultDocType = _documentTypes.FirstOrDefault(dt => dt.Code == "DDT_VEND");
            if (defaultDocType != null)
            {
                _model.DocumentTypeId = defaultDocType.Id;
            }
        }
    }

    private async Task LoadDocumentTypesAsync()
    {
        try
        {
            var types = await DocumentTypeService.GetAllDocumentTypesAsync();
            _documentTypes = types?.ToList() ?? new List<DocumentTypeDto>();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading document types");
            Snackbar.Add(TranslationService.GetTranslation("documents.errorLoadingTypes", "Errore durante il caricamento dei tipi di documento"), Severity.Error);
        }
    }

    private async Task LoadDocumentAsync(Guid documentId)
    {
        _isLoading = true;
        try
        {
            Logger.LogInformation("Loading document {DocumentId} with includeRows=true", documentId);
            
            _currentDocument = await DocumentHeaderService.GetDocumentHeaderByIdAsync(documentId, includeRows: true);
            
            if (_currentDocument != null)
            {
                Logger.LogInformation("Document loaded successfully. Id={Id}, Status={Status}, RowsCount={RowsCount}", 
                    _currentDocument.Id, 
                    _currentDocument.Status,
                    _currentDocument.Rows?.Count ?? 0);
                
                _model.DocumentTypeId = _currentDocument.DocumentTypeId;
                _model.Series = _currentDocument.Series;
                _model.Number = _currentDocument.Number;
                _model.Date = _currentDocument.Date;
                _model.BusinessPartyId = _currentDocument.BusinessPartyId;
                _model.Notes = _currentDocument.Notes;
                _documentDate = _currentDocument.Date.ToLocalTime();
                
                // Load the business party to populate the autocomplete
                if (_currentDocument.BusinessPartyId != Guid.Empty)
                {
                    _selectedBusinessParty = await BusinessPartyService.GetBusinessPartyAsync(_currentDocument.BusinessPartyId);
                    if (_selectedBusinessParty == null)
                    {
                        Logger.LogWarning("Business party with ID {BusinessPartyId} not found for document {DocumentId}", _currentDocument.BusinessPartyId, documentId);
                    }
                }
            }
            else
            {
                Logger.LogWarning("Document {DocumentId} not found or failed to load", documentId);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading document {DocumentId}", documentId);
            Snackbar.Add(TranslationService.GetTranslation("documents.errorLoading", "Errore durante il caricamento del documento"), Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task<IEnumerable<BusinessPartyDto>> SearchBusinessPartiesAsync(string searchTerm, CancellationToken cancellationToken)
    {
        if (string.IsNullOrWhiteSpace(searchTerm) || searchTerm.Length < 2)
            return Array.Empty<BusinessPartyDto>();

        try
        {
            // Get the selected document type to filter by required party type
            var selectedDocType = _documentTypes.FirstOrDefault(dt => dt.Id == _model.DocumentTypeId);
            
            // Use server-side search with type filter if applicable
            BusinessPartyType? partyTypeFilter = null;
            if (selectedDocType != null && selectedDocType.RequiredPartyType != BusinessPartyType.Both)
            {
                partyTypeFilter = selectedDocType.RequiredPartyType;
            }

            var result = await BusinessPartyService.SearchBusinessPartiesAsync(searchTerm, partyTypeFilter, pageSize: 50);
            return result;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error searching business parties");
            return Array.Empty<BusinessPartyDto>();
        }
    }

    private bool CanSaveHeader()
    {
        return _model.DocumentTypeId != Guid.Empty
               && _selectedBusinessParty != null
               && _documentDate.HasValue;
    }

    private decimal CalculateTotalAmount()
    {
        if (_currentDocument?.Rows == null || !_currentDocument.Rows.Any())
            return 0;
        
        return _currentDocument.Rows.Sum(row => row.Quantity * row.UnitPrice);
    }

    private async Task SaveDocumentHeaderAsync()
    {
        _isLoading = true;
        try
        {
            _model.BusinessPartyId = _selectedBusinessParty!.Id;
            _model.Date = _documentDate!.Value.ToUniversalTime();

            if (_isEditMode && DocumentId.HasValue)
            {
                var updateDto = new UpdateDocumentHeaderDto
                {
                    DocumentTypeId = _model.DocumentTypeId,
                    Series = _model.Series,
                    Number = _model.Number,
                    Date = _model.Date,
                    BusinessPartyId = _model.BusinessPartyId,
                    Notes = _model.Notes
                };
                var updated = await DocumentHeaderService.UpdateDocumentHeaderAsync(DocumentId.Value, updateDto);
                if (updated != null)
                {
                    _currentDocument = updated;
                    Snackbar.Add(TranslationService.GetTranslation("documents.updateSuccess", "Documento aggiornato con successo"), Severity.Success);
                }
            }
            else
            {
                var created = await DocumentHeaderService.CreateDocumentHeaderAsync(_model);
                if (created != null)
                {
                    _currentDocument = created;
                    Snackbar.Add(TranslationService.GetTranslation("documents.createSuccess", "Documento creato con successo"), Severity.Success);
                    NavigationManager.NavigateTo($"/documents/edit/{created.Id}");
                }
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error saving document header");
            Snackbar.Add(TranslationService.GetTranslation("documents.saveError", "Errore durante il salvataggio del documento"), Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task AddRowAsync()
    {
        var parameters = new DialogParameters
        {
            { "DocumentHeaderId", _currentDocument!.Id }
        };

        var options = new DialogOptions 
        { 
            MaxWidth = MaxWidth.Medium, 
            FullWidth = true,
            CloseButton = true
        };

        var dialog = await DialogService.ShowAsync<AddDocumentRowDialog>(
            TranslationService.GetTranslation("documents.addRow", "Aggiungi Riga"),
            parameters,
            options);

        var result = await dialog.Result;
        // Always reload the document when the dialog closes, regardless of how it was closed
        // This ensures we show any rows that were added during the dialog session
        await LoadDocumentAsync(_currentDocument.Id);
    }

    private async Task DeleteRowAsync(Guid rowId)
    {
        bool? confirmed = await DialogService.ShowMessageBox(
            TranslationService.GetTranslation("documents.confirmDeleteRow", "Conferma Eliminazione"),
            TranslationService.GetTranslation("documents.confirmDeleteRowMessage", "Sei sicuro di voler eliminare questa riga?"),
            yesText: TranslationService.GetTranslation("common.yes", "Sì"),
            noText: TranslationService.GetTranslation("common.no", "No"));

        if (confirmed == true)
        {
            _isLoading = true;
            try
            {
                bool success = await DocumentHeaderService.DeleteDocumentRowAsync(rowId);
                if (success)
                {
                    Snackbar.Add(TranslationService.GetTranslation("documents.deleteRowSuccess", "Riga eliminata con successo"), Severity.Success);
                    await LoadDocumentAsync(_currentDocument!.Id);
                }
                else
                {
                    Snackbar.Add(TranslationService.GetTranslation("documents.deleteRowError", "Errore durante l'eliminazione della riga"), Severity.Error);
                }
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Error deleting document row");
                Snackbar.Add(TranslationService.GetTranslation("documents.deleteRowError", "Errore durante l'eliminazione della riga"), Severity.Error);
            }
            finally
            {
                _isLoading = false;
            }
        }
    }

    private async Task ApproveDocumentAsync()
    {
        _isLoading = true;
        try
        {
            var result = await DocumentHeaderService.ApproveDocumentAsync(_currentDocument!.Id);
            if (result != null)
            {
                _currentDocument = result;
                Snackbar.Add(TranslationService.GetTranslation("documents.approveSuccess", "Documento approvato con successo"), Severity.Success);
                NavigationManager.NavigateTo("/documents/list");
            }
            else
            {
                Snackbar.Add(TranslationService.GetTranslation("documents.approveError", "Errore durante l'approvazione del documento"), Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error approving document");
            Snackbar.Add(TranslationService.GetTranslation("documents.approveError", "Errore durante l'approvazione del documento"), Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task EditRow(Guid rowId)
    {
        var parameters = new DialogParameters
        {
            { "DocumentHeaderId", _currentDocument!.Id },
            { "RowId", rowId }
        };

        var options = new DialogOptions 
        { 
            MaxWidth = MaxWidth.Medium, 
            FullWidth = true,
            CloseButton = true
        };

        var dialog = await DialogService.ShowAsync<AddDocumentRowDialog>(
            TranslationService.GetTranslation("documents.editRow", "Modifica Riga"),
            parameters,
            options);

        var result = await dialog.Result;
        // Always reload the document when the dialog closes
        await LoadDocumentAsync(_currentDocument.Id);
    }

    private async Task DeleteSelectedRowsAsync()
    {
        if (_selectedRows.Count == 0)
            return;

        bool? confirmed = await DialogService.ShowMessageBox(
            TranslationService.GetTranslation("documents.confirmDeleteRows", "Conferma Eliminazione"),
            TranslationService.GetTranslationFormatted("documents.confirmDeleteRowsMessage", "Sei sicuro di voler eliminare {0} righe?", _selectedRows.Count),
            yesText: TranslationService.GetTranslation("common.yes", "Sì"),
            noText: TranslationService.GetTranslation("common.no", "No"));

        if (confirmed == true)
        {
            _isLoading = true;
            try
            {
                int successCount = 0;
                foreach (var row in _selectedRows.ToList())
                {
                    bool success = await DocumentHeaderService.DeleteDocumentRowAsync(row.Id);
                    if (success)
                        successCount++;
                }

                if (successCount > 0)
                {
                    Snackbar.Add(TranslationService.GetTranslationFormatted("documents.deleteRowsSuccess", "{0} righe eliminate con successo", successCount), Severity.Success);
                    _selectedRows.Clear();
                    await LoadDocumentAsync(_currentDocument!.Id);
                }
                else
                {
                    Snackbar.Add(TranslationService.GetTranslation("documents.deleteRowsError", "Errore durante l'eliminazione delle righe"), Severity.Error);
                }
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Error deleting document rows");
                Snackbar.Add(TranslationService.GetTranslation("documents.deleteRowsError", "Errore durante l'eliminazione delle righe"), Severity.Error);
            }
            finally
            {
                _isLoading = false;
            }
        }
    }

    private bool CanMergeSelectedRows()
    {
        if (_selectedRows.Count < 2)
            return false;

        // Check if all selected rows have the same ProductId and it's not null
        var firstProductId = _selectedRows.First().ProductId;
        if (!firstProductId.HasValue)
            return false;

        // All rows must have the same ProductId
        if (!_selectedRows.All(r => r.ProductId == firstProductId))
            return false;

        // All rows must have the same UnitOfMeasure
        var firstUoM = _selectedRows.First().UnitOfMeasure;
        if (!_selectedRows.All(r => r.UnitOfMeasure == firstUoM))
            return false;

        return true;
    }

    private async Task MergeSelectedRowsAsync()
    {
        if (!CanMergeSelectedRows())
        {
            Snackbar.Add(TranslationService.GetTranslation("documents.cannotMergeRows", "Impossibile unire le righe selezionate. Assicurati che abbiano lo stesso prodotto e unità di misura."), Severity.Warning);
            return;
        }

        var rowsToMerge = _selectedRows.OrderBy(r => r.CreatedAt).ToList();
        var mainRow = rowsToMerge.First();

        // Create confirmation message showing what will be merged
        var confirmMessage = $"{TranslationService.GetTranslation("documents.mergeRowsConfirmMessage", "Verranno unite {0} righe del prodotto {1}:", rowsToMerge.Count, mainRow.Description)}\n\n";
        confirmMessage += string.Join("\n", rowsToMerge.Select(r => $"- {r.Quantity} x {r.UnitPrice:C2} = {(r.Quantity * r.UnitPrice):C2}"));
        confirmMessage += $"\n\n{TranslationService.GetTranslation("documents.mergeRowsResult", "Risultato: Quantità totale = {0}", rowsToMerge.Sum(r => r.Quantity))}";

        bool? confirmed = await DialogService.ShowMessageBox(
            TranslationService.GetTranslation("documents.confirmMergeRows", "Conferma Unione Righe"),
            confirmMessage,
            yesText: TranslationService.GetTranslation("common.yes", "Sì"),
            noText: TranslationService.GetTranslation("common.no", "No"));

        if (confirmed == true)
        {
            _isLoading = true;
            try
            {
                // Calculate merged values
                decimal totalQuantity = rowsToMerge.Sum(r => r.Quantity);
                decimal maxPrice = rowsToMerge.Max(r => r.UnitPrice);
                var mergedNotes = string.Join(" | ", rowsToMerge.Where(r => !string.IsNullOrWhiteSpace(r.Notes)).Select(r => r.Notes));

                // Update the main row
                var updateDto = new UpdateDocumentRowDto
                {
                    RowType = mainRow.RowType,
                    ParentRowId = mainRow.ParentRowId,
                    ProductCode = mainRow.ProductCode,
                    Description = mainRow.Description,
                    UnitOfMeasure = mainRow.UnitOfMeasure,
                    UnitOfMeasureId = mainRow.UnitOfMeasureId,
                    UnitPrice = maxPrice,
                    Quantity = totalQuantity,
                    LineDiscount = mainRow.LineDiscount,
                    VatRate = mainRow.VatRate,
                    VatDescription = mainRow.VatDescription,
                    IsGift = mainRow.IsGift,
                    IsManual = mainRow.IsManual,
                    SourceWarehouseId = mainRow.SourceWarehouseId,
                    DestinationWarehouseId = mainRow.DestinationWarehouseId,
                    Notes = string.IsNullOrWhiteSpace(mergedNotes) ? null : mergedNotes,
                    SortOrder = mainRow.SortOrder,
                    StationId = mainRow.StationId
                };

                var updated = await DocumentHeaderService.UpdateDocumentRowAsync(mainRow.Id, updateDto);
                if (updated != null)
                {
                    // Delete the other rows
                    int deletedCount = 0;
                    foreach (var row in rowsToMerge.Skip(1))
                    {
                        bool success = await DocumentHeaderService.DeleteDocumentRowAsync(row.Id);
                        if (success)
                            deletedCount++;
                    }

                    Snackbar.Add(TranslationService.GetTranslation("documents.mergeRowsSuccess", "Righe unite con successo"), Severity.Success);
                    _selectedRows.Clear();
                    await LoadDocumentAsync(_currentDocument!.Id);
                }
                else
                {
                    Snackbar.Add(TranslationService.GetTranslation("documents.mergeRowsError", "Errore durante l'unione delle righe"), Severity.Error);
                }
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Error merging document rows");
                Snackbar.Add(TranslationService.GetTranslation("documents.mergeRowsError", "Errore durante l'unione delle righe"), Severity.Error);
            }
            finally
            {
                _isLoading = false;
            }
        }
    }
}
