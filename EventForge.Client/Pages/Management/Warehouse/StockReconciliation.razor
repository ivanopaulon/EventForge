@page "/warehouse/stock-reconciliation"
@using Microsoft.AspNetCore.Authorization
@using EventForge.DTOs.Warehouse
@using EventForge.DTOs.Products
@using EventForge.Client.Shared.Components
@using EventForge.Client.Shared.Components.Dialogs
@using static EventForge.Client.Shared.Components.Dialogs.StockReconciliationConfirmDialog
@attribute [Authorize(Roles = "SuperAdmin,Admin,Manager")]
@inject IStockReconciliationService StockReconciliationService
@inject IWarehouseService WarehouseService
@inject IStorageLocationService StorageLocationService
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject ITranslationService TranslationService
@inject ILogger<StockReconciliation> Logger
@inject IJSRuntime JSRuntime

<PageLoadingOverlay Visible="_isLoading"
                    Message="@TranslationService.GetTranslation("messages.loadingPage", "Caricamento pagina...")" />

@if (!_isLoading)
{
    <div class="stock-reconciliation-page-root">
        <MudText Typo="Typo.h4" Class="mb-4">
            @TranslationService.GetTranslation("stockReconciliation.title", "Warehouse Stock Reconciliation")
        </MudText>

        @* Filters Section *@
        <MudPaper Class="pa-4 mb-4" Elevation="2" Style="background-color: var(--mud-palette-background-grey);">
            <MudText Typo="Typo.h6" Class="mb-3">
                <MudIcon Icon="@Icons.Material.Outlined.FilterList" Class="mr-2" />
                @TranslationService.GetTranslation("stockReconciliation.filters", "Filters and Options")
            </MudText>
            <MudGrid Spacing="2">
                <MudItem xs="12" md="6">
                    <MudDatePicker @bind-Date="_fromDate"
                                   Label="@TranslationService.GetTranslation("field.fromDate", "From Date")"
                                   Variant="Variant.Outlined"
                                   Clearable="true"
                                   AdornmentIcon="@Icons.Material.Outlined.CalendarToday"
                                   Adornment="Adornment.Start" />
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudDatePicker @bind-Date="_toDate"
                                   Label="@TranslationService.GetTranslation("field.toDate", "To Date")"
                                   Variant="Variant.Outlined"
                                   Clearable="true"
                                   AdornmentIcon="@Icons.Material.Outlined.CalendarToday"
                                   Adornment="Adornment.Start" />
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudSelect @bind-Value="_selectedWarehouseId"
                               @bind-Value:after="OnWarehouseChanged"
                               Label="@TranslationService.GetTranslation("field.warehouse", "Warehouse")"
                               Variant="Variant.Outlined"
                               Clearable="true"
                               AdornmentIcon="@Icons.Material.Outlined.Warehouse"
                               Adornment="Adornment.Start">
                        @foreach (var warehouse in _warehouses)
                        {
                            <MudSelectItem T="Guid?" Value="@warehouse.Id">
                                @(string.IsNullOrWhiteSpace(warehouse.Code) ? warehouse.Name : $"{warehouse.Code} - {warehouse.Name}")
                            </MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudSelect @bind-Value="_selectedLocationId"
                               Label="@TranslationService.GetTranslation("field.location", "Location")"
                               Variant="Variant.Outlined"
                               Clearable="true"
                               Disabled="@(!_selectedWarehouseId.HasValue || _isLoadingLocations)"
                               AdornmentIcon="@(_isLoadingLocations ? Icons.Material.Outlined.HourglassEmpty : Icons.Material.Outlined.LocationOn)"
                               Adornment="Adornment.Start">
                        @if (_isLoadingLocations)
                        {
                            <MudSelectItem T="Guid?" Value="null" Disabled="true">
                                @TranslationService.GetTranslation("common.loading", "Caricamento...")
                            </MudSelectItem>
                        }
                        else
                        {
                            @foreach (var location in _locations)
                            {
                                <MudSelectItem T="Guid?" Value="@location.Id">@location.Code - @location.Description</MudSelectItem>
                            }
                        }
                    </MudSelect>
                </MudItem>
                <MudItem xs="12" md="6">
                    <UnifiedProductScanner @bind-SelectedProduct="_selectedProduct"
                                           Title="@null"
                                           Placeholder="@TranslationService.GetTranslation("stockReconciliation.searchProduct", "Cerca prodotto...")"
                                           ShowProductInfo="false"
                                           SearchMode="ProductSearchMode.Description"
                                           AllowClear="true"
                                           Dense="true"
                                           AutoFocus="false" />
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudNumericField @bind-Value="_discrepancyThreshold"
                                     Label="@TranslationService.GetTranslation("stockReconciliation.discrepancyThreshold", "Soglia Discrepanza Maggiore (%)")"
                                     Variant="Variant.Outlined"
                                     Min="0"
                                     Max="100"
                                     Step="1"
                                     Adornment="Adornment.End"
                                     AdornmentText="%"
                                     HelperText="@TranslationService.GetTranslation("stockReconciliation.discrepancyThresholdHelp", "Differenze superiori a questa soglia saranno marcate come discrepanze maggiori")"
                                     Clearable="false" />
                </MudItem>
                
                <!-- Switches on a separate row -->
                <MudItem xs="12">
                    <MudStack Row="true" Spacing="3" Class="mt-2">
                        <MudSwitch @bind-Value="_includeDocuments"
                                   Label="@TranslationService.GetTranslation("stockReconciliation.includeDocuments", "Include documents")"
                                   Color="Color.Primary" />
                        <MudSwitch @bind-Value="_includeInventories"
                                   Label="@TranslationService.GetTranslation("stockReconciliation.includeInventories", "Include inventories")"
                                   Color="Color.Primary" />
                        <MudSwitch @bind-Value="_onlyWithDiscrepancies"
                                   Label="@TranslationService.GetTranslation("stockReconciliation.onlyWithDiscrepancies", "Only discrepancies")"
                                   Color="Color.Warning" />
                    </MudStack>
                </MudItem>
            </MudGrid>
            
            <!-- Action buttons aligned to right -->
            <MudStack Row="true" Spacing="2" Class="mt-3" Justify="Justify.FlexEnd">
                <MudButton Variant="Variant.Outlined" 
                           OnClick="ClearFilters"
                           StartIcon="@Icons.Material.Outlined.Clear">
                    @TranslationService.GetTranslation("common.clearFilters", "Clear Filters")
                </MudButton>
                <MudButton Variant="Variant.Filled" 
                           Color="Color.Primary"
                           OnClick="CalculatePreviewAsync"
                           Disabled="_isCalculating"
                           StartIcon="@Icons.Material.Outlined.Calculate">
                    @if (_isCalculating)
                    {
                        <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                        <MudText Class="ms-2">@TranslationService.GetTranslation("stockReconciliation.calculating", "Calculating...")</MudText>
                    }
                    else
                    {
                        <MudText>@TranslationService.GetTranslation("stockReconciliation.calculate", "Calculate Reconciliation")</MudText>
                    }
                </MudButton>
            </MudStack>
        </MudPaper>

        @* Info Banner *@
        @if (_reconciliationResult != null)
        {
            <MudPaper Elevation="1" Class="pa-3 mb-3" Style="background-color: var(--mud-palette-info-lighten);">
                <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                    <MudIcon Icon="@Icons.Material.Outlined.Info" Color="Color.Info" />
                    <MudText Typo="Typo.body2">
                        <strong>@TranslationService.GetTranslation("stockReconciliation.resultsLabel", "Results:"):</strong>
                        @(" ")
                        @_reconciliationResult.Summary.TotalProducts @TranslationService.GetTranslation("stockReconciliation.productsFound", "products")
                        @if ((_reconciliationResult.Summary.MinorDiscrepancyCount + _reconciliationResult.Summary.MajorDiscrepancyCount + _reconciliationResult.Summary.MissingCount) > 0)
                        {
                            <span> | </span>
                            <strong>@(_reconciliationResult.Summary.MinorDiscrepancyCount + _reconciliationResult.Summary.MajorDiscrepancyCount + _reconciliationResult.Summary.MissingCount)</strong>
                            @(" ")
                            @TranslationService.GetTranslation("stockReconciliation.withDiscrepancies", "with discrepancies")
                        }
                    </MudText>
                </MudStack>
            </MudPaper>
        }

        @* Action Buttons *@
        @if (_reconciliationResult != null)
        {
            <MudPaper Elevation="2" Class="pa-3 mb-4">
                <MudStack Row="true" Spacing="2" Justify="Justify.FlexEnd">
                    <MudButton Variant="Variant.Outlined"
                               Color="Color.Info"
                               OnClick="ExportReportAsync"
                               Disabled="@_isExporting"
                               StartIcon="@Icons.Material.Outlined.Download">
                        @TranslationService.GetTranslation("stockReconciliation.export", "Export Report")
                    </MudButton>
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Warning"
                               OnClick="ApplyReconciliationAsync"
                               Disabled="@(_selectedItems.Count == 0 || _isApplying)"
                               StartIcon="@Icons.Material.Outlined.Check">
                        @if (_isApplying)
                        {
                            <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                            <MudText Class="ms-2">@TranslationService.GetTranslation("stockReconciliation.applying", "Applying...")</MudText>
                        }
                        else
                        {
                            <MudText>@TranslationService.GetTranslation("stockReconciliation.apply", "Apply Recalculation") (@_selectedItems.Count)</MudText>
                        }
                    </MudButton>
                </MudStack>
            </MudPaper>
        }

        @* Results Section *@
        @if (_reconciliationResult != null)
        {
            <MudPaper Class="pa-4 mb-4" Elevation="2">
                <div class="d-flex align-center justify-space-between mb-3">
                    <MudText Typo="Typo.h6">
                        @TranslationService.GetTranslation("common.results", "Results")
                    </MudText>
                    <div class="d-flex gap-2">
                        <MudButton Size="Size.Small"
                                   Variant="Variant.Text"
                                   OnClick="SelectAll"
                                   Disabled="@(_reconciliationResult.Items.Count == 0)">
                            @TranslationService.GetTranslation("stockReconciliation.selectAll", "Select all")
                        </MudButton>
                        <MudButton Size="Size.Small"
                                   Variant="Variant.Text"
                                   OnClick="DeselectAll"
                                   Disabled="@(_selectedItems.Count == 0)">
                            @TranslationService.GetTranslation("stockReconciliation.deselectAll", "Deselect all")
                        </MudButton>
                    </div>
                </div>

                <MudTable T="StockReconciliationItemDto"
                          Items="_reconciliationResult.Items"
                          Hover="true"
                          Striped="true"
                          Dense="true"
                          MultiSelection="true"
                          @bind-SelectedItems="_selectedItems"
                          FixedHeader="true"
                          Height="500px">
                    <HeaderContent>
                        <MudTh></MudTh>
                        <MudTh>@TranslationService.GetTranslation("stockReconciliation.product", "Product")</MudTh>
                        <MudTh>@TranslationService.GetTranslation("stockReconciliation.warehouse", "Warehouse")</MudTh>
                        <MudTh>@TranslationService.GetTranslation("stockReconciliation.location", "Location")</MudTh>
                        <MudTh Style="text-align:right;">@TranslationService.GetTranslation("stockReconciliation.currentQty", "Current Stock")</MudTh>
                        <MudTh Style="text-align:right;">@TranslationService.GetTranslation("stockReconciliation.calculatedQty", "Calculated Stock")</MudTh>
                        <MudTh Style="text-align:right;">@TranslationService.GetTranslation("stockReconciliation.difference", "Difference")</MudTh>
                        <MudTh Style="text-align:center;">@TranslationService.GetTranslation("stockReconciliation.severity", "Severity")</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd>
                            <MudIconButton Icon="@(context.SourceMovements.Any() ? Icons.Material.Outlined.ExpandMore : Icons.Material.Outlined.ChevronRight)"
                                           Size="Size.Small"
                                           OnClick="@(() => ToggleRowExpansion(context))"
                                           Disabled="@(!context.SourceMovements.Any())" />
                        </MudTd>
                        <MudTd DataLabel="@TranslationService.GetTranslation("stockReconciliation.product", "Product")">
                            <div>
                                <MudText Typo="Typo.body2" Style="font-weight:600;">@context.ProductCode</MudText>
                                <MudText Typo="Typo.caption">@context.ProductName</MudText>
                            </div>
                        </MudTd>
                        <MudTd DataLabel="@TranslationService.GetTranslation("stockReconciliation.warehouse", "Warehouse")">
                            @context.WarehouseName
                        </MudTd>
                        <MudTd DataLabel="@TranslationService.GetTranslation("stockReconciliation.location", "Location")">
                            @context.LocationCode
                        </MudTd>
                        <MudTd DataLabel="@TranslationService.GetTranslation("stockReconciliation.currentQty", "Current Stock")" Style="text-align:right;">
                            <MudText Typo="Typo.body2">@context.CurrentQuantity.ToString("N2")</MudText>
                        </MudTd>
                        <MudTd DataLabel="@TranslationService.GetTranslation("stockReconciliation.calculatedQty", "Calculated Stock")" Style="text-align:right;">
                            <MudText Typo="Typo.body2" Style="font-weight:600;">@context.CalculatedQuantity.ToString("N2")</MudText>
                        </MudTd>
                        <MudTd DataLabel="@TranslationService.GetTranslation("stockReconciliation.difference", "Difference")" Style="text-align:right;">
                            <MudText Typo="Typo.body2" 
                                     Color="@(context.Difference > 0 ? Color.Success : (context.Difference < 0 ? Color.Error : Color.Default))"
                                     Style="font-weight:600;">
                                @((context.Difference > 0 ? "+" : "") + context.Difference.ToString("N2"))
                                @if (context.DifferencePercentage != 0)
                                {
                                    <text> (@((context.DifferencePercentage > 0 ? "+" : ""))@context.DifferencePercentage.ToString("N1")%)</text>
                                }
                            </MudText>
                        </MudTd>
                        <MudTd DataLabel="@TranslationService.GetTranslation("stockReconciliation.severity", "Severity")" Style="text-align:center;">
                            <MudChip T="string" Size="Size.Small" Color="@GetSeverityColor(context.Severity)">
                                @TranslationService.GetTranslation($"stockReconciliation.severity.{context.Severity.ToString().ToLower()}", context.Severity.ToString())
                            </MudChip>
                        </MudTd>
                    </RowTemplate>
                    <ChildRowContent>
                        @if (_expandedRows.Contains(context) && context.SourceMovements.Any())
                        {
                            <MudTr>
                                <td colspan="8" style="padding:0;">
                                    <MudPaper Class="pa-3 ma-2" Elevation="0" Style="background-color: var(--mud-palette-background-grey);">
                                        <MudText Typo="Typo.subtitle2" Class="mb-2">
                                            @TranslationService.GetTranslation("stockReconciliation.sourceMovements", "Source Movements")
                                        </MudText>
                                        <MudSimpleTable Dense="true" Hover="true" Style="overflow-x: auto;">
                                            <thead>
                                                <tr>
                                                    <th>@TranslationService.GetTranslation("field.type", "Type")</th>
                                                    <th>@TranslationService.GetTranslation("field.reference", "Reference")</th>
                                                    <th>@TranslationService.GetTranslation("field.date", "Date")</th>
                                                    <th style="text-align:right;">@TranslationService.GetTranslation("field.quantity", "Quantity")</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @foreach (var movement in context.SourceMovements.OrderBy(m => m.Date))
                                                {
                                                    <tr>
                                                        <td>@movement.Type</td>
                                                        <td>@movement.Reference</td>
                                                        <td>@movement.Date.ToString("dd/MM/yyyy HH:mm")</td>
                                                        <td style="text-align:right;">
                                                            <MudText Color="@(movement.Quantity > 0 ? Color.Success : Color.Error)">
                                                                @((movement.Quantity > 0 ? "+" : ""))@movement.Quantity.ToString("N2")
                                                            </MudText>
                                                        </td>
                                                    </tr>
                                                }
                                            </tbody>
                                        </MudSimpleTable>
                                        <MudText Typo="Typo.caption" Class="mt-2">
                                            Documents: @context.TotalDocuments | Inventories: @context.TotalInventories | Manual: @context.TotalManualMovements
                                        </MudText>
                                    </MudPaper>
                                </td>
                            </MudTr>
                        }
                    </ChildRowContent>
                    <NoRecordsContent>
                        <div class="text-center pa-4">
                            <MudIcon Icon="@Icons.Material.Outlined.CheckCircle" Size="Size.Large" Class="mb-2 mud-text-secondary" />
                            <MudText Typo="Typo.h6">
                                @TranslationService.GetTranslation("stockReconciliation.noResults", "No results found")
                            </MudText>
                        </div>
                    </NoRecordsContent>
                </MudTable>
            </MudPaper>

            @* Summary Section *@
            <MudPaper Class="pa-4" Elevation="2">
                <MudText Typo="Typo.h6" Class="mb-3">
                    @TranslationService.GetTranslation("stockReconciliation.summary.title", "Summary")
                </MudText>
                <MudGrid>
                    <MudItem xs="12" sm="6" md="2">
                        <MudPaper Class="pa-3" Elevation="0" Style="background-color: var(--mud-palette-info-lighten);">
                            <MudText Typo="Typo.body2" Class="mud-text-secondary">
                                @TranslationService.GetTranslation("stockReconciliation.summary.totalProducts", "Total Products")
                            </MudText>
                            <MudText Typo="Typo.h5">@_reconciliationResult.Summary.TotalProducts</MudText>
                        </MudPaper>
                    </MudItem>
                    <MudItem xs="12" sm="6" md="2">
                        <MudPaper Class="pa-3" Elevation="0" Style="background-color: var(--mud-palette-success-lighten);">
                            <MudText Typo="Typo.body2" Class="mud-text-secondary">
                                @TranslationService.GetTranslation("stockReconciliation.summary.correct", "Correct")
                            </MudText>
                            <MudText Typo="Typo.h5" Color="Color.Success">@_reconciliationResult.Summary.CorrectCount</MudText>
                        </MudPaper>
                    </MudItem>
                    <MudItem xs="12" sm="6" md="2">
                        <MudPaper Class="pa-3" Elevation="0" Style="background-color: var(--mud-palette-warning-lighten);">
                            <MudText Typo="Typo.body2" Class="mud-text-secondary">
                                @TranslationService.GetTranslation("stockReconciliation.summary.minorDiscrepancies", "Minor Discrepancies")
                            </MudText>
                            <MudText Typo="Typo.h5" Color="Color.Warning">@_reconciliationResult.Summary.MinorDiscrepancyCount</MudText>
                        </MudPaper>
                    </MudItem>
                    <MudItem xs="12" sm="6" md="2">
                        <MudPaper Class="pa-3" Elevation="0" Style="background-color: var(--mud-palette-error-lighten);">
                            <MudText Typo="Typo.body2" Class="mud-text-secondary">
                                @TranslationService.GetTranslation("stockReconciliation.summary.majorDiscrepancies", "Major Discrepancies")
                            </MudText>
                            <MudText Typo="Typo.h5" Color="Color.Error">@_reconciliationResult.Summary.MajorDiscrepancyCount</MudText>
                        </MudPaper>
                    </MudItem>
                    <MudItem xs="12" sm="6" md="2">
                        <MudPaper Class="pa-3" Elevation="0" Style="background-color: var(--mud-palette-dark-lighten);">
                            <MudText Typo="Typo.body2" Class="mud-text-secondary">
                                @TranslationService.GetTranslation("stockReconciliation.summary.missing", "Missing")
                            </MudText>
                            <MudText Typo="Typo.h5" Color="Color.Dark">@_reconciliationResult.Summary.MissingCount</MudText>
                        </MudPaper>
                    </MudItem>
                    <MudItem xs="12" sm="6" md="2">
                        <MudPaper Class="pa-3" Elevation="0" Style="background-color: var(--mud-palette-primary-lighten);">
                            <MudText Typo="Typo.body2" Class="mud-text-secondary">
                                @TranslationService.GetTranslation("stockReconciliation.summary.totalDifference", "Total Difference")
                            </MudText>
                            <MudText Typo="Typo.h5" Color="Color.Primary">@_reconciliationResult.Summary.TotalDifferenceValue.ToString("N2")</MudText>
                        </MudPaper>
                    </MudItem>
                </MudGrid>
                @if (_selectedItems.Count > 0)
                {
                    <MudDivider Class="my-3" />
                    <MudAlert Severity="Severity.Info" Dense="true">
                        @TranslationService.GetTranslationFormatted(
                            "stockReconciliation.itemsToUpdate",
                            "Items to update: {0}",
                            _selectedItems.Count)
                    </MudAlert>
                }
            </MudPaper>
        }
    </div>
}

@code {
    private bool _isLoading = true;
    private bool _isCalculating = false;
    private bool _isApplying = false;
    private bool _isExporting = false;
    private bool _isLoadingLocations = false;

    // Filters
    private DateTime? _fromDate = null;
    private DateTime? _toDate = null;
    private Guid? _selectedWarehouseId = null;
    private Guid? _selectedLocationId = null;
    private ProductDto? _selectedProduct = null;
    private bool _includeDocuments = true;
    private bool _includeInventories = true;
    private bool _onlyWithDiscrepancies = false;
    private decimal _discrepancyThreshold = 10m;

    // Data
    private List<StorageFacilityDto> _warehouses = new();
    private List<StorageLocationDto> _locations = new();
    private StockReconciliationResultDto? _reconciliationResult = null;
    private HashSet<StockReconciliationItemDto> _selectedItems = new();
    private HashSet<StockReconciliationItemDto> _expandedRows = new();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Preload dates: start of current year and today
            var today = DateTime.Today;
            _fromDate = new DateTime(today.Year, 1, 1);
            _toDate = today;

            await LoadAllWarehousesAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error initializing stock reconciliation page");
            Snackbar.Add(TranslationService.GetTranslation("messages.loadFailed", "Errore nel caricamento"), Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task LoadAllWarehousesAsync()
    {
        try
        {
            var allWarehouses = new List<StorageFacilityDto>();
            var page = 1;
            var pageSize = 100;
            PagedResult<StorageFacilityDto>? result;
            
            do
            {
                result = await WarehouseService.GetStorageFacilitiesAsync(page, pageSize);
                if (result?.Items != null)
                {
                    allWarehouses.AddRange(result.Items);
                }
                page++;
            } while (result?.HasNextPage == true);
            
            _warehouses = allWarehouses;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading warehouses");
            Snackbar.Add(
                TranslationService.GetTranslation("messages.warehousesLoadFailed", "Errore nel caricamento dei magazzini"),
                Severity.Error);
            _warehouses = new();
        }
    }

    private async Task OnWarehouseChanged()
    {
        _selectedLocationId = null;
        _locations.Clear();

        if (_selectedWarehouseId.HasValue)
        {
            _isLoadingLocations = true;
            try
            {
                var allLocations = new List<StorageLocationDto>();
                var page = 1;
                var pageSize = 100;
                PagedResult<StorageLocationDto>? result;
                
                do
                {
                    result = await StorageLocationService.GetStorageLocationsByWarehouseAsync(
                        _selectedWarehouseId.Value, page, pageSize);
                    if (result?.Items != null)
                    {
                        allLocations.AddRange(result.Items);
                    }
                    page++;
                } while (result?.HasNextPage == true);
                
                _locations = allLocations;
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Error loading locations for warehouse {WarehouseId}", _selectedWarehouseId);
                Snackbar.Add(
                    TranslationService.GetTranslation("messages.locationsLoadFailed", "Errore nel caricamento delle ubicazioni"),
                    Severity.Error);
                _locations = new();
            }
            finally
            {
                _isLoadingLocations = false;
            }
        }
    }

    private async Task CalculatePreviewAsync()
    {
        // Validate dates
        if (_fromDate.HasValue && _toDate.HasValue && _fromDate > _toDate)
        {
            Snackbar.Add(
                TranslationService.GetTranslation("stockReconciliation.error.invalidDateRange", 
                    "La data 'Da' non pu√≤ essere successiva alla data 'A'"),
                Severity.Warning);
            return;
        }

        _isCalculating = true;
        try
        {
            var request = new StockReconciliationRequestDto
            {
                FromDate = _fromDate,
                ToDate = _toDate,
                WarehouseId = _selectedWarehouseId,
                LocationId = _selectedLocationId,
                ProductId = _selectedProduct?.Id,
                IncludeDocuments = _includeDocuments,
                IncludeInventories = _includeInventories,
                OnlyWithDiscrepancies = _onlyWithDiscrepancies,
                DiscrepancyThreshold = _discrepancyThreshold
            };

            _reconciliationResult = await StockReconciliationService.CalculateReconciliationAsync(request);
            _selectedItems.Clear();
            _expandedRows.Clear();

            if (_reconciliationResult != null)
            {
                Snackbar.Add(
                    TranslationService.GetTranslation("stockReconciliation.success.calculated", "Calculation completed successfully"),
                    Severity.Success);
            }
            else
            {
                Snackbar.Add(
                    TranslationService.GetTranslation("stockReconciliation.error.calculationFailed", "Error during reconciliation calculation"),
                    Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error calculating stock reconciliation");
            Snackbar.Add(
                TranslationService.GetTranslation("stockReconciliation.error.calculationFailed", "Error during reconciliation calculation"),
                Severity.Error);
        }
        finally
        {
            _isCalculating = false;
        }
    }

    private async Task ApplyReconciliationAsync()
    {
        if (_reconciliationResult == null || _selectedItems.Count == 0)
            return;

        var parameters = new DialogParameters
        {
            { "ItemsToUpdate", _selectedItems.Count },
            { "Summary", _reconciliationResult.Summary },
            { "CreateAdjustmentMovements", true }
        };

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Medium,
            FullWidth = true,
            CloseButton = true
        };

        var dialog = await DialogService.ShowAsync<StockReconciliationConfirmDialog>(
            TranslationService.GetTranslation("stockReconciliation.confirmTitle", "Confirm Application"),
            parameters,
            options);

        var result = await dialog.Result;

        if (result != null && !result.Canceled && result.Data is StockReconciliationConfirmResult confirmResult)
        {
            await ExecuteApplyReconciliationAsync(confirmResult.Reason, confirmResult.CreateAdjustmentMovements);
        }
    }

    private async Task ExecuteApplyReconciliationAsync(string reason, bool createAdjustmentMovements)
    {
        _isApplying = true;
        try
        {
            var request = new StockReconciliationApplyRequestDto
            {
                ItemsToApply = _selectedItems.Select(x => x.StockId).ToList(),
                Reason = reason,
                CreateAdjustmentMovements = createAdjustmentMovements
            };

            var result = await StockReconciliationService.ApplyReconciliationAsync(request);

            if (result != null && result.Success)
            {
                Snackbar.Add(
                    TranslationService.GetTranslationFormatted(
                        "stockReconciliation.success.applied",
                        "Reconciliation applied successfully. Updated {0} stock records.",
                        result.UpdatedCount),
                    Severity.Success);

                // Reload the preview
                await CalculatePreviewAsync();
            }
            else
            {
                Snackbar.Add(
                    TranslationService.GetTranslation("stockReconciliation.error.applyFailed", "Error applying reconciliation"),
                    Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error applying stock reconciliation");
            Snackbar.Add(
                TranslationService.GetTranslation("stockReconciliation.error.applyFailed", "Error applying reconciliation"),
                Severity.Error);
        }
        finally
        {
            _isApplying = false;
        }
    }

    private async Task ExportReportAsync()
    {
        if (_reconciliationResult == null)
            return;

        _isExporting = true;
        try
        {
            var request = new StockReconciliationRequestDto
            {
                FromDate = _fromDate,
                ToDate = _toDate,
                WarehouseId = _selectedWarehouseId,
                LocationId = _selectedLocationId,
                ProductId = _selectedProduct?.Id,
                DiscrepancyThreshold = _discrepancyThreshold,
                IncludeDocuments = _includeDocuments,
                IncludeInventories = _includeInventories,
                OnlyWithDiscrepancies = _onlyWithDiscrepancies
            };

            var fileData = await StockReconciliationService.ExportReconciliationAsync(request);

            if (fileData != null && fileData.Length > 0)
            {
                // Download file using JavaScript interop
                var fileName = $"StockReconciliation_{DateTime.UtcNow:yyyyMMdd_HHmmss}.xlsx";
                var base64 = Convert.ToBase64String(fileData);
                await JSRuntime.InvokeVoidAsync("downloadFileFromBase64", fileName, base64);

                Snackbar.Add(
                    TranslationService.GetTranslation("messages.exportSuccess", "Esportazione completata"),
                    Severity.Success);
            }
            else
            {
                Snackbar.Add(
                    TranslationService.GetTranslation("stockReconciliation.error.exportFailed", "Error exporting report"),
                    Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error exporting stock reconciliation report");
            Snackbar.Add(
                TranslationService.GetTranslation("stockReconciliation.error.exportFailed", "Error exporting report"),
                Severity.Error);
        }
        finally
        {
            _isExporting = false;
        }
    }

    private void SelectAll()
    {
        if (_reconciliationResult?.Items != null)
        {
            _selectedItems = _reconciliationResult.Items.ToHashSet();
        }
    }

    private void DeselectAll()
    {
        _selectedItems.Clear();
    }

    private void ClearFilters()
    {
        // Reset dates to default values (start of year + today)
        var today = DateTime.Today;
        _fromDate = new DateTime(today.Year, 1, 1);
        _toDate = today;
        
        _selectedWarehouseId = null;
        _selectedLocationId = null;
        _selectedProduct = null; // Reset product filter
        _discrepancyThreshold = 10m; // Reset threshold to default
        _includeDocuments = true;
        _includeInventories = true;
        _onlyWithDiscrepancies = false;
        _reconciliationResult = null;
        _selectedItems.Clear();
        _locations.Clear();
    }

    private void ToggleRowExpansion(StockReconciliationItemDto item)
    {
        if (_expandedRows.Contains(item))
        {
            _expandedRows.Remove(item);
        }
        else
        {
            _expandedRows.Add(item);
        }
    }

    private Color GetSeverityColor(ReconciliationSeverity severity)
    {
        return severity switch
        {
            ReconciliationSeverity.Correct => Color.Success,
            ReconciliationSeverity.Minor => Color.Warning,
            ReconciliationSeverity.Major => Color.Error,
            ReconciliationSeverity.Missing => Color.Dark,
            _ => Color.Default
        };
    }
}
