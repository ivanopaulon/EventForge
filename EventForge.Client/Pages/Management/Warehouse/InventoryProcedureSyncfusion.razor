@page "/warehouse/inventory-procedure-syncfusion"
@using Microsoft.AspNetCore.Authorization
@using EventForge.DTOs.Common
@using EventForge.DTOs.Warehouse
@using EventForge.DTOs.Products
@using EventForge.Client.Shared.Components
@using EventForge.Client.Shared.Components.Warehouse
@using EventForge.Client.Shared.Components.Warehouse.SyncfusionComponents
@using Syncfusion.Blazor.Buttons
@using Syncfusion.Blazor.DropDowns
@using Syncfusion.Blazor.ProgressBar
@using Syncfusion.Blazor.Inputs
@attribute [Authorize(Roles = "SuperAdmin,Admin,Manager,Operator")]
@inject IProductService ProductService
@inject IInventoryService InventoryService
@inject IInventoryFastService InventoryFastService
@inject IStorageLocationService StorageLocationService
@inject IWarehouseService WarehouseService
@inject MudBlazor.ISnackbar Snackbar
@inject ITranslationService TranslationService
@inject ILogger<InventoryProcedureSyncfusion> Logger
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@inject IInventorySessionService InventorySessionService
@inject ISfInventoryStateManager StateManager

<PageTitle>@TranslationService.GetTranslation("warehouse.inventoryProcedureSyncfusion", "Procedura Inventario (Syncfusion)")</PageTitle>

<div class="container-fluid mt-4" style="max-width: 1400px;">
    <div class="row mb-4">
        <div class="col-md-8">
            <h4>
                <span class="e-icons e-barcode-scanner me-2"></span>
                @TranslationService.GetTranslation("warehouse.inventoryProcedureSyncfusion", "Procedura Inventario (Syncfusion)")
            </h4>
            <p class="text-muted mb-0">
                @TranslationService.GetTranslation("warehouse.syncfusionProcedureDescription", "Implementazione pilota con componenti Syncfusion per valutazione")
            </p>
        </div>
        <div class="col-md-4 text-end">
            <SfButton IconCss="e-icons e-list-unordered" 
                     CssClass="e-outline me-2"
                     OnClick="@(() => NavigationManager.NavigateTo("/warehouse/inventory-list"))">
                @TranslationService.GetTranslation("warehouse.viewInventory", "Visualizza Inventario")
            </SfButton>
            <SfButton IconCss="e-icons e-lightning" 
                     CssClass="e-outline"
                     OnClick="@(() => NavigationManager.NavigateTo("/warehouse/inventory-procedure-fast"))">
                @TranslationService.GetTranslation("warehouse.fastProcedure", "Procedura Rapida")
            </SfButton>
        </div>
    </div>

    @if (_uiState.IsLoading)
    {
        <div class="sf-card p-3 mb-4">
            <SfProgressBar Type="ProgressType.Linear" Value="40" IsIndeterminate="true" />
        </div>
    }

    <!-- Inventory Header Component (session banner, stats, confirmations) -->
    <SfFastInventoryHeader 
        CurrentDocument="@_currentDocument"
        SessionStartTime="@_sessionStartTime"
        PositiveAdjustmentsCount="@GetPositiveAdjustmentsCount()"
        NegativeAdjustmentsCount="@GetNegativeAdjustmentsCount()"
        SessionDuration="@GetSessionDuration()"
        ShowFinalizeConfirmation="@_uiState.ShowFinalizeConfirmation"
        ShowCancelConfirmation="@_uiState.ShowCancelConfirmation"
        OnExport="@ExportInventoryDocument"
        OnRequestFinalize="@FinalizeInventory"
        OnConfirmFinalize="@ConfirmFinalizeAsync"
        OnCancelFinalize="@(() => _uiState.ShowFinalizeConfirmation = false)"
        OnRequestCancel="@CancelInventorySession"
        OnConfirmCancel="@ConfirmCancelAsync"
        OnCancelCancel="@(() => _uiState.ShowCancelConfirmation = false)" />

    <!-- Storage Facility Selection -->
    <div class="sf-card p-4 mb-4">
        <h6 class="mb-3">
            <span class="e-icons e-warehouse"></span>
            @TranslationService.GetTranslation("warehouse.selectStorageFacility", "Seleziona Magazzino")
        </h6>
        
        <div class="row g-3">
            <div class="col-md-8">
                <SfDropDownList TValue="Guid?" TItem="StorageFacilityDto"
                               Value="@_selectedStorageFacilityId"
                               ValueChanged="@((Guid? value) => _selectedStorageFacilityId = value)"
                               DataSource="@_storageFacilities"
                               Placeholder="@TranslationService.GetTranslation("warehouse.storageFacility", "Magazzino")"
                               FloatLabelType="FloatLabelType.Auto"
                               Enabled="@(_currentDocument == null)">
                    <DropDownListFieldSettings Value="Id" Text="Name" />
                </SfDropDownList>
            </div>
            <div class="col-md-4">
                @if (_currentDocument == null)
                {
                    <SfButton IconCss="e-icons e-play" CssClass="e-success w-100"
                             OnClick="@StartInventorySession"
                             Disabled="@(!_selectedStorageFacilityId.HasValue)">
                        @TranslationService.GetTranslation("warehouse.startSession", "Avvia Sessione")
                    </SfButton>
                }
            </div>
        </div>
    </div>

    @if (_currentDocument != null)
    {
        <!-- Scanner Component -->
        <SfFastScanner @ref="_scannerComponent"
                      BarcodeValue="@_inputState.ScannedBarcode"
                      BarcodeValueChanged="@((value) => _inputState.ScannedBarcode = value)"
                      FastConfirmEnabledValue="@_fastConfirmEnabled"
                      FastConfirmEnabledValueChanged="@((value) => _fastConfirmEnabled = value)"
                      OnBarcodeScanned="@HandleBarcodeScanned"
                      OnSearch="@HandleBarcodeScanned" />

        <!-- Product Not Found Panel (conditional) -->
        @if (_uiState.ShowAssignPanel)
        {
            <SfFastNotFoundPanel 
                ScannedBarcode="@_uiState.AssignPanelBarcode"
                SelectedProduct="@_uiState.AssignSelectedProduct"
                SelectedProductChanged="@((product) => _uiState.AssignSelectedProduct = product)"
                CodeType="@_uiState.AssignCodeType"
                CodeTypeChanged="@((value) => _uiState.AssignCodeType = value)"
                Code="@_uiState.AssignCode"
                CodeChanged="@((value) => _uiState.AssignCode = value)"
                AlternativeDescription="@_uiState.AssignAlternativeDescription"
                AlternativeDescriptionChanged="@((value) => _uiState.AssignAlternativeDescription = value)"
                IsLoading="@_uiState.IsLoading"
                OnSearchProducts="@SearchProducts"
                OnAssign="@AssignBarcodeToProduct"
                OnSkip="@SkipBarcodeAssignment"
                OnOpenProducts="@(() => NavigationManager.NavigateTo("/product-management/products"))" />
        }

        <!-- Product Entry Inline (conditional) -->
        @if (_inputState.CurrentProduct != null && !_uiState.ShowAssignPanel)
        {
            <SfFastProductEntryInline @ref="_productEntryComponent"
                                     CurrentProduct="@_inputState.CurrentProduct"
                                     SelectedLocation="@_inputState.SelectedLocation"
                                     SelectedLocationChanged="@((location) => _inputState.SelectedLocation = location)"
                                     SelectedLocationId="@_inputState.SelectedLocationId"
                                     SelectedLocationIdChanged="@((id) => _inputState.SelectedLocationId = id)"
                                     QuantityValue="@_inputState.Quantity"
                                     QuantityValueChanged="@((value) => _inputState.Quantity = value ?? 1)"
                                     NotesValue="@_inputState.Notes"
                                     NotesValueChanged="@((value) => _inputState.Notes = value)"
                                     ShowUndo="@(_inputState.LastAddedRow != null)"
                                     LastAddedRow="@_inputState.LastAddedRow"
                                     OnSearchLocations="@SearchLocations"
                                     OnConfirm="@ConfirmAndNext"
                                     OnUndo="@UndoLastRow" />
        }

        <!-- Inventory Grid -->
        <SfFastInventoryGrid 
            Rows="@_currentDocument.Rows"
            TotalItems="@_currentDocument.TotalItems"
            ShowOnlyAdjustmentsValue="@_showOnlyAdjustments"
            ShowOnlyAdjustmentsValueChanged="@((value) => _showOnlyAdjustments = value)"
            EditingRowId="@_uiState.EditingRowId"
            EditQuantityValue="@_uiState.EditQuantity"
            EditQuantityValueChanged="@((value) => _uiState.EditQuantity = value)"
            EditNotesValue="@_uiState.EditNotes"
            EditNotesValueChanged="@((value) => _uiState.EditNotes = value)"
            ConfirmDeleteRowId="@_uiState.ConfirmDeleteRowId"
            OnBeginEdit="@BeginEditRow"
            OnSaveEdit="@SaveEditRow"
            OnCancelEdit="@CancelEditRow"
            OnRequestDelete="@RequestDeleteRow"
            OnConfirmDelete="@ConfirmDeleteRow"
            OnCancelDelete="@CancelDeleteRow" />

        <!-- Operation Log Panel -->
        <SfOperationLogPanel LogEntries="@_operationLog" />
    }
</div>

@code {
    // Component references
    private SfFastScanner? _scannerComponent;
    private SfFastProductEntryInline? _productEntryComponent;
    
    // State management using SfInventoryStateManager
    private InventoryInputState _inputState = new();
    private InventoryUIState _uiState = new();
    
    // Document and session fields (not part of ephemeral state)
    private List<StorageLocationDto> _locations = new();
    private List<StorageFacilityDto> _storageFacilities = new();
    private Guid? _selectedStorageFacilityId;
    private InventoryDocumentDto? _currentDocument = null;
    private DateTime _sessionStartTime = DateTime.UtcNow;
    private bool _showOnlyAdjustments = false;
    private bool _fastConfirmEnabled = true;
    
    // Location search constants
    private const int MaxLocationSearchResults = 20;
    
    // Operation log for audit trail
    private List<OperationLogEntry> _operationLog = new();

    private void AddOperationLog(string message, string details = "", string type = "Info")
    {
        var logEntry = StateManager.CreateLogEntry(type, message, details);
        _operationLog.Add(logEntry);

        Logger.LogInformation("Inventory Operation: {Message} - {Details}", message, details);
    }

    private int GetPositiveAdjustmentsCount()
    {
        if (_currentDocument?.Rows == null) return 0;
        return _currentDocument.Rows.Count(r => r.AdjustmentQuantity.HasValue && r.AdjustmentQuantity > 0);
    }

    private int GetNegativeAdjustmentsCount()
    {
        if (_currentDocument?.Rows == null) return 0;
        return _currentDocument.Rows.Count(r => r.AdjustmentQuantity.HasValue && r.AdjustmentQuantity < 0);
    }

    private string GetSessionDuration()
    {
        if (_currentDocument == null) return "00:00";
        
        var duration = DateTime.UtcNow - _sessionStartTime;
        return $"{(int)duration.TotalMinutes:D2}:{duration.Seconds:D2}";
    }

    /// <summary>
    /// Updates the session state in localStorage after each operation to keep it in sync.
    /// This method is called automatically after operations that modify the document (add/edit/delete rows)
    /// to ensure user progress is persisted. Failures are logged but do not interrupt the workflow.
    /// </summary>
    /// <remarks>
    /// Should be called after:
    /// - Adding inventory rows
    /// - Editing inventory rows
    /// - Deleting inventory rows
    /// - Changing FastConfirmEnabled or ShowOnlyAdjustments settings
    /// </remarks>
    private async Task UpdateSessionStateAsync()
    {
        if (_currentDocument == null) return;

        try
        {
            var sessionState = new InventorySessionState
            {
                DocumentId = _currentDocument.Id,
                DocumentNumber = _currentDocument.Number,
                WarehouseId = _selectedStorageFacilityId,
                SessionStartTime = _sessionStartTime,
                LastActivityTime = DateTime.UtcNow,
                FastConfirmEnabled = _fastConfirmEnabled,
                ShowOnlyAdjustments = _showOnlyAdjustments
            };

            await InventorySessionService.SaveSessionAsync(sessionState);
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "Error updating session state");
            // Don't throw - this is not critical for the workflow
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await Task.WhenAll(LoadStorageFacilities(), LoadLocations(), LoadProducts());
        await RestoreInventorySessionAsync();
        StateHasChanged();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && _scannerComponent != null && _currentDocument != null)
        {
            await _scannerComponent.FocusAsync();
        }
    }

    private List<ProductDto> _allProducts = new();

    private async Task LoadProducts()
    {
        _uiState.IsLoading = true;
        try
        {
            var result = await ProductService.GetProductsAsync(1, 100);
            if (result != null)
            {
                _allProducts = result.Items.ToList();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading products");
        }
        finally
        {
            _uiState.IsLoading = false;
        }
    }

    private async Task LoadStorageFacilities()
    {
        _uiState.IsLoading = true;
        try
        {
            var result = await WarehouseService.GetStorageFacilitiesAsync(1, 100);
            if (result?.Items != null)
            {
                _storageFacilities = result.Items.ToList();
                if (_storageFacilities.Count == 1)
                {
                    _selectedStorageFacilityId = _storageFacilities[0].Id;
                }
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading storage facilities");
            Snackbar.Add(TranslationService.GetTranslation("warehouse.loadFacilitiesError", "Errore nel caricamento dei magazzini"), MudBlazor.Severity.Error);
        }
        finally
        {
            _uiState.IsLoading = false;
        }
    }

    private async Task LoadLocations()
    {
        _uiState.IsLoading = true;
        try
        {
            var result = await StorageLocationService.GetStorageLocationsAsync(1, 100);
            if (result?.Items != null)
            {
                _locations = result.Items.ToList();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading storage locations");
            Snackbar.Add(TranslationService.GetTranslation("warehouse.loadLocationsError", "Errore nel caricamento ubicazioni"), MudBlazor.Severity.Error);
        }
        finally
        {
            _uiState.IsLoading = false;
        }
    }

    private async Task RestoreInventorySessionAsync()
    {
        try
        {
            InventoryDocumentDto? document = null;
            Guid? warehouseId = null;
            DateTime? sessionStartTime = null;
            string restorationSource = "localStorage";

            // Step 1: Try to restore from localStorage
            var sessionState = await InventorySessionService.LoadSessionAsync();
            if (sessionState != null)
            {
                // Try to load the inventory document from the server
                document = await InventoryService.GetInventoryDocumentAsync(sessionState.DocumentId);
                
                if (document != null && document.Status == "Open")
                {
                    warehouseId = sessionState.WarehouseId;
                    sessionStartTime = sessionState.SessionStartTime;
                }
                else
                {
                    // Document not found or already finalized, clear the invalid session
                    await InventorySessionService.ClearSessionAsync();
                    document = null;
                    Logger.LogInformation("Inventory session in localStorage is invalid (document not found or finalized)");
                }
            }

            // Step 2: If localStorage restoration failed, try to get the most recent open document from server
            if (document == null)
            {
                document = await InventoryService.GetMostRecentOpenInventoryDocumentAsync();
                if (document != null)
                {
                    warehouseId = document.WarehouseId;
                    sessionStartTime = document.CreatedAt;
                    restorationSource = "server";
                    
                    // Save this session to localStorage for future use
                    await InventorySessionService.SaveSessionAsync(new InventorySessionState
                    {
                        DocumentId = document.Id,
                        DocumentNumber = document.Number,
                        WarehouseId = warehouseId,
                        SessionStartTime = sessionStartTime ?? DateTime.UtcNow
                    });
                    
                    Logger.LogInformation("Inventory session restored from most recent open document: {DocumentId}", document.Id);
                }
            }

            // Step 3: If we have a valid document to restore, apply it
            if (document != null)
            {
                _currentDocument = document;
                _selectedStorageFacilityId = warehouseId;
                _sessionStartTime = sessionStartTime ?? DateTime.UtcNow;
                
                // Restore session preferences if available
                if (sessionState != null && restorationSource == "localStorage")
                {
                    _fastConfirmEnabled = sessionState.FastConfirmEnabled;
                    _showOnlyAdjustments = sessionState.ShowOnlyAdjustments;
                }
                
                string sourceMessage = restorationSource == "localStorage" 
                    ? TranslationService.GetTranslation("warehouse.sessionRestoredFromCache", "Sessione ripristinata dalla cache")
                    : TranslationService.GetTranslation("warehouse.sessionRestoredFromServer", "Sessione ripristinata dal server (documento più recente aperto)");
                
                AddOperationLog(
                    TranslationService.GetTranslation("warehouse.sessionRestored", "Sessione di inventario ripristinata"),
                    $"{sourceMessage} - Documento #{_currentDocument.Number} - {_currentDocument.TotalItems} articoli - {_currentDocument.Rows?.Count ?? 0} righe",
                    "Success"
                );
                
                Snackbar.Add(
                    TranslationService.GetTranslation("warehouse.sessionRestored", "Sessione di inventario ripristinata"), 
                    MudBlazor.Severity.Info
                );
                
                Logger.LogInformation("Inventory session restored from {Source}: Document {DocumentId} with {RowCount} rows", restorationSource, _currentDocument.Id, _currentDocument.Rows?.Count ?? 0);
                
                // Force UI update to ensure rows are displayed
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error restoring inventory session");
            // Clear invalid session only if it exists in localStorage
            try
            {
                if (await InventorySessionService.HasActiveSessionAsync())
                {
                    await InventorySessionService.ClearSessionAsync();
                }
            }
            catch (Exception clearEx)
            {
                Logger.LogError(clearEx, "Error clearing invalid session");
            }
        }
    }

    private async Task StartInventorySession()
    {
        if (!_selectedStorageFacilityId.HasValue) return;

        _uiState.IsLoading = true;
        try
        {
            _sessionStartTime = DateTime.UtcNow;

            var createDto = new CreateInventoryDocumentDto
            {
                WarehouseId = _selectedStorageFacilityId,
                InventoryDate = DateTime.UtcNow,
                Notes = $"Inventario del {DateTime.Now:dd/MM/yyyy HH:mm}"
            };

            _currentDocument = await InventoryService.StartInventoryDocumentAsync(createDto);
            
            if (_currentDocument != null)
            {
                await InventorySessionService.SaveSessionAsync(new InventorySessionState
                {
                    DocumentId = _currentDocument.Id,
                    DocumentNumber = _currentDocument.Number,
                    WarehouseId = _selectedStorageFacilityId.Value,
                    SessionStartTime = _sessionStartTime,
                    LastActivityTime = DateTime.UtcNow,
                    FastConfirmEnabled = _fastConfirmEnabled,
                    ShowOnlyAdjustments = _showOnlyAdjustments
                });

                AddOperationLog(
                    TranslationService.GetTranslation("warehouse.sessionStarted", "Sessione di inventario avviata"),
                    $"Documento #{_currentDocument.Number}",
                    "Success"
                );

                Snackbar.Add(TranslationService.GetTranslation("warehouse.sessionStarted", "Sessione di inventario avviata"), MudBlazor.Severity.Success);
                
                await Task.Delay(100);
                if (_scannerComponent != null)
                {
                    await _scannerComponent.FocusAsync();
                }
            }
            else
            {
                Snackbar.Add(TranslationService.GetTranslation("warehouse.startSessionError", "Errore nell'avvio della sessione"), MudBlazor.Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error starting inventory session");
            Snackbar.Add(TranslationService.GetTranslation("warehouse.startSessionError", "Errore nell'avvio della sessione"), MudBlazor.Severity.Error);
            AddOperationLog(TranslationService.GetTranslation("warehouse.startSessionError", "Errore nell'avvio della sessione"), ex.Message, "Error");
        }
        finally
        {
            _uiState.IsLoading = false;
        }
    }

    private async Task HandleBarcodeScanned(string barcode)
    {
        if (string.IsNullOrWhiteSpace(barcode)) return;
        if (_currentDocument == null) return;

        _inputState.ScannedBarcode = barcode;
        _uiState.IsLoading = true;
        
        try
        {
            AddOperationLog(TranslationService.GetTranslation("warehouse.searchingProduct", "Ricerca prodotto"), $"Codice: {barcode}", "Info");

            // First, check if this is a repeated scan using the service
            var scanResult = InventoryFastService.HandleBarcodeScanned(
                barcode, 
                _inputState.CurrentProduct, 
                _inputState.SelectedLocationId, 
                _inputState.Quantity, 
                _fastConfirmEnabled);

            if (scanResult.Action == BarcodeScanAction.IncrementAndConfirm)
            {
                // Repeated scan with fast confirm enabled
                _inputState.Quantity = scanResult.NewQuantity;
                AddOperationLog(TranslationService.GetTranslation("warehouse.repeatedScanIncrement", "Scansione ripetuta, quantità incrementata"),
                    $"{_inputState.CurrentProduct!.Name} - Nuova quantità: {_inputState.Quantity}", "Info");
                await ConfirmAndNext();
                return;
            }
            else if (scanResult.Action == BarcodeScanAction.IncrementAndFocusQuantity)
            {
                // Repeated scan without fast confirm
                _inputState.Quantity = scanResult.NewQuantity;
                AddOperationLog(TranslationService.GetTranslation("warehouse.repeatedScanIncrement", "Scansione ripetuta, quantità incrementata"),
                    $"{_inputState.CurrentProduct!.Name} - Nuova quantità: {_inputState.Quantity}", "Info");
                StateHasChanged();
                if (_productEntryComponent != null)
                {
                    await Task.Delay(100);
                    await _productEntryComponent.FocusQuantityAsync();
                }
                return;
            }

            // Not a repeated scan - lookup the product
            var foundProduct = await ProductService.GetProductByCodeAsync(barcode);
            
            if (foundProduct != null)
            {
                _inputState.CurrentProduct = foundProduct;
                _uiState.ClearAssignPanel();
                Snackbar.Add(TranslationService.GetTranslation("warehouse.productFound", "Prodotto trovato: {0}", _inputState.CurrentProduct.Name), MudBlazor.Severity.Success);
                AddOperationLog(TranslationService.GetTranslation("warehouse.productFound", "Prodotto trovato"),
                    $"{_inputState.CurrentProduct.Name} ({_inputState.CurrentProduct.Code})", "Success");

                if (_locations?.Count == 1)
                {
                    _inputState.SelectedLocationId = _locations[0].Id;
                    _inputState.SelectedLocation = _locations[0];
                    StateHasChanged();
                    if (_productEntryComponent != null)
                    {
                        await Task.Delay(100);
                        await _productEntryComponent.FocusQuantityAsync();
                    }
                }
                else if (_productEntryComponent != null)
                {
                    StateHasChanged();
                    await Task.Delay(100);
                    await _productEntryComponent.FocusLocationAsync();
                }
                else
                {
                    StateHasChanged();
                }
            }
            else
            {
                // Product not found - show assignment panel using state manager
                _inputState.CurrentProduct = null;
                _uiState.OpenAssignPanel(barcode);
                
                AddOperationLog(TranslationService.GetTranslation("warehouse.productNotFound", "Prodotto non trovato"), 
                    $"Codice: {barcode}", "Warning");
                
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error handling barcode scan {Barcode}", barcode);
            Snackbar.Add(TranslationService.GetTranslation("warehouse.searchError", "Errore nella ricerca"), MudBlazor.Severity.Error);
            AddOperationLog(TranslationService.GetTranslation("warehouse.searchError", "Errore nella ricerca"), ex.Message, "Error");
        }
        finally
        {
            _uiState.IsLoading = false;
        }
    }

    private Task<IEnumerable<ProductDto>> SearchProducts(string searchTerm, CancellationToken token)
    {
        // Use the service for consistent search logic
        var results = InventoryFastService.SearchProducts(searchTerm, _allProducts, maxResults: 20);
        return Task.FromResult(results);
    }

    private async Task AssignBarcodeToProduct((Guid productId, string codeType, string code, string? altDesc) args)
    {
        _uiState.IsLoading = true;
        try
        {
            var createCodeDto = new CreateProductCodeDto
            {
                ProductId = args.productId,
                CodeType = args.codeType,
                Code = args.code,
                AlternativeDescription = args.altDesc,
                Status = ProductCodeStatus.Active
            };

            var result = await ProductService.CreateProductCodeAsync(createCodeDto);

            if (result != null)
            {
                var productName = _uiState.AssignSelectedProduct?.Name ?? "Product";
                Snackbar.Add(TranslationService.GetTranslation("products.barcodeAssignedSuccess", "Codice a barre assegnato con successo a {0}", productName), MudBlazor.Severity.Success);
                AddOperationLog(TranslationService.GetTranslation("products.barcodeAssigned", "Codice assegnato"), $"{productName} - Codice: {args.code}", "Success");

                _inputState.CurrentProduct = _uiState.AssignSelectedProduct;
                _uiState.ClearAssignPanel();

                if (_locations?.Count == 1)
                {
                    _inputState.SelectedLocationId = _locations[0].Id;
                    _inputState.SelectedLocation = _locations[0];
                    StateHasChanged();
                    if (_productEntryComponent != null)
                    {
                        await Task.Delay(100);
                        await _productEntryComponent.FocusQuantityAsync();
                    }
                }
                else if (_productEntryComponent != null)
                {
                    StateHasChanged();
                    await Task.Delay(100);
                    await _productEntryComponent.FocusLocationAsync();
                }
                else
                {
                    StateHasChanged();
                }
            }
            else
            {
                Snackbar.Add(TranslationService.GetTranslation("products.assignError", "Errore nell'assegnazione del codice"), MudBlazor.Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error assigning barcode to product");
            Snackbar.Add(TranslationService.GetTranslation("products.assignError", "Errore nell'assegnazione del codice"), MudBlazor.Severity.Error);
            AddOperationLog(TranslationService.GetTranslation("products.assignError", "Errore nell'assegnazione del codice"), ex.Message, "Error");
        }
        finally
        {
            _uiState.IsLoading = false;
        }
    }

    private async Task SkipBarcodeAssignment()
    {
        // Use state manager UI state method
        _uiState.ClearAssignPanel();
        ClearProductForm();
        
        if (_scannerComponent != null)
        {
            await _scannerComponent.FocusAsync();
        }
    }

    private Task<IEnumerable<StorageLocationDto>> SearchLocations(string value, CancellationToken token)
    {
        if (string.IsNullOrWhiteSpace(value))
            return Task.FromResult(_locations.Take(MaxLocationSearchResults));
        
        var results = _locations
            .Where(l => l.Code.Contains(value, StringComparison.OrdinalIgnoreCase) ||
                       (l.Description?.Contains(value, StringComparison.OrdinalIgnoreCase) ?? false))
            .Take(MaxLocationSearchResults);
        
        return Task.FromResult(results);
    }

    private async Task ConfirmAndNext()
    {
        // Use state manager validation
        if (!StateManager.ValidateInputState(_inputState))
        {
            Logger.LogWarning("Cannot confirm: input state validation failed");
            return;
        }
        
        await AddInventoryRow();
    }

    private async Task AddInventoryRow()
    {
        if (_currentDocument == null || _inputState.CurrentProduct == null || !_inputState.SelectedLocationId.HasValue || _inputState.Quantity <= 0) return;

        _uiState.IsLoading = true;
        try
        {
            var location = _locations.FirstOrDefault(l => l.Id == _inputState.SelectedLocationId.Value);
            var locationName = location?.Code ?? "N/A";

            // Use the service to determine if we should merge or create
            var operation = InventoryFastService.DetermineRowOperation(
                _currentDocument.Rows?.ToList(),
                _inputState.CurrentProduct.Id,
                _inputState.SelectedLocationId.Value,
                _inputState.Quantity,
                _inputState.Notes);

            InventoryDocumentDto? updatedDocument = null;

            if (operation.OperationType == RowOperationType.Update)
            {
                // Update existing row by summing quantities
                var updateDto = new UpdateInventoryDocumentRowDto 
                { 
                    Quantity = operation.NewQuantity, 
                    Notes = operation.CombinedNotes
                };
                
                updatedDocument = await InventoryService.UpdateInventoryDocumentRowAsync(
                    _currentDocument.Id, 
                    operation.ExistingRowId!.Value, 
                    updateDto);
                
                if (updatedDocument != null)
                {
                    var existingRow = _currentDocument.Rows?.FirstOrDefault(r => r.Id == operation.ExistingRowId.Value);
                    AddOperationLog(TranslationService.GetTranslation("warehouse.itemUpdated", "Quantità aggiornata"),
                        $"{_inputState.CurrentProduct.Name} - Ubicazione: {locationName} - Quantità precedente: {existingRow?.Quantity ?? 0} - Aggiunta: {_inputState.Quantity} - Nuova quantità: {operation.NewQuantity}" + 
                        (!string.IsNullOrEmpty(_inputState.Notes) ? $" - Note: {_inputState.Notes}" : ""), "Success");

                    Snackbar.Add(TranslationService.GetTranslation("warehouse.quantityUpdated", "Quantità aggiornata nel documento"), MudBlazor.Severity.Success);
                }
            }
            else
            {
                // Add new row
                var rowDto = new AddInventoryDocumentRowDto
                {
                    ProductId = _inputState.CurrentProduct.Id,
                    LocationId = _inputState.SelectedLocationId.Value,
                    Quantity = _inputState.Quantity,
                    Notes = _inputState.Notes
                };

                updatedDocument = await InventoryService.AddInventoryDocumentRowAsync(_currentDocument.Id, rowDto);
                
                if (updatedDocument != null)
                {
                    AddOperationLog(TranslationService.GetTranslation("warehouse.itemAdded", "Articolo aggiunto"),
                        $"{_inputState.CurrentProduct.Name} - Ubicazione: {locationName} - Quantità: {_inputState.Quantity}" + 
                        (!string.IsNullOrEmpty(_inputState.Notes) ? $" - Note: {_inputState.Notes}" : ""), "Success");

                    Snackbar.Add(TranslationService.GetTranslation("warehouse.itemAdded", "Articolo aggiunto al documento"), MudBlazor.Severity.Success);
                }
            }

            if (updatedDocument != null)
            {
                _currentDocument = updatedDocument;
                
                _inputState.LastAddedRow = _currentDocument.Rows?
                    .Where(r => r.ProductId == _inputState.CurrentProduct.Id && r.LocationId == _inputState.SelectedLocationId.Value)
                    .OrderByDescending(r => r.CreatedAt)
                    .FirstOrDefault();
                
                // Update session state to persist progress
                await UpdateSessionStateAsync();
                
                ClearProductForm();
                StateHasChanged();
            }
            else
            {
                Snackbar.Add(TranslationService.GetTranslation("warehouse.addItemError", "Errore nell'aggiunta dell'articolo"), MudBlazor.Severity.Error);
                AddOperationLog(TranslationService.GetTranslation("warehouse.addItemError", "Errore nell'aggiunta dell'articolo"), $"Prodotto: {_inputState.CurrentProduct.Name}", "Error");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error adding inventory row");
            Snackbar.Add(TranslationService.GetTranslation("warehouse.addItemError", "Errore nell'aggiunta dell'articolo"), MudBlazor.Severity.Error);
            AddOperationLog(TranslationService.GetTranslation("warehouse.addItemError", "Errore nell'aggiunta dell'articolo"), ex.Message, "Error");
        }
        finally
        {
            _uiState.IsLoading = false;
        }
    }

    private void ClearProductForm()
    {
        // Use the state manager to clear input state (except LastAddedRow for undo)
        _inputState.Clear();
        
        if (_scannerComponent != null)
        {
            _scannerComponent.ClearBarcode();
            InvokeAsync(async () => await _scannerComponent.FocusAsync());
        }
    }

    private async Task UndoLastRow()
    {
        if (_inputState.LastAddedRow == null || _currentDocument == null) return;

        _uiState.IsLoading = true;
        try
        {
            var updatedDocument = await InventoryService.DeleteInventoryDocumentRowAsync(_currentDocument.Id, _inputState.LastAddedRow.Id);
            
            if (updatedDocument != null)
            {
                _currentDocument = updatedDocument;
                
                AddOperationLog(
                    TranslationService.GetTranslation("warehouse.rowUndone", "Ultima riga annullata"),
                    $"{_inputState.LastAddedRow.ProductCode} - Q.tà: {_inputState.LastAddedRow.Quantity}",
                    "Info"
                );

                Snackbar.Add(TranslationService.GetTranslation("warehouse.rowUndone", "Ultima riga annullata"), MudBlazor.Severity.Info);
                _inputState.LastAddedRow = null;
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error undoing last row");
            Snackbar.Add(TranslationService.GetTranslation("warehouse.undoError", "Errore nell'annullamento"), MudBlazor.Severity.Error);
            AddOperationLog(TranslationService.GetTranslation("warehouse.undoError", "Errore nell'annullamento"), ex.Message, "Error");
        }
        finally
        {
            _uiState.IsLoading = false;
        }
    }

    // Grid edit/delete operations
    private void BeginEditRow(Guid rowId)
    {
        var row = _currentDocument?.Rows?.FirstOrDefault(r => r.Id == rowId);
        if (row == null) return;

        // Use state manager UI state method
        _uiState.BeginEdit(rowId, row.Quantity, row.Notes ?? string.Empty);
        StateHasChanged();
    }

    private async Task SaveEditRow(Guid rowId)
    {
        if (_currentDocument == null || _uiState.EditingRowId == null || !_uiState.EditQuantity.HasValue) return;

        var row = _currentDocument.Rows?.FirstOrDefault(r => r.Id == rowId);
        if (row == null) return;

        _uiState.IsLoading = true;
        try
        {
            var updateDto = new UpdateInventoryDocumentRowDto 
            { 
                Quantity = _uiState.EditQuantity.Value, 
                Notes = _uiState.EditNotes 
            };
            
            var updatedDocument = await InventoryService.UpdateInventoryDocumentRowAsync(_currentDocument.Id, row.Id, updateDto);

            if (updatedDocument != null)
            {
                _currentDocument = updatedDocument;

                AddOperationLog(
                    TranslationService.GetTranslation("warehouse.rowUpdated", "Riga aggiornata"),
                    $"{row.ProductCode} - Q.tà: {_uiState.EditQuantity.Value}",
                    "Success"
                );

                Snackbar.Add(TranslationService.GetTranslation("warehouse.rowUpdated", "Riga aggiornata"), MudBlazor.Severity.Success);
            }

            // Use state manager to clear edit state
            _uiState.ClearEditState();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error updating row");
            Snackbar.Add(TranslationService.GetTranslation("warehouse.updateError", "Errore nell'aggiornamento"), MudBlazor.Severity.Error);
            AddOperationLog(TranslationService.GetTranslation("warehouse.updateError", "Errore nell'aggiornamento"), ex.Message, "Error");
        }
        finally
        {
            _uiState.IsLoading = false;
        }
    }

    private void CancelEditRow()
    {
        // Use state manager UI state method
        _uiState.ClearEditState();
        StateHasChanged();
    }

    private void RequestDeleteRow(Guid rowId)
    {
        _uiState.ConfirmDeleteRowId = rowId;
        StateHasChanged();
    }

    private async Task ConfirmDeleteRow(Guid rowId)
    {
        if (_currentDocument == null) return;

        var row = _currentDocument.Rows?.FirstOrDefault(r => r.Id == rowId);
        if (row == null) return;

        _uiState.IsLoading = true;
        try
        {
            var updatedDocument = await InventoryService.DeleteInventoryDocumentRowAsync(_currentDocument.Id, row.Id);
            
            if (updatedDocument != null)
            {
                _currentDocument = updatedDocument;
                if (_inputState.LastAddedRow?.Id == row.Id) _inputState.LastAddedRow = null;

                AddOperationLog(
                    TranslationService.GetTranslation("warehouse.rowDeleted", "Riga eliminata"),
                    $"{row.ProductCode} - Q.tà: {row.Quantity}",
                    "Info"
                );

                Snackbar.Add(TranslationService.GetTranslation("warehouse.rowDeleted", "Riga eliminata"), MudBlazor.Severity.Info);
            }
            
            // Use state manager to clear confirmation state
            _uiState.ConfirmDeleteRowId = null;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error deleting row");
            Snackbar.Add(TranslationService.GetTranslation("warehouse.deleteError", "Errore nell'eliminazione"), MudBlazor.Severity.Error);
            AddOperationLog(TranslationService.GetTranslation("warehouse.deleteError", "Errore nell'eliminazione"), ex.Message, "Error");
        }
        finally
        {
            _uiState.IsLoading = false;
        }
    }

    private void CancelDeleteRow()
    {
        // Use state manager UI state method to clear confirmations
        _uiState.ConfirmDeleteRowId = null;
        StateHasChanged();
    }

    // Finalize and Cancel operations
    private void FinalizeInventory()
    {
        if (_currentDocument == null) return;
        _uiState.ShowFinalizeConfirmation = true;
        StateHasChanged();
    }

    private async Task ConfirmFinalizeAsync()
    {
        if (_currentDocument == null) return;

        _uiState.ShowFinalizeConfirmation = false;
        _uiState.IsLoading = true;
        try
        {
            AddOperationLog(TranslationService.GetTranslation("warehouse.finalizingInventory", "Finalizzazione inventario in corso"),
                $"Documento #{_currentDocument.Number} con {_currentDocument.TotalItems} articoli", "Info");

            var finalizedDocument = await InventoryService.FinalizeInventoryDocumentAsync(_currentDocument.Id);

            if (finalizedDocument != null)
            {
                var sessionDuration = DateTime.UtcNow - _sessionStartTime;
                AddOperationLog(TranslationService.GetTranslation("warehouse.inventoryFinalized", "Inventario finalizzato con successo"),
                    $"Durata sessione: {(int)sessionDuration.TotalMinutes} minuti", "Success");
                Snackbar.Add(TranslationService.GetTranslation("warehouse.inventoryFinalized", "Inventario finalizzato con successo"), MudBlazor.Severity.Success);
                await InventorySessionService.ClearSessionAsync();
                _currentDocument = null;
                ClearProductForm();
            }
            else
            {
                Snackbar.Add(TranslationService.GetTranslation("warehouse.finalizeError", "Errore nella finalizzazione"), MudBlazor.Severity.Error);
                AddOperationLog(TranslationService.GetTranslation("warehouse.finalizeError", "Errore nella finalizzazione"), "", "Error");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error finalizing inventory");
            Snackbar.Add(TranslationService.GetTranslation("warehouse.finalizeError", "Errore nella finalizzazione"), MudBlazor.Severity.Error);
            AddOperationLog(TranslationService.GetTranslation("warehouse.finalizeError", "Errore nella finalizzazione"), ex.Message, "Error");
        }
        finally
        {
            _uiState.IsLoading = false;
        }
    }

    private void CancelInventorySession()
    {
        if (_currentDocument == null) return;
        _uiState.ShowCancelConfirmation = true;
        StateHasChanged();
    }

    private async Task ConfirmCancelAsync()
    {
        if (_currentDocument == null) return;

        _uiState.ShowCancelConfirmation = false;
        try
        {
            AddOperationLog(
                TranslationService.GetTranslation("warehouse.sessionCanceled", "Sessione annullata"),
                $"Documento #{_currentDocument.Number} - {_currentDocument.TotalItems} articoli scartati",
                "Warning"
            );
            
            await InventorySessionService.ClearSessionAsync();
            _currentDocument = null;
            ClearProductForm();
            
            Snackbar.Add(TranslationService.GetTranslation("warehouse.sessionCanceled", "Sessione annullata"), MudBlazor.Severity.Info);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error cancelling inventory session");
            Snackbar.Add(TranslationService.GetTranslation("warehouse.cancelError", "Errore nell'annullamento"), MudBlazor.Severity.Error);
            AddOperationLog(TranslationService.GetTranslation("warehouse.cancelError", "Errore nell'annullamento"), ex.Message, "Error");
        }
    }

    private async Task ExportInventoryDocument()
    {
        if (_currentDocument == null) return;

        try
        {
            AddOperationLog(
                TranslationService.GetTranslation("warehouse.exportStarted", "Esportazione documento iniziata"),
                $"Documento #{_currentDocument.Number} - {_currentDocument.TotalItems} articoli",
                "Info"
            );

            var csv = new System.Text.StringBuilder();
            csv.AppendLine("Codice Prodotto,Nome Prodotto,Ubicazione,Quantità Contata,Aggiustamento,Note,Data/Ora");
            
            foreach (var row in _currentDocument.Rows)
            {
                csv.AppendLine($"\"{row.ProductCode}\",\"{row.ProductName}\",\"{row.LocationName}\",{row.Quantity},{row.AdjustmentQuantity ?? 0},\"{row.Notes ?? ""}\",\"{row.CreatedAt.ToLocalTime():dd/MM/yyyy HH:mm:ss}\"");
            }

            var fileName = $"Inventario_{_currentDocument.Number}_{DateTime.Now:yyyyMMdd_HHmmss}.csv";
            await JSRuntime.InvokeVoidAsync("downloadCsv", fileName, csv.ToString());

            Snackbar.Add(TranslationService.GetTranslation("warehouse.exportSuccess", "Documento esportato con successo"), MudBlazor.Severity.Success);

            AddOperationLog(
                TranslationService.GetTranslation("warehouse.exportCompleted", "Esportazione completata"),
                $"File: {fileName}",
                "Success"
            );
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error exporting inventory document");
            Snackbar.Add(TranslationService.GetTranslation("warehouse.exportError", "Errore durante l'esportazione"), MudBlazor.Severity.Error);
            AddOperationLog(TranslationService.GetTranslation("warehouse.exportFailed", "Esportazione fallita"), ex.Message, "Error");
        }
    }
}
