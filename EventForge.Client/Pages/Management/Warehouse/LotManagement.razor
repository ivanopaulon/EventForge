@page "/warehouse/lot-management"
@using Microsoft.AspNetCore.Authorization
@using EventForge.DTOs.Common
@using EventForge.DTOs.Warehouse
@using EventForge.Client.Shared.Components
@using EventForge.Client.Extensions
@using MudBlazor
@attribute [Authorize(Roles = "SuperAdmin,Admin,Manager,Operator")]
@inject IAuthService AuthService
@inject ILotService LotService
@inject IAuthenticationDialogService AuthenticationDialogService
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject ITranslationService TranslationService
@inject ILogger<LotManagement> Logger
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime

<PageTitle>@TranslationService.GetTranslation("warehouse.lotManagement", "Gestione Lotti")</PageTitle>
<PageLoadingOverlay Visible="_isLoading || _isLoadingLots"
                    Message="@(_isLoading ? TranslationService.GetTranslation("messages.loadingPage", "Caricamento pagina...") : TranslationService.GetTranslation("common.loading", "Caricamento..."))" />

@if (!_isLoading)
{
    <div class="lot-page-root">
        <!-- Quick Filters -->
        <QuickFilters TItem="LotDto"
                      Items="_lots"
                      Filters="_quickFilters"
                      OnFilterSelected="@HandleQuickFilter"
                      ShowCount="true" />

        <div class="eftable-wrapper">
            <EFTable @ref="_efTable"
                 TItem="LotDto"
                 Items="_filteredLots"
                 MultiSelection="true"
                 SelectedItems="_selectedLots"
                 SelectedItemsChanged="_selectedItemsChangedCallback"
                 OnRowClick="@HandleRowClick"
                 IsLoading="_isLoadingLots"
                 ComponentKey="LotManagement"
                 InitialColumnConfigurations="_initialColumns"
                 AllowDragDropGrouping="true"
                 ShowExport="true"
                 ShowExportDialog="true"
                 ExcelFileName="Lotti"
                 IsDataFiltered="@HasActiveFilters()"
                 TotalItemsCount="@_lots.Count">
            <ToolBarContent>
                <MudText Typo="Typo.h5">
                    @TranslationService.GetTranslation("warehouse.lotManagement", "Gestione Lotti")
                </MudText>
                <MudSpacer />
                <MudTextField @bind-Value="_searchText"
                              @bind-Value:after="OnSearchChanged"
                              Label="@TranslationService.GetTranslation("common.search", "Cerca")"
                              Placeholder="@TranslationService.GetTranslation("warehouse.searchPlaceholder", "Cerca per codice...")"
                              Variant="Variant.Outlined"
                              Adornment="Adornment.End"
                              AdornmentIcon="@Icons.Material.Outlined.Search"
                              Clearable="true"
                              Class="ef-input" />
                <MudSelect @bind-Value="_selectedStatus"
                           @bind-Value:after="OnFilterChanged"
                           Label="@TranslationService.GetTranslation("warehouse.status", "Stato")"
                           Variant="Variant.Outlined"
                           Clearable="true"
                           Class="ml-2"
                           Style="min-width: 150px;">
                    <MudSelectItem Value="@("Active")">@TranslationService.GetTranslation("warehouse.active", "Attivo")</MudSelectItem>
                    <MudSelectItem Value="@("Blocked")">@TranslationService.GetTranslation("warehouse.blocked", "Bloccato")</MudSelectItem>
                    <MudSelectItem Value="@("Expired")">@TranslationService.GetTranslation("warehouse.expired", "Scaduto")</MudSelectItem>
                    <MudSelectItem Value="@("Recalled")">@TranslationService.GetTranslation("warehouse.recalled", "Richiamato")</MudSelectItem>
                </MudSelect>
                <ManagementTableToolbar ShowSelectionBadge="true"
                                        SelectedCount="@_selectedLots.Count"
                                        ShowRefresh="true"
                                        ShowCreate="true"
                                        ShowDelete="false"
                                        CreateTooltip="common.create"
                                        IsDisabled="_isLoadingLots"
                                        OnRefresh="@RefreshData"
                                        OnCreate="@OpenCreateDialog" />
            </ToolBarContent>
            <HeaderContent Context="columnConfigurations">
                @foreach (var column in columnConfigurations.Where(c => c.IsVisible).OrderBy(c => c.Order))
                {
                    @if (column.PropertyName == "Code")
                    {
                        <EFTableColumnHeader TItem="LotDto" PropertyName="Code" OnDragStartCallback="@_efTable.HandleColumnDragStart">
                            <MudTableSortLabel SortBy="@(new Func<LotDto, object>(x => x.Code))">@TranslationService.GetTranslation("warehouse.lotCode", "Codice Lotto")</MudTableSortLabel>
                        </EFTableColumnHeader>
                    }
                    else if (column.PropertyName == "ProductName")
                    {
                        <EFTableColumnHeader TItem="LotDto" PropertyName="ProductName" OnDragStartCallback="@_efTable.HandleColumnDragStart">
                            <MudTableSortLabel SortBy="@(new Func<LotDto, object>(x => x.ProductName ?? string.Empty))">@TranslationService.GetTranslation("warehouse.product", "Prodotto")</MudTableSortLabel>
                        </EFTableColumnHeader>
                    }
                    else if (column.PropertyName == "Status")
                    {
                        <EFTableColumnHeader TItem="LotDto" PropertyName="Status" OnDragStartCallback="@_efTable.HandleColumnDragStart">
                            <MudTableSortLabel SortBy="@(new Func<LotDto, object>(x => x.Status))">@TranslationService.GetTranslation("warehouse.status", "Stato")</MudTableSortLabel>
                        </EFTableColumnHeader>
                    }
                    else if (column.PropertyName == "QualityStatus")
                    {
                        <EFTableColumnHeader TItem="LotDto" PropertyName="QualityStatus" OnDragStartCallback="@_efTable.HandleColumnDragStart">
                            <MudTableSortLabel SortBy="@(new Func<LotDto, object>(x => x.QualityStatus))">@TranslationService.GetTranslation("warehouse.qualityStatus", "Qualità")</MudTableSortLabel>
                        </EFTableColumnHeader>
                    }
                    else if (column.PropertyName == "AvailableQuantity")
                    {
                        <EFTableColumnHeader TItem="LotDto" PropertyName="AvailableQuantity" OnDragStartCallback="@_efTable.HandleColumnDragStart">
                            <MudTableSortLabel SortBy="@(new Func<LotDto, object>(x => x.AvailableQuantity))">@TranslationService.GetTranslation("warehouse.availableQuantity", "Disponibile")</MudTableSortLabel>
                        </EFTableColumnHeader>
                    }
                    else if (column.PropertyName == "ExpiryDate")
                    {
                        <EFTableColumnHeader TItem="LotDto" PropertyName="ExpiryDate" OnDragStartCallback="@_efTable.HandleColumnDragStart">
                            <MudTableSortLabel InitialDirection="SortDirection.Descending" SortBy="@(new Func<LotDto, object>(x => x.ExpiryDate ?? DateTime.MaxValue))">@TranslationService.GetTranslation("warehouse.expiryDate", "Data Scadenza")</MudTableSortLabel>
                        </EFTableColumnHeader>
                    }
                }
                <MudTh Class="text-center" Style="min-width:120px;">@TranslationService.GetTranslation("common.actions", "Azioni")</MudTh>
            </HeaderContent>

            <RowTemplate Context="item">
                @{
                    var visibleColumns = _efTable?.ColumnConfigurations?.Where(c => c.IsVisible).OrderBy(c => c.Order).ToList() ?? _initialColumns.Where(c => c.IsVisible).OrderBy(c => c.Order).ToList();
                }
                @foreach (var column in visibleColumns)
                {
                    @if (column.PropertyName == "Code")
                    {
                        <MudTd DataLabel="@TranslationService.GetTranslation("warehouse.lotCode", "Codice Lotto")">
                            <div>
                                <MudText Typo="Typo.body2" Style="font-weight: 600;">@item.Code</MudText>
                                @if (!string.IsNullOrEmpty(item.Barcode))
                                {
                                    <MudText Typo="Typo.caption" Class="mud-text-secondary">@item.Barcode</MudText>
                                }
                            </div>
                        </MudTd>
                    }
                    else if (column.PropertyName == "ProductName")
                    {
                        <MudTd DataLabel="@TranslationService.GetTranslation("warehouse.product", "Prodotto")">
                            <div>
                                <MudText Typo="Typo.body2">@item.ProductName</MudText>
                                @if (!string.IsNullOrEmpty(item.ProductCode))
                                {
                                    <MudText Typo="Typo.caption" Class="mud-text-secondary">@item.ProductCode</MudText>
                                }
                            </div>
                        </MudTd>
                    }
                    else if (column.PropertyName == "Status")
                    {
                        <MudTd DataLabel="@TranslationService.GetTranslation("warehouse.status", "Stato")">
                            <MudChip T="string" Size="Size.Small" Color="@GetStatusColor(item.Status)">
                                @TranslationService.GetTranslation($"warehouse.{item.Status.ToLower()}", item.Status)
                            </MudChip>
                        </MudTd>
                    }
                    else if (column.PropertyName == "QualityStatus")
                    {
                        <MudTd DataLabel="@TranslationService.GetTranslation("warehouse.qualityStatus", "Qualità")">
                            <MudChip T="string" Size="Size.Small" Color="@GetQualityStatusColor(item.QualityStatus)">
                                @TranslationService.GetTranslation($"warehouse.{item.QualityStatus.ToLower()}", item.QualityStatus)
                            </MudChip>
                        </MudTd>
                    }
                    else if (column.PropertyName == "AvailableQuantity")
                    {
                        <MudTd DataLabel="@TranslationService.GetTranslation("warehouse.availableQuantity", "Disponibile")">
                            <MudText Typo="Typo.body2">@item.AvailableQuantity.ToString("N2")</MudText>
                        </MudTd>
                    }
                    else if (column.PropertyName == "ExpiryDate")
                    {
                        <MudTd DataLabel="@TranslationService.GetTranslation("warehouse.expiryDate", "Data Scadenza")">
                            @if (item.ExpiryDate.HasValue)
                            {
                                var daysToExpiry = (item.ExpiryDate.Value - DateTime.Now).Days;
                                <MudText Typo="Typo.body2" Color="@(daysToExpiry <= 30 ? Color.Warning : Color.Default)">
                                    @item.ExpiryDate.Value.ToString("dd/MM/yyyy")
                                </MudText>
                                @if (daysToExpiry <= 30 && daysToExpiry > 0)
                                {
                                    <MudText Typo="Typo.caption" Color="Color.Warning">
                                        @TranslationService.GetTranslation("warehouse.expireInDays", "{0} giorni", daysToExpiry)
                                    </MudText>
                                }
                                else if (daysToExpiry <= 0)
                                {
                                    <MudText Typo="Typo.caption" Color="Color.Error">
                                        @TranslationService.GetTranslation("warehouse.expired", "Scaduto")
                                    </MudText>
                                }
                            }
                            else
                            {
                                <MudText Typo="Typo.body2" Class="mud-text-secondary">-</MudText>
                            }
                        </MudTd>
                    }
                }
                <MudTd DataLabel="@TranslationService.GetTranslation("common.actions", "Azioni")" Class="text-center">
                    <MudButtonGroup Variant="Variant.Text" Size="Size.Small">
                        <MudIconButton Icon="@Icons.Material.Outlined.Edit" 
                                       Color="Color.Primary" 
                                       Size="Size.Small"
                                       OnClick="@(() => OpenEditDialog(item))" />
                        <MudIconButton Icon="@Icons.Material.Outlined.Block" 
                                       Color="Color.Error" 
                                       Size="Size.Small"
                                       OnClick="@(() => BlockLot(item))"
                                       Disabled="@(item.Status == "Blocked")" />
                        <MudIconButton Icon="@Icons.Material.Outlined.Info" 
                                       Color="Color.Info" 
                                       Size="Size.Small"
                                       OnClick="@(() => ViewDetails(item))" />
                    </MudButtonGroup>
                </MudTd>
            </RowTemplate>

            <NoRecordsContent>
                <div class="text-center pa-2 pa-sm-3 pa-md-4">
                    <MudIcon Icon="@Icons.Material.Outlined.QrCode" Size="Size.Medium" Class="mb-4 mud-text-secondary" />
                    <MudText Typo="Typo.h6" Class="mb-2">
                        @(_lots.Any() ?
                            TranslationService.GetTranslation("warehouse.noLotsMatchFilters", "Nessun lotto corrisponde ai filtri applicati") :
                            TranslationService.GetTranslation("common.noRecords", "Nessun record trovato"))
                    </MudText>
                    @if (_lots.Any())
                    {
                        <MudButton Variant="Variant.Text"
                                   Color="Color.Primary"
                                   StartIcon="@Icons.Material.Outlined.Clear"
                                   OnClick="@ClearFilters">
                            @TranslationService.GetTranslation("action.clearFilters", "Cancella filtri")
                        </MudButton>
                    }
                </div>
            </NoRecordsContent>
            </EFTable>

            <!-- Pagination -->
            @if (_pagedResult != null && _pagedResult.TotalPages > 0)
            {
                <MudDivider Class="my-4" />
                <div class="d-flex justify-center align-center flex-wrap gap-4">
                    @if (_pagedResult.TotalPages > 1)
                    {
                        <MudPagination Count="_pagedResult.TotalPages" 
                                       Selected="_currentPage" 
                                       Color="Color.Primary"
                                       Size="Size.Medium"
                                       ShowFirstButton="true"
                                       ShowLastButton="true"
                                       SelectedChanged="@OnPageChanged" />
                    }
                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                        @if (_pagedResult.TotalPages > 1)
                        {
                            @TranslationService.GetTranslation("pagination.info", 
                                "Pagina {0} di {1} - Totale: {2} lotti", 
                                _currentPage, _pagedResult.TotalPages, _pagedResult.TotalCount)
                        }
                        else
                        {
                            @TranslationService.GetTranslation("pagination.singlePage", 
                                "Totale: {0} lotti", 
                                _pagedResult.TotalCount)
                        }
                    </MudText>
                </div>
            }
        </div>
    </div>
}



@code {
    // UI State Management
    private bool _isLoading = true;
    private bool _isLoadingLots = false;

    // Filter and search state
    private string _searchText = string.Empty;
    private string? _selectedStatus;
    private string? _selectedQualityStatus;
    private CancellationTokenSource? _searchDebounceCts;

    // Pagination state
    private PagedResult<LotDto>? _pagedResult;
    private int _currentPage = 1;
    private int _pageSize = 20;
    
    // Data collections
    private List<LotDto> _lots = new();
    private HashSet<LotDto> _selectedLots = new();

    // EFTable reference
    private EFTable<LotDto> _efTable = null!;

    // Column configuration for EFTable
    private List<EFTableColumnConfiguration> _initialColumns = new()
    {
        new() { PropertyName = "Code", DisplayName = "Codice Lotto", IsVisible = true, Order = 0, IsSearchable = true },
        new() { PropertyName = "ProductName", DisplayName = "Prodotto", IsVisible = true, Order = 1, IsSearchable = true },
        new() { PropertyName = "Status", DisplayName = "Stato", IsVisible = true, Order = 2, IsSearchable = false },
        new() { PropertyName = "QualityStatus", DisplayName = "Qualità", IsVisible = true, Order = 3, IsSearchable = false },
        new() { PropertyName = "AvailableQuantity", DisplayName = "Disponibile", IsVisible = true, Order = 4, IsSearchable = false },
        new() { PropertyName = "ExpiryDate", DisplayName = "Data Scadenza", IsVisible = true, Order = 5, IsSearchable = false }
    };

    // Quick Filters
    private List<QuickFilter<LotDto>> _quickFilters = new()
    {
        new() 
        { 
            Id = "all", 
            Label = "Tutti",
            Predicate = _ => true,
            Description = "Mostra tutti i lotti"
        },
        new() 
        { 
            Id = "active", 
            Label = "Attivi",
            Predicate = l => l.Status == "Active",
            Color = Color.Success,
            Icon = Icons.Material.Outlined.CheckCircle,
            Description = "Lotti attivi"
        },
        new() 
        { 
            Id = "blocked", 
            Label = "Bloccati",
            Predicate = l => l.Status == "Blocked",
            Color = Color.Warning,
            Icon = Icons.Material.Outlined.Block,
            Description = "Lotti bloccati"
        },
        new() 
        { 
            Id = "expired", 
            Label = "Scaduti",
            Predicate = l => l.Status == "Expired",
            Color = Color.Error,
            Icon = Icons.Material.Outlined.EventBusy,
            Description = "Lotti scaduti"
        },
        new() 
        { 
            Id = "recalled", 
            Label = "Richiamati",
            Predicate = l => l.Status == "Recalled",
            Color = Color.Error,
            Icon = Icons.Material.Outlined.NotificationImportant,
            Description = "Lotti richiamati"
        },
        new() 
        { 
            Id = "expiring_soon", 
            Label = "In Scadenza",
            Predicate = l => l.ExpiryDate.HasValue && l.ExpiryDate.Value <= DateTime.UtcNow.AddDays(30) && l.ExpiryDate.Value > DateTime.UtcNow,
            Color = Color.Warning,
            Icon = Icons.Material.Outlined.Warning,
            Description = "Lotti in scadenza entro 30 giorni"
        }
    };
    
    private QuickFilter<LotDto>? _activeQuickFilter;

    private EventCallback<HashSet<LotDto>> _selectedItemsChangedCallback => EventCallback.Factory.Create<HashSet<LotDto>>(this, OnSelectedItemsChanged);

    /// <summary>
    /// Handles quick filter selection
    /// </summary>
    private void HandleQuickFilter(QuickFilter<LotDto>? filter)
    {
        _activeQuickFilter = filter;
        StateHasChanged();
    }

    /// <summary>
    /// Computed property for filtered lots based on search criteria.
    /// </summary>
    private IEnumerable<LotDto> _filteredLots => 
        _lots.Where(l => FilterLot(l));

    /// <summary>
    /// Filters a lot based on all active filters
    /// </summary>
    private bool FilterLot(LotDto lot)
    {
        // Quick filter
        if (_activeQuickFilter != null && _activeQuickFilter.Predicate != null)
        {
            if (!_activeQuickFilter.Predicate(lot))
                return false;
        }

        // Configurable multi-column search
        if (!lot.MatchesSearchInColumns(
            _searchText,
            _initialColumns.Where(c => c.IsSearchable).Select(c => c.PropertyName)))
            return false;

        // Status filter (inline filter for compatibility)
        if (!string.IsNullOrEmpty(_selectedStatus) && lot.Status != _selectedStatus)
            return false;

        // Quality status filter (inline filter for compatibility)
        if (!string.IsNullOrEmpty(_selectedQualityStatus) && lot.QualityStatus != _selectedQualityStatus)
            return false;

        return true;
    }

    /// <summary>
    /// Handles selection changes from EFTable
    /// </summary>
    private void OnSelectedItemsChanged(HashSet<LotDto> items)
    {
        _selectedLots = items;
        StateHasChanged();
    }

    /// <summary>
    /// Handles row click - navigates to lot detail page
    /// </summary>
    private void HandleRowClick(TableRowClickEventArgs<LotDto> args)
    {
        // Ctrl+Click or Cmd+Click opens in new tab
        if (args.MouseEventArgs.CtrlKey || args.MouseEventArgs.MetaKey)
        {
            JSRuntime.InvokeVoidAsync("open", $"/warehouse/lots/{args.Item.Id}", "_blank");
            return;
        }

        // Normal click navigates in same tab
        NavigationManager.NavigateTo($"/warehouse/lots/{args.Item.Id}");
    }

    /// <summary>
    /// Component initialization.
    /// </summary>
    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Check authentication
            var isAuthenticated = await AuthService.IsAuthenticatedAsync();
            if (!isAuthenticated)
            {
                await ShowLoginDialogAsync();
                return;
            }

            // Load data
            await LoadData();
        }
        catch (Exception ex)
        {
            Snackbar.Add(TranslationService.GetTranslation("warehouse.loadingPageError", "Errore nel caricamento della pagina: {0}", ex.Message), Severity.Error);
            Logger.LogError(ex, "Error loading lots page");
        }
        finally
        {
            _isLoading = false;
        }
    }

    /// <summary>
    /// Loads lot data.
    /// </summary>
    private async Task LoadData()
    {
        try
        {
            _isLoadingLots = true;
            
            _pagedResult = await LotService.GetLotsAsync(_currentPage, _pageSize, null, _selectedStatus);
            if (_pagedResult != null)
            {
                _lots = _pagedResult.Items.ToList();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading lots");
            Snackbar.Add(TranslationService.GetTranslation("common.errorLoading", "Errore nel caricamento"), Severity.Error);
        }
        finally
        {
            _isLoadingLots = false;
        }
    }

    /// <summary>
    /// Clears all active filters.
    /// </summary>
    private void ClearFilters()
    {
        _searchText = string.Empty;
        _activeQuickFilter = null;
        _selectedStatus = null;
        _selectedQualityStatus = null;
        StateHasChanged();
    }

    private async Task OnSearchChanged()
    {
        // Cancel previous debounce if any
        _searchDebounceCts?.Cancel();
        _searchDebounceCts = new CancellationTokenSource();
        var token = _searchDebounceCts.Token;
        
        try
        {
            await Task.Delay(300, token); // Debounce with cancellation
            if (!token.IsCancellationRequested)
            {
                StateHasChanged();
            }
        }
        catch (OperationCanceledException)
        {
            // Swallow cancellation
        }
    }

    private void OnFilterChanged()
    {
        StateHasChanged();
    }

    private async Task RefreshData()
    {
        await LoadData();
        Snackbar.Add(TranslationService.GetTranslation("common.refreshed", "Dati aggiornati"), Severity.Success);
    }

    private async Task OnPageChanged(int page)
    {
        _currentPage = page;
        await LoadData();
    }

    private async Task ShowLoginDialogAsync()
    {
        var result = await AuthenticationDialogService.ShowLoginDialogAsync();
        if (result)
        {
            // Reload the page after successful login
            await OnInitializedAsync();
        }
    }

    private void OpenCreateDialog()
    {
        // TODO: Implement create dialog
        Snackbar.Add(TranslationService.GetTranslation("common.notImplemented", "Funzionalità non ancora implementata"), Severity.Info);
    }

    private void OpenEditDialog(LotDto lot)
    {
        // TODO: Implement edit dialog
        Snackbar.Add(TranslationService.GetTranslation("common.notImplemented", "Funzionalità non ancora implementata"), Severity.Info);
    }

    private async Task BlockLot(LotDto lot)
    {
        // TODO: Implement block dialog with reason
        var result = await LotService.BlockLotAsync(lot.Id, "Blocked via UI");
        if (result)
        {
            Snackbar.Add(TranslationService.GetTranslation("warehouse.lotBlocked", "Lotto bloccato"), Severity.Success);
            await RefreshData();
        }
        else
        {
            Snackbar.Add(TranslationService.GetTranslation("common.error", "Errore"), Severity.Error);
        }
    }

    private void ViewDetails(LotDto lot)
    {
        // TODO: Navigate to lot details page
        NavigationManager.NavigateTo($"/warehouse/lots/{lot.Id}");
    }

    private Color GetStatusColor(string status) => status switch
    {
        "Active" => Color.Success,
        "Blocked" => Color.Error,
        "Expired" => Color.Warning,
        "Recalled" => Color.Error,
        _ => Color.Default
    };

    private Color GetQualityStatusColor(string qualityStatus) => qualityStatus switch
    {
        "Approved" => Color.Success,
        "Rejected" => Color.Error,
        "Pending" => Color.Warning,
        "OnHold" => Color.Info,
        _ => Color.Default
    };

    /// <summary>
    /// Checks if any filters are currently active
    /// </summary>
    private bool HasActiveFilters()
    {
        return !string.IsNullOrWhiteSpace(_searchText)
            || _activeQuickFilter != null
            || !string.IsNullOrEmpty(_selectedStatus)
            || !string.IsNullOrEmpty(_selectedQualityStatus);
    }
}