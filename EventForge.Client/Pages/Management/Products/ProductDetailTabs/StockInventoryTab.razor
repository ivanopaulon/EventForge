@using EventForge.DTOs.Products
@using EventForge.DTOs.Documents
@using EventForge.DTOs.Common
@using EventForge.DTOs.Warehouse
@using EventForge.Client.Services
@using EventForge.Client.Shared.Components.Warehouse
@inject ITranslationService TranslationService
@inject IDocumentHeaderService DocumentHeaderService
@inject IStockService StockService
@inject IProductService ProductService
@inject ILogger<StockInventoryTab> Logger

<MudStack Spacing="3">
    <MudPaper Elevation="1" Class="pa-4">
        <MudText Typo="Typo.h6" Class="mb-3">
            <MudIcon Icon="@Icons.Material.Outlined.Warehouse" Class="mr-2" />
            @TranslationService.GetTranslation("product.stockInfo", "Informazioni Magazzino")
        </MudText>

        <!-- Two column layout: procurement data (left) and stock summary (right) -->
        <MudGrid Spacing="3">
            <MudItem xs="12" md="6">
                <MudPaper Elevation="0" Class="pa-3" Style="height:100%; border: 1px solid rgba(0,0,0,0.12); border-radius:4px;">
                    <MudText Typo="Typo.subtitle1" Class="mb-3">
                        <MudIcon Icon="@Icons.Material.Outlined.Inventory" Class="mr-1" Size="Size.Small" />
                        @TranslationService.GetTranslation("product.procurementData", "Dati Approvvigionamento")
                    </MudText>
                    <MudGrid Spacing="2">
                        <MudItem xs="12" sm="6">
                            <MudNumericField Value="@(Product.ReorderPoint ?? 0)"
                                             Label="@TranslationService.GetTranslation("field.reorderPoint", "Punto di Riordino")"
                                             Variant="Variant.Outlined"
                                             ReadOnly="true"
                                             Min="0" 
                                             Format="N2"
                                             HelperText="@TranslationService.GetTranslation("helper.reorderPoint", "Livello di riordino")" />
                        </MudItem>

                        <MudItem xs="12" sm="6">
                            <MudNumericField Value="@(Product.SafetyStock ?? 0)"
                                             Label="@TranslationService.GetTranslation("field.safetyStock", "Scorta di Sicurezza")"
                                             Variant="Variant.Outlined"
                                             ReadOnly="true"
                                             Min="0" 
                                             Format="N2"
                                             HelperText="@TranslationService.GetTranslation("helper.safetyStock", "Scorta minima")" />
                        </MudItem>

                        <MudItem xs="12" sm="6">
                            <MudNumericField Value="@(Product.TargetStockLevel ?? 0)"
                                             Label="@TranslationService.GetTranslation("field.targetStockLevel", "Livello Obiettivo")"
                                             Variant="Variant.Outlined"
                                             ReadOnly="true"
                                             Min="0" 
                                             Format="N2"
                                             HelperText="@TranslationService.GetTranslation("helper.targetStockLevel", "Stock target")" />
                        </MudItem>

                        <MudItem xs="12" sm="6">
                            <MudNumericField Value="@(Product.AverageDailyDemand ?? 0)"
                                             Label="@TranslationService.GetTranslation("field.averageDailyDemand", "Domanda Giornaliera")"
                                             Variant="Variant.Outlined"
                                             ReadOnly="true"
                                             Min="0" 
                                             Format="N2"
                                             HelperText="@TranslationService.GetTranslation("helper.averageDailyDemand", "Media giornaliera")" />
                        </MudItem>
                    </MudGrid>
                </MudPaper>
            </MudItem>

            <MudItem xs="12" md="6">
                <MudPaper Elevation="0" Class="pa-3" Style="height:100%; border: 1px solid rgba(0,0,0,0.12); border-radius:4px;">
                    <MudText Typo="Typo.subtitle1" Class="mb-3">
                        <MudIcon Icon="@Icons.Material.Outlined.Store" Class="mr-1" Size="Size.Small" />
                        @TranslationService.GetTranslation("product.availabilityStock", "Disponibilità e Giacenza")
                    </MudText>
                    @if (_isLoadingStock)
                    {
                        <div class="d-flex justify-center pa-4">
                            <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
                        </div>
                    }
                    else if (_stockLevels?.Any() == true)
                    {
                        <MudTable Items="@_stockLevels" Hover="true" Striped="true" Dense="true" Class="mb-0" GroupBy="@_groupDefinition">
                            <HeaderContent>
                                <MudTh>@TranslationService.GetTranslation("warehouse.warehouse", "Magazzino")</MudTh>
                                <MudTh>@TranslationService.GetTranslation("warehouse.location", "Ubicazione")</MudTh>
                                <MudTh>@TranslationService.GetTranslation("warehouse.lot", "Lotto")</MudTh>
                                <MudTh Class="text-right">@TranslationService.GetTranslation("warehouse.quantity", "Quantità")</MudTh>
                                <MudTh Class="text-right">@TranslationService.GetTranslation("warehouse.reserved", "Riservata")</MudTh>
                                <MudTh Class="text-right">@TranslationService.GetTranslation("warehouse.available", "Disponibile")</MudTh>
                                <MudTh>@TranslationService.GetTranslation("warehouse.lastMovement", "Ultimo Movimento")</MudTh>
                            </HeaderContent>
                            <GroupHeaderTemplate>
                                <MudTh colspan="7" Class="mud-table-cell-custom-group">
                                    <MudIcon Icon="@Icons.Material.Outlined.Warehouse" Size="Size.Small" Class="mr-2" />
                                    <strong>@($"{context.Key ?? TranslationService.GetTranslation("warehouse.unknownWarehouse", "Magazzino Sconosciuto")}")</strong>
                                    <MudChip T="string" Size="Size.Small" Color="Color.Info" Class="ml-2">
                                        @context.Items.Sum(x => x.AvailableQuantity).ToString("N2") @TranslationService.GetTranslation("warehouse.available", "disponibili")
                                    </MudChip>
                                </MudTh>
                            </GroupHeaderTemplate>
                            <RowTemplate>
                                <MudTd>@(context.WarehouseName ?? "-")</MudTd>
                                <MudTd>
                                    <MudIcon Icon="@Icons.Material.Outlined.LocationOn" Size="Size.Small" Class="mr-1" />
                                    @(context.StorageLocationCode ?? "-")
                                </MudTd>
                                <MudTd>@(context.LotCode ?? "-")</MudTd>
                                <MudTd Class="text-right">@context.Quantity.ToString("N2")</MudTd>
                                <MudTd Class="text-right">@context.ReservedQuantity.ToString("N2")</MudTd>
                                <MudTd Class="text-right">
                                    <strong>@context.AvailableQuantity.ToString("N2")</strong>
                                </MudTd>
                                <MudTd>@(context.LastMovementDate?.ToString("dd/MM/yyyy") ?? "-")</MudTd>
                            </RowTemplate>
                        </MudTable>
                    }
                    else
                    {
                        <MudAlert Severity="Severity.Info" Class="mb-0 mt-2">
                            @TranslationService.GetTranslation("product.noStockFound", "Nessuna giacenza trovata per questo prodotto")
                        </MudAlert>
                    }
                </MudPaper>
            </MudItem>
        </MudGrid>
    </MudPaper>

    <!-- Stock Trend Chart -->
    <StockTrendChart StockTrend="@_stockTrend" IsLoading="@_isLoadingTrend" />

    <!-- Document History Section -->
    <MudPaper Elevation="1" Class="pa-4">
        <MudText Typo="Typo.h6" Class="mb-3">
            <MudIcon Icon="@Icons.Material.Outlined.Description" Class="mr-2" />
            @TranslationService.GetTranslation("product.documentHistory", "Storico Documenti")
        </MudText>

        <!-- Filters -->
        <MudPaper Elevation="0" Class="pa-3 mb-3" Style="background-color: var(--mud-palette-background-grey);">
            <MudGrid Spacing="2">
                <MudItem xs="12" sm="6" md="3">
                    <MudDatePicker @bind-Date="_fromDate"
                                   Label="@TranslationService.GetTranslation("filter.fromDate", "Da Data")"
                                   Variant="Variant.Outlined"
                                   Clearable="true"
                                   DateFormat="dd/MM/yyyy" />
                </MudItem>
                <MudItem xs="12" sm="6" md="3">
                    <MudDatePicker @bind-Date="_toDate"
                                   Label="@TranslationService.GetTranslation("filter.toDate", "A Data")"
                                   Variant="Variant.Outlined"
                                   Clearable="true"
                                   DateFormat="dd/MM/yyyy" />
                </MudItem>
                <MudItem xs="12" sm="6" md="4">
                    <MudTextField @bind-Value="_customerNameFilter"
                                  Label="@TranslationService.GetTranslation("filter.customerSupplier", "Cliente/Fornitore")"
                                  Variant="Variant.Outlined"
                                  Clearable="true" />
                </MudItem>
                <MudItem xs="12" sm="6" md="2" Class="d-flex align-end">
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               StartIcon="@Icons.Material.Outlined.FilterAlt"
                               OnClick="LoadDocumentsAsync"
                               FullWidth="true">
                        @TranslationService.GetTranslation("common.filter", "Filtra")
                    </MudButton>
                </MudItem>
            </MudGrid>
        </MudPaper>

        @if (_isLoadingDocuments)
        {
            <div class="d-flex justify-center pa-4">
                <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
            </div>
        }
        else if (_documentMovements?.Items?.Any() == true)
        {
            <MudTable Items="@_documentMovements.Items" Hover="true" Striped="true" Dense="true" Class="mb-4">
                <HeaderContent>
                    <MudTh>@TranslationService.GetTranslation("field.number", "Numero")</MudTh>
                    <MudTh>@TranslationService.GetTranslation("field.date", "Data")</MudTh>
                    <MudTh>@TranslationService.GetTranslation("field.type", "Tipo")</MudTh>
                    <MudTh Class="mud-hidden-sm-down">@TranslationService.GetTranslation("field.businessParty", "Cliente/Fornitore")</MudTh>
                    <MudTh Class="text-right">@TranslationService.GetTranslation("field.quantity", "Quantità")</MudTh>
                    <MudTh Class="mud-hidden-md-down">@TranslationService.GetTranslation("field.unitOfMeasure", "UM")</MudTh>
                    <MudTh Class="text-center">@TranslationService.GetTranslation("field.movementType", "Movimento")</MudTh>
                    <MudTh Class="mud-hidden-sm-down">@TranslationService.GetTranslation("field.warehouse", "Magazzino")</MudTh>
                    <MudTh>@TranslationService.GetTranslation("field.status", "Stato")</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="@TranslationService.GetTranslation("field.number", "Numero")">@context.DocumentNumber</MudTd>
                    <MudTd DataLabel="@TranslationService.GetTranslation("field.date", "Data")">@context.DocumentDate.ToString("dd/MM/yyyy")</MudTd>
                    <MudTd DataLabel="@TranslationService.GetTranslation("field.type", "Tipo")">@context.DocumentTypeName</MudTd>
                    <MudTd DataLabel="@TranslationService.GetTranslation("field.businessParty", "Cliente/Fornitore")" Class="mud-hidden-sm-down">@(context.BusinessPartyName ?? "-")</MudTd>
                    <MudTd Class="text-right" DataLabel="@TranslationService.GetTranslation("field.quantity", "Quantità")">
                        <strong>@context.Quantity.ToString("N2")</strong>
                    </MudTd>
                    <MudTd DataLabel="@TranslationService.GetTranslation("field.unitOfMeasure", "UM")" Class="mud-hidden-md-down">@(context.UnitOfMeasure ?? "-")</MudTd>
                    <MudTd Class="text-center" DataLabel="@TranslationService.GetTranslation("field.movementType", "Movimento")">
                        @if (context.IsStockIncrease)
                        {
                            <MudChip T="string" Size="Size.Small" Color="Color.Success" Icon="@Icons.Material.Filled.ArrowUpward">
                                @TranslationService.GetTranslation("movement.stockIncrease", "Carico")
                            </MudChip>
                        }
                        else
                        {
                            <MudChip T="string" Size="Size.Small" Color="Color.Error" Icon="@Icons.Material.Filled.ArrowDownward">
                                @TranslationService.GetTranslation("movement.stockDecrease", "Scarico")
                            </MudChip>
                        }
                    </MudTd>
                    <MudTd DataLabel="@TranslationService.GetTranslation("field.warehouse", "Magazzino")" Class="mud-hidden-sm-down">@(context.WarehouseName ?? "-")</MudTd>
                    <MudTd DataLabel="@TranslationService.GetTranslation("field.status", "Stato")">
                        <MudChip T="string" Size="Size.Small" Color="GetStatusColorFromString(context.Status)">
                            @GetStatusTextFromString(context.Status)
                        </MudChip>
                    </MudTd>
                </RowTemplate>
            </MudTable>

            <div class="d-flex justify-space-between align-center">
                <MudText Typo="Typo.body2" Class="mud-text-secondary">
                    @TranslationService.GetTranslation("pagination.showing", "Mostrando") 
                    @((_documentMovements.Page -1) * _documentMovements.PageSize +1) - 
                    @Math.Min(_documentMovements.Page * _documentMovements.PageSize, _documentMovements.TotalCount) 
                    @TranslationService.GetTranslation("pagination.of", "di") 
                    @_documentMovements.TotalCount
                </MudText>
                <MudPagination Count="@((int)((_documentMovements.TotalCount + _documentMovements.PageSize -1) / _documentMovements.PageSize))"
                               Selected="@_currentPage"
                               SelectedChanged="OnPageChangedAsync"
                               ShowFirstButton="true"
                               ShowLastButton="true" />
            </div>
        }
        else
        {
            <MudAlert Severity="Severity.Info" Class="mb-4">
                @TranslationService.GetTranslation("product.noDocumentsFound", "Nessun documento trovato per questo prodotto")
            </MudAlert>
        }
    </MudPaper>
</MudStack>

@code {
    [Parameter, EditorRequired]
    public ProductDto Product { get; set; } = default!;

    [Parameter]
    public bool IsEditMode { get; set; }

    [Parameter]
    public EventCallback OnProductUpdated { get; set; }

    [Parameter]
    public EventCallback OnProductUpdatedPersisted { get; set; }

    private bool _isLoadingDocuments = false;
    private bool _isLoadingStock = false;
    private bool _isLoadingTrend = false;
    private PagedResult<ProductDocumentMovementDto>? _documentMovements;
    private IEnumerable<StockDto> _stockLevels = Enumerable.Empty<StockDto>();
    private StockTrendDto? _stockTrend;
    private int _currentPage =1;
    private const int PageSize =10;

    // Group definition for warehouse grouping
    private TableGroupDefinition<StockDto> _groupDefinition = new()
    {
        GroupName = "Warehouse",
        Indentation = false,
        Expandable = true,
        IsInitiallyExpanded = true,
        Selector = (e) => e.WarehouseName
    };

    // Filters
    private DateTime? _fromDate;
    private DateTime? _toDate;
    private string? _customerNameFilter;

    protected override async Task OnParametersSetAsync()
    {
        // Load documents, stock, and trend
        await Task.WhenAll(
            LoadDocumentsAsync(), 
            LoadStockLevelsAsync(),
            LoadStockTrendAsync()
        );
    }

    private async Task LoadStockLevelsAsync()
    {
        _isLoadingStock = true;
        try
        {
            _stockLevels = await StockService.GetStockByProductIdAsync(Product.Id);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading stock levels for product {ProductId}", Product.Id);
            _stockLevels = Enumerable.Empty<StockDto>();
        }
        finally
        {
            _isLoadingStock = false;
            StateHasChanged();
        }
    }

    private async Task LoadDocumentsAsync()
    {
        _isLoadingDocuments = true;
        try
        {
            _documentMovements = await ProductService.GetProductDocumentMovementsAsync(
                Product.Id,
                _fromDate,
                _toDate,
                _customerNameFilter,
                _currentPage,
                PageSize
            );
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading document movements for product {ProductId}", Product.Id);
            _documentMovements = null;
        }
        finally
        {
            _isLoadingDocuments = false;
            StateHasChanged();
        }
    }

    private async Task LoadStockTrendAsync()
    {
        _isLoadingTrend = true;
        try
        {
            _stockTrend = await ProductService.GetProductStockTrendAsync(Product.Id);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading stock trend for product {ProductId}", Product.Id);
            _stockTrend = null;
        }
        finally
        {
            _isLoadingTrend = false;
            StateHasChanged();
        }
    }

    private async Task OnPageChangedAsync(int page)
    {
        _currentPage = page;
        await LoadDocumentsAsync();
    }

    private Color GetStatusColorFromString(string status)
    {
        return status.ToLower() switch
        {
            "draft" => Color.Default,
            "approved" => Color.Success,
            "rejected" => Color.Error,
            "cancelled" => Color.Error,
            _ => Color.Default
        };
    }

    private string GetStatusTextFromString(string status)
    {
        return status.ToLower() switch
        {
            "draft" => TranslationService.GetTranslation("status.draft", "Bozza"),
            "approved" => TranslationService.GetTranslation("status.approved", "Approvato"),
            "rejected" => TranslationService.GetTranslation("status.rejected", "Rifiutato"),
            "cancelled" => TranslationService.GetTranslation("status.cancelled", "Annullato"),
            _ => status
        };
    }

    private Color GetStatusColor(DocumentStatus status)
    {
        return status switch
        {
            DocumentStatus.Draft => Color.Default,
            DocumentStatus.Approved => Color.Success,
            DocumentStatus.Rejected => Color.Error,
            DocumentStatus.Cancelled => Color.Error,
            _ => Color.Default
        };
    }

    private string GetStatusText(DocumentStatus status)
    {
        return status switch
        {
            DocumentStatus.Draft => TranslationService.GetTranslation("status.draft", "Bozza"),
            DocumentStatus.Approved => TranslationService.GetTranslation("status.approved", "Approvato"),
            DocumentStatus.Rejected => TranslationService.GetTranslation("status.rejected", "Rifiutato"),
            DocumentStatus.Cancelled => TranslationService.GetTranslation("status.cancelled", "Annullato"),
            _ => status.ToString()
        };
    }

    private async Task NotifyUpdated()
    {
        try
        {
            if (OnProductUpdated.HasDelegate)
                await OnProductUpdated.InvokeAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error invoking OnProductUpdated from StockInventoryTab");
        }
    }
}
