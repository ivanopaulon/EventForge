@using EventForge.DTOs.Products
@using EventForge.DTOs.VatRates
@using EventForge.DTOs.Warehouse
@using EventForge.Client.Services
@using EventForge.Client.Shared.Components.Warehouse
@inject ITranslationService TranslationService
@inject ILookupCacheService LookupCacheService
@inject IProductService ProductService
@inject ILogger<PricingFinancialTab> Logger

<MudStack Spacing="3">
    <MudPaper Elevation="1" Class="pa-4">
        <MudText Typo="Typo.h6" Class="mb-3">
            <MudIcon Icon="@Icons.Material.Outlined.AttachMoney" Class="mr-2" />
            @TranslationService.GetTranslation("product.pricingInfo", "Informazioni Prezzi e Finanza")
        </MudText>
        <MudGrid Spacing="3">
            <MudItem xs="12" md="6">
                <MudNumericField @bind-Value="Product.DefaultPrice"
                                 Label="@TranslationService.GetTranslation("field.defaultPrice", "Prezzo Predefinito")"
                                 Variant="Variant.Outlined"
                                 ReadOnly="@(!IsEditMode)"
                                 Min="0"
                                 Format="N2"
                                 Adornment="Adornment.Start"
                                 AdornmentText="â‚¬"
                                 HelperText="@TranslationService.GetTranslation("helper.defaultPrice", "Prezzo base del prodotto")"
                                 @bind-Value:after="NotifyUpdated" />
            </MudItem>

            <MudItem xs="12" md="6">
                <MudSelect T="Guid?"
                           @bind-Value="Product.VatRateId"
                           Label="@TranslationService.GetTranslation("field.vatRate", "Aliquota IVA")"
                           Variant="Variant.Outlined"
                           Class="ef-select"
                           ReadOnly="@(!IsEditMode)"
                           Clearable="true"
                           @bind-Value:after="NotifyUpdated">
                    @if (_vatRates != null)
                    {
                        @foreach (var vat in _vatRates)
                        {
                            <MudSelectItem T="Guid?" Value="@((Guid?)vat.Id)">@vat.Name (@vat.Percentage%)</MudSelectItem>
                        }
                    }
                </MudSelect>
            </MudItem>

            <MudItem xs="12">
                <MudSwitch T="bool"
                           @bind-Checked="Product.IsVatIncluded"
                           @bind-Checked:after="OnVatIncludedChanged"
                           Label="@TranslationService.GetTranslation("product.isVatIncluded", "IVA Inclusa nel Prezzo")"
                           Color="Color.Primary"
                           ReadOnly="@(!IsEditMode)" />
            </MudItem>
        </MudGrid>
    </MudPaper>

    <!-- Price Trend Chart -->
    @if (Product.Id != Guid.Empty)
    {
        <PriceTrendChart PriceTrend="@_priceTrend" IsLoading="@_isLoadingPriceTrend" ProductId="@Product.Id" />
    }
</MudStack>

@code {
    [Parameter, EditorRequired]
    public ProductDto Product { get; set; } = default!;

    [Parameter]
    public bool IsEditMode { get; set; }

    [Parameter]
    public EventCallback OnProductUpdated { get; set; }

    private IEnumerable<VatRateDto>? _vatRates;
    private PriceTrendDto? _priceTrend;
    private bool _isLoadingPriceTrend = false;
    private bool _priceTrendLoaded = false;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var vatRates = await LookupCacheService.GetVatRatesAsync();
            _vatRates = vatRates.ToList();
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "Unable to load VAT rates");
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        // Ensure VAT rates are loaded
        if (_vatRates == null)
        {
            try
            {
                var vatRates = await LookupCacheService.GetVatRatesAsync();
                _vatRates = vatRates.ToList();
            }
            catch (Exception ex)
            {
                Logger.LogWarning(ex, "Unable to load VAT rates on parameter set");
            }
        }

        // If product has a VatRateId that's not present in the loaded list, fetch it explicitly and add it
        try
        {
            if (Product?.VatRateId.HasValue == true && _vatRates != null && !_vatRates.Any(v => v.Id == Product.VatRateId.Value))
            {
                var vatRate = await LookupCacheService.GetVatRateByIdAsync(Product.VatRateId.Value);
                if (vatRate != null)
                {
                    _vatRates = _vatRates.Append(vatRate).ToList();
                }
            }
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "Unable to load specific VAT rate {VatRateId}", Product?.VatRateId);
        }

        // Load price trend only once when product is set and not a new product
        if (Product?.Id != Guid.Empty && !_priceTrendLoaded)
        {
            await LoadPriceTrendAsync();
        }

        StateHasChanged();
    }

    private async Task LoadPriceTrendAsync()
    {
        _isLoadingPriceTrend = true;
        try
        {
            _priceTrend = await ProductService.GetProductPriceTrendAsync(Product.Id);
            _priceTrendLoaded = true;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading price trend for product {ProductId}", Product.Id);
            _priceTrend = null;
        }
        finally
        {
            _isLoadingPriceTrend = false;
            StateHasChanged();
        }
    }

    // Nota: chiamato come @bind-Checked:after, deve essere parameterless
    private async Task OnVatIncludedChanged()
    {
        await NotifyUpdated();
    }

    private async Task NotifyUpdated()
    {
        try
        {
            if (OnProductUpdated.HasDelegate)
                await OnProductUpdated.InvokeAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error invoking OnProductUpdated from PricingFinancialTab");
        }
    }
}
