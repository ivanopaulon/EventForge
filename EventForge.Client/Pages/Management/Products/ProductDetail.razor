@page "/product-management/products/{ProductId:guid}"
@page "/product-management/products/{ProductIdString}"
@using Microsoft.AspNetCore.Authorization
@using EventForge.DTOs.Products
@using EventForge.Client.Shared.Components
@using EventForge.Client.Pages.Management.Products.ProductDetailTabs
@using EventForge.Client.ViewModels
@attribute [Authorize]
@inject ProductDetailViewModel ViewModel
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject ITranslationService TranslationService
@inject ILogger<ProductDetail> Logger
@implements IDisposable

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <PageLoadingOverlay Visible="ViewModel.IsLoading || ViewModel.IsSaving"
                        Message="@(ViewModel.IsSaving ? TranslationService.GetTranslation("common.saving", "Salvataggio...") : TranslationService.GetTranslation("common.loading", "Caricamento..."))" />

    @if (!ViewModel.IsLoading && ViewModel.Entity == null)
    {
        <MudAlert Severity="Severity.Error">
            @TranslationService.GetTranslation("product.notFound", "Prodotto non trovato")
        </MudAlert>
    }
    else if (!ViewModel.IsLoading && ViewModel.Entity != null)
    {
        <!-- Page Header -->
        <MudPaper Elevation="2" Class="pa-4 mb-4">
            <div class="d-flex justify-space-between align-center">
                <div>
                    <div class="d-flex align-center gap-2 mb-2">
                        <MudIconButton Icon="@Icons.Material.Filled.ArrowBack" 
                                       Color="Color.Primary"
                                       OnClick="@(() => TryNavigateAway("/product-management/products"))"
                                       Size="Size.Small" />
                        <MudText Typo="Typo.h4">
                            <MudIcon Icon="@Icons.Material.Outlined.Inventory2" Class="mr-2" />
                            @(ViewModel.IsNewEntity ? TranslationService.GetTranslation("product.newProduct", "Nuovo Prodotto") : ViewModel.Entity.Name)
                        </MudText>
                        <MudChip T="string" Size="Size.Small" Color="GetStatusColor(ViewModel.Entity.Status)">
                            @GetStatusText(ViewModel.Entity.Status)
                        </MudChip>

                        @if (ViewModel.HasUnsavedChanges())
                        {
                            <MudChip T="string" Size="Size.Small" Color="Color.Warning" Class="ml-2">
                                @TranslationService.GetTranslation("product.unsavedChanges", "Modifiche non salvate")
                            </MudChip>
                        }
                    </div>
                    @if (!ViewModel.IsNewEntity)
                    {
                        <MudText Typo="Typo.body2" Class="mud-text-secondary">
                            @TranslationService.GetTranslation("field.code", "Codice"): @ViewModel.Entity.Code
                        </MudText>
                    }
                </div>
                <div class="d-flex gap-2">
                    <!-- Page now ALWAYS in edit mode -->
                    <MudButton Variant="Variant.Filled" 
                               Color="Color.Primary" 
                               StartIcon="@Icons.Material.Filled.Save"
                               OnClick="SaveProductAsync"
                               Disabled="ViewModel.IsSaving"
                               Size="Size.Small">
                        @TranslationService.GetTranslation("common.save", "Salva")
                    </MudButton>
                </div>
            </div>
        </MudPaper>

        <!-- Tabs Section -->
        <MudPaper Elevation="2" Class="pa-2">
            <MudTabs Elevation="0" Rounded="false" PanelClass="pa-4" @bind-ActivePanelIndex="_activeTab" Color="Color.Primary">
                <MudTabPanel Text="@TranslationService.GetTranslation("product.generalInfo", "Informazioni Generali")" Icon="@Icons.Material.Filled.Info">
                    <GeneralInfoTab Product="@ViewModel.Entity" IsEditMode="@_isEditMode"
                                    OnProductUpdated="@HandleProductLocallyChanged"
                                    OnProductUpdatedPersisted="@HandleProductPersistedChange" />
                </MudTabPanel>

                <MudTabPanel Text="@TranslationService.GetTranslation("product.pricingFinancial", "Prezzi e Finanza")" Icon="@Icons.Material.Filled.AttachMoney">
                    <PricingFinancialTab Product="@ViewModel.Entity" IsEditMode="@_isEditMode" OnProductUpdated="@HandleProductLocallyChanged" />
                </MudTabPanel>

                <MudTabPanel Text="@TranslationService.GetTranslation("product.classification", "Classificazione")" Icon="@Icons.Material.Filled.Category">
                    <ClassificationTab Product="@ViewModel.Entity" IsEditMode="@_isEditMode" OnProductUpdated="@HandleProductLocallyChanged" />
                </MudTabPanel>

                <MudTabPanel Text="@TranslationService.GetTranslation("product.alternativeCodes", "Codici Alternativi")" Icon="@Icons.Material.Filled.QrCode2" BadgeData="@ViewModel.ProductCodes?.Count()" BadgeDot="@(ViewModel.ProductCodes?.Any() ?? false)">
                    <ProductCodesTab Product="@ViewModel.Entity" IsEditMode="@_isEditMode" OnProductUpdated="@HandleProductLocallyChanged" OnProductUpdatedPersisted="@HandleProductPersistedChange" />
                </MudTabPanel>

                <MudTabPanel Text="@TranslationService.GetTranslation("product.alternativeUnits", "UnitÃ  Alternative")" Icon="@Icons.Material.Filled.Straighten" BadgeData="@ViewModel.ProductUnits?.Count()" BadgeDot="@(ViewModel.ProductUnits?.Any() ?? false)">
                    <ProductUnitsTab Product="@ViewModel.Entity" IsEditMode="@_isEditMode" OnProductUpdated="@HandleProductLocallyChanged" OnProductUpdatedPersisted="@HandleProductPersistedChange" />
                </MudTabPanel>

                <MudTabPanel Text="@TranslationService.GetTranslation("product.suppliers", "Fornitori")" Icon="@Icons.Material.Filled.LocalShipping" BadgeData="@ViewModel.ProductSuppliers?.Count()" BadgeDot="@(ViewModel.ProductSuppliers?.Any() ?? false)">
                    <ProductSuppliersTab Product="@ViewModel.Entity" IsEditMode="@_isEditMode" OnProductUpdated="@HandleProductLocallyChanged" OnProductUpdatedPersisted="@HandleProductPersistedChange" />
                </MudTabPanel>

                @if (ViewModel.Entity.IsBundle)
                {
                    <MudTabPanel Text="@TranslationService.GetTranslation("product.bundleComponents", "Componenti Bundle")" Icon="@Icons.Material.Filled.Inventory" BadgeData="@ViewModel.BundleItems?.Count()" BadgeDot="@(ViewModel.BundleItems?.Any() ?? false)">
                        <BundleItemsTab Product="@ViewModel.Entity" IsEditMode="@_isEditMode" OnProductUpdated="@HandleProductLocallyChanged" OnProductUpdatedPersisted="@HandleProductPersistedChange" />
                    </MudTabPanel>
                }

                <MudTabPanel Text="@TranslationService.GetTranslation("product.stockInventory", "Magazzino e Inventario")" Icon="@Icons.Material.Filled.Warehouse">
                    <StockInventoryTab Product="@ViewModel.Entity" IsEditMode="@_isEditMode" OnProductUpdated="@HandleProductLocallyChanged" OnProductUpdatedPersisted="@HandleProductPersistedChange" />
                </MudTabPanel>
            </MudTabs>
        </MudPaper>
    }
</MudContainer>

@code {
    [Parameter] public Guid? ProductId { get; set; }
    [Parameter] public string? ProductIdString { get; set; }

    private bool _isEditMode = true;
    private int _activeTab = 0;

    protected override async Task OnInitializedAsync()
    {
        ViewModel.StateChanged += OnViewModelStateChanged;
        await LoadProductAsync();
    }

    protected override async Task OnParametersSetAsync()
    {
        var currentId = GetCurrentProductId();
        if (ViewModel.Entity?.Id != currentId || (currentId == Guid.Empty && !ViewModel.IsNewEntity))
            await LoadProductAsync();
    }

    private Guid GetCurrentProductId()
    {
        if (ProductId.HasValue)
            return ProductId.Value;
        
        if (string.IsNullOrEmpty(ProductIdString))
            return Guid.Empty;
        
        if (ProductIdString.Equals("new", StringComparison.OrdinalIgnoreCase))
            return Guid.Empty;
        
        if (Guid.TryParse(ProductIdString, out var parsedGuid))
            return parsedGuid;
        
        return Guid.Empty;
    }

    private async Task LoadProductAsync()
    {
        try
        {
            var productId = GetCurrentProductId();
            await ViewModel.LoadEntityAsync(productId);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading product {ProductId}", GetCurrentProductId());
            Snackbar.Add(TranslationService.GetTranslation("product.loadError", "Errore nel caricamento del prodotto"), Severity.Error);
        }
    }

    private async Task SaveProductAsync()
    {
        try
        {
            var success = await ViewModel.SaveEntityAsync();
            if (success)
            {
                var message = ViewModel.IsNewEntity 
                    ? TranslationService.GetTranslation("product.createSuccess", "Prodotto creato con successo")
                    : TranslationService.GetTranslation("product.saveSuccess", "Prodotto salvato con successo");
                Snackbar.Add(message, Severity.Success);

                // If it was a new product, navigate to its detail page
                if (ViewModel.Entity?.Id != Guid.Empty && ProductIdString?.Equals("new", StringComparison.OrdinalIgnoreCase) == true)
                {
                    NavigationManager.NavigateTo($"/product-management/products/{ViewModel.Entity.Id}");
                }
            }
            else
            {
                var message = ViewModel.IsNewEntity
                    ? TranslationService.GetTranslation("product.createError", "Errore nella creazione del prodotto")
                    : TranslationService.GetTranslation("product.saveError", "Errore nel salvataggio del prodotto");
                Snackbar.Add(message, Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error saving product");
            Snackbar.Add(TranslationService.GetTranslation("product.saveError", "Errore nel salvataggio del prodotto"), Severity.Error);
        }
    }

    private void HandleProductLocallyChanged()
    {
        ViewModel.NotifyEntityChanged();
    }

    private async Task HandleProductPersistedChange()
    {
        await ViewModel.ReloadEntityAsync();
    }

    private async Task TryNavigateAway(string target)
    {
        if (!ViewModel.HasUnsavedChanges())
        {
            NavigationManager.NavigateTo(target);
            return;
        }

        var title = TranslationService.GetTranslation("common.confirm", "Conferma");
        var message = TranslationService.GetTranslation("product.unsavedChangesConfirm", "Ci sono modifiche non salvate. Vuoi salvare prima di uscire?");
        var saveText = TranslationService.GetTranslation("common.save", "Salva");
        var discardText = TranslationService.GetTranslation("common.discard", "Non salvare");
        var cancelText = TranslationService.GetTranslation("common.cancel", "Annulla");

        var result = await DialogService.ShowMessageBox(title, message, yesText: saveText, noText: discardText, cancelText: cancelText);

        if (result == true)
        {
            await SaveProductAsync();
            NavigationManager.NavigateTo(target);
        }
        else if (result == false)
        {
            NavigationManager.NavigateTo(target);
        }
    }

    private void OnViewModelStateChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    private Color GetStatusColor(ProductStatus status) => status switch
    {
        ProductStatus.Active => Color.Success,
        ProductStatus.Suspended => Color.Warning,
        ProductStatus.OutOfStock => Color.Error,
        ProductStatus.Deleted => Color.Dark,
        _ => Color.Default
    };

    private string GetStatusText(ProductStatus status) => status switch
    {
        ProductStatus.Active => TranslationService.GetTranslation("status.active", "Attivo"),
        ProductStatus.Suspended => TranslationService.GetTranslation("status.suspended", "Sospeso"),
        ProductStatus.OutOfStock => TranslationService.GetTranslation("status.outOfStock", "Esaurito"),
        ProductStatus.Deleted => TranslationService.GetTranslation("status.deleted", "Eliminato"),
        _ => status.ToString()
    };

    public void Dispose()
    {
        ViewModel.StateChanged -= OnViewModelStateChanged;
    }
}
