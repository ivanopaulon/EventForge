@using MudBlazor
@using EventForge.DTOs.Tenants
@using EventForge.DTOs.SuperAdmin
@inject ISuperAdminService SuperAdminService
@inject ISnackbar Snackbar
@inject ITranslationService TranslationService

<MudDialog>
    <DialogContent>
        <MudContainer Style="max-width: 600px;">
            <MudText Typo="Typo.h6" Class="mb-4">@TranslationService.GetTranslation("superAdmin.createTenantTitle", "Crea Nuovo Tenant")</MudText>
            
            <MudForm @ref="_form" Model="_createDto" @bind-IsValid="_isFormValid">
                <MudGrid>
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="_createDto.Name"
                                      Label="@(TranslationService.GetTranslation("superAdmin.tenantName", "Nome Tenant") + " *")"
                                      Variant="Variant.Outlined"
                                      Required="true"
                                      RequiredError="@TranslationService.GetTranslation("superAdmin.tenantNameRequired", "Il nome del tenant è obbligatorio")"
                                      MaxLength="100"
                                      HelperText="@TranslationService.GetTranslation("superAdmin.uniqueTenantNameHelper", "Nome univoco del tenant (es: azienda-abc)")" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="_createDto.DisplayName"
                                      Label="@(TranslationService.GetTranslation("field.displayName", "Nome Visualizzato") + " *")"
                                      Variant="Variant.Outlined"
                                      Required="true"
                                      RequiredError="@TranslationService.GetTranslation("superAdmin.displayNameRequired", "Il nome visualizzato è obbligatorio")"
                                      MaxLength="200"
                                      HelperText="@TranslationService.GetTranslation("superAdmin.displayNameHelper", "Nome da mostrare nell'interfaccia")" />
                    </MudItem>
                    <MudItem xs="12">
                        <MudTextField @bind-Value="_createDto.Description"
                                      Label="@TranslationService.GetTranslation("field.description", "Descrizione")"
                                      Variant="Variant.Outlined"
                                      Lines="3"
                                      MaxLength="500"
                                      HelperText="@TranslationService.GetTranslation("superAdmin.optionalDescriptionHelper", "Descrizione opzionale del tenant")" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="_createDto.Domain"
                                      Label="@TranslationService.GetTranslation("field.domain", "Dominio")"
                                      Variant="Variant.Outlined"
                                      MaxLength="100"
                                      HelperText="@TranslationService.GetTranslation("superAdmin.customDomainHelper", "Dominio personalizzato (opzionale)")" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="_createDto.ContactEmail"
                                      Label="@(TranslationService.GetTranslation("field.contactEmail", "Email Contatto") + " *")"
                                      Variant="Variant.Outlined"
                                      InputType="InputType.Email"
                                      Required="true"
                                      RequiredError="@TranslationService.GetTranslation("superAdmin.contactEmailRequired", "L'email di contatto è obbligatoria")"
                                      MaxLength="256"
                                      HelperText="@TranslationService.GetTranslation("superAdmin.contactEmailHelper", "Email di riferimento per il tenant")" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudNumericField @bind-Value="_createDto.MaxUsers"
                                         Label="@(TranslationService.GetTranslation("superAdmin.maxUsers", "Massimo Utenti") + " *")"
                                         Variant="Variant.Outlined"
                                         Min="1"
                                         Max="10000"
                                         Required="true"
                                         HelperText="@TranslationService.GetTranslation("superAdmin.maxUsersHelper", "Numero massimo di utenti consentiti")" />
                    </MudItem>
                </MudGrid>
            </MudForm>
        </MudContainer>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">@TranslationService.GetTranslation("common.cancel", "Annulla")</MudButton>
        <MudButton Color="Color.Primary" 
                   Variant="Variant.Filled"
                   OnClick="Create"
                   Disabled="@(!_isFormValid || _isCreating)">
            @if (_isCreating)
            {
                <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true"/>
                <MudText Class="ms-2">@TranslationService.GetTranslation("superAdmin.creating", "Creando...")</MudText>
            }
            else
            {
                <MudText>@TranslationService.GetTranslation("superAdmin.createTenant", "Crea Tenant")</MudText>
            }
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] private dynamic? MudDialog { get; set; }

    private MudForm _form = null!;
    private bool _isFormValid;
    private bool _isCreating;
    private CreateTenantDto _createDto = new() { MaxUsers = 100 };

    private void Cancel() => MudDialog?.Cancel();

    private async Task Create()
    {
        if (!_isFormValid || MudDialog == null) return;

        try
        {
            _isCreating = true;
            var newTenant = await SuperAdminService.CreateTenantAsync(_createDto);
            MudDialog!.Close(MudBlazor.DialogResult.Ok(newTenant));
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Errore nella creazione del tenant: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isCreating = false;
        }
    }
}