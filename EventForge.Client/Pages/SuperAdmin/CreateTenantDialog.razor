@using MudBlazor
@using EventForge.DTOs.Tenants
@using EventForge.DTOs.SuperAdmin
@inject ISuperAdminService SuperAdminService
@inject ISnackbar Snackbar

<MudDialog>
    <DialogContent>
        <MudContainer Style="max-width: 600px;">
            <MudText Typo="Typo.h6" Class="mb-4">Crea Nuovo Tenant</MudText>
            
            <MudForm @ref="_form" Model="_createDto" @bind-IsValid="_isFormValid">
                <MudGrid>
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="_createDto.Name"
                                      Label="Nome Tenant *"
                                      Variant="Variant.Outlined"
                                      Required="true"
                                      RequiredError="Il nome del tenant è obbligatorio"
                                      MaxLength="100"
                                      HelperText="Nome univoco del tenant (es: azienda-abc)" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="_createDto.DisplayName"
                                      Label="Nome Visualizzato *"
                                      Variant="Variant.Outlined"
                                      Required="true"
                                      RequiredError="Il nome visualizzato è obbligatorio"
                                      MaxLength="200"
                                      HelperText="Nome da mostrare nell'interfaccia" />
                    </MudItem>
                    <MudItem xs="12">
                        <MudTextField @bind-Value="_createDto.Description"
                                      Label="Descrizione"
                                      Variant="Variant.Outlined"
                                      Lines="3"
                                      MaxLength="500"
                                      HelperText="Descrizione opzionale del tenant" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="_createDto.Domain"
                                      Label="Dominio"
                                      Variant="Variant.Outlined"
                                      MaxLength="100"
                                      HelperText="Dominio personalizzato (opzionale)" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="_createDto.ContactEmail"
                                      Label="Email Contatto *"
                                      Variant="Variant.Outlined"
                                      InputType="InputType.Email"
                                      Required="true"
                                      RequiredError="L'email di contatto è obbligatoria"
                                      MaxLength="256"
                                      HelperText="Email di riferimento per il tenant" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudNumericField @bind-Value="_createDto.MaxUsers"
                                         Label="Massimo Utenti *"
                                         Variant="Variant.Outlined"
                                         Min="1"
                                         Max="10000"
                                         Required="true"
                                         HelperText="Numero massimo di utenti consentiti" />
                    </MudItem>
                </MudGrid>
            </MudForm>
        </MudContainer>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Annulla</MudButton>
        <MudButton Color="Color.Primary" 
                   Variant="Variant.Filled"
                   OnClick="Create"
                   Disabled="@(!_isFormValid || _isCreating)">
            @if (_isCreating)
            {
                <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true"/>
                <MudText Class="ms-2">Creando...</MudText>
            }
            else
            {
                <MudText>Crea Tenant</MudText>
            }
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] private dynamic? MudDialog { get; set; }

    private MudForm _form = null!;
    private bool _isFormValid;
    private bool _isCreating;
    private CreateTenantDto _createDto = new() { MaxUsers = 100 };

    private void Cancel() => MudDialog?.Cancel();

    private async Task Create()
    {
        if (!_isFormValid || MudDialog == null) return;

        try
        {
            _isCreating = true;
            var newTenant = await SuperAdminService.CreateTenantAsync(_createDto);
            MudDialog!.Close(MudBlazor.DialogResult.Ok(newTenant));
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Errore nella creazione del tenant: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isCreating = false;
        }
    }
}