@page "/superadmin/user-management"
@using Microsoft.AspNetCore.Authorization
@using EventForge.DTOs.Tenants
@using EventForge.DTOs.SuperAdmin
@using EventForge.DTOs.Audit
@using EventForge.DTOs.Common
@using EventForge.Client.Constants
@using EventForge.Client.Shared.Components
@using EventForge.Client.Shared.Components.Dashboard
@attribute [Authorize(Roles = "SuperAdmin")]
@inject IAuthService AuthService
@inject ISuperAdminService SuperAdminService
@inject NavigationManager NavigationManager
@inject IAuthenticationDialogService AuthenticationDialogService
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject ITranslationService TranslationService
@inject ITenantContextService TenantContextService
@inject IJSRuntime JSRuntime
@inject ILogger<UserManagement> Logger

<PageTitle>@TranslationService.GetTranslation("superAdmin.pageTitle", "{0} - EventForge Super Admin", TranslationService.GetTranslation("superAdmin.userManagement", "Gestione Utenti Tenant"))</PageTitle>

<PageLoadingOverlay Visible="_isLoading || _isLoadingUsers"
                     Message="@(_isLoading ? TranslationService.GetTranslation("messages.loadingPage", "Caricamento pagina...") : TranslationService.GetTranslation("common.loading", "Caricamento..."))" />

@if (!_isLoading)
{
    @if (!_isAuthorized)
    {
        <MudContainer MaxWidth="MaxWidth.Medium" Class="mt-8">
            <MudPaper Class="ef-tile">
                <MudGrid Justify="Justify.Center">
                    <MudItem xs="12">
                        <div class="d-flex flex-column align-center">
                            <MudIcon Icon="Icons.Material.Filled.Block" Color="Color.Error" Size="Size.Medium" Style="font-size: 48px;" />
                            <MudText Typo="Typo.h4" Align="Align.Center" Class="mb-4">@TranslationService.GetTranslation("error.accessDenied", "Accesso Negato")</MudText>
                            <MudText Typo="Typo.body1" Align="Align.Center" Class="mb-4">
                                @TranslationService.GetTranslation("superAdmin.superAdminRoleRequired", "Non hai i permessi per accedere a questa pagina. È richiesto il ruolo Super Amministratore.")
                            </MudText>
                            <MudButton Variant="Variant.Filled" 
                                       Color="Color.Primary" 
                                       StartIcon="Icons.Material.Filled.ArrowBack"
                                       OnClick="@(() => NavigationManager.NavigateTo("/"))">
                                @TranslationService.GetTranslation("superAdmin.returnToHome", "Torna alla Home")
                            </MudButton>
                        </div>
                    </MudItem>
                </MudGrid>
            </MudPaper>
        </MudContainer>
    }
    else
    {
        <div class="user-page-root">
            <div class="user-top">
                <ManagementDashboard TItem="UserManagementDto"
                                     Items="_filteredUsers"
                                     Metrics="_dashboardMetrics"
                                     EntityType="User"
                                     AllowConfiguration="true"
                                     UseServerSide="false" />
            </div>

            <div class="eftable-wrapper">
                <EFTable @ref="_efTable"
                         TItem="UserManagementDto"
                         Items="_filteredUsers"
                         MultiSelection="true"
                         SelectedItems="_selectedUsers"
                         SelectedItemsChanged="_selectedItemsChangedCallback"
                         IsLoading="_isLoadingUsers"
                         ComponentKey="UserManagement"
                         InitialColumnConfigurations="_initialColumns"
                         AllowDragDropGrouping="true">
                    <ToolBarContent>
                        <MudText Typo="Typo.h5">
                            @TranslationService.GetTranslation("superAdmin.userManagement", "Gestione Utenti")
                        </MudText>
                        <MudSpacer />
                        <MudTextField @bind-Value="_searchTerm"
                                      @bind-Value:after="OnSearchChanged"
                                      Label="@TranslationService.GetTranslation("superAdmin.searchByNameEmailUsername", "Cerca per nome, email o username")"
                                      Placeholder="@TranslationService.GetTranslation("superAdmin.searchPlaceholder", "Inserisci testo da cercare...")"
                                      Variant="Variant.Outlined"
                                      Adornment="Adornment.End"
                                      AdornmentIcon="@Icons.Material.Outlined.Search"
                                      Clearable="true"
                                      Class="ef-input" />
                        <MudSelect T="string" @bind-Value="_selectedTenant" @bind-Value:after="OnTenantChanged" 
                                   Label="@TranslationService.GetTranslation("field.tenant", "Tenant")" 
                                   Placeholder="@TranslationService.GetTranslation("superAdmin.selectTenant", "Seleziona un tenant...")"
                                   Variant="Variant.Outlined"
                                   Clearable="true"
                                   Class="ml-2"
                                   Style="min-width: 200px;">
                            <MudSelectItem Value="@("")">@TranslationService.GetTranslation("superAdmin.allTenants", "Tutti i Tenant")</MudSelectItem>
                            @foreach (var tenant in _tenants)
                            {
                                <MudSelectItem Value="@tenant.Id.ToString()">@tenant.DisplayName</MudSelectItem>
                            }
                        </MudSelect>
                        <MudSelect T="string" @bind-Value="_roleFilter" @bind-Value:after="OnRoleFilterChanged" 
                                   Label="@TranslationService.GetTranslation("field.role", "Ruolo")" 
                                   Placeholder="@TranslationService.GetTranslation("superAdmin.selectRole", "Seleziona ruolo...")"
                                   Variant="Variant.Outlined"
                                   Clearable="true"
                                   Class="ml-2"
                                   Style="min-width: 150px;">
                            <MudSelectItem Value="@("all")">@TranslationService.GetTranslation("superAdmin.allRoles", "Tutti i Ruoli")</MudSelectItem>
                            <MudSelectItem Value="@("SuperAdmin")">@TranslationService.GetTranslation("role.superAdmin", "Super Admin")</MudSelectItem>
                            <MudSelectItem Value="@("Admin")">@TranslationService.GetTranslation("role.admin", "Admin")</MudSelectItem>
                            <MudSelectItem Value="@("Manager")">@TranslationService.GetTranslation("role.manager", "Manager")</MudSelectItem>
                            <MudSelectItem Value="@("User")">@TranslationService.GetTranslation("role.user", "User")</MudSelectItem>
                        </MudSelect>
                        <MudSwitch @bind-Value="_showActiveOnly"
                                   @bind-Value:after="OnStatusFilterChanged"
                                   Label="@TranslationService.GetTranslation("field.onlyActive", "Solo Attivi")"
                                   Color="Color.Success"
                                   Class="ml-2" />
                        <ManagementTableToolbar ShowSelectionBadge="true"
                                                SelectedCount="@_selectedUsers.Count"
                                                ShowRefresh="true"
                                                ShowCreate="true"
                                                ShowDelete="false"
                                                CreateTooltip="superAdmin.createNewUser"
                                                IsDisabled="_isLoadingUsers"
                                                OnRefresh="@LoadUsersAsync"
                                                OnCreate="@CreateUser" />
                    </ToolBarContent>
                    <HeaderContent Context="columnConfigurations">
                        @foreach (var column in columnConfigurations.Where(c => c.IsVisible).OrderBy(c => c.Order))
                        {
                            @if (column.PropertyName == "FullName")
                            {
                                <EFTableColumnHeader TItem="UserManagementDto" PropertyName="FullName" OnDragStartCallback="@_efTable.HandleColumnDragStart">
                                    <MudTableSortLabel SortBy="@(new Func<UserManagementDto, object>(x => x.FullName))">@TranslationService.GetTranslation("field.fullName", "Nome Completo")</MudTableSortLabel>
                                </EFTableColumnHeader>
                            }
                            else if (column.PropertyName == "Email")
                            {
                                <EFTableColumnHeader TItem="UserManagementDto" PropertyName="Email" OnDragStartCallback="@_efTable.HandleColumnDragStart">
                                    <MudTableSortLabel SortBy="@(new Func<UserManagementDto, object>(x => x.Email))">@TranslationService.GetTranslation("field.email", "Email")</MudTableSortLabel>
                                </EFTableColumnHeader>
                            }
                            else if (column.PropertyName == "Username")
                            {
                                <EFTableColumnHeader TItem="UserManagementDto" PropertyName="Username" OnDragStartCallback="@_efTable.HandleColumnDragStart">
                                    <MudTableSortLabel SortBy="@(new Func<UserManagementDto, object>(x => x.Username))">@TranslationService.GetTranslation("field.username", "Username")</MudTableSortLabel>
                                </EFTableColumnHeader>
                            }
                            else if (column.PropertyName == "TenantName")
                            {
                                <EFTableColumnHeader TItem="UserManagementDto" PropertyName="TenantName" OnDragStartCallback="@_efTable.HandleColumnDragStart">
                                    <MudTableSortLabel SortBy="@(new Func<UserManagementDto, object>(x => x.TenantName ?? string.Empty))">@TranslationService.GetTranslation("field.tenant", "Tenant")</MudTableSortLabel>
                                </EFTableColumnHeader>
                            }
                            else if (column.PropertyName == "Roles")
                            {
                                <EFTableColumnHeader TItem="UserManagementDto" PropertyName="Roles" OnDragStartCallback="@_efTable.HandleColumnDragStart">
                                    <MudTh>@TranslationService.GetTranslation("field.roles", "Ruoli")</MudTh>
                                </EFTableColumnHeader>
                            }
                            else if (column.PropertyName == "IsActive")
                            {
                                <EFTableColumnHeader TItem="UserManagementDto" PropertyName="IsActive" OnDragStartCallback="@_efTable.HandleColumnDragStart">
                                    <MudTableSortLabel SortBy="@(new Func<UserManagementDto, object>(x => x.IsActive))">@TranslationService.GetTranslation("field.status", "Stato")</MudTableSortLabel>
                                </EFTableColumnHeader>
                            }
                            else if (column.PropertyName == "LastLoginAt")
                            {
                                <EFTableColumnHeader TItem="UserManagementDto" PropertyName="LastLoginAt" OnDragStartCallback="@_efTable.HandleColumnDragStart">
                                    <MudTableSortLabel InitialDirection="SortDirection.Descending" SortBy="@(new Func<UserManagementDto, object>(x => x.LastLoginAt ?? DateTime.MinValue))">@TranslationService.GetTranslation("field.lastLogin", "Ultimo Accesso")</MudTableSortLabel>
                                </EFTableColumnHeader>
                            }
                        }
                        <MudTh Class="text-center" Style="min-width:120px;">@TranslationService.GetTranslation("common.actions", "Azioni")</MudTh>
                    </HeaderContent>

                    <RowTemplate Context="item">
                        @{
                            var visibleColumns = _efTable?.ColumnConfigurations?.Where(c => c.IsVisible).OrderBy(c => c.Order).ToList() ?? _initialColumns.Where(c => c.IsVisible).OrderBy(c => c.Order).ToList();
                        }
                        @foreach (var column in visibleColumns)
                        {
                            @if (column.PropertyName == "FullName")
                            {
                                <MudTd DataLabel="@TranslationService.GetTranslation("field.fullName", "Nome Completo")">
                                    <div class="d-flex align-center">
                                        <MudAvatar Color="Color.Primary" Size="Size.Small" Class="mr-2">
                                            @(item.FirstName.FirstOrDefault())@(item.LastName.FirstOrDefault())
                                        </MudAvatar>
                                        <div>
                                            <MudText Typo="Typo.body2">@item.FullName</MudText>
                                            <MudText Typo="Typo.caption" Class="mud-text-secondary">ID: @(item.Id.ToString()[..Math.Min(8, item.Id.ToString().Length)])...</MudText>
                                        </div>
                                    </div>
                                </MudTd>
                            }
                            else if (column.PropertyName == "Email")
                            {
                                <MudTd DataLabel="@TranslationService.GetTranslation("field.email", "Email")">
                                    <MudText Typo="Typo.body2">@item.Email</MudText>
                                </MudTd>
                            }
                            else if (column.PropertyName == "Username")
                            {
                                <MudTd DataLabel="@TranslationService.GetTranslation("field.username", "Username")">
                                    <MudText Typo="Typo.body2">@item.Username</MudText>
                                </MudTd>
                            }
                            else if (column.PropertyName == "TenantName")
                            {
                                <MudTd DataLabel="@TranslationService.GetTranslation("field.tenant", "Tenant")">
                                    <MudText Typo="Typo.body2">@(item.TenantName ?? TranslationService.GetTranslation("common.notAvailable", "N/A"))</MudText>
                                </MudTd>
                            }
                            else if (column.PropertyName == "Roles")
                            {
                                <MudTd DataLabel="@TranslationService.GetTranslation("field.roles", "Ruoli")">
                                    <div class="d-flex flex-wrap gap-1">
                                        @foreach (var role in item.Roles.Take(2))
                                        {
                                            <MudChip T="string" Size="Size.Small" 
                                                     Color="@GetRoleColor(role)">
                                                @TranslationService.GetTranslation($"role.{role.ToLower()}", role)
                                            </MudChip>
                                        }
                                        @if (item.Roles.Count > 2)
                                        {
                                            <MudChip T="string" Color="Color.Default" Size="Size.Small">+@(item.Roles.Count - 2)</MudChip>
                                        }
                                    </div>
                                </MudTd>
                            }
                            else if (column.PropertyName == "IsActive")
                            {
                                <MudTd DataLabel="@TranslationService.GetTranslation("field.status", "Stato")">
                                    <MudChip T="string" Color="@(item.IsActive ? Color.Success : Color.Error)" 
                                             Size="Size.Small"
                                             Icon="@(item.IsActive ? Icons.Material.Outlined.CheckCircle : Icons.Material.Outlined.Cancel)">
                                        @(item.IsActive ? TranslationService.GetTranslation("field.active", "Attivo") : TranslationService.GetTranslation("field.inactive", "Inattivo"))
                                    </MudChip>
                                </MudTd>
                            }
                            else if (column.PropertyName == "LastLoginAt")
                            {
                                <MudTd DataLabel="@TranslationService.GetTranslation("field.lastLogin", "Ultimo Accesso")">
                                    <MudText Typo="Typo.body2">@(item.LastLoginAt?.ToString("dd/MM/yyyy HH:mm") ?? TranslationService.GetTranslation("common.never", "Mai"))</MudText>
                                </MudTd>
                            }
                        }
                        <MudTd DataLabel="@TranslationService.GetTranslation("common.actions", "Azioni")" Class="text-center">
                            <ActionButtonGroup EntityName="@item.FullName"
                                              ItemDisplayName="@item.FullName"
                                              ShowView="false"
                                              ShowEdit="true"
                                              ShowAuditLog="true"
                                              ShowToggleStatus="true"
                                              ShowDelete="true"
                                              IsActive="@item.IsActive"
                                              OnEdit="@(() => EditUser(item.Id))"
                                              OnAuditLog="@(() => ViewUserAuditHistory(item))"
                                              OnToggleStatus="@(() => ToggleUserStatus(item))"
                                              OnDelete="@(() => DeleteUser(item))">
                                <AdditionalActions>
                                    <MudTooltip Text="@TranslationService.GetTranslation("tooltip.resetPassword", "Reimposta password")">
                                        <MudIconButton Icon="@Icons.Material.Outlined.LockReset" 
                                                       Color="Color.Secondary"
                                                       Size="Size.Small"
                                                       Class="rounded"
                                                       OnClick="@(() => ResetUserPassword(item))"
                                                       aria-label="@TranslationService.GetTranslation("tooltip.resetPassword", "Reimposta password per {0}", item.FullName)" />
                                    </MudTooltip>
                                    <MudTooltip Text="@TranslationService.GetTranslation("tooltip.impersonateUser", "Impersona utente")">
                                        <MudIconButton Icon="@Icons.Material.Outlined.PersonOutline" 
                                                       Color="Color.Warning"
                                                       Size="Size.Small"
                                                       Class="rounded"
                                                       OnClick="@(() => ImpersonateUser(item))"
                                                       aria-label="@TranslationService.GetTranslation("tooltip.impersonateUser", "Impersona utente {0}", item.FullName)" />
                                    </MudTooltip>
                                </AdditionalActions>
                            </ActionButtonGroup>
                        </MudTd>
                    </RowTemplate>

                    <NoRecordsContent>
                        <div class="text-center pa-2 pa-sm-3 pa-md-4">
                            <MudIcon Icon="@Icons.Material.Outlined.PersonOff" Size="Size.Medium" Class="mb-4 mud-text-secondary" />
                            <MudText Typo="Typo.h6" Class="mb-2">
                                @(_users.Any() ? 
                                    TranslationService.GetTranslation("superAdmin.noUsersMatchFilters", "Nessun utente corrisponde ai filtri applicati") : 
                                    TranslationService.GetTranslation("superAdmin.noUsersFound", "Nessun utente trovato"))
                            </MudText>
                            @if (_users.Any())
                            {
                                <MudButton Variant="Variant.Text" 
                                           Color="Color.Primary" 
                                           StartIcon="@Icons.Material.Outlined.Clear"
                                           OnClick="@ClearFilters">
                                    @TranslationService.GetTranslation("superAdmin.clearFilters", "Cancella filtri")
                                </MudButton>
                            }
                        </div>
                    </NoRecordsContent>
                </EFTable>
                
                <!-- Bulk Actions Alert -->
                @if (_selectedUsers.Any())
                {
                    <MudAlert Severity="Severity.Info" Class="mt-2">
                        <div class="d-flex align-center justify-space-between">
                            <div class="d-flex align-center">
                                <MudText Typo="Typo.body2" Class="mr-4">
                                    @TranslationService.GetTranslation("superAdmin.selectedUsers", "{0} utenti selezionati", _selectedUsers.Count)
                                </MudText>
                                <MudButton Variant="Variant.Text" 
                                           Color="Color.Primary" 
                                           Size="Size.Small"
                                           StartIcon="@Icons.Material.Outlined.Clear"
                                           OnClick="@ClearSelection">
                                    @TranslationService.GetTranslation("common.clearSelection", "Deseleziona tutti")
                                </MudButton>
                            </div>
                            <div class="d-flex gap-2">
                                <MudButton Variant="Variant.Outlined" 
                                           Color="Color.Success" 
                                           Size="Size.Small"
                                           StartIcon="@Icons.Material.Outlined.CheckCircle"
                                           OnClick="@(() => ExecuteBulkAction("activate"))"
                                           Disabled="@_isExecutingBulkAction">
                                    @TranslationService.GetTranslation("superAdmin.bulkActivate", "Attiva")
                                </MudButton>
                                <MudButton Variant="Variant.Outlined" 
                                           Color="Color.Warning" 
                                           Size="Size.Small"
                                           StartIcon="@Icons.Material.Outlined.Cancel"
                                           OnClick="@(() => ExecuteBulkAction("deactivate"))"
                                           Disabled="@_isExecutingBulkAction">
                                    @TranslationService.GetTranslation("superAdmin.bulkDeactivate", "Disattiva")
                                </MudButton>
                                <MudButton Variant="Variant.Outlined" 
                                           Color="Color.Secondary" 
                                           Size="Size.Small"
                                           StartIcon="@Icons.Material.Outlined.LockReset"
                                           OnClick="@(() => ExecuteBulkAction("force-password-change"))"
                                           Disabled="@_isExecutingBulkAction">
                                    @TranslationService.GetTranslation("superAdmin.bulkForcePasswordChange", "Forza cambio password")
                                </MudButton>
                            </div>
                        </div>
                    </MudAlert>
                }
            </div>
        </div>
    }
}

@code {
    // Dialog options for fullscreen audit dialog
    private readonly DialogOptions _auditDialogOptions = new() 
    { 
        FullScreen = true, 
        CloseButton = true,
        MaxWidth = MaxWidth.False
    };
    
    // UI State Management
    private bool _isLoading = true;
    private bool _isAuthorized = false;
    private bool _isLoadingTenants = false;
    private bool _isLoadingUsers = false;
    
    // Drawer and modal management
    private UserDto? _currentUser;
    
    // Filter and search state
    private string _searchTerm = string.Empty;
    private string _roleFilter = "all";
    private bool _showActiveOnly = false;
    private string _selectedTenant = string.Empty;
    private CancellationTokenSource? _searchDebounceCts;
    
    // Data collections
    private List<TenantResponseDto> _tenants = new();
    private List<UserManagementDto> _users = new();
    
    // Bulk actions
    private HashSet<UserManagementDto> _selectedUsers = new();
    private List<Guid> _selectedUserIds => _selectedUsers.Select(u => u.Id).ToList();
    private bool _isExecutingBulkAction = false;
    
    // EFTable reference
    private EFTable<UserManagementDto> _efTable = null!;
    
    // Column configuration for EFTable
    private List<EFTableColumnConfiguration> _initialColumns = new()
    {
        new() { PropertyName = "FullName", DisplayName = "Nome Completo", IsVisible = true, Order = 0 },
        new() { PropertyName = "Email", DisplayName = "Email", IsVisible = true, Order = 1 },
        new() { PropertyName = "Username", DisplayName = "Username", IsVisible = true, Order = 2 },
        new() { PropertyName = "TenantName", DisplayName = "Tenant", IsVisible = true, Order = 3 },
        new() { PropertyName = "Roles", DisplayName = "Ruoli", IsVisible = true, Order = 4 },
        new() { PropertyName = "IsActive", DisplayName = "Stato", IsVisible = true, Order = 5 },
        new() { PropertyName = "LastLoginAt", DisplayName = "Ultimo Accesso", IsVisible = true, Order = 6 }
    };
    
    // Dashboard configuration
    private List<DashboardMetric<UserManagementDto>> _dashboardMetrics = new()
    {
        new()
        {
            Title = "Totale Utenti",
            Type = MetricType.Count,
            Icon = Icons.Material.Outlined.People,
            Color = "primary",
            Description = "Numero totale di utenti",
            Format = "N0"
        },
        new()
        {
            Title = "Utenti Attivi",
            Type = MetricType.Count,
            Filter = u => u.IsActive,
            Icon = Icons.Material.Outlined.CheckCircle,
            Color = "success",
            Description = "Utenti attivi",
            Format = "N0"
        },
        new()
        {
            Title = "Creati Questo Mese",
            Type = MetricType.Count,
            Filter = u => u.CreatedAt >= DateTime.Now.AddDays(-30),
            Icon = Icons.Material.Outlined.CalendarToday,
            Color = "warning",
            Description = "Utenti creati negli ultimi 30 giorni",
            Format = "N0"
        },
        new()
        {
            Title = "SuperAdmin",
            Type = MetricType.Count,
            Filter = u => u.Roles.Any(r => r.Equals("SuperAdmin", StringComparison.OrdinalIgnoreCase)),
            Icon = Icons.Material.Outlined.AdminPanelSettings,
            Color = "info",
            Description = "Utenti con ruolo SuperAdmin",
            Format = "N0"
        }
    };
    
    private EventCallback<HashSet<UserManagementDto>> _selectedItemsChangedCallback => EventCallback.Factory.Create<HashSet<UserManagementDto>>(this, OnSelectedItemsChanged);
    
    /// <summary>
    /// Handles selection changes from EFTable
    /// </summary>
    private void OnSelectedItemsChanged(HashSet<UserManagementDto> items)
    {
        _selectedUsers = items;
        StateHasChanged();
    }
    
    /// <summary>
    /// Computed property for filtered users based on search criteria.
    /// Applies multiple filters: search term, role, status, and tenant selection.
    /// </summary>
    private IEnumerable<UserManagementDto> _filteredUsers => 
        _users.Where(u => 
            // Search filter: check name, email, username
            (string.IsNullOrEmpty(_searchTerm) || 
             u.FullName.Contains(_searchTerm, StringComparison.OrdinalIgnoreCase) ||
             u.Email.Contains(_searchTerm, StringComparison.OrdinalIgnoreCase) ||
             u.Username.Contains(_searchTerm, StringComparison.OrdinalIgnoreCase)) &&
            // Role filter
            (_roleFilter == "all" || u.Roles.Any(r => r.Equals(_roleFilter, StringComparison.OrdinalIgnoreCase))) &&
            // Status filter  
            (!_showActiveOnly || u.IsActive) &&
            // Tenant filter
            (string.IsNullOrEmpty(_selectedTenant) || 
             _selectedTenant == "" ||
             u.TenantId?.ToString() == _selectedTenant));

    /// <summary>
    /// Component initialization with enhanced security checks and responsive UI setup.
    /// Aligned with TenantManagement page pattern - no tenant auto-selection.
    /// </summary>
    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Enhanced authentication and authorization flow
            var isAuthenticated = await AuthService.IsAuthenticatedAsync();
            if (!isAuthenticated)
            {
                await ShowLoginDialogAsync();
                return;
            }

            // SuperAdmin role verification with proper error handling
            var isSuperAdmin = await AuthService.IsSuperAdminAsync();
            if (!isSuperAdmin)
            {
                _isAuthorized = false;
                _isLoading = false;
                Snackbar.Add(TranslationService.GetTranslation("superAdmin.accessDeniedSuperAdmin", "Accesso negato. È richiesto il ruolo Super Amministratore."), Severity.Warning);
                return;
            }

            // Load current user info for audit purposes
            _currentUser = await AuthService.GetCurrentUserAsync();
            _isAuthorized = true;
            
            // Parallel data loading for better performance (like TenantManagement)
            await Task.WhenAll(
                LoadTenantsAsync(),
                LoadUsersAsync()
            );
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error initializing user management page");
            Snackbar.Add(TranslationService.GetTranslation("superAdmin.loadingPageError", "Errore nel caricamento della pagina: {0}", ex.Message), Severity.Error);
            NavigationManager.NavigateTo("/");
        }
        finally
        {
            _isLoading = false;
        }
    }

    /// <summary>
    /// Loads tenant data with proper error handling and loading state management.
    /// Does not auto-select tenants to align with TenantManagement page behavior.
    /// </summary>
    private async Task LoadTenantsAsync()
    {
        try
        {
            _isLoadingTenants = true;
            _tenants = (await SuperAdminService.GetTenantsAsync()).ToList();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading tenants for user management");
            Snackbar.Add(TranslationService.GetTranslation("superAdmin.loadingTenantsError", "Errore nel caricamento dei tenant: {0}", ex.Message), Severity.Error);
        }
        finally
        {
            _isLoadingTenants = false;
        }
    }

    /// <summary>
    /// Loads user data with tenant filtering and enhanced error handling.
    /// </summary>
    private async Task LoadUsersAsync()
    {
        try
        {
            _isLoadingUsers = true;
            var tenantId = string.IsNullOrEmpty(_selectedTenant) ? (Guid?)null : Guid.Parse(_selectedTenant);
            _users = (await SuperAdminService.GetUsersAsync(tenantId)).ToList();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading users for tenant {TenantId}", _selectedTenant);
            Snackbar.Add(TranslationService.GetTranslation("superAdmin.loadingUsersError", "Errore nel caricamento degli utenti: {0}", ex.Message), Severity.Error);
        }
        finally
        {
            _isLoadingUsers = false;
        }
    }



    /// <summary>
    /// Clears all active filters and resets search form to initial state.
    /// </summary>
    private async Task ClearFilters()
    {
        _searchTerm = string.Empty;
        _roleFilter = "all";
        _showActiveOnly = false;
        _selectedTenant = string.Empty;
        await Task.CompletedTask;
        StateHasChanged();
    }

    private async Task OnTenantChanged()
    {
        // Update tenant context service with new selection
        if (!string.IsNullOrEmpty(_selectedTenant) && Guid.TryParse(_selectedTenant, out var tenantId))
        {
            var selectedTenant = _tenants.FirstOrDefault(t => t.Id == tenantId);
            await TenantContextService.SetCurrentTenantAsync(tenantId, selectedTenant);
        }
        else
        {
            await TenantContextService.ClearCurrentTenantAsync();
        }
        
        await LoadUsersAsync();
        StateHasChanged();
    }

    private async Task OnSearchChanged()
    {
        // Cancel previous debounce if any
        _searchDebounceCts?.Cancel();
        _searchDebounceCts = new CancellationTokenSource();
        var token = _searchDebounceCts.Token;
        
        try
        {
            await Task.Delay(300, token); // Debounce with cancellation
            if (!token.IsCancellationRequested)
            {
                StateHasChanged();
            }
        }
        catch (OperationCanceledException)
        {
            // Swallow cancellation
        }
    }

    private async Task OnRoleFilterChanged()
    {
        await Task.CompletedTask;
        StateHasChanged();
    }

    private void OnStatusFilterChanged()
    {
        StateHasChanged();
    }

    private async Task ExportUsers()
    {
        try
        {
            // Get filtered users for export
            var usersToExport = _filteredUsers.ToList();
            
            if (!usersToExport.Any())
            {
                Snackbar.Add(TranslationService.GetTranslation("superAdmin.noDataToExport", "Nessun dato da esportare"), Severity.Warning);
                return;
            }

            // Create CSV content
            var csv = new System.Text.StringBuilder();
            
            // Add headers
            csv.AppendLine($"{TranslationService.GetTranslation("field.fullName", "Nome Completo")}," +
                          $"{TranslationService.GetTranslation("field.email", "Email")}," +
                          $"{TranslationService.GetTranslation("field.username", "Username")}," +
                          $"{TranslationService.GetTranslation("field.tenant", "Tenant")}," +
                          $"{TranslationService.GetTranslation("field.roles", "Ruoli")}," +
                          $"{TranslationService.GetTranslation("field.status", "Stato")}," +
                          $"{TranslationService.GetTranslation("field.lastLogin", "Ultimo Accesso")}," +
                          $"{TranslationService.GetTranslation("field.createdAt", "Data Creazione")}");

            // Add data rows
            foreach (var user in usersToExport)
            {
                var statusText = user.IsActive ? 
                    TranslationService.GetTranslation("field.active", "Attivo") : 
                    TranslationService.GetTranslation("field.inactive", "Inattivo");
                
                var lastLogin = user.LastLoginAt?.ToString("dd/MM/yyyy HH:mm") ?? 
                               TranslationService.GetTranslation("common.never", "Mai");
                
                csv.AppendLine($"\"{user.FullName}\"," +
                              $"\"{user.Email}\"," +
                              $"\"{user.Username}\"," +
                              $"\"{user.TenantName ?? "N/A"}\"," +
                              $"\"{string.Join("; ", user.Roles)}\"," +
                              $"\"{statusText}\"," +
                              $"\"{lastLogin}\"," +
                              $"\"{user.CreatedAt:dd/MM/yyyy HH:mm}\"");
            }

            // Create file download
            var fileName = $"users_export_{DateTime.Now:yyyyMMdd_HHmmss}.csv";
            var csvContent = csv.ToString();
            
            // Use JavaScript to download the file
            await JSRuntime.InvokeVoidAsync("downloadFile", fileName, "text/csv", csvContent);
            
            Snackbar.Add(TranslationService.GetTranslation("superAdmin.exportSuccessful", 
                "Esportazione completata: {0} utenti esportati", usersToExport.Count), Severity.Success);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error exporting users");
            Snackbar.Add(TranslationService.GetTranslation("superAdmin.exportError", 
                "Errore durante l'esportazione: {0}", ex.Message), Severity.Error);
        }
    }

    private async Task OpenCreateUserDrawer()
    {
        NavigationManager.NavigateTo("/superadmin/users/new");
        await Task.CompletedTask;
    }

    // Navigation actions
    private void CreateUser()
    {
        NavigationManager.NavigateTo("/superadmin/users/new");
    }

    private void EditUser(Guid id)
    {
        NavigationManager.NavigateTo($"/superadmin/users/{id}");
    }

    private async Task OnUserCreated(UserManagementDto newUser)
    {
        _users.Add(newUser);
        await Task.CompletedTask;
        StateHasChanged();
    }

    private async Task OnUserUpdated(UserManagementDto updatedUser)
    {
        var index = _users.FindIndex(u => u.Id == updatedUser.Id);
        if (index >= 0)
        {
            _users[index] = updatedUser;
        }
        await Task.CompletedTask;
        StateHasChanged();
    }

    /// <summary>
    /// Enhanced impersonation with detailed confirmation and audit logging.
    /// </summary>
    private async Task ImpersonateUser(UserManagementDto user)
    {
        var confirm = await DialogService.ShowMessageBox(
            TranslationService.GetTranslation("common.confirm", "Conferma"),
            TranslationService.GetTranslation("superAdmin.confirmImpersonation", 
                "Sei sicuro di voler impersonificare l'utente '{0}'? Questa azione verrà registrata nei log di audit e terminerà la sessione corrente.", 
                user.FullName),
            yesText: TranslationService.GetTranslation("common.confirm", "Conferma"),
            cancelText: TranslationService.GetTranslation("common.cancel", "Annulla"));

        if (confirm == true)
        {
            try
            {
                // TODO: Implement actual impersonation when API is ready
                Snackbar.Add(TranslationService.GetTranslation("superAdmin.impersonationRequested", 
                    "Impersonificazione di {0} richiesta. Funzionalità in sviluppo.", user.FullName), Severity.Info);
            }
            catch (Exception ex)
            {
                Snackbar.Add(TranslationService.GetTranslation("superAdmin.impersonationError", 
                    "Errore nell'impersonificazione dell'utente: {0}", ex.Message), Severity.Error);
            }
        }
    }

    /// <summary>
    /// Toggles user active status with enhanced confirmation dialog and error handling.
    /// Implements proper audit trail logging and user feedback.
    /// </summary>
    private async Task ToggleUserStatus(UserManagementDto user)
    {
        var actionKey = user.IsActive ? "superAdmin.disableUserAction" : "superAdmin.enableUserAction";
        var actionText = user.IsActive ? 
            TranslationService.GetTranslation("superAdmin.disable", "disabilitare") : 
            TranslationService.GetTranslation("superAdmin.enable", "abilitare");
            
        var confirmTitle = TranslationService.GetTranslation("common.confirm", "Conferma");
        var confirmMessage = TranslationService.GetTranslation("superAdmin.confirmUserStatusChange", 
            "Sei sicuro di voler {0} l'utente '{1}'? Questa azione verrà registrata nei log di audit.", 
            actionText, user.FullName);

        var confirm = await DialogService.ShowMessageBox(
            confirmTitle,
            confirmMessage,
            yesText: TranslationService.GetTranslation("common.confirm", "Conferma"),
            cancelText: TranslationService.GetTranslation("common.cancel", "Annulla"));

        if (confirm == true)
        {
            try
            {
                // Note: For now, just toggle locally - implement actual API call when available
                user.IsActive = !user.IsActive;
                
                var successMessage = user.IsActive 
                    ? TranslationService.GetTranslation("superAdmin.userEnabled", "Utente abilitato con successo!")
                    : TranslationService.GetTranslation("superAdmin.userDisabled", "Utente disabilitato con successo!");
                    
                Snackbar.Add(successMessage, Severity.Success);
                StateHasChanged();
            }
            catch (Exception ex)
            {
                // Revert the change if API call failed
                user.IsActive = !user.IsActive;
                Snackbar.Add(TranslationService.GetTranslation("superAdmin.toggleUserStatusError", 
                    "Errore nel cambio stato dell'utente: {0}", ex.Message), Severity.Error);
            }
        }
    }

    private Color GetRoleColor(string role)
    {
        return role.ToLower() switch
        {
            "superadmin" => Color.Error,
            "admin" => Color.Warning,
            "manager" => Color.Info,
            "user" => Color.Primary,
            _ => Color.Default
        };
    }



    /// <summary>
    /// Resets a user's password with confirmation dialog.
    /// </summary>
    private async Task ResetUserPassword(UserManagementDto user)
    {
        var confirmTitle = TranslationService.GetTranslation("common.confirm", "Conferma");
        var confirmMessage = TranslationService.GetTranslation("superAdmin.confirmPasswordReset", 
            "Sei sicuro di voler reimpostare la password per l'utente '{0}'? Verrà generata una nuova password temporanea che l'utente dovrà cambiare al prossimo accesso.", 
            user.FullName);

        var confirm = await DialogService.ShowMessageBox(
            confirmTitle,
            confirmMessage,
            yesText: TranslationService.GetTranslation("common.reset", "Reimposta"),
            cancelText: TranslationService.GetTranslation("common.cancel", "Annulla"));

        if (confirm == true)
        {
            try
            {
                var resetDto = new ResetPasswordDto
                {
                    Reason = "Password reset by SuperAdmin",
                    SendEmailNotification = true
                };

                var result = await SuperAdminService.ResetUserPasswordAsync(user.Id, resetDto);
                
                if (result.Success)
                {
                    var successMessage = TranslationService.GetTranslation("superAdmin.passwordResetSuccess", 
                        "Password reimpostata con successo per {0}. Nuova password temporanea: {1}", 
                        user.FullName, result.TemporaryPassword ?? "****");
                    
                    Snackbar.Add(successMessage, Severity.Success);
                    
                    // Update user in local collection to reflect password change requirement
                    user.MustChangePassword = true;
                    StateHasChanged();
                }
                else
                {
                    Snackbar.Add(result.Message ?? "Errore sconosciuto durante il reset della password", Severity.Error);
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add(TranslationService.GetTranslation("superAdmin.passwordResetError", 
                    "Errore durante il reset della password: {0}", ex.Message), Severity.Error);
            }
        }
    }

    /// <summary>
    /// Deletes a user with enhanced confirmation dialog and error handling.
    /// </summary>
    private async Task DeleteUser(UserManagementDto user)
    {
        var confirmTitle = TranslationService.GetTranslation("common.confirm", "Conferma");
        var confirmMessage = TranslationService.GetTranslation("superAdmin.confirmUserDeletion", 
            "Sei sicuro di voler eliminare l'utente '{0}'? Questa azione non può essere annullata e verrà registrata nei log di audit.", 
            user.FullName);

        var confirm = await DialogService.ShowMessageBox(
            confirmTitle,
            confirmMessage,
            yesText: TranslationService.GetTranslation("common.delete", "Elimina"),
            cancelText: TranslationService.GetTranslation("common.cancel", "Annulla"));

        if (confirm == true)
        {
            try
            {
                await SuperAdminService.DeleteUserAsync(user.Id);
                
                // Remove from local collection
                _users.Remove(user);
                
                var successMessage = TranslationService.GetTranslation("superAdmin.userDeleted", "Utente eliminato con successo!");
                Snackbar.Add(successMessage, Severity.Success);
                StateHasChanged();
            }
            catch (Exception ex)
            {
                Snackbar.Add(TranslationService.GetTranslation("superAdmin.deleteUserError", 
                    "Errore nell'eliminazione dell'utente: {0}", ex.Message), Severity.Error);
            }
        }
    }

    /// <summary>
    /// Views the audit history for a specific user.
    /// Shows all audit trail entries related to the selected user.
    /// </summary>
    private async Task ViewUserAuditHistory(UserManagementDto user)
    {
        try
        {
            var parameters = new DialogParameters<AuditHistoryDialog>
            {
                { x => x.EntityType, "User" },
                { x => x.EntityId, user.Id },
                { x => x.EntityName, user.FullName }
            };

            await DialogService.ShowAsync<AuditHistoryDialog>(
                TranslationService.GetTranslation("audit.historyDialog.title", "Cronologia Modifiche"),
                parameters,
                _auditDialogOptions);
        }
        catch (Exception ex)
        {
            Snackbar.Add(TranslationService.GetTranslation("superAdmin.userAuditHistoryError", 
                "Errore nell'apertura della cronologia audit per l'utente: {0}", ex.Message), Severity.Error);
        }
    }
    
    #region Bulk Actions
    

    
    /// <summary>
    /// Clears all user selections.
    /// </summary>
    private void ClearSelection()
    {
        _selectedUsers.Clear();
        StateHasChanged();
    }
    
    /// <summary>
    /// Executes bulk actions on selected users.
    /// </summary>
    private async Task ExecuteBulkAction(string action)
    {
        if (!_selectedUserIds.Any())
        {
            Snackbar.Add(TranslationService.GetTranslation("superAdmin.noUsersSelected", "Nessun utente selezionato"), Severity.Warning);
            return;
        }

        var actionName = action switch
        {
            "activate" => TranslationService.GetTranslation("superAdmin.activate", "attivare"),
            "deactivate" => TranslationService.GetTranslation("superAdmin.deactivate", "disattivare"),
            "force-password-change" => TranslationService.GetTranslation("superAdmin.forcePasswordChange", "forzare il cambio password per"),
            _ => action
        };

        var confirmMessage = TranslationService.GetTranslation("superAdmin.confirmBulkAction", 
            "Sei sicuro di voler {0} {1} utenti selezionati? Questa azione verrà registrata nei log di audit.", 
            actionName, _selectedUserIds.Count);

        var confirm = await DialogService.ShowMessageBox(
            TranslationService.GetTranslation("common.confirm", "Conferma"),
            confirmMessage,
            yesText: TranslationService.GetTranslation("common.confirm", "Conferma"),
            cancelText: TranslationService.GetTranslation("common.cancel", "Annulla"));

        if (confirm == true)
        {
            try
            {
                _isExecutingBulkAction = true;
                StateHasChanged();

                var bulkActionDto = new QuickUserActionDto
                {
                    UserIds = _selectedUserIds,
                    Action = action,
                    Reason = $"Bulk action executed by SuperAdmin: {actionName}"
                };

                // TODO: Implement actual bulk action API call when backend supports it
                // var result = await SuperAdminService.ExecuteBulkUserActionAsync(bulkActionDto);
                
                // For now, simulate the action locally
                foreach (var userId in _selectedUserIds)
                {
                    var user = _users.FirstOrDefault(u => u.Id == userId);
                    if (user != null)
                    {
                        switch (action)
                        {
                            case "activate":
                                user.IsActive = true;
                                break;
                            case "deactivate":
                                user.IsActive = false;
                                break;
                            case "force-password-change":
                                user.MustChangePassword = true;
                                break;
                        }
                    }
                }

                ClearSelection();

                var successMessage = TranslationService.GetTranslation("superAdmin.bulkActionSuccess", 
                    "Azione di massa completata con successo per {0} utenti", _selectedUserIds.Count);
                Snackbar.Add(successMessage, Severity.Success);
            }
            catch (Exception ex)
            {
                Snackbar.Add(TranslationService.GetTranslation("superAdmin.bulkActionError", 
                    "Errore nell'esecuzione dell'azione di massa: {0}", ex.Message), Severity.Error);
            }
            finally
            {
                _isExecutingBulkAction = false;
                StateHasChanged();
            }
        }
    }

    private async Task ShowLoginDialogAsync()
    {
        var result = await AuthenticationDialogService.ShowLoginDialogAsync();
        if (result)
        {
            // Reload the page after successful login
            await OnInitializedAsync();
        }
    }
    
    #endregion
}