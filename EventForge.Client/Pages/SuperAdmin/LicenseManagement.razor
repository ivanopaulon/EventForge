@page "/superadmin/license-management"
@using Microsoft.AspNetCore.Authorization
@using EventForge.DTOs.Licensing
@using EventForge.DTOs.Common
@using EventForge.Client.Shared.Components
@using EventForge.Client.Shared.Components.Dashboard
@attribute [Authorize(Roles = "SuperAdmin")]
@inject IAuthService AuthService
@inject ILicenseService LicenseService
@inject NavigationManager NavigationManager
@inject IAuthenticationDialogService AuthenticationDialogService
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject ITranslationService TranslationService
@inject ILogger<LicenseManagement> Logger

<PageLoadingOverlay Visible="_isLoading || _isLoadingEntities"
                     Message="@(_isLoading ? TranslationService.GetTranslation("messages.loadingPage", "Caricamento pagina...") : TranslationService.GetTranslation("common.loading", "Caricamento..."))" />

@if (!_isLoading)
{
    <div class="license-page-root">
        <div class="license-top">
            <ManagementDashboard TItem="LicenseDto"
                                 Items="_filteredLicenses"
                                 Metrics="_dashboardMetrics"
                                 EntityType="License"
                                 AllowConfiguration="false"
                                 UseServerSide="false" />
        </div>

        <div class="eftable-wrapper">
            <EFTable @ref="_efTable"
                     TItem="LicenseDto"
                     Items="_filteredLicenses"
                     IsLoading="_isLoadingEntities"
                     ComponentKey="LicenseManagement"
                     InitialColumnConfigurations="_initialColumns">
                <ToolBarContent>
                    <MudText Typo="Typo.h5">
                        @TranslationService.GetTranslation("superAdmin.licenseManagement", "Gestione Licenze")
                    </MudText>
                    <MudSpacer />
                    <MudTextField @bind-Value="_searchTerm"
                                  @bind-Value:after="OnSearchChanged"
                                  Label="@TranslationService.GetTranslation("license.search", "Cerca licenze")"
                                  Placeholder="@TranslationService.GetTranslation("license.searchPlaceholder", "Inserisci nome...")"
                                  Variant="Variant.Outlined"
                                  Adornment="Adornment.End"
                                  AdornmentIcon="@Icons.Material.Outlined.Search"
                                  Clearable="true"
                                  Class="ef-input" />
                    <MudSelect T="int?" @bind-Value="_tierFilter" @bind-Value:after="OnTierFilterChanged"
                               Label="@TranslationService.GetTranslation("license.tierLevel", "Tier")"
                               Variant="Variant.Outlined"
                               Clearable="true"
                               Class="ef-input"
                               Style="min-width: 120px;">
                        <MudSelectItem Value="@((int?)null)">@TranslationService.GetTranslation("filter.all", "Tutti")</MudSelectItem>
                        @for (int i = 1; i <= 10; i++)
                        {
                            <MudSelectItem Value="@i">Tier @i</MudSelectItem>
                        }
                    </MudSelect>
                    <MudSwitch T="bool?" @bind-Value="_statusFilter" @bind-Value:after="OnStatusFilterChanged"
                               Label="@TranslationService.GetTranslation("status.active", "Solo Attive")"
                               Color="Color.Success"
                               ThumbIcon="@(_statusFilter == true ? Icons.Material.Filled.Done : null)" />
                    <ManagementTableToolbar ShowRefresh="true"
                                            ShowCreate="true"
                                            ShowExport="true"
                                            CreateTooltip="license.createNew"
                                            IsDisabled="_isLoadingEntities"
                                            OnRefresh="@LoadLicenses"
                                            OnCreate="@CreateLicense"
                                            OnExport="@ExportLicenses" />
                </ToolBarContent>
                <HeaderContent Context="columnConfigurations">
                    @foreach (var column in columnConfigurations.Where(c => c.IsVisible).OrderBy(c => c.Order))
                    {
                        @if (column.PropertyName == "Name")
                        {
                            <EFTableColumnHeader TItem="LicenseDto" PropertyName="Name" OnDragStartCallback="@_efTable.HandleColumnDragStart">
                                <MudTableSortLabel SortBy="@(new Func<LicenseDto, object>(x => x.Name))">@TranslationService.GetTranslation("field.name", "Nome")</MudTableSortLabel>
                            </EFTableColumnHeader>
                        }
                        else if (column.PropertyName == "DisplayName")
                        {
                            <EFTableColumnHeader TItem="LicenseDto" PropertyName="DisplayName" OnDragStartCallback="@_efTable.HandleColumnDragStart">
                                <MudTableSortLabel SortBy="@(new Func<LicenseDto, object>(x => x.DisplayName))">@TranslationService.GetTranslation("field.displayName", "Nome Visualizzato")</MudTableSortLabel>
                            </EFTableColumnHeader>
                        }
                        else if (column.PropertyName == "TierLevel")
                        {
                            <EFTableColumnHeader TItem="LicenseDto" PropertyName="TierLevel" OnDragStartCallback="@_efTable.HandleColumnDragStart">
                                <MudTableSortLabel SortBy="@(new Func<LicenseDto, object>(x => x.TierLevel))">@TranslationService.GetTranslation("license.tierLevel", "Tier")</MudTableSortLabel>
                            </EFTableColumnHeader>
                        }
                        else if (column.PropertyName == "MaxUsers")
                        {
                            <EFTableColumnHeader TItem="LicenseDto" PropertyName="MaxUsers" OnDragStartCallback="@_efTable.HandleColumnDragStart">
                                <MudTableSortLabel SortBy="@(new Func<LicenseDto, object>(x => x.MaxUsers))">@TranslationService.GetTranslation("license.maxUsers", "Max Utenti")</MudTableSortLabel>
                            </EFTableColumnHeader>
                        }
                        else if (column.PropertyName == "MaxApiCallsPerMonth")
                        {
                            <EFTableColumnHeader TItem="LicenseDto" PropertyName="MaxApiCallsPerMonth" OnDragStartCallback="@_efTable.HandleColumnDragStart">
                                <MudTableSortLabel SortBy="@(new Func<LicenseDto, object>(x => x.MaxApiCallsPerMonth))">@TranslationService.GetTranslation("license.maxApiCalls", "Max API/Mese")</MudTableSortLabel>
                            </EFTableColumnHeader>
                        }
                        else if (column.PropertyName == "TenantCount")
                        {
                            <EFTableColumnHeader TItem="LicenseDto" PropertyName="TenantCount" OnDragStartCallback="@_efTable.HandleColumnDragStart">
                                <MudTableSortLabel SortBy="@(new Func<LicenseDto, object>(x => x.TenantCount))">@TranslationService.GetTranslation("license.tenantCount", "Tenant")</MudTableSortLabel>
                            </EFTableColumnHeader>
                        }
                        else if (column.PropertyName == "IsActive")
                        {
                            <EFTableColumnHeader TItem="LicenseDto" PropertyName="IsActive" OnDragStartCallback="@_efTable.HandleColumnDragStart">
                                <MudTableSortLabel SortBy="@(new Func<LicenseDto, object>(x => x.IsActive))">@TranslationService.GetTranslation("field.status", "Stato")</MudTableSortLabel>
                            </EFTableColumnHeader>
                        }
                    }
                    <MudTh Class="text-center" Style="min-width:120px;">@TranslationService.GetTranslation("common.actions", "Azioni")</MudTh>
                </HeaderContent>

                <RowTemplate Context="item">
                    @{
                        var visibleColumns = _efTable?.ColumnConfigurations?.Where(c => c.IsVisible).OrderBy(c => c.Order).ToList() ?? _initialColumns.Where(c => c.IsVisible).OrderBy(c => c.Order).ToList();
                    }
                    @foreach (var column in visibleColumns)
                    {
                        @if (column.PropertyName == "Name")
                        {
                            <MudTd DataLabel="@TranslationService.GetTranslation("field.name", "Nome")">
                                <MudChip T="string" Size="Size.Small" Color="Color.Primary" Variant="Variant.Outlined">
                                    @item.Name
                                </MudChip>
                            </MudTd>
                        }
                        else if (column.PropertyName == "DisplayName")
                        {
                            <MudTd DataLabel="@TranslationService.GetTranslation("field.displayName", "Nome Visualizzato")">
                                <div class="d-flex align-center">
                                    <MudAvatar Color="Color.Primary" Size="Size.Small" Class="mr-2">
                                        <MudIcon Icon="@Icons.Material.Outlined.Security" />
                                    </MudAvatar>
                                    <div>
                                        <MudText Typo="Typo.body2">@item.DisplayName</MudText>
                                        <MudText Typo="Typo.caption" Class="mud-text-secondary">ID: @(item.Id.ToString()[..Math.Min(8, item.Id.ToString().Length)])...</MudText>
                                    </div>
                                </div>
                            </MudTd>
                        }
                        else if (column.PropertyName == "TierLevel")
                        {
                            <MudTd DataLabel="@TranslationService.GetTranslation("license.tierLevel", "Tier")">
                                <MudChip T="string" Size="Size.Small" Color="@GetTierColor(item.TierLevel)">
                                    Tier @item.TierLevel
                                </MudChip>
                            </MudTd>
                        }
                        else if (column.PropertyName == "MaxUsers")
                        {
                            <MudTd DataLabel="@TranslationService.GetTranslation("license.maxUsers", "Max Utenti")">
                                <MudText Typo="Typo.body2">@item.MaxUsers.ToString("N0")</MudText>
                            </MudTd>
                        }
                        else if (column.PropertyName == "MaxApiCallsPerMonth")
                        {
                            <MudTd DataLabel="@TranslationService.GetTranslation("license.maxApiCalls", "Max API/Mese")">
                                <MudText Typo="Typo.body2">@item.MaxApiCallsPerMonth.ToString("N0")</MudText>
                            </MudTd>
                        }
                        else if (column.PropertyName == "TenantCount")
                        {
                            <MudTd DataLabel="@TranslationService.GetTranslation("license.tenantCount", "Tenant")">
                                <MudBadge Content="@item.TenantCount" Color="Color.Primary" Overlap="true" Bordered="true">
                                    <MudIcon Icon="@Icons.Material.Outlined.Business" />
                                </MudBadge>
                            </MudTd>
                        }
                        else if (column.PropertyName == "IsActive")
                        {
                            <MudTd DataLabel="@TranslationService.GetTranslation("field.status", "Stato")">
                                <MudChip T="string" 
                                         Size="Size.Small" 
                                         Color="@(item.IsActive ? Color.Success : Color.Error)"
                                         Icon="@(item.IsActive ? Icons.Material.Outlined.CheckCircle : Icons.Material.Outlined.Cancel)">
                                    @(item.IsActive ? TranslationService.GetTranslation("status.active", "Attiva") : TranslationService.GetTranslation("status.inactive", "Inattiva"))
                                </MudChip>
                            </MudTd>
                        }
                    }
                    <MudTd DataLabel="@TranslationService.GetTranslation("common.actions", "Azioni")" Class="text-center">
                        <ActionButtonGroup EntityName="@item.DisplayName"
                                           ItemDisplayName="@item.DisplayName"
                                           ShowView="false"
                                           ShowEdit="true"
                                           ShowDelete="true"
                                           OnEdit="@(() => EditLicense(item.Id))"
                                           OnDelete="@(() => DeleteLicense(item))" />
                    </MudTd>
                </RowTemplate>

                <NoRecordsContent>
                    <div class="text-center pa-2 pa-sm-3 pa-md-4">
                        <MudIcon Icon="@Icons.Material.Outlined.Security" Size="Size.Medium" Class="mb-4 mud-text-secondary" />
                        <MudText Typo="Typo.h6" Class="mb-2">
                            @(_licenses.Any() ? 
                                TranslationService.GetTranslation("license.noFilteredLicenses", "Nessuna licenza corrisponde ai filtri applicati") : 
                                TranslationService.GetTranslation("license.noLicenses", "Nessuna licenza trovata"))
                        </MudText>
                        @if (_licenses.Any())
                        {
                            <MudButton Variant="Variant.Text" 
                                       Color="Color.Primary" 
                                       StartIcon="@Icons.Material.Outlined.Clear"
                                       OnClick="@ClearFilters">
                                @TranslationService.GetTranslation("action.clearFilters", "Cancella filtri")
                            </MudButton>
                        }
                    </div>
                </NoRecordsContent>
            </EFTable>
        </div>
    </div>
}

@code {
    // UI State Management
    private bool _isLoading = true;
    private bool _isLoadingEntities = false;

    // Filter and search state
    private string _searchTerm = string.Empty;
    private bool? _statusFilter = null;
    private int? _tierFilter = null;

    // Data collections
    private List<LicenseDto> _licenses = new();

    // EFTable reference
    private EFTable<LicenseDto> _efTable = null!;

    // Column configuration for EFTable
    private List<EFTableColumnConfiguration> _initialColumns = new()
    {
        new() { PropertyName = "Name", DisplayName = "Nome", IsVisible = true, Order = 0 },
        new() { PropertyName = "DisplayName", DisplayName = "Nome Visualizzato", IsVisible = true, Order = 1 },
        new() { PropertyName = "TierLevel", DisplayName = "Tier", IsVisible = true, Order = 2 },
        new() { PropertyName = "MaxUsers", DisplayName = "Max Utenti", IsVisible = true, Order = 3 },
        new() { PropertyName = "MaxApiCallsPerMonth", DisplayName = "Max API/Mese", IsVisible = true, Order = 4 },
        new() { PropertyName = "TenantCount", DisplayName = "Tenant", IsVisible = true, Order = 5 },
        new() { PropertyName = "IsActive", DisplayName = "Stato", IsVisible = true, Order = 6 }
    };

    // Dashboard configuration
    private List<DashboardMetric<LicenseDto>> _dashboardMetrics = new()
    {
        new()
        {
            Title = "Totale Licenze",
            Type = MetricType.Count,
            Icon = Icons.Material.Outlined.Security,
            Color = "primary",
            Description = "Numero totale di licenze",
            Format = "N0"
        },
        new()
        {
            Title = "Licenze Attive",
            Type = MetricType.Count,
            Filter = l => l.IsActive,
            Icon = Icons.Material.Outlined.CheckCircle,
            Color = "success",
            Description = "Licenze attive",
            Format = "N0"
        },
        new()
        {
            Title = "Licenze Assegnate",
            Type = MetricType.Count,
            Filter = l => l.TenantCount > 0,
            Icon = Icons.Material.Outlined.Assignment,
            Color = "info",
            Description = "Licenze con tenant assegnati",
            Format = "N0"
        },
        new()
        {
            Title = "Totale Tenant",
            Type = MetricType.Sum,
            ValueSelector = l => l.TenantCount,
            Icon = Icons.Material.Outlined.Business,
            Color = "warning",
            Description = "Totale tenant con licenza",
            Format = "N0"
        }
    };

    /// <summary>
    /// Computed property for filtered licenses based on search criteria.
    /// </summary>
    private IEnumerable<LicenseDto> _filteredLicenses => 
        _licenses.Where(l => 
            // Search filter
            (string.IsNullOrEmpty(_searchTerm) || 
             l.Name.Contains(_searchTerm, StringComparison.OrdinalIgnoreCase) ||
             l.DisplayName.Contains(_searchTerm, StringComparison.OrdinalIgnoreCase) ||
             (l.Description != null && l.Description.Contains(_searchTerm, StringComparison.OrdinalIgnoreCase))) &&
            // Status filter
            (!_statusFilter.HasValue || l.IsActive == _statusFilter.Value) &&
            // Tier filter
            (!_tierFilter.HasValue || l.TierLevel == _tierFilter.Value));

    /// <summary>
    /// Component initialization.
    /// </summary>
    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Check authentication
            var isAuthenticated = await AuthService.IsAuthenticatedAsync();
            if (!isAuthenticated)
            {
                await ShowLoginDialogAsync();
                return;
            }

            // SuperAdmin role verification
            var isSuperAdmin = await AuthService.IsSuperAdminAsync();
            if (!isSuperAdmin)
            {
                Snackbar.Add(TranslationService.GetTranslation("superAdmin.accessDeniedSuperAdmin", "Accesso negato. È richiesto il ruolo Super Amministratore."), Severity.Warning);
                NavigationManager.NavigateTo("/");
                return;
            }

            // Load licenses
            await LoadLicenses();
        }
        catch (Exception ex)
        {
            Snackbar.Add(TranslationService.GetTranslation("error.loadFailed", "Errore durante il caricamento: {0}", ex.Message), Severity.Error);
            Logger.LogError(ex, "Error loading license management page");
        }
        finally
        {
            _isLoading = false;
        }
    }

    /// <summary>
    /// Loads license data.
    /// </summary>
    private async Task LoadLicenses()
    {
        try
        {
            _isLoadingEntities = true;
            var licenses = await LicenseService.GetLicensesAsync();
            _licenses = licenses.ToList();
        }
        catch (Exception ex)
        {
            Snackbar.Add(TranslationService.GetTranslation("error.loadFailed", "Errore durante il caricamento delle licenze: {0}", ex.Message), Severity.Error);
            Logger.LogError(ex, "Error loading licenses");
        }
        finally
        {
            _isLoadingEntities = false;
        }
    }

    /// <summary>
    /// Clears all active filters.
    /// </summary>
    private void ClearFilters()
    {
        _searchTerm = string.Empty;
        _statusFilter = null;
        _tierFilter = null;
        StateHasChanged();
    }

    private void OnSearchChanged()
    {
        StateHasChanged();
    }

    private void OnStatusFilterChanged()
    {
        StateHasChanged();
    }

    private void OnTierFilterChanged()
    {
        StateHasChanged();
    }

    private Color GetTierColor(int tierLevel)
    {
        return tierLevel switch
        {
            1 => Color.Secondary,
            2 => Color.Info,
            3 => Color.Primary,
            4 => Color.Success,
            >= 5 => Color.Warning,
            _ => Color.Default
        };
    }

    private void CreateLicense()
    {
        NavigationManager.NavigateTo("/superadmin/licenses/new");
    }

    private void EditLicense(Guid id)
    {
        NavigationManager.NavigateTo($"/superadmin/licenses/{id}");
    }

    private async Task DeleteLicense(LicenseDto license)
    {
        var confirmTitle = TranslationService.GetTranslation("common.confirm", "Conferma");
        var confirmMessage = TranslationService.GetTranslation("license.confirmDelete", 
            "Sei sicuro di voler eliminare la licenza '{0}'? Questa azione non può essere annullata.", 
            license.DisplayName);

        var confirm = await DialogService.ShowMessageBox(
            confirmTitle,
            confirmMessage,
            yesText: TranslationService.GetTranslation("common.delete", "Elimina"),
            cancelText: TranslationService.GetTranslation("common.cancel", "Annulla"));

        if (confirm == true)
        {
            try
            {
                await LicenseService.DeleteLicenseAsync(license.Id);
                _licenses.Remove(license);
                Snackbar.Add(TranslationService.GetTranslation("license.deleted", "Licenza eliminata con successo!"), Severity.Success);
                StateHasChanged();
            }
            catch (Exception ex)
            {
                Snackbar.Add(TranslationService.GetTranslation("error.deleteFailed", 
                    "Errore nell'eliminazione della licenza: {0}", ex.Message), Severity.Error);
                Logger.LogError(ex, "Error deleting license {LicenseId}", license.Id);
            }
        }
    }

    private async Task ExportLicenses()
    {
        Snackbar.Add(TranslationService.GetTranslation("superAdmin.exportFunctionalityComingSoon", "La funzionalità di esportazione sarà implementata presto."), Severity.Info);
        await Task.CompletedTask;
    }

    private async Task ShowLoginDialogAsync()
    {
        var result = await AuthenticationDialogService.ShowLoginDialogAsync();
        if (result)
        {
            // Reload the page after successful login
            await OnInitializedAsync();
        }
    }
}