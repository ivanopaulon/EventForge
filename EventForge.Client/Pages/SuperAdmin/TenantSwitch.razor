@page "/superadmin/tenant-switch"
@using Microsoft.AspNetCore.Authorization
@using EventForge.Client.Shared.Components
@using EventForge.DTOs.SuperAdmin
@using EventForge.DTOs.Tenants
@using EventForge.DTOs.Common
@attribute [Authorize(Roles = "SuperAdmin")]
@inject IAuthService AuthService
@inject NavigationManager NavigationManager
@inject IAuthenticationDialogService AuthenticationDialogService
@inject ISnackbar Snackbar
@inject ITranslationService TranslationService
@inject ISuperAdminService SuperAdminService
@inject IHttpClientService HttpClientService
@inject ILogger<TenantSwitch> Logger

<SuperAdminPageLayout PageTitle="@TranslationService.GetTranslation("superAdmin.tenantSwitch", "Switch Tenant")"
                      PageIcon="@Icons.Material.Outlined.SwapHoriz"
                      IsLoading="_isLoading"
                      IsAuthorized="_isAuthorized"
                      OnNavigateHome="@(() => NavigationManager.NavigateTo("/"))">

    <!-- Current Status Section -->
    <SuperAdminCollapsibleSection SectionTitle="@TranslationService.GetTranslation("superAdmin.currentStatus", "Stato Corrente")"
                                  SectionIcon="@Icons.Material.Outlined.AdminPanelSettings"
                                  @bind-IsExpanded="_statusExpanded">
        <div class="d-flex align-center">
            <MudAvatar Color="Color.Primary" Size="Size.Medium" Class="mr-2">
                <MudIcon Icon="@Icons.Material.Outlined.AdminPanelSettings" />
            </MudAvatar>
            <div>
                <MudText Typo="Typo.h6">@TranslationService.GetTranslation("superAdmin.superAdministrator", "Super Amministratore: {0}", _currentUser?.FullName ?? "N/A")</MudText>
                <div class="d-flex ga-2 mt-2">
                    <MudChip T="string" Color="Color.Warning" Size="Size.Small">Super Admin</MudChip>
                    @if (_isImpersonating)
                    {
                        <MudChip T="string" Color="Color.Error" Size="Size.Small">@TranslationService.GetTranslation("superAdmin.impersonationMode", "Modalità Impersonazione")</MudChip>
                    }
                    @if (!string.IsNullOrEmpty(_currentTenant))
                    {
                        <MudChip T="string" Color="Color.Info" Size="Size.Small">@TranslationService.GetTranslation("superAdmin.tenantContext", "Tenant: {0}", _currentTenant)</MudChip>
                    }
                </div>
            </div>
        </div>
    </SuperAdminCollapsibleSection>

    <!-- Switch Tenant Section -->
    <SuperAdminCollapsibleSection SectionTitle="@TranslationService.GetTranslation("superAdmin.changeTenantContext", "Cambia Contesto Tenant")"
                                  SectionIcon="@Icons.Material.Outlined.Business"
                                  @bind-IsExpanded="_tenantSwitchExpanded">
        <MudStack Spacing="3">
            <MudSelect T="Guid?" @bind-Value="_selectedTenantId" 
                       Label="@TranslationService.GetTranslation("superAdmin.selectTenant", "Seleziona Tenant")" 
                       Variant="Variant.Outlined"
                       FullWidth="true">
                <MudSelectItem Value="@((Guid?)null)">@TranslationService.GetTranslation("superAdmin.noTenantSuperAdminMode", "Nessun tenant (modalità SuperAdmin)")</MudSelectItem>
                @foreach (var tenant in _tenants)
                {
                    <MudSelectItem Value="@((Guid?)tenant.Id)">@tenant.Name</MudSelectItem>
                }
            </MudSelect>
            
            <MudTextField @bind-Value="_switchReason"
                          Label="@TranslationService.GetTranslation("superAdmin.switchReason", "Motivo del cambio (audit)")"
                          Variant="Variant.Outlined"
                          Lines="2"
                          Placeholder="@TranslationService.GetTranslation("superAdmin.switchReasonPlaceholder", "Es: Supporto tecnico, verifica configurazione...")" />

            <MudStack Row="true" Spacing="2">
                <MudTooltip Text="@TranslationService.GetTranslation("tooltip.switchTenant", "Cambia contesto tenant")">
                    <MudIconButton Icon="@Icons.Material.Outlined.SwapHoriz"
                                   Color="Color.Primary"
                                   aria-label="@TranslationService.GetTranslation("superAdmin.changeTenant", "Cambia Tenant")"
                                   OnClick="@(() => SwitchTenant())"
                                   Disabled="@(string.IsNullOrWhiteSpace(_switchReason))" />
                </MudTooltip>
                
                @if (!string.IsNullOrEmpty(_currentTenant))
                {
                    <MudTooltip Text="@TranslationService.GetTranslation("tooltip.restoreContext", "Ripristina contesto originale")">
                        <MudIconButton Icon="@Icons.Material.Outlined.Restore"
                                       Color="Color.Secondary"
                                       aria-label="@TranslationService.GetTranslation("superAdmin.restoreOriginalContext", "Ripristina Contesto Originale")"
                                       OnClick="@(() => RestoreOriginalContext())" />
                    </MudTooltip>
                }
            </MudStack>
        </MudStack>

        <MudAlert Severity="Severity.Info" Icon="@Icons.Material.Outlined.Info" Class="mt-3">
            <strong>@TranslationService.GetTranslation("superAdmin.integrationTodo", "TODO:"):</strong> @TranslationService.GetTranslation("superAdmin.integrationTodo", "Integrare con API per"):
            <ul class="mt-2">
                <li>@TranslationService.GetTranslation("superAdmin.recoverTenantList", "Recuperare lista tenant gestibili dal SuperAdmin")</li>
                <li>@TranslationService.GetTranslation("superAdmin.performTenantSwitch", "Effettuare switch di contesto al tenant selezionato")</li>
                <li>@TranslationService.GetTranslation("superAdmin.registerAuditOperation", "Registrare operazione nell'audit trail")</li>
            </ul>
        </MudAlert>
    </SuperAdminCollapsibleSection>

    <!-- User Impersonation Section -->
    <SuperAdminCollapsibleSection SectionTitle="@TranslationService.GetTranslation("superAdmin.userImpersonation", "Impersonazione Utente")"
                                  SectionIcon="@Icons.Material.Outlined.Person"
                                  @bind-IsExpanded="_impersonationExpanded">
        @if (_isImpersonating)
                        {
                            <MudAlert Severity="Severity.Warning" Icon="@Icons.Material.Outlined.Warning" Class="mb-3">
                                <strong>@TranslationService.GetTranslation("superAdmin.impersonationModeActive", "Modalità Impersonazione Attiva")</strong><br />
                                @TranslationService.GetTranslation("superAdmin.operatingAsAnotherUser", "Stai operando come un altro utente. Tutte le azioni verranno registrate.")
                            </MudAlert>
                            
                            <MudStack Spacing="3">
                                <MudTextField @bind-Value="_endImpersonationReason"
                                              Label="@TranslationService.GetTranslation("superAdmin.endImpersonationReason", "Motivo fine impersonazione (audit)")"
                                              Variant="Variant.Outlined"
                                              Lines="2" />
                                              
                                <MudButton Variant="Variant.Filled" 
                                           Color="Color.Error"
                                           StartIcon="@Icons.Material.Outlined.ExitToApp"
                                           OnClick="EndImpersonation"
                                           Disabled="@(string.IsNullOrWhiteSpace(_endImpersonationReason))">
                                    @TranslationService.GetTranslation("superAdmin.endImpersonation", "Termina Impersonazione")
                                </MudButton>
                            </MudStack>
                        }
                        else
                        {
                            <MudStack Spacing="3">
                                <MudAutocomplete T="UserManagementDto" 
                                                 @bind-Value="_selectedUser"
                                                 Label="@TranslationService.GetTranslation("superAdmin.targetUsername", "Seleziona Utente da Impersonare")"
                                                 SearchFunc="SearchUsersAsync"
                                                 ToStringFunc="@(u => u?.FullName ?? "")"
                                                 Variant="Variant.Outlined"
                                                 ResetValueOnEmptyText="true"
                                                 CoerceText="false"
                                                 CoerceValue="false" />
                                
                                <MudTextField @bind-Value="_impersonationReason"
                                              Label="@TranslationService.GetTranslation("superAdmin.impersonationReason", "Motivo impersonazione (audit)")"
                                              Variant="Variant.Outlined"
                                              Lines="2"
                                              Placeholder="@TranslationService.GetTranslation("superAdmin.impersonationReasonPlaceholder", "Es: Supporto tecnico urgente...")" />

                                <MudButton Variant="Variant.Filled" 
                                           Color="Color.Primary"
                                           StartIcon="@Icons.Material.Outlined.PersonOutline"
                                           OnClick="StartImpersonation"
                                           Disabled="@(_selectedUser == null || string.IsNullOrWhiteSpace(_impersonationReason))">
                                    @TranslationService.GetTranslation("superAdmin.startImpersonation", "Avvia Impersonazione")
                                </MudButton>
                            </MudStack>
                        }

                        <MudAlert Severity="Severity.Warning" Icon="@Icons.Material.Outlined.Warning" Class="mt-3">
                            <strong>@TranslationService.GetTranslation("common.warning", "ATTENZIONE"):</strong> @TranslationService.GetTranslation("superAdmin.impersonationWarning", "L'impersonazione è una funzionalità critica che deve essere utilizzata solo per supporto tecnico urgente. Tutte le operazioni vengono registrate nell'audit trail.")
                        </MudAlert>

        <MudAlert Severity="Severity.Info" Icon="@Icons.Material.Outlined.Info" Class="mt-2">
            <strong>@TranslationService.GetTranslation("superAdmin.implementImpersonationApi", "TODO:"):</strong> @TranslationService.GetTranslation("superAdmin.implementImpersonationApi", "Implementare API per impersonazione utente con audit completo.")
        </MudAlert>
    </SuperAdminCollapsibleSection>

    <!-- Recent History Section -->
    <SuperAdminCollapsibleSection SectionTitle="@TranslationService.GetTranslation("superAdmin.recentSwitchHistory", "Cronologia Switch Recenti")"
                                  SectionIcon="@Icons.Material.Outlined.History"
                                  @bind-IsExpanded="_historyExpanded">
        <div class="d-flex justify-end ga-1 mb-2">
            <MudTooltip Text="@TranslationService.GetTranslation("tooltip.refresh", "Aggiorna dati")">
                <MudIconButton Icon="@Icons.Material.Outlined.Refresh" 
                               Color="Color.Primary"
                               Size="Size.Small"
                               aria-label="@TranslationService.GetTranslation("tooltip.refresh", "Aggiorna dati")"
                               OnClick="@LoadSwitchHistoryAsync" />
            </MudTooltip>
            <MudTooltip Text="@TranslationService.GetTranslation("tooltip.export", "Esporta dati")">
                <MudIconButton Icon="@Icons.Material.Outlined.Download" 
                               Color="Color.Secondary"
                               Size="Size.Small"
                               aria-label="@TranslationService.GetTranslation("tooltip.export", "Esporta dati")"
                               OnClick="@ExportSwitchHistory" />
            </MudTooltip>
        </div>
        
        <MudAlert Severity="Severity.Info" Icon="@Icons.Material.Outlined.Info" Class="mb-4">
            <strong>@TranslationService.GetTranslation("superAdmin.integrationTodo", "TODO:"):</strong> @TranslationService.GetTranslation("superAdmin.switchHistoryDescription", "Implementare recupero cronologia switch tenant e impersonazioni.")
            <br />
            @TranslationService.GetTranslation("superAdmin.switchHistoryFields", "La cronologia dovrebbe includere: data e ora dell'operazione, tipo di operazione (switch tenant, impersonazione), tenant/utente target, motivo dell'operazione, durata dell'operazione, indirizzo IP e user agent.")
        </MudAlert>

        <!-- Table with server-side pagination, sortable columns, horizontal scrolling -->
        <MudTable T="TenantSwitchHistoryDto" Items="@_switchHistory" 
                  Hover="true" 
                  Striped="true"
                  Dense="true"
                  Elevation="0"
                  Class="overflow-x-auto">
            <HeaderContent>
                <MudTh>@TranslationService.GetTranslation("superAdmin.dateTime", "Data/Ora")</MudTh>
                <MudTh>@TranslationService.GetTranslation("superAdmin.user", "Utente")</MudTh>
                <MudTh>@TranslationService.GetTranslation("superAdmin.fromTenant", "Da Tenant")</MudTh>
                <MudTh>@TranslationService.GetTranslation("superAdmin.toTenant", "A Tenant")</MudTh>
                <MudTh>@TranslationService.GetTranslation("superAdmin.reason", "Motivo")</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="@TranslationService.GetTranslation("superAdmin.dateTime", "Data/Ora")">@context.SwitchedAt.ToString("dd/MM/yyyy HH:mm")</MudTd>
                <MudTd DataLabel="@TranslationService.GetTranslation("superAdmin.user", "Utente")">@context.Username</MudTd>
                <MudTd DataLabel="@TranslationService.GetTranslation("superAdmin.fromTenant", "Da Tenant")">@(context.FromTenantName ?? "N/A")</MudTd>
                <MudTd DataLabel="@TranslationService.GetTranslation("superAdmin.toTenant", "A Tenant")">@context.ToTenantName</MudTd>
                <MudTd DataLabel="@TranslationService.GetTranslation("superAdmin.reason", "Motivo")">@(context.Reason ?? "N/A")</MudTd>
            </RowTemplate>
            <NoRecordsContent>
                <MudText>@TranslationService.GetTranslation("superAdmin.noSwitchHistory", "Nessuno switch registrato")</MudText>
            </NoRecordsContent>
        </MudTable>
    </SuperAdminCollapsibleSection>

</SuperAdminPageLayout>
@code {
    private bool _isLoading = true;
    private bool _isAuthorized = false;
    private UserDto? _currentUser;
    private Guid? _selectedTenantId;
    private string _switchReason = string.Empty;
    private string _impersonationReason = string.Empty;
    private string _endImpersonationReason = string.Empty;
    private string _currentTenant = string.Empty;
    private bool _isImpersonating = false;
    
    // Impersonation
    private UserManagementDto? _selectedUser;
    
    // History
    private List<TenantSwitchHistoryDto> _switchHistory = new();
    
    // Tenant list
    private List<TenantResponseDto> _tenants = new();
    
    // Current context
    private CurrentContextDto? _currentContext;
    
    // MudCollapse expanded states (closed by default as per requirements)
    private bool _statusExpanded = false;
    private bool _tenantSwitchExpanded = false;
    private bool _impersonationExpanded = false;
    private bool _historyExpanded = false;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Verifica autenticazione
            var isAuthenticated = await AuthService.IsAuthenticatedAsync();
            if (!isAuthenticated)
            {
                await ShowLoginDialogAsync();
                return;
            }

            // Verifica ruolo SuperAdmin
            var isSuperAdmin = await AuthService.IsSuperAdminAsync();
            if (!isSuperAdmin)
            {
                _isAuthorized = false;
                _isLoading = false;
                Snackbar.Add(TranslationService.GetTranslation("superAdmin.accessDeniedSuperAdmin", "Accesso negato. È richiesto il ruolo Super Amministratore."), Severity.Warning);
                return;
            }

            // Carica informazioni utente corrente
            _currentUser = await AuthService.GetCurrentUserAsync();
            _isAuthorized = true;

            // Carica contesto corrente
            try
            {
                _currentContext = await HttpClientService.GetAsync<CurrentContextDto>("api/v1/tenant-switch/context");
                if (_currentContext != null)
                {
                    _currentTenant = _currentContext.CurrentTenantName ?? string.Empty;
                    _isImpersonating = _currentContext.IsImpersonating;
                }
            }
            catch (Exception ex)
            {
                Logger.LogWarning(ex, "Failed to load current context");
            }

            // Carica lista tenant attivi
            try
            {
                var allTenants = await SuperAdminService.GetTenantsAsync();
                _tenants = allTenants.Where(t => t.IsActive).ToList();
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Failed to load tenants");
                Snackbar.Add(TranslationService.GetTranslation("superAdmin.errorLoadingTenants", "Errore nel caricamento dei tenant"), Severity.Error);
            }

            // Carica cronologia switch
            await LoadSwitchHistoryAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error in OnInitializedAsync");
            Snackbar.Add(TranslationService.GetTranslation("superAdmin.loadingPageError", "Errore nel caricamento della pagina: {0}", ex.Message), Severity.Error);
            NavigationManager.NavigateTo("/");
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task SwitchTenant()
    {
        if (!_selectedTenantId.HasValue || string.IsNullOrWhiteSpace(_switchReason))
        {
            Snackbar.Add(TranslationService.GetTranslation("superAdmin.selectTenantAndReason", "Seleziona un tenant e specifica un motivo"), Severity.Warning);
            return;
        }

        try
        {
            var switchDto = new TenantSwitchWithAuditDto
            {
                TenantId = _selectedTenantId.Value,
                TargetTenantId = _selectedTenantId.Value,
                Reason = _switchReason,
                CreateAuditEntry = true
            };

            var result = await HttpClientService.PostAsync<TenantSwitchWithAuditDto, CurrentContextDto>("api/v1/tenant-switch/switch", switchDto);
            
            if (result != null)
            {
                _currentTenant = result.CurrentTenantName ?? string.Empty;
                _currentContext = result;
                Snackbar.Add(TranslationService.GetTranslation("superAdmin.tenantSwitchSuccess", "Switch tenant completato con successo"), Severity.Success);
                
                // Ricarica cronologia
                await LoadSwitchHistoryAsync();
                
                // Reset form
                _switchReason = string.Empty;
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error switching tenant");
            Snackbar.Add(TranslationService.GetTranslation("superAdmin.tenantSwitchError", "Errore durante lo switch tenant: {0}", ex.Message), Severity.Error);
        }
    }

    private void RestoreOriginalContext()
    {
        // TODO: Implementare chiamata API per ripristino contesto originale
        Snackbar.Add(TranslationService.GetTranslation("superAdmin.implementRestoreContext", "TODO: Implementare ripristino contesto SuperAdmin originale"), Severity.Info);
    }

    private async Task<IEnumerable<UserManagementDto>> SearchUsersAsync(string searchText, CancellationToken cancellationToken)
    {
        if (string.IsNullOrWhiteSpace(searchText))
            return Array.Empty<UserManagementDto>();

        try
        {
            var users = await SuperAdminService.GetUsersAsync(_selectedTenantId);
            return users.Where(u => 
                u.FullName.Contains(searchText, StringComparison.OrdinalIgnoreCase) ||
                u.Username.Contains(searchText, StringComparison.OrdinalIgnoreCase));
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error searching users");
            return Array.Empty<UserManagementDto>();
        }
    }

    private async Task StartImpersonation()
    {
        if (_selectedUser == null || string.IsNullOrWhiteSpace(_impersonationReason))
        {
            Snackbar.Add(TranslationService.GetTranslation("superAdmin.selectUserAndReason", "Seleziona un utente e specifica un motivo"), Severity.Warning);
            return;
        }

        try
        {
            var impersonateDto = new ImpersonationWithAuditDto
            {
                UserId = _selectedUser.Id,
                TargetUserId = _selectedUser.Id,
                Reason = _impersonationReason,
                TargetTenantId = _selectedUser.TenantId,
                CreateAuditEntry = true
            };

            var result = await HttpClientService.PostAsync<ImpersonationWithAuditDto, CurrentContextDto>("api/v1/tenant-switch/impersonate", impersonateDto);
            
            if (result != null)
            {
                _isImpersonating = true;
                _currentContext = result;
                Snackbar.Add(TranslationService.GetTranslation("superAdmin.impersonationStartSuccess", "Impersonazione avviata con successo"), Severity.Success);
                
                // Reset form
                _impersonationReason = string.Empty;
                _selectedUser = null;
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error starting impersonation");
            Snackbar.Add(TranslationService.GetTranslation("superAdmin.impersonationStartError", "Errore durante l'avvio dell'impersonazione: {0}", ex.Message), Severity.Error);
        }
    }

    private async Task EndImpersonation()
    {
        if (string.IsNullOrWhiteSpace(_endImpersonationReason))
        {
            Snackbar.Add(TranslationService.GetTranslation("superAdmin.specifyReason", "Specifica un motivo"), Severity.Warning);
            return;
        }

        try
        {
            var endDto = new EndImpersonationDto
            {
                Reason = _endImpersonationReason
            };

            var result = await HttpClientService.PostAsync<EndImpersonationDto, CurrentContextDto>("api/v1/tenant-switch/end-impersonation", endDto);
            
            if (result != null)
            {
                _isImpersonating = false;
                _currentContext = result;
                _endImpersonationReason = string.Empty;
                Snackbar.Add(TranslationService.GetTranslation("superAdmin.impersonationEndSuccess", "Impersonazione terminata con successo"), Severity.Success);
                
                // Ricarica tutto
                await OnInitializedAsync();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error ending impersonation");
            Snackbar.Add(TranslationService.GetTranslation("superAdmin.impersonationEndError", "Errore durante la fine dell'impersonazione: {0}", ex.Message), Severity.Error);
        }
    }

    private async Task LoadSwitchHistoryAsync()
    {
        try
        {
            var searchDto = new OperationHistorySearchDto
            {
                PageNumber = 1,
                PageSize = 50,
                SortBy = "PerformedAt",
                SortOrder = "desc"
            };

            var result = await HttpClientService.GetAsync<PagedResult<TenantSwitchHistoryDto>>(
                $"api/v1/tenant-switch/history/tenant-switches?PageNumber={searchDto.PageNumber}&PageSize={searchDto.PageSize}&SortBy={searchDto.SortBy}&SortOrder={searchDto.SortOrder}");
            
            _switchHistory = result?.Items?.ToList() ?? new List<TenantSwitchHistoryDto>();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading switch history");
            _switchHistory = new List<TenantSwitchHistoryDto>();
        }
    }

    private async Task ExportSwitchHistory()
    {
        // TODO: Implementare esportazione cronologia
        Snackbar.Add(TranslationService.GetTranslation("superAdmin.implementExportHistory", "TODO: Implementare esportazione cronologia"), Severity.Info);
        await Task.CompletedTask;
    }

    private async Task ShowLoginDialogAsync()
    {
        var result = await AuthenticationDialogService.ShowLoginDialogAsync();
        if (result)
        {
            // Reload the page after successful login
            await OnInitializedAsync();
        }
    }
}