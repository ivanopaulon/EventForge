@page "/superadmin/tenant-management"
@using Microsoft.AspNetCore.Authorization
@using EventForge.DTOs.Tenants
@using EventForge.DTOs.SuperAdmin
@using EventForge.DTOs.Common
@using EventForge.Client.Shared.Components
@using EventForge.Client.Shared.Components.Dashboard
@attribute [Authorize(Roles = "SuperAdmin")]
@inject IAuthService AuthService
@inject ISuperAdminService SuperAdminService
@inject NavigationManager NavigationManager
@inject IAuthenticationDialogService AuthenticationDialogService
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject ITranslationService TranslationService
@inject ILogger<TenantManagement> Logger

<PageTitle>@TranslationService.GetTranslation("superAdmin.pageTitle", "{0} - EventForge Super Admin", TranslationService.GetTranslation("superAdmin.tenantManagement", "Gestione Tenant"))</PageTitle>

<PageLoadingOverlay Visible="_isLoading || _isLoadingTenants"
                     Message="@(_isLoading ? TranslationService.GetTranslation("messages.loadingPage", "Caricamento pagina...") : TranslationService.GetTranslation("common.loading", "Caricamento..."))" />

@if (!_isLoading)
{
    @if (!_isAuthorized)
    {
        <MudContainer MaxWidth="MaxWidth.Medium" Class="mt-8">
            <MudPaper Class="ef-tile">
                <MudGrid Justify="Justify.Center">
                    <MudItem xs="12">
                        <div class="d-flex flex-column align-center">
                            <MudIcon Icon="Icons.Material.Filled.Block" Color="Color.Error" Size="Size.Medium" Style="font-size: 48px;" />
                            <MudText Typo="Typo.h4" Align="Align.Center" Class="mb-4">@TranslationService.GetTranslation("error.accessDenied", "Accesso Negato")</MudText>
                            <MudText Typo="Typo.body1" Align="Align.Center" Class="mb-4">
                                @TranslationService.GetTranslation("superAdmin.superAdminRoleRequired", "Non hai i permessi per accedere a questa pagina. È richiesto il ruolo Super Amministratore.")
                            </MudText>
                            <MudButton Variant="Variant.Filled" 
                                       Color="Color.Primary" 
                                       StartIcon="Icons.Material.Filled.ArrowBack"
                                       OnClick="@(() => NavigationManager.NavigateTo("/"))">
                                @TranslationService.GetTranslation("superAdmin.returnToHome", "Torna alla Home")
                            </MudButton>
                        </div>
                    </MudItem>
                </MudGrid>
            </MudPaper>
        </MudContainer>
    }
    else
    {
        <div class="tenant-page-root">
            <div class="tenant-top">
                <ManagementDashboard TItem="TenantResponseDto"
                                     Items="_filteredTenants"
                                     Metrics="_dashboardMetrics"
                                     EntityType="Tenant"
                                     AllowConfiguration="true"
                                     UseServerSide="false" />
            </div>

            <div class="eftable-wrapper">
                <EFTable @ref="_efTable"
                         TItem="TenantResponseDto"
                         Items="_filteredTenants"
                         IsLoading="_isLoadingTenants"
                         ComponentKey="TenantManagement"
                         InitialColumnConfigurations="_initialColumns"
                         AllowDragDropGrouping="true">
                    <ToolBarContent>
                        <MudText Typo="Typo.h5">
                            @TranslationService.GetTranslation("superAdmin.tenantManagement", "Gestione Tenant")
                        </MudText>
                        <MudSpacer />
                        <MudTextField @bind-Value="_searchTerm"
                                      @bind-Value:after="OnSearchChanged"
                                      Label="@TranslationService.GetTranslation("superAdmin.searchByNameOrDomain", "Cerca per nome o dominio")"
                                      Placeholder="@TranslationService.GetTranslation("superAdmin.searchPlaceholder", "Inserisci testo da cercare...")"
                                      Variant="Variant.Outlined"
                                      Adornment="Adornment.End"
                                      AdornmentIcon="@Icons.Material.Outlined.Search"
                                      Clearable="true"
                                      Class="ef-input" />
                        <MudSwitch @bind-Value="_showActiveOnly"
                                   @bind-Value:after="OnStatusFilterChanged"
                                   Label="@TranslationService.GetTranslation("field.onlyActive", "Solo Attivi")"
                                   Color="Color.Success"
                                   Class="ml-2" />
                        <ManagementTableToolbar ShowRefresh="true"
                                                ShowCreate="true"
                                                ShowDelete="false"
                                                CreateTooltip="superAdmin.createNewTenant"
                                                IsDisabled="_isLoadingTenants"
                                                OnRefresh="@LoadTenantsAsync"
                                                OnCreate="@CreateTenant" />
                    </ToolBarContent>
                    <HeaderContent Context="columnConfigurations">
                        @foreach (var column in columnConfigurations.Where(c => c.IsVisible).OrderBy(c => c.Order))
                        {
                            @if (column.PropertyName == "DisplayName")
                            {
                                <EFTableColumnHeader TItem="TenantResponseDto" PropertyName="DisplayName" OnDragStartCallback="@_efTable.HandleColumnDragStart">
                                    <MudTableSortLabel SortBy="@(new Func<TenantResponseDto, object>(x => x.DisplayName))">@TranslationService.GetTranslation("field.displayName", "Nome")</MudTableSortLabel>
                                </EFTableColumnHeader>
                            }
                            else if (column.PropertyName == "Name")
                            {
                                <EFTableColumnHeader TItem="TenantResponseDto" PropertyName="Name" OnDragStartCallback="@_efTable.HandleColumnDragStart">
                                    <MudTableSortLabel SortBy="@(new Func<TenantResponseDto, object>(x => x.Name))">@TranslationService.GetTranslation("field.name", "Nome Sistema")</MudTableSortLabel>
                                </EFTableColumnHeader>
                            }
                            else if (column.PropertyName == "Description")
                            {
                                <EFTableColumnHeader TItem="TenantResponseDto" PropertyName="Description" OnDragStartCallback="@_efTable.HandleColumnDragStart">
                                    <MudTableSortLabel SortBy="@(new Func<TenantResponseDto, object>(x => x.Description ?? string.Empty))">@TranslationService.GetTranslation("field.description", "Descrizione")</MudTableSortLabel>
                                </EFTableColumnHeader>
                            }
                            else if (column.PropertyName == "IsActive")
                            {
                                <EFTableColumnHeader TItem="TenantResponseDto" PropertyName="IsActive" OnDragStartCallback="@_efTable.HandleColumnDragStart">
                                    <MudTableSortLabel SortBy="@(new Func<TenantResponseDto, object>(x => x.IsActive))">@TranslationService.GetTranslation("field.status", "Stato")</MudTableSortLabel>
                                </EFTableColumnHeader>
                            }
                            else if (column.PropertyName == "CreatedAt")
                            {
                                <EFTableColumnHeader TItem="TenantResponseDto" PropertyName="CreatedAt" OnDragStartCallback="@_efTable.HandleColumnDragStart">
                                    <MudTableSortLabel InitialDirection="SortDirection.Descending" SortBy="@(new Func<TenantResponseDto, object>(x => x.CreatedAt))">@TranslationService.GetTranslation("field.createdAt", "Creato il")</MudTableSortLabel>
                                </EFTableColumnHeader>
                            }
                        }
                        <MudTh Class="text-center" Style="min-width:120px;">@TranslationService.GetTranslation("common.actions", "Azioni")</MudTh>
                    </HeaderContent>

                    <RowTemplate Context="item">
                        @{
                            var visibleColumns = _efTable?.ColumnConfigurations?.Where(c => c.IsVisible).OrderBy(c => c.Order).ToList() ?? _initialColumns.Where(c => c.IsVisible).OrderBy(c => c.Order).ToList();
                        }
                        @foreach (var column in visibleColumns)
                        {
                            @if (column.PropertyName == "DisplayName")
                            {
                                <MudTd DataLabel="@TranslationService.GetTranslation("field.displayName", "Nome")">
                                    <div class="d-flex align-center">
                                        <MudAvatar Color="Color.Primary" Size="Size.Small" Class="mr-2">
                                            @(item.DisplayName.FirstOrDefault())
                                        </MudAvatar>
                                        <div>
                                            <MudText Typo="Typo.body2">@item.DisplayName</MudText>
                                            <MudText Typo="Typo.caption" Class="mud-text-secondary">ID: @(item.Id.ToString()[..Math.Min(8, item.Id.ToString().Length)])...</MudText>
                                        </div>
                                    </div>
                                </MudTd>
                            }
                            else if (column.PropertyName == "Name")
                            {
                                <MudTd DataLabel="@TranslationService.GetTranslation("field.name", "Nome Sistema")">
                                    <MudChip T="string" Size="Size.Small" Color="Color.Default">@item.Name</MudChip>
                                </MudTd>
                            }
                            else if (column.PropertyName == "Description")
                            {
                                <MudTd DataLabel="@TranslationService.GetTranslation("field.description", "Descrizione")">
                                    <MudText Typo="Typo.body2">@(item.Description ?? TranslationService.GetTranslation("common.notAvailable", "N/A"))</MudText>
                                </MudTd>
                            }
                            else if (column.PropertyName == "IsActive")
                            {
                                <MudTd DataLabel="@TranslationService.GetTranslation("field.status", "Stato")">
                                    <MudChip T="string" Color="@(item.IsActive ? Color.Success : Color.Error)" 
                                             Size="Size.Small"
                                             Icon="@(item.IsActive ? Icons.Material.Outlined.CheckCircle : Icons.Material.Outlined.Cancel)">
                                        @(item.IsActive ? TranslationService.GetTranslation("field.active", "Attivo") : TranslationService.GetTranslation("field.inactive", "Inattivo"))
                                    </MudChip>
                                </MudTd>
                            }
                            else if (column.PropertyName == "CreatedAt")
                            {
                                <MudTd DataLabel="@TranslationService.GetTranslation("field.createdAt", "Creato il")">
                                    <MudText Typo="Typo.body2">@item.CreatedAt.ToString("dd/MM/yyyy HH:mm")</MudText>
                                </MudTd>
                            }
                        }
                        <MudTd DataLabel="@TranslationService.GetTranslation("common.actions", "Azioni")" Class="text-center">
                            <ActionButtonGroup EntityName="@item.DisplayName"
                                              ItemDisplayName="@item.DisplayName"
                                              ShowView="false"
                                              ShowEdit="true"
                                              ShowAuditLog="true"
                                              ShowToggleStatus="true"
                                              ShowDelete="true"
                                              IsActive="@item.IsActive"
                                              OnEdit="@(() => EditTenant(item.Id))"
                                              OnAuditLog="@(() => ViewTenantAuditLog(item))"
                                              OnToggleStatus="@(() => ToggleTenantStatus(item))"
                                              OnDelete="@(() => DeleteTenant(item))" />
                        </MudTd>
                    </RowTemplate>

                    <NoRecordsContent>
                        <div class="text-center pa-2 pa-sm-3 pa-md-4">
                            <MudIcon Icon="@Icons.Material.Outlined.Business" Size="Size.Medium" Class="mb-4 mud-text-secondary" />
                            <MudText Typo="Typo.h6" Class="mb-2">
                                @(_tenants.Any() ? 
                                    TranslationService.GetTranslation("superAdmin.noTenantsMatchFilters", "Nessun tenant corrisponde ai filtri applicati") : 
                                    TranslationService.GetTranslation("superAdmin.noTenantsFound", "Nessun tenant trovato"))
                            </MudText>
                            @if (_tenants.Any())
                            {
                                <MudButton Variant="Variant.Text" 
                                           Color="Color.Primary" 
                                           StartIcon="@Icons.Material.Outlined.Clear"
                                           OnClick="@ClearFilters">
                                    @TranslationService.GetTranslation("superAdmin.clearFilters", "Cancella filtri")
                                </MudButton>
                            }
                        </div>
                    </NoRecordsContent>
                </EFTable>
            </div>
        </div>
    }
}

@code {
    // Dialog options for fullscreen audit dialog
    private readonly DialogOptions _auditDialogOptions = new() 
    { 
        FullScreen = true, 
        CloseButton = true,
        MaxWidth = MaxWidth.False
    };
    
    // UI State Management
    private bool _isLoading = true;
    private bool _isAuthorized = false;
    private bool _isLoadingTenants = false;
    
    private UserDto? _currentUser;
    
    // Filter and search state
    private string _searchTerm = string.Empty;
    private bool _showActiveOnly = false;
    private CancellationTokenSource? _searchDebounceCts;
    
    // Data collections
    private List<TenantResponseDto> _tenants = new();
    
    // EFTable reference
    private EFTable<TenantResponseDto> _efTable = null!;
    
    // Column configuration for EFTable
    private List<EFTableColumnConfiguration> _initialColumns = new()
    {
        new() { PropertyName = "DisplayName", DisplayName = "Nome", IsVisible = true, Order = 0 },
        new() { PropertyName = "Name", DisplayName = "Nome Sistema", IsVisible = true, Order = 1 },
        new() { PropertyName = "Description", DisplayName = "Descrizione", IsVisible = true, Order = 2 },
        new() { PropertyName = "IsActive", DisplayName = "Stato", IsVisible = true, Order = 3 },
        new() { PropertyName = "CreatedAt", DisplayName = "Creato il", IsVisible = true, Order = 4 }
    };
    
    // Dashboard configuration
    private List<DashboardMetric<TenantResponseDto>> _dashboardMetrics = new()
    {
        new()
        {
            Title = "Totale Tenant",
            Type = MetricType.Count,
            Icon = Icons.Material.Outlined.Business,
            Color = "primary",
            Description = "Numero totale di tenant",
            Format = "N0"
        },
        new()
        {
            Title = "Tenant Attivi",
            Type = MetricType.Count,
            Filter = t => t.IsActive,
            Icon = Icons.Material.Outlined.CheckCircle,
            Color = "success",
            Description = "Tenant attivi",
            Format = "N0"
        },
        new()
        {
            Title = "Creati Questo Mese",
            Type = MetricType.Count,
            Filter = t => t.CreatedAt >= DateTime.Now.AddDays(-30),
            Icon = Icons.Material.Outlined.CalendarToday,
            Color = "warning",
            Description = "Tenant creati negli ultimi 30 giorni",
            Format = "N0"
        },
        new()
        {
            Title = "In Scadenza",
            Type = MetricType.Count,
            Filter = t => t.SubscriptionExpiresAt.HasValue && t.SubscriptionExpiresAt.Value <= DateTime.Now.AddDays(30),
            Icon = Icons.Material.Outlined.Warning,
            Color = "info",
            Description = "Tenant con sottoscrizione in scadenza nei prossimi 30 giorni",
            Format = "N0"
        }
    };

    /// <summary>
    /// Computed property for filtered tenants based on search criteria.
    /// Applies multiple filters: search term and status.
    /// </summary>
    private IEnumerable<TenantResponseDto> _filteredTenants => 
        _tenants.Where(t => 
            // Search filter: check displayName and name
            (string.IsNullOrEmpty(_searchTerm) || 
             t.DisplayName.Contains(_searchTerm, StringComparison.OrdinalIgnoreCase) ||
             t.Name.Contains(_searchTerm, StringComparison.OrdinalIgnoreCase) ||
             (!string.IsNullOrEmpty(t.Domain) && t.Domain.Contains(_searchTerm, StringComparison.OrdinalIgnoreCase))) &&
            // Status filter
            (!_showActiveOnly || t.IsActive));

    /// <summary>
    /// Component initialization with enhanced security checks and responsive UI setup.
    /// </summary>
    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Enhanced authentication and authorization flow
            var isAuthenticated = await AuthService.IsAuthenticatedAsync();
            if (!isAuthenticated)
            {
                await ShowLoginDialogAsync();
                return;
            }

            // SuperAdmin role verification with proper error handling
            var isSuperAdmin = await AuthService.IsSuperAdminAsync();
            if (!isSuperAdmin)
            {
                _isAuthorized = false;
                _isLoading = false;
                Snackbar.Add(TranslationService.GetTranslation("superAdmin.accessDeniedSuperAdmin", "Accesso negato. È richiesto il ruolo Super Amministratore."), Severity.Warning);
                return;
            }

            // Load current user info for audit purposes
            _currentUser = await AuthService.GetCurrentUserAsync();
            _isAuthorized = true;
            
            // Load tenant data
            await LoadTenantsAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add(TranslationService.GetTranslation("superAdmin.loadingPageError", "Errore nel caricamento della pagina: {0}", ex.Message), Severity.Error);
            NavigationManager.NavigateTo("/");
        }
        finally
        {
            _isLoading = false;
        }
    }

    /// <summary>
    /// Loads tenant data with proper error handling and loading state management.
    /// </summary>
    private async Task LoadTenantsAsync()
    {
        try
        {
            _isLoadingTenants = true;
            _tenants = (await SuperAdminService.GetTenantsAsync()).ToList();
        }
        catch (Exception ex)
        {
            Snackbar.Add(TranslationService.GetTranslation("superAdmin.loadingTenantsError", "Errore nel caricamento dei tenant: {0}", ex.Message), Severity.Error);
        }
        finally
        {
            _isLoadingTenants = false;
        }
    }



    /// <summary>
    /// Clears all active filters and resets search form to initial state.
    /// </summary>
    private async Task ClearFilters()
    {
        _searchTerm = string.Empty;
        _showActiveOnly = false;
        await Task.CompletedTask;
        StateHasChanged();
    }

    private async Task OnSearchChanged()
    {
        // Cancel previous debounce if any
        _searchDebounceCts?.Cancel();
        _searchDebounceCts = new CancellationTokenSource();
        var token = _searchDebounceCts.Token;
        
        try
        {
            await Task.Delay(300, token); // Debounce with cancellation
            if (!token.IsCancellationRequested)
            {
                StateHasChanged();
            }
        }
        catch (OperationCanceledException)
        {
            // Swallow cancellation
        }
    }

    private void OnStatusFilterChanged()
    {
        StateHasChanged();
    }



    private void CreateTenant()
    {
        NavigationManager.NavigateTo("/superadmin/tenants/new");
    }

    private void EditTenant(Guid id)
    {
        NavigationManager.NavigateTo($"/superadmin/tenants/{id}");
    }

    private async Task ViewTenantAuditLog(TenantResponseDto tenant)
    {
        var parameters = new DialogParameters<AuditHistoryDialog>
        {
            { x => x.EntityType, "Tenant" },
            { x => x.EntityId, tenant.Id },
            { x => x.EntityName, tenant.DisplayName }
        };

        await DialogService.ShowAsync<AuditHistoryDialog>(
            TranslationService.GetTranslation("audit.historyDialog.title", "Cronologia Modifiche"),
            parameters,
            _auditDialogOptions);
    }

    /// <summary>
    /// Toggles tenant active status with enhanced confirmation dialog and error handling.
    /// Implements proper audit trail logging and user feedback.
    /// </summary>
    private async Task ToggleTenantStatus(TenantResponseDto tenant)
    {
        var actionText = tenant.IsActive ? 
            TranslationService.GetTranslation("superAdmin.disable", "disabilitare") : 
            TranslationService.GetTranslation("superAdmin.enable", "abilitare");
            
        var confirmTitle = TranslationService.GetTranslation("common.confirm", "Conferma");
        var confirmMessage = TranslationService.GetTranslation("superAdmin.confirmTenantStatusChange", 
            "Sei sicuro di voler {0} il tenant '{1}'? Questa azione verrà registrata nei log di audit e potrebbe influenzare tutti gli utenti del tenant.", 
            actionText, tenant.DisplayName);

        var confirm = await DialogService.ShowMessageBox(
            confirmTitle,
            confirmMessage,
            yesText: TranslationService.GetTranslation("common.confirm", "Conferma"),
            cancelText: TranslationService.GetTranslation("common.cancel", "Annulla"));

        if (confirm == true)
        {
            try
            {
                var reason = tenant.IsActive 
                    ? $"Tenant disabled by superadmin on {DateTime.UtcNow:yyyy-MM-dd HH:mm:ss} UTC"
                    : $"Tenant enabled by superadmin on {DateTime.UtcNow:yyyy-MM-dd HH:mm:ss} UTC";

                if (tenant.IsActive)
                {
                    await SuperAdminService.DisableTenantAsync(tenant.Id, reason);
                }
                else
                {
                    await SuperAdminService.EnableTenantAsync(tenant.Id, reason);
                }

                // Update the local state
                tenant.IsActive = !tenant.IsActive;
                
                var successMessage = tenant.IsActive 
                    ? TranslationService.GetTranslation("superAdmin.tenantEnabled", "Tenant abilitato con successo!")
                    : TranslationService.GetTranslation("superAdmin.tenantDisabled", "Tenant disabilitato con successo!");
                    
                Snackbar.Add(successMessage, Severity.Success);
                StateHasChanged();
            }
            catch (Exception ex)
            {
                // Revert the change if API call failed
                var errorMessage = TranslationService.GetTranslation("superAdmin.toggleTenantStatusError", 
                    "Errore nel cambio stato del tenant: {0}", ex.Message);
                Snackbar.Add(errorMessage, Severity.Error);
                Logger.LogError(ex, "Failed to toggle tenant status for tenant {TenantId}", tenant.Id);
            }
        }
    }

    private async Task DeleteTenant(TenantResponseDto tenant)
    {
        var confirmTitle = TranslationService.GetTranslation("common.confirm", "Conferma");
        var confirmMessage = TranslationService.GetTranslation("superAdmin.confirmTenantDelete", 
            "Sei sicuro di voler eliminare il tenant '{0}'? Questa azione non può essere annullata e eliminerà tutti i dati associati.", 
            tenant.DisplayName);

        var confirm = await DialogService.ShowMessageBox(
            confirmTitle,
            confirmMessage,
            yesText: TranslationService.GetTranslation("common.delete", "Elimina"),
            cancelText: TranslationService.GetTranslation("common.cancel", "Annulla"));

        if (confirm == true)
        {
            try
            {
                // Chiamata API per soft delete
                await SuperAdminService.DeleteTenantAsync(tenant.Id, "Soft deleted by superadmin");

                _tenants.Remove(tenant);

                Snackbar.Add(TranslationService.GetTranslation("superAdmin.tenantDeleted", "Tenant eliminato con successo!"), Severity.Success);
                StateHasChanged();
            }
            catch (Exception ex)
            {
                Snackbar.Add(TranslationService.GetTranslation("superAdmin.deleteTenantError", 
                    "Errore nell'eliminazione del tenant: {0}", ex.Message), Severity.Error);
            }
        }
    }

    private async Task ShowLoginDialogAsync()
    {
        var result = await AuthenticationDialogService.ShowLoginDialogAsync();
        if (result)
        {
            // Reload the page after successful login
            await OnInitializedAsync();
        }
    }
}