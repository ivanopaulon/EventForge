@page "/superadmin/tenant-settings"
@using Microsoft.AspNetCore.Authorization
@using EventForge.Client.Shared.Components
@using EventForge.DTOs.SuperAdmin
@attribute [Authorize(Roles = "SuperAdmin")]
@inject IAuthService AuthService
@inject ISuperAdminService SuperAdminService
@inject NavigationManager NavigationManager
@inject IAuthenticationDialogService AuthenticationDialogService
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject ITranslationService TranslationService
@inject ILogger<TenantSettings> Logger

<SuperAdminPageLayout PageTitle="@TranslationService.GetTranslation("superAdmin.tenantSettings", "Impostazioni Tenant")"
                      PageIcon="@Icons.Material.Outlined.Settings"
                      IsLoading="_isLoading"
                      IsAuthorized="_isAuthorized"
                      OnNavigateHome="@(() => NavigationManager.NavigateTo("/"))">

    <!-- Dashboard Metrics -->
    <div class="dashboard-metrics mb-4">
        <div class="metric-card primary">
            <div class="metric-label">@TranslationService.GetTranslation("superAdmin.totalSettings", "Impostazioni Totali")</div>
            <div class="metric-value">@_totalSettings</div>
        </div>
        <div class="metric-card success">
            <div class="metric-label">@TranslationService.GetTranslation("superAdmin.modifiedToday", "Modificate Oggi")</div>
            <div class="metric-value">@_modifiedToday</div>
        </div>
        <div class="metric-card warning">
            <div class="metric-label">@TranslationService.GetTranslation("superAdmin.defaultSettings", "Predefinite")</div>
            <div class="metric-value">@_defaultSettings</div>
        </div>
        <div class="metric-card info">
            <div class="metric-label">@TranslationService.GetTranslation("superAdmin.customSettings", "Personalizzate")</div>
            <div class="metric-value">@_customSettings</div>
        </div>
    </div>

    <!-- Filters Section -->
    <SuperAdminCollapsibleSection SectionTitle="@TranslationService.GetTranslation("superAdmin.advancedFilters", "Filtri Avanzati")"
                                  SectionIcon="@Icons.Material.Outlined.FilterList"
                                  @bind-IsExpanded="_filtersExpanded">
        <div class="d-flex gap-4 align-center flex-wrap">
            <MudTextField @bind-Value="_searchTerm"
                          @bind-Value:after="OnSearchChanged"
                          Label="@TranslationService.GetTranslation("superAdmin.searchSettings", "Cerca impostazioni")"
                          Placeholder="@TranslationService.GetTranslation("superAdmin.searchPlaceholder", "Inserisci testo da cercare...")"
                          Variant="Variant.Outlined"
                          Adornment="Adornment.End"
                          AdornmentIcon="@Icons.Material.Outlined.Search"
                          Clearable="true"
                          Style="flex: 2;" />
            <MudSelect T="string" @bind-Value="_categoryFilter" @bind-Value:after="OnCategoryFilterChanged" 
                       Label="@TranslationService.GetTranslation("field.category", "Categoria")" 
                       Placeholder="@TranslationService.GetTranslation("superAdmin.selectCategory", "Seleziona categoria...")"
                       Variant="Variant.Outlined"
                       Clearable="true"
                       Style="flex: 1;">
                <MudSelectItem Value="@("all")">@TranslationService.GetTranslation("common.all", "Tutte")</MudSelectItem>
                <MudSelectItem Value="@("general")">@TranslationService.GetTranslation("superAdmin.general", "Generale")</MudSelectItem>
                <MudSelectItem Value="@("security")">@TranslationService.GetTranslation("superAdmin.security", "Sicurezza")</MudSelectItem>
                <MudSelectItem Value="@("email")">@TranslationService.GetTranslation("superAdmin.email", "Email")</MudSelectItem>
                <MudSelectItem Value="@("appearance")">@TranslationService.GetTranslation("superAdmin.appearance", "Aspetto")</MudSelectItem>
            </MudSelect>
        </div>
    </SuperAdminCollapsibleSection>

    <!-- Settings Data Table -->
    <MudPaper Elevation="2" Class="border-rounded mb-1">
        <MudCardHeader Class="pa-2">
            <CardHeaderContent>
                <MudText Typo="Typo.h6">
                    <MudIcon Icon="@Icons.Material.Outlined.Settings" Class="mr-2" />
                    @TranslationService.GetTranslation("superAdmin.settingsList", "Lista Impostazioni")
                    <MudText Typo="Typo.body2" Class="mud-text-secondary ml-2">
                        (@_filteredSettings.Count() @TranslationService.GetTranslation("superAdmin.itemsFound", "elementi trovati"))
                    </MudText>
                </MudText>
            </CardHeaderContent>
            <CardHeaderActions>
                <ActionButtonGroup Mode="ActionButtonGroupMode.Toolbar"
                                   ShowRefresh="true"
                                   ShowExport="true" 
                                   ShowCreate="false"
                                   ShowAuditLog="false"
                                   IsDisabled="_isLoadingSettings"
                                   OnRefresh="@LoadSettingsAsync"
                                   OnExport="@ExportSettings" />
            </CardHeaderActions>
        </MudCardHeader>
        <MudCardContent Class="pa-1">
            @if (_isLoadingSettings)
            {
                <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="mt-4" />
            }
            else
            {
                <MudTable T="TenantSettingDto" 
                          Items="_filteredSettings" 
                          Hover="true" 
                          Striped="true"
                          Loading="_isLoadingSettings"
                          LoadingProgressColor="Color.Info"
                          SortLabel="@TranslationService.GetTranslation("tooltip.sortColumn", "Ordina colonna")"
                          AllowUnsorted="false"
                          Dense="true"
                          Breakpoint="Breakpoint.Sm">
                    <HeaderContent>
                        <MudTh><MudTableSortLabel SortBy="@(new Func<TenantSettingDto, object>(x => x.SettingKey))">@TranslationService.GetTranslation("field.settingKey", "Chiave")</MudTableSortLabel></MudTh>
                        <MudTh><MudTableSortLabel SortBy="@(new Func<TenantSettingDto, object>(x => x.SettingValue ?? string.Empty))">@TranslationService.GetTranslation("field.settingValue", "Valore")</MudTableSortLabel></MudTh>
                        <MudTh><MudTableSortLabel SortBy="@(new Func<TenantSettingDto, object>(x => x.Category ?? string.Empty))">@TranslationService.GetTranslation("field.category", "Categoria")</MudTableSortLabel></MudTh>
                        <MudTh><MudTableSortLabel SortBy="@(new Func<TenantSettingDto, object>(x => x.IsDefault))">@TranslationService.GetTranslation("field.isDefault", "Predefinita")</MudTableSortLabel></MudTh>
                        <MudTh><MudTableSortLabel InitialDirection="SortDirection.Descending" SortBy="@(new Func<TenantSettingDto, object>(x => x.LastModified))">@TranslationService.GetTranslation("field.lastModified", "Ultima Modifica")</MudTableSortLabel></MudTh>
                        <MudTh Class="text-center" Style="min-width: 120px;">@TranslationService.GetTranslation("common.actions", "Azioni")</MudTh>
                    </HeaderContent>

                    <RowTemplate>
                        <MudTd DataLabel="@TranslationService.GetTranslation("field.settingKey", "Chiave")">
                            <MudText Typo="Typo.body2" Style="font-weight: 600;">@context.SettingKey</MudText>
                        </MudTd>
                        <MudTd DataLabel="@TranslationService.GetTranslation("field.settingValue", "Valore")">
                            <MudText Typo="Typo.body2">@(context.SettingValue ?? TranslationService.GetTranslation("common.notSet", "Non impostato"))</MudText>
                        </MudTd>
                        <MudTd DataLabel="@TranslationService.GetTranslation("field.category", "Categoria")">
                            <MudChip T="string" Size="Size.Small" Color="@GetCategoryColor(context.Category)">
                                @(context.Category ?? TranslationService.GetTranslation("common.notAvailable", "N/A"))
                            </MudChip>
                        </MudTd>
                        <MudTd DataLabel="@TranslationService.GetTranslation("field.isDefault", "Predefinita")">
                            <MudChip T="string" Color="@(context.IsDefault ? Color.Default : Color.Info)" 
                                     Size="Size.Small"
                                     Icon="@(context.IsDefault ? Icons.Material.Outlined.CheckCircle : Icons.Material.Outlined.Edit)">
                                @(context.IsDefault ? TranslationService.GetTranslation("field.default", "Predefinita") : TranslationService.GetTranslation("field.custom", "Personalizzata"))
                            </MudChip>
                        </MudTd>
                        <MudTd DataLabel="@TranslationService.GetTranslation("field.lastModified", "Ultima Modifica")">
                            <MudText Typo="Typo.body2">@context.LastModified.ToString("dd/MM/yyyy HH:mm")</MudText>
                        </MudTd>
                        <MudTd DataLabel="@TranslationService.GetTranslation("common.actions", "Azioni")" Class="text-center">
                            <ActionButtonGroup EntityName="@context.SettingKey"
                                              ItemDisplayName="@context.SettingKey"
                                              ShowView="false"
                                              ShowEdit="true"
                                              ShowAuditLog="false"
                                              ShowToggleStatus="false"
                                              ShowDelete="false"
                                              OnEdit="@(() => EditSetting(context))">
                                <AdditionalActions>
                                    @if (!context.IsDefault)
                                    {
                                        <MudTooltip Text="@TranslationService.GetTranslation("tooltip.resetToDefault", "Ripristina predefinita")">
                                            <MudIconButton Icon="@Icons.Material.Outlined.RestartAlt" 
                                                          Color="Color.Warning"
                                                          Size="Size.Small"
                                                          Class="rounded"
                                                          OnClick="@(() => ResetToDefault(context))"
                                                          aria-label="@TranslationService.GetTranslation("tooltip.resetToDefault", "Ripristina valore predefinito per {0}", context.SettingKey)" />
                                        </MudTooltip>
                                    }
                                </AdditionalActions>
                            </ActionButtonGroup>
                        </MudTd>
                    </RowTemplate>

                    <NoRecordsContent>
                        <div class="text-center pa-2 pa-sm-3 pa-md-4">
                            <MudIcon Icon="@Icons.Material.Outlined.Settings" Size="Size.Medium" Class="mb-4 mud-text-secondary" />
                            <MudText Typo="Typo.h6" Class="mb-2">
                                @(_settings.Any() ? 
                                    TranslationService.GetTranslation("superAdmin.noSettingsMatchFilters", "Nessuna impostazione corrisponde ai filtri applicati") : 
                                    TranslationService.GetTranslation("superAdmin.noSettingsFound", "Nessuna impostazione trovata"))
                            </MudText>
                            @if (_settings.Any())
                            {
                                <MudButton Variant="Variant.Text" 
                                          Color="Color.Primary" 
                                          StartIcon="@Icons.Material.Outlined.Clear"
                                          OnClick="@ClearFilters">
                                    @TranslationService.GetTranslation("superAdmin.clearFilters", "Cancella filtri")
                                </MudButton>
                            }
                        </div>
                    </NoRecordsContent>
                </MudTable>
            }
        </MudCardContent>
    </MudPaper>

</SuperAdminPageLayout>

@code {
    // UI State Management
    private bool _isLoading = true;
    private bool _isAuthorized = false;
    private bool _isLoadingSettings = false;
    
    // MudCollapse state management (closed by default)
    private bool _filtersExpanded = false;
    
    private UserDto? _currentUser;
    
    // Filter and search state
    private string _searchTerm = string.Empty;
    private string _categoryFilter = "all";
    
    // Data collections
    private List<TenantSettingDto> _settings = new();
    
    // Dashboard metrics
    private int _totalSettings => _settings.Count;
    private int _modifiedToday => _settings.Count(s => s.LastModified.Date == DateTime.UtcNow.Date);
    private int _defaultSettings => _settings.Count(s => s.IsDefault);
    private int _customSettings => _settings.Count(s => !s.IsDefault);

    /// <summary>
    /// Computed property for filtered settings based on search criteria.
    /// </summary>
    private IEnumerable<TenantSettingDto> _filteredSettings => 
        _settings.Where(s => 
            // Search filter: check key and value
            (string.IsNullOrEmpty(_searchTerm) || 
             s.SettingKey.Contains(_searchTerm, StringComparison.OrdinalIgnoreCase) ||
             (s.SettingValue != null && s.SettingValue.Contains(_searchTerm, StringComparison.OrdinalIgnoreCase))) &&
            // Category filter
            (_categoryFilter == "all" || 
             (s.Category != null && s.Category.Equals(_categoryFilter, StringComparison.OrdinalIgnoreCase))));

    /// <summary>
    /// Component initialization with enhanced security checks.
    /// </summary>
    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Enhanced authentication and authorization flow
            var isAuthenticated = await AuthService.IsAuthenticatedAsync();
            if (!isAuthenticated)
            {
                await ShowLoginDialogAsync();
                return;
            }

            // SuperAdmin role verification
            var isSuperAdmin = await AuthService.IsSuperAdminAsync();
            if (!isSuperAdmin)
            {
                _isAuthorized = false;
                _isLoading = false;
                Snackbar.Add(TranslationService.GetTranslation("superAdmin.accessDeniedSuperAdmin", "Accesso negato. È richiesto il ruolo Super Amministratore."), Severity.Warning);
                return;
            }

            // Load current user info
            _currentUser = await AuthService.GetCurrentUserAsync();
            _isAuthorized = true;
            
            // Load settings data
            await LoadSettingsAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error initializing tenant settings page");
            Snackbar.Add(TranslationService.GetTranslation("superAdmin.loadingPageError", "Errore nel caricamento della pagina: {0}", ex.Message), Severity.Error);
            NavigationManager.NavigateTo("/");
        }
        finally
        {
            _isLoading = false;
        }
    }

    /// <summary>
    /// Loads tenant settings data with proper error handling.
    /// TODO: Implement actual API call when backend is ready.
    /// </summary>
    private async Task LoadSettingsAsync()
    {
        try
        {
            _isLoadingSettings = true;
            
            // TODO: Replace with actual API call when available
            // _settings = (await SuperAdminService.GetTenantSettingsAsync()).ToList();
            
            // Placeholder data for demo purposes
            _settings = new List<TenantSettingDto>
            {
                new TenantSettingDto { Id = Guid.NewGuid(), SettingKey = "MaxUsers", SettingValue = "100", Category = "general", IsDefault = false, LastModified = DateTime.UtcNow.AddDays(-5) },
                new TenantSettingDto { Id = Guid.NewGuid(), SettingKey = "SessionTimeout", SettingValue = "30", Category = "security", IsDefault = true, LastModified = DateTime.UtcNow.AddDays(-10) },
                new TenantSettingDto { Id = Guid.NewGuid(), SettingKey = "SmtpHost", SettingValue = "smtp.example.com", Category = "email", IsDefault = false, LastModified = DateTime.UtcNow },
                new TenantSettingDto { Id = Guid.NewGuid(), SettingKey = "ThemeColor", SettingValue = "#1976d2", Category = "appearance", IsDefault = true, LastModified = DateTime.UtcNow.AddDays(-2) },
            };
            
            await Task.Delay(500); // Simulate API call
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading tenant settings");
            Snackbar.Add(TranslationService.GetTranslation("superAdmin.loadingSettingsError", "Errore nel caricamento delle impostazioni: {0}", ex.Message), Severity.Error);
        }
        finally
        {
            _isLoadingSettings = false;
            StateHasChanged();
        }
    }

    /// <summary>
    /// Clears all active filters.
    /// </summary>
    private async Task ClearFilters()
    {
        _searchTerm = string.Empty;
        _categoryFilter = "all";
        await Task.CompletedTask;
        StateHasChanged();
    }

    private async Task OnSearchChanged()
    {
        await Task.Delay(300); // Debounce
        StateHasChanged();
    }

    private async Task OnCategoryFilterChanged()
    {
        await Task.CompletedTask;
        StateHasChanged();
    }

    private async Task ExportSettings()
    {
        // TODO: Implement export functionality
        Snackbar.Add(TranslationService.GetTranslation("superAdmin.exportFunctionalityComingSoon", "La funzionalità di esportazione sarà implementata presto."), Severity.Info);
        await Task.CompletedTask;
    }

    private async Task EditSetting(TenantSettingDto setting)
    {
        // TODO: Implement edit dialog
        Snackbar.Add(TranslationService.GetTranslation("superAdmin.editSettingComingSoon", "La funzionalità di modifica impostazioni sarà implementata presto."), Severity.Info);
        await Task.CompletedTask;
    }

    private async Task ResetToDefault(TenantSettingDto setting)
    {
        var confirm = await DialogService.ShowMessageBox(
            TranslationService.GetTranslation("common.confirm", "Conferma"),
            TranslationService.GetTranslation("superAdmin.confirmResetSetting", 
                "Sei sicuro di voler ripristinare l'impostazione '{0}' al valore predefinito?", setting.SettingKey),
            yesText: TranslationService.GetTranslation("common.confirm", "Conferma"),
            cancelText: TranslationService.GetTranslation("common.cancel", "Annulla"));

        if (confirm == true)
        {
            try
            {
                // TODO: Implement reset to default API call
                Snackbar.Add(TranslationService.GetTranslation("superAdmin.settingResetSuccess", "Impostazione ripristinata con successo!"), Severity.Success);
                await LoadSettingsAsync();
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Error resetting setting to default");
                Snackbar.Add(TranslationService.GetTranslation("superAdmin.settingResetError", 
                    "Errore nel ripristino dell'impostazione: {0}", ex.Message), Severity.Error);
            }
        }
    }

    private Color GetCategoryColor(string? category)
    {
        return category?.ToLower() switch
        {
            "general" => Color.Primary,
            "security" => Color.Error,
            "email" => Color.Info,
            "appearance" => Color.Success,
            _ => Color.Default
        };
    }

    private async Task ShowLoginDialogAsync()
    {
        var result = await AuthenticationDialogService.ShowLoginDialogAsync();
        if (result)
        {
            // Reload the page after successful login
            await OnInitializedAsync();
        }
    }
}
