@page "/sales/pos"
@using EventForge.Client.Services.Sales
@using EventForge.Client.Services.Store
@using EventForge.DTOs.Sales
@using EventForge.DTOs.Products
@using EventForge.DTOs.Store
@using EventForge.DTOs.Business
@using EventForge.DTOs.Common
@using EventForge.DTOs.Constants
@using EventForge.Client.Shared.Components.Sales
@using EventForge.Client.Shared.Components.Dialogs.Sales
@using EventForge.Client.Shared.Components.Dialogs
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@implements IDisposable
@attribute [Authorize]
@inject ISalesService SalesService
@inject IStoreUserService StoreUserService
@inject IStorePosService StorePosService
@inject IProductService ProductService
@inject IBusinessPartyService BusinessPartyService
@inject IPaymentMethodService PaymentMethodService
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject ITranslationService TranslationService
@inject ILogger<POS> Logger
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IJSRuntime JSRuntime

<PageTitle>@TranslationService.GetTranslation("sales.pos", "Punto Vendita")</PageTitle>
<PageLoadingOverlay Visible="_isLoading" 
                    Message="@TranslationService.GetTranslation("common.loading", "Caricamento...")" />

<MudContainer MaxWidth="MaxWidth.False" Class="mt-4">
    <!-- Page Title -->
    <MudText Typo="Typo.h4" Class="mb-4">
        <MudIcon Icon="@Icons.Material.Filled.PointOfSale" Class="mr-2" Size="Size.Medium" />
        @TranslationService.GetTranslation("sales.pos", "Punto Vendita")
    </MudText>

    <!-- POS Header -->
    <POSHeader OperatorName="@_operatorName"
               AvailablePos="@_availablePos"
               @bind-SelectedPosId="@_selectedPosId"
               @bind-SelectedCustomer="@_selectedCustomer"
               SessionNumber="@_currentSession?.Id"
               IsSessionActive="@(_currentSession != null)"
               IsUpdatingItems="@_isUpdatingItems"
               SearchCustomers="@SearchCustomersAsync"
               OnParkClick="@ParkSessionAsync"
               OnCancelClick="@CancelSessionAsync" />

    <!-- Keyboard Shortcuts Help Banner -->
    @if (_currentSession != null)
    {
        <MudPaper Elevation="0" Class="pa-2 mb-2" Style="background: var(--mud-palette-background-grey);">
            <MudText Typo="Typo.caption" Color="Color.Secondary" Align="Align.Center">
                <MudIcon Icon="@Icons.Material.Outlined.Keyboard" Size="Size.Small" Class="mr-1" />
                @TranslationService.GetTranslation("sales.keyboardShortcuts", "Scorciatoie"): 
                <strong>F2</strong> @TranslationService.GetTranslation("sales.pay", "Paga") | 
                <strong>F3</strong> @TranslationService.GetTranslation("sales.park", "Parcheggia") | 
                <strong>F4</strong> @TranslationService.GetTranslation("sales.removeLastItem", "Rimuovi ultimo") | 
                <strong>F8</strong> @TranslationService.GetTranslation("sales.focusScanner", "Scanner") | 
                <strong>F12</strong> @TranslationService.GetTranslation("sales.closeSaleShort", "Chiudi")
            </MudText>
        </MudPaper>
    }

    <!-- Main Content: 2-column layout -->
    <MudGrid Spacing="3">
        <!-- Left Column: Scanner + Products Table (70%) -->
        <MudItem xs="12" md="8">
            @if (_currentSession != null)
            {
                <!-- Barcode Scanner -->
                <BarcodeScanner Title="@TranslationService.GetTranslation("sales.scanProduct", "Scansiona Prodotto")"
                                Label="@TranslationService.GetTranslation("sales.barcode", "Codice a Barre")"
                                HelperText="@TranslationService.GetTranslation("sales.scanOrTypeBarcode", "Scansiona o digita il codice a barre e premi Invio")"
                                SearchButtonText="@TranslationService.GetTranslation("common.search", "Cerca")"
                                IsDisabled="@(_currentSession == null)"
                                OnProductFound="@HandleProductFoundAsync"
                                OnMultipleProductsFound="@HandleMultipleProductsFoundAsync"
                                OnProductNotFound="@HandleProductNotFoundAsync"
                                OnError="@HandleScanErrorAsync" />

                <!-- Scan Mode Toggle -->
                <MudPaper Elevation="2" Class="pa-3 mb-4">
                    <MudRadioGroup @bind-Value="_scanMode">
                        <MudRadio T="ScanMode" Value="ScanMode.AddToCart" Color="Color.Primary">
                            <MudText>
                                <MudIcon Icon="@Icons.Material.Filled.AddShoppingCart" Size="Size.Small" Class="mr-1" />
                                @TranslationService.GetTranslation("sales.addToCart", "Aggiungi al conto")
                            </MudText>
                        </MudRadio>
                        <MudRadio T="ScanMode" Value="ScanMode.PriceCheckOnly" Color="Color.Info">
                            <MudText>
                                <MudIcon Icon="@Icons.Material.Filled.Visibility" Size="Size.Small" Class="mr-1" />
                                @TranslationService.GetTranslation("sales.priceCheckOnly", "Solo visualizza prezzo")
                            </MudText>
                        </MudRadio>
                    </MudRadioGroup>
                </MudPaper>

                <!-- Product Preview Card -->
                @if (_lastScannedProduct != null)
                {
                    <ProductPreviewCard Product="@_lastScannedProduct"
                                        Code="@_lastScannedCode"
                                        Mode="@_scanMode"
                                        OnAddToCart="@AddProductFromPreviewAsync"
                                        OnClose="@ClearPreview"
                                        OnImageClick="@OpenImagePreviewAsync" />
                }

                <!-- Products Table -->
                <MudPaper Elevation="2" Class="pa-4 mb-4">
                    <MudText Typo="Typo.h6" Class="mb-3">
                        <MudIcon Icon="@Icons.Material.Filled.ShoppingCart" Class="mr-2" />
                        @TranslationService.GetTranslation("sales.items", "Articoli")
                        <MudChip T="string" Size="Size.Small" Color="Color.Primary" Class="ml-2">@_currentSession.Items.Count</MudChip>
                    </MudText>

                    @if (_currentSession.Items.Any())
                    {
                        <MudTable Items="@_currentSession.Items" Hover="true" Striped="true" Dense="true">
                            <HeaderContent>
                                <MudTh>@TranslationService.GetTranslation("products.code", "Codice")</MudTh>
                                <MudTh>@TranslationService.GetTranslation("products.product", "Prodotto")</MudTh>
                                <MudTh Style="text-align: center;">@TranslationService.GetTranslation("sales.quantity", "Quantit√†")</MudTh>
                                <MudTh Style="text-align: right;">@TranslationService.GetTranslation("sales.price", "Prezzo")</MudTh>
                                <MudTh Style="text-align: right;">@TranslationService.GetTranslation("sales.discount", "Sconto")</MudTh>
                                <MudTh Style="text-align: right;">@TranslationService.GetTranslation("sales.total", "Totale")</MudTh>
                                <MudTh Style="text-align: center;">@TranslationService.GetTranslation("common.actions", "Azioni")</MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd DataLabel="Code">@context.ProductCode</MudTd>
                                <MudTd DataLabel="Product">@context.ProductName</MudTd>
                                <MudTd DataLabel="Quantity" Style="text-align: center;">
                                    <div class="d-flex align-center justify-center gap-1">
                                        <MudIconButton Icon="@Icons.Material.Filled.Remove" 
                                                       Size="Size.Small" 
                                                       OnClick="@(() => DecreaseQuantityAsync(context))"
                                                       Disabled="@(context.Quantity <= 1)" />
                                        <MudNumericField T="decimal"
                                                         Value="@context.Quantity"
                                                         ValueChanged="@((decimal val) => { context.Quantity = val; QueueItemUpdate(context); })"
                                                         Min="1"
                                                         HideSpinButtons="true"
                                                         Style="width: 60px; text-align: center;"
                                                         Variant="Variant.Text" />
                                        <MudIconButton Icon="@Icons.Material.Filled.Add" 
                                                       Size="Size.Small" 
                                                       OnClick="@(() => IncreaseQuantityAsync(context))" />
                                    </div>
                                </MudTd>
                                <MudTd DataLabel="Price" Style="text-align: right;">
                                    <MudNumericField T="decimal"
                                                     Value="@context.UnitPrice"
                                                     ValueChanged="@((decimal val) => { context.UnitPrice = val; QueueItemUpdate(context); })"
                                                     Format="N2"
                                                     Min="0"
                                                     HideSpinButtons="true"
                                                     Style="width: 100px;"
                                                     Variant="Variant.Text" />
                                </MudTd>
                                <MudTd DataLabel="Discount" Style="text-align: right;">
                                    <div class="d-flex align-center justify-end gap-1">
                                        <MudNumericField T="decimal"
                                                         Value="@context.DiscountPercent"
                                                         ValueChanged="@((decimal val) => { context.DiscountPercent = val; QueueItemUpdate(context); })"
                                                         Format="N1"
                                                         Min="0"
                                                         Max="100"
                                                         HideSpinButtons="true"
                                                         Style="width: 60px;"
                                                         Variant="Variant.Text" />
                                        <MudText Typo="Typo.body2">%</MudText>
                                    </div>
                                </MudTd>
                                <MudTd DataLabel="Total" Style="text-align: right;">
                                    <MudText Typo="Typo.body1" Style="font-weight: 600;">
                                        @context.TotalAmount.ToString("C")
                                    </MudText>
                                </MudTd>
                                <MudTd DataLabel="Actions" Style="text-align: center;">
                                    <MudIconButton Icon="@Icons.Material.Filled.Edit" 
                                                   Size="Size.Small" 
                                                   Color="Color.Primary"
                                                   OnClick="@(() => EditItemNotesAsync(context))"
                                                   Title="@TranslationService.GetTranslation("common.notes", "Note")" />
                                    <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                                   Size="Size.Small" 
                                                   Color="Color.Error"
                                                   OnClick="@(() => RemoveItemAsync(context))" />
                                </MudTd>
                            </RowTemplate>
                        </MudTable>
                    }
                    else
                    {
                        <MudAlert Severity="Severity.Info" Dense="true">
                            @TranslationService.GetTranslation("sales.emptyCart", "Nessun articolo nel carrello. Scansiona un prodotto per iniziare.")
                        </MudAlert>
                    }
                </MudPaper>

                <!-- Main Action Button -->
                <MudPaper Elevation="2" Class="pa-4">
                    @if (_currentSession.Items.Any())
                    {
                        @if (_currentSession.IsFullyPaid)
                        {
                            @if (_isSessionClosed)
                            {
                                <!-- Post-closure: Print button -->
                                <MudButton Color="Color.Primary"
                                           Variant="Variant.Filled"
                                           FullWidth="true"
                                           Size="Size.Large"
                                           StartIcon="@Icons.Material.Filled.Print"
                                           OnClick="@PrintReceiptAsync">
                                    @TranslationService.GetTranslation("sales.printReceipt", "üñ®Ô∏è STAMPA SCONTRINO")
                                </MudButton>
                            }
                            else
                            {
                                <!-- Fully paid: Close sale -->
                                <MudButton Color="Color.Success"
                                           Variant="Variant.Filled"
                                           FullWidth="true"
                                           Size="Size.Large"
                                           StartIcon="@Icons.Material.Filled.CheckCircle"
                                           OnClick="@CloseSaleAsync">
                                    @TranslationService.GetTranslation("sales.closeSale", "‚úÖ CHIUDI VENDITA")
                                </MudButton>
                            }
                        }
                        else
                        {
                            <!-- Incomplete payment -->
                            <MudButton Color="Color.Warning"
                                       Variant="Variant.Filled"
                                       FullWidth="true"
                                       Size="Size.Large"
                                       StartIcon="@Icons.Material.Filled.Payment"
                                       OnClick="@AddPaymentAsync">
                                @TranslationService.GetTranslation("sales.addPayment", "AGGIUNGI PAGAMENTO") 
                                @if (_currentSession.RemainingAmount > 0)
                                {
                                    <MudChip T="string" Size="Size.Small" Color="Color.Default" Class="ml-2">
                                        @TranslationService.GetTranslation("sales.missing", "Mancano") @_currentSession.RemainingAmount.ToString("C")
                                    </MudChip>
                                }
                            </MudButton>
                        }
                    }
                    else
                    {
                        <!-- Empty cart -->
                        <MudButton Color="Color.Default"
                                   Variant="Variant.Filled"
                                   FullWidth="true"
                                   Size="Size.Large"
                                   Disabled="true">
                            @TranslationService.GetTranslation("sales.closeSale", "CHIUDI VENDITA")
                        </MudButton>
                    }
                </MudPaper>
            }
            else
            {
                <MudAlert Severity="Severity.Info">
                    @TranslationService.GetTranslation("sales.selectPosToStart", "Seleziona un POS per iniziare")
                </MudAlert>
            }
        </MudItem>

        <!-- Right Column: Receipt Preview (30%) -->
        <MudItem xs="12" md="4">
            <POSReceipt SessionNumber="@_currentSession?.Id"
                        Items="@_currentSession?.Items"
                        Payments="@_currentSession?.Payments" />
        </MudItem>
    </MudGrid>
</MudContainer>

@code {
    // State
    private bool _isLoading = false;
    private bool _isSessionClosed = false;

    // Operator and POS
    private string? _operatorName;
    private StoreUserDto? _currentOperator;
    private List<StorePosDto> _availablePos = new();
    private Guid? _selectedPosId;

    // Customer
    private BusinessPartyDto? _selectedCustomer;

    // Current Session
    private SaleSessionDto? _currentSession;

    // Payment Methods
    private List<PaymentMethodDto> _paymentMethods = new();

    // Scan mode and product preview
    private ScanMode _scanMode = ScanMode.AddToCart;
    private ProductDto? _lastScannedProduct;
    private ProductCodeDto? _lastScannedCode;

    // Debounce for item updates
    private readonly HashSet<Guid> _pendingItemUpdates = new();
    private System.Timers.Timer? _updateDebounceTimer;
    private const int DebounceDelayMs = 500;
    private bool _isUpdatingItems = false;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _isLoading = true;

            // Get current user from authentication
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;
            
            string? username = null;
            if (user.Identity?.IsAuthenticated == true)
            {
                username = user.Identity.Name;
            }

            if (!string.IsNullOrEmpty(username))
            {
                // Parallel API calls for faster loading
                var operatorTask = StoreUserService.GetByUsernameAsync(username);
                var posTask = StorePosService.GetActiveAsync();
                var paymentMethodsTask = PaymentMethodService.GetActiveAsync();

                await Task.WhenAll(operatorTask, posTask, paymentMethodsTask);

                _currentOperator = await operatorTask;
                _operatorName = _currentOperator?.Name ?? username;
                _availablePos = await posTask;
                _paymentMethods = (await paymentMethodsTask).ToList();
            }
            else
            {
                // Load POS and payment methods even without operator
                var posTask = StorePosService.GetActiveAsync();
                var paymentMethodsTask = PaymentMethodService.GetActiveAsync();
                
                await Task.WhenAll(posTask, paymentMethodsTask);
                
                _availablePos = await posTask;
                _paymentMethods = (await paymentMethodsTask).ToList();
            }

            // Check for suspended sessions (depends on above data)
            await CheckForSuspendedSessionsAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error initializing POS page");
            Snackbar.Add(
                TranslationService.GetTranslation("errors.initializationError", "Errore durante l'inizializzazione"),
                Severity.Error
            );
        }
        finally
        {
            _isLoading = false;
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        // Create session when POS is selected
        if (_selectedPosId.HasValue && _currentSession == null && _currentOperator != null)
        {
            await CreateNewSessionAsync();
        }
    }

    private async Task CheckForSuspendedSessionsAsync()
    {
        try
        {
            var allSessions = await SalesService.GetActiveSessionsAsync();
            var suspendedSessions = allSessions?
                .Where(s => s.Status == SaleSessionStatusDto.Suspended)
                .ToList();

            if (suspendedSessions?.Any() == true)
            {
                var parameters = new DialogParameters
                {
                    { "SuspendedSessions", suspendedSessions }
                };

                var dialog = await DialogService.ShowAsync<ResumeSessionDialog>(
                    TranslationService.GetTranslation("sales.resumeSession", "Riprendi Sessione"),
                    parameters,
                    new DialogOptions { MaxWidth = MaxWidth.Medium, FullWidth = true }
                );

                var result = await dialog.Result;

                if (!result.Canceled && result.Data is SaleSessionDto selectedSession)
                {
                    _currentSession = selectedSession;
                    _selectedPosId = selectedSession.PosId;
                    _selectedCustomer = selectedSession.CustomerId.HasValue 
                        ? await BusinessPartyService.GetBusinessPartyAsync(selectedSession.CustomerId.Value) 
                        : null;
                }
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error checking for suspended sessions");
        }
    }

    private async Task CreateNewSessionAsync()
    {
        if (!_selectedPosId.HasValue || _currentOperator == null)
            return;

        try
        {
            _isLoading = true;

            var createDto = new CreateSaleSessionDto
            {
                OperatorId = _currentOperator.Id,
                PosId = _selectedPosId.Value,
                CustomerId = _selectedCustomer?.Id,
                SaleType = SaleTypes.Retail,
                Currency = Currencies.EUR
            };

            _currentSession = await SalesService.CreateSessionAsync(createDto);
            _isSessionClosed = false;

            Snackbar.Add(
                TranslationService.GetTranslation("sales.sessionCreated", "Sessione creata con successo"),
                Severity.Success
            );
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error creating sale session");
            Snackbar.Add(
                TranslationService.GetTranslation("errors.sessionCreationError", "Errore durante la creazione della sessione"),
                Severity.Error
            );
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task HandleProductFoundAsync(ProductWithCodeDto productWithCode)
    {
        if (_currentSession == null || productWithCode.Product == null)
            return;

        // Store for preview
        _lastScannedProduct = productWithCode.Product;
        _lastScannedCode = productWithCode.Code;

        // If mode is AddToCart, add immediately
        if (_scanMode == ScanMode.AddToCart)
        {
            await AddProductToCartAsync(productWithCode.Product);
        }
        // Otherwise just show preview (PriceCheckOnly mode)
    }

    private async Task AddProductToCartAsync(ProductDto product)
    {
        if (_currentSession == null || product == null)
            return;

        try
        {
            // Check if product already in cart
            var existingItem = _currentSession.Items.FirstOrDefault(i => i.ProductId == product.Id);

            if (existingItem != null)
            {
                // Increment quantity
                existingItem.Quantity++;
                await UpdateItemAsync(existingItem);
                
                Snackbar.Add(
                    TranslationService.GetTranslation("sales.quantityIncreased", "Quantit√† aumentata: {0}", product.Name),
                    Severity.Success
                );
            }
            else
            {
                // Add new item
                var addItemDto = new AddSaleItemDto
                {
                    ProductId = product.Id,
                    Quantity = 1,
                    UnitPrice = product.DefaultPrice ?? 0m,
                    DiscountPercent = 0,
                    Notes = null
                };

                _currentSession = await SalesService.AddItemAsync(_currentSession.Id, addItemDto);

                Snackbar.Add(
                    TranslationService.GetTranslation("sales.productAdded", "Prodotto aggiunto: {0}", product.Name),
                    Severity.Success
                );
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error adding product to session");
            Snackbar.Add(
                TranslationService.GetTranslation("errors.addProductError", "Errore durante l'aggiunta del prodotto"),
                Severity.Error
            );
        }
    }

    private async Task HandleMultipleProductsFoundAsync(List<ProductDto> products)
    {
        var parameters = new DialogParameters
        {
            { "InitialProducts", products }
        };

        var dialog = await DialogService.ShowAsync<ProductSearchDialog>(
            TranslationService.GetTranslation("sales.selectProduct", "Seleziona Prodotto"),
            parameters,
            new DialogOptions { MaxWidth = MaxWidth.Large, FullWidth = true }
        );

        var result = await dialog.Result;

        if (!result.Canceled && result.Data is ProductDto selectedProduct)
        {
            var productWithCode = new ProductWithCodeDto
            {
                Product = selectedProduct,
                Code = null
            };
            await HandleProductFoundAsync(productWithCode);
        }
    }

    private async Task AddProductFromPreviewAsync()
    {
        if (_lastScannedProduct != null)
        {
            await AddProductToCartAsync(_lastScannedProduct);
        }
    }

    private void ClearPreview()
    {
        _lastScannedProduct = null;
        _lastScannedCode = null;
    }

    private async Task OpenImagePreviewAsync()
    {
        if (_lastScannedProduct == null)
            return;

        var parameters = new DialogParameters
        {
            { "ImageUrl", _lastScannedProduct.ImageUrl },
            { "ProductName", _lastScannedProduct.Name },
            { "ProductCode", _lastScannedCode?.Code ?? _lastScannedProduct.Code },
            { "Price", _lastScannedProduct.DefaultPrice }
        };

        await DialogService.ShowAsync<ImagePreviewDialog>(
            _lastScannedProduct.Name,
            parameters,
            new DialogOptions { MaxWidth = MaxWidth.Medium }
        );
    }

    private async Task HandleProductNotFoundAsync(string barcode)
    {
        var parameters = new DialogParameters
        {
            { "Barcode", barcode }
        };

        var dialog = await DialogService.ShowAsync<ProductNotFoundDialog>(
            TranslationService.GetTranslation("warehouse.productNotFound", "Prodotto non trovato"),
            parameters,
            new DialogOptions { MaxWidth = MaxWidth.Medium, FullWidth = true }
        );

        await dialog.Result;
        var result = await dialog.Result;
        
        if (!result.Canceled && result.Data != null)
        {
            // Handle "skip" action
            if (result.Data is string action && action == "skip")
            {
                Snackbar.Add(
                    TranslationService.GetTranslation("sales.productSkipped", "Prodotto saltato"),
                    Severity.Info
                );
                return;
            }
            
            // Handle ProductDto (newly created product)
            if (result.Data is ProductDto product)
            {
                await AddProductToCartAsync(product);
                return;
            }
            
            // Handle product assignment result (from AssignBarcodeToProduct)
            if (result.Data is ProductNotFoundDialog.AssignResult assignResult)
            {
                await AddProductToCartAsync(assignResult.Product);
                return;
            }
        }
    }

    private Task HandleScanErrorAsync(Exception exception)
    {
        Logger.LogError(exception, "Error during barcode scan");
        return Task.CompletedTask;
    }

    private async Task<IEnumerable<BusinessPartyDto>> SearchCustomersAsync(string searchTerm, CancellationToken cancellationToken)
    {
        if (string.IsNullOrWhiteSpace(searchTerm))
            return Enumerable.Empty<BusinessPartyDto>();

        try
        {
            var customers = await BusinessPartyService.SearchBusinessPartiesAsync(searchTerm, null, 50);
            return customers ?? Enumerable.Empty<BusinessPartyDto>();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error searching customers");
            return Enumerable.Empty<BusinessPartyDto>();
        }
    }

    private void IncreaseQuantityAsync(SaleItemDto item)
    {
        item.Quantity++;
        QueueItemUpdate(item); // Use debounce to batch API calls
        StateHasChanged();
    }

    private void DecreaseQuantityAsync(SaleItemDto item)
    {
        if (item.Quantity > 1)
        {
            item.Quantity--;
            QueueItemUpdate(item); // Use debounce to batch API calls
            StateHasChanged();
        }
    }

    private async Task UpdateItemAsync(SaleItemDto item)
    {
        if (_currentSession == null)
            return;

        try
        {
            var updateDto = new UpdateSaleItemDto
            {
                Quantity = item.Quantity,
                UnitPrice = item.UnitPrice,
                DiscountPercent = item.DiscountPercent,
                Notes = item.Notes
            };

            _currentSession = await SalesService.UpdateItemAsync(_currentSession.Id, item.Id, updateDto);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error updating item");
            Snackbar.Add(
                TranslationService.GetTranslation("errors.updateItemError", "Errore durante l'aggiornamento"),
                Severity.Error
            );
        }
    }

    private async Task EditItemNotesAsync(SaleItemDto item)
    {
        var parameters = new DialogParameters
        {
            { "InitialNotes", item.Notes ?? string.Empty },
            { "Item", item }
        };

        var dialog = await DialogService.ShowAsync<ItemNotesDialog>(
            TranslationService.GetTranslation("sales.editNotes", "Modifica Note"),
            parameters,
            new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true }
        );

        var result = await dialog.Result;
        if (!result.Canceled && result.Data is string newNotes)
        {
            item.Notes = newNotes;
            QueueItemUpdate(item); // Use debounce for notes too
        }
    }

    private async Task RemoveItemAsync(SaleItemDto item)
    {
        if (_currentSession == null)
            return;

        // Conferma per articoli significativi
        if (item.Quantity > 1 || item.TotalAmount > 50)
        {
            bool? confirm = await DialogService.ShowMessageBox(
                TranslationService.GetTranslation("common.confirm", "Conferma"),
                TranslationService.GetTranslation("sales.confirmRemoveItem", 
                    "Rimuovere {0} (x{1}) per {2}?", 
                    item.ProductName, item.Quantity, item.TotalAmount.ToString("C")),
                yesText: TranslationService.GetTranslation("common.yes", "S√¨"),
                cancelText: TranslationService.GetTranslation("common.no", "No")
            );

            if (confirm != true) return;
        }

        try
        {
            _currentSession = await SalesService.RemoveItemAsync(_currentSession.Id, item.Id);
            
            Snackbar.Add(
                TranslationService.GetTranslation("sales.itemRemoved", "Articolo rimosso"),
                Severity.Info
            );
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error removing item");
            Snackbar.Add(
                TranslationService.GetTranslation("errors.removeItemError", "Errore durante la rimozione"),
                Severity.Error
            );
        }
    }

    private async Task AddPaymentAsync()
    {
        // Pre-validation checks
        if (_currentSession == null)
        {
            Snackbar.Add(
                TranslationService.GetTranslation("errors.noActiveSession", "Nessuna sessione attiva"),
                Severity.Warning
            );
            return;
        }

        if (!_currentSession.Items.Any())
        {
            Snackbar.Add(
                TranslationService.GetTranslation("sales.addProductsFirst", "Aggiungi prodotti prima di pagare"),
                Severity.Warning
            );
            return;
        }

        if (_currentSession.IsFullyPaid)
        {
            Snackbar.Add(
                TranslationService.GetTranslation("sales.billAlreadySettled", "Il conto √® gi√† saldato"),
                Severity.Info
            );
            return;
        }

        var parameters = new DialogParameters
        {
            { "TotalAmount", _currentSession.FinalTotal },
            { "AlreadyPaid", _currentSession.Payments.Where(p => p.Status == PaymentStatusDto.Completed).Sum(p => p.Amount) },
            { "PaymentMethods", _paymentMethods }
        };

        var dialog = await DialogService.ShowAsync<PaymentDialog>(
            TranslationService.GetTranslation("sales.payBill", "Paga Conto"),
            parameters
        );

        var result = await dialog.Result;

        if (!result.Canceled && result.Data is PaymentDialog.PaymentDialogResult paymentDialogResult)
        {
            // Process all payments from the dialog
            var successfulPayments = 0;
            var failedPayments = 0;

            foreach (var pendingPayment in paymentDialogResult.Payments)
            {
                try
                {
                    var addPaymentDto = new AddSalePaymentDto
                    {
                        PaymentMethodId = pendingPayment.Method.Id,
                        Amount = pendingPayment.Amount,
                        Notes = pendingPayment.Notes
                    };

                    _currentSession = await SalesService.AddPaymentAsync(_currentSession.Id, addPaymentDto);
                    successfulPayments++;
                }
                catch (Exception ex)
                {
                    Logger.LogError(ex, "Error adding payment for method {MethodName}", pendingPayment.Method.Name);
                    failedPayments++;
                }
            }

            // Show summary
            if (successfulPayments > 0)
            {
                var message = successfulPayments == 1
                    ? TranslationService.GetTranslation("sales.paymentAdded", "Pagamento aggiunto")
                    : TranslationService.GetTranslation("sales.paymentSuccess", "Pagamento completato!");
                
                Snackbar.Add(message, Severity.Success);
            }

            if (failedPayments > 0)
            {
                Snackbar.Add(
                    TranslationService.GetTranslation("errors.paymentError", "Errore durante il pagamento"),
                    Severity.Error
                );
            }
        }
    }

    private async Task CloseSaleAsync()
    {
        if (_currentSession == null || !_currentSession.IsFullyPaid)
            return;

        try
        {
            _isLoading = true;

            // Flush pending updates before closing session to prevent data loss
            await FlushPendingUpdatesAsync();

            _currentSession = await SalesService.CloseSessionAsync(_currentSession.Id);
            _isSessionClosed = true;

            Snackbar.Add(
                TranslationService.GetTranslation("sales.saleClosed", "Vendita completata con successo!"),
                Severity.Success
            );

            // Auto-prepare for new sale after a short delay
            await Task.Delay(2000);
            await PrepareNewSaleAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error closing sale");
            Snackbar.Add(
                TranslationService.GetTranslation("errors.closeSaleError", "Errore durante la chiusura della vendita"),
                Severity.Error
            );
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task ParkSessionAsync()
    {
        if (_currentSession == null)
            return;

        try
        {
            // Flush pending updates before parking session to prevent data loss
            await FlushPendingUpdatesAsync();
            
            var updateDto = new UpdateSaleSessionDto
            {
                Status = SaleSessionStatusDto.Suspended,
                CustomerId = _selectedCustomer?.Id
            };

            _currentSession = await SalesService.UpdateSessionAsync(_currentSession.Id, updateDto);

            Snackbar.Add(
                TranslationService.GetTranslation("sales.sessionParked", "Sessione parcheggiata"),
                Severity.Info
            );

            await PrepareNewSaleAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error parking session");
            Snackbar.Add(
                TranslationService.GetTranslation("errors.parkSessionError", "Errore durante il parcheggio della sessione"),
                Severity.Error
            );
        }
    }

    private async Task CancelSessionAsync()
    {
        if (_currentSession == null)
            return;

        bool? confirm = await DialogService.ShowMessageBox(
            TranslationService.GetTranslation("sales.cancelSession", "Annulla Sessione"),
            TranslationService.GetTranslation("sales.cancelSessionConfirm", "Sei sicuro di voler annullare questa sessione? Tutti i dati andranno persi."),
            yesText: TranslationService.GetTranslation("common.yes", "S√¨"),
            cancelText: TranslationService.GetTranslation("common.no", "No")
        );

        if (confirm == true)
        {
            try
            {
                // Flush pending updates before canceling session to prevent data loss
                await FlushPendingUpdatesAsync();
                
                var updateDto = new UpdateSaleSessionDto
                {
                    Status = SaleSessionStatusDto.Cancelled
                };

                await SalesService.UpdateSessionAsync(_currentSession.Id, updateDto);

                Snackbar.Add(
                    TranslationService.GetTranslation("sales.sessionCancelled", "Sessione annullata"),
                    Severity.Info
                );

                await PrepareNewSaleAsync();
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Error cancelling session");
                Snackbar.Add(
                    TranslationService.GetTranslation("errors.cancelSessionError", "Errore durante l'annullamento della sessione"),
                    Severity.Error
                );
            }
        }
    }

    private async Task PrepareNewSaleAsync()
    {
        _currentSession = null;
        _selectedCustomer = null;
        _isSessionClosed = false;

        if (_selectedPosId.HasValue)
        {
            await CreateNewSessionAsync();
        }
    }

    private async Task PrintReceiptAsync()
    {
        if (_currentSession == null)
            return;

        try
        {
            // Generate printable receipt content
            var receiptContent = GenerateReceiptContent(_currentSession);

            // Use browser print functionality
            await JSRuntime.InvokeVoidAsync("printReceipt", receiptContent);

            Snackbar.Add(
                TranslationService.GetTranslation("sales.printingReceipt", "Stampa scontrino in corso..."),
                Severity.Info
            );

            // After printing, prepare for new sale
            await Task.Delay(1000);
            await PrepareNewSaleAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error printing receipt");
            Snackbar.Add(
                TranslationService.GetTranslation("errors.printError", "Errore durante la stampa"),
                Severity.Error
            );
        }
    }

    private string GenerateReceiptContent(SaleSessionDto session)
    {
        var sb = new System.Text.StringBuilder();
        sb.AppendLine("<!DOCTYPE html>");
        sb.AppendLine("<html><head>");
        sb.AppendLine("<meta charset='utf-8'>");
        sb.AppendLine("<style>");
        sb.AppendLine("body { font-family: 'Courier New', monospace; width: 80mm; margin: 0 auto; }");
        sb.AppendLine("h1 { text-align: center; font-size: 18px; margin: 10px 0; }");
        sb.AppendLine(".header { text-align: center; border-bottom: 2px dashed #000; padding-bottom: 10px; margin-bottom: 10px; }");
        sb.AppendLine(".item { margin: 5px 0; }");
        sb.AppendLine(".item-name { font-weight: bold; }");
        sb.AppendLine(".item-details { display: flex; justify-content: space-between; font-size: 12px; }");
        sb.AppendLine(".totals { border-top: 2px dashed #000; padding-top: 10px; margin-top: 10px; }");
        sb.AppendLine(".total-row { display: flex; justify-content: space-between; margin: 3px 0; }");
        sb.AppendLine(".grand-total { font-size: 16px; font-weight: bold; border-top: 2px solid #000; padding-top: 5px; margin-top: 5px; }");
        sb.AppendLine(".footer { text-align: center; margin-top: 20px; font-size: 12px; }");
        sb.AppendLine("@media print { body { width: 80mm; } }");
        sb.AppendLine("</style>");
        sb.AppendLine("</head><body>");

        // Header
        sb.AppendLine("<div class='header'>");
        sb.AppendLine("<h1>SCONTRINO</h1>");
        sb.AppendLine($"<p>Sessione: #{session.Id.ToString("N")[..8]}</p>");
        sb.AppendLine($"<p>{DateTime.Now:dd/MM/yyyy HH:mm:ss}</p>");
        if (!string.IsNullOrEmpty(_operatorName))
        {
            sb.AppendLine($"<p>Operatore: {_operatorName}</p>");
        }
        sb.AppendLine("</div>");

        // Items
        foreach (var item in session.Items)
        {
            sb.AppendLine("<div class='item'>");
            sb.AppendLine($"<div class='item-name'>{item.ProductName}</div>");
            sb.AppendLine("<div class='item-details'>");
            sb.AppendLine($"<span>{item.Quantity} x {item.UnitPrice:C}");
            if (item.DiscountPercent > 0)
            {
                sb.AppendLine($" (-{item.DiscountPercent:F1}%)");
            }
            sb.AppendLine("</span>");
            sb.AppendLine($"<span>{item.TotalAmount:C}</span>");
            sb.AppendLine("</div>");
            sb.AppendLine("</div>");
        }

        // Totals
        sb.AppendLine("<div class='totals'>");
        var subtotal = session.Items.Sum(i => i.Quantity * i.UnitPrice);
        var discount = session.Items.Sum(i => i.Quantity * i.UnitPrice * i.DiscountPercent / 100);
        var tax = session.Items.Sum(i => i.TaxAmount);

        sb.AppendLine($"<div class='total-row'><span>Subtotale:</span><span>{subtotal:C}</span></div>");
        if (discount > 0)
        {
            sb.AppendLine($"<div class='total-row'><span>Sconto:</span><span>-{discount:C}</span></div>");
        }
        sb.AppendLine($"<div class='total-row'><span>IVA:</span><span>{tax:C}</span></div>");
        sb.AppendLine($"<div class='total-row grand-total'><span>TOTALE:</span><span>{session.FinalTotal:C}</span></div>");

        // Payments
        if (session.Payments?.Any() == true)
        {
            sb.AppendLine("<div style='margin-top: 10px;'>");
            var totalPaid = session.Payments.Where(p => p.Status == PaymentStatusDto.Completed).Sum(p => p.Amount);
            foreach (var payment in session.Payments.Where(p => p.Status == PaymentStatusDto.Completed))
            {
                sb.AppendLine($"<div class='total-row'><span>{payment.PaymentMethodName}:</span><span>{payment.Amount:C}</span></div>");
            }
            if (totalPaid > session.FinalTotal)
            {
                var change = totalPaid - session.FinalTotal;
                sb.AppendLine($"<div class='total-row' style='font-weight: bold;'><span>RESTO:</span><span>{change:C}</span></div>");
            }
            sb.AppendLine("</div>");
        }
        sb.AppendLine("</div>");

        // Footer
        sb.AppendLine("<div class='footer'>");
        sb.AppendLine("<p>Grazie per il vostro acquisto!</p>");
        sb.AppendLine("</div>");

        sb.AppendLine("<script>");
        sb.AppendLine("window.onload = function() { window.print(); };");
        sb.AppendLine("</script>");
        sb.AppendLine("</body></html>");

        return sb.ToString();
    }

    /// <summary>
    /// Queues an item update with debounce to avoid excessive API calls.
    /// Multiple rapid changes are batched into a single API call after 500ms of inactivity.
    /// </summary>
    private void QueueItemUpdate(SaleItemDto item)
    {
        // Set loading state
        _isUpdatingItems = true;
        
        // Add item ID to pending updates
        _pendingItemUpdates.Add(item.Id);
        
        // Initialize timer on first use or reuse existing one
        if (_updateDebounceTimer == null)
        {
            _updateDebounceTimer = new System.Timers.Timer(DebounceDelayMs);
            _updateDebounceTimer.AutoReset = false;
            
            // When timer fires, update all pending items
            _updateDebounceTimer.Elapsed += async (sender, e) =>
            {
                await InvokeAsync(async () =>
                {
                    try
                    {
                        // Get list of items to update
                        var itemsToUpdate = _pendingItemUpdates.ToList();
                        _pendingItemUpdates.Clear();
                        
                        // Build dictionary for O(1) lookup (use GroupBy in case of duplicates)
                        var itemsDict = _currentSession?.Items
                            .GroupBy(i => i.Id)
                            .ToDictionary(g => g.Key, g => g.First());
                        
                        // Update each pending item
                        if (itemsDict != null)
                        {
                            foreach (var itemId in itemsToUpdate)
                            {
                                if (itemsDict.TryGetValue(itemId, out var itemToUpdate))
                                {
                                    await UpdateItemAsync(itemToUpdate);
                                }
                            }
                        }
                        
                        // Clear loading state after update completes
                        _isUpdatingItems = false;
                        StateHasChanged();
                    }
                    catch (Exception ex)
                    {
                        Logger.LogError(ex, "Error in debounced update");
                        Snackbar.Add(
                            TranslationService.GetTranslation("errors.updateError", "Errore durante l'aggiornamento"),
                            Severity.Error
                        );
                        
                        // Clear loading state on error
                        _isUpdatingItems = false;
                        StateHasChanged();
                    }
                });
            };
        }
        
        // Stop timer and restart it (resets the debounce window)
        _updateDebounceTimer.Stop();
        _updateDebounceTimer.Start();
        
        // Update UI immediately for responsive feel
        StateHasChanged();
    }

    /// <summary>
    /// Forces immediate flush of all pending item updates.
    /// Used before completing/canceling session to prevent data loss.
    /// </summary>
    private async Task FlushPendingUpdatesAsync()
    {
        // Check if there are pending updates
        if (_pendingItemUpdates.Count == 0 || _currentSession == null)
            return;
        
        try
        {
            // Stop timer to prevent double execution
            _updateDebounceTimer?.Stop();
            
            // Get list of items to update
            var itemsToUpdate = _pendingItemUpdates.ToList();
            _pendingItemUpdates.Clear();
            
            // Build dictionary for O(1) lookup
            var itemsDict = _currentSession.Items
                .GroupBy(i => i.Id)
                .ToDictionary(g => g.Key, g => g.First());
            
            // Update each pending item
            foreach (var itemId in itemsToUpdate)
            {
                if (itemsDict.TryGetValue(itemId, out var itemToUpdate))
                {
                    await UpdateItemAsync(itemToUpdate);
                }
            }
            
            Logger.LogInformation($"Flushed {itemsToUpdate.Count} pending item updates before session action");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error flushing pending item updates");
            Snackbar.Add(
                TranslationService.GetTranslation("errors.updateError", "Errore durante l'aggiornamento"),
                Severity.Error
            );
            throw; // Re-throw to prevent session completion if updates fail
        }
    }

    // Keyboard shortcuts
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JSRuntime.InvokeVoidAsync("setupPOSKeyboardShortcuts", DotNetObjectReference.Create(this));
        }
    }

    [JSInvokable]
    public async Task HandleKeyboardShortcut(string key)
    {
        if (_currentSession == null && key != "Escape")
            return;

        switch (key)
        {
            case "F2": // Pagamento
                if (_currentSession?.Items.Any() == true && !_currentSession.IsFullyPaid)
                    await AddPaymentAsync();
                break;
                
            case "F3": // Parcheggia
                if (_currentSession != null)
                    await ParkSessionAsync();
                break;
                
            case "F4": // Rimuovi ultimo articolo
                if (_currentSession?.Items.LastOrDefault() is { } lastItem)
                    await RemoveItemAsync(lastItem);
                break;
                
            case "F8": // Focus su scanner barcode (gestito in JS)
                break;
                
            case "F12": // Chiudi vendita
                if (_currentSession?.IsFullyPaid == true && !_isSessionClosed)
                    await CloseSaleAsync();
                break;
                
            case "Escape": // Annulla sessione
                if (_currentSession != null)
                    await CancelSessionAsync();
                break;
        }
        
        await InvokeAsync(StateHasChanged);
    }

    // Dispose pattern
    /// <summary>
    /// Cleanup resources to prevent memory leaks
    /// </summary>
    public void Dispose()
    {
        // Stop and dispose timer to prevent memory leaks
        if (_updateDebounceTimer != null)
        {
            _updateDebounceTimer.Stop();
            _updateDebounceTimer.Dispose();
            _updateDebounceTimer = null;
        }
    }
}
