@page "/sales/pos"
@using EventForge.Client.ViewModels
@using EventForge.DTOs.Sales
@using EventForge.DTOs.Products
@using EventForge.DTOs.Store
@using EventForge.DTOs.Business
@using EventForge.Client.Shared.Components.Sales
@using EventForge.Client.Shared.Components.Dialogs.Sales
@using EventForge.Client.Shared.Components.Dialogs
@using EventForge.Client.Shared.Components
@using EventForge.Client.Services.Sales
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@implements IDisposable
@attribute [Authorize]
@inject POSViewModel ViewModel
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject ITranslationService TranslationService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IJSRuntime JSRuntime
@inject ISalesService SalesService

<PageTitle>@TranslationService.GetTranslation("sales.pos", "Punto Vendita")</PageTitle>
<PageLoadingOverlay Visible="ViewModel.IsLoading" 
                    Message="@TranslationService.GetTranslation("common.loading", "Caricamento...")" />

<MudContainer MaxWidth="MaxWidth.False" Class="mt-4">
    <!-- Page Title -->
    <MudText Typo="Typo.h4" Class="mb-4">
        <MudIcon Icon="@Icons.Material.Filled.PointOfSale" Class="mr-2" Size="Size.Medium" />
        @TranslationService.GetTranslation("sales.pos", "Punto Vendita")
    </MudText>

    <!-- POS Header -->
    <POSHeader AvailableOperators="@ViewModel.AvailableOperators"
               SelectedOperatorId="@ViewModel.SelectedOperatorId"
               SelectedOperatorIdChanged="@((value) => ViewModel.SelectedOperatorId = value)"
               AvailablePos="@ViewModel.AvailablePos"
               SelectedPosId="@ViewModel.SelectedPosId"
               SelectedPosIdChanged="@((value) => ViewModel.SelectedPosId = value)"
               SelectedCustomer="@ViewModel.SelectedCustomer"
               SelectedCustomerChanged="@OnSelectedCustomerChangedAsync"
               SessionNumber="@ViewModel.CurrentSession?.Id"
               IsSessionActive="@ViewModel.HasActiveSession"
               IsUpdatingItems="@ViewModel.IsUpdatingItems"
               LoadingTooltipText="@GetLoadingTooltipText()"
               LoadingSpinnerColor="@GetLoadingSpinnerColor()"
               OnParkClick="@ParkSessionAsync"
               OnCancelClick="@CancelSessionAsync" />

    <!-- Keyboard Shortcuts (solo se ha sessione) -->
    @if (ViewModel.HasActiveSession)
    {
        <MudPaper Elevation="0" 
                  Class="pa-2 mb-2" 
                  Style="background: linear-gradient(90deg, #e3f2fd, #f3e5f5); border-radius: 8px;">
            
            <MudStack Row="true" 
                      Justify="Justify.SpaceAround" 
                      AlignItems="AlignItems.Center" 
                      Wrap="Wrap.Wrap">
                
                <MudChip T="string" Size="Size.Small" 
                         Icon="@Icons.Material.Outlined.Payment" 
                         Variant="Variant.Text">
                    <strong>F2</strong> @TranslationService.GetTranslation("sales.pay", "Paga")
                </MudChip>
                
                <MudChip T="string" Size="Size.Small" 
                         Icon="@Icons.Material.Outlined.Pause" 
                         Variant="Variant.Text">
                    <strong>F3</strong> @TranslationService.GetTranslation("sales.park", "Parcheggia")
                </MudChip>
                
                <MudChip T="string" Size="Size.Small" 
                         Icon="@Icons.Material.Outlined.RemoveCircle" 
                         Variant="Variant.Text">
                    <strong>F4</strong> @TranslationService.GetTranslation("sales.removeLastItem", "Rimuovi")
                </MudChip>
                
                <MudChip T="string" Size="Size.Small" 
                         Icon="@Icons.Material.Outlined.Search" 
                         Variant="Variant.Text">
                    <strong>F8</strong> @TranslationService.GetTranslation("sales.focusScanner", "Scanner")
                </MudChip>
                
                <MudChip T="string" Size="Size.Small" 
                         Icon="@Icons.Material.Outlined.CheckCircle" 
                         Variant="Variant.Text">
                    <strong>F12</strong> @TranslationService.GetTranslation("sales.closeSaleShort", "Chiudi")
                </MudChip>
                
            </MudStack>
        </MudPaper>
    }

    <!-- Main Content: 2-column responsive layout -->
    <MudGrid Spacing="3">
        
        <!-- Left Column: Scanner + Toolbar + Cart (70% desktop) -->
        <MudItem xs="12" lg="8">
            @if (ViewModel.HasActiveSession)
            {
                <MudStack Spacing="2">
                    
                    <!-- UnifiedProductScanner -->
                    <UnifiedProductScanner 
                        SelectedProduct="@_currentProduct"
                        SelectedProductChanged="@OnProductSelectedAsync"
                        Title="@TranslationService.GetTranslation("sales.scanProduct", "Scansiona Prodotto")"
                        Placeholder="@TranslationService.GetTranslation("sales.scanOrType", "Scansiona codice o cerca nome...")"
                        SearchMode="ProductSearchMode.Both"
                        EditMode="ProductEditMode.Dialog"
                        CreateMode="ProductCreateMode.Dialog"
                        ShowProductInfo="true"
                        AllowClear="true"
                        AutoFocus="true"
                        Disabled="@(!ViewModel.HasActiveSession)"
                        OnProductWithCodeFound="@HandleProductWithCodeFoundAsync"
                        OnProductNotFound="@HandleProductNotFoundAsync" />

                    <!-- Toolbar Azioni Rapide (visibile solo se ha items) -->
                    @if (ViewModel.CurrentSession?.Items.Any() == true)
                    {
                        <MudPaper Elevation="1" Class="pa-2 mb-2">
                            <MudStack Row="true" Spacing="2" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                
                                <!-- Azioni Sinistra -->
                                <MudStack Row="true" Spacing="1">
                                    
                                    <MudTooltip Text="@TranslationService.GetTranslation("sales.applyGlobalDiscount", "Applica sconto globale al carrello")">
                                        <MudButton Variant="Variant.Text"
                                                   Color="Color.Warning"
                                                   StartIcon="@Icons.Material.Outlined.Discount"
                                                   Size="Size.Small"
                                                   OnClick="@ApplyGlobalDiscountAsync">
                                            @TranslationService.GetTranslation("sales.discountShort", "Sconto %")
                                        </MudButton>
                                    </MudTooltip>
                                    
                                    <MudTooltip Text="@TranslationService.GetTranslation("sales.addSessionNoteTooltip", "Aggiungi nota alla vendita")">
                                        <MudButton Variant="Variant.Text"
                                                   Color="Color.Info"
                                                   StartIcon="@Icons.Material.Outlined.Note"
                                                   Size="Size.Small"
                                                   OnClick="@AddSessionNoteAsync">
                                            @TranslationService.GetTranslation("sales.notes", "Note")
                                        </MudButton>
                                    </MudTooltip>
                                    
                                    <MudTooltip Text="@TranslationService.GetTranslation("sales.splitTooltip", "Dividi Conto")">
                                        <MudIconButton Icon="@Icons.Material.Outlined.CallSplit" 
                                                       Color="Color.Primary"
                                                       OnClick="@OpenSplitDialogAsync"
                                                       Disabled="@(!_canSplit)"
                                                       Size="Size.Small" />
                                    </MudTooltip>
                                    
                                    <MudTooltip Text="@TranslationService.GetTranslation("sales.mergeTooltip", "Unisci Sessioni")">
                                        <MudIconButton Icon="@Icons.Material.Outlined.MergeType" 
                                                       Color="Color.Secondary"
                                                       OnClick="@OpenMergeDialogAsync"
                                                       Disabled="@(_openSessions.Count < 2)"
                                                       Size="Size.Small" />
                                    </MudTooltip>
                                    
                                </MudStack>
                                
                                <!-- Info Carrello Centro -->
                                <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                                    <MudChip T="string" Size="Size.Small" Color="Color.Primary" Icon="@Icons.Material.Outlined.ShoppingCart">
                                        @ViewModel.ItemCount @TranslationService.GetTranslation("sales.items", "items")
                                    </MudChip>
                                    <MudChip T="string" Size="Size.Small" Color="Color.Success" Icon="@Icons.Material.Outlined.Euro">
                                        €@ViewModel.CurrentSession.FinalTotal.ToString("F2")
                                    </MudChip>
                                </MudStack>
                                
                                <!-- Azioni Destra -->
                                <MudStack Row="true" Spacing="1">
                                    
                                    <MudTooltip Text="@TranslationService.GetTranslation("sales.removeLastItemTooltip", "Rimuovi ultimo articolo aggiunto (F4)")">
                                        <MudButton Variant="Variant.Text"
                                                   Color="Color.Error"
                                                   StartIcon="@Icons.Material.Outlined.RemoveCircle"
                                                   Size="Size.Small"
                                                   OnClick="@RemoveLastItemAsync">
                                            @TranslationService.GetTranslation("sales.removeLastItem", "Rimuovi Ultimo")
                                        </MudButton>
                                    </MudTooltip>
                                    
                                    <MudTooltip Text="@TranslationService.GetTranslation("sales.clearCartTooltip", "Svuota carrello")">
                                        <MudIconButton Icon="@Icons.Material.Outlined.DeleteSweep"
                                                       Color="Color.Error"
                                                       Size="Size.Small"
                                                       OnClick="@ClearCartAsync" />
                                    </MudTooltip>
                                    
                                </MudStack>
                                
                            </MudStack>
                        </MudPaper>
                    }

                    <!-- Loading State -->
                    @if (ViewModel.IsUpdatingItems)
                    {
                        <MudProgressLinear Color="Color.Primary" 
                                           Indeterminate="true" 
                                           Class="mb-2" 
                                           Style="border-radius: 4px;" />
                        
                        <MudAlert Severity="Severity.Info" 
                                  Dense="true" 
                                  Icon="@Icons.Material.Outlined.Sync"
                                  Elevation="0"
                                  Class="mb-2">
                            @TranslationService.GetTranslation("sales.updatingCart", "Aggiornamento carrello in corso...")
                        </MudAlert>
                    }

                    <!-- Cart o Empty State -->
                    @if (ViewModel.CurrentSession?.Items.Any() == true)
                    {
                        <!-- Cart Table -->
                        <POSCartTable Items="@ViewModel.CurrentSession?.Items"
                                      IsDisabled="@ViewModel.IsUpdatingItems"
                                      OnQuantityChanged="@HandleQuantityChanged"
                                      OnPriceChanged="@HandlePriceChanged"
                                      OnDiscountChanged="@HandleDiscountChanged"
                                      OnEditNotes="@EditItemNotesAsync"
                                      OnRemoveItem="@RemoveItemAsync"
                                      OnIncreaseQuantity="@IncreaseQuantityAsync"
                                      OnDecreaseQuantity="@DecreaseQuantityAsync" />
                    }
                    else
                    {
                        <!-- Empty Cart State -->
                        <MudPaper Elevation="0" 
                                  Class="pa-8" 
                                  Style="text-align: center; background: var(--mud-palette-background-grey); border-radius: 8px;">
                            
                            <MudIcon Icon="@Icons.Material.Outlined.ShoppingCart" 
                                     Size="Size.Large" 
                                     Color="Color.Secondary" 
                                     Style="font-size: 4rem; opacity: 0.3; margin-bottom: 16px;" />
                            
                            <MudText Typo="Typo.h6" Color="Color.Secondary" Class="mb-2">
                                @TranslationService.GetTranslation("sales.emptyCart", "Carrello vuoto")
                            </MudText>
                            
                            <MudText Typo="Typo.body2" Color="Color.Secondary">
                                @TranslationService.GetTranslation("sales.scanProductHint", "Scansiona un prodotto o cercalo per nome")
                            </MudText>
                            
                        </MudPaper>
                    }

                    <!-- Main Action Button -->
                    <POSActionButton Session="@ViewModel.CurrentSession"
                                     IsSessionClosed="@ViewModel.IsSessionClosed"
                                     OnAddPayment="@AddPaymentAsync"
                                     OnCloseSale="@CloseSaleAsync"
                                     OnPrintReceipt="@PrintReceiptAsync" />
                    
                </MudStack>
            }
            else
            {
                <!-- No Session State -->
                <MudPaper Elevation="0" Class="pa-8" Style="text-align: center;">
                    
                    <MudIcon Icon="@Icons.Material.Outlined.PointOfSale" 
                             Size="Size.Large" 
                             Style="font-size: 5rem; opacity: 0.2; margin-bottom: 20px;" />
                    
                    <MudText Typo="Typo.h5" Class="mb-3">
                        @TranslationService.GetTranslation("sales.selectOperatorAndPos", "Seleziona Operatore e Cassa")
                    </MudText>
                    
                    <MudText Typo="Typo.body1" Color="Color.Secondary">
                        @TranslationService.GetTranslation("sales.selectOperatorAndPosHint", "Seleziona un operatore e un punto cassa per iniziare")
                    </MudText>
                    
                </MudPaper>
            }
        </MudItem>

        <!-- Right Column: Summary + Receipt Preview (30% desktop, sticky) -->
        <MudItem xs="12" lg="4">
            <MudStack Spacing="2" Class="pos-summary-column">
                
                <!-- Summary -->
                <POSReceipt SessionNumber="@ViewModel.CurrentSession?.Id"
                            Items="@ViewModel.CurrentSession?.Items"
                            Payments="@ViewModel.CurrentSession?.Payments"
                            Subtotal="@(ViewModel.CurrentSession?.OriginalTotal ?? 0m)"
                            TotalDiscount="@(ViewModel.CurrentSession?.DiscountAmount ?? 0m)"
                            TotalVat="@(ViewModel.CurrentSession?.TaxAmount ?? 0m)"
                            GrandTotal="@ViewModel.GrandTotal" />
                
            </MudStack>
        </MudItem>
        
    </MudGrid>
</MudContainer>

@code {
    private ProductDto? _currentProduct;

    protected override async Task OnInitializedAsync()
    {
        // Subscribe to ViewModel events
        ViewModel.StateChanged += StateHasChanged;
        ViewModel.OnNotification += HandleNotification;

        // Get current user
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var username = authState.User.Identity?.Name;

        // Initialize ViewModel
        await ViewModel.InitializeAsync(username);
        
        // Initialize split/merge functionality
        await LoadOpenSessionsAsync();
        await CheckCanSplitAsync();
    }

    private void HandleNotification(string message, bool isSuccess)
    {
        Snackbar.Add(message, isSuccess ? Severity.Success : Severity.Error);
    }

    private async Task OnProductSelectedAsync(ProductDto? product)
    {
        if (product == null) return;
        
        var result = await ViewModel.AddProductAsync(product);
        
        if (result.Success)
        {
            _currentProduct = null;
            Snackbar.Add($"✅ {product.Name} aggiunto", Severity.Success);
        }
        else
        {
            Snackbar.Add(result.Error ?? "Errore", Severity.Error);
        }
    }

    private async Task HandleProductWithCodeFoundAsync(ProductWithCodeDto productWithCode)
    {
        await OnProductSelectedAsync(productWithCode.Product);
    }

    private async Task HandleProductNotFoundAsync(string barcode)
    {
        var parameters = new DialogParameters
        {
            { "Barcode", barcode }
        };

        var dialog = await DialogService.ShowAsync<ProductNotFoundDialog>(
            TranslationService.GetTranslation("warehouse.productNotFound", "Prodotto non trovato"),
            parameters,
            new DialogOptions { MaxWidth = MaxWidth.Medium, FullWidth = true }
        );

        var result = await dialog.Result;
        
        if (!result.Canceled && result.Data != null)
        {
            // Handle "skip" action
            if (result.Data is string action && action == "skip")
            {
                Snackbar.Add(
                    TranslationService.GetTranslation("sales.productSkipped", "Prodotto saltato"),
                    Severity.Info
                );
                return;
            }
            
            // Handle ProductDto (newly created product)
            if (result.Data is ProductDto product)
            {
                await OnProductSelectedAsync(product);
                return;
            }
            
            // Handle product assignment result (from AssignBarcodeToProduct)
            if (result.Data is ProductNotFoundDialog.AssignResult assignResult)
            {
                await OnProductSelectedAsync(assignResult.Product);
                return;
            }
        }
    }

    private async Task OnSelectedCustomerChangedAsync(BusinessPartyDto? customer)
    {
        await ViewModel.UpdateSelectedCustomerAsync(customer);
    }

    private void IncreaseQuantityAsync(SaleItemDto item)
    {
        // Prevent modifications during updates
        if (ViewModel.IsUpdatingItems) return;
        
        item.Quantity++;
        ViewModel.QueueItemUpdate(item);
    }

    private void DecreaseQuantityAsync(SaleItemDto item)
    {
        // Prevent modifications during updates
        if (ViewModel.IsUpdatingItems) return;
        
        if (item.Quantity > 1)
        {
            item.Quantity--;
            ViewModel.QueueItemUpdate(item);
        }
    }

    private void QueueItemUpdate(SaleItemDto item)
    {
        // Prevent modifications during updates
        if (ViewModel.IsUpdatingItems) return;
        
        ViewModel.QueueItemUpdate(item);
    }

    private void HandleQuantityChanged((SaleItemDto Item, decimal NewQuantity) args)
    {
        // Prevent modifications during updates
        if (ViewModel.IsUpdatingItems) return;
        
        args.Item.Quantity = args.NewQuantity;
        ViewModel.QueueItemUpdate(args.Item);
    }

    private void HandlePriceChanged((SaleItemDto Item, decimal NewPrice) args)
    {
        // Prevent modifications during updates
        if (ViewModel.IsUpdatingItems) return;
        
        args.Item.UnitPrice = args.NewPrice;
        ViewModel.QueueItemUpdate(args.Item);
    }

    private void HandleDiscountChanged((SaleItemDto Item, decimal NewDiscount) args)
    {
        // Prevent modifications during updates
        if (ViewModel.IsUpdatingItems) return;
        
        args.Item.DiscountPercent = args.NewDiscount;
        ViewModel.QueueItemUpdate(args.Item);
    }

    private async Task EditItemNotesAsync(SaleItemDto item)
    {
        // Prevent modifications during updates
        if (ViewModel.IsUpdatingItems) return;
        
        var parameters = new DialogParameters
        {
            { "InitialNotes", item.Notes ?? string.Empty },
            { "Item", item }
        };

        var dialog = await DialogService.ShowAsync<ItemNotesDialog>(
            TranslationService.GetTranslation("sales.editNotes", "Modifica Note"),
            parameters,
            new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true }
        );

        var result = await dialog.Result;
        if (!result.Canceled && result.Data is string newNotes)
        {
            item.Notes = newNotes;
            ViewModel.QueueItemUpdate(item);
        }
    }

    private async Task RemoveItemAsync(SaleItemDto item)
    {
        if (!ViewModel.HasActiveSession) return;

        // Confirm removal for significant items
        if (item.Quantity > 1 || item.TotalAmount > 50)
        {
            bool? confirm = await DialogService.ShowMessageBox(
                TranslationService.GetTranslation("common.confirm", "Conferma"),
                TranslationService.GetTranslation("sales.confirmRemoveItem", 
                    "Rimuovere {0} (x{1}) per {2}?", 
                    item.ProductName, item.Quantity, item.TotalAmount.ToString("C")),
                yesText: TranslationService.GetTranslation("common.yes", "Sì"),
                cancelText: TranslationService.GetTranslation("common.no", "No")
            );

            if (confirm != true) return;
        }

        var result = await ViewModel.RemoveItemAsync(item);
        if (!result.Success && result.Error != null)
        {
            Snackbar.Add("❌ " + result.Error, Severity.Error);
        }
    }

    private async Task ApplyGlobalDiscountAsync()
    {
        var parameters = new DialogParameters
        {
            ["CurrentTotal"] = ViewModel.CurrentSession?.FinalTotal ?? 0m
        };

        var dialog = await DialogService.ShowAsync<GlobalDiscountDialog>(
            TranslationService.GetTranslation("sales.globalDiscountTitle", "Sconto Globale Carrello"),
            parameters,
            new DialogOptions { MaxWidth = MaxWidth.Small });

        var result = await dialog.Result;

        if (!result.Canceled && result.Data is decimal discountPercent)
        {
            var dto = new ApplyGlobalDiscountDto
            {
                DiscountPercent = discountPercent,
                Reason = TranslationService.GetTranslation("sales.globalDiscountReason", "Sconto globale POS")
            };
            
            var updatedSession = await ViewModel.ApplyGlobalDiscountAsync(dto);
            
            if (updatedSession != null)
            {
                Snackbar.Add($"✅ Sconto {discountPercent}% applicato - Nuovo totale: €{updatedSession.FinalTotal:F2}", Severity.Success);
            }
            else
            {
                Snackbar.Add("❌ Errore applicazione sconto", Severity.Error);
            }
        }
    }

    private async Task AddSessionNoteAsync()
    {
        var parameters = new DialogParameters
        {
            ["SessionId"] = ViewModel.CurrentSession?.Id
        };

        var dialog = await DialogService.ShowAsync<SessionNoteDialog>(
            TranslationService.GetTranslation("sales.addSessionNote", "Aggiungi Nota Vendita"),
            parameters,
            new DialogOptions { MaxWidth = MaxWidth.Small });

        var result = await dialog.Result;

        if (!result.Canceled && result.Data is AddSessionNoteDto noteDto)
        {
            // Chiamata backend REALE (rimuove TODO)
            var updatedSession = await ViewModel.AddSessionNoteAsync(noteDto);
            
            if (updatedSession != null)
            {
                Snackbar.Add($"✅ Nota aggiunta: {noteDto.Text}", Severity.Success);
            }
            else
            {
                Snackbar.Add("❌ Errore aggiunta nota", Severity.Error);
            }
        }
    }

    private async Task RemoveLastItemAsync()
    {
        if (ViewModel.CurrentSession?.Items.Any() != true) return;

        var lastItem = ViewModel.CurrentSession.Items.Last();
        var result = await ViewModel.RemoveItemAsync(lastItem);

        if (result.Success)
        {
            Snackbar.Add(TranslationService.GetTranslation("sales.itemRemoved", $"✅ {lastItem.ProductName} rimosso"), Severity.Success);
        }
    }

    private async Task ClearCartAsync()
    {
        var confirmed = await DialogService.ShowMessageBox(
            TranslationService.GetTranslation("common.confirm", "Conferma"),
            TranslationService.GetTranslation("sales.clearCartConfirm", "Sei sicuro di voler svuotare il carrello?"),
            yesText: TranslationService.GetTranslation("sales.clearCart", "Svuota"),
            cancelText: TranslationService.GetTranslation("common.cancel", "Annulla"));

        if (confirmed == true)
        {
            var items = ViewModel.CurrentSession?.Items.ToList();
            if (items != null)
            {
                foreach (var item in items)
                {
                    await ViewModel.RemoveItemAsync(item);
                }
                Snackbar.Add(TranslationService.GetTranslation("sales.cartCleared", "Carrello svuotato"), Severity.Success);
            }
        }
    }

    private async Task AddPaymentAsync()
    {
        // Pre-validation checks
        if (!ViewModel.HasActiveSession)
        {
            Snackbar.Add(
                TranslationService.GetTranslation("errors.noActiveSession", "Nessuna sessione attiva"),
                Severity.Warning
            );
            return;
        }

        if (!ViewModel.CurrentSession!.Items.Any())
        {
            Snackbar.Add(
                TranslationService.GetTranslation("sales.addProductsFirst", "Aggiungi prodotti prima di pagare"),
                Severity.Warning
            );
            return;
        }

        if (ViewModel.CurrentSession.IsFullyPaid)
        {
            Snackbar.Add(
                TranslationService.GetTranslation("sales.billAlreadySettled", "Il conto è già saldato"),
                Severity.Info
            );
            return;
        }

        var parameters = new DialogParameters
        {
            { "TotalAmount", ViewModel.CurrentSession.FinalTotal },
            { "AlreadyPaid", ViewModel.CurrentSession.Payments.Where(p => p.Status == PaymentStatusDto.Completed).Sum(p => p.Amount) },
            { "PaymentMethods", ViewModel.PaymentMethods }
        };

        var dialog = await DialogService.ShowAsync<PaymentDialog>(
            TranslationService.GetTranslation("sales.payBill", "Paga Conto"),
            parameters
        );

        var result = await dialog.Result;

        if (!result.Canceled && result.Data is PaymentDialog.PaymentDialogResult paymentDialogResult)
        {
            // Process all payments from the dialog
            var successfulPayments = 0;
            var failedPayments = 0;

            foreach (var pendingPayment in paymentDialogResult.Payments)
            {
                var paymentResult = await ViewModel.AddPaymentAsync(pendingPayment.Method, pendingPayment.Amount);
                if (paymentResult.Success)
                {
                    successfulPayments++;
                }
                else
                {
                    failedPayments++;
                }
            }

            // Show summary
            if (successfulPayments > 0)
            {
                var message = successfulPayments == 1
                    ? TranslationService.GetTranslation("sales.paymentAdded", "Pagamento aggiunto")
                    : TranslationService.GetTranslation("sales.paymentSuccess", "Pagamento completato!");
                
                Snackbar.Add(message, Severity.Success);
            }

            if (failedPayments > 0)
            {
                Snackbar.Add(
                    TranslationService.GetTranslation("errors.paymentError", "Errore durante il pagamento"),
                    Severity.Error
                );
            }
        }
    }

    private async Task CloseSaleAsync()
    {
        var result = await ViewModel.CloseSaleAsync();
        if (!result.Success && result.Error != null)
        {
            Snackbar.Add(result.Error, Severity.Error);
        }
    }

    private async Task ParkSessionAsync()
    {
        var result = await ViewModel.ParkSessionAsync();
        if (!result.Success && result.Error != null)
        {
            Snackbar.Add(result.Error, Severity.Error);
        }
    }

    private async Task CancelSessionAsync()
    {
        if (!ViewModel.HasActiveSession)
            return;

        bool? confirm = await DialogService.ShowMessageBox(
            TranslationService.GetTranslation("sales.cancelSession", "Annulla Sessione"),
            TranslationService.GetTranslation("sales.cancelSessionConfirm", "Sei sicuro di voler annullare questa sessione? Tutti i dati andranno persi."),
            yesText: TranslationService.GetTranslation("common.yes", "Sì"),
            cancelText: TranslationService.GetTranslation("common.no", "No")
        );

        if (confirm == true)
        {
            var result = await ViewModel.CancelSessionAsync();
            if (!result.Success && result.Error != null)
            {
                Snackbar.Add(result.Error, Severity.Error);
            }
        }
    }

    private async Task PrintReceiptAsync()
    {
        if (!ViewModel.HasActiveSession)
            return;

        try
        {
            // Generate printable receipt content
            var receiptContent = GenerateReceiptContent(ViewModel.CurrentSession!);

            // Use browser print functionality
            await JSRuntime.InvokeVoidAsync("printReceipt", receiptContent);

            Snackbar.Add(
                TranslationService.GetTranslation("sales.printingReceipt", "Stampa scontrino in corso..."),
                Severity.Info
            );
        }
        catch (Exception ex)
        {
            Snackbar.Add(
                TranslationService.GetTranslation("errors.printError", "Errore durante la stampa"),
                Severity.Error
            );
        }
    }

    private string GenerateReceiptContent(SaleSessionDto session)
    {
        var sb = new System.Text.StringBuilder();
        sb.AppendLine("<!DOCTYPE html>");
        sb.AppendLine("<html><head>");
        sb.AppendLine("<meta charset='utf-8'>");
        sb.AppendLine("<style>");
        sb.AppendLine("body { font-family: 'Courier New', monospace; width: 80mm; margin: 0 auto; }");
        sb.AppendLine("h1 { text-align: center; font-size: 18px; margin: 10px 0; }");
        sb.AppendLine(".header { text-align: center; border-bottom: 2px dashed #000; padding-bottom: 10px; margin-bottom: 10px; }");
        sb.AppendLine(".item { margin: 5px 0; }");
        sb.AppendLine(".item-name { font-weight: bold; }");
        sb.AppendLine(".item-details { display: flex; justify-content: space-between; font-size: 12px; }");
        sb.AppendLine(".totals { border-top: 2px dashed #000; padding-top: 10px; margin-top: 10px; }");
        sb.AppendLine(".total-row { display: flex; justify-content: space-between; margin: 3px 0; }");
        sb.AppendLine(".grand-total { font-size: 16px; font-weight: bold; border-top: 2px solid #000; padding-top: 5px; margin-top: 5px; }");
        sb.AppendLine(".footer { text-align: center; margin-top: 20px; font-size: 12px; }");
        sb.AppendLine("@media print { body { width: 80mm; } }");
        sb.AppendLine("</style>");
        sb.AppendLine("</head><body>");

        // Header
        sb.AppendLine("<div class='header'>");
        sb.AppendLine("<h1>SCONTRINO</h1>");
        sb.AppendLine($"<p>Sessione: #{session.Id.ToString("N")[..8]}</p>");
        sb.AppendLine($"<p>{DateTime.Now:dd/MM/yyyy HH:mm:ss}</p>");
        var operatorName = GetSelectedOperatorName();
        if (!string.IsNullOrEmpty(operatorName))
        {
            sb.AppendLine($"<p>Operatore: {operatorName}</p>");
        }
        sb.AppendLine("</div>");

        // Items
        foreach (var item in session.Items)
        {
            sb.AppendLine("<div class='item'>");
            sb.AppendLine($"<div class='item-name'>{item.ProductName}</div>");
            sb.AppendLine("<div class='item-details'>");
            sb.AppendLine($"<span>{item.Quantity} x {item.UnitPrice:C}");
            if (item.DiscountPercent > 0)
            {
                sb.AppendLine($" (-{item.DiscountPercent:F1}%)");
            }
            sb.AppendLine("</span>");
            sb.AppendLine($"<span>{item.TotalAmount:C}</span>");
            sb.AppendLine("</div>");
            sb.AppendLine("</div>");
        }

        // Totals
        sb.AppendLine("<div class='totals'>");
        var subtotal = session.Items.Sum(i => i.Quantity * i.UnitPrice);
        var discount = session.Items.Sum(i => i.Quantity * i.UnitPrice * i.DiscountPercent / 100);
        var tax = session.Items.Sum(i => i.TaxAmount);

        sb.AppendLine($"<div class='total-row'><span>Subtotale:</span><span>{subtotal:C}</span></div>");
        if (discount > 0)
        {
            sb.AppendLine($"<div class='total-row'><span>Sconto:</span><span>-{discount:C}</span></div>");
        }
        sb.AppendLine($"<div class='total-row'><span>IVA:</span><span>{tax:C}</span></div>");
        sb.AppendLine($"<div class='total-row grand-total'><span>TOTALE:</span><span>{session.FinalTotal:C}</span></div>");

        // Payments
        if (session.Payments?.Any() == true)
        {
            sb.AppendLine("<div style='margin-top: 10px;'>");
            var totalPaid = session.Payments.Where(p => p.Status == PaymentStatusDto.Completed).Sum(p => p.Amount);
            foreach (var payment in session.Payments.Where(p => p.Status == PaymentStatusDto.Completed))
            {
                sb.AppendLine($"<div class='total-row'><span>{payment.PaymentMethodName}:</span><span>{payment.Amount:C}</span></div>");
            }
            if (totalPaid > session.FinalTotal)
            {
                var change = totalPaid - session.FinalTotal;
                sb.AppendLine($"<div class='total-row' style='font-weight: bold;'><span>RESTO:</span><span>{change:C}</span></div>");
            }
            sb.AppendLine("</div>");
        }
        sb.AppendLine("</div>");

        // Footer
        sb.AppendLine("<div class='footer'>");
        sb.AppendLine("<p>Grazie per il vostro acquisto!</p>");
        sb.AppendLine("</div>");

        sb.AppendLine("<script>");
        sb.AppendLine("window.onload = function() { window.print(); };");
        sb.AppendLine("</script>");
        sb.AppendLine("</body></html>");

        return sb.ToString();
    }

    // Split and Merge Functionality
    private bool _canSplit = false;
    private List<SaleSessionDto> _openSessions = new();
    
    private async Task CheckCanSplitAsync()
    {
        if (ViewModel.CurrentSession != null)
        {
            _canSplit = await SalesService.CanSplitSessionAsync(ViewModel.CurrentSession.Id);
        }
        else
        {
            _canSplit = false;
        }
    }
    
    private async Task LoadOpenSessionsAsync()
    {
        var allSessions = await SalesService.GetActiveSessionsAsync();
        if (allSessions != null)
        {
            // Filter to only show parent sessions (not child sessions from splits)
            // Child sessions (with ParentSessionId) are sub-sessions from a split operation
            // and should not be merged with other sessions to maintain split integrity
            _openSessions = allSessions
                .Where(s => s.Status == SaleSessionStatusDto.Open && s.ParentSessionId == null)
                .ToList();
        }
    }
    
    private async Task OpenSplitDialogAsync()
    {
        if (ViewModel.CurrentSession == null) return;
        
        var parameters = new DialogParameters
        {
            { "Session", ViewModel.CurrentSession }
        };
        
        var options = new DialogOptions 
        { 
            MaxWidth = MaxWidth.Medium, 
            FullWidth = true,
            CloseButton = true
        };
        
        var dialog = DialogService.Show<SplitPaymentDialog>(
            TranslationService.GetTranslation("sales.split.title", "Dividi Conto"), 
            parameters, 
            options);
        var result = await dialog.Result;
        
        if (!result.Canceled)
        {
            // Refresh session
            await ViewModel.ReloadSessionAsync();
            await LoadOpenSessionsAsync();
            await CheckCanSplitAsync();
        }
    }
    
    private async Task OpenMergeDialogAsync()
    {
        var parameters = new DialogParameters
        {
            { "AvailableSessions", _openSessions }
        };
        
        var options = new DialogOptions 
        { 
            MaxWidth = MaxWidth.Medium, 
            FullWidth = true,
            CloseButton = true
        };
        
        var dialog = DialogService.Show<MergeSessionsDialog>(
            TranslationService.GetTranslation("sales.merge.title", "Unisci Sessioni"), 
            parameters, 
            options);
        var result = await dialog.Result;
        
        if (!result.Canceled)
        {
            // Refresh session
            await ViewModel.ReloadSessionAsync();
            await LoadOpenSessionsAsync();
            await CheckCanSplitAsync();
        }
    }

    // UI Helper Methods
    private string GetLoadingTooltipText()
    {
        return TranslationService.GetTranslation("sales.updatingItems", "Salvataggio in corso...");
    }

    private Color GetLoadingSpinnerColor()
    {
        return Color.Primary;
    }

    private string? GetSelectedOperatorName()
    {
        if (!ViewModel.SelectedOperatorId.HasValue || ViewModel.AvailableOperators == null || ViewModel.AvailableOperators.Count == 0)
            return null;
            
        var selectedOperator = ViewModel.AvailableOperators.FirstOrDefault(op => op.Id == ViewModel.SelectedOperatorId.Value);
        return selectedOperator?.Name;
    }

    // Keyboard shortcuts
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JSRuntime.InvokeVoidAsync("setupPOSKeyboardShortcuts", DotNetObjectReference.Create(this));
        }
    }

    [JSInvokable]
    public async Task HandleKeyboardShortcut(string key)
    {
        if (!ViewModel.HasActiveSession && key != "Escape")
            return;

        switch (key)
        {
            case "F2": // Payment
                if (ViewModel.CanPay)
                    await AddPaymentAsync();
                break;
                
            case "F3": // Park
                if (ViewModel.HasActiveSession)
                    await ParkSessionAsync();
                break;
                
            case "F4": // Remove last item
                if (ViewModel.CurrentSession?.Items.LastOrDefault() is { } lastItem)
                    await RemoveItemAsync(lastItem);
                break;
                
            case "F8": // Focus on barcode scanner (handled in JS)
                break;
                
            case "F12": // Close sale
                if (ViewModel.CanCloseSale)
                    await CloseSaleAsync();
                break;
                
            case "Escape": // Cancel session
                if (ViewModel.HasActiveSession)
                    await CancelSessionAsync();
                break;
        }
    }

    // Dispose pattern
    public void Dispose()
    {
        ViewModel.StateChanged -= StateHasChanged;
        ViewModel.OnNotification -= HandleNotification;
        ViewModel.Dispose();
    }
}
