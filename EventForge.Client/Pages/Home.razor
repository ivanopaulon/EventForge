@* EventForge Home Page - Landing page for the application
   Route: "/" - Root route serves as the main landing page 
   Authentication: [AllowAnonymous] - Accessible without authentication
   Purpose: Shows system health status from backend HealthService
   Fallback: Visual error handling if health service call fails
   
   NOTE: I18N REMOVED - This page no longer uses TranslationService to avoid 
   rendering issues. All text is now hardcoded in English. *@

@page "/"
@using Microsoft.AspNetCore.Authorization
@attribute [AllowAnonymous]
@inject IHealthService HealthService
@inject NavigationManager NavigationManager

<PageTitle>EventForge - Home</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-8">
    <MudPaper Class="pa-8" Elevation="4">
        <!-- Updated header with trace.svg logo for consistent branding -->
        <div class="d-flex justify-center align-center mb-8">
            <img src="trace.svg" alt="EventForge Logo" style="height: 48px; width: 48px; margin-right: 16px;" />
            <MudText Typo="Typo.h4" Align="Align.Center">
                EventForge - Home
            </MudText>
        </div>

        <MudText Typo="Typo.h5" Class="mb-4">
            <MudIcon Icon="Icons.Material.Filled.HealthAndSafety" Class="mr-2" />
            System Health Check
        </MudText>

        <!-- DEBUG: Static content to verify rendering -->
        <MudAlert Severity="Severity.Info" Class="mb-4">
            <MudText><strong>âœ… Home page is rendering!</strong></MudText>
            <MudText>This minimal home page has been successfully created without i18n dependencies.</MudText>
        </MudAlert>

        @if (_isLoading)
        {
            <MudCard Class="mb-4">
                <MudCardContent>
                    <div class="d-flex align-center justify-center pa-8">
                        <MudProgressCircular Color="Color.Primary" Indeterminate="true" Class="mr-4" />
                        <MudText>Loading...</MudText>
                    </div>
                </MudCardContent>
            </MudCard>
        }
        else if (_healthStatus != null)
        {
            <MudCard Class="mb-4">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">
                            Health Status
                        </MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    <MudExpansionPanels>
                        <MudExpansionPanel Text="Version JSON">
                            <pre style="white-space: pre-wrap; overflow-x: auto;">@_healthJson</pre>
                        </MudExpansionPanel>
                        <MudExpansionPanel Text="System Overview" IsInitiallyExpanded="true">
                            <MudSimpleTable Style="overflow-x: auto;">
                                <tbody>
                                    <tr>
                                        <td><strong>API Status:</strong></td>
                                        <td>
                                            <MudChip T="string" Color="@GetStatusColor(_healthStatus.ApiStatus)" Size="Size.Small">
                                                @_healthStatus.ApiStatus
                                            </MudChip>
                                        </td>
                                    </tr>
                                    @if (!string.IsNullOrEmpty(_healthStatus.DatabaseStatus))
                                    {
                                        <tr>
                                            <td><strong>Database:</strong></td>
                                            <td>
                                                <MudChip T="string" Color="@GetStatusColor(_healthStatus.DatabaseStatus)" Size="Size.Small">
                                                    @_healthStatus.DatabaseStatus
                                                </MudChip>
                                            </td>
                                        </tr>
                                    }
                                    @if (!string.IsNullOrEmpty(_healthStatus.Version))
                                    {
                                        <tr>
                                            <td><strong>Version:</strong></td>
                                            <td>@_healthStatus.Version</td>
                                        </tr>
                                    }
                                    @if (!string.IsNullOrEmpty(_healthStatus.AuthenticationStatus))
                                    {
                                        <tr>
                                            <td><strong>Authentication:</strong></td>
                                            <td>
                                                <MudChip T="string" Color="@GetStatusColor(_healthStatus.AuthenticationStatus)" Size="Size.Small">
                                                    @_healthStatus.AuthenticationStatus
                                                </MudChip>
                                            </td>
                                        </tr>
                                    }
                                    <tr>
                                        <td><strong>Last Check:</strong></td>
                                        <td>@_healthStatus.Timestamp.ToString("yyyy-MM-dd HH:mm:ss") UTC</td>
                                    </tr>
                                </tbody>
                            </MudSimpleTable>
                        </MudExpansionPanel>
                    </MudExpansionPanels>
                </MudCardContent>
            </MudCard>
        }
        else if (!string.IsNullOrEmpty(_errorMessage))
        {
            <MudAlert Severity="Severity.Error" Icon="@Icons.Material.Filled.Error" Class="mb-4">
                <MudText><strong>Error loading health status:</strong></MudText>
                <MudText>@_errorMessage</MudText>
            </MudAlert>
        }
        else
        {
            <MudAlert Severity="Severity.Info" Icon="@Icons.Material.Filled.Info" Class="mb-4">
                <MudText>No health data available</MudText>
            </MudAlert>
        }

        <MudDivider Class="my-6" />

        <MudGrid Justify="Justify.Center">
            <MudItem>
                <MudButton Variant="Variant.Filled" 
                           Color="Color.Primary" 
                           StartIcon="Icons.Material.Filled.Login"
                           OnClick="@(() => NavigationManager.NavigateTo("/login"))">
                    Go to Login
                </MudButton>
            </MudItem>
        </MudGrid>
    </MudPaper>
</MudContainer>

@code {
    // NOTE: I18N REMOVED - TranslationService dependency removed to create minimal home
    // All text content is now hardcoded in English to avoid rendering issues
    private bool _isLoading = false; // Changed to false to show content immediately
    private HealthStatusDto? _healthStatus;
    private string? _errorMessage;
    private string _healthJson = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        // Debug log to verify component is executing
        Console.WriteLine("[Home] OnInitializedAsync called");
        
        // Load health status in background
        _ = Task.Run(async () => await LoadHealthStatus());
    }

    private async Task LoadHealthStatus()
    {
        Console.WriteLine("[Home] LoadHealthStatus started");
        _isLoading = true;
        StateHasChanged(); // Trigger re-render to show loading state
        
        try
        {
            // Set a shorter timeout for the health check to avoid hanging
            using var cts = new CancellationTokenSource(TimeSpan.FromSeconds(5));
            _healthStatus = await HealthService.GetHealthAsync();
            
            if (_healthStatus != null)
            {
                // Pretty print JSON
                _healthJson = System.Text.Json.JsonSerializer.Serialize(_healthStatus, new System.Text.Json.JsonSerializerOptions 
                { 
                    WriteIndented = true 
                });
                Console.WriteLine("[Home] Health status loaded successfully");
            }
            else
            {
                _errorMessage = "Unable to connect to server or retrieve health status.";
                Console.WriteLine("[Home] Health status is null");
            }
        }
        catch (TaskCanceledException)
        {
            _errorMessage = "Health check request timed out (5 seconds). Server may be unavailable.";
            Console.WriteLine("[Home] Health check timed out");
        }
        catch (HttpRequestException ex)
        {
            _errorMessage = $"Network error: {ex.Message}";
            Console.WriteLine($"[Home] Network error: {ex.Message}");
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error: {ex.Message}";
            Console.WriteLine($"[Home] Error: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
            StateHasChanged(); // Trigger re-render when done
            Console.WriteLine("[Home] LoadHealthStatus completed");
        }
    }

    private Color GetStatusColor(string? status) => status?.ToLower() switch
    {
        "healthy" => Color.Success,
        "degraded" => Color.Warning,
        "unhealthy" or "error" => Color.Error,
        _ => Color.Default
    };
}