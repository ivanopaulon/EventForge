@using EventForge.DTOs.Notifications
@using EventForge.DTOs.Chat
@using EventForge.Client.Services
@inject IAuthService AuthService
@inject INotificationService NotificationService
@inject IChatService ChatService
@inject IRealtimeService RealtimeService
@inject ITranslationService TranslationService
@inject IHelpService HelpService
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@implements IDisposable

<MudNavMenu>
    @if (_isAuthenticated)
    {
        @if (_isSuperAdmin)
        {
            <MudNavGroup title="@TranslationService.GetTranslation("nav.superAdmin", "Super Amministrazione")" 
                         Icon="@Icons.Material.Outlined.AdminPanelSettings" 
                         Expanded="true">
                <MudNavLink Href="/superadmin/tenant-management" 
                            Icon="@Icons.Material.Outlined.Business" 
                            Match="NavLinkMatch.All">
                    @TranslationService.GetTranslation("nav.tenantManagement", "Gestione Tenant")
                </MudNavLink>
                <MudNavLink Href="/superadmin/user-management" 
                            Icon="@Icons.Material.Outlined.People" 
                            Match="NavLinkMatch.All">
                    @TranslationService.GetTranslation("nav.userManagement", "Gestione Utenti")
                </MudNavLink>
                <MudNavLink Href="/superadmin/license-management" 
                            Icon="@Icons.Material.Outlined.Security" 
                            Match="NavLinkMatch.All">
                    @TranslationService.GetTranslation("nav.licenseManagement", "Gestione Licenze")
                </MudNavLink>
                <MudNavLink Href="/superadmin/role-permission-management" 
                            Icon="@Icons.Material.Outlined.Shield" 
                            Match="NavLinkMatch.All">
                    @TranslationService.GetTranslation("nav.rolePermissionManagement", "Gestione Ruoli e Permessi")
                </MudNavLink>
                <MudNavLink Href="/superadmin/feature-templates" 
                            Icon="@Icons.Material.Outlined.FeaturedPlayList" 
                            Match="NavLinkMatch.All">
                    @TranslationService.GetTranslation("nav.featureTemplates", "Feature Templates")
                </MudNavLink>
                <MudNavLink Href="/superadmin/configuration" 
                            Icon="@Icons.Material.Outlined.Settings" 
                            Match="NavLinkMatch.All">
                    @TranslationService.GetTranslation("nav.configuration", "Configurazione")
                </MudNavLink>
            </MudNavGroup>
        }
        @if (_isSuperAdmin || _isAdmin || _isManager)
        {
            <!-- Dashboard Admin -->
            <MudNavLink Href="/admin" 
                        Icon="@Icons.Material.Outlined.Dashboard" 
                        Match="NavLinkMatch.All">
                @TranslationService.GetTranslation("nav.adminDashboard", "Dashboard Admin")
            </MudNavLink>

            <!-- Catalogo (Product Management) -->
            <MudNavGroup title="@TranslationService.GetTranslation("nav.catalog", "Catalogo")" 
                         Icon="@Icons.Material.Outlined.Inventory" 
                         Expanded="false">
                <MudNavLink Href="/product-management/products"
                            Icon="@Icons.Material.Outlined.Inventory2" 
                            Match="NavLinkMatch.All">
                    @TranslationService.GetTranslation("nav.products", "Prodotti")
                </MudNavLink>
                <MudNavLink Href="/product-management/brands"
                            Icon="@Icons.Material.Outlined.Sell" 
                            Match="NavLinkMatch.All">
                    @TranslationService.GetTranslation("nav.brandManagement", "Gestione Marchi")
                </MudNavLink>
                <MudNavLink Href="/settings/unit-of-measures"
                            Icon="@Icons.Material.Outlined.Straighten" 
                            Match="NavLinkMatch.All">
                    @TranslationService.GetTranslation("nav.unitOfMeasureManagement", "Gestione Unità di Misura")
                </MudNavLink>
                <MudNavLink Href="/management/classification-nodes"
                            Icon="@Icons.Material.Outlined.AccountTree" 
                            Match="NavLinkMatch.All">
                    @TranslationService.GetTranslation("nav.classificationNodeManagement", "Gestione Classificazione")
                </MudNavLink>
            </MudNavGroup>

            <!-- Warehouse Management Group -->
            @if (_canManageWarehouse)
            {
                <MudNavGroup title="@TranslationService.GetTranslation("nav.warehouseManagement", "Magazzino")" 
                             Icon="@Icons.Material.Outlined.Warehouse" 
                             Expanded="false">
                    <MudNavLink Href="/warehouse/facilities" 
                                Icon="@Icons.Material.Outlined.Warehouse" 
                                Match="NavLinkMatch.All">
                        @TranslationService.GetTranslation("nav.facilities", "Magazzini")
                    </MudNavLink>
                    <MudNavLink Href="/warehouse/lot-management" 
                                Icon="@Icons.Material.Outlined.QrCode" 
                                Match="NavLinkMatch.All">
                        @TranslationService.GetTranslation("nav.lotManagement", "Gestione Lotti")
                    </MudNavLink>
                    <MudNavLink Href="/warehouse/inventory-procedure" 
                                Icon="@Icons.Material.Outlined.Inventory" 
                                Match="NavLinkMatch.All">
                        @TranslationService.GetTranslation("nav.inventoryProcedure", "Inventari")
                    </MudNavLink>
                    <MudNavLink Href="/warehouse/transfers" 
                                Icon="@Icons.Material.Outlined.CompareArrows" 
                                Match="NavLinkMatch.All">
                        @TranslationService.GetTranslation("nav.transferOrders", "Trasferimenti")
                    </MudNavLink>
                </MudNavGroup>
            }

            <!-- Document Management Group -->
            @if (_canManageWarehouse || _isAdmin || _isSuperAdmin)
            {
                <MudNavGroup title="@TranslationService.GetTranslation("nav.documentManagement", "Documenti")" 
                             Icon="@Icons.Material.Outlined.Description" 
                             Expanded="false">
                    <MudNavLink Href="/documents/list" 
                                Icon="@Icons.Material.Outlined.ListAlt" 
                                Match="NavLinkMatch.All">
                        @TranslationService.GetTranslation("nav.documentList", "Elenco Documenti")
                    </MudNavLink>
                    <MudNavLink Href="/documents/create" 
                                Icon="@Icons.Material.Outlined.Add" 
                                Match="NavLinkMatch.All">
                        @TranslationService.GetTranslation("nav.createDocument", "Nuovo Documento")
                    </MudNavLink>
                    <MudNavLink Href="/documents/types" 
                                Icon="@Icons.Material.Outlined.Category" 
                                Match="NavLinkMatch.All">
                        @TranslationService.GetTranslation("nav.documentTypes", "Tipi Documento")
                    </MudNavLink>
                    <MudNavLink Href="/documents/counters" 
                                Icon="@Icons.Material.Outlined.Pin" 
                                Match="NavLinkMatch.All">
                        @TranslationService.GetTranslation("nav.documentCounters", "Contatori")
                    </MudNavLink>
                </MudNavGroup>
            }

            <!-- Business Partners Group -->
            <MudNavGroup title="@TranslationService.GetTranslation("nav.businessPartners", "Partner Commerciali")" 
                         Icon="@Icons.Material.Outlined.Handshake" 
                         Expanded="false">
                <MudNavLink Href="/business/suppliers"
                            Icon="@Icons.Material.Outlined.Business" 
                            Match="NavLinkMatch.All">
                    @TranslationService.GetTranslation("nav.supplierManagement", "Fornitori")
                </MudNavLink>
                <MudNavLink Href="/business/customers"
                            Icon="@Icons.Material.Outlined.People" 
                            Match="NavLinkMatch.All">
                    @TranslationService.GetTranslation("nav.customerManagement", "Clienti")
                </MudNavLink>
            </MudNavGroup>

            <!-- Financial Management Group -->
            <MudNavGroup title="@TranslationService.GetTranslation("nav.financialManagement", "Contabilità")" 
                         Icon="@Icons.Material.Outlined.AccountBalance" 
                         Expanded="false">
                <MudNavLink Href="/financial/vat-rates" 
                            Icon="@Icons.Material.Outlined.Percent" 
                            Match="NavLinkMatch.All">
                    @TranslationService.GetTranslation("nav.vatRateManagement", "Aliquote IVA")
                </MudNavLink>
                <MudNavLink Href="/financial/vat-natures" 
                            Icon="@Icons.Material.Outlined.Category" 
                            Match="NavLinkMatch.All">
                    @TranslationService.GetTranslation("nav.vatNatureManagement", "Nature IVA")
                </MudNavLink>
            </MudNavGroup>

            <!-- Direct POS Link -->
            <MudNavLink Href="/sales/pos" 
                        Icon="@Icons.Material.Outlined.PointOfSale" 
                        Match="NavLinkMatch.All">
                @TranslationService.GetTranslation("nav.pos", "Punto Vendita (POS)")
            </MudNavLink>

            <!-- Store Settings -->
            <MudNavGroup title="@TranslationService.GetTranslation("nav.storeSettings", "Configurazione Store")" 
                         Icon="@Icons.Material.Outlined.Settings" 
                         Expanded="false">
                <MudNavLink Href="/store/payment-methods" 
                            Icon="@Icons.Material.Outlined.Payment" 
                            Match="NavLinkMatch.All">
                    @TranslationService.GetTranslation("nav.paymentMethods", "Metodi di Pagamento")
                </MudNavLink>
                <MudNavLink Href="/store/pos" 
                            Icon="@Icons.Material.Outlined.PointOfSale" 
                            Match="NavLinkMatch.All">
                    @TranslationService.GetTranslation("nav.posManagement", "Punti Cassa (Terminali)")
                </MudNavLink>
                <MudNavLink Href="/store/operators" 
                            Icon="@Icons.Material.Outlined.Person" 
                            Match="NavLinkMatch.All">
                    @TranslationService.GetTranslation("nav.operatorManagement", "Operatori")
                </MudNavLink>
                <MudNavLink Href="/store/operator-groups" 
                            Icon="@Icons.Material.Outlined.Groups" 
                            Match="NavLinkMatch.All">
                    @TranslationService.GetTranslation("nav.operatorGroupManagement", "Gruppi Operatori")
                </MudNavLink>
            </MudNavGroup>
        }
        
        <!-- Common user links -->
        <MudNavLink Href="/profile" Icon="@Icons.Material.Outlined.Person" Match="NavLinkMatch.All">
            @TranslationService.GetTranslation("nav.profile", "Profilo")
        </MudNavLink>
    }
    else
    {
        <MudNavLink Href="/login" Icon="@Icons.Material.Outlined.Login" Match="NavLinkMatch.All">
            @TranslationService.GetTranslation("nav.login", "Accedi")
        </MudNavLink>
    }
</MudNavMenu>

@code {
    private bool _isAuthenticated = false;
    private bool _isAdmin = false;
    private bool _isSuperAdmin = false;
    private bool _isManager = false;
    private bool _canManageWarehouse = false;
    private int _unreadNotificationCount = 0;
    private int _unreadMessageCount = 0;

    protected override async Task OnInitializedAsync()
    {
        AuthService.OnAuthenticationStateChanged += OnAuthenticationStateChanged;
        TranslationService.LanguageChanged += OnLanguageChanged;
        
        // Subscribe to real-time updates
        NotificationService.NotificationReceived += OnNotificationReceived;
        NotificationService.NotificationRead += OnNotificationRead;
        ChatService.MessageReceived += OnMessageReceived;
        ChatService.MessageRead += OnMessageRead;
        
        await CheckAuthenticationState();
    }

    private async Task CheckAuthenticationState()
    {
        _isAuthenticated = await AuthService.IsAuthenticatedAsync();
        if (_isAuthenticated)
        {
            // Check for all role types
            _isSuperAdmin = await AuthService.IsSuperAdminAsync();
            _isAdmin = await AuthService.IsInRoleAsync("Admin");
            _isManager = await AuthService.IsInRoleAsync("Manager");
            
            _canManageWarehouse = _isSuperAdmin || _isAdmin || _isManager;
            
            // Load notification and message counts
            await LoadCommunicationCountsAsync();
        }
        else
        {
            _isAdmin = false;
            _isSuperAdmin = false;
            _isManager = false;
            _canManageWarehouse = false;
            _unreadNotificationCount = 0;
            _unreadMessageCount = 0;
        }
        StateHasChanged();
    }

    private async void OnAuthenticationStateChanged()
    {
        await CheckAuthenticationState();
    }

    private void OnLanguageChanged(object? sender, string newLanguage)
    {
        // Refresh the component when language changes to update navigation labels
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        AuthService.OnAuthenticationStateChanged -= OnAuthenticationStateChanged;
        TranslationService.LanguageChanged -= OnLanguageChanged;
        
        // Unsubscribe from real-time updates
        NotificationService.NotificationReceived -= OnNotificationReceived;
        NotificationService.NotificationRead -= OnNotificationRead;
        ChatService.MessageReceived -= OnMessageReceived;
        ChatService.MessageRead -= OnMessageRead;
    }

    /// <summary>
    /// Load unread notification and message counts for navigation badges
    /// </summary>
    private async Task LoadCommunicationCountsAsync()
    {
        try
        {
            // Start real-time connections if not already started
            if (!RealtimeService.IsNotificationConnected)
            {
                await RealtimeService.StartNotificationConnectionAsync();
            }
            if (!RealtimeService.IsChatConnected)
            {
                await RealtimeService.StartChatConnectionAsync();
            }

            // Get notification stats to calculate unread count
            var notificationStats = await NotificationService.GetNotificationStatsAsync();
            _unreadNotificationCount = notificationStats.UnreadCount;

            // Get chat stats to calculate unread messages
            // Note: ChatStatsDto doesn't have unread count, so we'll rely on real-time updates for now
            var chatStats = await ChatService.GetChatStatsAsync();
            // _unreadMessageCount will be updated via real-time events
            
            StateHasChanged();
        }
        catch (Exception ex)
        {
            // Log error but don't show to user as this is background loading
            Console.WriteLine($"[NavMenu] Error loading communication counts: {ex.Message}");
            _unreadNotificationCount = 0;
            _unreadMessageCount = 0;
        }
    }

    #region Real-time Event Handlers

    private void OnNotificationReceived(NotificationResponseDto notification)
    {
        _unreadNotificationCount++;
        InvokeAsync(StateHasChanged);
    }

    private void OnNotificationRead(Guid notificationId)
    {
        _unreadNotificationCount = Math.Max(0, _unreadNotificationCount - 1);
        InvokeAsync(StateHasChanged);
    }

    private void OnMessageReceived(ChatMessageDto message)
    {
        _unreadMessageCount++;
        InvokeAsync(StateHasChanged);
    }

    private void OnMessageRead(Guid chatId, Guid messageId)
    {
        _unreadMessageCount = Math.Max(0, _unreadMessageCount - 1);
        InvokeAsync(StateHasChanged);
    }

    #endregion

    #region Help System Methods

    /// <summary>
    /// Shows general help dialog.
    /// </summary>
    private async Task ShowGeneralHelp()
    {
        try
        {
            var options = new DialogOptions 
            { 
                MaxWidth = MaxWidth.Medium, 
                FullWidth = true,
                CloseOnEscapeKey = true
            };

            var parameters = new DialogParameters
            {
                ["Title"] = TranslationService.GetTranslation("help.generalHelpTitle", "EventForge Help Center"),
                ["Content"] = TranslationService.GetTranslation("help.generalHelpContent", "Welcome to EventForge Help! Use this application to manage events, notifications, chat, and more. Each section has its own help system with detailed tutorials and walkthroughs.")
            };

            await DialogService.ShowAsync<MudMessageBox>(TranslationService.GetTranslation("help.helpCenter", "Help Center"), parameters, options);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error showing help: {ex.Message}", Severity.Warning);
        }
    }

    /// <summary>
    /// Shows interactive tour selector.
    /// </summary>
    private async Task ShowInteractiveTour()
    {
        try
        {
            var options = new DialogOptions 
            { 
                MaxWidth = MaxWidth.Medium, 
                FullWidth = true,
                CloseOnEscapeKey = true
            };

            var tourOptions = new List<string>
            {
                TranslationService.GetTranslation("tour.notifications", "Notifications Tour"),
                TranslationService.GetTranslation("tour.chat", "Chat Tour"),
                TranslationService.GetTranslation("tour.superadmin", "SuperAdmin Tour")
            };

            // For now, show a simple message. This could be expanded to a custom component
            var message = TranslationService.GetTranslation("tour.selectMessage", "Visit the specific sections (Notifications, Chat, SuperAdmin) and click 'Take a Tour' to start an interactive walkthrough of that feature.");
            
            await DialogService.ShowMessageBox(
                TranslationService.GetTranslation("nav.interactiveTour", "Interactive Tour"),
                message,
                TranslationService.GetTranslation("common.ok", "OK"),
                options: options
            );
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error showing tour options: {ex.Message}", Severity.Warning);
        }
    }

    /// <summary>
    /// Shows onboarding options.
    /// </summary>
    private async Task ShowOnboarding()
    {
        try
        {
            var options = new DialogOptions 
            { 
                MaxWidth = MaxWidth.Medium, 
                FullWidth = true,
                CloseOnEscapeKey = true
            };

            var message = TranslationService.GetTranslation("onboarding.centerMessage", "Tutorial Center: Access step-by-step guides for each feature. You can reset your progress and replay tutorials at any time. Visit Notifications, Chat, or SuperAdmin sections and click 'Quick Start' to begin.");
            
            await DialogService.ShowMessageBox(
                TranslationService.GetTranslation("nav.tutorialCenter", "Tutorial Center"),
                message,
                TranslationService.GetTranslation("common.ok", "OK"),
                options: options
            );
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error showing tutorial center: {ex.Message}", Severity.Warning);
        }
    }

    #endregion
}
