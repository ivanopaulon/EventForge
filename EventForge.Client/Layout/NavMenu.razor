@inject IAuthService AuthService
@inject ITranslationService TranslationService
@implements IDisposable

<MudNavMenu>
    @if (_isAuthenticated)
    {
        @if (_isSuperAdmin)
        {
            <MudNavGroup title="@TranslationService.GetTranslation("nav.superAdmin", "Super Amministrazione")" 
                         Icon="Icons.Material.Filled.AdminPanelSettings" 
                         Expanded="true">
                <MudNavLink Href="/superadmin/tenant-management" 
                            Icon="Icons.Material.Filled.Business" 
                            Match="NavLinkMatch.All">
                    @TranslationService.GetTranslation("nav.tenantManagement", "Gestione Tenant")
                </MudNavLink>
                <MudNavLink Href="/superadmin/user-management" 
                            Icon="Icons.Material.Filled.People" 
                            Match="NavLinkMatch.All">
                    @TranslationService.GetTranslation("nav.userManagement", "Gestione Utenti")
                </MudNavLink>
                <MudNavLink Href="/superadmin/event-management" 
                            Icon="Icons.Material.Filled.Event" 
                            Match="NavLinkMatch.All">
                    @TranslationService.GetTranslation("nav.eventManagement", "Gestione Eventi")
                </MudNavLink>
                <MudNavLink Href="/superadmin/event-category-management" 
                            Icon="Icons.Material.Filled.BookmarkBorder" 
                            Match="NavLinkMatch.All">
                    @TranslationService.GetTranslation("nav.eventCategoryManagement", "Gestione Categorie")
                </MudNavLink>
                <MudNavLink Href="/superadmin/event-type-management" 
                            Icon="Icons.Material.Filled.Category" 
                            Match="NavLinkMatch.All">
                    @TranslationService.GetTranslation("nav.eventTypeManagement", "Gestione Tipi Evento")
                </MudNavLink>
                <MudNavLink Href="/superadmin/tenant-switch" 
                            Icon="Icons.Material.Filled.SwapHoriz" 
                            Match="NavLinkMatch.All">
                    @TranslationService.GetTranslation("nav.tenantSwitch", "Switch Tenant")
                </MudNavLink>
                <MudNavLink Href="/superadmin/system-logs" 
                            Icon="Icons.Material.Filled.Article" 
                            Match="NavLinkMatch.All">
                    @TranslationService.GetTranslation("nav.systemLogs", "Log Sistema")
                </MudNavLink>
                <MudNavLink Href="/superadmin/client-log-management" 
                            Icon="Icons.Material.Filled.BugReport" 
                            Match="NavLinkMatch.All">
                    @TranslationService.GetTranslation("nav.clientLogManagement", "Log Client")
                </MudNavLink>
                <MudNavLink Href="/superadmin/audit-trail" 
                            Icon="Icons.Material.Filled.History" 
                            Match="NavLinkMatch.All">
                    @TranslationService.GetTranslation("nav.auditTrail", "Audit Trail")
                </MudNavLink>
                <MudNavLink Href="/superadmin/configuration" 
                            Icon="Icons.Material.Filled.Settings" 
                            Match="NavLinkMatch.All">
                    @TranslationService.GetTranslation("nav.configuration", "Configurazione")
                </MudNavLink>
                <MudNavLink Href="/superadmin/translation-management" 
                            Icon="Icons.Material.Filled.Translate" 
                            Match="NavLinkMatch.All">
                    @TranslationService.GetTranslation("nav.translationManagement", "Gestione Traduzioni")
                </MudNavLink>
            </MudNavGroup>
        }
        @if (_isAdmin)
        {
            <MudNavGroup title="@TranslationService.GetTranslation("nav.administration", "Amministrazione")" 
                         Icon="Icons.Material.Filled.Dashboard" 
                         Expanded="true">
                <MudNavLink Href="/admin" 
                            Icon="Icons.Material.Filled.Dashboard" 
                            Match="NavLinkMatch.All">
                    @TranslationService.GetTranslation("nav.adminDashboard", "Dashboard Admin")
                </MudNavLink>
                <!-- Add more admin links here as needed -->
            </MudNavGroup>
        }
        
        <!-- Common user links -->
        <MudNavLink Href="/profile" Icon="Icons.Material.Filled.Person" Match="NavLinkMatch.All">
            @TranslationService.GetTranslation("nav.profile", "Profilo")
        </MudNavLink>
    }
    else
    {
        <MudNavLink Href="/login" Icon="Icons.Material.Filled.Login" Match="NavLinkMatch.All">
            @TranslationService.GetTranslation("nav.login", "Accedi")
        </MudNavLink>
    }
</MudNavMenu>

@code {
    private bool _isAuthenticated = false;
    private bool _isAdmin = false;
    private bool _isSuperAdmin = false;

    protected override async Task OnInitializedAsync()
    {
        AuthService.OnAuthenticationStateChanged += OnAuthenticationStateChanged;
        TranslationService.LanguageChanged += OnLanguageChanged;
        await CheckAuthenticationState();
    }

    private async Task CheckAuthenticationState()
    {
        _isAuthenticated = await AuthService.IsAuthenticatedAsync();
        if (_isAuthenticated)
        {
            // Check for multiple roles - user can have both Admin and SuperAdmin
            _isAdmin = await AuthService.IsAdminOrSuperAdminAsync(); // Changed to include SuperAdmin
            _isSuperAdmin = await AuthService.IsSuperAdminAsync();
        }
        else
        {
            _isAdmin = false;
            _isSuperAdmin = false;
        }
        StateHasChanged();
    }

    private async void OnAuthenticationStateChanged()
    {
        await CheckAuthenticationState();
    }

    private void OnLanguageChanged(object? sender, string newLanguage)
    {
        // Refresh the component when language changes to update navigation labels
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        AuthService.OnAuthenticationStateChanged -= OnAuthenticationStateChanged;
        TranslationService.LanguageChanged -= OnLanguageChanged;
    }
}
