@namespace EventForge.Client.Layout
@inherits LayoutComponentBase
@using EventForge.Client.Constants
@inject IAuthService AuthService
@inject ISessionKeepaliveService SessionKeepaliveService
@inject IThemeService ThemeService
@inject IFontPreferencesService FontPreferencesService
@inject NavigationManager NavigationManager
@inject IAuthenticationDialogService AuthenticationDialogService
@inject ISnackbar Snackbar
@inject ITranslationService TranslationService
@inject ILogger<MainLayout> Logger
@inject IDialogService DialogService
@implements IDisposable

<MudThemeProvider @ref="_mudThemeProvider" Theme="_currentTheme" />

<MudLayout>
    <!-- Improved AppBar with accessibility enhancements and dynamic title -->
    <MudAppBar Elevation="1" role="banner" Class="ef-appbar">
        <MudTooltip Text="@TranslationService.GetTranslation("button.delete", "Elimina")">
            <MudIconButton Icon="@Icons.Material.Outlined.Menu"
                           Edge="Edge.Start"
                           OnClick="@(() => _drawerOpen = !_drawerOpen)"
                           aria-label="@TranslationService.GetTranslation("navigation.openMenu", "Open navigation menu")"
                           aria-expanded="@_drawerOpen"
                           aria-controls="navigation-drawer"
                           Class="ef-menu-button">
            </MudIconButton>
        </MudTooltip>
        <MudTooltip Text="EventForge - Torna alla Home">
            <MudIconButton Color="Color.Inherit"
                          OnClick="@(() => NavigationManager.NavigateTo("/"))"
                          Size="Size.Large"
                          Class="pa-0"
                          aria-label="EventForge - Torna alla Home"
                          Style="width: auto; height: auto;">
                <MudImage Src="/eventforgetitle.svg" 
                          Alt="EventForge Logo"
                          Height="40"
                          Class="mx-2">
                </MudImage>
            </MudIconButton>
        </MudTooltip>
        <MudSpacer />
        
        @if (_isAuthenticated)
        {
            <!-- Font Preferences Button con migliore spaziatura -->
            <MudTooltip Text="@TranslationService.GetTranslation("fontPreferences.title", "Preferenze Font")">
                <MudIconButton Icon="@Icons.Material.Filled.FontDownload"
                               Color="Color.Inherit"
                               OnClick="OpenFontPreferences"
                               Size="Size.Medium"
                               Class="me-4"
                               aria-label="@TranslationService.GetTranslation("fontPreferences.title", "Preferenze Font")" />
            </MudTooltip>
            <UserAccountMenu OnLogout="@HandleLogout" />
        }
        else
        {
            <!-- Login button for unauthenticated users -->
            <MudButton Variant="Variant.Text" 
                       Color="Color.Inherit" 
                       StartIcon="Icons.Material.Filled.Login"
                       OnClick="@ShowLoginDialogAsync"
                       aria-label="@TranslationService.GetTranslation("auth.loginDescription", "Login to system")">
                @TranslationService.GetTranslation("auth.login", "Login")
            </MudButton>
        }
    </MudAppBar>
    
    @if (_isAuthenticated)
    {
        <!-- Navigation drawer with accessibility improvements -->
        <MudDrawer @bind-Open="@_drawerOpen" 
                   ClipMode="DrawerClipMode.Docked"
                   Elevation="1"
                   Variant="@DrawerVariant.Responsive"
                   Width="280px"
                   id="navigation-drawer"
                   Class="ef-drawer"
                   aria-label="@TranslationService.GetTranslation("navigation.mainMenu", "Main navigation menu")">
            <NavMenu />
        </MudDrawer>
    }
    
    <!-- Main content area with proper semantic structure -->
    <MudMainContent Class="mt-16 pa-2 pa-sm-4 main-content-with-footer" role="main">
        @Body
    </MudMainContent>
</MudLayout>

<!-- Health Footer - centralized for all layouts -->
<HealthFooter />

<!-- Global Loading Dialog - centralized modal loading component -->
<GlobalLoadingDialog />

@code {
    private bool _drawerOpen = true;
    private bool _isAuthenticated = false;
    private MudThemeProvider? _mudThemeProvider;
    private MudTheme _currentTheme = new();
    private readonly SemaphoreSlim _authStateLock = new(1, 1);

    protected override async Task OnInitializedAsync()
    {
        AuthService.OnAuthenticationStateChanged += OnAuthenticationStateChanged;
        ThemeService.OnThemeChanged += OnThemeChanged;
        FontPreferencesService.OnPreferencesChanged += OnFontPreferencesChanged;
        TranslationService.LanguageChanged += OnLanguageChanged;
        NavigationManager.LocationChanged += OnLocationChanged;
        
        // Subscribe to session keepalive events
        SessionKeepaliveService.OnRefreshSuccess += OnSessionRefreshSuccess;
        SessionKeepaliveService.OnRefreshFailure += OnSessionRefreshFailure;
        SessionKeepaliveService.OnSessionWarning += OnSessionWarning; // NUOVO
        
        await ThemeService.InitializeAsync();
        await FontPreferencesService.InitializeAsync();
        await CheckAuthenticationState();
        
        UpdateTheme();
    }

    private void OnThemeChanged()
    {
        UpdateTheme();
        InvokeAsync(StateHasChanged);
    }

    private void OnFontPreferencesChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    private async Task OpenFontPreferences()
    {
        var options = new DialogOptions 
        { 
            CloseOnEscapeKey = true, 
            MaxWidth = MaxWidth.Small, 
            FullWidth = true 
        };
        
        await DialogService.ShowAsync<EventForge.Client.Shared.Components.Dialogs.FontPreferencesDialog>(
            TranslationService.GetTranslation("fontPreferences.title", "Preferenze Font"),
            options);
    }

    private void OnLanguageChanged(object? sender, string newLanguage)
    {
        InvokeAsync(StateHasChanged);
    }

    private void UpdateTheme()
    {
        _currentTheme = new MudTheme()
        {
            PaletteLight = GetLightPalette(ThemeService.CurrentTheme),
            PaletteDark = GetDarkPalette(ThemeService.CurrentTheme)
        };
    }

    private string GetPageTitle()
    {
        var currentPath = NavigationManager.ToBaseRelativePath(NavigationManager.Uri);
        var routePath = "/" + currentPath.Split('?')[0].Split('#')[0];

        return routePath.ToLower() switch
        {
            "/" => TranslationService.GetTranslation("navigation.home", "Home"),
            "/admin" => TranslationService.GetTranslation("navigation.admin", "Administration"),
            "/events" => TranslationService.GetTranslation("navigation.events", "Events"),
            "/notifications" => TranslationService.GetTranslation("navigation.notifications", "Notifications"),
            "/chat" => TranslationService.GetTranslation("navigation.chat", "Chat"),
            "/profile" => TranslationService.GetTranslation("navigation.profile", "Profile"),
            "/settings" => TranslationService.GetTranslation("navigation.settings", "Settings"),
            "/superadmin" => TranslationService.GetTranslation("navigation.superadmin", "Super Admin"),
            var path when path.StartsWith("/superadmin/") => TranslationService.GetTranslation("navigation.superadmin", "Super Admin"),
            var path when path.StartsWith("/admin/") => TranslationService.GetTranslation("navigation.admin", "Administration"),
            _ => TranslationService.GetTranslation("navigation.eventforge", "EventForge")
        };
    }

    private PaletteLight GetLightPalette(string themeKey)
    {
        // Light theme variants
        return themeKey switch
        {
            "carbon-neon-light" => new PaletteLight()
            {
                Primary = "#0099CC",        // Bright Cyan
                Secondary = "#00D9FF",      // Electric Blue
                Tertiary = "#7B68EE",       // Medium Slate Blue
                AppbarBackground = "#FFFFFF",
                AppbarText = "#1A1A1A",
                Background = "#F5F5F5",     // Light Gray
                Surface = "#FFFFFF",
                DrawerBackground = "#FFFFFF",
                DrawerText = "#1A1A1A",
                TextPrimary = "#1A1A1A",    // Near Black
                TextSecondary = "#6B6B6B",  // Medium Gray
                Info = "#0099CC",
                Success = "#00C853",
                Warning = "#FFB300",
                Error = "#FF3D00"
            },
            _ => GetDefaultLightPalette()
        };
    }

    private PaletteLight GetDefaultLightPalette()
    {
        return new PaletteLight()
        {
            Primary = "#1F2F46",        // Navy Blue
            Secondary = "#247BFF",      // Electric Blue
            Tertiary = "#FF6B2C",       // Orange Fire
            AppbarBackground = "#1F2F46",
            AppbarText = "#ffffff",
            Background = "#F5F6FA",     // Light Gray
            Surface = "#ffffff",
            DrawerBackground = "#1F2F46",
            DrawerText = "#d7d7d7",
            TextPrimary = "#2D2D2D",    // Charcoal
            TextSecondary = "#666666",
            Info = "#247BFF",
            Success = "#4caf50",
            Warning = "#ff9800",
            Error = "#f44336"
        };
    }

    private PaletteDark GetDarkPalette(string themeKey)
    {
        // Dark theme variants
        return themeKey switch
        {
            "carbon-neon-dark" => new PaletteDark()
            {
                Primary = "#00F5FF",           // Neon cyan
                Secondary = "#FF006E",         // Vivid magenta
                Background = "#121212",        // Pure MD dark
                Surface = "#262626",
                DrawerBackground = "#1A1A1A",
                DrawerText = "#F5F5F5",
                AppbarBackground = "#000000",
                AppbarText = "#FFFFFF",
                TextPrimary = "#FFFFFF",
                TextSecondary = "#B3B3B3",
                ActionDefault = "#00E5FF",
                Divider = "rgba(255,255,255,0.1)",
                Info = "#00E5FF",
                Success = "#10B981",
                Warning = "#F59E0B",
                Error = "#EF4444"
            },
            _ => GetDefaultDarkPalette()
        };
    }

    private PaletteDark GetDefaultDarkPalette()
    {
        return new PaletteDark()
        {
            Black = "#1a1a2e",
            Background = "#1a1a2e",
            Surface = "#2d2d30",
            TextPrimary = "#e0e0e0",
            TextSecondary = "#b0b0b0",
            AppbarBackground = "#1a1a2e",
            AppbarText = "#e0e0e0",
            DrawerBackground = "#1a1a2e",
            DrawerText = "#b0b0b0",
            Primary = "#4fc3f7",
            Secondary = "#ffb74d",
            Tertiary = "#4fc3f7",
            Info = "#4fc3f7",
            Success = "#66bb6a",
            Warning = "#ffb74d",
            Error = "#f06292"
        };
    }



    private async Task CheckAuthenticationState()
    {
        // Use semaphore to prevent race conditions from concurrent calls
        await _authStateLock.WaitAsync();
        try
        {
            var wasAuthenticated = _isAuthenticated;
            _isAuthenticated = await AuthService.IsAuthenticatedAsync();
            
            // Start or stop session keepalive based on authentication state
            if (_isAuthenticated && !wasAuthenticated)
            {
                // User just logged in - start the keepalive service
                Logger.LogInformation("User authenticated, starting session keepalive service");
                SessionKeepaliveService.Start();
            }
            else if (!_isAuthenticated && wasAuthenticated)
            {
                // User just logged out - stop the keepalive service
                Logger.LogInformation("User logged out, stopping session keepalive service");
                SessionKeepaliveService.Stop();
            }
            
            StateHasChanged();
        }
        finally
        {
            _authStateLock.Release();
        }
    }

    private async void OnAuthenticationStateChanged()
    {
        await CheckAuthenticationState();
    }

    private void OnLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
    {
        InvokeAsync(StateHasChanged);
    }

    private async Task HandleLogout()
    {
        // This method is called from UserAccountMenu component
        // Default behavior is handled by the component itself
        await Task.CompletedTask;
    }

    private async Task ShowLoginDialogAsync()
    {
        var result = await AuthenticationDialogService.ShowLoginDialogAsync();
        if (result)
        {
            // Reload authentication state after successful login
            await CheckAuthenticationState();
        }
    }

    private void OnSessionRefreshSuccess()
    {
        // Optional: Show subtle success notification
        // Commented out to avoid noise, but can be enabled if desired
        Logger.LogDebug("Session token refreshed successfully");
        
        // Uncomment to show success notification:
        // InvokeAsync(() =>
        // {
        //     Snackbar.Add(
        //         TranslationService.GetTranslation("session.refreshSuccess", "Sessione rinnovata automaticamente"),
        //         Severity.Success,
        //         config => { config.VisibleStateDuration = 2000; }
        //     );
        // });
    }

    private void OnSessionRefreshFailure(string errorMessage)
    {
        Logger.LogWarning("Session token refresh failed: {Error}", errorMessage);
        
        InvokeAsync(() =>
        {
            Snackbar.Add(
                TranslationService.GetTranslation("session.refreshFailure", "Impossibile rinnovare la sessione. Salva il lavoro e rieffettua il login."),
                Severity.Error,
                config =>
                {
                    config.VisibleStateDuration = 10000;
                    config.ShowCloseIcon = true;
                }
            );
        });
    }

    private void OnSessionWarning(int minutesRemaining)
    {
        Logger.LogInformation("Session warning: {Minutes} minutes remaining", minutesRemaining);
        
        InvokeAsync(() =>
        {
            // Mostra un avviso discreto solo se veramente critico (< 10 minuti)
            if (minutesRemaining < 10)
            {
                Snackbar.Add(
                    TranslationService.GetTranslation("session.expiringWarning", 
                        $"La sessione scadrà tra {minutesRemaining} minuti. Il rinnovo è in corso..."),
                    Severity.Warning,
                    config =>
                    {
                        config.VisibleStateDuration = 5000;
                        config.ShowCloseIcon = true;
                    }
                );
            }
        });
    }

    public void Dispose()
    {
        AuthService.OnAuthenticationStateChanged -= OnAuthenticationStateChanged;
        ThemeService.OnThemeChanged -= OnThemeChanged;
        FontPreferencesService.OnPreferencesChanged -= OnFontPreferencesChanged;
        TranslationService.LanguageChanged -= OnLanguageChanged;
        NavigationManager.LocationChanged -= OnLocationChanged;
        SessionKeepaliveService.OnRefreshSuccess -= OnSessionRefreshSuccess;
        SessionKeepaliveService.OnRefreshFailure -= OnSessionRefreshFailure;
        SessionKeepaliveService.OnSessionWarning -= OnSessionWarning; // NUOVO
        
        // Ensure the keepalive service is stopped when the layout is disposed
        SessionKeepaliveService.Stop();
        
        // Dispose the semaphore
        _authStateLock.Dispose();
    }
}
