@inherits LayoutComponentBase
@using EventForge.Client.Constants
@inject IAuthService AuthService
@inject IThemeService ThemeService
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@implements IDisposable

<MudThemeProvider @ref="_mudThemeProvider" Theme="_currentTheme" />

<MudLayout>
    <MudAppBar Elevation="1">
        <MudIconButton Icon="Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start" OnClick="@(() => _drawerOpen = !_drawerOpen)" />
        <MudSpacer />
        <!-- Updated to use trace.svg logo instead of text-only branding -->
        <div class="d-flex align-center">
            <img src="trace.svg" alt="EventForge Logo" style="height: 32px; width: 32px; margin-right: 8px;" />
            <MudText Typo="Typo.h6">EventForge</MudText>
        </div>
        <MudSpacer />
        
        @if (_isAuthenticated)
        {
            <div class="d-flex align-center ga-2">
                <!-- Language Selector -->
                <LanguageSelector Dense="true" />
               
                
                <!-- Theme Toggle Button -->
                <MudTooltip Text="@(ThemeService.IsDarkMode ? ButtonLabels.LightMode : ButtonLabels.DarkMode)">
                    <MudIconButton Icon="@(ThemeService.IsDarkMode ? Icons.Material.Filled.LightMode : Icons.Material.Filled.DarkMode)"
                                   Color="Color.Inherit"
                                   OnClick="@ToggleTheme" />
                </MudTooltip>
                
                @if (_currentUser != null)
                {
                    <!-- User Profile Menu -->
                    <MudMenu Icon="@Icons.Material.Filled.AccountCircle" 
                             Color="Color.Inherit" 
                             Direction="Origin.BottomLeft"
                             OffsetX="true"
                             Dense="true">
                        <ActivatorContent>
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                <MudAvatar Color="Color.Primary" Size="Size.Small">
                                    @GetUserInitials()
                                </MudAvatar>
                                <div class="d-none d-sm-flex flex-column">
                                    <MudText Typo="Typo.body2" Class="ma-0">@_currentUser.FullName</MudText>
                                    @if (_currentUser.Roles?.Any() == true)
                                    {
                                        <MudChip T="string"
                                                 Size="Size.Small" 
                                                 Color="Color.Secondary" 
                                                 Variant="Variant.Filled"
                                                 Text="@GetRolesDisplayText()" />
                                    }
                                </div>
                                <MudIcon Icon="@Icons.Material.Filled.ArrowDropDown" Size="Size.Small" />
                            </MudStack>
                        </ActivatorContent>
                        <ChildContent>
                            <MudMenuItem Icon="@Icons.Material.Filled.Person" 
                                         OnClick="@(() => NavigationManager.NavigateTo("/profile"))">
                                @ButtonLabels.Profile
                            </MudMenuItem>
                            <MudMenuItem Icon="@Icons.Material.Filled.Settings" 
                                         OnClick="@(() => NavigationManager.NavigateTo("/settings"))">
                                @ButtonLabels.Settings
                            </MudMenuItem>
                            <MudDivider />
                            <MudMenuItem Icon="@(ThemeService.IsDarkMode ? Icons.Material.Filled.LightMode : Icons.Material.Filled.DarkMode)"
                                         OnClick="@ToggleTheme">
                                @(ThemeService.IsDarkMode ? ButtonLabels.LightMode : ButtonLabels.DarkMode)
                            </MudMenuItem>
                            <MudDivider />
                            <MudMenuItem Icon="@Icons.Material.Filled.Logout" 
                                         OnClick="@HandleLogout">
                                @ButtonLabels.Logout
                            </MudMenuItem>
                        </ChildContent>
                    </MudMenu>
                }
            </div>
        }
        else
        {
            <MudButton Variant="Variant.Text" 
                       Color="Color.Inherit" 
                       StartIcon="Icons.Material.Filled.Login"
                       OnClick="@(() => NavigationManager.NavigateTo("/login"))">
                @ButtonLabels.Login
            </MudButton>
        }
    </MudAppBar>
    
    @if (_isAuthenticated)
    {
        <MudDrawer @bind-Open="@_drawerOpen" ClipMode="DrawerClipMode.Always" Elevation="2">
            <NavMenu />
        </MudDrawer>
    }
    
    <MudMainContent Class="mt-16 pa-4">
        <CustomErrorBoundary OnError="HandleError">
            @Body
        </CustomErrorBoundary>
    </MudMainContent>
</MudLayout>

@code {
    private bool _drawerOpen = true;
    private bool _isAuthenticated = false;
    private UserDto? _currentUser;
    private MudThemeProvider? _mudThemeProvider;
    private MudTheme _currentTheme = new();

    protected override async Task OnInitializedAsync()
    {
        AuthService.OnAuthenticationStateChanged += OnAuthenticationStateChanged;
        ThemeService.OnThemeChanged += OnThemeChanged;
        
        await ThemeService.InitializeAsync();
        await CheckAuthenticationState();
        
        UpdateTheme();
    }

    private void OnThemeChanged()
    {
        UpdateTheme();
        InvokeAsync(StateHasChanged);
    }

    private void UpdateTheme()
    {
        _currentTheme = new MudTheme()
        {
            PaletteLight = ThemeService.IsDarkMode ? 
                new PaletteLight()
                {
                    Black = "#27272f",
                    Background = "#32333d",
                    Surface = "#373740",
                    TextPrimary = "#ffffffDE",
                    TextSecondary = "#ffffff89",
                    AppbarBackground = "#27272f",
                    AppbarText = "#ffffffDE",
                    DrawerBackground = "#27272f",
                    DrawerText = "#ffffffDE"
                } :
                new PaletteLight()
                {
                    // EventForge Custom Theme Integration
                    // These values correspond to the CSS variables defined in custom-theme.css
                    // This ensures MudBlazor components use our custom color palette consistently
                    
                    Primary = "#1F2F46",        // --primary (Navy Blue) - headers, navbar, dark backgrounds
                    Secondary = "#247BFF",      // --secondary (Electric Blue) - buttons, links, highlights
                    Tertiary = "#FF6B2C",       // --accent (Orange Fire) - CTAs, badges, active states
                    AppbarBackground = "#1F2F46", // --appbar-background
                    AppbarText = "#ffffff",     // --appbar-text
                    Background = "#F5F6FA",     // --background-primary (Light Gray)
                    Surface = "#ffffff",        // --card-background
                    DrawerBackground = "#1F2F46", // --sidebar-background
                    DrawerText = "#d7d7d7",     // --sidebar-text
                    TextPrimary = "#2D2D2D",    // --text-primary (Charcoal)
                    TextSecondary = "#666666",  // --text-secondary
                    // Status and interaction colors
                    Info = "#247BFF",           // --link-color (Electric Blue)
                    Success = "#4caf50",        // --success
                    Warning = "#ff9800",        // --warning
                    Error = "#f44336"           // --error
                }
        };
    }

    private async Task ToggleTheme()
    {
        await ThemeService.ToggleThemeAsync();
    }

    private async Task CheckAuthenticationState()
    {
        _isAuthenticated = await AuthService.IsAuthenticatedAsync();
        if (_isAuthenticated)
        {
            _currentUser = await AuthService.GetCurrentUserAsync();
        }
        else
        {
            _currentUser = null;
        }
        StateHasChanged();
    }

    private async void OnAuthenticationStateChanged()
    {
        await CheckAuthenticationState();
    }

    private async Task HandleLogout()
    {
        try
        {
            await AuthService.LogoutAsync();
            Snackbar.Add(Messages.OperationSuccessful, Severity.Success);
            NavigationManager.NavigateTo("/login");
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Logout error: {ex.Message}", Severity.Error);
        }
    }

    private string GetUserInitials()
    {
        if (_currentUser == null) return "?";
        
        var firstName = _currentUser.FirstName?.Trim();
        var lastName = _currentUser.LastName?.Trim();
        
        if (string.IsNullOrEmpty(firstName) && string.IsNullOrEmpty(lastName))
            return _currentUser.Username?.Substring(0, 1).ToUpper() ?? "?";
        
        var firstInitial = !string.IsNullOrEmpty(firstName) ? firstName.Substring(0, 1).ToUpper() : "";
        var lastInitial = !string.IsNullOrEmpty(lastName) ? lastName.Substring(0, 1).ToUpper() : "";
        
        return $"{firstInitial}{lastInitial}";
    }

    private string GetRolesDisplayText()
    {
        if (_currentUser?.Roles == null || !_currentUser.Roles.Any())
            return "No Role";
        
        if (_currentUser.Roles.Count == 1)
            return _currentUser.Roles.First();
        
        return $"{_currentUser.Roles.Count} Roles";
    }

    private async Task HandleError(Exception exception)
    {
        // Log the error and show a user-friendly message
        Snackbar.Add("Si è verificato un errore. L'operazione potrebbe non essere stata completata correttamente.", Severity.Error);
        
        // You could also send error reports to a logging service here
        // await ErrorReportingService.ReportErrorAsync(exception);
    }

    public void Dispose()
    {
        AuthService.OnAuthenticationStateChanged -= OnAuthenticationStateChanged;
        ThemeService.OnThemeChanged -= OnThemeChanged;
    }
}
